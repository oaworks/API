P.search=function(m){var e,r;for(e in null==(m=null==m?{}:m).msg&&(m.msg="search..."),null==m.url&&(m.url=window.location.href.split("?")[0].replace(".html","")),null==m.default&&(m.default={query:{bool:{must:[],filter:[]}}}),null==m.query&&(m.query=!0),null==m.operator&&(m.operator="AND"),null==m.fuzzy&&(m.fuzzy="*"),null==m.pushstate&&(m.pushstate=!0),null==m.sticky&&(m.sticky=!0),null==m.scroll&&(m.scroll=!0),m.table=!0,(P.search.opts=m).paging=!1,m.max=!1,m.page=function(e,r){try{e.preventDefault()}catch(e){}return m.query.from=(null!=(e=m.query.from)?e:0)+(r?-1:1)*(null!=(r=m.query.size)?r:10),m.query.from<0&&(m.query.from=0),P(".PResultFrom"+m.query.from)?(P.hide(".PSearchResult"),P.show(".PResultFrom"+m.query.from),m.placeholder()):m.max?void 0:(P.show(".PLoading"),m.paging=!0,m.search())},m.previous=function(e){return m.page(e,!0)},m.next=function(e){return m.page(e)},m.from=function(){return m.query.from=parseInt(P.val(".PSearchFrom")),m.search()},m.to=function(){var e;return m.query.size=P.val(".PSearchTo")-(null!=(e=m.query.from)?e:0),m.search()},m.scroller=function(){return window.addEventListener("scroll",function(){if(!m.paging&&window.innerHeight+window.pageYOffset>=document.body.offsetHeight)return m.next()})},m.add=function(e){var r,t,l;try{e.preventDefault()}catch(e){}if(delete m.query.from,l=P.val(e.target))if(0===l.indexOf("opts."))if(-1===l.indexOf(":"))m.placeholder(P.dot(m,l.replace("opts.","")));else{r=l.substring(8,l.indexOf(":")).replace(" ",""),t=l.substring(l.indexOf(":")+1).trim();try{t=JSON.parse(t)}catch(e){}!1===m.scroll&&"opts.scroll"===r&&!0===t&&m.scroller();try{P.dot(m,r,t),m.search()}catch(e){}}else-1!==l.indexOf(":")&&-1===l.split(":")[0].indexOf(" ")&&-1===l.indexOf("*")&&-1===l.indexOf("~")&&-1===l.indexOf(" AND ")&&-1===l.indexOf(" OR ")?((t={term:{}}).term[l.split(":")[0]]=l.split(":")[1].replace(/"/g,""),m.query.query.bool.filter.push(t)):l.startsWith('"')&&l.endsWith('"')?m.query.query.bool.filter.push({match_phrase:{_all:l.replace(/"/g,"")}}):m.query.query.bool.filter.push({query_string:{default_operator:m.operator,query:m.fuzzify(l)}}),m.search();try{P.set(e.target,"")}catch(e){}return P.blur(".PSearch")},m.remove=function(e){try{e.preventDefault()}catch(e){}return P.remove(e.target.closest("a")),m.query.query.bool.filter=[],delete m.query.from,m.search()},m.placeholder=function(e){var r;return e||(e=(null!=(r=m.query.from)?r:0)+(null!=(r=m.query.size)?r:10)<m.response.hits.total?(null!=(r=m.query.from)?r:0)+(null!=(r=m.query.size)?r:10):m.response.hits.total,e+=0!==e?" of "+m.response.hits.total:""),P.set(".PSearch",""),P.attr(".PSearch","placeholder",e)},m.fuzzify=function(e){return e=m.fuzzy&&-1===e.indexOf("*")&&-1===e.indexOf("~")&&-1===e.indexOf(":")&&-1===e.indexOf('"')&&-1===e.indexOf("AND")&&-1===e.indexOf("OR")?("*"===m.fuzzy?"*":"")+e.trim().replace(/\s/g,m.fuzzy+" "+("*"===m.fuzzy?"*":""))+m.fuzzy:e},m.translate=function(){for(var e,r,t,l,s,a,n,o,u,i,c,f,h,p,d=null!=(f=m.aggregations)?f:[],y=0,g=d.length;y<g;y++)e=d[y],null==(r=m.default).aggregations&&(r.aggregations=[]),m.default.aggregations.push("string"==typeof e?{terms:{field:e}}:e);for(null==(f=m.default).size&&(f.size=m.size),s=0,n=(c=["includes","excludes"]).length;s<n;s++)null!=m[p=c[s]]&&(null==(t=m.default)._source&&(t._source={}),null==(t=m.default._source)[p]&&(t[p]=m[p]));for(m.filters&&(m.default.query.bool.filter=m.filters),"object"!=typeof m.query&&delete m.query,null==m.query&&(m.query=JSON.parse(JSON.stringify(m.default))),P(".PSearchVal",function(e){var r;try{r=P.val(e)}catch(e){}try{null==r&&(r=P.html(e))}catch(e){}if(r)return-1!==r.indexOf(":")?((e={term:{}}).term[r.split(":")[0]]=r.split(":")[1].replace(/"/g,""),m.query.query.bool.filter.push(e)):-1!==r.indexOf("*")||-1!==r.indexOf("~")||-1!==r.indexOf(" AND ")||-1===r.indexOf(" OR ")?m.query.query.bool.filter.push({query_string:{default_operator:m.operator,query:r}}):m.query.query.bool.filter.push({match_phrase:{_all:r}})}),a=0,o=(h=null!=(f=m.filters)?f:[]).length;a<o;a++){l=h[a],i=JSON.stringify(m.query.query.bool.filter);try{-1===i.indexOf(JSON.stringify(l))&&m.query.query.bool.filter.push(l)}catch(e){}}return m.random?(!0!==m.random&&null==m.seed&&(m.seed=m.random),null==m.seed&&(m.seed=Math.floor(1e12*Math.random())),(u={function_score:{random_score:{seed:m.seed}}}).function_score.query=m.query.query,m.query.query=u):null!=m.sort&&(m.query.sort="function"==typeof m.sort?m.sort():m.sort),m.paging&&delete m.query.aggregations,"POST"!==m.method&&(u=m.url.split("source=")[0],u+=-1===u.indexOf("?")?"?":u.endsWith("&")||u.endsWith("?")?"":"&",m.url=u+"source="+encodeURIComponent(JSON.stringify(m.query))),m.query},m._first=!0,m.success=function(e){var r;P.hide(".PLoading"),m.response=e,m._first?m._first=!1:m.placeholder(),m.render(),m.construct();try{m.max=e.hits.hits.length<(null!=(r=m.query.size)?r:10)}catch(e){}return m.paging=!1},m.error=function(e){return P.hide(".PLoading"),P.show(".PError"),console.log(e)},m.searching=!1,m.search=function(e){if(!m.searching)return m.searching=!0,P.hide(".PError"),P.show(".PLoading"),m._first||P.attr(".PSearch","placeholder","searching..."),setTimeout(function(){var e={success:m.success,error:m.error,data:m.translate()};return"POST"!==m.method&&delete e.data,e.url=m.url,m.username&&m.password&&(e.headers={Authorization:"Basic "+btoa(m.username+":"+m.password)}),m.apikey&&(e.headers={apikey:m.apikey}),P.ajax(e),m.searching=!1},300)},m.render=function(){var e,r,t,l,s,a,n,o,u,i,c,f;if(m.pushstate){f=window.location.search.split("source=")[0],JSON.stringify(m.query)!==JSON.stringify(m.default)&&(f+=-1===f.indexOf("?")?"?":f.endsWith("&")?"":"&",f+="source="+JSON.stringify(m.query)),(f.endsWith("&")||f.endsWith("?"))&&(f=f.substring(0,f.length-1));try{window.history.pushState("","search",f)}catch(e){}}try{P.set(".PSearchFrom",null!=(n=m.query.from)?n:0)}catch(e){}try{P.set(".PSearchTo",(null!=(o=m.query.from)?o:0)+(null!=(null!=(u=m.response)&&null!=(i=u.hits)?i.hits:void 0)?m.response.hits.hits.length:null!=(c=m.query.size)?c:10))}catch(e){}try{P.html(".PSearches","")}catch(e){}for(r in m.query.query.bool.filter)if(t=m.query.query.bool.filter[r],-1===JSON.stringify(t).indexOf("match_all"))a=JSON.stringify(t).split(':"').pop().split("}")[0].replace(/"/g,""),P.append(".PSearches",'<a class="button PSearchRemove" href="#"><b>X</b> <span class="PSearchVal">'+a+"</span></a>");else if(t.term){for(l in e='<a style="margin:5px;" class="button PSearchRemove" href="#"><b>X</b> <span class="PSearchVal">',t.term)e+=" "+l.replace(".keyword","").split(".").pop()+":"+t.term[l];P.append(".PSearches",e+"</span></a>")}else if(t.range)for(s in t.range)s.replace(".keyword","").split(".").pop(),t.range[s].gte,t.range[s].lte;return 2<m.query.query.bool.filter.length&&P.append(".PSearches",'<a class="button PSearchRemove" href="#">clear all</a>'),P.listen("click",".PSearchRemove",m.remove)},m.results=[],m.result=function(e){var r,t,l,s,a,n,o,u,i;if(Array.isArray(m.table)){for(n={},t=0,a=(u=m.table).length;t<a;t++)n[u[t]]="";m.table=n}for(l in o=m.table?"<tr":'<p style="word-wrap: break-word; padding:5px; margin-bottom:0px;"',o+=' class="PSearchResult PResultFrom'+(null!=(i=m.query.from)?i:0)+'">',r=P.html(".PSearchHeaders"),m.table||e)s="object"==typeof m.table&&m.table[l]?m.table[l]:l,m.table&&-1===r.indexOf(s)&&P.append(".PSearchHeaders","<th>"+s+"</th>"),o+=m.table?"<td>":"<b>"+s+"</b>: ",Array.isArray(e[l])&&(e[l]=0===e[l].length?void 0:1===e[l].length?e[l][0]:"object"!=typeof e[l][0]?e[l].join(", "):e[l]),e[l]&&(o+="object"==typeof e[l]?JSON.stringify(e[l]):e[l]),o+=m.table?"</td>":", ";return o+=m.table?"</tr>":"</p>"},m.transform=!1,m.construct=function(e){var r,t,l,s,a,n;for(null!=(null!=(e=null==e?JSON.parse(JSON.stringify(m.response)):e)&&null!=(s=e.hits)?s.hits:void 0)&&(e=e.hits.hits),m.paging?!1===m.scroll&&P.hide(".PSearchResult"):(m.results=[],P.html(".PSearchResults","")),n=[],r=0,t=(a=null!=e?e:[]).length;r<t;r++)l=a[r],l="function"==typeof m.transform?m.transform(l):null!=l._source?l._source:l,m.results.push(l),"function"==typeof m.result?n.push(P.append(".PSearchResults",m.result(l))):n.push(void 0);return n},m.template||!1===m.template||(m.template='<div class="container big PSearchDiv"><div'+(m.sticky?' class="sticky"':"")+">",!1===m.scroll&&(m.template+='<a href="#" class="button PSearchPrevious" alt="previous" title="previous">&lt;</a>'),m.template+='<input style="margin-top:5px;" type="text" class="PSearch big" placeholder="'+m.msg+'">',!1===m.scroll&&(m.template+='<a href="#" class="button PSearchNext" alt="next" title="next">&gt;</a>'),m.template+='<div class="PSearches" style="margin-top:5px; margin-bottom:5px;"></div>',m.template+=m.table?'<table class="striped"><thead'+(m.sticky?' class="sticky"':"")+'><tr class="PSearchHeaders"></tr></thead><tbody class="PSearchResults"></tbody></table>':'<div class="PSearchResults"></div>',m.template+='<div class="PLoading" style="display:none;"><div class="loading big"></div></div>',m.template+="</div></div>"),null==m.ui&&(m.ui=function(){for(var e in!1===m.template||P(".PSearch")||P.append("body",m.template),P.on("focus",".PSearch",function(){try{return P.show(".POptions")}catch(e){}}),P.on("enter",".PSearch",m.add),m)"function"==typeof m[e]&&P.on("change",".PSearch"+e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase(),m[e]);!1!==m.scroll&&m.scroller();try{return P.focus(".PSearch")}catch(e){}}),"function"==typeof m.ui&&m.ui(),r=P.params())"search"!==e&&(m["source"===e?"query":e]=r[e]);if(m.query)return!1!==m.scroll&&delete m.query.from,m.search()};