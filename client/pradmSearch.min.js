P.search=function(m){var e,r;for(e in null==(m=null==m?{}:m).msg&&(m.msg="search..."),null==m.url&&(m.url=window.location.href.split("?")[0].replace(".html","")),null==m.default&&(m.default={query:{bool:{must:[],filter:[]}}}),null==m.query&&(m.query=!0),null==m.operator&&(m.operator="AND"),null==m.fuzzy&&(m.fuzzy="*"),null==m.pushstate&&(m.pushstate=!0),null==m.sticky&&(m.sticky=!0),null==m.scroll&&(m.scroll=!0),m.table=["DOI","title","year","ISSN"],(P.search.opts=m).paging=!1,m.max=!1,m.page=function(e,r){try{e.preventDefault()}catch(e){}return m.query.from=(null!=(e=m.query.from)?e:0)+(r?-1:1)*(null!=(r=m.query.size)?r:10),m.query.from<0&&(m.query.from=0),P(".PResultFrom"+m.query.from)?(P.hide(".PSearchResult"),P.show(".PResultFrom"+m.query.from),m.placeholder()):m.max?void 0:(P.show(".PLoading"),m.paging=!0,m.execute())},m.previous=function(e){return m.page(e,!0)},m.next=function(e){return m.page(e)},m.from=function(){return m.query.from=parseInt(P.val(".PSearchFrom")),m.execute()},m.to=function(){var e;return m.query.size=P.val(".PSearchTo")-(null!=(e=m.query.from)?e:0),m.execute()},m.scroller=function(){return window.addEventListener("scroll",function(){if(!m.paging&&window.innerHeight+window.pageYOffset>=document.body.offsetHeight)return m.next()})},m.add=function(e){var r,t,l;try{e.preventDefault()}catch(e){}if(delete m.query.from,l=P.val(e.target))if(0===l.indexOf("opts."))if(-1===l.indexOf(":"))m.placeholder(P.dot(m,l.replace("opts.","")));else{r=l.substring(8,l.indexOf(":")).replace(" ",""),t=l.substring(l.indexOf(":")+1).trim();try{t=JSON.parse(t)}catch(e){}!1===m.scroll&&"opts.scroll"===r&&!0===t&&m.scroller();try{P.dot(m,r,t),m.execute()}catch(e){}}else-1!==l.indexOf(":")&&-1===l.split(":")[0].indexOf(" ")&&-1===l.indexOf("*")&&-1===l.indexOf("~")&&-1===l.indexOf(" AND ")&&-1===l.indexOf(" OR ")?((t={term:{}}).term[l.split(":")[0]]=l.split(":")[1].replace(/"/g,""),m.query.query.bool.filter.push(t)):l.startsWith('"')&&l.endsWith('"')?m.query.query.bool.filter.push({match_phrase:{_all:l.replace(/"/g,"")}}):m.query.query.bool.filter.push({query_string:{default_operator:m.operator,query:m.fuzzify(l)}}),m.execute();try{P.set(e.target,"")}catch(e){}return P.blur(".PSearch")},m.remove=function(e){try{e.preventDefault()}catch(e){}return P.remove(e.target.closest("a")),m.query.query.bool.filter=[],delete m.query.from,m.execute()},m.placeholder=function(e){var r;return e||(e=(null!=(r=m.query.from)?r:0)+(null!=(r=m.query.size)?r:10)<m.response.hits.total?(null!=(r=m.query.from)?r:0)+(null!=(r=m.query.size)?r:10):m.response.hits.total,e+=0!==e?" of "+m.response.hits.total:""),P.set(".PSearch",""),P.attr(".PSearch","placeholder",e)},m.suggesting=!1,m.suggestions=function(e){var r;try{e.preventDefault()}catch(e){}return 0!==m.query.query.bool.filter.length&&m.query.query.bool.filter.splice(-1,1),13===(null!=(r=e.keyCode)?r:e.which)?m.add(e):(m.suggesting=!0,m.query.query.bool.filter.push({query_string:{query:m.fuzzify(P.val(e.target))}}),m.execute())},m.suggest=function(e){var s,r,n,t,l,a;for(null==e&&(e=m.response),P.html(".PSuggestions",""),a=[],r=0,t=(l=null!=(e=e.aggregations)?e:[]).length;r<t;r++)s=l[r],a.push(function(){for(var e=s.buckets,r=[],t=0,l=e.length;t<l;t++)n=e[t],r.push(P.append(".PSuggestions",n.key+" ("+n.doc_count+")<br>"));return r}());return a},m.fuzzify=function(e){var r,t,l,s,n;if(m.fuzzy&&-1===e.indexOf("*")&&-1===e.indexOf("~")&&-1===e.indexOf(":")&&-1===e.indexOf('"')&&-1===e.indexOf("AND")&&-1===e.indexOf("OR")&&-1===e.indexOf(" ")){for(l="",r=0,t=(n=e.split(" ")).length;r<t;r++)(s=n[r]).length&&(s+=m.fuzzy,l+=(s="*"===m.fuzzy?"*"+s:s)+" ");return l}return e},m.qry=function(){for(var e,r,t,l,s,n,a,u,o,i,c,f,h,p,y=null!=(f=m.aggregations)?f:[],d=0,g=y.length;d<g;d++)e=y[d],null==(r=m.default).aggregations&&(r.aggregations=[]),m.default.aggregations.push("string"==typeof e?{terms:{field:e}}:e);for(null==(f=m.default).size&&(f.size=m.size),s=0,n=(c=["includes","excludes"]).length;s<n;s++)null!=m[p=c[s]]&&(null==(t=m.default)._source&&(t._source={}),null==(t=m.default._source)[p]&&(t[p]=m[p]));for(m.filters&&(m.default.query.bool.filter=m.filters),"object"!=typeof m.query&&delete m.query,null==m.query&&(m.query=JSON.parse(JSON.stringify(m.default))),P(".PSearchVal",function(e){var r;try{r=P.val(e)}catch(e){}try{null==r&&(r=P.html(e))}catch(e){}if(r)return-1!==r.indexOf(":")?((e={term:{}}).term[r.split(":")[0]]=r.split(":")[1].replace(/"/g,""),m.query.query.bool.filter.push(e)):-1!==r.indexOf("*")||-1!==r.indexOf("~")||-1!==r.indexOf(" AND ")||-1===r.indexOf(" OR ")?m.query.query.bool.filter.push({query_string:{default_operator:m.operator,query:r}}):m.query.query.bool.filter.push({match_phrase:{_all:r}})}),u=0,a=(h=null!=(f=m.filters)?f:[]).length;u<a;u++){l=h[u],i=JSON.stringify(m.query.query.bool.filter);try{-1===i.indexOf(JSON.stringify(l))&&m.query.query.bool.filter.push(l)}catch(e){}}return m.random?(!0!==m.random&&null==m.seed&&(m.seed=m.random),null==m.seed&&(m.seed=Math.floor(1e12*Math.random())),(o={function_score:{random_score:{seed:m.seed}}}).function_score.query=m.query.query,m.query.query=o):null!=m.sort&&(m.query.sort="function"==typeof m.sort?m.sort():m.sort),m.paging&&delete m.query.aggregations,"function"==typeof m.translate&&(m.query=m.translate(m.query)),"POST"!==m.method&&(o=m.url.split("source=")[0],o+=-1===o.indexOf("?")?"?":o.endsWith("&")||o.endsWith("?")?"":"&",m.url=o+"source="+encodeURIComponent(JSON.stringify(m.query))),m.query},m._first=!0,m.success=function(e){var r;P.hide(".PLoading"),m.response=e,m.suggesting?m.suggest():(m._first?m._first=!1:m.placeholder(),m.render(),m.construct());try{m.max=!m.suggesting&&e.hits.hits.length<(null!=(r=m.query.size)?r:10)}catch(e){}return m.suggesting=!1,m.paging=!1},m.error=function(e){return P.hide(".PLoading"),P.show(".PError"),console.log(e)},m.executing=!1,m.execute=function(e){if(!m.executing)return m.executing=!0,P.hide(".PError"),P.show(".PLoading"),m._first||P.attr(".PSearch","placeholder","searching..."),setTimeout(function(){var e={success:m.success,error:m.error,data:m.qry()};return"POST"!==m.method&&delete e.data,e.url=m.url,m.username&&m.password&&(e.headers={Authorization:"Basic "+btoa(m.username+":"+m.password)}),m.apikey&&(e.headers={apikey:m.apikey}),P.ajax(e),m.executing=!1},300)},m.render=function(){var e,r,t,l,s,n,a,u,o,i,c,f;if(m.pushstate&&!m.suggesting){f=window.location.search.split("source=")[0],JSON.stringify(m.query)!==JSON.stringify(m.default)&&(f+=-1===f.indexOf("?")?"?":f.endsWith("&")?"":"&",f+="source="+JSON.stringify(m.query)),(f.endsWith("&")||f.endsWith("?"))&&(f=f.substring(0,f.length-1));try{window.history.pushState("","search",f)}catch(e){}}try{P.set(".PSearchFrom",null!=(a=m.query.from)?a:0)}catch(e){}try{P.set(".PSearchTo",(null!=(u=m.query.from)?u:0)+(null!=(null!=(o=m.response)&&null!=(i=o.hits)?i.hits:void 0)?m.response.hits.hits.length:null!=(c=m.query.size)?c:10))}catch(e){}try{P.html(".PSearches","")}catch(e){}for(r in m.query.query.bool.filter)if(t=m.query.query.bool.filter[r],-1===JSON.stringify(t).indexOf("match_all"))n=JSON.stringify(t).split(':"').pop().split("}")[0].replace(/"/g,""),P.append(".PSearches",'<a class="button PSearchRemove" href="#"><b>X</b> <span class="PSearchVal">'+n+"</span></a>");else if(t.term){for(l in e='<a style="margin:5px;" class="button PSearchRemove" href="#"><b>X</b> <span class="PSearchVal">',t.term)e+=" "+l.replace(".keyword","").split(".").pop()+":"+t.term[l];P.append(".PSearches",e+"</span></a>")}else if(t.range)for(s in t.range)s.replace(".keyword","").split(".").pop(),t.range[s].gte,t.range[s].lte;return 2<m.query.query.bool.filter.length&&P.append(".PSearches",'<a class="button PSearchRemove" href="#">clear all</a>'),P.listen("click",".PSearchRemove",m.remove)},m.results=[],m.result=function(e){var r,t,l,s,n,a,u,o,i,c,f,h,p,y;if(null==m._table_was_defined&&(m._table_was_defined="object"==typeof m.table),Array.isArray(m.table)){for(i={},l=0,u=(h=m.table).length;l<u;l++)i[h[l]]="";m.table=i}for(s in f=!1!==m.table?"<tr":'<p style="word-wrap: break-word; padding:5px; margin-bottom:0px;"',f+=' class="PSearchResult PResultFrom'+(null!=(p=m.query.from)?p:0)+'">',t=P.html(".PSearchHeaders"),"object"==typeof m.table?m.table:e){if(n="object"==typeof m.table&&m.table[s]?m.table[s]:s,null==m.table&&(m.table={}),!1!==m.table&&(m._table_was_defined||null==(r=m.table)[s]&&(r[s]=""),-1===t.indexOf(n)&&P.append(".PSearchHeaders","<th>"+n+"</th>")),f+=!1!==m.table?"<td>":"<b>"+n+"</b>: ",Array.isArray(e[s])&&(e[s]=0===e[s].length?void 0:1===e[s].length?e[s][0]:e[s],Array.isArray(e[s]))){for(c=!1,a=0,o=(y=e[s]).length;a<o;a++)if("object"==typeof y[a]){c=!0;break}c||(e[s]=e[s].join(", "))}e[s]&&(f+="object"==typeof e[s]?JSON.stringify(e[s]):e[s]),f+=!1!==m.table?"</td>":", "}return f+=!1!==m.table?"</tr>":"</p>"},m.transform=!1,m.construct=function(e){var r,t,l,s,n,a;for(null!=(null!=(e=null==e?JSON.parse(JSON.stringify(m.response)):e)&&null!=(s=e.hits)?s.hits:void 0)&&(e=e.hits.hits),m.paging?!1===m.scroll&&P.hide(".PSearchResult"):(m.results=[],P.html(".PSearchResults","")),a=[],r=0,t=(n=null!=e?e:[]).length;r<t;r++)l=n[r],l="function"==typeof m.transform?m.transform(l):null!=l._source?l._source:l,m.results.push(l),"function"==typeof m.result?a.push(P.append(".PSearchResults",m.result(l))):a.push(void 0);return a},m.template||!1===m.template||(m.template='<div class="container big PSearchDiv"><div'+(m.sticky?' class="sticky"':"")+">",!1===m.scroll&&(m.template+='<a href="#" class="button PSearchPrevious" alt="previous" title="previous">&lt;</a>'),m.template+='<input style="margin-top:5px;" type="text" class="PSearch big" placeholder="'+m.msg+'">',!1===m.scroll&&(m.template+='<a href="#" class="button PSearchNext" alt="next" title="next">&gt;</a>'),m.template+='<div class="PSuggestions"></div><div class="PSearches" style="margin-top:5px; margin-bottom:5px;"></div>',m.template+=!1!==m.table?'<table class="striped"><thead'+(m.sticky?' class="sticky"':"")+'><tr class="PSearchHeaders"></tr></thead><tbody class="PSearchResults"></tbody></table>':'<div class="PSearchResults"></div>',m.template+='<div class="PLoading" style="display:none;"><div class="loading big"></div></div>',m.template+="</div></div>"),null==m.ui&&(m.ui=function(){for(var e in!1===m.template||P(".PSearch")||P.append("body",m.template),P.on("focus",".PSearch",function(){try{return P.show(".POptions")}catch(e){}}),P.on("enter",".PSearch",m.add),P.on("keyup",".PSuggest",m.suggestions,600),m)"function"==typeof m[e]&&P.on("change",".PSearch"+e.substring(0,1).toUpperCase()+e.substring(1).toLowerCase(),m[e]);!1!==m.scroll&&m.scroller();try{return P.focus(".PSearch")}catch(e){}}),"function"==typeof m.ui&&m.ui(),r=P.params())"search"!==e&&(m["source"===e?"query":e]=r[e]);if(m.query)return!1!==m.scroll&&delete m.query.from,m.execute()};