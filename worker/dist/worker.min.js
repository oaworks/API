/*! For license information please see worker.min.js.LICENSE.txt */
(()=>{var t={282:(t,e,i)=>{"use strict";var r=i(155),s=i(108);function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}var a,l,o=i(136).codes,u=o.ERR_AMBIGUOUS_ARGUMENT,c=o.ERR_INVALID_ARG_TYPE,h=o.ERR_INVALID_ARG_VALUE,p=o.ERR_INVALID_RETURN_VALUE,d=o.ERR_MISSING_ARGS,f=i(961),y=i(539).inspect,m=i(539).types,g=m.isPromise,v=m.isRegExp,b=Object.assign?Object.assign:i(91).assign,w=Object.is?Object.is:i(609);function _(){var t=i(158);a=t.isDeepEqual,l=t.isDeepStrictEqual}new Map;var x=!1,O=t.exports=A,S={};function k(t){if(t.message instanceof Error)throw t.message;throw new f(t)}function j(t,e,i,r){if(!i){var s=!1;if(0===e)s=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var n=new f({actual:i,expected:!0,message:r,operator:"==",stackStartFn:t});throw n.generatedMessage=s,n}}function A(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];j.apply(void 0,[A,e.length].concat(e))}O.fail=function t(e,i,n,a,l){var o,u=arguments.length;if(0===u?o="Failed":1===u?(n=e,e=void 0):(!1===x&&(x=!0,(r.emitWarning?r.emitWarning:s.warn.bind(s))("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===u&&(a="!=")),n instanceof Error)throw n;var c={actual:e,expected:i,operator:void 0===a?"fail":a,stackStartFn:l||t};void 0!==n&&(c.message=n);var h=new f(c);throw o&&(h.message=o,h.generatedMessage=!0),h},O.AssertionError=f,O.ok=A,O.equal=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");e!=i&&k({actual:e,expected:i,message:r,operator:"==",stackStartFn:t})},O.notEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");e==i&&k({actual:e,expected:i,message:r,operator:"!=",stackStartFn:t})},O.deepEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),a(e,i)||k({actual:e,expected:i,message:r,operator:"deepEqual",stackStartFn:t})},O.notDeepEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),a(e,i)&&k({actual:e,expected:i,message:r,operator:"notDeepEqual",stackStartFn:t})},O.deepStrictEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),l(e,i)||k({actual:e,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:t})},O.notDeepStrictEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),l(e,i)&&k({actual:e,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:t})},O.strictEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");w(e,i)||k({actual:e,expected:i,message:r,operator:"strictEqual",stackStartFn:t})},O.notStrictEqual=function t(e,i,r){if(arguments.length<2)throw new d("actual","expected");w(e,i)&&k({actual:e,expected:i,message:r,operator:"notStrictEqual",stackStartFn:t})};var I=function t(e,i,r){var s=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),i.forEach((function(t){t in e&&(void 0!==r&&"string"==typeof r[t]&&v(e[t])&&e[t].test(r[t])?s[t]=r[t]:s[t]=e[t])}))};function E(t,e,i,r){if("function"!=typeof e){if(v(e))return e.test(t);if(2===arguments.length)throw new c("expected",["Function","RegExp"],e);if("object"!==n(t)||null===t){var s=new f({actual:t,expected:e,message:i,operator:"deepStrictEqual",stackStartFn:r});throw s.operator=r.name,s}var o=Object.keys(e);if(e instanceof Error)o.push("name","message");else if(0===o.length)throw new h("error",e,"may not be an empty object");return void 0===a&&_(),o.forEach((function(s){"string"==typeof t[s]&&v(e[s])&&e[s].test(t[s])||function(t,e,i,r,s,n){if(!(i in t)||!l(t[i],e[i])){if(!r){var a=new I(t,s),o=new I(e,s,t),u=new f({actual:a,expected:o,operator:"deepStrictEqual",stackStartFn:n});throw u.actual=t,u.expected=e,u.operator=n.name,u}k({actual:t,expected:e,message:r,operator:n.name,stackStartFn:n})}}(t,e,s,i,o,r)})),!0}return void 0!==e.prototype&&t instanceof e||!Error.isPrototypeOf(e)&&!0===e.call({},t)}function D(t){if("function"!=typeof t)throw new c("fn","Function",t);try{t()}catch(t){return t}return S}function C(t){return g(t)||null!==t&&"object"===n(t)&&"function"==typeof t.then&&"function"==typeof t.catch}function N(t){return Promise.resolve().then((function(){var e;if("function"==typeof t){if(!C(e=t()))throw new p("instance of Promise","promiseFn",e)}else{if(!C(t))throw new c("promiseFn",["Function","Promise"],t);e=t}return Promise.resolve().then((function(){return e})).then((function(){return S})).catch((function(t){return t}))}))}function L(t,e,i,r){if("string"==typeof i){if(4===arguments.length)throw new c("error",["Object","Error","Function","RegExp"],i);if("object"===n(e)&&null!==e){if(e.message===i)throw new u("error/message",'The error message "'.concat(e.message,'" is identical to the message.'))}else if(e===i)throw new u("error/message",'The error "'.concat(e,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==n(i)&&"function"!=typeof i)throw new c("error",["Object","Error","Function","RegExp"],i);if(e===S){var s="";i&&i.name&&(s+=" (".concat(i.name,")")),s+=r?": ".concat(r):".";var a="rejects"===t.name?"rejection":"exception";k({actual:void 0,expected:i,operator:t.name,message:"Missing expected ".concat(a).concat(s),stackStartFn:t})}if(i&&!E(e,i,r,t))throw e}function T(t,e,i,r){if(e!==S){if("string"==typeof i&&(r=i,i=void 0),!i||E(e,i)){var s=r?": ".concat(r):".",n="doesNotReject"===t.name?"rejection":"exception";k({actual:e,expected:i,operator:t.name,message:"Got unwanted ".concat(n).concat(s,"\n")+'Actual message: "'.concat(e&&e.message,'"'),stackStartFn:t})}throw e}}function P(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];j.apply(void 0,[P,e.length].concat(e))}O.throws=function t(e){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];L.apply(void 0,[t,D(e)].concat(r))},O.rejects=function t(e){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(e).then((function(e){return L.apply(void 0,[t,e].concat(r))}))},O.doesNotThrow=function t(e){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];T.apply(void 0,[t,D(e)].concat(r))},O.doesNotReject=function t(e){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(e).then((function(e){return T.apply(void 0,[t,e].concat(r))}))},O.ifError=function t(e){if(null!=e){var i="ifError got unwanted exception: ";"object"===n(e)&&"string"==typeof e.message?0===e.message.length&&e.constructor?i+=e.constructor.name:i+=e.message:i+=y(e);var r=new f({actual:e,expected:null,operator:"ifError",message:i,stackStartFn:t}),s=e.stack;if("string"==typeof s){var a=s.split("\n");a.shift();for(var l=r.stack.split("\n"),o=0;o<a.length;o++){var u=l.indexOf(a[o]);if(-1!==u){l=l.slice(0,u);break}}r.stack="".concat(l.join("\n"),"\n").concat(a.join("\n"))}throw r}},O.strict=b(P,O,{equal:O.strictEqual,deepEqual:O.deepStrictEqual,notEqual:O.notStrictEqual,notDeepEqual:O.notDeepStrictEqual}),O.strict.strict=O.strict},961:(t,e,i)=>{"use strict";var r=i(155);function s(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function n(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function a(t,e){return!e||"object"!==p(e)&&"function"!=typeof e?l(t):e}function l(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function o(t){var e="function"==typeof Map?new Map:void 0;return o=function(t){if(null===t||(i=t,-1===Function.toString.call(i).indexOf("[native code]")))return t;var i;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return u(t,arguments,h(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,t)},o(t)}function u(t,e,i){return u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,i){var r=[null];r.push.apply(r,e);var s=new(Function.bind.apply(t,r));return i&&c(s,i.prototype),s},u.apply(null,arguments)}function c(t,e){return c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},c(t,e)}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}var d=i(539).inspect,f=i(136).codes.ERR_INVALID_ARG_TYPE;function y(t,e,i){return(void 0===i||i>t.length)&&(i=t.length),t.substring(i-e.length,i)===e}var m="",g="",v="",b="",w={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function _(t){var e=Object.keys(t),i=Object.create(Object.getPrototypeOf(t));return e.forEach((function(e){i[e]=t[e]})),Object.defineProperty(i,"message",{value:t.message}),i}function x(t){return d(t,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var O=function(t){function e(t){var i;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),"object"!==p(t)||null===t)throw new f("options","Object",t);var s=t.message,n=t.operator,o=t.stackStartFn,u=t.actual,c=t.expected,d=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=s)i=a(this,h(e).call(this,String(s)));else if(r.stderr&&r.stderr.isTTY&&(r.stderr&&r.stderr.getColorDepth&&1!==r.stderr.getColorDepth()?(m="[34m",g="[32m",b="[39m",v="[31m"):(m="",g="",b="",v="")),"object"===p(u)&&null!==u&&"object"===p(c)&&null!==c&&"stack"in u&&u instanceof Error&&"stack"in c&&c instanceof Error&&(u=_(u),c=_(c)),"deepStrictEqual"===n||"strictEqual"===n)i=a(this,h(e).call(this,function(t,e,i){var s="",n="",a=0,l="",o=!1,u=x(t),c=u.split("\n"),h=x(e).split("\n"),d=0,f="";if("strictEqual"===i&&"object"===p(t)&&"object"===p(e)&&null!==t&&null!==e&&(i="strictEqualObject"),1===c.length&&1===h.length&&c[0]!==h[0]){var _=c[0].length+h[0].length;if(_<=10){if(!("object"===p(t)&&null!==t||"object"===p(e)&&null!==e||0===t&&0===e))return"".concat(w[i],"\n\n")+"".concat(c[0]," !== ").concat(h[0],"\n")}else if("strictEqualObject"!==i&&_<(r.stderr&&r.stderr.isTTY?r.stderr.columns:80)){for(;c[0][d]===h[0][d];)d++;d>2&&(f="\n  ".concat(function(t,e){if(e=Math.floor(e),0==t.length||0==e)return"";var i=t.length*e;for(e=Math.floor(Math.log(e)/Math.log(2));e;)t+=t,e--;return t+t.substring(0,i-t.length)}(" ",d),"^"),d=0)}}for(var O=c[c.length-1],S=h[h.length-1];O===S&&(d++<2?l="\n  ".concat(O).concat(l):s=O,c.pop(),h.pop(),0!==c.length&&0!==h.length);)O=c[c.length-1],S=h[h.length-1];var k=Math.max(c.length,h.length);if(0===k){var j=u.split("\n");if(j.length>30)for(j[26]="".concat(m,"...").concat(b);j.length>27;)j.pop();return"".concat(w.notIdentical,"\n\n").concat(j.join("\n"),"\n")}d>3&&(l="\n".concat(m,"...").concat(b).concat(l),o=!0),""!==s&&(l="\n  ".concat(s).concat(l),s="");var A=0,I=w[i]+"\n".concat(g,"+ actual").concat(b," ").concat(v,"- expected").concat(b),E=" ".concat(m,"...").concat(b," Lines skipped");for(d=0;d<k;d++){var D=d-a;if(c.length<d+1)D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(h[d-2]),A++),n+="\n  ".concat(h[d-1]),A++),a=d,s+="\n".concat(v,"-").concat(b," ").concat(h[d]),A++;else if(h.length<d+1)D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(b," ").concat(c[d]),A++;else{var C=h[d],N=c[d],L=N!==C&&(!y(N,",")||N.slice(0,-1)!==C);L&&y(C,",")&&C.slice(0,-1)===N&&(L=!1,N+=","),L?(D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(b," ").concat(N),s+="\n".concat(v,"-").concat(b," ").concat(C),A+=2):(n+=s,s="",1!==D&&0!==d||(n+="\n  ".concat(N),A++))}if(A>20&&d<k-2)return"".concat(I).concat(E,"\n").concat(n,"\n").concat(m,"...").concat(b).concat(s,"\n")+"".concat(m,"...").concat(b)}return"".concat(I).concat(o?E:"","\n").concat(n).concat(s).concat(l).concat(f)}(u,c,n)));else if("notDeepStrictEqual"===n||"notStrictEqual"===n){var O=w[n],S=x(u).split("\n");if("notStrictEqual"===n&&"object"===p(u)&&null!==u&&(O=w.notStrictEqualObject),S.length>30)for(S[26]="".concat(m,"...").concat(b);S.length>27;)S.pop();i=1===S.length?a(this,h(e).call(this,"".concat(O," ").concat(S[0]))):a(this,h(e).call(this,"".concat(O,"\n\n").concat(S.join("\n"),"\n")))}else{var k=x(u),j="",A=w[n];"notDeepEqual"===n||"notEqual"===n?(k="".concat(w[n],"\n\n").concat(k)).length>1024&&(k="".concat(k.slice(0,1021),"...")):(j="".concat(x(c)),k.length>512&&(k="".concat(k.slice(0,509),"...")),j.length>512&&(j="".concat(j.slice(0,509),"...")),"deepEqual"===n||"equal"===n?k="".concat(A,"\n\n").concat(k,"\n\nshould equal\n\n"):j=" ".concat(n," ").concat(j)),i=a(this,h(e).call(this,"".concat(k).concat(j)))}return Error.stackTraceLimit=d,i.generatedMessage=!s,Object.defineProperty(l(i),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),i.code="ERR_ASSERTION",i.actual=u,i.expected=c,i.operator=n,Error.captureStackTrace&&Error.captureStackTrace(l(i),o),i.stack,i.name="AssertionError",a(i)}var i,o;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&c(t,e)}(e,t),i=e,o=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:d.custom,value:function(t,e){return d(this,function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter((function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable})))),r.forEach((function(e){s(t,e,i[e])}))}return t}({},e,{customInspect:!1,depth:0}))}}],o&&n(i.prototype,o),e}(o(Error));t.exports=O},136:(t,e,i)=>{"use strict";function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function s(t){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},s(t)}function n(t,e){return n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},n(t,e)}var a,l,o={};function u(t,e,i){i||(i=Error);var a=function(i){function a(i,n,l){var o,u,c;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),u=this,c=s(a).call(this,function(t,i,r){return"string"==typeof e?e:e(t,i,r)}(i,n,l)),o=!c||"object"!==r(c)&&"function"!=typeof c?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(u):c,o.code=t,o}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&n(t,e)}(a,i),a}(i);o[t]=a}function c(t,e){if(Array.isArray(t)){var i=t.length;return t=t.map((function(t){return String(t)})),i>2?"one of ".concat(e," ").concat(t.slice(0,i-1).join(", "),", or ")+t[i-1]:2===i?"one of ".concat(e," ").concat(t[0]," or ").concat(t[1]):"of ".concat(e," ").concat(t[0])}return"of ".concat(e," ").concat(String(t))}u("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),u("ERR_INVALID_ARG_TYPE",(function(t,e,s){var n,l,o,u,h;if(void 0===a&&(a=i(282)),a("string"==typeof t,"'name' must be a string"),"string"==typeof e&&(l="not ",e.substr(0,4)===l)?(n="must not be",e=e.replace(/^not /,"")):n="must be",function(t,e,i){return(void 0===i||i>t.length)&&(i=t.length),t.substring(i-9,i)===e}(t," argument"))o="The ".concat(t," ").concat(n," ").concat(c(e,"type"));else{var p=("number"!=typeof h&&(h=0),h+1>(u=t).length||-1===u.indexOf(".",h)?"argument":"property");o='The "'.concat(t,'" ').concat(p," ").concat(n," ").concat(c(e,"type"))}return o+". Received type ".concat(r(s))}),TypeError),u("ERR_INVALID_ARG_VALUE",(function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===l&&(l=i(539));var s=l.inspect(e);return s.length>128&&(s="".concat(s.slice(0,128),"...")),"The argument '".concat(t,"' ").concat(r,". Received ").concat(s)}),TypeError,RangeError),u("ERR_INVALID_RETURN_VALUE",(function(t,e,i){var s;return s=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(r(i)),"Expected ".concat(t,' to be returned from the "').concat(e,'"')+" function but got ".concat(s,".")}),TypeError),u("ERR_MISSING_ARGS",(function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];void 0===a&&(a=i(282)),a(e.length>0,"At least one arg needs to be specified");var s="The ",n=e.length;switch(e=e.map((function(t){return'"'.concat(t,'"')})),n){case 1:s+="".concat(e[0]," argument");break;case 2:s+="".concat(e[0]," and ").concat(e[1]," arguments");break;default:s+=e.slice(0,n-1).join(", "),s+=", and ".concat(e[n-1]," arguments")}return"".concat(s," must be specified")}),TypeError),t.exports.codes=o},158:(t,e,i)=>{"use strict";function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],r=!0,s=!1,n=void 0;try{for(var a,l=t[Symbol.iterator]();!(r=(a=l.next()).done)&&(i.push(a.value),!e||i.length!==e);r=!0);}catch(t){s=!0,n=t}finally{try{r||null==l.return||l.return()}finally{if(s)throw n}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}var n=void 0!==/a/g.flags,a=function(t){var e=[];return t.forEach((function(t){return e.push(t)})),e},l=function(t){var e=[];return t.forEach((function(t,i){return e.push([i,t])})),e},o=Object.is?Object.is:i(609),u=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},c=Number.isNaN?Number.isNaN:i(360);function h(t){return t.call.bind(t)}var p=h(Object.prototype.hasOwnProperty),d=h(Object.prototype.propertyIsEnumerable),f=h(Object.prototype.toString),y=i(539).types,m=y.isAnyArrayBuffer,g=y.isArrayBufferView,v=y.isDate,b=y.isMap,w=y.isRegExp,_=y.isSet,x=y.isNativeError,O=y.isBoxedPrimitive,S=y.isNumberObject,k=y.isStringObject,j=y.isBooleanObject,A=y.isBigIntObject,I=y.isSymbolObject,E=y.isFloat32Array,D=y.isFloat64Array;function C(t){if(0===t.length||t.length>10)return!0;for(var e=0;e<t.length;e++){var i=t.charCodeAt(e);if(i<48||i>57)return!0}return 10===t.length&&t>=Math.pow(2,32)}function N(t){return Object.keys(t).filter(C).concat(u(t).filter(Object.prototype.propertyIsEnumerable.bind(t)))}function L(t,e){if(t===e)return 0;for(var i=t.length,r=e.length,s=0,n=Math.min(i,r);s<n;++s)if(t[s]!==e[s]){i=t[s],r=e[s];break}return i<r?-1:r<i?1:0}var T=0,P=1,R=2,q=3;function U(t,e,i,r){if(t===e)return 0!==t||!i||o(t,e);if(i){if("object"!==s(t))return"number"==typeof t&&c(t)&&c(e);if("object"!==s(e)||null===t||null===e)return!1;if(Object.getPrototypeOf(t)!==Object.getPrototypeOf(e))return!1}else{if(null===t||"object"!==s(t))return(null===e||"object"!==s(e))&&t==e;if(null===e||"object"!==s(e))return!1}var a,l,u,h,p=f(t);if(p!==f(e))return!1;if(Array.isArray(t)){if(t.length!==e.length)return!1;var d=N(t),y=N(e);return d.length===y.length&&B(t,e,i,r,P,d)}if("[object Object]"===p&&(!b(t)&&b(e)||!_(t)&&_(e)))return!1;if(v(t)){if(!v(e)||Date.prototype.getTime.call(t)!==Date.prototype.getTime.call(e))return!1}else if(w(t)){if(!w(e)||(u=t,h=e,!(n?u.source===h.source&&u.flags===h.flags:RegExp.prototype.toString.call(u)===RegExp.prototype.toString.call(h))))return!1}else if(x(t)||t instanceof Error){if(t.message!==e.message||t.name!==e.name)return!1}else{if(g(t)){if(i||!E(t)&&!D(t)){if(!function(t,e){return t.byteLength===e.byteLength&&0===L(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),new Uint8Array(e.buffer,e.byteOffset,e.byteLength))}(t,e))return!1}else if(!function(t,e){if(t.byteLength!==e.byteLength)return!1;for(var i=0;i<t.byteLength;i++)if(t[i]!==e[i])return!1;return!0}(t,e))return!1;var C=N(t),U=N(e);return C.length===U.length&&B(t,e,i,r,T,C)}if(_(t))return!(!_(e)||t.size!==e.size)&&B(t,e,i,r,R);if(b(t))return!(!b(e)||t.size!==e.size)&&B(t,e,i,r,q);if(m(t)){if(l=e,(a=t).byteLength!==l.byteLength||0!==L(new Uint8Array(a),new Uint8Array(l)))return!1}else if(O(t)&&!function(t,e){return S(t)?S(e)&&o(Number.prototype.valueOf.call(t),Number.prototype.valueOf.call(e)):k(t)?k(e)&&String.prototype.valueOf.call(t)===String.prototype.valueOf.call(e):j(t)?j(e)&&Boolean.prototype.valueOf.call(t)===Boolean.prototype.valueOf.call(e):A(t)?A(e)&&BigInt.prototype.valueOf.call(t)===BigInt.prototype.valueOf.call(e):I(e)&&Symbol.prototype.valueOf.call(t)===Symbol.prototype.valueOf.call(e)}(t,e))return!1}return B(t,e,i,r,T)}function W(t,e){return e.filter((function(e){return d(t,e)}))}function B(t,e,i,n,o,c){if(5===arguments.length){c=Object.keys(t);var h=Object.keys(e);if(c.length!==h.length)return!1}for(var f=0;f<c.length;f++)if(!p(e,c[f]))return!1;if(i&&5===arguments.length){var y=u(t);if(0!==y.length){var m=0;for(f=0;f<y.length;f++){var g=y[f];if(d(t,g)){if(!d(e,g))return!1;c.push(g),m++}else if(d(e,g))return!1}var v=u(e);if(y.length!==v.length&&W(e,v).length!==m)return!1}else{var b=u(e);if(0!==b.length&&0!==W(e,b).length)return!1}}if(0===c.length&&(o===T||o===P&&0===t.length||0===t.size))return!0;if(void 0===n)n={val1:new Map,val2:new Map,position:0};else{var w=n.val1.get(t);if(void 0!==w){var _=n.val2.get(e);if(void 0!==_)return w===_}n.position++}n.val1.set(t,n.position),n.val2.set(e,n.position);var x=function(t,e,i,n,o,u){var c=0;if(u===R){if(!function(t,e,i,r){for(var n=null,l=a(t),o=0;o<l.length;o++){var u=l[o];if("object"===s(u)&&null!==u)null===n&&(n=new Set),n.add(u);else if(!e.has(u)){if(i)return!1;if(!F(t,e,u))return!1;null===n&&(n=new Set),n.add(u)}}if(null!==n){for(var c=a(e),h=0;h<c.length;h++){var p=c[h];if("object"===s(p)&&null!==p){if(!M(n,p,i,r))return!1}else if(!i&&!t.has(p)&&!M(n,p,i,r))return!1}return 0===n.size}return!0}(t,e,i,o))return!1}else if(u===q){if(!function(t,e,i,n){for(var a=null,o=l(t),u=0;u<o.length;u++){var c=r(o[u],2),h=c[0],p=c[1];if("object"===s(h)&&null!==h)null===a&&(a=new Set),a.add(h);else{var d=e.get(h);if(void 0===d&&!e.has(h)||!U(p,d,i,n)){if(i)return!1;if(!J(t,e,h,p,n))return!1;null===a&&(a=new Set),a.add(h)}}}if(null!==a){for(var f=l(e),y=0;y<f.length;y++){var m=r(f[y],2),g=(h=m[0],m[1]);if("object"===s(h)&&null!==h){if(!$(a,t,h,g,i,n))return!1}else if(!(i||t.has(h)&&U(t.get(h),g,!1,n)||$(a,t,h,g,!1,n)))return!1}return 0===a.size}return!0}(t,e,i,o))return!1}else if(u===P)for(;c<t.length;c++){if(!p(t,c)){if(p(e,c))return!1;for(var h=Object.keys(t);c<h.length;c++){var d=h[c];if(!p(e,d)||!U(t[d],e[d],i,o))return!1}return h.length===Object.keys(e).length}if(!p(e,c)||!U(t[c],e[c],i,o))return!1}for(c=0;c<n.length;c++){var f=n[c];if(!U(t[f],e[f],i,o))return!1}return!0}(t,e,i,c,n,o);return n.val1.delete(t),n.val2.delete(e),x}function M(t,e,i,r){for(var s=a(t),n=0;n<s.length;n++){var l=s[n];if(U(e,l,i,r))return t.delete(l),!0}return!1}function z(t){switch(s(t)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":t=+t;case"number":if(c(t))return!1}return!0}function F(t,e,i){var r=z(i);return null!=r?r:e.has(r)&&!t.has(r)}function J(t,e,i,r,s){var n=z(i);if(null!=n)return n;var a=e.get(n);return!(void 0===a&&!e.has(n)||!U(r,a,!1,s))&&!t.has(n)&&U(r,a,!1,s)}function $(t,e,i,r,s,n){for(var l=a(t),o=0;o<l.length;o++){var u=l[o];if(U(i,u,s,n)&&U(r,e.get(u),s,n))return t.delete(u),!0}return!1}t.exports={isDeepEqual:function(t,e){return U(t,e,!1)},isDeepStrictEqual:function(t,e){return U(t,e,!0)}}},742:(t,e)=>{"use strict";e.byteLength=function(t){var e=l(t),i=e[0],r=e[1];return 3*(i+r)/4-r},e.toByteArray=function(t){var e,i,n=l(t),a=n[0],o=n[1],u=new s(function(t,e,i){return 3*(e+i)/4-i}(0,a,o)),c=0,h=o>0?a-4:a;for(i=0;i<h;i+=4)e=r[t.charCodeAt(i)]<<18|r[t.charCodeAt(i+1)]<<12|r[t.charCodeAt(i+2)]<<6|r[t.charCodeAt(i+3)],u[c++]=e>>16&255,u[c++]=e>>8&255,u[c++]=255&e;return 2===o&&(e=r[t.charCodeAt(i)]<<2|r[t.charCodeAt(i+1)]>>4,u[c++]=255&e),1===o&&(e=r[t.charCodeAt(i)]<<10|r[t.charCodeAt(i+1)]<<4|r[t.charCodeAt(i+2)]>>2,u[c++]=e>>8&255,u[c++]=255&e),u},e.fromByteArray=function(t){for(var e,r=t.length,s=r%3,n=[],a=16383,l=0,u=r-s;l<u;l+=a)n.push(o(t,l,l+a>u?u:l+a));return 1===s?(e=t[r-1],n.push(i[e>>2]+i[e<<4&63]+"==")):2===s&&(e=(t[r-2]<<8)+t[r-1],n.push(i[e>>10]+i[e>>4&63]+i[e<<2&63]+"=")),n.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)i[a]=n[a],r[n.charCodeAt(a)]=a;function l(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function o(t,e,r){for(var s,n,a=[],l=e;l<r;l+=3)s=(t[l]<<16&16711680)+(t[l+1]<<8&65280)+(255&t[l+2]),a.push(i[(n=s)>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(t,e,i)=>{"use strict";var r=i(108);const s=i(742),n=i(645),a="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.lW=u,e.h2=50;const l=2147483647;function o(t){if(t>l)throw new RangeError('The value "'+t+'" is invalid for option "size"');const e=new Uint8Array(t);return Object.setPrototypeOf(e,u.prototype),e}function u(t,e,i){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return p(t)}return c(t,e,i)}function c(t,e,i){if("string"==typeof t)return function(t,e){if("string"==typeof e&&""!==e||(e="utf8"),!u.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const i=0|m(t,e);let r=o(i);const s=r.write(t,e);return s!==i&&(r=r.slice(0,s)),r}(t,e);if(ArrayBuffer.isView(t))return function(t){if(H(t,Uint8Array)){const e=new Uint8Array(t);return f(e.buffer,e.byteOffset,e.byteLength)}return d(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(H(t,ArrayBuffer)||t&&H(t.buffer,ArrayBuffer))return f(t,e,i);if("undefined"!=typeof SharedArrayBuffer&&(H(t,SharedArrayBuffer)||t&&H(t.buffer,SharedArrayBuffer)))return f(t,e,i);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=t.valueOf&&t.valueOf();if(null!=r&&r!==t)return u.from(r,e,i);const s=function(t){if(u.isBuffer(t)){const e=0|y(t.length),i=o(e);return 0===i.length||t.copy(i,0,0,e),i}return void 0!==t.length?"number"!=typeof t.length||Z(t.length)?o(0):d(t):"Buffer"===t.type&&Array.isArray(t.data)?d(t.data):void 0}(t);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return u.from(t[Symbol.toPrimitive]("string"),e,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function h(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function p(t){return h(t),o(t<0?0:0|y(t))}function d(t){const e=t.length<0?0:0|y(t.length),i=o(e);for(let r=0;r<e;r+=1)i[r]=255&t[r];return i}function f(t,e,i){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===e&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,e):new Uint8Array(t,e,i),Object.setPrototypeOf(r,u.prototype),r}function y(t){if(t>=l)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l.toString(16)+" bytes");return 0|t}function m(t,e){if(u.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||H(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);const i=t.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return G(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return X(t).length;default:if(s)return r?-1:G(t).length;e=(""+e).toLowerCase(),s=!0}}function g(t,e,i){let r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return C(this,e,i);case"utf8":case"utf-8":return A(this,e,i);case"ascii":return E(this,e,i);case"latin1":case"binary":return D(this,e,i);case"base64":return j(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,e,i);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function v(t,e,i){const r=t[e];t[e]=t[i],t[i]=r}function b(t,e,i,r,s){if(0===t.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Z(i=+i)&&(i=s?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(s)return-1;i=t.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof e&&(e=u.from(e,r)),u.isBuffer(e))return 0===e.length?-1:w(t,e,i,r,s);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):w(t,[e],i,r,s);throw new TypeError("val must be string, number or Buffer")}function w(t,e,i,r,s){let n,a=1,l=t.length,o=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;a=2,l/=2,o/=2,i/=2}function u(t,e){return 1===a?t[e]:t.readUInt16BE(e*a)}if(s){let r=-1;for(n=i;n<l;n++)if(u(t,n)===u(e,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===o)return r*a}else-1!==r&&(n-=n-r),r=-1}else for(i+o>l&&(i=l-o),n=i;n>=0;n--){let i=!0;for(let r=0;r<o;r++)if(u(t,n+r)!==u(e,r)){i=!1;break}if(i)return n}return-1}function _(t,e,i,r){i=Number(i)||0;const s=t.length-i;r?(r=Number(r))>s&&(r=s):r=s;const n=e.length;let a;for(r>n/2&&(r=n/2),a=0;a<r;++a){const r=parseInt(e.substr(2*a,2),16);if(Z(r))return a;t[i+a]=r}return a}function x(t,e,i,r){return Y(G(e,t.length-i),t,i,r)}function O(t,e,i,r){return Y(function(t){const e=[];for(let i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,r)}function S(t,e,i,r){return Y(X(e),t,i,r)}function k(t,e,i,r){return Y(function(t,e){let i,r,s;const n=[];for(let a=0;a<t.length&&!((e-=2)<0);++a)i=t.charCodeAt(a),r=i>>8,s=i%256,n.push(s),n.push(r);return n}(e,t.length-i),t,i,r)}function j(t,e,i){return 0===e&&i===t.length?s.fromByteArray(t):s.fromByteArray(t.slice(e,i))}function A(t,e,i){i=Math.min(t.length,i);const r=[];let s=e;for(;s<i;){const e=t[s];let n=null,a=e>239?4:e>223?3:e>191?2:1;if(s+a<=i){let i,r,l,o;switch(a){case 1:e<128&&(n=e);break;case 2:i=t[s+1],128==(192&i)&&(o=(31&e)<<6|63&i,o>127&&(n=o));break;case 3:i=t[s+1],r=t[s+2],128==(192&i)&&128==(192&r)&&(o=(15&e)<<12|(63&i)<<6|63&r,o>2047&&(o<55296||o>57343)&&(n=o));break;case 4:i=t[s+1],r=t[s+2],l=t[s+3],128==(192&i)&&128==(192&r)&&128==(192&l)&&(o=(15&e)<<18|(63&i)<<12|(63&r)<<6|63&l,o>65535&&o<1114112&&(n=o))}}null===n?(n=65533,a=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=a}return function(t){const e=t.length;if(e<=I)return String.fromCharCode.apply(String,t);let i="",r=0;for(;r<e;)i+=String.fromCharCode.apply(String,t.slice(r,r+=I));return i}(r)}u.TYPED_ARRAY_SUPPORT=function(){try{const t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),u.TYPED_ARRAY_SUPPORT||void 0===r||"function"!=typeof r.error||r.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}}),u.poolSize=8192,u.from=function(t,e,i){return c(t,e,i)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array),u.alloc=function(t,e,i){return function(t,e,i){return h(t),t<=0?o(t):void 0!==e?"string"==typeof i?o(t).fill(e,i):o(t).fill(e):o(t)}(t,e,i)},u.allocUnsafe=function(t){return p(t)},u.allocUnsafeSlow=function(t){return p(t)},u.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==u.prototype},u.compare=function(t,e){if(H(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),!u.isBuffer(t)||!u.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let i=t.length,r=e.length;for(let s=0,n=Math.min(i,r);s<n;++s)if(t[s]!==e[s]){i=t[s],r=e[s];break}return i<r?-1:r<i?1:0},u.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return u.alloc(0);let i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;const r=u.allocUnsafe(e);let s=0;for(i=0;i<t.length;++i){let e=t[i];if(H(e,Uint8Array))s+e.length>r.length?(u.isBuffer(e)||(e=u.from(e)),e.copy(r,s)):Uint8Array.prototype.set.call(r,e,s);else{if(!u.isBuffer(e))throw new TypeError('"list" argument must be an Array of Buffers');e.copy(r,s)}s+=e.length}return r},u.byteLength=m,u.prototype._isBuffer=!0,u.prototype.swap16=function(){const t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)v(this,e,e+1);return this},u.prototype.swap32=function(){const t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)v(this,e,e+3),v(this,e+1,e+2);return this},u.prototype.swap64=function(){const t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)v(this,e,e+7),v(this,e+1,e+6),v(this,e+2,e+5),v(this,e+3,e+4);return this},u.prototype.toString=function(){const t=this.length;return 0===t?"":0===arguments.length?A(this,0,t):g.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(t){if(!u.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===u.compare(this,t)},u.prototype.inspect=function(){let t="";const i=e.h2;return t=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(t+=" ... "),"<Buffer "+t+">"},a&&(u.prototype[a]=u.prototype.inspect),u.prototype.compare=function(t,e,i,r,s){if(H(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),!u.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),e<0||i>t.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&e>=i)return 0;if(r>=s)return-1;if(e>=i)return 1;if(this===t)return 0;let n=(s>>>=0)-(r>>>=0),a=(i>>>=0)-(e>>>=0);const l=Math.min(n,a),o=this.slice(r,s),c=t.slice(e,i);for(let t=0;t<l;++t)if(o[t]!==c[t]){n=o[t],a=c[t];break}return n<a?-1:a<n?1:0},u.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},u.prototype.indexOf=function(t,e,i){return b(this,t,e,i,!0)},u.prototype.lastIndexOf=function(t,e,i){return b(this,t,e,i,!1)},u.prototype.write=function(t,e,i,r){if(void 0===e)r="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)r=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-e;if((void 0===i||i>s)&&(i=s),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return _(this,t,e,i);case"utf8":case"utf-8":return x(this,t,e,i);case"ascii":case"latin1":case"binary":return O(this,t,e,i);case"base64":return S(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,t,e,i);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const I=4096;function E(t,e,i){let r="";i=Math.min(t.length,i);for(let s=e;s<i;++s)r+=String.fromCharCode(127&t[s]);return r}function D(t,e,i){let r="";i=Math.min(t.length,i);for(let s=e;s<i;++s)r+=String.fromCharCode(t[s]);return r}function C(t,e,i){const r=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=e;r<i;++r)s+=K[t[r]];return s}function N(t,e,i){const r=t.slice(e,i);let s="";for(let t=0;t<r.length-1;t+=2)s+=String.fromCharCode(r[t]+256*r[t+1]);return s}function L(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function T(t,e,i,r,s,n){if(!u.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>s||e<n)throw new RangeError('"value" argument is out of bounds');if(i+r>t.length)throw new RangeError("Index out of range")}function P(t,e,i,r,s){F(e,r,s,t,i,7);let n=Number(e&BigInt(4294967295));t[i++]=n,n>>=8,t[i++]=n,n>>=8,t[i++]=n,n>>=8,t[i++]=n;let a=Number(e>>BigInt(32)&BigInt(4294967295));return t[i++]=a,a>>=8,t[i++]=a,a>>=8,t[i++]=a,a>>=8,t[i++]=a,i}function R(t,e,i,r,s){F(e,r,s,t,i,7);let n=Number(e&BigInt(4294967295));t[i+7]=n,n>>=8,t[i+6]=n,n>>=8,t[i+5]=n,n>>=8,t[i+4]=n;let a=Number(e>>BigInt(32)&BigInt(4294967295));return t[i+3]=a,a>>=8,t[i+2]=a,a>>=8,t[i+1]=a,a>>=8,t[i]=a,i+8}function q(t,e,i,r,s,n){if(i+r>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function U(t,e,i,r,s){return e=+e,i>>>=0,s||q(t,0,i,4),n.write(t,e,i,r,23,4),i+4}function W(t,e,i,r,s){return e=+e,i>>>=0,s||q(t,0,i,8),n.write(t,e,i,r,52,8),i+8}u.prototype.slice=function(t,e){const i=this.length;(t=~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),(e=void 0===e?i:~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),e<t&&(e=t);const r=this.subarray(t,e);return Object.setPrototypeOf(r,u.prototype),r},u.prototype.readUintLE=u.prototype.readUIntLE=function(t,e,i){t>>>=0,e>>>=0,i||L(t,e,this.length);let r=this[t],s=1,n=0;for(;++n<e&&(s*=256);)r+=this[t+n]*s;return r},u.prototype.readUintBE=u.prototype.readUIntBE=function(t,e,i){t>>>=0,e>>>=0,i||L(t,e,this.length);let r=this[t+--e],s=1;for(;e>0&&(s*=256);)r+=this[t+--e]*s;return r},u.prototype.readUint8=u.prototype.readUInt8=function(t,e){return t>>>=0,e||L(t,1,this.length),this[t]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(t,e){return t>>>=0,e||L(t,2,this.length),this[t]|this[t+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(t,e){return t>>>=0,e||L(t,2,this.length),this[t]<<8|this[t+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(t,e){return t>>>=0,e||L(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(t,e){return t>>>=0,e||L(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},u.prototype.readBigUInt64LE=Q((function(t){J(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||$(t,this.length-8);const r=e+256*this[++t]+65536*this[++t]+this[++t]*2**24,s=this[++t]+256*this[++t]+65536*this[++t]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),u.prototype.readBigUInt64BE=Q((function(t){J(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||$(t,this.length-8);const r=e*2**24+65536*this[++t]+256*this[++t]+this[++t],s=this[++t]*2**24+65536*this[++t]+256*this[++t]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),u.prototype.readIntLE=function(t,e,i){t>>>=0,e>>>=0,i||L(t,e,this.length);let r=this[t],s=1,n=0;for(;++n<e&&(s*=256);)r+=this[t+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*e)),r},u.prototype.readIntBE=function(t,e,i){t>>>=0,e>>>=0,i||L(t,e,this.length);let r=e,s=1,n=this[t+--r];for(;r>0&&(s*=256);)n+=this[t+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*e)),n},u.prototype.readInt8=function(t,e){return t>>>=0,e||L(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},u.prototype.readInt16LE=function(t,e){t>>>=0,e||L(t,2,this.length);const i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt16BE=function(t,e){t>>>=0,e||L(t,2,this.length);const i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt32LE=function(t,e){return t>>>=0,e||L(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},u.prototype.readInt32BE=function(t,e){return t>>>=0,e||L(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},u.prototype.readBigInt64LE=Q((function(t){J(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||$(t,this.length-8);const r=this[t+4]+256*this[t+5]+65536*this[t+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(e+256*this[++t]+65536*this[++t]+this[++t]*2**24)})),u.prototype.readBigInt64BE=Q((function(t){J(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||$(t,this.length-8);const r=(e<<24)+65536*this[++t]+256*this[++t]+this[++t];return(BigInt(r)<<BigInt(32))+BigInt(this[++t]*2**24+65536*this[++t]+256*this[++t]+i)})),u.prototype.readFloatLE=function(t,e){return t>>>=0,e||L(t,4,this.length),n.read(this,t,!0,23,4)},u.prototype.readFloatBE=function(t,e){return t>>>=0,e||L(t,4,this.length),n.read(this,t,!1,23,4)},u.prototype.readDoubleLE=function(t,e){return t>>>=0,e||L(t,8,this.length),n.read(this,t,!0,52,8)},u.prototype.readDoubleBE=function(t,e){return t>>>=0,e||L(t,8,this.length),n.read(this,t,!1,52,8)},u.prototype.writeUintLE=u.prototype.writeUIntLE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||T(this,t,e,i,Math.pow(2,8*i)-1,0);let s=1,n=0;for(this[e]=255&t;++n<i&&(s*=256);)this[e+n]=t/s&255;return e+i},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||T(this,t,e,i,Math.pow(2,8*i)-1,0);let s=i-1,n=1;for(this[e+s]=255&t;--s>=0&&(n*=256);)this[e+s]=t/n&255;return e+i},u.prototype.writeUint8=u.prototype.writeUInt8=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,1,255,0),this[e]=255&t,e+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},u.prototype.writeBigUInt64LE=Q((function(t,e=0){return P(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeBigUInt64BE=Q((function(t,e=0){return R(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeIntLE=function(t,e,i,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*i-1);T(this,t,e,i,r-1,-r)}let s=0,n=1,a=0;for(this[e]=255&t;++s<i&&(n*=256);)t<0&&0===a&&0!==this[e+s-1]&&(a=1),this[e+s]=(t/n>>0)-a&255;return e+i},u.prototype.writeIntBE=function(t,e,i,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*i-1);T(this,t,e,i,r-1,-r)}let s=i-1,n=1,a=0;for(this[e+s]=255&t;--s>=0&&(n*=256);)t<0&&0===a&&0!==this[e+s+1]&&(a=1),this[e+s]=(t/n>>0)-a&255;return e+i},u.prototype.writeInt8=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},u.prototype.writeInt16LE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},u.prototype.writeInt16BE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},u.prototype.writeInt32LE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},u.prototype.writeInt32BE=function(t,e,i){return t=+t,e>>>=0,i||T(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},u.prototype.writeBigInt64LE=Q((function(t,e=0){return P(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeBigInt64BE=Q((function(t,e=0){return R(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeFloatLE=function(t,e,i){return U(this,t,e,!0,i)},u.prototype.writeFloatBE=function(t,e,i){return U(this,t,e,!1,i)},u.prototype.writeDoubleLE=function(t,e,i){return W(this,t,e,!0,i)},u.prototype.writeDoubleBE=function(t,e,i){return W(this,t,e,!1,i)},u.prototype.copy=function(t,e,i,r){if(!u.isBuffer(t))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-i&&(r=t.length-e+i);const s=r-i;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,i,r):Uint8Array.prototype.set.call(t,this.subarray(i,r),e),s},u.prototype.fill=function(t,e,i,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===t.length){const e=t.charCodeAt(0);("utf8"===r&&e<128||"latin1"===r)&&(t=e)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;let s;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(s=e;s<i;++s)this[s]=t;else{const n=u.isBuffer(t)?t:u.from(t,r),a=n.length;if(0===a)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(s=0;s<i-e;++s)this[s+e]=n[s%a]}return this};const B={};function M(t,e,i){B[t]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function z(t){let e="",i=t.length;const r="-"===t[0]?1:0;for(;i>=r+4;i-=3)e=`_${t.slice(i-3,i)}${e}`;return`${t.slice(0,i)}${e}`}function F(t,e,i,r,s,n){if(t>i||t<e){const r="bigint"==typeof e?"n":"";let s;throw s=n>3?0===e||e===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(n+1)}${r}`:`>= -(2${r} ** ${8*(n+1)-1}${r}) and < 2 ** ${8*(n+1)-1}${r}`:`>= ${e}${r} and <= ${i}${r}`,new B.ERR_OUT_OF_RANGE("value",s,t)}!function(t,e,i){J(e,"offset"),void 0!==t[e]&&void 0!==t[e+i]||$(e,t.length-(i+1))}(r,s,n)}function J(t,e){if("number"!=typeof t)throw new B.ERR_INVALID_ARG_TYPE(e,"number",t)}function $(t,e,i){if(Math.floor(t)!==t)throw J(t,i),new B.ERR_OUT_OF_RANGE(i||"offset","an integer",t);if(e<0)throw new B.ERR_BUFFER_OUT_OF_BOUNDS;throw new B.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${e}`,t)}M("ERR_BUFFER_OUT_OF_BOUNDS",(function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),M("ERR_INVALID_ARG_TYPE",(function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`}),TypeError),M("ERR_OUT_OF_RANGE",(function(t,e,i){let r=`The value of "${t}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=z(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=z(s)),s+="n"),r+=` It must be ${e}. Received ${s}`,r}),RangeError);const V=/[^+/0-9A-Za-z-_]/g;function G(t,e){let i;e=e||1/0;const r=t.length;let s=null;const n=[];for(let a=0;a<r;++a){if(i=t.charCodeAt(a),i>55295&&i<57344){if(!s){if(i>56319){(e-=3)>-1&&n.push(239,191,189);continue}if(a+1===r){(e-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(e-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(e-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((e-=1)<0)break;n.push(i)}else if(i<2048){if((e-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function X(t){return s.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(V,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function Y(t,e,i,r){let s;for(s=0;s<r&&!(s+i>=e.length||s>=t.length);++s)e[s+i]=t[s];return s}function H(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function Z(t){return t!=t}const K=function(){const t="0123456789abcdef",e=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)e[r+s]=t[i]+t[s]}return e}();function Q(t){return"undefined"==typeof BigInt?tt:t}function tt(){throw new Error("BigInt not supported")}},924:(t,e,i)=>{"use strict";var r=i(210),s=i(559),n=s(r("String.prototype.indexOf"));t.exports=function(t,e){var i=r(t,!!e);return"function"==typeof i&&n(t,".prototype.")>-1?s(i):i}},559:(t,e,i)=>{"use strict";var r=i(612),s=i(210),n=s("%Function.prototype.apply%"),a=s("%Function.prototype.call%"),l=s("%Reflect.apply%",!0)||r.call(a,n),o=s("%Object.getOwnPropertyDescriptor%",!0),u=s("%Object.defineProperty%",!0),c=s("%Math.max%");if(u)try{u({},"a",{value:1})}catch(t){u=null}t.exports=function(t){var e=l(r,a,arguments);return o&&u&&o(e,"length").configurable&&u(e,"length",{value:1+c(0,t.length-(arguments.length-1))}),e};var h=function(){return l(r,n,arguments)};u?u(t.exports,"apply",{value:h}):t.exports.apply=h},108:(t,e,i)=>{var r=i(539),s=i(282);function n(){return(new Date).getTime()}var a,l=Array.prototype.slice,o={};a=void 0!==i.g&&i.g.console?i.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){a.log.apply(a,arguments)},"info"],[function(){a.log.apply(a,arguments)},"warn"],[function(){a.warn.apply(a,arguments)},"error"],[function(t){o[t]=n()},"time"],[function(t){var e=o[t];if(!e)throw new Error("No such label: "+t);delete o[t];var i=n()-e;a.log(t+": "+i+"ms")},"timeEnd"],[function(){var t=new Error;t.name="Trace",t.message=r.format.apply(null,arguments),a.error(t.stack)},"trace"],[function(t){a.log(r.inspect(t)+"\n")},"dir"],[function(t){if(!t){var e=l.call(arguments,1);s.ok(!1,r.format.apply(null,e))}},"assert"]],c=0;c<u.length;c++){var h=u[c],p=h[0],d=h[1];a[d]||(a[d]=p)}t.exports=a},289:(t,e,i)=>{"use strict";var r=i(215),s="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),n=Object.prototype.toString,a=Array.prototype.concat,l=Object.defineProperty,o=i(44)(),u=l&&o,c=function(t,e,i,r){if(e in t)if(!0===r){if(t[e]===i)return}else if("function"!=typeof(s=r)||"[object Function]"!==n.call(s)||!r())return;var s;u?l(t,e,{configurable:!0,enumerable:!1,value:i,writable:!0}):t[e]=i},h=function(t,e){var i=arguments.length>2?arguments[2]:{},n=r(e);s&&(n=a.call(n,Object.getOwnPropertySymbols(e)));for(var l=0;l<n.length;l+=1)c(t,n[l],e[n[l]],i[n[l]])};h.supportsDescriptors=!!u,t.exports=h},91:t=>{"use strict";function e(t,e){if(null==t)throw new TypeError("Cannot convert first argument to object");for(var i=Object(t),r=1;r<arguments.length;r++){var s=arguments[r];if(null!=s)for(var n=Object.keys(Object(s)),a=0,l=n.length;a<l;a++){var o=n[a],u=Object.getOwnPropertyDescriptor(s,o);void 0!==u&&u.enumerable&&(i[o]=s[o])}}return i}t.exports={assign:e,polyfill:function(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:e})}}},29:(t,e,i)=>{"use strict";var r=i(320),s=Object.prototype.toString,n=Object.prototype.hasOwnProperty;t.exports=function(t,e,i){if(!r(e))throw new TypeError("iterator must be a function");var a;arguments.length>=3&&(a=i),"[object Array]"===s.call(t)?function(t,e,i){for(var r=0,s=t.length;r<s;r++)n.call(t,r)&&(null==i?e(t[r],r,t):e.call(i,t[r],r,t))}(t,e,a):"string"==typeof t?function(t,e,i){for(var r=0,s=t.length;r<s;r++)null==i?e(t.charAt(r),r,t):e.call(i,t.charAt(r),r,t)}(t,e,a):function(t,e,i){for(var r in t)n.call(t,r)&&(null==i?e(t[r],r,t):e.call(i,t[r],r,t))}(t,e,a)}},648:t=>{"use strict";var e=Array.prototype.slice,i=Object.prototype.toString;t.exports=function(t){var r=this;if("function"!=typeof r||"[object Function]"!==i.call(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,n=e.call(arguments,1),a=Math.max(0,r.length-n.length),l=[],o=0;o<a;o++)l.push("$"+o);if(s=Function("binder","return function ("+l.join(",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var i=r.apply(this,n.concat(e.call(arguments)));return Object(i)===i?i:this}return r.apply(t,n.concat(e.call(arguments)))})),r.prototype){var u=function(){};u.prototype=r.prototype,s.prototype=new u,u.prototype=null}return s}},612:(t,e,i)=>{"use strict";var r=i(648);t.exports=Function.prototype.bind||r},210:(t,e,i)=>{"use strict";var r,s=SyntaxError,n=Function,a=TypeError,l=function(t){try{return n('"use strict"; return ('+t+").constructor;")()}catch(t){}},o=Object.getOwnPropertyDescriptor;if(o)try{o({},"")}catch(t){o=null}var u=function(){throw new a},c=o?function(){try{return u}catch(t){try{return o(arguments,"callee").get}catch(t){return u}}}():u,h=i(405)(),p=Object.getPrototypeOf||function(t){return t.__proto__},d={},f="undefined"==typeof Uint8Array?r:p(Uint8Array),y={"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":h?p([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":d,"%AsyncGenerator%":d,"%AsyncGeneratorFunction%":d,"%AsyncIteratorPrototype%":d,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":n,"%GeneratorFunction%":d,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":h?p(p([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&h?p((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&h?p((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":h?p(""[Symbol.iterator]()):r,"%Symbol%":h?Symbol:r,"%SyntaxError%":s,"%ThrowTypeError%":c,"%TypedArray%":f,"%TypeError%":a,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};try{null.error}catch(t){var m=p(p(t));y["%Error.prototype%"]=m}var g=function t(e){var i;if("%AsyncFunction%"===e)i=l("async function () {}");else if("%GeneratorFunction%"===e)i=l("function* () {}");else if("%AsyncGeneratorFunction%"===e)i=l("async function* () {}");else if("%AsyncGenerator%"===e){var r=t("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===e){var s=t("%AsyncGenerator%");s&&(i=p(s.prototype))}return y[e]=i,i},v={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},b=i(612),w=i(642),_=b.call(Function.call,Array.prototype.concat),x=b.call(Function.apply,Array.prototype.splice),O=b.call(Function.call,String.prototype.replace),S=b.call(Function.call,String.prototype.slice),k=b.call(Function.call,RegExp.prototype.exec),j=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,A=/\\(\\)?/g,I=function(t,e){var i,r=t;if(w(v,r)&&(r="%"+(i=v[r])[0]+"%"),w(y,r)){var n=y[r];if(n===d&&(n=g(r)),void 0===n&&!e)throw new a("intrinsic "+t+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:n}}throw new s("intrinsic "+t+" does not exist!")};t.exports=function(t,e){if("string"!=typeof t||0===t.length)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof e)throw new a('"allowMissing" argument must be a boolean');if(null===k(/^%?[^%]*%?$/,t))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(t){var e=S(t,0,1),i=S(t,-1);if("%"===e&&"%"!==i)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==e)throw new s("invalid intrinsic syntax, expected opening `%`");var r=[];return O(t,j,(function(t,e,i,s){r[r.length]=i?O(s,A,"$1"):e||t})),r}(t),r=i.length>0?i[0]:"",n=I("%"+r+"%",e),l=n.name,u=n.value,c=!1,h=n.alias;h&&(r=h[0],x(i,_([0,1],h)));for(var p=1,d=!0;p<i.length;p+=1){var f=i[p],m=S(f,0,1),g=S(f,-1);if(('"'===m||"'"===m||"`"===m||'"'===g||"'"===g||"`"===g)&&m!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==f&&d||(c=!0),w(y,l="%"+(r+="."+f)+"%"))u=y[l];else if(null!=u){if(!(f in u)){if(!e)throw new a("base intrinsic for "+t+" exists, but the property is not available.");return}if(o&&p+1>=i.length){var v=o(u,f);u=(d=!!v)&&"get"in v&&!("originalValue"in v.get)?v.get:u[f]}else d=w(u,f),u=u[f];d&&!c&&(y[l]=u)}}return u}},296:(t,e,i)=>{"use strict";var r=i(210)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(t){r=null}t.exports=r},44:(t,e,i)=>{"use strict";var r=i(210)("%Object.defineProperty%",!0),s=function(){if(r)try{return r({},"a",{value:1}),!0}catch(t){return!1}return!1};s.hasArrayLengthDefineBug=function(){if(!s())return null;try{return 1!==r([],"length",{value:1}).length}catch(t){return!0}},t.exports=s},405:(t,e,i)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,s=i(419);t.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&s()}},419:t=>{"use strict";t.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var t={},e=Symbol("test"),i=Object(e);if("string"==typeof e)return!1;if("[object Symbol]"!==Object.prototype.toString.call(e))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(e in t[e]=42,t)return!1;if("function"==typeof Object.keys&&0!==Object.keys(t).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(t).length)return!1;var r=Object.getOwnPropertySymbols(t);if(1!==r.length||r[0]!==e)return!1;if(!Object.prototype.propertyIsEnumerable.call(t,e))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(t,e);if(42!==s.value||!0!==s.enumerable)return!1}return!0}},410:(t,e,i)=>{"use strict";var r=i(419);t.exports=function(){return r()&&!!Symbol.toStringTag}},642:(t,e,i)=>{"use strict";var r=i(612);t.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},645:(t,e)=>{e.read=function(t,e,i,r,s){var n,a,l=8*s-r-1,o=(1<<l)-1,u=o>>1,c=-7,h=i?s-1:0,p=i?-1:1,d=t[e+h];for(h+=p,n=d&(1<<-c)-1,d>>=-c,c+=l;c>0;n=256*n+t[e+h],h+=p,c-=8);for(a=n&(1<<-c)-1,n>>=-c,c+=r;c>0;a=256*a+t[e+h],h+=p,c-=8);if(0===n)n=1-u;else{if(n===o)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),n-=u}return(d?-1:1)*a*Math.pow(2,n-r)},e.write=function(t,e,i,r,s,n){var a,l,o,u=8*n-s-1,c=(1<<u)-1,h=c>>1,p=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:n-1,f=r?1:-1,y=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(l=isNaN(e)?1:0,a=c):(a=Math.floor(Math.log(e)/Math.LN2),e*(o=Math.pow(2,-a))<1&&(a--,o*=2),(e+=a+h>=1?p/o:p*Math.pow(2,1-h))*o>=2&&(a++,o/=2),a+h>=c?(l=0,a=c):a+h>=1?(l=(e*o-1)*Math.pow(2,s),a+=h):(l=e*Math.pow(2,h-1)*Math.pow(2,s),a=0));s>=8;t[i+d]=255&l,d+=f,l/=256,s-=8);for(a=a<<s|l,u+=s;u>0;t[i+d]=255&a,d+=f,a/=256,u-=8);t[i+d-f]|=128*y}},717:t=>{"function"==typeof Object.create?t.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(t,e){if(e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}}},584:(t,e,i)=>{"use strict";var r=i(410)(),s=i(924)("Object.prototype.toString"),n=function(t){return!(r&&t&&"object"==typeof t&&Symbol.toStringTag in t)&&"[object Arguments]"===s(t)},a=function(t){return!!n(t)||null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Array]"!==s(t)&&"[object Function]"===s(t.callee)},l=function(){return n(arguments)}();n.isLegacyArguments=a,t.exports=l?n:a},320:t=>{"use strict";var e,i,r=Function.prototype.toString,s="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof s&&"function"==typeof Object.defineProperty)try{e=Object.defineProperty({},"length",{get:function(){throw i}}),i={},s((function(){throw 42}),null,e)}catch(t){t!==i&&(s=null)}else s=null;var n=/^\s*class\b/,a=function(t){try{var e=r.call(t);return n.test(e)}catch(t){return!1}},l=function(t){try{return!a(t)&&(r.call(t),!0)}catch(t){return!1}},o=Object.prototype.toString,u="function"==typeof Symbol&&!!Symbol.toStringTag,c=!(0 in[,]),h=function(){return!1};if("object"==typeof document){var p=document.all;o.call(p)===o.call(document.all)&&(h=function(t){if((c||!t)&&(void 0===t||"object"==typeof t))try{var e=o.call(t);return("[object HTMLAllCollection]"===e||"[object HTML document.all class]"===e||"[object HTMLCollection]"===e||"[object Object]"===e)&&null==t("")}catch(t){}return!1})}t.exports=s?function(t){if(h(t))return!0;if(!t)return!1;if("function"!=typeof t&&"object"!=typeof t)return!1;try{s(t,null,e)}catch(t){if(t!==i)return!1}return!a(t)&&l(t)}:function(t){if(h(t))return!0;if(!t)return!1;if("function"!=typeof t&&"object"!=typeof t)return!1;if(u)return l(t);if(a(t))return!1;var e=o.call(t);return!("[object Function]"!==e&&"[object GeneratorFunction]"!==e&&!/^\[object HTML/.test(e))&&l(t)}},662:(t,e,i)=>{"use strict";var r,s=Object.prototype.toString,n=Function.prototype.toString,a=/^\s*(?:function)?\*/,l=i(410)(),o=Object.getPrototypeOf;t.exports=function(t){if("function"!=typeof t)return!1;if(a.test(n.call(t)))return!0;if(!l)return"[object GeneratorFunction]"===s.call(t);if(!o)return!1;if(void 0===r){var e=function(){if(!l)return!1;try{return Function("return function*() {}")()}catch(t){}}();r=!!e&&o(e)}return o(t)===r}},611:t=>{"use strict";t.exports=function(t){return t!=t}},360:(t,e,i)=>{"use strict";var r=i(559),s=i(289),n=i(611),a=i(415),l=i(194),o=r(a(),Number);s(o,{getPolyfill:a,implementation:n,shim:l}),t.exports=o},415:(t,e,i)=>{"use strict";var r=i(611);t.exports=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:r}},194:(t,e,i)=>{"use strict";var r=i(289),s=i(415);t.exports=function(){var t=s();return r(Number,{isNaN:t},{isNaN:function(){return Number.isNaN!==t}}),t}},692:(t,e,i)=>{"use strict";var r=i(29),s=i(83),n=i(924),a=n("Object.prototype.toString"),l=i(410)(),o=i(296),u="undefined"==typeof globalThis?i.g:globalThis,c=s(),h=n("Array.prototype.indexOf",!0)||function(t,e){for(var i=0;i<t.length;i+=1)if(t[i]===e)return i;return-1},p=n("String.prototype.slice"),d={},f=Object.getPrototypeOf;l&&o&&f&&r(c,(function(t){var e=new u[t];if(Symbol.toStringTag in e){var i=f(e),r=o(i,Symbol.toStringTag);if(!r){var s=f(i);r=o(s,Symbol.toStringTag)}d[t]=r.get}})),t.exports=function(t){if(!t||"object"!=typeof t)return!1;if(!l||!(Symbol.toStringTag in t)){var e=p(a(t),8,-1);return h(c,e)>-1}return!!o&&function(t){var e=!1;return r(d,(function(i,r){if(!e)try{e=i.call(t)===r}catch(t){}})),e}(t)}},244:t=>{"use strict";var e=function(t){return t!=t};t.exports=function(t,i){return 0===t&&0===i?1/t==1/i:t===i||!(!e(t)||!e(i))}},609:(t,e,i)=>{"use strict";var r=i(289),s=i(559),n=i(244),a=i(624),l=i(281),o=s(a(),Object);r(o,{getPolyfill:a,implementation:n,shim:l}),t.exports=o},624:(t,e,i)=>{"use strict";var r=i(244);t.exports=function(){return"function"==typeof Object.is?Object.is:r}},281:(t,e,i)=>{"use strict";var r=i(624),s=i(289);t.exports=function(){var t=r();return s(Object,{is:t},{is:function(){return Object.is!==t}}),t}},987:(t,e,i)=>{"use strict";var r;if(!Object.keys){var s=Object.prototype.hasOwnProperty,n=Object.prototype.toString,a=i(414),l=Object.prototype.propertyIsEnumerable,o=!l.call({toString:null},"toString"),u=l.call((function(){}),"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],h=function(t){var e=t.constructor;return e&&e.prototype===t},p={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},d=function(){if("undefined"==typeof window)return!1;for(var t in window)try{if(!p["$"+t]&&s.call(window,t)&&null!==window[t]&&"object"==typeof window[t])try{h(window[t])}catch(t){return!0}}catch(t){return!0}return!1}();r=function(t){var e=null!==t&&"object"==typeof t,i="[object Function]"===n.call(t),r=a(t),l=e&&"[object String]"===n.call(t),p=[];if(!e&&!i&&!r)throw new TypeError("Object.keys called on a non-object");var f=u&&i;if(l&&t.length>0&&!s.call(t,0))for(var y=0;y<t.length;++y)p.push(String(y));if(r&&t.length>0)for(var m=0;m<t.length;++m)p.push(String(m));else for(var g in t)f&&"prototype"===g||!s.call(t,g)||p.push(String(g));if(o)for(var v=function(t){if("undefined"==typeof window||!d)return h(t);try{return h(t)}catch(t){return!1}}(t),b=0;b<c.length;++b)v&&"constructor"===c[b]||!s.call(t,c[b])||p.push(c[b]);return p}}t.exports=r},215:(t,e,i)=>{"use strict";var r=Array.prototype.slice,s=i(414),n=Object.keys,a=n?function(t){return n(t)}:i(987),l=Object.keys;a.shim=function(){if(Object.keys){var t=function(){var t=Object.keys(arguments);return t&&t.length===arguments.length}(1,2);t||(Object.keys=function(t){return s(t)?l(r.call(t)):l(t)})}else Object.keys=a;return Object.keys||a},t.exports=a},414:t=>{"use strict";var e=Object.prototype.toString;t.exports=function(t){var i=e.call(t),r="[object Arguments]"===i;return r||(r="[object Array]"!==i&&null!==t&&"object"==typeof t&&"number"==typeof t.length&&t.length>=0&&"[object Function]"===e.call(t.callee)),r}},155:t=>{var e,i,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(t){if(e===setTimeout)return setTimeout(t,0);if((e===s||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(i){try{return e.call(null,t,0)}catch(i){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:s}catch(t){e=s}try{i="function"==typeof clearTimeout?clearTimeout:n}catch(t){i=n}}();var l,o=[],u=!1,c=-1;function h(){u&&l&&(u=!1,l.length?o=l.concat(o):c=-1,o.length&&p())}function p(){if(!u){var t=a(h);u=!0;for(var e=o.length;e;){for(l=o,o=[];++c<e;)l&&l[c].run();c=-1,e=o.length}l=null,u=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{return i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function f(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];o.push(new d(t,e)),1!==o.length||u||a(p)},d.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},384:t=>{t.exports=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8}},955:(t,e,i)=>{"use strict";var r=i(584),s=i(662),n=i(430),a=i(692);function l(t){return t.call.bind(t)}var o="undefined"!=typeof BigInt,u="undefined"!=typeof Symbol,c=l(Object.prototype.toString),h=l(Number.prototype.valueOf),p=l(String.prototype.valueOf),d=l(Boolean.prototype.valueOf);if(o)var f=l(BigInt.prototype.valueOf);if(u)var y=l(Symbol.prototype.valueOf);function m(t,e){if("object"!=typeof t)return!1;try{return e(t),!0}catch(t){return!1}}function g(t){return"[object Map]"===c(t)}function v(t){return"[object Set]"===c(t)}function b(t){return"[object WeakMap]"===c(t)}function w(t){return"[object WeakSet]"===c(t)}function _(t){return"[object ArrayBuffer]"===c(t)}function x(t){return"undefined"!=typeof ArrayBuffer&&(_.working?_(t):t instanceof ArrayBuffer)}function O(t){return"[object DataView]"===c(t)}function S(t){return"undefined"!=typeof DataView&&(O.working?O(t):t instanceof DataView)}e.isArgumentsObject=r,e.isGeneratorFunction=s,e.isTypedArray=a,e.isPromise=function(t){return"undefined"!=typeof Promise&&t instanceof Promise||null!==t&&"object"==typeof t&&"function"==typeof t.then&&"function"==typeof t.catch},e.isArrayBufferView=function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):a(t)||S(t)},e.isUint8Array=function(t){return"Uint8Array"===n(t)},e.isUint8ClampedArray=function(t){return"Uint8ClampedArray"===n(t)},e.isUint16Array=function(t){return"Uint16Array"===n(t)},e.isUint32Array=function(t){return"Uint32Array"===n(t)},e.isInt8Array=function(t){return"Int8Array"===n(t)},e.isInt16Array=function(t){return"Int16Array"===n(t)},e.isInt32Array=function(t){return"Int32Array"===n(t)},e.isFloat32Array=function(t){return"Float32Array"===n(t)},e.isFloat64Array=function(t){return"Float64Array"===n(t)},e.isBigInt64Array=function(t){return"BigInt64Array"===n(t)},e.isBigUint64Array=function(t){return"BigUint64Array"===n(t)},g.working="undefined"!=typeof Map&&g(new Map),e.isMap=function(t){return"undefined"!=typeof Map&&(g.working?g(t):t instanceof Map)},v.working="undefined"!=typeof Set&&v(new Set),e.isSet=function(t){return"undefined"!=typeof Set&&(v.working?v(t):t instanceof Set)},b.working="undefined"!=typeof WeakMap&&b(new WeakMap),e.isWeakMap=function(t){return"undefined"!=typeof WeakMap&&(b.working?b(t):t instanceof WeakMap)},w.working="undefined"!=typeof WeakSet&&w(new WeakSet),e.isWeakSet=function(t){return w(t)},_.working="undefined"!=typeof ArrayBuffer&&_(new ArrayBuffer),e.isArrayBuffer=x,O.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&O(new DataView(new ArrayBuffer(1),0,1)),e.isDataView=S;var k="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function j(t){return"[object SharedArrayBuffer]"===c(t)}function A(t){return void 0!==k&&(void 0===j.working&&(j.working=j(new k)),j.working?j(t):t instanceof k)}function I(t){return m(t,h)}function E(t){return m(t,p)}function D(t){return m(t,d)}function C(t){return o&&m(t,f)}function N(t){return u&&m(t,y)}e.isSharedArrayBuffer=A,e.isAsyncFunction=function(t){return"[object AsyncFunction]"===c(t)},e.isMapIterator=function(t){return"[object Map Iterator]"===c(t)},e.isSetIterator=function(t){return"[object Set Iterator]"===c(t)},e.isGeneratorObject=function(t){return"[object Generator]"===c(t)},e.isWebAssemblyCompiledModule=function(t){return"[object WebAssembly.Module]"===c(t)},e.isNumberObject=I,e.isStringObject=E,e.isBooleanObject=D,e.isBigIntObject=C,e.isSymbolObject=N,e.isBoxedPrimitive=function(t){return I(t)||E(t)||D(t)||C(t)||N(t)},e.isAnyArrayBuffer=function(t){return"undefined"!=typeof Uint8Array&&(x(t)||A(t))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(t){Object.defineProperty(e,t,{enumerable:!1,value:function(){throw new Error(t+" is not supported in userland")}})}))},539:(t,e,i)=>{var r=i(155),s=i(108),n=Object.getOwnPropertyDescriptors||function(t){for(var e=Object.keys(t),i={},r=0;r<e.length;r++)i[e[r]]=Object.getOwnPropertyDescriptor(t,e[r]);return i},a=/%[sdj%]/g;e.format=function(t){if(!w(t)){for(var e=[],i=0;i<arguments.length;i++)e.push(c(arguments[i]));return e.join(" ")}i=1;for(var r=arguments,s=r.length,n=String(t).replace(a,(function(t){if("%%"===t)return"%";if(i>=s)return t;switch(t){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(t){return"[Circular]"}default:return t}})),l=r[i];i<s;l=r[++i])v(l)||!O(l)?n+=" "+l:n+=" "+c(l);return n},e.deprecate=function(t,i){if(void 0!==r&&!0===r.noDeprecation)return t;if(void 0===r)return function(){return e.deprecate(t,i).apply(this,arguments)};var n=!1;return function(){if(!n){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?s.trace(i):s.error(i),n=!0}return t.apply(this,arguments)}};var l={},o=/^$/;if(r.env.NODE_DEBUG){var u=r.env.NODE_DEBUG;u=u.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+u+"$","i")}function c(t,i){var r={seen:[],stylize:p};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&e._extend(r,i),_(r.showHidden)&&(r.showHidden=!1),_(r.depth)&&(r.depth=2),_(r.colors)&&(r.colors=!1),_(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=h),d(r,t,r.depth)}function h(t,e){var i=c.styles[e];return i?"["+c.colors[i][0]+"m"+t+"["+c.colors[i][1]+"m":t}function p(t,e){return t}function d(t,i,r){if(t.customInspect&&i&&j(i.inspect)&&i.inspect!==e.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,t);return w(s)||(s=d(t,s,r)),s}var n=function(t,e){if(_(e))return t.stylize("undefined","undefined");if(w(e)){var i="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(i,"string")}return b(e)?t.stylize(""+e,"number"):g(e)?t.stylize(""+e,"boolean"):v(e)?t.stylize("null","null"):void 0}(t,i);if(n)return n;var a=Object.keys(i),l=function(t){var e={};return t.forEach((function(t,i){e[t]=!0})),e}(a);if(t.showHidden&&(a=Object.getOwnPropertyNames(i)),k(i)&&(a.indexOf("message")>=0||a.indexOf("description")>=0))return f(i);if(0===a.length){if(j(i)){var o=i.name?": "+i.name:"";return t.stylize("[Function"+o+"]","special")}if(x(i))return t.stylize(RegExp.prototype.toString.call(i),"regexp");if(S(i))return t.stylize(Date.prototype.toString.call(i),"date");if(k(i))return f(i)}var u,c="",h=!1,p=["{","}"];return m(i)&&(h=!0,p=["[","]"]),j(i)&&(c=" [Function"+(i.name?": "+i.name:"")+"]"),x(i)&&(c=" "+RegExp.prototype.toString.call(i)),S(i)&&(c=" "+Date.prototype.toUTCString.call(i)),k(i)&&(c=" "+f(i)),0!==a.length||h&&0!=i.length?r<0?x(i)?t.stylize(RegExp.prototype.toString.call(i),"regexp"):t.stylize("[Object]","special"):(t.seen.push(i),u=h?function(t,e,i,r,s){for(var n=[],a=0,l=e.length;a<l;++a)D(e,String(a))?n.push(y(t,e,i,r,String(a),!0)):n.push("");return s.forEach((function(s){s.match(/^\d+$/)||n.push(y(t,e,i,r,s,!0))})),n}(t,i,r,l,a):a.map((function(e){return y(t,i,r,l,e,h)})),t.seen.pop(),function(t,e,i){return t.reduce((function(t,e){return e.indexOf("\n"),t+e.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+i[1]:i[0]+e+" "+t.join(", ")+" "+i[1]}(u,c,p)):p[0]+c+p[1]}function f(t){return"["+Error.prototype.toString.call(t)+"]"}function y(t,e,i,r,s,n){var a,l,o;if((o=Object.getOwnPropertyDescriptor(e,s)||{value:e[s]}).get?l=o.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):o.set&&(l=t.stylize("[Setter]","special")),D(r,s)||(a="["+s+"]"),l||(t.seen.indexOf(o.value)<0?(l=v(i)?d(t,o.value,null):d(t,o.value,i-1)).indexOf("\n")>-1&&(l=n?l.split("\n").map((function(t){return"  "+t})).join("\n").slice(2):"\n"+l.split("\n").map((function(t){return"   "+t})).join("\n")):l=t.stylize("[Circular]","special")),_(a)){if(n&&s.match(/^\d+$/))return l;(a=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.slice(1,-1),a=t.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=t.stylize(a,"string"))}return a+": "+l}function m(t){return Array.isArray(t)}function g(t){return"boolean"==typeof t}function v(t){return null===t}function b(t){return"number"==typeof t}function w(t){return"string"==typeof t}function _(t){return void 0===t}function x(t){return O(t)&&"[object RegExp]"===A(t)}function O(t){return"object"==typeof t&&null!==t}function S(t){return O(t)&&"[object Date]"===A(t)}function k(t){return O(t)&&("[object Error]"===A(t)||t instanceof Error)}function j(t){return"function"==typeof t}function A(t){return Object.prototype.toString.call(t)}function I(t){return t<10?"0"+t.toString(10):t.toString(10)}e.debuglog=function(t){if(t=t.toUpperCase(),!l[t])if(o.test(t)){var i=r.pid;l[t]=function(){var r=e.format.apply(e,arguments);s.error("%s %d: %s",t,i,r)}}else l[t]=function(){};return l[t]},e.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},e.types=i(955),e.isArray=m,e.isBoolean=g,e.isNull=v,e.isNullOrUndefined=function(t){return null==t},e.isNumber=b,e.isString=w,e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=_,e.isRegExp=x,e.types.isRegExp=x,e.isObject=O,e.isDate=S,e.types.isDate=S,e.isError=k,e.types.isNativeError=k,e.isFunction=j,e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=i(384);var E=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function D(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.log=function(){var t,i;s.log("%s - %s",(i=[I((t=new Date).getHours()),I(t.getMinutes()),I(t.getSeconds())].join(":"),[t.getDate(),E[t.getMonth()],i].join(" ")),e.format.apply(e,arguments))},e.inherits=i(717),e._extend=function(t,e){if(!e||!O(e))return t;for(var i=Object.keys(e),r=i.length;r--;)t[i[r]]=e[i[r]];return t};var C="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function N(t,e){if(!t){var i=new Error("Promise was rejected with a falsy value");i.reason=t,t=i}return e(t)}e.promisify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');if(C&&t[C]){var e;if("function"!=typeof(e=t[C]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(e,C,{value:e,enumerable:!1,writable:!1,configurable:!0}),e}function e(){for(var e,i,r=new Promise((function(t,r){e=t,i=r})),s=[],n=0;n<arguments.length;n++)s.push(arguments[n]);s.push((function(t,r){t?i(t):e(r)}));try{t.apply(this,s)}catch(t){i(t)}return r}return Object.setPrototypeOf(e,Object.getPrototypeOf(t)),C&&Object.defineProperty(e,C,{value:e,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(e,n(t))},e.promisify.custom=C,e.callbackify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');function e(){for(var e=[],i=0;i<arguments.length;i++)e.push(arguments[i]);var s=e.pop();if("function"!=typeof s)throw new TypeError("The last argument must be of type Function");var n=this,a=function(){return s.apply(n,arguments)};t.apply(this,e).then((function(t){r.nextTick(a.bind(null,null,t))}),(function(t){r.nextTick(N.bind(null,t,a))}))}return Object.setPrototypeOf(e,Object.getPrototypeOf(t)),Object.defineProperties(e,n(t)),e}},430:(t,e,i)=>{"use strict";var r=i(29),s=i(83),n=i(924),a=i(296),l=n("Object.prototype.toString"),o=i(410)(),u="undefined"==typeof globalThis?i.g:globalThis,c=s(),h=n("String.prototype.slice"),p={},d=Object.getPrototypeOf;o&&a&&d&&r(c,(function(t){if("function"==typeof u[t]){var e=new u[t];if(Symbol.toStringTag in e){var i=d(e),r=a(i,Symbol.toStringTag);if(!r){var s=d(i);r=a(s,Symbol.toStringTag)}p[t]=r.get}}}));var f=i(692);t.exports=function(t){return!!f(t)&&(o&&Symbol.toStringTag in t?function(t){var e=!1;return r(p,(function(i,r){if(!e)try{var s=i.call(t);s===r&&(e=s)}catch(t){}})),e}(t):h(l(t),8,-1))}},83:(t,e,i)=>{"use strict";var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],s="undefined"==typeof globalThis?i.g:globalThis;t.exports=function(){for(var t=[],e=0;e<r.length;e++)"function"==typeof s[r[e]]&&(t[t.length]=r[e]);return t}}},e={};function i(r){var s=e[r];if(void 0!==s)return s.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{"use strict";let t=t=>crypto.getRandomValues(new Uint8Array(t));var e,r,s,n,a,l,o,u,c,h,p,d,f=i(155),y=i(108),m=i(764).lW,g=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(t){}try{for(l in s=JSON.parse(SECRETS_SERVER))r[l]=s[l]}catch(t){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0);try{f.env.name.includes("async")&&(r.async=!0)}catch(t){}null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(t){return!1!==r.pass&&t.passThroughOnException(),t.respondWith(e.call(t))}))}catch(t){}a={},n={},e=async function(){var t,s,a,o,u,c,h,p,d,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt;this.started=Date.now();try{null==(a=r.headers)[C="x-"+r.name.toLowerCase()]&&(a[C]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(t){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(o=this.S).cache&&(o.cache=!1),this.waitUntil=function(t){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),i.g[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(R="",x=0,A=(B=this.request.url.split("?")[1].split("&")).length;x<A;x++)if((S=(W=B[x]).split("="))[0].length){if(1===S.length&&R&&(S[0].startsWith(" ")||S[0].includes("%")))this.params[R]+="&"+decodeURIComponent(S[0]);else{if(this.params[S[0]]=1===S.length||"string"==typeof S[1]&&"true"===S[1].toLowerCase()||("string"!=typeof S[1]||"false"!==S[1].toLowerCase())&&(!!W.endsWith("=")||S[1]),"string"!=typeof this.params[S[0]]||0!==this.params[S[0]].replace(/[0-9]/g,"").length||"0"!==this.params[S[0]]&&this.params[S[0]].startsWith("0")||(k=parseInt(this.params[S[0]]),isNaN(k)||(this.params[S[0]]=k)),"string"==typeof this.params[S[0]]&&this.params[S[0]].includes("%"))try{this.params[S[0]]=decodeURIComponent(this.params[S[0]])}catch(t){}if("string"==typeof this.params[S[0]]&&(this.params[S[0]].startsWith("[")||this.params[S[0]].startsWith("{")))try{this.params[S[0]]=JSON.parse(this.params[S[0]])}catch(t){}}R=S[0]}this.headers={};try{for(M=[...this.request.headers],O=0,I=M.length;O<I;O++)w=M[O],this.headers[w[0].toLowerCase()]=w[1]}catch(t){try{for(_ in this.request.headers)this.headers[_.toLowerCase()]=this.request.headers[_]}catch(t){}}if(null==(u=this.headers).ip&&(u.ip=null!=(K=this.headers["x-real-ip"])?K:this.headers["x-forwarded-for"]),d=null!=(st=this.headers["content-type"])?st:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(d.includes("/json"))this.body=await this.request.json();else if(d.includes("form")){for(v in h={},(await this.request.formData()).entries())v[0]&&(null!=h[v[0]]?(Array.isArray(h[v[0]])||(h[v[0]]=[h[v[0]]]),h[v[0]].push(v[1])):h[v[0]]=v[1]);null!=h&&"{}"!==JSON.stringify(h)&&(this.body=h)}if(null==this.body&&("POST"===(nt=this.request.method)||"PUT"===nt||"DELETE"===nt)){try{h=await this.request.text()}catch(t){}h&&(this.body=h)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(t){}if("object"==typeof this.body&&!Array.isArray(this.body))for(W in this.body)W&&null==(c=this.params)[W]&&(c[W]=this.body[W]);try{this.cookie=null!=(at=this.headers.Cookie)?at:this.headers.cookie}catch(t){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(t){}null==this.rid&&(this.rid=e.uid());try{this.apikey=null!=(lt=null!=(ot=this.headers["x-apikey"])?ot:this.headers.apikey)?lt:this.params.apikey}catch(t){}for(j=0,E=(ut=["x-apikey","apikey"]).length;j<E;j++)dt=ut[j],null!=this.headers[dt]&&delete this.headers[dt],null!=this.params[dt]&&delete this.params[dt];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(t){}this.parts=(null!=m?m:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(t){}this.parts=this.url.length?(null!=m?m:this.url).split("/"):[];try{this.base=this.headers.host}catch(t){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(L=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),g.call(this.S.formats,L)>=0&&(this.format=L,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+L,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ct=this.parts[0],g.call(this.S.pass,ct)>=0))throw new Error;if(ft="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[ft]===this.S.system&&(delete this.headers[ft],this.system=!0),this._logs=[],this.nolog=!1,this.params._nolog&&(this.nolog=this.S.nolog&&this.params._nolog===this.S.nolog,delete this.params._nolog),this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(z=this.request.method)||"OPTIONS"===z?e._response.call(this,""):e._response.call(this,{name:null!=(F=this.S.name)?F:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=(J=null!=($=this.user)?$.email:void 0)?J:void 0});for(b=void 0,U=[...this.parts],T=void 0,q=[],t=async(i,r,s,a,o)=>{var u,c,h,p,d,m,v,w,_,x,O,S,k,j,A,I,E;if(T&&this.fn.startsWith(s))for(;U.length&&null==i[U[0]];)this.params[T]=(this.params[T]?this.params[T]+"/":"")+U.shift(),g.call(q,T)<0&&q.push(T);for(l in A=[],i)if("function"!=(k=typeof i[l])&&"object"!==k)A.push(r[l]=i[l]);else if(null!=i[l]){if(O=s+(s?".":"")+l,"object"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._sheet||i[l]._kv||i[l]._bg){if(null==(h=i[l])._auth&&(h._auth=null!=(p=i[l])._auths?p._auths:p._auths=a),Array.isArray(i[l]._auths)&&0===i[l]._auths.length&&(i[l]._auths=O.split(".")),Array.isArray(i[l]._auth)&&0===i[l]._auth.length&&(i[l]._auth=O.split(".")),null==(d=i[l])._cache&&(d._cache=null!=(m=i[l])._caches?m._caches:m._caches=o),O.startsWith("auth")&&null==(v=i[l])._cache&&(v._cache=!1),i[l]._sheet&&null==(w=i[l])._index&&(w._index=!0),i[l]._index)for(S=0,x=(j=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;S<x;S++)_=j[S],null==(u=i[l])[_]&&(u[_]={_indexed:_,_auth:_.startsWith("_")?"system":i[l]._auth});for(E in"function"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._kv||i[l]._bg||O.includes(".")&&!s.startsWith("index")&&!O.split(".").pop().startsWith("_")?r[l]=e._wrapper(i[l],O).bind(this):r[l]=i[l].bind(this),i[l])E.startsWith("_")&&(r[l][E]=i[l][E])}else r[l]=JSON.parse(JSON.stringify(i[l]));null==(c=r[l])._name&&(c._name=O),r[l]._schedule&&!n[O]&&!0===this.S.bg&&!1!==this.S.cron&&(y.log("Adding schedule",r[l]._schedule,O),n[O]={schedule:r[l]._schedule,fn:r[l]},I=t=>async()=>{var e,i,r;if(!0!==this.S.dev&&1!==(r=f.env.pm_id)&&"1"!==r)return y.log("NOT running scheduled task because not on dev and process pid is not 1",t,this.datetime());if("string"==typeof this.S.async)return y.log("NOT running scheduled task because not on the available async process",t,this.datetime());"loop"===n[t].fn._schedule&&y.log("starting scheduled loop function",t),y.log("scheduled task",t,this.datetime()),n[t].last=await this.datetime(),delete n[t].error;try{e=n[t].fn._sheet?await this._loadsheet(n[t].fn,n[t].fn._name.replace(/\./g,"_")):await n[t].fn(n[t].fn._args);try{n[t].result=JSON.stringify(e).substr(0,200)}catch(t){}if(n[t].success=!0,y.log("scheduled task result",e),"loop"===n[t].fn._schedule)return y.log("Schedule looping",t),(await I(t))()}catch(e){i=e,n[t].success=!1;try{return n[t].error=JSON.stringify(i)}catch(t){}}},"loop"===r[l]._schedule?(y.log("Scheduling loop",O),(await I(O))()):cron.schedule(r[l]._schedule,I(O))),l.startsWith("_")||(U.length&&U[0]===l&&this.fn.startsWith(s)&&(T=U.shift(),this.fn+=(""===this.fn?"":".")+T,"function"!=typeof r[l]||s.includes("._")||(b=r[l])),"function"==typeof r[l]&&1===O.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(O.replace(/\./g,"/"))),Array.isArray(i[l])||l.startsWith("_")&&"function"!=typeof r[l]?A.push(void 0):A.push(t(i[l],r[l],O,null!=a?a:i[l]._auths,null!=o?o:i[l]._caches))}else A.push(void 0);return A},t(e,this,""),T&&U.length&&(this.params[T]=this.params[T]?this.params[T]+"/"+U.join("/"):U.join("/")),N=0,D=q.length;N<D;N++)p=q[N],"true"===this.params[p].toLowerCase()&&(this.params[p]=!0),"false"===this.params[p].toLowerCase()&&(this.params[p]=!1),"string"!=typeof this.params[p]||0!==this.params[p].replace(/[0-9]/g,"").length||this.params[p].startsWith("0")||(P=parseInt(this.params[p]),isNaN(P)||(this.params[p]=P));if(this.S.dev&&!0===this.S.bg&&y.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(V=typeof b)||"function"===V)&&b._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(G=typeof b)&&"function"!==G||!b._async||"string"!=typeof this.S.async?"function"==typeof b&&("object"==typeof(s="auth"===this.fn?void 0:await this.auth())&&s._id&&s.email&&(this.user=s),(s="function"==typeof b._auth?await b._auth():!0===b._auth&&null!=this.user||!b._auth||await this.auth.role(b._auth))||this.system?"HEAD"===(X=this.request.method)||"OPTIONS"===X?ht="":!1!==b._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(ht=await this.cache())?(this.cached="cache",(ht=new Response(ht.body,ht)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),ht.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(ht=await b(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(ht={status:401}).body=await this.auth(!1))):(y.log("Fetching from async process",this.S.async,this.request.url),ht=await this.fetch(this.S.async+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body})),(null==ht||"object"==typeof ht&&404===ht.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(ht=""),pt="object"!=typeof ht||Array.isArray(ht)||"function"!=typeof(null!=(Y=ht.headers)?Y.append:void 0)?await this._response(ht,b):ht,this.parts.length&&"log"!==(H=this.parts[0])&&"status"!==H&&(!this.system||"kv"!==(Z=this.parts[0])&&"index"!==Z)&&"HEAD"!==(Q=this.request.method)&&"OPTIONS"!==Q&&null!=ht&&""!==ht&&(!this.completed||!1===b._cache||200!==pt.status||"object"==typeof ht&&!Array.isArray(ht)&&0===(null!=(tt=ht.hits)?tt.total:void 0)||"number"==typeof ht&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(yt=b._cache)||"object"!=typeof ht||Array.isArray(ht)||null==(null!=(et=ht.hits)?et.hits:void 0)||(yt=60),this.cache(void 0,pt,yt)),("object"!=(it=typeof b)&&"function"!==it||!1!==b._log)&&this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(rt=this.request.method)||"OPTIONS"===rt)return pt;throw new Error},e._response=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,v,b,w,_,x,O,S,k,j;if(null==(s=this.S).headers&&(s.headers={}),null==t)t=404,k=404;else if("status"!==this.fn&&"object"==typeof t&&!Array.isArray(t)&&("number"==typeof t.status&&t.status>300&&t.status<600||t.headers)){if(null!=t.headers){for(l in t.headers)this.S.headers[l]=t.headers[l];delete t.headers}k=null!=(b=t.status)?b:200,delete t.status,0===(p=this.keys(t)).length?t=k:1===p.length&&(t=t[p[0]])}else k=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(w=this.format,g.call(this.S.formats,w)>=0)){if("string"!=typeof t)try{t=await this.convert["json2"+this.format](t)}catch(t){}if("string"==typeof t&&"html"===this.format&&!(t=t.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(O='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',O+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',t.includes("<title")?([v,j]=t.split("<title"),[j,r]=j.split("</title>"),O+="<title"+j+"</title>\n",t=v+r):t.includes('id="title"')&&(O+="<title>"+t.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),c=0,d=(_=["<meta ","<link "]).length;c<d;c++)if(o=_[c],t.includes(o))for(h=0,f=(x=t.split(o)).length;h<f;h++)S=o+x[h].split(">")[0],t=t.replace(S,""),O+=S+"\n";t.includes("<head>")&&([y,u]=t.split("<head>"),[u,i]=u.split("</head>"),O+=u,t=y+i),O.includes("icon")||(O+='<link rel="icon" href="data:,">'),O+="\n</head>\n",O+=t.includes("<body")?t:"\n<body>\n"+t+"\n</body>\n",t=O+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof t)try{t=JSON.stringify(t,"",2)}catch(t){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(a=this.S.headers)["Content-Length"]&&(a["Content-Length"]=m.byteLength(t))}catch(t){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(t){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(t){}try{return new Response(t,{status:k,headers:this.S.headers})}catch(e){return{status:k,headers:this.S.headers,body:t}}},e._loadsheet=async function(t,e){var i,r,s,n,a,l;if(t._sheet.startsWith("http")&&t._sheet.includes("csv")?a=await this.convert.csv2json(t._sheet):t._sheet.startsWith("http")&&t._sheet.includes("json")?(a=await this.fetch(t._sheet))&&!Array.isArray(a)&&(a=[a]):a=await this.src.google.sheets(t._sheet),Array.isArray(a)&&a.length){if("function"==typeof t._format&&(a=await t._format.apply(this,[a])),t._key)for(i=0,r=a.length;i<r;i++)null==(l=a[i])._id&&(l._id=(null!=(s=l[t._key])?s:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(e,""),await this.index(e,"object"!=typeof t._index?{}:{settings:t._index.settings,mappings:null!=(n=t._index.mappings)?n:t._index.mapping,aliases:t._index.aliases}),await this.index(e,a),a.length}return 0},e._wrapper=function(t,e){return async function(){var i,r,s,n,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht;if(ut=Date.now(),ot=e.replace(/\./g,"_"),k={fn:e},t._limit)for(j=await this.kv("limit/"+e);j;)null==k.limited&&(k.limited=0),k.limited+=j,await this.sleep(j-ut),j=await this.kv("limit/"+e);if("string"==(W=typeof this.params._async)||"number"===W)if(lt=await this.kv("async/"+this.params._async,"")){if("string"==typeof lt&&lt.includes("/")&&!lt.includes(" ")&&!lt.includes(":")&&!lt.startsWith("10.")&&2===lt.split("/").length){try{t._kv&&(lt=await this.kv(lt))}catch(t){}try{null==lt&&t._index&&(lt=await this.index(lt))}catch(t){}}try{"string"==typeof lt&&(lt.startsWith("{")||lt.startsWith("["))&&(lt=JSON.parse(lt))}catch(t){}}else lt={_async:this.params._async};else if(this.fn===e&&t._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)lt={status:302},t._sheet.startsWith("http")?lt.body=t._sheet:"json"===this.format?lt.body="https://sheets.googleapis.com/v4/spreadsheets/"+t._sheet.split("/")[0]+"/values/"+(null!=(B=null!=(Z=t._sheetid)?Z:t._sheet.split("/")[1])?B:"Sheet1")+"?alt=json":lt.body="https://docs.google.com/spreadsheets/d/"+t._sheet.split("/")[0],lt.headers={Location:lt.body};else if(t._indexed)(s=[...arguments]).unshift(ot.replace("_"+t._indexed,"")),lt=await this.index[t._indexed](...s);else if((t._index||t._kv)&&(!t._sheet||this.fn!==e||!this.refresh)){if(this.fn===e?(this.fn.replace(/\./g,"/")!==this.route&&(k.key=this.route.split(e.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!k.key&&t._index&&(q=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?=%"]/g,"").length&&(k.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(k.key=arguments[0].toString()),t._index&&!k.key&&(q=await this.index.translate(arguments[0],arguments[1])),U=null!=q?void 0:k.key?arguments[1]:t._index?arguments[0]:void 0),"object"==typeof U)if(Array.isArray(U)){if(U.length)for(y=0,w=U.length;y<w;y++)null==(u=U[y])._id&&(u._id=(null!=(it=u[t._key])?it:this.uid()).replace(/\//g,"_").toLowerCase())}else null==U._id&&(U._id=(null!=(tt=null!=(et=k.key)?et:U[t._key])?tt:this.uid()).replace(/\//g,"_").toLowerCase()),null==k.key&&(k.key=U._id.replace(/\//g,"_").toLowerCase());if((null!=U||!this.refresh||"function"!=typeof t)&&(t._kv&&k.key&&null!=(lt=await this.kv(ot+"/"+k.key,U))&&null==U&&(k.cached="kv"),t._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;lt={status:404}}if(A=this.params.email,this.params.orgkey&&(L=this.params.orgkey,delete this.params.orgkey),C=null!=(rt=this.params.funders)?rt:this.params.flatten,delete q.orgkey,delete q.funders,delete q.flatten,delete q.email,delete this.params.size,delete q.size,(ht=await this.index.count(ot,q))>2e5||!(null!=(st=this.S.static)?st.folder:void 0))lt={status:401};else{f=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),c=this.S.static.url+"/export/"+f+".csv",ht>1e5&&await this.mail({to:null!=(nt=null!=(at=this.S.log)?at.notify:void 0)?nt:"mark@oa.works",text:"Someone is creating a large csv of size "+ht+"\n\n"+c+("joe@oa.works"===A?"":"\n\nbut they are not the user who is allowed, so it should get capped")}),D=this.S.static.folder+"/export";try{(p=(await fs.readdir(D)).length)>900&&p%20==0&&this.mail({to:null!=(M=null!=(z=this.S.log)?z.notify:void 0)?M:"mark@oa.works",text:"Warning, export file count is "+p+" they will be deleted at 1000"})}catch(t){await fs.mkdir(D),p=0}try{if(p>999){for(F=await fs.readdir(D),m=0,_=F.length;m<_;m++)d=F[m],await fs.unlink(D+"/"+d);this.mail({to:null!=(J=null!=($=this.S.log)?$.notify:void 0)?J:"mark@oa.works",text:"Export files had reached 1000 so have been deleted "})}}catch(t){}if(p>1e3)lt={status:401};else{if(D+="/"+f+".csv",await fs.appendFile(D,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)v="string"==typeof this.params.include?this.params.include.split(","):this.params.include,L&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&g.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",g.call(q._source.includes,"orgs")<0&&q._source.includes.push("orgs"));else for(v=[],b=0,x=(V=await this.index.keys(ot)).length;b<x;b++)ct=V[b].split(".")[0],g.call(v,ct)<0&&"_id"!==ct&&v.push(ct);if(null!=this.params.exclude){for(I=0,O=(G="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;I<O;I++)h=G[I],-1===(N=v.indexOf(h))||L&&"orgs"===h||(v=v.splice(N,1));L&&-1!==(E=q._source.excludes.indexOf("orgs"))&&(q._source.excludes=q._source.excludes.splice(E,1))}A&&await this.mail({to:A,subject:"Your export has started (ref: "+f+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+c+'">Download csv</a><br><br>Thanks'}),r=async(t,e,i,r,s,n,a,o)=>{var u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt;for(v=!0,null!=o&&(X=await this.encrypt(o),L=await this.report.orgs.orgkeys('key.keyword:"'+X+'"',1)),a&&(r=["DOI","funder.name","funder.award","authorships.institutions.display_name","authorships.institutions.ror"]),T=0,k=r.length;T<k;T++)x=r[T],await fs.appendFile(i,(v?'"':',"')+x.replace("supplements.","")+'"'),v=!1;for await(f of this.index._for(t,e,{scroll:"5m",max:1e5}))if(await fs.appendFile(i,"\n"),a){if(C="",c="",_="",V="",null!=f.funder)for(v=!0,Y=0,j=(P=f.funder).length;Y<j;Y++)C+=(v?"":";")+(null!=(R=(b=P[Y]).name)?R:""),null!=b.award&&b.award.length&&(b.award=b.award.join(" ")),null==b.award&&(b.award=""),Array.isArray(b.award)&&(b.award.length?b.award=b.award.join(" "):b.award=""),b.award=b.award.replace(/;/g,""),c+=(v?"":";")+b.award,v=!1;if(null!=f.authorships)for(v=!0,Z=0,A=(q=f.authorships).length;Z<A;Z++)if(v||(_+=";",V+=";"),v=!1,null!=(u=q[Z]).institutions)for(m=!0,K=0,I=(U=u.institutions).length;K<I;K++)_+=(m?"":",")+(null!=(W=(w=U[K]).display_name)?W:""),V+=(m?"":",")+(null!=(B=w.ror)?B:""),m=!1;await fs.appendFile(i,'"'+f.DOI+'","'+C+'","'+c+'","'+_+'","'+V+'"')}else for(v=!0,tt=0,E=r.length;tt<E;tt++){if((l=r[tt]).includes("."))try{h=await this.flatten(f)}catch(t){h=void 0}else h=f;if(Array.isArray(h)){if(h.length&&"object"==typeof h[0]){for(H=[],et=0,D=h.length;et<D;et++)null!=(null!=(d=h[et])?d[l]:void 0)&&H.push(d[l]);h=H}(N={})[l]=h,h=N}if(null==h||null==h[l])Q="";else if("object"==typeof h[l]){if(Array.isArray(h[l])){for(p="",it=0,O=(M=h[l]).length;it<O;it++)"object"==typeof(y=M[it])&&(y=JSON.stringify(y)),p.includes(y)||(p+=(p?";":"")+y);h[l]=p}Q=JSON.stringify(h[l])}else Q=h[l];if("string"==typeof Q&&(Q=Q.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),("email"===l||"supplements.email"===l)&&!Q.includes("@")&&"string"==typeof(null!=L?L.org:void 0)&&L.org.length){for($=[],rt=0,S=(F=null!=(z=f.orgs)?z:[]).length;rt<S;rt++)G=F[rt],$.push(G.toLowerCase());J=L.org.toLowerCase(),g.call($,J)>=0&&(Q=await this.decrypt(Q))}await fs.appendFile(i,(v?'"':',"')+Q+'"'),v=!1}if(s)return await this.mail({to:s,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+n+'">Download csv</a>\n\nThanks'})},this.waitUntil(r(ot,q,D,v,A,c,C,L)),delete this.format,lt=c}}}else lt=await this.index(ot+(k.key?"/"+k.key:""),null!=U?U:q);if(null!=lt||k.key&&null!=U||(await this.index(ot,"object"!=typeof t._index?{}:{settings:t._index.settings,mappings:null!=(X=t._index.mappings)?X:t._index.mapping,aliases:t._index.aliases}),""!==U&&(lt=await this.index(ot+(k.key?"/"+k.key:""),null!=U?U:k.key?void 0:q))),null==lt&&null==U&&k.key&&"string"==typeof arguments[0]&&(q=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(R=await this.index(ot,q))&&null!=(Y=R.hits)?Y.total:void 0))for(P=0,S=(H=await this.keys(R.hits.hits[0]._source)).length;P<S;P++)if(l=H[P],"string"==typeof R.hits.hits[0]._source[l]&&arguments[0]===R.hits.hits[0]._source[l]||Array.isArray(R.hits.hits[0]._source[l])&&(K=arguments[0],g.call(R.hits.hits[0]._source[l],K)>=0)){null==(lt=R.hits.hits[0]._source)._id&&(lt._id=R.hits.hits[0]._id);break}1===(null!=q?q.size:void 0)&&"object"==typeof lt&&null!=(null!=(Q=lt.hits)?Q.hits:void 0)&&(lt.hits.hits.length?(null==(n=lt.hits.hits[0]._source)._id&&(n._id=lt.hits.hits[0]._id),lt=lt.hits.hits[0]._source):lt=void 0)}null!=q&&(k.qry=JSON.stringify(q)),null==lt||null!=U||k.cached||(k.cached="index"),k.cached&&this.fn===e&&(this.cached=k.cached)}return null==lt&&(t._bg||t._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(o={headers:{},body:U,params:this.copy(this.params)},this.refresh&&(o.params.refresh=!0),o.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,lt=await this.fetch(this.S.bg+"/"+ot.replace(/\_/g,"/"),o),k.bg=!0),null==lt&&t._sheet&&""!==U&&(this.refresh&&this.fn===e||!await this.index(ot))&&(lt=await this._loadsheet(t,ot),(arguments.length||"{}"!==JSON.stringify(this.params))&&(lt=void 0)),null!=lt||t._index&&""===U||"function"!=typeof t||(i=async(t,e,i,r,s)=>{var n,l,o,c,h,p,d,f;if(e._limit&&(n=!0===e._limit?86400:e._limit,await this.kv("limit/"+s,ut+n,n)),c=await e.apply(this,i),delete a[s],"object"==typeof c&&(e._kv||e._index)&&null==c.took&&null==c.hits){if(e._key&&Array.isArray(c)&&c.length&&null==c[0]._id&&null!=c[0][e._key])for(d=0,o=c.length;d<o;d++)null==(u=c[d])._id&&(u._id=u[e._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(c)?"":"/"+(null!=(h=null!=(p=c[e._key])?p:c._id)?h:this.uid()).replace(/\//g,"_").toLowerCase(),e._kv&&!Array.isArray(c)&&this.kv(t+l,lt,e._kv),e._index&&this.waitUntil(this.index(t+l,c))}return!0===e._limit&&await this.kv("limit/"+s,""),e._async&&(this.kv("async/"+this.rid,null==l||Array.isArray(c)?Array.isArray(c)?c.length:c:t+l,172800),this.fn===s&&!1!==e._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(c)+"\n\n"+this.base+"/"+t+"?_async="+this.rid,r&&this.mail({to:r,text:f}))),c},t._async&&this.fn===e?(k.async=!0,t._unique&&(T=a[e])?lt={_async:T}:(t._unique&&(a[this.fn]=this.rid),lt={_async:this.rid},this.waitUntil(i(ot,t,arguments,this.params.notify,e)))):lt=await i(ot,t,arguments)),!1!==t._log&&(k.took=Date.now()-ut,this.log(k)),lt}},e.svc={},e.src={},e.status=async function(){var t,e,s,a,o,u,c,h,p;h={name:r.name,version:r.version,built:r.built};try{h.pmid=f.env.pm_id}catch(t){}for(t=0,s=(o=["rid","params","base","parts","opts","routes"]).length;t<s;t++){l=o[t];try{null==h[l]&&(h[l]=this[l])}catch(t){}}if(!0===this.S.bg)try{for(p in h.schedule={},n)for(l in h.schedule[p]={},n[p])"fn"!==l&&(h.schedule[p][l]=n[p][l])}catch(t){}!0===this.S.bg&&(h.bg=!0),h.kv=("string"==typeof this.S.kv&&i.g[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{h.index=await this.index.status()}catch(t){}if(r.dev){if(h.bg=this.S.bg,!0!==this.S.bg)try{h.request=this.request}catch(t){}for(e=0,a=(u=["headers","cookie","user","body"]).length;e<a;e++){l=u[e];try{null==h[l]&&(h[l]=this[l])}catch(t){}}}else{try{h.index=h.index.status}catch(t){}h.kv&&(h.kv=!0),h.user=null!=(c=this.user)?c.email:void 0}return h},g=[].indexOf,e.auth=async function(t){var e,i,s,n,a,l,o,u,c,h,p,d,f;if("string"==typeof t)return this.users._get(t);if(t||null==this.user||"auth"!==this.fn&&!1!==t){if(!1!==t&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(n=this.params.token)?n:this.params.auth),"")))&&((f=await this.users._get(null!=(a=null!=s?s.email:void 0)?a:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(d=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(d))),!f&&(this.params.resume||this.cookie))){if(!(h=this.params.resume))try{h=(e=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"oaworksLogin")+"=")[1].split(";")[0])).resume,d=e._id}catch(t){}null==d&&(d=this.headers["x-id"]),this.params.email&&!d&&(d=this.hashhex(this.params.email.trim().toLowerCase())),h&&d&&await this.kv("auth/resume/"+d+"/"+h)&&null!=(f=await this.users._get(d))&&(f.resume=h)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),t||"html"!==this.format?f:(p="<body>",p+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',p+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(p+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',p+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',p+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',p+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):p+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',p+"</body>")},e.auth.token=function(t,e,i,s,n,a,l){var o,u,c;if(null==t&&(t=this.params.email),t)return t=t.trim().toLowerCase(),null==e&&(e=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&y.log(t,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,t,1200),this.waitUntil(this.mail({from:e,to:t,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=n?n:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:t}},e.auth.role=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y;if(null==t&&(t=this.params.role),e="object"==typeof e?e:e||this.params.auth?await this.users._get(null!=e?e:this.params.auth):this.user,"system"===t&&this.system)return"system";if((null!=e?e.email:void 0)&&(u=e.email,g.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(t.startsWith("@")&&null!=(null!=e?e.email:void 0)&&e.email.endsWith(t))return t;if(null!=(null!=e?e.roles:void 0))for(n=0,l=(c="string"==typeof t?t.split(","):t||[]).length;n<l;n++){if(r=c[n],[s,y]=r.replace("/",".").split("."),s===e._id)return"owner";if(y){if(g.call(null!=(h=e.roles[s])?h:[],y)>=0)return y;if(null!=e.roles[s]&&-1<(d=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(y)))for(a=0,o=(p=i.splice(0,d)).length;a<o;a++)if(f=p[a],g.call(e.roles[s],f)>=0)return f}}return!1},e.auth.add=async function(t,e,i,r){var s,n,a,l,o,u,c;return e="object"==typeof e?e:e||this.params.auth?await this.users._get(null!=e?e:this.params.auth):this.user,!(!t&&this.user._id!==e._id&&!await this.auth.role("system"))&&(null==t&&(t=null!=(a=null!=(l=this.params.add)?l:this.params.remove)?a:this.params.deny),!!t&&([n,c]=t.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==n&&"root"!==c&&(r?(e.roles[n]=["deny"],this.users._update(e)):c?(null!=(o=e.roles)?o[n]:void 0)&&g.call(e.roles[n],c)>=0?null!=i&&(e.roles[n].splice(e.roles[n].indexOf(c),1),e.roles[n].length||delete e.roles[n],this.users._update(e)):("request"!==c||g.call(null!=(u=e.roles[n])?u:[],"deny")<0)&&(null==(s=e.roles)[n]&&(s[n]=[]),g.call(e.roles[n],"request")>=0&&(e.roles[n]=e.roles[n].splice(e.roles[n].indexOf("request"),1)),e.roles.group.push(c),this.users._update(e)):null!=e.roles[n]?null!=i&&(delete e.roles[n],this.users._update(e)):(e.roles[n]=["user"],this.users._update(e)),e)))},e.auth.remove=function(t,e){return this.auth.add(t,e,!0)},e.auth.deny=function(t,e){return this.auth.add(t,e,void 0,!0)},e.auth.request=function(t,e){return null==t&&(t=this.params.request),t=t.split("/")[0]+"/request",this.auth.add(t,e)},e.auth.logout=async function(t){return null==t&&(t=this.user),!!t&&(await this.kv._each("auth/resume/"+("string"==typeof t?t.includes("@")?this.hashhex(t.trim().toLowerCase()):t:t._id),""),!0)},e.auth._oauth=async function(t,e){var i,s,n,a,l,o,u,c,h,p,d,f,y,m;if(t)try{if(m=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+t,{method:"POST"}),null==e&&(e=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=r.use)&&null!=(p=h.google)&&null!=(d=p.oauth)&&null!=(f=d.client)?f.id:void 0),null!=e&&(null!=(n=m.data)?n.aud:void 0)===e)return{email:(y=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+t)).data.email.toLowerCase(),google:{id:y.data.id},name:null!=(a=y.data.name)?a:y.data.given_name+(y.data.family_name?" "+y.data.family_name:""),avatar:y.data.picture}}catch(t){}},e.users={_index:!0,_auth:"system"},e.users._get=async function(t,e){var i,r,s;if(e)1===(null!=(r=await this.index("users",'apikey:"'+e+'"'))&&null!=(i=r.hits)?i.total:void 0)&&null==(s=r.hits.hits[0]._source)._id&&(s._id=r.hits.hits[0]._id);else if("string"==typeof t){if(t.startsWith("users/")&&(t=t.replace("users/","")),t.includes("@")&&(t=this.hashhex(t.trim().toLowerCase())),!0!==this.S.bg)try{s=await this.kv("users/"+t)}catch(t){}if(null==s){try{s=await this.index("users/"+t)}catch(t){}if(null!=s&&!0!==this.S.bg){try{await this.kv("users/"+t,s)}catch(t){}try{await this.kv("auth/apikey/"+s.apikey,t)}catch(t){}}}}return s},e.users._create=async function(t){var e;if("string"==typeof t&&(t={email:t}),"string"!=typeof t.email||!t.email.includes("@"))return!1;e={_id:this.hashhex(t.email.trim().toLowerCase()),email:t.email,apikey:this.uid()},delete t.email;try{e.profile=t}catch(t){}try{e.creation=this.base+"/"+this.route}catch(t){}e.roles={},e.createdAt=new Date;try{await this.kv("users/"+e._id,e)}catch(t){}try{await this.kv("auth/apikey/"+e.apikey,e._id)}catch(t){}try{this.waitUntil(this.index("users/"+e._id,e))}catch(t){}return e},e.users._update=async function(t,e){if("object"==typeof t&&e._id&&null==e&&(t=(e=t)._id),"string"==typeof t&&"object"==typeof e&&"{}"!==JSON.stringify(e)){t.startsWith("users/")&&(t=t.replace("users/","")),t.includes("@")&&(t=this.hashhex(t.trim().toLowerCase())),e.updatedAt=new Date;try{await this.kv("users/"+t,e)}catch(t){}try{this.waitUntil(this.index("users/"+t,e))}catch(t){}return!0}return!1},e.users._delete=async function(t){var e,i;if(i="object"==typeof t?t:(null!=(e=this.user)?e._id:void 0)===t?this.user:await this.users._get(t)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(t){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(t){}try{await this.kv("users/"+i._id,"")}catch(t){}try{return await this.index("users/"+i._id,"")}catch(t){}}},e.deal={_index:!0,_prefix:!1},e.deal.institution={_index:!0,_prefix:!1},e.deal.load=async function(){var t,e,i,r,s,n,a,l,o,u,c,h,p;for(e={},r=0,n=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;r<n;r++){for(u=c[r],s=0,a=(h=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;s<a;s++)u[(p=h[s]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[p],delete u[p];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(t){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(t){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(t){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(t){}try{delete u.shareurlpublicly}catch(t){}try{""===u.collection&&(u.collection="Unclassified")}catch(t){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(t){}try{null==e[l=u.institution]&&(e[l]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(t){}try{e[u.institution].value+=u.value,e[u.institution].gbpvalue+=u.gbpvalue,e[u.institution].usdvalue+=u.usdvalue}catch(t){}e[u.institution].deals.push(o)}catch(t){}}for(t in i=[],e)i.push(e[t]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}},g=[].indexOf,e.deposits={_index:!0},e.deposit=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt,gt,vt,bt,wt,_t,xt,Ot,St,kt;for(null==t&&(t=this.copy(this.params)),(null!=(E=t.metadata)?E.doi:void 0)&&!t.doi&&(t.doi=t.metadata.doi),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),null==i&&(i=this.S.dev),(h={createdAt:Date.now()}).created_date=await this.datetime(h.createdAt),d=0,v=(D=["embedded","demo","pilot","live","email","plugin"]).length;d<v;d++)h[m=D[d]]=t[m];if(!0===h.pilot&&(h.pilot=Date.now()),!0===h.live&&(h.live=Date.now()),h.name=null!=(M=null!=e?e.filename:void 0)?M:null!=e?e.name:void 0,"anonymous"!==t.from&&(h.from=t.from),t.confirmed&&(h.confirmed=decodeURIComponent(t.confirmed)),h.doi=null!=(K=t.doi)?K:null!=(ut=t.metadata)?ut.doi:void 0,null==t.metadata&&t.doi&&(t.metadata=await this.metadata(t.doi)),h.metadata=t.metadata,xt=t.config,"string"==typeof t.config&&(xt=JSON.parse(t.config)),!t.config&&t.from&&(xt=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+t.from)),h.permissions=null!=(ft=t.permissions)?ft:await this.permissions(null!=(yt=t.metadata)?yt:t.doi),t.redeposit||(null==e&&t.email&&null!=t.metadata?h.type="dark":(h.archivable=await this.archivable(e,void 0,h.confirmed,t.metadata,h.permissions,i),null!=(null!=(mt=h.archivable)?mt.metadata:void 0)&&delete h.archivable.metadata)),(null!=(gt=h.archivable)?gt.archivable:void 0)&&(!h.confirmed||h.confirmed===h.archivable.checksum)){for((St={content:e.data,name:h.archivable.name}).publish=!0,c=[],y=0,b=(N=null!=(vt=null!=(C=t.metadata)?C.author:void 0)?vt:[]).length;y<b;y++)if(null!=(r=N[y]).family){n={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(n.orcid=r.ORCID.split("/").pop())}catch(t){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(n.affiliation=r.affiliation.name)}catch(t){}c.push(n)}0===c.length&&(c=[{name:"Unknown"}]),p=t.metadata.abstract?t.metadata.abstract+"<br><br>":"",(p=(p+=null!=(L=null!=(T=h.permissions.best_permission)?T.deposit_statement:void 0)?L:null!=t.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+t.metadata.doi:"").trim()).lastIndexOf(".")!==p.length-1&&(p+="."),p.length&&(p+=" "),p+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",S={title:null!=(P=t.metadata.title)?P:"Unknown",description:p.trim(),creators:c,version:"submittedVersion"===h.archivable.version?"Submitted Version":"acceptedVersion"===h.archivable.version?"Accepted Version":"publishedVersion"===h.archivable.version?"Published Version":"Accepted Version",journal_title:t.metadata.journal,journal_volume:t.metadata.volume,journal_issue:t.metadata.issue,journal_pages:t.metadata.page},t.doi&&((null!=(kt=await this.src.zenodo.records.search('"'+t.doi+'"',i))&&null!=(R=kt.hits)?R.total:void 0)&&(f=kt.hits.hits[0]),f&&h.confirmed!==h.archivable.checksum&&!i?h.zenodo={already:f.id}:S.related_identifiers=[{relation:"postprint"===S.version||"AAM"===S.version||"preprint"===S.version?"isPreviousVersionOf":"isIdenticalTo",identifier:t.doi}]),S.prereserve_doi=!0,S.access_right="open",S.license=null!=(q=null!=(U=h.permissions.best_permission)?U.licence:void 0)?q:"cc-by",S.license.includes("other")&&S.license.includes("closed")&&(S.license="other-closed"),S.license.includes("other")&&S.license.includes("non")&&S.license.includes("commercial")&&(S.license="other-nc"),S.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(S.license.substring(S.license.length-1)))&&(S.license+="-4.0");try{(null!=(W=h.permissions.best_permission)?W.embargo_end:void 0)&&await this.epoch(h.permissions.best_permission.embargo_end)>Date.now()&&(S.access_right="embargoed",S.embargo_date=h.permissions.best_permission.embargo_end,h.embargo=h.permissions.best_permission.embargo_end)}catch(t){}try{null!=t.metadata.published&&"string"==typeof t.metadata.published&&(S.publication_date=t.metadata.published)}catch(t){}if(null!=xt){if(h.config=xt,null!=xt.community_ID&&null==xt.community&&(xt.community=xt.community_ID),xt.community)for(null==xt.communities&&(xt.communities=[]),O=0,w=(B="string"==typeof xt.community?xt.community.split(","):xt.community).length;O<w;O++)o=B[O],xt.communities.push({identifier:o});if(null!=xt.community||null!=xt.communities)for(null==xt.communities&&(xt.communities=xt.community),Array.isArray(xt.communities)||(xt.communities=[xt.communities]),S.communities=[],j=0,_=(z=xt.communities).length;j<_;j++)u=z[j],S.communities.push("string"==typeof u?{identifier:u}:u);S.communities&&S.communities.length&&(h.community=S.communities[0].identifier)}if(bt=i||h.demo?null!=(F=this.S.src.zenodo)?F.sandbox:void 0:null!=(J=this.S.src.zenodo)?J.token:void 0){if(!(null!=($=h.zenodo)?$.already:void 0))if((Ot=await this.src.zenodo.deposition.create(S,St,bt,i)).id)h.zenodo={id:Ot.id,url:"https://"+(i||h.demo?"sandbox.":"")+"zenodo.org/record/"+Ot.id,doi:null!=(null!=(V=Ot.metadata)&&null!=(G=V.prereserve_doi)?G.doi:void 0)?Ot.metadata.prereserve_doi.doi:void 0,file:null!=(X=null!=(Y=Ot.uploaded)&&null!=(H=Y.links)?H.download:void 0)?X:null!=(Z=Ot.uploaded)&&null!=(Q=Z.links)?Q.download:void 0},null==h.doi&&(h.doi=h.zenodo.doi),h.type="zenodo";else{h.error="Deposit to Zenodo failed";try{h.error+=": "+JSON.stringify(Ot)}catch(t){}h.type="review"}}else h.error="No Zenodo credentials available",h.type="review"}if((null!=(tt=h.archivable)?tt.timeout:void 0)&&(h.error="Archivable timeout",h.type="review"),h.version=null!=(et=h.archivable)?et.version:void 0,h.type||!t.from||h.embedded&&(h.embedded.includes("oa.works")||h.embedded.includes("openaccessbutton.org")||h.embedded.includes("shareyourpaper.org"))||(h.type=t.redeposit?"redeposit":e?"forward":"dark"),h.doi&&(null==h.type&&(h.type="review"),h.url="string"==typeof t.redeposit?t.redeposit:t.url?t.url:void 0,await this.deposits(h),("review"!==h.type||null!=e)&&!1!==(null!=(it=h.archivable)?it.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(rt=exists.zenodo)?rt.already:void 0)||i))){for(l=["joe@oa.works","shared@oa.works"],i&&l.push("mark@oa.works"),_t=[],"string"==typeof(null!=xt?xt.owner:void 0)&&xt.owner.includes("@")&&!h.error?_t.push(xt.owner):(null!=xt?xt.email:void 0)&&_t.push(xt.email),0===_t.length&&(_t=this.copy(l),l=[]),s=[],A=0,x=(at=null!=(st=null!=(nt=h.metadata)?nt.author:void 0)?st:[]).length;A<x;A++)(a=at[A]).family&&s.push((a.given?a.given+" ":"")+a.family);h.metadata.author=s,h.adminlink=h.embedded?h.embedded:"https://shareyourpaper.org"+(h.metadata.doi?"/"+h.metadata.doi:""),h.adminlink+=h.adminlink.includes("?")?"&":"?",null!=(null!=(lt=h.archivable)?lt.checksum:void 0)&&(h.confirmed=encodeURIComponent(h.archivable.checksum),h.adminlink+="confirmed="+h.confirmed+"&"),ot=h.email,g.call(h.adminlink,ot)<0&&(h.adminlink+="email="+h.email),wt=await this.templates(h.type+"_deposit"),I=await this.template(wt.content,h),delete h.adminlink,delete h.confirmed,k={from:"deposits@oa.works",to:_t,subject:null!=(ct=I.subject)?ct:h.type+" deposit",html:I.content},l&&l.length&&(k.bcc=l),e&&(k.attachment={file:e.data,filename:null!=(ht=null!=(pt=null!=(dt=h.archivable)?dt.name:void 0)?pt:e.name)?ht:e.filename}),await this.mail(k)}if(h.embargo)try{h.embargo_UI=new Date(h.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(t){}return h},e.deposit._bg=!0,e.archivable=async function(t,e,i,r,s,n){var a,l,o;for(null==n&&(n=this.S.dev),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),l={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},a=async()=>{var a,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z;if(("string"==typeof r||null==r&&(this.params.doi||this.params.title))&&(r=await this.metadata(null!=(C=null!=r?r:this.params.doi)?C:this.params.title)),null==r&&(r={}),"string"==typeof t&&(t={data:t}),null==t&&null!=e&&(t=await this.fetch(e)),null!=t){null==t.name&&(t.name=t.filename);try{l.name=t.name}catch(t){}try{l.format=null!=t.name&&t.name.includes(".")?t.name.split(".").pop():"html"}catch(t){}if(l.format=l.format.toLowerCase(),t.data){if(null==p&&null!=l.format&&null!=this.convert[l.format+"2txt"])try{p=await this.convert[l.format+"2txt"](t.data)}catch(t){}try{null==p&&(p=t.data)}catch(t){}try{p=p.toString()}catch(t){}}}if(null!=p||i){j=((k=(d=p.length<2e4?p:p.substring(0,6e3)+p.substring(p.length-6e3,p.length)).toLowerCase()).length<6e3?k:k.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==l.name&&(l.name=r.title);try{l.checksum=crypto.createHash("md5").update(p,"utf8").digest("base64")}catch(t){}l.same_paper_evidence={};try{l.same_paper_evidence.words_count=p.split(" ").length}catch(t){}try{l.same_paper_evidence.words_more_than_threshold=l.same_paper_evidence.words_count>500}catch(t){}try{l.same_paper_evidence.doi_match=!(!r.doi||!j.includes(r.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(t){}try{l.same_paper_evidence.title_match=!(!r.title||!j.includes(r.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(t){}if(null!=r.author)try{for(c=0,l.same_paper_evidence.author_match=!1,"string"==typeof r.author&&(r.author={name:r.author}),Array.isArray(r.author)||(r.author=[r.author]),B=r.author,g=0,x=B.length;g<x&&(a=B[g],!0!==l.same_paper_evidence.author_match);g++)try{if(u=(null!=(M=null!=(z=null!=(F=null!=(J=a.last)?J:a.lastname)?F:a.family)?z:a.surname)?M:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=($=null!=(V=null!=(G=a.first)?G:a.firstname)?V:a.given)?$:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),v=j.indexOf(u),u.length>2&&o.length>0&&-1!==v&&j.substring(v-20,v+u.length+20).includes(o)&&(c+=1,r.author.length<3&&1===c||r.author.length>2&&c>1)){l.same_paper_evidence.author_match=!0;break}}catch(t){}}catch(t){}if(null!=l.format)for(w=0,O=(L=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;w<O;w++)if(y=L[w],l.format.includes(y)){l.same_paper_evidence.document_format=!0;break}l.same_paper=!!(l.same_paper_evidence.words_more_than_threshold&&(l.same_paper_evidence.doi_match||l.same_paper_evidence.title_match||l.same_paper_evidence.author_match)&&l.same_paper_evidence.document_format),l.same_paper_evidence.words_count<150&&"pdf"===l.format&&(l.same_paper_evidence.words_count=0,l.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),l.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(T=await this.src.google.sheets(n?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),I=0,S=T.length;I<S;I++){_=T[I],l.version_evidence.strings_checked+=1,Z=_["what to search"],X=_["where to search"],m=_["how to search"],b=_["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(H=Z.split("<<")[1].split(">>")[0],null!=r[H.toLowerCase()]&&(Z=Z.replace("<<"+H+">>",r[H.toLowerCase()]))),E=!1,"string"===m?E=!!("file"===X&&d.includes(Z)||"file"!==X&&(null!=r.title&&r.title.includes(Z)||null!=l.name&&l.name.includes(Z))):(D=new RegExp(Z,"gium"),E="file"===X&&null!==k.match(D)||"file"!==X&&(null!=r.title&&null!==r.title.match(D)||null!=l.name&&null!==l.name.match(D))),E){if("string"==typeof(Y=_.value))try{Y=parseInt(Y)}catch(t){}"number"!=typeof Y&&(Y=1),!b||"publisher pdf"!==(P=b.toLowerCase())&&"publishedversion"!==P?l.version_evidence.score-=Y:l.version_evidence.score+=Y,l.version_evidence.strings_matched.push({indicates:b,found:m+" "+Z,in:X,score_value:Y})}}catch(t){f=t,null==(h=l.version_evidence).strings_errored&&(h.strings_errored=[]),l.version_evidence.strings_errored.push({tried:m+" "+Z,in:X,error:f.toString()})}}}catch(t){}l.version_evidence.score>0&&(l.version="publishedVersion"),l.version_evidence.score<0&&(l.version="acceptedVersion"),"unknown"===l.version&&l.version_evidence.strings_checked>0&&(l.version="acceptedVersion");try{null!=(null!=(A=await this.licence(void 0,k))?A.licence:void 0)&&(l.licence=A.licence,l.licence_evidence=A)}catch(t){}l.archivable=!1,i?(l.archivable=!0,i===l.checksum?(l.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",l.admin_confirms=!0):(l.archivable_reason="The depositor says that this file is a version that can be archived",l.depositor_says=!0)):l.same_paper?("pdf"!==l.format&&(l.archivable=!0,l.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!l.archivable&&null!=l.licence&&l.licence.toLowerCase().startsWith("cc")&&(l.archivable=!0,l.archivable_reason="It appears this file contains a "+l.licence+" licence statement. Under this licence the article can be archived"),l.archivable||(l.version?(null!=r&&"{}"!==JSON.stringify(r)&&null==s&&(s=await this.permissions(r)),l.version===(null!=s&&null!=(R=s.best_permission)?R.version:void 0)?(l.archivable=!0,l.archivable_reason="We believe this is a "+l.version.split("V")[0]+" version and our permission system says that version can be shared"):null==l.archivable_reason&&(l.archivable_reason="We believe this file is a "+l.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):l.archivable_reason="We cannot confirm if it is an archivable version or not")):null==l.archivable_reason&&(l.archivable_reason=l.same_paper_evidence.words_more_than_threshold?l.same_paper_evidence.document_format?r.doi||r.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+l.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==t&&null==e||(l.error=null!=(N=t.error)?N:"Could not extract any content");return l.archivable&&null==l.licence&&((null!=s&&null!=(q=s.best_permission)?q.licence:void 0)?l.licence=s.best_permission.licence:(null!=(U=null!=s&&null!=(W=s.best_permission)?W.deposit_statement:void 0)?U:"").toLowerCase().startsWith("cc")&&(l.licence=s.best_permission.deposit_statement)),l.metadata=r},a(),setTimeout((()=>l.timeout=!0),null!=(o=this.params.timeout)?o:6e4);null==l.archivable&&!l.timeout;)await this.sleep(500);return l},e.archivable._bg=!0,g=[].indexOf,e.metadata=async function(t){var e;return null!=(e=await this.find(t))?e.metadata:void 0},e.find=async function(t,e={},i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;_={},s=async t=>{var i,r;for(r in i=await this.citation(t))"url"===r||"paywall"===r?null==_[r]&&(_[r]=i[r]):null==e[r]&&(e[r]=i[r]);return!0},"string"==typeof t&&(t=t.split("doi.org/").pop().startsWith("10.")?{doi:t}:{title:t});try{null==t&&(t=this.copy(this.params))}catch(t){}null==t&&(t={}),null==i&&(i=null!=(p=t.dom)?p:"string"==typeof this.body?this.body:void 0),t.metadata&&(t.find=t.metadata),t.find&&(t.find.startsWith("10.")&&t.find.includes("/")?t.doi=t.find:t.url=t.find,delete t.find),null==t.url&&(t.url=null!=(d=t.q)?d:t.id),t.url&&("number"==typeof t.url&&(t.url=t.url.toString()),t.url.startsWith("/10.")&&(l="10."+t.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&l.split("/")[0].length>6&&l.length>8&&((o=l.split("/")).length>2&&(l=o.join("/")),null==e.doi&&(e.doi=l)),t.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==e.doi&&(e.doi=t.url.replace("doi:","").replace("doi.org/","").trim()),t.url="https://doi.org/"+e.doi):t.url.toLowerCase().startsWith("pmc")?(null==e.pmcid&&(e.pmcid=t.url.toLowerCase().replace("pmcid","").replace("pmc","")),t.url="http://europepmc.org/articles/PMC"+e.pmcid):t.url.replace(/pmid/i,"").replace(":","").length<10&&t.url.includes(".")&&!isNaN(parseInt(t.url.replace(/pmid/i,"").replace(":","").trim()))?(null==e.pmid&&(e.pmid=t.url.replace(/pmid/i,"").replace(":","").trim()),t.url="https://www.ncbi.nlm.nih.gov/pubmed/"+e.pmid):null!=e.title||t.url.startsWith("http")||(t.url.includes("{")||(null!=(f=t.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(y=t.url.match(/\(/gi))?y:[]).length>2?t.citation=t.url:e.title=t.url),t.url.startsWith("http")&&t.url.includes(".")||delete t.url),"string"==typeof t.title&&(t.title.includes("{")||(null!=(m=t.title.replace("...","").match(/\./gi))?m:[]).length>3||(null!=(g=t.title.match(/\(/gi))?g:[]).length>2)&&(t.citation=t.title,delete t.title),t.doi&&(t.doi=await this.decode(t.doi)),null==e.doi&&(e.doi=t.doi),null==e.title&&(e.title=t.title),null==e.pmid&&(e.pmid=t.pmid),null==e.pmcid&&(e.pmcid=null!=(v=t.pmcid)?v:t.pmc),t.citation&&await s(t.citation);try{e.title=e.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(t){}try{e.title=await this.decode(e.title)}catch(t){}try{e.doi=e.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(t){}for("string"==typeof e.doi&&e.doi.startsWith("10.")||delete e.doi,!e.title&&i&&"string"==typeof t.url&&(t.url.includes("alma.exlibrisgroup.com")||t.url.includes("/exlibristest"))&&delete t.url,null!=t.demo&&(_.demo=t.demo),("10.1234/567890"===e.doi||null!=e.doi&&e.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===e.title||"qZooaHWRz9NLFNcgR"===(b=t.from)||"eZwJ83xp3oZDaec86"===b)&&null==_.demo&&(_.demo=!0),_.demo&&null==_.test&&(_.test=!0),u=!1,a=async()=>{var r,n,a,l,o;return null==i&&null==t.url||e.doi||null!=e.pmid||null!=e.pmcid||null!=e.title||(o=await this.scrape(null!=i?i:t.url),await s(o)),e.doi||((e.pmid||e.pmcid)&&(u=await this.src.epmc[e.pmcid?"pmc":"pmid"](null!=(l=e.pmcid)?l:e.pmid),await s(u)),!e.doi&&e.title&&e.title.length>8&&e.title.split(" ").length>1&&(e.title=e.title.replace(/\+/g," "),(null!=(a=await this.src.crossref.works.title(e.title))?a.type:void 0)&&(null!=a?a.DOI:void 0)&&await s(a),e.doi||u||!1!==(u=await this.src.epmc.title(e.title))&&await s(u))),e.doi&&(n=async()=>{var t;return null==(t=await this.src.oadoi(e.doi))&&(_.doi_not_in_oadoi=e.doi),(null!=t?t.doi:void 0)&&(null!=e?e.doi:void 0)&&t.doi.toLowerCase()===e.doi.toLowerCase()&&await s(t),!0},r=async()=>{if(null==(a=await this.src.crossref.works(e.doi))&&(a=await this.src.crossref.works.doi(e.doi)),null!=a?a.type:void 0){try{a.published=await this.src.crossref.works.published(a);try{a.year=a.published.split("-")[0]}catch(t){}try{a.year=parseInt(a.year)}catch(t){}try{a.publishedAt=await this.epoch(a.published)}catch(t){}}catch(t){}await s(a)}else _.doi_not_in_crossref=e.doi;return!0},await Promise.all([n(),r()])),!0},await a(),r=async()=>{var i;if((e.doi||e.title&&e.title.length>8&&e.title.split(" ").length>1)&&(t.from||null!=t.config)&&("instantill"===t.plugin||!0===t.ill))try{null==_.ill&&(_.ill={subscription:await this.ill.subscription(null!=(i=t.config)?i:t.from,e)})}catch(t){}return!0},n=async()=>{var i;return e.doi&&(t.permissions||"shareyourpaper"===t.plugin)&&null==_.permissions&&(_.permissions=await this.permissions(e,null!=(i=t.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]),c=0,h=(w=["title","journal","year","doi"]).length;c<h;c++)t[x=w[c]]&&t[x]!==e[x]&&(e[x]=t[x]);return _.metadata=e,_},e.citation=function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt,gt,vt,bt,wt,_t,xt,Ot,St,kt,jt,At,It,Et,Dt,Ct,Nt,Lt,Tt,Pt,Rt,qt,Ut,Wt,Bt,Mt,zt,Ft,Jt,$t;Ut={};try{null==t&&(t=null!=(T=this.params.citation)?T:this.params)}catch(t){}if("string"==typeof t&&(t.startsWith("{")||t.startsWith("[")))try{t=JSON.parse(t)}catch(t){}if("object"==typeof t){Ut.doi=null!=(P=t.DOI)?P:t.doi,t.pmid&&(Ut.pmid=t.pmid),t.pmcid&&(Ut.pmcid=t.pmcid);try{Ut.type=null!=(V=t.type)?V:t.genre}catch(t){}null==Ut.issn&&(Ut.issn=null!=(rt=null!=(ft=null!=(kt=t.ISSN)?kt:t.issn)?ft:null!=(Tt=t.journalInfo)&&null!=(Pt=Tt.journal)?Pt.issn:void 0)?rt:null!=(Rt=t.journal)?Rt.issn:void 0),null!=(null!=(qt=t.journalInfo)&&null!=(R=qt.journal)?R.eissn:void 0)&&(null==Ut.issn&&(Ut.issn=[]),"string"==typeof Ut.issn&&(Ut.issn=[Ut.issn]),Ut.issn.push(t.journalInfo.journal.eissn)),t.journal_issns&&null==Ut.issn&&(Ut.issn=t.journal_issns.split(","));try{Array.isArray(t.title)&&null==Ut.title&&(Ut.title=t.title[0])}catch(t){}try{null!=t.subtitle&&t.subtitle.length&&t.subtitle[0].length&&(Ut.title+=": "+t.subtitle[0])}catch(t){}null==Ut.title&&(Ut.title=null!=(q=t.dctitle)?q:null!=(U=t.bibjson)?U.title:void 0),404!==(W=t.title)&&"404"!==W&&null==Ut.title&&(Ut.title=t.title),"string"==typeof Ut.title&&(Ut.title=Ut.title.replace(/\s\s+/g," ").trim());try{null==Ut.journal&&(Ut.journal=t["container-title"][0])}catch(t){}try{Ut.shortname=t["short-container-title"][0]}catch(t){}try{Ut.shortname=null!=(B=t.journalInfo.journal.isoabbreviation)?B:t.journalInfo.journal.medlineAbbreviation}catch(t){}Ut.shortname&&!Ut.journal_short&&(Ut.journal_short=Ut.shortname),null==Ut.journal&&(Ut.journal=null!=(M=null!=(z=t.journal_name)?z:null!=(F=t.journalInfo)&&null!=(J=F.journal)?J.title:void 0)?M:null!=($=t.journal)?$.title:void 0),t.journal&&(Ut.journal=t.journal.split("(")[0].trim());try{for(u=0,f=(G=["title","journal"]).length;u<f;u++)Ut[p=G[u]]=Ut[p].charAt(0).toUpperCase()+Ut[p].slice(1)}catch(t){}null==Ut.publisher&&(Ut.publisher=t.publisher),Ut.publisher&&(Ut.publisher=Ut.publisher.trim());try{null!=t.issue&&null==Ut.issue&&(Ut.issue=t.issue)}catch(t){}try{(null!=(X=t.journalInfo)?X.issue:void 0)&&null==Ut.issue&&(Ut.issue=t.journalInfo.issue)}catch(t){}try{null!=t.volume&&null==Ut.volume&&(Ut.volume=t.volume)}catch(t){}try{(null!=(Y=t.journalInfo)?Y.volume:void 0)&&null==Ut.volume&&(Ut.volume=t.journalInfo.volume)}catch(t){}try{null!=t.page&&null==Ut.page&&(Ut.page=t.page.toString())}catch(t){}for(t.pageInfo&&(Ut.page=t.pageInfo.toString()),(t.abstract||t.abstractText)&&(Ut.abstract=null!=(H=t.abstract)?H:t.abstractText),c=0,y=(Z=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<y;c++)if(E=Z[c],"string"!=typeof Ut.published){if(Bt=null!=(K=null!=(Q=t[E])?Q:null!=(tt=t["journal-issue"])?tt[E.replace("journal-issue.","")]:void 0)?K:null!=(et=t.journalInfo)?et[E.replace("journalInfo.","")]:void 0){"number"==typeof Bt&&(Bt=Bt.toString());try{"string"!=typeof Bt&&(Bt=Bt["date-time"].toString())}catch(t){}if("string"!=typeof Bt)try{for(h in Bt["date-parts"][0])"number"!=(it=typeof Bt["date-parts"][0][h])&&"string"!==it&&(Bt["date-parts"][0][h]="01");Bt=Bt["date-parts"][0].join("-")}catch(t){}"string"==typeof Bt&&(Ut.published=Bt.includes("T")?Bt.split("T")[0]:Bt,Ut.published=Ut.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Ut.published.includes("-")||(Ut.published+="-01"),3!==Ut.published.split("-").length&&(Ut.published+="-01"),null==Ut.year&&(Ut.year=Ut.published.split("-")[0]),3!==Ut.published.split("-").length&&delete Ut.published,4!==Ut.year.toString().length&&delete Ut.year)}if(Ut.published)break}t.year&&null==Ut.year&&(Ut.year=t.year);try{null==Ut.year&&(Ut.year=t.journalInfo.yearOfPublication.trim())}catch(t){}if(null==Ut.author&&(null!=t.author||null!=t.z_authors||(null!=(st=t.authorList)?st.author:void 0))){null==Ut.author&&(Ut.author=[]);try{for(lt=null!=(nt=null!=(at=t.author)?at:t.z_authors)?nt:t.authorList.author,A=0,m=lt.length;A<m;A++)if("string"==typeof(e=lt[A]))Ut.author.push({name:e});else{if((s={}).given=null!=(ot=e.given)?ot:e.firstName,s.family=null!=(ut=e.family)?ut:e.lastName,s.name=(s.given?s.given+" ":"")+(null!=(ct=s.family)?ct:""),null!=e.affiliation)try{for(ht=s.affiliation?Array.isArray(e.affiliation)?e.affiliation:[e.affiliation]:s.authorAffiliationDetailsList.authorAffiliation,I=0,v=ht.length;I<v;I++)"string"==typeof(i=ht[I])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(pt=i.name)?pt:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(t){}Ut.author.push(s)}}catch(t){}}try{null!=t.subject&&t.subject.length&&"string"==typeof t.subject[0]&&(Ut.subject=t.subject)}catch(t){}try{null!=(null!=(dt=t.keywordList)?dt.keyword:void 0)&&t.keywordList.keyword.length&&"string"==typeof t.keywordList.keyword[0]&&(Ut.keyword=t.keywordList.keyword)}catch(t){}try{for(bt=[...null!=(yt=null!=(mt=t.meshHeadingList)?mt.meshHeading:void 0)?yt:[],...null!=(gt=null!=(vt=t.chemicalList)?vt.chemical:void 0)?gt:[]],N=0,b=bt.length;N<b;N++)k=bt[N],null==Ut.keyword&&(Ut.keyword=[]),"string"==typeof(j="string"==typeof k?k:null!=(wt=k.name)?wt:k.descriptorName)&&j&&g.call(Ut.keyword,j)<0&&Ut.keyword.push(j)}catch(t){}"string"==typeof t.license&&(Ut.licence=t.license.trim().replace(/ /g,"-")),"string"==typeof t.licence&&(Ut.licence=t.licence.trim().replace(/ /g,"-"));try{(null!=(_t=t.best_oa_location)?_t.license:void 0)&&null!==(null!=(xt=t.best_oa_location)?xt.license:void 0)&&null==Ut.licence&&(Ut.licence=t.best_oa_location.license)}catch(t){}if(!Ut.licence){if(Array.isArray(t.assertion))for(L=0,w=(Ot=t.assertion).length;L<w;L++)"OPEN ACCESS"===(e=Ot[L]).label&&e.URL&&e.URL.includes("creativecommons")&&null==Ut.licence&&(Ut.licence=e.URL);if(Array.isArray(t.license))for(Mt=0,_=(jt=null!=(St=t.license)?St:[]).length;Mt<_;Mt++)!(d=jt[Mt]).URL||!d.URL.includes("creativecommons")||Ut.licence&&Ut.licence.includes("creativecommons")||null==Ut.licence&&(Ut.licence=d.URL)}if("string"==typeof Ut.licence&&Ut.licence.includes("/licenses/")&&(Ut.licence="cc-"+Ut.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Ut.url&&(Ut.url=null!=(At=null!=(It=t.best_oa_location)?It.url_for_pdf:void 0)?At:null!=(Et=t.best_oa_location)?Et.url:void 0),!Ut.url&&null!=(null!=(Dt=t.fullTextUrlList)?Dt.fullTextUrl:void 0))for(Ft=0,x=(Ct=t.fullTextUrlList.fullTextUrl).length;Ft<x;Ft++)"oa"!==(Nt=(a=Ct[Ft]).availabilityCode.toLowerCase())&&"f"!==Nt||Ut.url&&("pdf"!==a.documentStyle||Ut.url.includes("pdf"))||(Ut.url=a.url)}else if("string"==typeof t)try{(t=t.replace(/citation\:/gi,"").trim()).includes("title")&&(t=t.split("title")[1].trim()),(t=t.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Ut.doi=t.split("doi:")[1].split(",")[0].split(" ")[0].trim()),t.includes("doi.org/")&&(Ut.doi=t.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Ut.doi&&t.includes("http")&&(Ut.url="http"+t.split("http")[1].split(" ")[0].trim());try{(t.includes("|")||t.includes("}"))&&(Ut.title=t.split("|")[0].split("}")[0].trim()),t.split('"').length>2?Ut.title=t.split('"')[1].trim():t.split("'").length>2&&null==Ut.title&&(Ut.title=t.split("'")[1].trim())}catch(t){}try{for(C=t.replace(/,\./g," ").split(" "),Jt=0,O=C.length;Jt<O;Jt++)D=C[Jt],Ut.year||4===(D=D.replace(/[^0-9]/g,"")).length&&("number"!=typeof(zt=parseInt(D))||isNaN(zt)||(Ut.year=zt))}catch(t){}try{!Ut.title&&Ut.year&&t.indexOf(Ut.year)<t.length/4&&(Ut.title=t.split(Ut.year)[1].trim(),(!Ut.title.includes("(")||Ut.title.indexOf(")")<Ut.title.indexOf("("))&&(Ut.title=Ut.title.replace(")","")),Ut.title.indexOf(".")<3&&(Ut.title=Ut.title.replace(".","")),Ut.title.indexOf(",")<3&&(Ut.title=Ut.title.replace(",","")),Ut.title=Ut.title.trim(),Ut.title.includes(".")?Ut.title=Ut.title.split(".")[0]:Ut.title.includes(",")&&(Ut.title=Ut.title.split(",")[0]))}catch(t){}if(Ut.title){try{if(n=t.split(Ut.title)[0],Ut.year&&n.includes(Ut.year)&&(n=n.split(Ut.year)[0]),Ut.url&&n.indexOf(Ut.url)>0&&(n=n.split(Ut.url)[0]),Ut.url&&n.startsWith(Ut.url)&&(n=n.replace(Ut.url)),Ut.doi&&n.startsWith(Ut.doi)&&(n=n.replace(Ut.doi)),n.indexOf(".")<3&&(n=n.replace(".","")),n.indexOf(",")<3&&(n=n.replace(",","")),n.lastIndexOf("(")>n.length-3&&(n=n.substring(0,n.lastIndexOf("("))),n.lastIndexOf(")")>n.length-3&&(n=n.substring(0,n.lastIndexOf(")"))),n.lastIndexOf(",")>n.length-3&&(n=n.substring(0,n.lastIndexOf(","))),n.lastIndexOf(".")>n.length-3&&(n=n.substring(0,n.lastIndexOf("."))),(n=n.trim()).length>6)if(n.includes(","))for(Ut.author=[],Lt=n.split(","),$t=0,S=Lt.length;$t<S;$t++)r=Lt[$t],Ut.author.push({name:r});else Ut.author=[{name:n}]}catch(t){}try{Wt=t.split(Ut.title)[1],Ut.url&&Wt.includes(Ut.url)&&(Wt=Wt.replace(Ut.url)),Ut.doi&&Wt.includes(Ut.doi)&&(Wt=Wt.replace(Ut.doi)),Wt.indexOf(".")<3&&(Wt=Wt.replace(".","")),Wt.indexOf(",")<3&&(Wt=Wt.replace(",","")),(Wt=Wt.trim()).length>6&&(Ut.journal=Wt,Wt.includes(",")&&(Ut.journal=Ut.journal.split(",")[0].replace(/in /gi,"").trim()),Ut.journal.indexOf(".")<3&&(Ut.journal=Ut.journal.replace(".","")),Ut.journal.indexOf(",")<3&&(Ut.journal=Ut.journal.replace(",","")),Ut.journal=Ut.journal.trim())}catch(t){}}try{if(Ut.journal&&(Wt=t.split(Ut.journal)[1],Ut.url&&Wt.includes(Ut.url)&&(Wt=Wt.replace(Ut.url)),Ut.doi&&Wt.includes(Ut.doi)&&(Wt=Wt.replace(Ut.doi)),Wt.indexOf(".")<3&&(Wt=Wt.replace(".","")),Wt.indexOf(",")<3&&(Wt=Wt.replace(",","")),(Wt=Wt.trim()).length>4)){if(Wt.includes("retrieved")&&(Wt=Wt.split("retrieved")[0]),Wt.includes("Retrieved")&&(Wt=Wt.split("Retrieved")[0]),Ut.volume=Wt,Ut.volume.includes("(")){Ut.volume=Ut.volume.split("(")[0],Ut.volume=Ut.volume.trim();try{Ut.issue=Wt.split("(")[1].split(")")[0],Ut.issue=Ut.issue.trim()}catch(t){}}if(Ut.volume.includes(",")){Ut.volume=Ut.volume.split(",")[0],Ut.volume=Ut.volume.trim();try{Ut.issue=Wt.split(",")[1],Ut.issue=Ut.issue.trim()}catch(t){}}if(Ut.volume)try{isNaN(parseInt(Ut.volume))&&delete Ut.volume}catch(t){}if(Ut.issue){Ut.issue.includes(",")&&(Ut.issue=Ut.issue.split(",")[0].trim());try{isNaN(parseInt(Ut.issue))&&delete Ut.issue}catch(t){}}if(Ut.volume&&Ut.issue)try{(Wt=t.split(Ut.journal)[1]).includes("retriev")&&(Wt=Wt.split("retriev")[0]),Wt.includes("Retriev")&&(Wt=Wt.split("Retriev")[0]),Ut.url&&Wt.includes(Ut.url)&&(Wt=Wt.split(Ut.url)[0]),Ut.doi&&Wt.includes(Ut.doi)&&(Wt=Wt.split(Ut.doi)[0]),(Wt=(Wt=Wt.substring(Wt.indexOf(Ut.volume)+(Ut.volume+"").length)).substring(Wt.indexOf(Ut.issue)+(Ut.issue+"").length)).indexOf(".")<2&&(Wt=Wt.replace(".","")),Wt.indexOf(",")<2&&(Wt=Wt.replace(",","")),Wt.indexOf(")")<2&&(Wt=Wt.replace(")","")),Wt=Wt.trim(),isNaN(parseInt(Wt.substring(0,1)))||(Ut.pages=Wt.split(" ")[0].split(".")[0].trim(),Ut.pages.length>5&&(Ut.pages=Ut.pages.split(", ")[0]))}catch(t){}}}catch(t){}if(!Ut.author&&t.includes("et al")&&(o=t.split("et al")[0].trim(),t.startsWith(o)&&(Ut.author=[{name:o+"et al"}])),Ut.title&&!Ut.volume)try{(l=t.split(Ut.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Ut.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Ut.issue&&l.includes("iss")&&(Ut.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Ut.pages&&l.includes("page")&&(Ut.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(t){}}catch(t){}return"number"==typeof Ut.year&&(Ut.year=Ut.year.toString()),Ut},e.availability=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,S,k,j,A,I,E;if(null==t&&(t=this.copy(this.params)),delete this.params.dom,t.availability&&(t.availability.startsWith("10.")&&t.availability.includes("/")?t.doi=t.availability:t.availability.includes(" ")?t.title=t.availability:t.id=t.availability,delete t.availability),Array.isArray(t.url)&&(t.url=t.url[0]),!t.test&&t.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=t&&(i.data.match=null!=(n=null!=(a=null!=(g=null!=(w=null!=(_=null!=(x=null!=(O=null!=(S=t.doi)?S:t.pmid)?O:t.pmc)?x:t.pmcid)?_:t.title)?w:t.url)?g:t.id)?a:t.citation)?n:t.q),"object"==typeof e&&"{}"!==JSON.stringify(e)&&null!=e.metadata&&(i.v2=e),null==i.v2&&(i.v2=await this.find(t)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(k=null!=(j=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(p=i.v2.metadata)?p.title:void 0)?o:null!=(d=i.v2.metadata)?d.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?j:null!=(y=i.v2.metadata)?y.pmcid:void 0)?k:null!=(m=i.v2.metadata)?m.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(t){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(s=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(I=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+s+" AND type:article&sort=createdAt:desc"))&&null!=(v=I.hits)?v.total:void 0)&&((E={type:"article",_id:(A=I.hits.hits[0]._source)._id}).ucreated=!(!t.uid||(null!=(b=A.user)?b.id:void 0)!==t.uid),i.data.requests.push(E))}catch(t){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},g=[].indexOf,e.ill=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x;null==t&&(t=this.copy(this.params)).ill&&(t.doi=t.ill,delete t.ill),null==t.metadata&&(t.metadata=await this.metadata(t)),!0===t.pilot&&(t.pilot=Date.now()),!0===t.live&&(t.live=Date.now()),s=t.config;try{s=JSON.parse(s)}catch(t){}for(h in("string"==typeof s||!s&&t.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=t.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(y=t.from)?y:s)))),null==s&&(s={}),x={name:"librarian",details:""},p=["title","author","volume","issue","date","pages"],t)if("metadata"===h){for(c in t[h])"email"!==c&&(t[c]=t[h][c],g.call(p,c)<0&&p.push(c));delete t.metadata}else g.call(p,h)<0&&p.push(h);for(a=0,o=p.length;a<o;a++)if(t[d=p[a]]&&(x[d]=t[d],"author"===d)){for(n=!0,r=[],l=0,u=(m=t[d]).length;l<u;l++)(e=m[l]).family&&(n&&(n=!1),i=e.family+(e.given?" "+e.given:""),r.push(i));x[d]=r}return null!=t.author&&delete t.author,x.illid=t._id=await this.uid(),s.search&&s.search.length&&(t.issn||t.journal)&&(-1!==s.search.indexOf("worldcat")?(w=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",w+=null!=t.issn?"in%3A":"ti%3A",w+="&si0qs="+(null!=(v=t.issn)?v:t.journal),w+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(w=s.search,w+=t.issn?t.issn:t.journal),x.worldcatsearchurl=w),await this.ills(t),_=(_=await this.templates("instantill_create")).content,t.forwarded||t.resolved||!s.email&&!t.email||this.waitUntil(this.mail({svc:"oaworks",vars:x,template:_,to:null!=(b=s.email)?b:t.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+t._id})),_=_.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:x,template:_,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+t._id,to:"joe@oa.works"})),t},e.ills={_index:!0},e.ill.collect=async function(t){var e,i,r;for(e in null==t&&(t=this.copy(this.params)),i=t.collect,null==t._id&&(t._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",t)"collect"!==e&&(r+=("_id"===e?"uuid":e)+"="+t[e]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(t)),!0},e.ill.openurl=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d;for(r in null==t&&(t=null!=(u=this.params.config)?u:{}),null==e&&(e=null!=(c=this.params.meta)?c:await this.metadata()),t.ill_redirect_base_url&&null==t.ill_form&&(t.ill_form=t.ill_redirect_base_url),t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})t[r]||(t[r]=s[r]);for(a in p="",t.ill_added_params&&(p+=t.ill_added_params.replace("?","")+"&"),p+=t.sid+"=InstantILL&",e){if(d="","author"===a)for(n=0,l=(h=Array.isArray(e.author)?e.author:[e.author]).length;n<l;n++)i=h[n],d.length&&(d+=", "),d+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==a&&"pmid"!==a&&"pmc"!==a&&"pmcid"!==a&&"url"!==a&&"journal"!==a&&"title"!==a&&"year"!==a&&"issn"!==a&&"volume"!==a&&"issue"!==a&&"page"!==a&&"crossref_type"!==a&&"publisher"!==a&&"published"!==a&&"notes"!==a||(d=e[a]);d&&(p+=(t[a]?t[a]:a)+"="+encodeURIComponent(d)+"&")}return e.usermetadata&&(o=t.notes?t.notes:"notes",-1===(p=p.replace("usermetadata=true","")).indexOf(o+"=")?p+="&"+o+"=The user provided some metadata.":p=p.replace(o+"=",o+"=The user provided some metadata. ")),p.replace("/&&/g","&")},e.ill.subscription=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(t||e||!this.params.sub&&!this.params.subscription||((t=this.copy(this.params)).sub&&(t.subscription=t.sub),this.params.meta?(e=this.params.meta,delete t.meta):t.doi&&2===this.keys(t).length?(e=await this.metadata(t.doi),delete t.doi):(e=this.copy(t),delete t.doi)),null==t&&(t=null!=(l=this.params.config)?l:{}),"string"==typeof t&&(null!=(t=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+t))&&"{}"!==JSON.stringify(t)||(t=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:t)))),null==e&&(e=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=t.subscription)for(h in t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),n=await this.ill.openurl(t,e),t.ill_added_params&&(n=n.replace(t.ill_added_params.replace("?",""),"")),"string"==typeof t.subscription&&(t.subscription=t.subscription.split(",")),"string"==typeof t.subscription_type&&(t.subscription_type=t.subscription_type.split(",")),null==t.subscription_type&&(t.subscription_type=[]),t.subscription)if("object"==typeof(d=t.subscription[h])?(f=d.type,d=d.url):f=null!=(u=t.subscription_type[h])?u:"unknown",d=d.trim()){"serialssolutions"===f||-1!==d.indexOf("serialssolutions")?(-1!==(m=d.split(".search")[0]).indexOf("//")&&(m=m.split("//")[1]),d="http://"+m+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===d.indexOf("sfx.")||-1!==d.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===d.indexOf(".exlibris")||-1!==d.indexOf("response_type")||(d=d.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):d+=(-1===d.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=d+(-1===d.indexOf("?")?"?":"&")+n).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==d.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==d.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),a="",p="",i=!1,c.lookups.push(g);try{p=-1!==(a=await this.fetch(g)).indexOf("<body")?a.toLowerCase().split("<body")[1].split("</body")[0]:a,c.contents.push(p)}catch(t){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==p.indexOf("getFullTxt")&&-1!==p.indexOf("<target_url>"))try{c.url=p.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(t){}else-1!==p.indexOf('<a title="navigate to target in new window')&&-1!==p.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==p.indexOf("view this ")&&-1!==a.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+a.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==p.indexOf('<ssopenurl:url type="article">'))(r=p.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===p.indexOf("ss_noresults"))try{y=g.split("?")[0]+"?ShowSupressedLinks"+a.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(s=await this.fetch(y)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=y.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(t){i&&c.error.push("serialssolutions")}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==p.indexOf("full_text_indicator")&&0===p.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==p.indexOf("resolution_url")&&(c.url=p.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},e.licence=async function(t,e,i,r){var s,n,a,l,o,u,c,h,p,d,f,m,g;if(null==t&&(t=this.params.url),null==e&&(e=null!=(c=this.params.content)?c:this.body),t||e||!this.params.licence&&!this.params.doi||(t="https://doi.org/"+(null!=(h=this.params.licence)?h:this.params.doi)),t&&(t=t.replace(/(^\s*)|(\s*$)/g,""),!e)){y.log(t);try{e=await this.fetch(t)}catch(t){}}if("number"==typeof e&&(e=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),l={},t&&(l.url=t),"string"==typeof e)for(null!=i&&e.includes(i)&&(e=e.split(i)[1]),r&&(e=e.split(r)[0]),e.length>1e5&&(l.large=!0,e=e.substring(0,5e4)+e.substring(e.length-5e4,e.length)),s=0,a=(f=null!=(p=null!=(o=await this.licences("*",1e4))&&null!=(d=o.hits)?d.hits:void 0)?p:[]).length;s<a;s++)if((!(n=f[s]._source).matchesondomains||"*"===n.matchesondomains||null==t||n.matchesondomains.toLowerCase().includes(t.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=n.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(g=!!n.matchtext.includes("://")&&n.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&e.toLowerCase().includes(g))||e.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){l.licence=n.licencetype,l.match=n.matchtext,l.matched=m?g:u;break}return l},e.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},g=[].indexOf,e.permissions=async function(t,e,i,s,n,a){var l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt,gt,vt,bt,wt,_t,xt,Ot,St,kt,jt,At,It,Et,Dt,Ct,Nt,Lt,Tt,Pt,Rt,qt,Ut,Wt,Bt,Mt;if(M=!1,m=!1,l=async function(e){var i,s,a,l,o,u,c,h,p,d,f,y,g,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L;if(m&&e.embargo_months&&(t.published||t.year)&&(s=new Date(Date.parse(null!=(g=t.published)?g:t.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+e.embargo_months)),e.embargo_end=s.toISOString().split("T")[0]),""===e.embargo_end&&delete e.embargo_end,e.copyright_name=e.copyright_owner&&"publisher"===e.copyright_owner.toLowerCase()?"string"==typeof e.issuer.parent_policy?e.issuer.parent_policy:"string"==typeof e.issuer.id?e.issuer.id:e.issuer.id[0]:!e.copyright_owner||"journal"!==(v=e.copyright_owner.toLowerCase())&&"affiliation"!==v?m&&e.copyright_owner&&e.copyright_owner.toLowerCase().includes("author")&&null!=t.author&&t.author.length&&(t.author[0].name||t.author[0].family)?(null!=(j=t.author[0].name)?j:t.author[0].family)+(t.author.length>1?" et al":""):"":null!=(k=t.journal)?k:"",("publisher"===(A=e.copyright_name.toLowerCase())||"journal"===A)&&(n||t.doi||(null!=(I=e.provenance)?I.example:void 0)))for(null==n&&(n=await this.src.crossref.works(null!=(E=t.doi)?E:e.provenance.example)),o=0,h=(C=null!=(D=null!=n?n.assertion:void 0)?D:[]).length;o<h;o++)if("copyright"===(i=C[o]).name.toLowerCase()){try{e.copyright_name=i.value}catch(t){}try{e.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(t){}}if(m&&""===e.copyright_year&&t.year&&(e.copyright_year=t.year),""===e.copyright_year&&delete e.copyright_year,m&&null!=e.deposit_statement&&e.deposit_statement.includes("<<")){for(l="",u=0,p=(N=e.deposit_statement.split("<<")).length;u<p;u++)if(y=N[u],""!==l||y.includes(">>")){if(null!=(L={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(a=y.split(">>"))[0].toLowerCase()]&&(f=L[f]),"author"===f)try{l+=(null!=(b=t.author[0].name)?b:t.author[0].family)+(t.author.length>1?" et al":"")}catch(t){}else l+=null!=(w=null!=(_=t[f])?_:e[f])?w:"";try{l+=a[1]}catch(t){}}else l+=y;e.deposit_statement=l}for(null!=e._id&&(null==e.meta&&(e.meta={}),e.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(e.issuer.type?e.issuer.type+"/":"")+e._id),"string"!=typeof(null!=(x=e.issuer)?x.has_policy:void 0)||"not publisher"!==(O=e.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(M=e.issuer.has_policy),c=0,d=(S=["_id","hide"]).length;c<d;c++)delete e[S[c]];return e},u=t=>{var e,i,r,s,n,a;return a=t.can_archive?1e3:0,"In DOAJ"===(null!=(e=t.provenance)?e.oa_evidence:void 0)&&(a+=1e3),null!=t.requirements?a-=10:a+="publishedVersion"===t.version?200:"acceptedVersion"===t.version?100:0,t.licence&&(a-=5),a+="journal"===(null!=(i=t.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=t.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=t.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=t.issuer)?n.type.toLowerCase():void 0)?2:0,t.embargo_months&&t.embargo_months>=36&&(!t.embargo_end||Date.parse(t.embargo_end)<Date.now())&&(a-=25),a},"string"==typeof t&&(t=t.startsWith("10.")?{doi:t}:{issn:t}),null==t&&(t=this.copy(this.params)),!0===(null!=t?t.metadata:void 0)&&delete t.metadata,null!=(null!=t?t.permissions:void 0)&&"string"==typeof t.permissions&&(t.permissions.startsWith("journal/")?t.issn=t.permissions.replace("journal/",""):t.permissions.startsWith("affiliation/")?t.ror=t.permissions.replace("affiliation/",""):t.permissions.startsWith("publisher/")?t.publisher=t.permissions.replace("publisher/",""):t.permissions.startsWith("10.")&&t.permissions.includes("/")?t.doi=t.permissions:t.permissions.includes("-")&&t.permissions.length<10&&t.permissions.length>6?t.issn=t.permissions:t.permissions.includes(" ")||t.permissions.includes(",")||t.permissions.replace(/[0-9]/g,"").length===t.permissions.length?t.publisher=t.permissions:t.ror=t.permissions,delete t.permissions),t.affiliation&&(t.ror=t.affiliation,delete t.affiliation),null==t.ror&&(t.ror=e),"string"==typeof t.ror&&t.ror.includes(",")&&(t.ror=t.ror.split(",")),t.journal&&!t.journal.includes(" ")&&t.journal.includes("-")&&(t.issn=t.journal,delete t.journal),_=Array.isArray(t.issn)?t.issn:[],"string"==typeof t.issn&&t.issn.includes(",")&&(t.issn=t.issn.split(",")),delete t.best,"{}"===JSON.stringify(t)||t.issn&&!JSON.stringify(t.issn).includes("-")||t.doi&&("string"!=typeof t.doi||!t.doi.startsWith("10.")||!t.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==a&&(a=this.params.best),a&&t.doi&&!t.ror.length&&(h=await this.permissions.best(t.doi))&&(!0===a||h.updated>a))return delete h.updated,delete h.DOI,{best_permission:h};if(o=async()=>{var e,i,r,s,a;if(i=this.copy(t),"{}"!==JSON.stringify(i)){for(e in s=[],a=null!=(r=null!=n?n:await this.metadata(t.doi))?r:{})s.push(null!=t[e]?t[e]:t[e]=a[e]);return s}},!1===i||!t.doi||t.publisher&&t.issn||await o(),!t.published&&t.year&&(t.published=t.year+"-01-01"),m=null!=t.doi,t.issn){if("string"==typeof t.issn&&(t.issn=[t.issn]),!_.length)for(v=0,k=(H=t.issn).length;v<k;v++)w=H[v],g.call(_,w)<0&&_.push(w);try{null==t.doi&&(t.doi=await this.permissions.journals.example(_))}catch(t){}!m&&t.doi&&await o()}if(m&&"journal-article"!==t.type)return{body:"DOI is not a journal article",status:501};t.publisher&&t.publisher.includes("(")&&t.publisher.lastIndexOf(")")>.7*t.publisher.length&&(t.publisher=t.publisher.substring(0,t.publisher.lastIndexOf("(")).trim());try{t.citation="[",t.title&&(t.citation+=t.title+". "),t.journal&&(t.citation+=t.journal+" "),t.volume&&(t.citation+=t.volume+(t.issue?", ":" ")),t.issue&&(t.citation+=t.issue+" "),null==t.page&&null==t.pages||(t.citation+="p"+(null!=(at=t.page)?at:t.pages)),(t.year||t.published)&&(t.citation+=" ("+(null!=(yt=t.year)?yt:t.published).split("-")[0]+")"),t.citation=t.citation.trim(),t.citation+="]"}catch(t){}if(J={best_permission:void 0,all_permissions:[]},Ct=[],null!=t.ror){if("string"==typeof t.ror&&(t.ror=[t.ror]),!(null!=(Tt=await this.permissions.affiliations('issuer.id:"'+t.ror.join('" OR issuer.id:"')+'"'))&&null!=(kt=Tt.hits)?kt.total:void 0))try{(null!=(jt=(Pt=await this.src.ror(1===t.ror.length?t.ror[0]:'id:"'+t.ror.join(" OR id:")+'"')).hits)?jt.total:void 0)&&(Pt=Pt.hits.hits[0]._source),Pt.country.country_code&&(Tt=await this.permissions.affiliations('issuer.id:"'+Pt.country.country_code+'"'))}catch(t){}for(x=0,j=(Et=null!=(At=null!=Tt&&null!=(It=Tt.hits)?It.hits:void 0)?At:[]).length;x<j;x++)Lt=Et[x],(Ut=await l(Lt._source)).score=await u(Ut),Ct.push(Ut)}if(b=void 0,_){for await(Y of this.index._for("src_doaj_journals",'bibjson.pissn:"'+_.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+_.join('" OR bibjson.eissn:"')+'"'))b||(b=Y),Z=Y.bibjson.pissn,g.call(_,Z)<0&&_.push(Y.bibjson.pissn),K=Y.bibjson.eissn,g.call(_,K)<0&&_.push(Y.bibjson.eissn);if(null==b){for await(Y of(W=[],this.index._for("src_openalex_venues",'issn:"'+_.join('" OR issn:"')+'"')))for(S=0,I=(Q=Y.issn).length;S<I;S++)y=Q[S],g.call(W,y)<0&&W.push(y);_=W}if(_.length)for(q=0,E=(it=null!=(tt=null!=($=await this.permissions.journals('issuer.id:"'+_.join('" OR issuer.id:"')+'"'))&&null!=(et=$.hits)?et.hits:void 0)?tt:[]).length;q<E;q++)z=it[q],(Nt=await l(z._source)).score=await u(Nt),J.all_permissions.push(Nt)}if(t.publisher)for(G='issuer.id:"'+t.publisher+'"',U=0,D=(nt=null!=(rt=null!=($=await this.permissions.publishers(G))&&null!=(st=$.hits)?st.hits:void 0)?rt:[]).length;U<D;U++)z=nt[U],(Nt=await l(z._source)).score=await u(Nt),J.all_permissions.push(Nt);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},_&&(null!=b?b:b=await this.src.doaj.journals('bibjson.eissn.keyword:"'+_.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+_.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(B=0,C=(ut=null!=(lt=null!=(ot=b.bibjson)?ot.license:void 0)?lt:[]).length;B<C;B++)d=ut[B],(!c.licence||c.licence.length>d.type)&&(c.licence=d.type),null==c.licences&&(c.licences=[]),c.licences.push({type:d.type});if(null==c.licence&&(p=await this.src.crossref.journals('ISSN.keyword:"'+_.join('" OR ISSN.keyword:"')+'"',1)))for(V=0,N=(ht=null!=(ct=p.license)?ct:[]).length;V<N;V++)R=ht[V],(!c.licence||c.licence.length>R.type)&&(c.licence=R.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=b.bibjson.eissn&&b.bibjson.pissn?[b.bibjson.pissn,b.bibjson.eissn]:b.bibjson.pissn?[b.bibjson.pissn]:[b.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),J.all_permissions.push(c)}else!_&&t.publisher&&(await this.permissions.publishers.oa(t.publisher)).oa&&(c.issuer.id=t.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),J.all_permissions.push(c));if(t.doi&&(null==s&&(s=await this.src.oadoi(t.doi)),m&&(null!=s&&null!=(pt=s.best_oa_location)?pt.license:void 0)&&s.best_oa_location.license.includes("cc")&&((f={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:t.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(f.versions="submittedVersion"===f.version?["submittedVersion"]:"acceptedVersion"===f.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),f.score=await u(f),J.all_permissions.push(f))),J.all_permissions.length){for(J.all_permissions.sort(((t,e)=>t.score<e.score?1:-1)),X=0,L=(dt=J.all_permissions).length;X<L;X++)null==(Mt=dt[X]).licences&&(Mt.licences=[],Mt.licence&&Mt.licences.push({type:Mt.licence})),m&&(null!=(ft=Mt.issuer)?ft.journal_oa_type_from:void 0)&&t.published&&Date.parse(t.published)<Date.parse(Mt.issuer.journal_oa_type_from)&&delete Mt.issuer.journal_oa_type,delete Mt.issuer.journal_oa_type_from,!_&&"journal"!==(null!=(mt=Mt.issuer)?mt.type:void 0)||Mt.issuer.journal_oa_type||(Mt.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=_?_:Mt.issuer.id,b,s,n)),(null!=(gt=Mt.provenance)?gt.enforcement_from:void 0)?(!t.published||Date.parse(t.published)>Date.parse(Mt.provenance.enforcement_from.split("/").reverse().join("-")))&&null==J.best_permission&&(J.best_permission=this.copy(Mt)):null==J.best_permission&&(J.best_permission=this.copy(Mt));if(Ct.length)for(Ct.sort(((t,e)=>t.score<e.score?1:-1)),Rt=0,T=Ct.length;Rt<T;Rt++)if(Dt=Ct[Rt],m&&(null!=(vt=Dt.issuer)?vt.journal_oa_type_from:void 0)&&t.published&&Date.parse(t.published)<Date.parse(Dt.issuer.journal_oa_type_from)&&delete Dt.issuer.journal_oa_type,delete Dt.issuer.journal_oa_type_from,!_&&"journal"!==(null!=(bt=Dt.issuer)?bt.type:void 0)||Dt.issuer.journal_oa_type||(Dt.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=_?_:Dt.issuer.id,b,s,n)),J.all_permissions.push(Dt),null==(null!=(wt=J.best_permission)?wt.author_affiliation_requirement:void 0)&&null!=J.best_permission&&(!(null!=(_t=Dt.provenance)?_t.enforcement_from:void 0)||!t.published||Date.parse(t.published)>Date.parse(Dt.provenance.enforcement_from.split("/").reverse().join("-")))){for(F=this.copy(J.best_permission),qt=0,P=(xt=["versions","locations"]).length;qt<P;qt++)for(Wt=0,A=(Ot=Dt[O=xt[qt]]).length;Wt<A;Wt++)Bt=Ot[Wt],null==F[O]&&(F[O]=[]),g.call(F[O],Bt)<0&&F[O].push(Bt);F.version=g.call(F.versions,"publishedVersion")>=0?"publishedVersion":g.call(F.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",F.embargo_end&&Dt.embargo_end&&Date.parse(Dt.embargo_end)<Date.parse(F.embargo_end)&&(F.embargo_end=Dt.embargo_end),F.embargo_months&&null!=Dt.embargo_months&&Dt.embargo_months<F.embargo_months&&(F.embargo_months=Dt.embargo_months),!0===Dt.can_archive&&(F.can_archive=!0),null==F.requirements&&(F.requirements={}),F.requirements.author_affiliation_requirement=null==t.ror?Dt.issuer.id:"string"==typeof t.ror?t.ror:t.ror[0],F.issuer.affiliation=Dt.issuer,null==F.meta&&(F.meta={}),F.meta.affiliation=Dt.meta,null==F.provenance&&(F.provenance={}),F.provenance.affiliation=Dt.provenance,F.score=parseInt(F.score)+parseInt(Dt.score),J.best_permission=F,J.all_permissions.push(F)}}return M?{body:"string"!=typeof M?M:null!=(St={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[M.toLowerCase()])?St:M,status:501}:(t.doi&&!Ct.length&&J.best_permission&&((h=await this.copy(J.best_permission)).updated=await this.epoch(),h.DOI=t.doi,this.waitUntil(this.permissions.best(h))),!0!==this.params.metadata&&!0!==i||(J.metadata=t),J)},e.permissions.best={_index:!0,_key:"DOI"},e.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(t=[]){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w;for(f=[],s=0,u=(m="object"!=typeof t||Array.isArray(t)?t:[t]).length;s<u;s++){for(a in d={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},y=m[s])if("string"==typeof y[a]&&(y[a]=y[a].trim()),"id"===a)if(d.issuer.id="string"==typeof y.id&&y.id.includes(",")?y.id.split(","):y.id,"string"==typeof d.issuer.id&&d.issuer.id.startsWith("10.")&&d.issuer.id.includes("/")&&!d.issuer.id.includes(" "))d.DOI=d.issuer.id;else{for(r=[],n=0,c=(v="string"==typeof d.issuer.id?[d.issuer.id]:d.issuer.id).length;n<c;n++){if(p=(p=v[n]).trim(),"journal"===d.issuer.type&&p.includes("-")&&!p.includes(" ")&&(p=p.toUpperCase(),e=await this.journal('ISSN:"'+p+'"',1)))for(o=0,h=(b=e.issn).length;o<h;o++)i=b[o],g.call(r,i)<0&&r.push(i);g.call(r,p)<0&&r.push(p)}d.issuer.id=r}else"embargo_months"===a?(l="number"==typeof y[a]?y[a]:"string"==typeof y[a]?parseInt(y[a].trim()):void 0)&&"number"==typeof l&&(d.embargo_months=l,d.embargo_end=""):a&&null!=y[a]&&""!==(w=y[a])&&"none"!==w&&"unclear"!==w&&("versions"===a&&y.versions.length&&(d.can_archive=!0,d.version=y.versions.includes("ublish")?"publishedVersion":y.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==a&&"locations"!==a&&"meta.contributors"!==a&&"meta.creator"!==a&&"meta.reviewer"!==a&&"provenance.archiving_policy"!==a&&"requirements.funder"!==a&&"journal"!==a||(y[a]=y[a].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(d,"license"===a?"licence":a,y[a]));d.copyright_owner&&"journal"!==d.copyright_owner.toLowerCase()||!d.issuer.type||(d.copyright_owner=d.issuer.type),"{}"===JSON.stringify(d.requirements)&&delete d.requirements,f.push(d)}return 1===f.length?f[0]:f}},e.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:e.permissions.journals._format},e.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:e.permissions.journals._format},e.permissions.journals.example=async function(t){var e;null==t&&(t=null!=(e=this.params.doi)?e:this.params.issn),"string"==typeof t&&(t=t.split(","));try{return(await this.src.crossref.works('ISSN:"'+t.join('" OR ISSN:"')+'"',1)).DOI}catch(t){}},e.permissions.journals.transformative={_index:!0,_prefix:!1},e.permissions.journals.transformative.load=async function(){var t,e,i,r,s;for(t=[],e=0,i=(s=(await this.fetch("https://api.journalcheckertool.org/tj?q=*&include=title,issn&size=10000")).hits.hits).length;e<i;e++)r=s[e],t.push(r._source);return t.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(t)),t.length},e.permissions.journals.transformative.load._bg=!0,e.permissions.journals.transformative.load._async=!0,e.permissions.journals.transformative.load._auth="root",e.permissions.journals.oa=async function(t,e){var i,r,s,n,a,l;try{null==t&&(t=null!=(r=null!=(s=null!=(n=this.params.journals)?n:this.params.journal)?s:this.params.issn)?r:this.params.oa)}catch(t){}return l={},t&&(l.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+t+'"'),l.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+t+'" AND is_oa:true'),l.articles===l.open&&(l.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+t+'" OR bibjson.eissn:"'+t+'"',1)&&(l.open=l.articles,l.doaj=!0,l.oa=!0),(i=await this.permissions.journals.example(t))&&(null==e&&(e=await this.src.oadoi(i,1)),null!=e?(delete l.oa,l.open=l.articles,l.oadoi=!0,l.oa=(null!=e&&null!=(a=e.best_oa_location)?a.license:void 0)&&e.best_oa_location.license.includes("cc")):l.oa=!1)),l},e.permissions.journals.oa.type=async function(t,e,i,r){var s,n,a,l,o,u,c,h,p,d;return null==t&&(t=null!=(n=null!=(a=null!=(l=null!=(o=null!=(u=null!=(c=null!=i?i.journal_issns:void 0)?c:null!=r?r.ISSN:void 0)?u:this.params.journals)?o:this.params.journal)?l:this.params.type)?a:this.params.issn)?n:this.params.issns),"string"==typeof t&&(t.includes("doi.org/")&&(t=t.split("doi.org/")[1]),t.startsWith("10.")&&(null==i&&(i=await this.src.oadoi(t)),null==r&&(r=await this.src.crossref.works(t)),t=null!=(h=null!=i?i.journal_issns:void 0)?h:null!=r?r.ISSN:void 0)),"string"==typeof t&&(t=t.split(",")),s="unknown",null!=(null!=r?r.type:void 0)&&"journal-article"!==r.type?s="not applicable":(null!=r?r.type:void 0)&&"journal-article"!==r.type||(s="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==e&&t&&(e=await this.src.doaj.journals('bibjson.eissn.keyword:"'+t.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+t.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=e?s=!1===(null!=(p=e.bibjson)&&null!=(d=p.apc)?d.has_apc:void 0)?"diamond":"gold":t&&(t&&await this.permissions.journals.transformative.count('issn:"'+t.join('" OR issn:"')+'"')?s="transformative":"closed"===s&&await this.src.oadoi.hybrid(t)&&(s="hybrid"))),s},e.permissions.publishers.oa=async function(t){var e,i,r,s;return s={publisher:(null!=(r=null!=t?t:this.params.publisher)?r:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+s.publisher+'"',1)||((e=await this.src.crossref.journals('publisher:"'+s.publisher.split(" ").join('" AND publisher:"')+'"',1))?e.publisher.toLowerCase()!==s.publisher.toLowerCase()&&((i=await this.levenshtein(e.publisher,s.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(s.publisher=e.publisher):s.journals=0),null==s.journals&&(s.journals=await this.src.crossref.journals.count('publisher:"'+s.publisher+'" AND NOT discontinued:true')),s.open=await this.src.doaj.journals.count('publisher:"'+s.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT .bibjson.is_replaced_by:*'),s.percent=s.journals?Math.ceil(s.open/s.journals*100):s.open?100:0,s.oa=!s.journals&&s.open||s.journals&&s.journals===s.open,s},g=[].indexOf;try{r.report=JSON.parse(SECRETS_REPORT)}catch(t){}null==r.report&&(r.report={}),e.report=function(){return"OA.Works report"},e.report.dev2live=async function(t){var e,i,r,s,n;for await(s of(t?(r="paradigm_report_works",n="paradigm_b_report_works"):(r="paradigm_b_report_works",n="paradigm_report_works"),this.params.clear&&await this.index._send(n,"",void 0,!1),i=0,e=[],this.index._for(r)))i+=1,!s.DOI||s.DOI.includes(" pmcid:")||s.DOI.includes("\n")||s.DOI.includes("?ref")||e.push(s),3e4===e.length&&(y.log("report works",t?"live2dev":"dev2live",r,n,i),await this.index._bulk(n,e,void 0,void 0,!1),e=[]);return e.length&&(await this.index._bulk(n,e,void 0,void 0,!1),e=[]),i},e.report.dev2live._async=!0,e.report.dev2live._bg=!0,e.report.dev2live._auth="root",e.report.live2dev=function(){return this.report.dev2live(!0)},e.report.live2dev._async=!0,e.report.live2dev._bg=!0,e.report.live2dev._auth="root",e.report.oapolicy={_sheet:r.report.oapolicy_sheet,_format:function(t=[]){var e,i,r,s,n,a,l,o;for(a=[],r=0,s=(o="object"!=typeof t||Array.isArray(t)?t:[t]).length;r<s;r++){for(i in n={},l=o[r]){if("string"==typeof l[i])if(l[i]=l[i].trim(),"true"===l[i].toLowerCase())l[i]=!0;else if("false"===l[i].toLowerCase())l[i]=!1;else if(l[i].startsWith("[")&&l[i].endsWith("]")||l[i].startsWith("{")&&l[i].endsWith("}"))try{l[i]=JSON.parse(l[i])}catch(t){e=t,y.log("cant parse "+i,l[i],e)}else l[i].includes(";")&&(l[i]=l[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=l[i]&&""!==l[i])if(i.includes("."))try{this.dot(n,i,l[i])}catch(t){}else n[i]=l[i]}"{}"!==JSON.stringify(n)&&a.push(n)}return 1===a.length?a[0]:a}},e.report.cleandoi=function(t){var e;null==t&&(t=null!=(e=this.params.cleandoi)?e:this.params.doi);try{t.startsWith("http")&&(t="10."+t.split("/10.")[1])}catch(t){}try{t.startsWith("doi ")&&(t=t.toLowerCase().replace("doi ",""))}catch(t){}try{t=t.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(t){}return"string"==typeof t&&t.startsWith("10.")?t:""},e.report.orgs={_sheet:r.report.orgs_sheet,_format:async function(t=[]){var e,i,r,s,n,a,l,o,u,c,h,p;for(o=[],r=0,n=(c="object"!=typeof t||Array.isArray(t)?t:[t]).length;r<n;r++){for(i in l={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(t){e=t,y.log("cant parse "+i,u[i],e)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(l,i,u[i])}catch(t){}else l[i]=u[i]}if(Array.isArray(l.sheets))for(s=0,a=(h=l.sheets).length;s<a;s++)(p=h[s]).url=await this.encrypt(p.url);else delete l.sheets;"{}"!==JSON.stringify(l)&&o.push(l)}return 1===o.length?o[0]:o}},e.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},e.report.orgs.key=async function(t){var e,i;if(null==t&&(t=this.params.org),null!=t){if(t=t.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+t+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(t){}}else{i={org:t,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(t){}}return e=await this.uid(),i.key=await this.encrypt(e),await this.report.orgs.orgkeys(i),e}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(t){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},e.report.orgs.key._auth="@oa.works",e.report.orgs.supplements={_index:!0,_auth:"@oa.works"},e.report.orgs.supplements.load=async function(t,e,i){var s,n,a,l,o,u,c,h,p,d,f,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt,gt;if(pt=await this.epoch(),null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==t&&(t=this.params.org),null==e&&(e=this.params.sheet),W=await this.src.google.sheets(r.report.orgs_sheet),yt=0,a=[],l=[],nt={},ht=[],ct=[],!i)for await(dt of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","replaced:*"))nt[dt.replaced]=dt.DOI;for(p=0,_=(B="object"!=typeof W||Array.isArray(W)?W:[W]).length;p<_;p++){for(o in D={},U=B[p]){if("string"==typeof U[o])if(U[o]=U[o].trim(),"true"===U[o].toLowerCase())U[o]=!0;else if("false"===U[o].toLowerCase())U[o]=!1;else if(U[o].startsWith("[")&&U[o].endsWith("]")||U[o].startsWith("{")&&U[o].endsWith("}"))try{U[o]=JSON.parse(U[o])}catch(t){}else U[o].includes(";")&&(U[o]=U[o].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(o.includes("."))try{this.dot(D,o,U[o])}catch(t){}else D[o]=U[o]}if(Array.isArray(D.sheets))for(m=0,x=(H=D.sheets).length;m<x;m++)if(ut=H[m],!(t&&D.name!==t||e&&ut.name!==e)){y.log(D.name,ut.name,ut.url),q=0,C=[],c=[],gt=!0,ft=[],await this.sleep(1e3);try{n=await this.src.google.sheets({sheetid:ut.url,sheet:"m_admin",headers:!1}),await this.sleep(1e3),Array.isArray(n)&&n.length&&"last updated"===n[0][0].toLowerCase()&&(v=n[0][1])&&([w,A]=v.split(" "),w=w.split("/").reverse().join("-"),v=await this.epoch(w+"T"+A),y.log(D.name,ut.name,"last updated",v),"number"==typeof v&&v>16725312e5&&(null!=(null!=(K=(b=await this.report.orgs.supplements('sheets.keyword:"'+ut.name+'"',{size:1,sort:{updated:"desc"}})).hits)?K.hits:void 0)&&(b=b.hits.hits[0]._source),(null!=b?b.updated:void 0)&&v<=b.updated&&(gt=v)))}catch(t){}if(!0!==gt)y.log(D.name,ut.name,"NOT loading because",v,"is not after",null!=b?b.updated:void 0);else{await this.sleep(1e3);try{lt=await this.src.google.sheets({sheetid:ut.url,sheet:"Export",headers:!1})}catch(t){}for(mt=0;(!Array.isArray(lt)||!lt.length)&&mt<3;){await this.sleep(2e3),mt+=1;try{lt=await this.src.google.sheets({sheetid:ut.url,sheet:"Export",headers:!1})}catch(t){}}if(Array.isArray(lt)&&lt.length){for(I=0,O=(Q=lt.shift()).length;I<O;I++)u=Q[I],c.push(u.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(E=0,S=lt.length;E<S;E++){for(h in at=lt[E],q+=1,ot={org:D.name,sheets:ut.name,ror:D.ror,paid:!0===D.paid?D.paid:void 0},c)if("doi"===(o=c[h])||"DOI"===o)ot[o]=at[h];else if("apc_cost"===o)try{ot.apc_cost=parseInt(at[h])}catch(t){}else o.includes(".")?await this.dot(ot,o,at[h]?"true"===(tt=at[h].trim().toLowerCase())||"yes"===tt||"false"!==(et=at[h].trim().toLowerCase())&&"no"!==et&&("grant_id"===(it=o.toLowerCase())||"ror"===it?at[h].replace(/\//g,",").replace(/ /g,"").split(","):"string"==typeof at[h]&&at[h].includes(";")?at[h].split(";"):at[h]):void 0):(ot[o]=at[h]?"true"===(rt=at[h].trim().toLowerCase())||"yes"===rt||"false"!==(st=at[h].trim().toLowerCase())&&"no"!==st&&("grant_id"===(M=o.toLowerCase())||"ror"===M?at[h].replace(/\//g,",").replace(/ /g,"").split(","):at[h]):void 0,"string"==typeof ot[o]&&ot[o].includes(";")&&(ot[o]=ot[o].split(";")));if(ot.doi?null==ot.DOI&&(ot.DOI=ot.doi+""):ot.doi=(null!=(z=ot.DOI)?z:"")+"",ot.DOI=await this.report.cleandoi(ot.DOI)){if(i||null==nt[ot.DOI]||(ot.replaced=ot.DOI,ot.DOI=nt[ot.DOI]),"string"==typeof ot.email&&ot.email.includes("@")&&(ot.email=await this.encrypt(ot.email)),ot._id=ot.osdid=(D.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+ut.name+"_"+ot.DOI).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),C.push(ot.osdid),F=ot.DOI,g.call(l,F)<0){if(f=!1,!i){null!=(null!=(T=await this.report.works('supplements.osdid.keyword:"'+ot.osdid+'"',1))&&null!=(J=T.hits)?J.hits:void 0)&&T.hits.hits.length&&(T=T.hits.hits[0]._source);try{for($=T.supplements,L=0,k=$.length;L<k;L++)if((P=$[L]).osdid===ot.osdid){T=P;break}}catch(t){}if(null!=T)for(d in delete(f=await this.copy(ot)).updated,T){if("updated"!==d&&JSON.stringify(null!=(V=ot[d])?V:"").toLowerCase()!==JSON.stringify(T[d]).toLowerCase())break;delete f[d]}}(i||"{}"!==JSON.stringify(f))&&l.push(ot.DOI)}ot.updated=pt,ft.push(ot),yt+=1}}y.log(D.name,ut.name,ft.length,l.length),await this.report.orgs.supplements(ft)}for await(dt of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+D.name+'" AND sheets.keyword:"'+ut.name+'"',{scroll:"5m",include:["osdid"]}))G=dt.osdid,g.call(C,G)<0&&(await this.report.orgs.supplements(dt.osdid,""),a.push(dt.osdid),X=dt.DOI,g.call(l,X)<0&&l.push(dt.DOI))}ht.push({org:D.name,sheet:ut.name,rows:q,update:gt,supplements:ft.length}),ct.push(ut.name)}}if(!i&&!t&&!e)for(R=0,j=(Y=await this.report.works.suggest("supplements.sheets",void 0,5e3)).length;R<j;R++)if(s=Y[R],g.call(ct,s)<0){for await(dt of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'sheets.keyword:"'+s+'"',{scroll:"5m",include:["osdid"]}))await this.report.orgs.supplements(dt.osdid,""),a.push(dt.osdid);for await(N of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",'supplements.sheets.keyword:"'+s+'"',{scroll:"5m",include:["DOI"]}))N.DOI&&(Z=N.DOI,g.call(l,Z)<0)&&l.push(N.DOI)}return await this.sleep(6e4),y.log("report orgs supplements load",yt,l.length,a.length,await this.epoch()-pt),l.length&&(y.log("reoprt orgs supplements load ready to call works load",l.length),await this.report.works.load(void 0,void 0,l,void 0,void 0,pt,void 0,ht)),yt},e.report.orgs.supplements.load._async=!0,e.report.orgs.supplements.load._auth="@oa.works",e.report.emails={_sheet:r.report.emails_sheet,_key:"doi",_auth:"@oa.works"},e.report.email=async function(t){var e,i,r,s,n,a,l,o,u,c;if((t||this.params.orgkey)&&(null==t&&(t=null!=(n=this.params.email)?n:this.params.doi),null!=t&&(null!=(s=await this.report.works(t))?s.email:void 0))){if(s.email.includes("@"))return s.email;if(c=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(r=await this.report.orgs.orgkeys('key.keyword:"'+c+'"',1))?r.org:void 0)&&r.org.length){for(o=[],e=0,i=(a=s.orgs).length;e<i;e++)u=a[e],o.push(u.toLowerCase());if(l=r.org,g.call(o,l)>=0)return this.decrypt(s.email)}}},e.report.works={_index:!0},e.report.works.process=async function(t,e,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt,gt,vt,bt,wt,_t,xt,Ot,St,kt,jt,At,It,Et,Dt,Ct,Nt,Lt,Tt,Pt,Rt,qt,Ut,Wt,Bt,Mt,zt,Ft,Jt,$t,Vt,Gt,Xt,Yt,Ht,Zt,Kt,Qt,te,ee,ie,re,se,ne,ae,le,oe,ue,ce;if(ee=await this.epoch(),null==t&&(t=this.params.process),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),"string"==typeof e&&((e=(e=e.split(e.includes("doi.org")?"doi.org/":"/").pop()).replace(/\/$/,"")).startsWith("10.")&&(e=e.toLowerCase(),null==t&&(t=e)),(e.startsWith("W")||e.startsWith("10."))&&(e.startsWith("10.")&&!0!==i&&(!(null!=(m=await this.report.works({_id:e}))?m.updated:void 0)||i&&m&&m.updated<i)&&(m=void 0),!e.startsWith("W")&&(null!=m?m.openalex:void 0)||(null!=(z=await this.src.openalex.works({_id:e}))?z.id:void 0)&&(e=z))),"string"!=typeof e||e.startsWith("W")||e.startsWith("10.")||(e=void 0),null==t&&"object"==typeof e&&(null!=e&&null!=(tt=e.ids)?tt.doi:void 0)&&(t=e.ids.doi),"string"==typeof t&&t.includes("doi.org/")&&(t=t.split("doi.org/").pop()),"string"!=typeof t||t.startsWith("10.")||(t=void 0),"string"==typeof t&&(t=t.toLowerCase()),null==m&&"string"==typeof t&&(oe=await this.src.crossref.works({_id:t}))&&(t=oe),"object"!=typeof t||t.DOI||(t=void 0),null!=t&&!0!==i&&(null==m&&(m=await this.report.works("string"==typeof t?t:t.DOI)),(!(null!=m?m.updated:void 0)||i&&m&&m.updated<i)&&(m=void 0)),null==t||(null!=m?m.openalex:void 0)||null==e&&(e=await this.src.openalex.works({_id:"object"==typeof t?t.DOI:t})),"string"!=typeof e&&(null!=e?e.id:void 0)||(e=void 0),"object"==typeof t&&t.DOI){for(Q={DOI:t.DOI.toLowerCase(),subject:t.subject,subtitle:t.subtitle,volume:t.volume,published_year:t.year,issue:t.issue,publisher:t.publisher,published_date:t.published,funder:t.funder,issn:t.ISSN,subtype:t.subtype},v=0,x=(ct=null!=(et=t.assertion)?et:[]).length;v<x;v++)(o=(null!=(_t=(l=ct[v]).label)?_t:"").toLowerCase()).includes("accepted")&&o.split(" ").length<3&&(null!=(a=await this.dateparts(l.value))?a.date:void 0)&&null==Q.accepted_date&&(Q.accepted_date=a.date),o.includes("received")&&(null!=(te=await this.dateparts(l.value))?te.date:void 0)&&null==Q.submitted_date&&(Q.submitted_date=te.date);for(w=0,O=(zt=null!=(Ct=Q.funder)?Ct:[]).length;w<O;w++)delete zt[w]["doi-asserted-by"];for(t.title&&t.title.length&&(Q.title=t.title[0]),t["container-title"]&&t["container-title"].length&&(Q.journal=t["container-title"][0]),null!=t["reference-count"]&&(Q["reference-count"]=t["reference-count"]),q=0,A=(Xt=null!=(Gt=t.license)?Gt:[]).length;q<A;q++)"am"!==(Yt=(_=Xt[q])["content-version"])&&"vor"!==Yt&&"tdm"!==Yt&&"unspecified"!==Yt||(Q["crossref_license_url_"+_["content-version"]]=_.URL);for(Q.crossref_is_oa=null!=t.is_oa&&t.is_oa,p=[],n=async(e,i)=>(e.DOI=t.DOI,e.replaced=i,await this.report.orgs.supplements(e.osdid,""),e._id=e.osdid=e.osdid.split("_10.")[0]+"_"+e.DOI.replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),p.push(e)),U=0,I=(it=null!=(Ht=t["update-to"])?Ht:[]).length;U<I;U++)if((se=it[U]).DOI!==t.DOI&&"erratum"!==(rt=se.type.toLowerCase())&&"correction"!==rt)for await(ie of(Q.replaces=[],Q.replaces.push({DOI:se.DOI,type:se.type,updated:null!=(st=se.updated)?st.timestamp:void 0}),await this.report.works(se.DOI)&&await this.report.works(se.DOI,""),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+se.DOI+'"')))n(ie,se.DOI);for(F=0,E=(lt=null!=(nt=null!=(at=t.relation)?at["is-same-as"]:void 0)?nt:[]).length;F<E;F++)if("doi"===(Kt=lt[F])["id-type"]&&Kt.id!==t.DOI&&Kt.id!==s&&(W=await this.src.crossref.works(Kt.id)))for await(ie of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+t.DOI+'"'))n(ie,Kt.id);if(p.length&&await this.report.orgs.supplements(p),null!=W)return this.report.works.process(W,e,i,r,t.DOI);s&&(null==Q.replaces&&(Q.replaces=[]),Q.replaces.push({DOI:s,type:"relation.is-same-as"}))}if(null!=e){for(null==Q&&(Q={}),e.id&&(Q.openalex=e.id.split("/").pop()),Q.DOI||null==(null!=(ot=e.ids)?ot.doi:void 0)||(Q.DOI=e.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(ut=e.ids)?ut.pmid:void 0)&&(Q.PMID=e.ids.pmid.split("/").pop()),!Q.PMCID&&(null!=(ht=e.ids)?ht.pmcid:void 0)&&(Q.PMCID="PMC"+e.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),e.title&&(Q.title=e.title),H=0,D=(pt=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;H<D;H++)Q[M=pt[H]]=e[M];for(e.publication_date&&(Q.published_date=e.publication_date),e.publication_year&&(Q.published_year=e.publication_year),(null!=(dt=e.host_venue)?dt.issn:void 0)&&e.host_venue.issn.length&&(Q.issn=e.host_venue.issn),e.biblio&&(Q.biblio=e.biblio),e.referenced_works&&(Q.referenced_works=e.referenced_works.length),Z=0,C=(yt=null!=(ft=Q.concepts)?ft:[]).length;Z<C;Z++){delete(d=yt[Z]).wikidata;try{d.score=Math.floor(100*d.score)}catch(t){}}for(re=0,N=(gt=null!=(mt=Q.authorships)?mt:[]).length;re<N;re++)for(ne=0,L=(bt=null!=(vt=gt[re].institutions)?vt:[]).length;ne<L;ne++)delete bt[ne].type}if(null==Q&&(Q={}),Q.DOI||"string"!=typeof t||(Q.DOI=t.toLowerCase()),!Q.is_paratext&&!Q.is_retracted){if(delete Q.is_paratext,delete Q.is_retracted,!(null!=m?m.oadoi:void 0)&&Q.DOI){for(Q.oadoi=!0,ae=0,T=(Ot=null!=(xt=null!=(B=await this.src.oadoi(Q.DOI))?B.oa_locations:void 0)?xt:[]).length;ae<T;ae++)if("publisher"===(R=Ot[ae]).host_type&&(null==Q.publisher_license&&(Q.publisher_license=R.license),null==Q.publisher_url_for_pdf&&(Q.publisher_url_for_pdf=R.url_for_pdf),null==Q.publisher_version&&(Q.publisher_version=R.version)),"repository"===R.host_type&&(R.url&&R.url.toLowerCase().includes("pmc")&&(Q.PMCID||(V=R.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0]).length&&V.replace(/[^0-9]/g,"").length===V.length&&!isNaN(parseInt(V))&&(Q.PMCID="PMC"+V),R.license&&!Q.epmc_licence&&(Q.epmc_licence=R.license)),!Q.repository_url||!Q.repository_url.includes("pmc")))for(le=0,S=(St=["license","url_for_pdf","url","version"]).length;le<S;le++)R[M=St[le]]&&(Q["repository_"+M]=R[M]);Q.repository_url&&Q.repository_url.toLowerCase().includes("pmc")&&(null==Q.PMCID&&(Q.PMCID="PMC"+Q.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0]),Q.repository_url_in_pmc=!0),null!=B&&(Q.best_oa_location_url=null!=(kt=B.best_oa_location)?kt.url:void 0,Q.best_oa_location_url_for_pdf=null!=(jt=B.best_oa_location)?jt.url_for_pdf:void 0,Q.oa_status=B.oa_status,Q.has_repository_copy=B.has_repository_copy,Q.has_oa_locations_embargoed=!(null==B.oa_locations_embargoed||!B.oa_locations_embargoed.length),Q.title=B.title,!Q.issn&&"string"==typeof B.journal_issns&&B.journal_issns.length&&(Q.issn=B.journal_issns.split(",")),null==Q.journal&&(Q.journal=B.journal_name),null==Q.publisher&&(Q.publisher=B.publisher),B.published_date&&(Q.published_date=B.published_date),B.year&&(Q.published_year=B.year),null!=B.is_oa&&(Q.oadoi_is_oa=B.is_oa))}if(Q.supplements=[],Q.orgs=[],Q.DOI)for await(ie of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+Q.DOI+'"',{sort:{"osdid.keyword":"asc"}}))At=ie.org,g.call(Q.orgs,At)<0&&Q.orgs.push(ie.org),ie.paid&&(Q.paid=!0),!Q.email&&ie.email&&(Q.email=ie.email),ie.author_email_name_ic&&(Q.author_email_name=ie.author_email_name_ic),Q.supplements.push(ie);if(null!=m)for(b in!Q.author_email_name&&m.author_email_name&&m.email&&Q.email&&Q.email.toLowerCase()===m.email.toLowerCase()&&(Q.author_email_name=m.author_email_name),m)null==Q[b]&&(Q[b]=m[b]);if(null!=Q.authorships&&Q.email&&!Q.author_email_name&&(null==(null!=m?m.authorships:void 0)||!(null!=m?m.email:void 0)))if(f=Q.email.includes("@")?Q.email:await this.decrypt(Q.email),1===Q.authorships.length)Q.author_email_name="Dr. "+(null!=(It=Q.authorships[0].author)?It.display_name:void 0);else{for(Zt=f.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),u="",c="",h=1e6,ue=0,k=(Et=Q.authorships).length;ue<k;ue++)(K=null!=(Dt=Et[ue].author)?Dt.display_name:void 0)&&((Qt=(await this.levenshtein(Zt,K.toLowerCase().replace(/[^a-z]/g,""))).distance/K.length)<h&&(h=Qt,c=K),h>.2&&(Zt.endsWith(K.split(" ").pop().toLowerCase())||K.split(" ")[0].length>4&&Zt.includes(K.split(" ")[0].toLowerCase()))&&(h=.1,c=K),!u&&Zt.startsWith((K.split(" ")[0].slice(0,1)+K.split(" ").pop().slice(0,1)).toLowerCase())&&(u=K));c&&h<.7&&(Q.author_email_name="Dr. "+c.split(" ").pop()),!Q.author_email_name&&u&&(Q.author_email_name="Dr. "+u)}if("string"==typeof Q.email&&Q.email.includes("@")&&(Q.email=await this.encrypt(Q.email)),Q.orgs.length&&(null!=(Nt=null!=m?m.orgs:void 0)?Nt:[]).length!==Q.orgs.length&&(r=!0),Q.DOI&&(Q.PMCID&&Q.PMID&&Q.pubtype&&Q.submitted_date&&Q.accepted_date||(Y=Q.PMID?await this.src.pubmed(Q.PMID):await this.src.pubmed.doi(Q.DOI))&&(!Q.PMCID&&(null!=Y&&null!=(Lt=Y.identifier)?Lt.pmc:void 0)&&(Q.PMCID="PMC"+Y.identifier.pmc.toLowerCase().replace("pmc","")),!Q.PMID&&(null!=Y&&null!=(Tt=Y.identifier)?Tt.pubmed:void 0)&&(Q.PMID=Y.identifier.pubmed),Q.pubtype=Y.type,null==Q.submitted_date&&(Q.submitted_date=null!=(Pt=Y.dates)&&null!=(Rt=Pt.PubMedPubDate_received)?Rt.date:void 0),null==Q.accepted_date&&(Q.accepted_date=null!=(qt=Y.dates)&&null!=(Ut=qt.PubMedPubDate_accepted)?Ut.date:void 0)),Q.journal_oa_type||(J=await this.permissions(await this.copy(Q),void 0,void 0,B,t,ee-12096e5),Q.can_archive=null!=J&&null!=(Wt=J.best_permission)?Wt.can_archive:void 0,null==Q.can_archive&&((null!=(Bt=null!=B&&null!=(Mt=B.best_oa_location)?Mt.license:void 0)?Bt:"").includes("cc")||(null!=B?B.journal_is_in_doaj:void 0))&&(Q.can_archive=!0),Q.version=null!=J&&null!=(Ft=J.best_permission)?Ft.version:void 0,Q.journal_oa_type=await this.permissions.journals.oa.type(Q.issn,void 0,B,t),null==Q.journal_oa_type&&(Q.journal_oa_type="unsuccessful")),r&&!(Q.PMCID&&Q.pubtype&&Q.submitted_date&&Q.accepted_date)&&(y=await this.src.epmc.doi(Q.DOI))))for(y.pmcid&&(Q.PMCID=y.pmcid),null==Q.submitted_date&&(Q.submitted_date=y.firstIndexDate),null==Q.accepted_date&&(Q.accepted_date=y.firstPublicationDate),ce=0,j=($t=null!=(Jt=y.pubTypeList)?Jt:[]).length;ce<j;ce++)X=$t[ce],Q.pubtype=Array.isArray(Q.pubtype)?Q.pubtype:Q.pubtype?[Q.pubtype]:[],Vt=X.pubType,g.call(Q.pubtype,Vt)<0&&Q.pubtype.push(X.pubType);return r&&(Q.PMCID&&Q.repository_url_in_pmc&&!Q.epmc_licence&&(P=await this.src.epmc.licence(Q.PMCID,y),Q.epmc_licence=null!=P?P.licence:void 0),null==Q.pmc_has_data_availability_statement&&(Q.pmc_has_data_availability_statement=Q.PMCID&&await this.src.pubmed.availability(Q.PMCID)),!Q.data_availability_statement&&Q.PMCID&&(Q.data_availability_statement=await this.src.epmc.statement(Q.PMCID,y))),Q.is_oa=Q.oadoi_is_oa||Q.crossref_is_oa||"gold"===Q.journal_oa_type,null==Q._id&&(Q._id=Q.DOI?Q.DOI.toLowerCase().replace(/\//g,"_"):Q.openalex),Q.supplemented=await this.epoch(),null==Q.updated&&(Q.updated=Q.supplemented),Q.took=Q.supplemented-ee,Q.DOI&&this.params.process===Q.DOI&&!1!==this.params.save&&await this.report.works(Q),Q}if(Q.DOI)try{$=(Q.is_paratext?"paratext":"retracted")+(this.S.dev?"_dev":""),G=[];try{G=JSON.parse((await fs.readFile(this.S.static.folder+$+".json")).toString())}catch(t){}wt=Q.DOI,g.call(G,wt)<0&&G.push(Q.DOI),await fs.writeFile(this.S.static.folder+$+".json",JSON.stringify(G,"",2))}catch(t){}},e.report.works.load=async function(t,e,i,r,s,n,a,l){var o,u,c,h,p,d,f,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U;if(T=await this.epoch(),null==r&&(r=null!=(k=this.params.load)?k:(await this.date()).split("-")[0]),null==e&&(e=null!=(j=null!=(I=this.params.org)?I:this.params.orgs)?j:"orgs"===this.params.load),null==i&&null!=this.params.load&&this.params.load.startsWith("10.")&&(i=this.params.load),"string"==typeof i&&(i=[i]),null==s&&(s=this.refresh),null==a&&(a="everything"===this.params.load),s&&await this.report.works(""),h=[],p=0,U=0,d=[],S=[],o=async(e,r)=>{var n;if(p+=1,y.log(p,e,r),"string"==typeof e&&e.startsWith("W")&&!r&&(r=e,e=void 0),(null!=e||null!=r)&&(null!=(null!=(n=await this.report.works.process(e,r,null!=t?t:s,a))?n._id:void 0)?(h.push(n),U+=1):y.log("report works load finding empty works",e,r,n),h.length%200==0&&y.log("report load building batch",h.length),2e3===h.length))return await this.report.works(h),h=[],y.log("report works load",U,p,i?i.length:void 0,await this.epoch()-T)},"supplements"===this.params.load){for await(P of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",t?"updated:<"+t:void 0,{scroll:"5m",include:["DOI"]})))E=P.DOI,g.call(i,E)<0&&i.push(P.DOI);y.log("report works supplements to load",i.length)}else if(a){for await(P of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","NOT pmc_has_data_availability_statement:*",{scroll:"5m",include:["DOI","openalex"]})))L=null!=(D=P.DOI)?D:P.openalex,g.call(i,L)<0&&i.push(L);y.log("report works supplements to load everything for records that do not yet have everything",i.length)}if(Array.isArray(i))for(b=0,_=i.length;b<_;b++)m=i[b],await o(m);else{for await(O of(u=async e=>{var i,s,n,a,l;for await(i of(a=d.length,null==e&&(e="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+r),t&&(e="("+e+") AND srcday:>"+t),y.log("report works load crossref by query",e),d=[],this.index._for("src_crossref_works",e,{include:["DOI"],scroll:"30m"})))d.push(i.DOI);for(y.log("report works load crossref by query counted",d.length),await this.mail({to:["mark@oa.works"],subject:"report works load crossref by query counted "+d.length,text:d.length+"\n\n"+e}),s=0,n=(l=d.slice(a)).length;s<n;s++)m=l[s],await o(m);return await this.mail({to:["mark@oa.works"],subject:"report works load crossref done "+p,text:p+""})},!0!==e&&await u(),c=async e=>{var i,s,n,a,l,u,c,h;for await(a of(u=S.length,null==e&&(e="authorships.institutions.display_name:* AND publication_year:"+r),t&&(e="("+e+") AND updated_date:>"+t),y.log("report works load openalex by query",e),this.index._for("src_openalex_works",e,{include:["id","ids"],scroll:"30m"})))l=(null!=(c=a.ids)?c.doi:void 0)?"10."+a.ids.doi.split("/10.")[1]:void 0,a.id&&a.id.includes("/")&&(!l||g.call(S,l)<0&&g.call(d,l)<0)&&S.push(a.id.split("/").pop());for(y.log("report works load openalex by query counted",S.length),await this.mail({to:["mark@oa.works"],subject:"report works load crossref by query counted "+d.length,text:S.length+"\n\n"+e}),i=0,s=(h=S.slice(u)).length;i<s;i++)n=h[i],await o(void 0,n);return await this.mail({to:["mark@oa.works"],subject:"report works load openalex done "+p,text:p+""})},!0!==e&&await c(),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs","string"==typeof e?'name:"'+e+'"':"paid:true",{scroll:"10m"}))){try{(null!=(C=O.source)?C.crossref:void 0)&&await u(O.source.crossref)}catch(t){}try{(null!=(N=O.source)?N.openalex:void 0)&&await c(O.source.openalex)}catch(t){}}if(t)for await(f of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND updated:<"+t,{scroll:"10m"}))await this.src.crossref.works('DOI:"'+f.DOI+'" AND srcday:>'+t)&&await o(f)}for(h.length&&await this.report.works(h),q=await this.epoch()-T,R="Report works loaded "+U+(this.S.dev?" (dev)":"")+"\n",s&&(R+="All old works were removed before loading began\n"),i&&i.length&&(R+=i.length+" DOIs were provided to process\n"),"supplements"===this.params.load&&(R+="These were derived by searching for all works that already have supplements attached\n"),a&&(R+="These were derived by searching for all works that have not yet had everything fully processed\n"),n&&(R+="These were provided by an orgs supplements refresh which took "+Math.ceil((T-n)/1e3/60)+"m\n"),"string"==typeof e&&(R+="The load process was limited to "+e+"\n"),t&&(R+="The load process was run for changes since "+await this.datetime(t)+"\n"),r&&!(null!=i?i:[]).length&&(R+="The load process was run for year "+r+"\n"),d.length&&(R+="Crossref queries counted "+d.length+" works\n"),S.length&&(R+="Openalex queries counted "+S.length+" works\n"),R+="Load processing took "+Math.ceil(q/1e3/60)+"m\n",w=0,x=(A=null!=l?l:[]).length;w<x;w++)v=A[w],R+="\n"+JSON.stringify(v)+"\n";return y.log("Report works loaded",U,q),await this.mail({to:["mark@oa.works","joe@oa.works"],subject:"OA report works works loaded "+U,text:R}),U},e.report.works.load._async=!0,e.report.works.load._auth="@oa.works",e.report.works.changes=function(t,e){var i,r;return null==t&&(t=null!=(i=null!=(r=this.params.changes)?r:this.params.timestamp)?i:Date.now()-9e7),null==e&&(e=this.params.org),this.report.works.load(t,e),!0},e.report.works.changes._bg=!0,e.report.works.changes._auth="@oa.works",g=[].indexOf,null==e.svc&&(e.svc={}),e.svc.rscvd={_index:!0},e.svc.rscvd.form=async function(){var t,e,i,r,s,n,a,l;if(this.keys(this.params).length>1){delete(e=this.copy(this.params)).form,e.status="Awaiting verification";try{(a=await this.svc.rscvd.requestees('email:"'+e.email+'"'))&&((null!=a?a.verified:void 0)||"Approved"===(null!=a?a.verification:void 0)?(e.status="Verified",e.verified=!0):((null!=a?a.denied:void 0)||"Denied"===(null!=a?a.verification:void 0))&&(e.status="Denied",e.verified=!1))}catch(t){}if("Awaiting verification"===e.status)try{(null!=(t=await this.svc.rscvd('email:"'+e.email+'" AND verified:*'))&&null!=(i=t.hits)?i.hits:void 0)&&!0===t.hits.hits[0]._source.verified?(e.status="Verified",e.verified=!0):!1===t.hits.hits[0]._source.verified&&(e.status="Denied",e.verified=!1)}catch(t){}null==e.type&&(e.type="paper");try{e.createdAt=new Date}catch(t){}try{e.neededAt=await this.epoch(e["needed-by"])}catch(t){}e._id=await this.svc.rscvd(e);try{l="Hi "+e.name+",<br><br>We got your request:<br><br>Title: "+(null!=(r=null!=(s=e.atitle)?s:e.title)?r:"Unknown")+"\nReference (if provided): "+(null!=(n=e.reference)?n:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+e._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:e.email,subject:"RSCVD Request Receipt",text:l})}catch(t){}return e}},e.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},e.svc.rscvd.resolves=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d;for(null==t&&(t=this.params.resolves),null==e&&(e=this.params.resolver),t?a="object"==typeof t?t:await this.svc.rscvd(t):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+e+'" AND NOT unresolved:"'+e+'"'),p={},i=0,r=(c=null!=a?[a]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<r;i++)null!=(n=c[i])._source&&null==(a=n._source)._id&&(a._id=n._id),(s=this.copy(a)).title&&(s.journal=s.title),s.atitle&&(s.title=s.atitle),(null!=(d=await this.ill.subscription({subscription:e},s))?d.url:void 0)?(null==a.resolved&&(a.resolved=[]),a.resolved.push(e),null==a.resolves&&(a.resolves=[]),a.resolves.push({resolver:e,url:d.url,user:null!=(h=this.user)?h._id:void 0}),p[n._id]=!0):(null==a.unresolved&&(a.unresolved=[]),a.unresolved.push(e),p[n._id]=!1),this.svc.rscvd(a);return t&&p[t]?p[t]:p},e.svc.rscvd.cancel=async function(){var t;if(this.params.cancel)return(t=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(t),t},e.svc.rscvd.verify=async function(t,e=!0){var i,r;if(null==t&&(t=this.params.verify),t)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+t+'"'))&&null!=(r=i.hits)?r.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:t,createdAt:Date.now()}),e?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+t+'"',{action:"index"},(function(t){return t.status&&"Awaiting verification"!==t.status||(t.verified=e,e?(t.status="Verified",t.verified_by=this.user.email):(t.status="Denied",t.denied_by=this.user.email)),t})),!0},e.svc.rscvd.verify._auth=!0,e.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},e.svc.rscvd.deny._auth=!0,e.svc.rscvd.status=async function(){var t,e,i;if(this.params.status){[e,i]=this.params.status.split("/"),(t=await this.svc.rscvd(e)).status=i;try{"Done"===t.status?t.done_by=this.user.email:"In Progress"===t.status&&(t.progressed_by=this.user.email)}catch(t){}return this.svc.rscvd(t),t}},e.svc.rscvd.status._auth=!0,e.svc.rscvd.poll=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N;if(this.nolog=!0,null==t&&(t=null!=(w=this.params.poll)?w:Date.now()-18e4),"string"==typeof(e=null!=(_=this.params.which)?_:["new","verify","deny","cancel","status","overdue"])&&(e=e.split(",")),g.call(e,"overdue")>=0&&this.svc.rscvd.overdue(),E={new:[],verify:[],deny:[],cancel:[],status:{}},g.call(e,"new")>=0)for(a=0,c=(S=null!=(x=null!=(b=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+t,500))&&null!=(O=b.hits)?O.hits:void 0)?x:[]).length;a<c;a++)null==(i=(m=S[a])._source)._id&&(i._id=m._id),E.new.push(m._source);if(g.call(e,"verify")>=0)for(l=0,h=(k=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<h;l++)N=k[l]._source.parts.pop(),g.call(E.verify,N)<0&&E.verify.push(N);if(g.call(e,"deny")>=0)for(o=0,p=(j=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<p;o++)n=j[o]._source.parts.pop(),g.call(E.deny,n)<0&&E.deny.push(n);if(g.call(e,"cancel")>=0)for(u=0,d=(A=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<d;u++)s=A[u]._source.parts.pop(),g.call(E.cancel,s)<0&&E.cancel.push(s);if(g.call(e,"status")>=0)for(y=0,f=(I=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;y<f;y++)C=(D=I[y])._source.parts.pop(),null==(r=E.status)[v=D._source.parts.pop()]&&(r[v]=C);return E},e.svc.rscvd.overdue=async function(){var t,e,i,r,s,n,a,l,o,u,c;if(e=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(r=0,n=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;r<n;r++)null==(t=(l=c[r])._source)._id&&(t._id=l._id),u.push(l._source);for(s=0,a=u.length;s<a;s++)(o=u[s]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),e+=1;return e},g=[].indexOf,e.src.crossref=function(){return"Crossref API wrapper"},e.src.crossref.works={_index:{settings:{number_of_shards:9}}},e.src.crossref.works._key="DOI",e.src.crossref.works._prefix=!1,e.src.crossref.works.doi=async function(t,e){var i,r,s,n,a,l,o;if(null==t&&(t=this.params.doi),null==e&&(e=null!=(r=this.params.save)&&r),"string"==typeof t&&t.startsWith("10.")&&(0===t.indexOf("http")&&(t=t.split("//")[1]),0!==t.indexOf("10.")&&-1!==t.indexOf("/10.")&&(t="10."+t.split("/10.")[1]),null!=(null!=(o=await this.fetch("https://api.crossref.org/works/"+t,{headers:{"User-Agent":(null!=(s=this.S.name)?s:"OA.Works")+"; mailto:"+(null!=(n=null!=(a=this.S.mail)?a.to:void 0)?n:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(l=o.message)?l.DOI:void 0)))return i=await this.src.crossref.works._format(o.message),e&&await this.src.crossref.works(i),i},e.src.crossref.works.title=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v;if(null==t&&(t=null!=(o=this.params.title)?o:this.params.q),a='title:"'+t+'"',t.split(" ").length>2){for(a+=" OR (",e=0,i=(u=t.split(" ")).length;e<i;e++)v=u[e],a.endsWith("(")||(a+=" AND "),a+='(title:"'+v+'" OR subtitle:"'+v+'")';a+=")"}for(d=await this.src.crossref.works(a),s=t.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),n=0,r=(p=null!=(c=null!=d&&null!=(h=d.hits)?h.hits:void 0)?c:[]).length;n<r;n++)(l=p[n])._source.DOI&&l._source.title&&l._source.title.length&&(y=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(m=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&m.length&&g.call(y,m)<0&&(y+=" "+m),y=y.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(y)||-1!==y.indexOf(s))&&s.length/y.length>.7&&s.length/y.length<1.3&&("journal-article"===l._source.type||null==f||"journal-article"!==f.type&&"journal-article"===l._source.type)&&(f=l._source));return f},e.src.crossref.works._format=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m;for(t.abstract&&(t.abstract=t.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==t._id&&(t._id=t.DOI.replace(/\//g,"_")),r=0,n=(h=null!=(c=t.assertion)?c:[]).length;r<n;r++)"OPEN ACCESS"===(e=h[r]).label&&(e.URL&&-1!==e.URL.indexOf("creativecommons")&&(null==t.license&&(t.license=[]),t.license.push({URL:e.URL})),t.is_oa=!0);for(o=0,a=(d=null!=(p=t.license)?p:[]).length;o<a;o++)if((s=d[o]).URL&&-1!==s.URL.indexOf("creativecommons")&&(!t.licence||-1===t.licence.indexOf("creativecommons"))){t.licence=s.URL;try{t.licence="cc-"+t.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(t){}t.is_oa=!0}try{t.reference&&t.reference.length>100&&(t.reference_original_length=t.reference.length,t.reference=t.reference.slice(0,100))}catch(t){}try{t.relation&&t.relation.length>100&&(t.relation_original_length=t.relation.length,t.relation=t.relation.slice(0,100))}catch(t){}for(u=0,l=(y=null!=(f=t.author)?f:[]).length;u<l;u++)(i=y[u]).name=(i.given?i.given+" ":"")+(null!=(m=i.family)?m:"");if(t.published=await this.src.crossref.works.published(t)){try{t.year=t.published.split("-")[0]}catch(t){}try{parseInt(t.year)}catch(t){}try{t.publishedAt=await this.epoch(t.published)}catch(t){}}return t},e.src.crossref.works.published=async function(t){var e,i,r,s,n,a,l,o,u;if(null==t&&(t=this.params.published),"string"==typeof t&&(t=await this.src.crossref.works(t)),null!=t){for(n=void 0,s=void 0,e=0,i=(l=["published","published-print","published-online","issued","deposited"]).length;e<i;e++)"object"==typeof t[r=l[e]]&&(a=void 0,"string"==typeof t[r]["date-time"]&&3===t[r]["date-time"].split("T")[0].split("-").length?a=t[r]["date-time"].split("T")[0]:Array.isArray(t[r]["date-parts"])&&t[r]["date-parts"].length&&Array.isArray(t[r]["date-parts"][0])&&("string"!=(o=typeof(u=t[r]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(a=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),a&&(!s||n>await this.epoch(a))&&(s=a,n=await this.epoch(s)));return s}},e.src.crossref.works.search=async function(t,e,i,r,s,n,a,l){var o,u,c,h,p,d,f,y,m,g,v;if(null==t&&(t=null!=(p=this.params.q)?p:this.params.search),null==e&&(e=this.params.from),null==i&&(i=this.params.size),null==r&&(r=this.params.filter),null==s&&(s=this.params.start),null==n&&(n=this.params.end),null==a&&(a=this.params.sort),null==l&&(l=null!=(d=this.params.order)?d:"asc"),o="",s&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof s&&-1!==s.indexOf("-")||(s=await this.date(s)),o="from-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+s),n&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof n&&-1!==n.indexOf("-")||(n=await this.date(n)),o+=(o?",":"")+"until-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+n),o&&(r=o),v="https://api.crossref.org/works?",null!=a&&(v+="sort="+a+"&order="+l+"&"),"object"==typeof t)for(c in t)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(v+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(t[c])+"&");else t&&"all"!==t&&(h=(h=t.replace(/\w+?\:/g,"")).replace(/ /g,"+"),v+="query="+encodeURIComponent(h)+"&");if(null!=e){if("*"!==e&&"string"==typeof e&&!e.replace(/[0-9]/g,"").length)try{u=parseInt(e),isNaN(u)||(e=u)}catch(t){}v+="number"!=typeof e?"cursor="+encodeURIComponent(e)+"&":"offset="+e+"&"}null!=i&&(v+="rows="+i+"&"),r&&(v+="filter="+encodeURIComponent(r)+"&"),v=v.replace("?&","?").replace(/&$/,"");try{return{total:(g=await this.fetch(v,{headers:{"User-Agent":(null!=(f=this.S.name)?f:"OA.Works")+"; mailto:"+(null!=(y=null!=(m=this.S.mail)?m.to:void 0)?y:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:g.message["next-cursor"],data:g.message.items,facets:g.message.facets}}catch(t){}},e.src.crossref.journals={_index:!0,_prefix:!1},e.src.crossref.journals.load=async function(){var t,e,i,r,s,n,a,l,o,u,c,h,p,d,f,m,v,b,w,_,x,O,S,k,j,A,I,E;for(await this.src.crossref.journals(""),e=0,A=0,t=[],i="*";i&&(0===e||e<A);){for(I="https://api.crossref.org/journals?cursor="+i+"&rows=1000",k=await this.fetch(I,{headers:{"User-Agent":(null!=(h=this.S.name)?h:"OA.Works")+"; mailto:"+(null!=(p=null!=(m=this.S.mail)?m.to:void 0)?p:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===A&&(A=k.message["total-results"]),i=k.message["next-cursor"],s=0,n=(v=k.message.items).length;s<n;s++){for(null==(c=v[s]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,a=(b=c.ISSN).length;o<a;o++)"string"==typeof(r=b[o])&&r.length&&g.call(c.issn,r)<0&&c.issn.push(r);if(c.dois=null!=(w=c.counts)?w["total-dois"]:void 0,null!=(null!=(_=c.breakdowns)?_["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,l=(x=c.breakdowns["dois-by-issued-year"]).length;u<l;u++)2===(E=x[u]).length&&(O=E[0],g.call(c.years,O)<0)&&c.years.push(E[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(j=(new Date).getFullYear(),g.call(c.years,j)<0&&(S=j-1,g.call(c.years,S)<0)&&(d=j-2,g.call(c.years,d)<0)&&(f=j-3,g.call(c.years,f)<0)&&(c.discontinued=!0)):c.discontinued=!0,t.push(c)}e+=1e3,t.length>=1e4&&(await this.src.crossref.journals(t),t=[])}return t.length&&(await this.src.crossref.journals(t),t=[]),y.log(e),e},e.src.crossref.journals.load._bg=!0,e.src.crossref.journals.load._async=!0,e.src.crossref.journals.load._auth="root",e.src.crossref.load=async function(){var t,e,i,r,s,n,a,l,o,u,c,h,p;i=null!=(c=this.params.howmany)?c:-1,r=this.S.directory+"/crossref/data/",n=this.S.directory+"/crossref/last",e=0;try{this.refresh||(e=parseInt((await fs.readFile(n)).toString()))}catch(t){}for(p=0,t=[];e>=0&&-1!==e&&e<26810;){if(g.call([],e)<0){if(p===i)break;for await(l of(y.log("Crossref load starting file",e),o="",readline.createInterface({input:fs.createReadStream(r+e+".json.gz").pipe(zlib.createGunzip())})))o+=l;for(s=0,a=(h=JSON.parse(o).items).length;s<a&&(u=h[s],p!==i);s++)p+=1,(u=await this.src.crossref.works._format(u)).srcfile=e,t.push(u),1e4===t.length&&(y.log("Crossref load "+e,p),await this.src.crossref.works(t),await fs.writeFile(n,e),t=[])}e+=1}return t.length&&await this.src.crossref.works(t),y.log(p),p},e.src.crossref.load._bg=!0,e.src.crossref.load._async=!0,e.src.crossref.load._auth="root",e.src.crossref.changes=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d,f,m,g;if(null==t&&(t=this.params.changes),"string"==typeof t&&(t.includes("/")||t.includes("-"))&&(t=await this.epoch(t)),!t)try{t=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday}catch(t){}for(null==t&&(t=16071264e5),null==e&&(e=this.params.end),"string"==typeof e&&(e.includes("/")||e.includes("-"))&&(e=await this.epoch(e)),null==i&&(i=this.params.created),a=null!=e?e:Date.now(),h=0,n=0,r=[];t<a;){for(y.log("Crossref changes",i?"for created":void 0,t,n),s="*",n+=1,g=!1,o=0;!1===g||o<g;)if(await this.sleep(500),null!=(m=await this.src.crossref.works.search(void 0,s,1e3,"indexed",t,t))?m.data:void 0){for(u=0,c=(d=m.data).length;u<c;u++)p=d[u],(l=await this.src.crossref.works._format(p)).srcday=t,r.push(l),h+=1;r.length>=1e4&&(y.log("Crossref bulk load",i?"for created":void 0,t,n,g,o,h),await this.src.crossref.works(r),r=[]),!1===g&&(g=null!=(f=m.total)?f:0,y.log(t,g)),o+=1e3,s=m.cursor}else y.log("crossref error"),await this.sleep(2e3);t+=864e5}return r.length&&await this.src.crossref.works(r),y.log(h,n,i?"for created":void 0),h},e.src.crossref.changes._bg=!0,e.src.crossref.changes._async=!0,e.src.crossref.changes._auth="root",e.src.crossref.changes._notify=!1,null==(o=r.src).doaj&&(o.doaj={});try{r.src.doaj.secrets=JSON.parse(SECRETS_DOAJ)}catch(t){}e.src.doaj={},e.src.doaj.journals={_index:!0,_prefix:!1},e.src.doaj.journals.load=async function(){var t,e,i,s,n,a,l,o;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal?api_key="+r.src.doaj.secrets.apikey,{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),t=!1,s=0,a=(l=await fs.readdir(i)).length;s<a;s++)(e=l[s]).includes("doaj_journal_data")&&(t=e);return o=0,t&&(o=(n=JSON.parse(await fs.readFile(i+t+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(n),await fs.unlink(i+t+"/journal_batch_1.json")),await fs.rmdir(i+t),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),o},e.src.doaj.journals.load._bg=!0,e.src.doaj.journals.load._async=!0,e.src.doaj.journals.load._auth="root",e.src.epmc={_index:!0,_prefix:!1,_key:"id"},e.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},e.src.epmc.search=async function(t,e,i){var r,s,n,a,l,o,u,c;return null==t&&(t=null!=(r=null!=(s=null!=(n=this.params.search)?n:this.params.epmc)?s:this.params.doi)?r:""),t.startsWith("10.")&&!t.includes(" ")&&t.split("/").length>=2&&(t="DOI:"+t),"string"!=typeof t||t.startsWith("PMCID:")||!t.toLowerCase().startsWith("pmc")||t.includes(" ")||(t="PMCID:PMC"+t.toLowerCase().replace("pmc","")),"number"==typeof t&&(t="PMCID:PMC"+t),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+t+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=e&&(c+="&cursorMark="+e),u={},await this.sleep(150),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(a=null!=(l=o.resultList)?l.result:void 0)?a:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},e.src.epmc.doi=async function(t,e){var i,r,s;if(t||null==e&&(e=this.refresh),null==t&&(t=this.params.doi),null!=(i=await this.src.epmc('doi:"'+t+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!e&&await this.src.epmc.notinepmc(t));else{if((s=await this.src.epmc.search("DOI:"+t)).total)return s.data[0].doi||(s.data[0].doi=t,this.waitUntil(this.src.epmc(s.data[0]))),s.data[0];await this.src.epmc.notinepmc({id:t.replace(/\//g,"_"),doi:t})}},e.src.epmc.pmid=async function(t,e){var i,r,s;if(t||null==e&&(e=this.refresh),null==t&&(t=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+t+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!e&&await this.src.epmc.notinepmc(t));else{if((s=await this.src.epmc.search("EXT_ID:"+t+" AND SRC:MED")).total)return s.data[0];await this.src.epmc.notinepmc({id:t,pmid:t})}},e.src.epmc.pmc=async function(t,e){var i,r,s,n;if(t||null==e&&(e=this.refresh),null==t&&(t=null!=(r=this.params.pmc)?r:this.params.pmcid),t="PMC"+t.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+t+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!e&&await this.src.epmc.notinepmc(t));else{if((n=await this.src.epmc.search("PMCID:"+t)).total)return n.data[0];await this.src.epmc.notinepmc({id:t,pmcid:t})}},e.src.epmc.title=async function(t){var e,i,r;null==t&&(t=this.params.title);try{t=t.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(t){}return(null!=(e=await this.src.epmc('title:"'+t+'"'))&&null!=(i=e.hits)?i.total:void 0)?e.hits.hits[0]._source:(r=await this.src.epmc.search('title:"'+t+'"')).total?r.data[0]:void 0},e.src.epmc.licence=async function(t,e,i,r){var s,n,a;if(t||null==r&&(r=this.refresh),null==t&&(t=null!=(n=null!=(a=this.params.licence)?a:this.params.pmcid)?n:this.params.epmc),t&&(t="PMC"+t.toLowerCase().replace("pmc","")),t&&null==e&&(e=await this.src.epmc.pmc(t)),e||i){if(null!=(null!=e?e.calculated_licence:void 0)&&!r)return"not found"===e.calculated_licence.licence?void 0:e.calculated_licence;if(null==t&&(t=null!=e?e.pmcid:void 0),(null!=e?e.license:void 0)&&"string"==typeof e.license?(s={licence:e.license,source:"epmc_api"}).licence.startsWith("cc")&&(s.licence=s.licence.replace(/ /g,"-")):(!i&&t&&(i=await this.src.epmc.xml(t,e)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(s=await this.licence(void 0,i,"<permissions>","</permissions>"))?s.licence:void 0)&&(s.source="epmc_xml_permissions"),null==(null!=s?s.licence:void 0)&&null!=(null!=(s=await this.licence(void 0,i))?s.licence:void 0)&&(s.source="epmc_xml_outside_permissions")),null==(null!=s?s.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(s={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=s?s.licence:void 0))return e.calculated_licence=s,await this.src.epmc(e.id,e),s;e.calculated_licence={licence:"not found"},await this.src.epmc(e.id,e)}},e.src.epmc.xml=async function(t,e){var i,r,s,n;if(null==t&&(t=null!=(r=null!=(s=this.params.xml)?s:this.params.pmcid)?r:this.params.epmc),t&&(t="PMC"+t.toLowerCase().replace("pmc","")),t)try{return(i=await fs.readFile("/home/cloo/static/epmc/fulltext/"+t+".xml")).toString()}catch(r){if(null==e&&(e=await this.src.epmc.pmc(t)),!(null!=e?e.no_ft:void 0)){if(await this.sleep(150),n="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id="+t,"string"==typeof(i=await this.fetch(n))&&i.length||null==e||(n="https://www.ebi.ac.uk/europepmc/webservices/rest/"+t+"/fullTextXML",i=await this.fetch(n)),"string"==typeof i&&i.length){try{await fs.writeFile("/home/cloo/static/epmc/fulltext/"+t+".xml",i)}catch(t){}return i}null!=e&&(e.no_ft=!0,await this.src.epmc(e.id,e))}}},e.src.epmc.fulltext=async function(t){var e,i,r;if(null==t&&(t=null!=(i=null!=(r=this.params.fulltext)?r:this.params.pmcid)?i:this.params.epmc),t)return await this.sleep(150),200===(null!=(e=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+t+"/fullTextXML",{method:"HEAD"}))?e.status:void 0)},e.src.epmc.statement=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p;if(null==t&&(t=null!=(a=null!=(l=null!=(o=null!=(u=this.params.statement)?u:this.params.pmc)?o:this.params.pmcid)?l:this.params.PMC)?a:this.params.PMCID),t&&(t="PMC"+(t+"").toLowerCase().replace("pmc",""),p=await this.src.epmc.xml(t,e))){if(h="",p.includes('type="data-availability">')?(h=p.split('type="data-availability">')[1].split("</sec>")[0].split("</notes>")[0]).includes("<title>")&&(h=h.split("<title>").pop().split("</title")[0]):p.includes('id="data-availability"')&&(h=p.split('id="data-availability"')[1]).includes("meta-value")&&(h=h.split("meta-value>")[1].split(",")[0]),!h&&p.includes("<notes>"))for(i=0,r=(c=p.split("<notes>")).length;i<r;i++)if((n=(s=c[i]).toLowerCase()).includes("data availability")||n.includes("data accessibility")||n.includes("supporting data")){s.includes("</title>")&&(h=s.split("</title>")[1]),h=h.split("</notes>")[0];break}if(h&&(h.includes("<list-item")&&(h=h.split("<list-item").pop().split(">").pop()),(h=h.replace(/<[ap].*?>/gi,"").replace(/<\/[ap]>/gi,"").replace(/<xref.*?>/gi,"").replace(/<\/xref>/gi,"").replace(/<ext.*?>/gi,"").replace(/<\/ext.*?>/gi,"").replace(/<br>/gi,"").replace(/\n/g,"").split("</")[0].trim()).length>10))return h}},e.src.epmc.aam=async function(t,e,i){var r,s,n,a;if(null==t&&(t=null!=(s=null!=(n=this.params.aam)?n:this.params.pmcid)?s:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{t&&!e&&(e=await this.src.epmc.pmc(t))}catch(t){}return null==t&&(t=null!=e?e.pmcid:void 0),t?"string"==typeof(i=await this.src.epmc.xml(t,e))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),a="https://europepmc.org/articles/PMC"+t.toLowerCase().replace("pmc",""),(r=await this.fetch(a))?"string"==typeof r?r.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||r.includes("Author manuscript; available in PMC")||r.includes("logo-nihpa.gif")||r.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}:null!=r?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},null==(o=r.src).google&&(o.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(t){}e.src.google=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p;return null==t&&(t=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(n=this.params)?n.google:void 0),null==e&&(e=null!=(a=this.S.src.google)&&null!=(l=a.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),t&&e&&i?(p="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+e+"&q="+t,await this.fetch(p)):{}},e.src.google.sheets=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if(null==t&&(t=this.copy(this.params)),"string"==typeof t&&(t={sheetid:t}),null==t.sheets&&null==t.sheet||null!=t.sheetid||(t.sheetid=null!=(c=t.sheet)?c:t.sheets,delete t.sheet,delete t.sheets),!t.sheetid)return[];if(t.sheetid.startsWith("http")&&t.sheetid.includes("sheets.googleapis.com/v4/")?b=t.sheetid:(t.sheetid.includes("/spreadsheets/")?(g=t.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!t.sheet&&t.sheetid.includes("/values/")&&(t.sheet=t.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),t.sheetid=g):2===t.sheetid.split("/").length&&([t.sheetid,t.sheet]=t.sheetid.split("/")),null==t.sheet&&(t.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+t.sheetid+"/values/"+t.sheet+"?alt=json&key="+(null!=(h=null!=(p=this.S.src.google)&&null!=(d=p.secrets)?d.serverkey:void 0)?h:null!=(f=this.S.src.google)&&null!=(y=f.secrets)?y.apikey:void 0)),e=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===t.values)return e;if(!1===t.headers)return e.values;if(Array.isArray(t.headers))s=t.headers;else if(s=[],null!=e.values)for(n=0,o=(v=e.values.shift()).length;n<o;n++){r=v[n];try{r=r.trim()}catch(t){}s.push(r)}for(_=[],a=0,u=(m=e.values).length;a<u;a++){for(i in l=m[a],w={},s)try{w[s[i]]=l[i]}catch(t){}"{}"!==JSON.stringify(w)&&_.push(w)}return _},e.src.google.sheets._bg=!0,g=[].indexOf,null==(o=r.src).microsoft&&(o.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(t){}e.src.microsoft={},e.src.microsoft.bing=async function(t,e,i,s,n){var a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;return null==t&&(t=null!=(a=null!=(l=null!=this&&null!=(d=this.params)?d.bing:void 0)?l:null!=this&&null!=(f=this.params)?f.q:void 0)?a:null!=this&&null!=(y=this.params)?y.query:void 0),null==e&&(e=null!=(m=null!=this&&null!=(g=this.params)?g.key:void 0)?m:null!=(v=r.src.microsoft.bing)?v.key:void 0),null==i&&(i=null!=(b=null!=this&&null!=(w=this.params)?w.market:void 0)?b:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==n&&(n=null!=(c=null!=this&&null!=(h=this.params)?h.cache:void 0)?c:259200),null!=t&&null!=e&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+t,null!=(_=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":e},cache:n}))&&null!=(p=_.webPages)?p.value:void 0)?{total:_.webPages.totalEstimatedMatches,data:_.webPages.value}:{total:0,data:[]}},e.src.microsoft.bing._auth="@oa.works",e.src.microsoft.graph={_prefix:!1,_index:{settings:{number_of_shards:9}}},e.src.microsoft.graph.journal={_prefix:!1,_index:!0},e.src.microsoft.graph.author={_prefix:!1,_index:{settings:{number_of_shards:9}}},e.src.microsoft.graph.affiliation={_prefix:!1,_index:!0},e.src.microsoft.graph.urls={_prefix:!1,_index:{settings:{number_of_shards:6}}},e.src.microsoft.graph.abstract={_prefix:!1,_index:{settings:{number_of_shards:6}}},e.src.microsoft.graph.relation={_prefix:!1,_index:{settings:{number_of_shards:12}}},e.src.microsoft.graph.paper=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if(_={1:"html",2:"text",3:"pdf",4:"doc",5:"ppt",6:"xls",8:"rtf",12:"xml",13:"rss",20:"swf",27:"ics",31:"pub",33:"ods",34:"odp",35:"odt",36:"zip",40:"mp3"},this.params.title&&!t)return this.src.microsoft.graph.paper.title();for(r=0,a=(y=null!=(d=null!=(v="object"==typeof(t=null!=(h=null!=(p=this.params.q)?p:this.params.paper)?h:this.params)&&t.PaperId&&t.Rank?t:await this.src.microsoft.graph(t))&&null!=(f=v.hits)?f.hits:void 0)?d:v?[v]:[]).length;r<a;r++){c=y[r];try{for(m=(await this.src.microsoft.graph.urls('PaperId:"'+c._source.PaperId+'"')).hits.hits,s=0,l=m.length;s<l;s++){w=m[s],null==(e=c._source).url&&(e.url=[]),u={url:w._source.SourceUrl,language:w._source.LanguageCode};try{u.type=_[w._source.SourceType.toString()]}catch(t){}c._source.url.push(u)}}catch(t){}try{for(g=(await this.src.microsoft.graph.relation('PaperId:"'+c._source.PaperId+'"',100)).hits.hits,n=0,o=g.length;n<o;n++)(b=g[n])._source.AuthorId&&(null==(i=c._source).author&&(i.author=[]),c._source.author.push({name:b._source.OriginalAuthor,sequence:b._source.AuthorSequenceNumber,id:b._source.AuthorId,affiliation:{name:b._source.OriginalAffiliation,id:b._source.AffiliationId}}))}catch(t){}}return v},e.src.microsoft.graph.title=async function(t){var e,i,r,s,n,a,l,o;if(null==t&&(t=null!=(r=this.params.title)?r:this.params.q),"string"==typeof t&&(o=t.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(null!=(a=await this.src.microsoft.graph('PaperTitle:"'+o+'"',1))&&null!=(s=a.hits)?s.hits:void 0)&&(a=null!=(n=a.hits.hits[0])?n._source:void 0),(null!=a?a.PaperTitle:void 0)&&(l=a.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),e=(i=await this.levenshtein(o,l,!1)).length.a>i.length.b?i.length.a:i.length.b,i.distance<2||e/i.distance>10)))return this.src.microsoft.graph.paper(a)},e.src.microsoft.load=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,m,v;for(a=null!=(m=this.params.howmany)?m:-1,c={paper:["PaperId","Rank","Doi","DocType","PaperTitle","OriginalTitle","BookTitle","Year","Date","OnlineDate","Publisher","JournalId","ConferenceSeriesId","ConferenceInstanceId","Volume","Issue","FirstPage","LastPage","ReferenceCount","CitationCount","EstimatedCitation","OriginalVenue","FamilyId","FamilyRank","CreatedDate"]},null==t&&(t=this.params.load?this.params.load.split(","):this.params.kinds?this.params.kinds.split(","):this.keys(c)),o=this.S.directory+"/mag/2021-04-26/",h=this.S.directory+"/mag/last",v=0,i=0,s=!this.params.parallel,n={},d=0,f={},e=async t=>{var e,r,s,l,u,p,m,g,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U;y.log("MAG loading",t),l="abstract"===t?2e4:"relation"===t?75e3:"urls"===t?1e5:5e4,r=[],S=h+"_"+t,k=0;try{this.refresh||(A=parseInt((await fs.readFile(S)).toString().split(" ")[0]))}catch(t){}if("DONE"!==A){for await(C of(A||("paper"===t?await this.src.microsoft.graph(""):await this.src.microsoft.graph[t]("")),m=("urls"===t?o.replace("2021-04-26/",""):o)+("relation"===t?"PaperAuthorAffiliations.txt":("urls"===t?"Paper":"")+t.substr(0,1).toUpperCase()+t.substr(1)+("urls"===t?"":"s")+".txt"),readline.createInterface({input:fs.createReadStream(m)}))){if(k+=1,v===a)break;q=C.split("\t");try{A&&!(k/1e5).toString().includes(".")&&y.log(t,"waiting",k,A)}catch(t){}if(!A||k===A||parseInt(q[0])===A){if(A=void 0,v+=1,x=0,N={},"relation"!==t&&"urls"!==t){N._id=q[0];try{N._id=N._id.trim()}catch(t){}N._id||delete N._id}if(N._id||"relation"===t||"urls"===t){if("abstract"===t)try{for(N.PaperId=parseInt(q[0]),p=JSON.parse(q[1]),e=[];e.length<p.IndexLength;)e.push("");for(T=p.InvertedIndex,u=0,I=T.length;u<I;u++)for(_=T[u],P=p.InvertedIndex[_],g=0,E=P.length;g<E;g++)e[P[g]]=_;N.Abstract=e.join(" ").replace(/\n/g," ")}catch(t){}else for(j=0,D=(R=c[t]).length;j<D;j++){O=R[j],U=q[x];try{U.trim()}catch(t){}if(U&&"NormalizedName"!==O&&(N[O]=U),"Rank"===O||"AuthorSequenceNumber"===O||"Year"===O||"EstimatedCitation"===O||"FamilyRank"===O||"SourceType"===O||O.endsWith("Count")||O.endsWith("Id"))try{L=parseInt(N[O]),isNaN(L)||(N[O]=L)}catch(t){}x+=1}if("paper"===t&&N.JournalId)try{w=N.JournalId.toString(),(b=f[w])?N.journal={title:b.DisplayName,ISSN:b.Issn.split(","),url:b.Webpage,id:N.JournalId}:(b=await this.src.microsoft.graph.journal(w))&&(f[w]=b,d+=1,y.log(d),N.journal={title:b.DisplayName,ISSN:b.Issn.split(","),url:b.Webpage})}catch(t){}}"{}"!==JSON.stringify(N)?r.push(N):i+=1}r.length===l&&(y.log(t,v,k,i),"paper"===t?await this.src.microsoft.graph(r):(s=await this.src.microsoft.graph[t](r),y.log("batch returned",s)),await fs.writeFile(S,k+" "+q[0]),r=[])}r.length&&("paper"===t?await this.src.microsoft.graph(r):await this.src.microsoft.graph[t](r)),await fs.writeFile(S,"DONE")}return n[_]=!0},l=0,p=t.length;l<p;l++)u=t[l],this.params.parallel?"paper"!==u&&(n[u]=!1,e(u)):await e(u);for(;!s;){for(r in s=!0,n)!1===n[r]&&(s=!1);s&&g.call(t,"paper")>=0&&await e("paper"),await this.sleep(1e3)}return y.log(v,i),v},e.src.microsoft.load._bg=!0,e.src.microsoft.load._async=!0,e.src.microsoft.load._auth="root",null==(o=r.src).oadoi&&(o.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(t){}e.src.oadoi={_index:{settings:{number_of_shards:9}}},e.src.oadoi._key="doi",e.src.oadoi._prefix=!1,e.src.oadoi.search=async function(t){var e,i,s,n,a,l;if(null==t&&(t=null!=(e=null!=(i=null!=(s=this.params)?s.oadoi:void 0)?i:null!=(n=this.params)?n.doi:void 0)?e:null!=(a=this.params)?a.search:void 0),"string"==typeof t&&t.startsWith("10."))return await this.sleep(900),l="https://api.oadoi.org/v2/"+t+"?email="+r.mail.to,this.fetch(l)},e.src.oadoi.hybrid=async function(t){var e,i,r,s,n,a;if(null==t&&(t=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"object"!=typeof t||Array.isArray(t)||(t=null!=(a=t.journal_issns)?a:t.ISSN),"string"==typeof t&&(t=t.replace(/\s/g,"").split(",")),Array.isArray(t)&&t.length)return(r="journal_issns.keyword:*"+t.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(r="("+r+")"),e=await this.src.oadoi.count(r+' AND oa_status:"closed"'),i=await this.src.oadoi.count(r+' AND oa_status:"hybrid"'),!!(e&&i/e>.001)},e.src.oadoi.load=async function(){var t,e,i,r,s,n,a,l,o;e=null!=(l=this.params.howmany)?l:-1,i=this.S.directory+"/oadoi/snapshot.jsonl",r=this.S.directory+"/oadoi/last";try{this.refresh||(s=(await fs.readFile(r)).toString())}catch(t){}for await(n of(s||await this.src.oadoi(""),o=0,t=[],readline.createInterface({input:fs.createReadStream(i).pipe(zlib.createGunzip())}))){if(o===e)break;try{a=JSON.parse(n.trim().replace(/\,$/,"")),s&&s!==a.doi||(s=void 0,o+=1,a._id=a.doi.replace(/\//g,"_"),t.push(a),3e4===t.length&&(y.log("OADOI bulk loading",t.length,o),await this.src.oadoi(t),t=[],await fs.writeFile(r,a.doi)))}catch(t){}}return t.length&&await this.src.oadoi(t),y.log(o),o},e.src.oadoi.load._bg=!0,e.src.oadoi.load._async=!0,e.src.oadoi.load._auth="root",e.src.oadoi.changes=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,m,g,v;if(g=this.S.directory+"/oadoi/upto",this.S.directory,null==t&&(t=this.params.changes),!t)try{t=parseInt((await fs.readFile(g)).toString())}catch(t){}if(!t)try{n=await this.src.oadoi("*",{size:1,sort:{updated:{order:"desc"}}}),t=new Date(n.updated).valueOf()}catch(t){}if(t){for(i=0,r=0,m=!1,s=0,l=(d=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;s<l;s++){if(h=d[s],c=new Date(h.last_modified).valueOf(),y.log(h.last_modified,c,t,null!=n?n.updated:void 0),"jsonl"===h.filetype&&(!t||c>t)){for await(u of(y.log("OADOI importing changes for",h.last_modified),r+=1,e=[],a=0,o=this.S.directory+"/oadoi/"+h.date+".jsonl.gz",f=await fetch(h.url),v=fs.createWriteStream(o),await new Promise(((t,e)=>(f.body.pipe(v),f.body.on("error",e),v.on("finish",t)))),readline.createInterface({input:fs.createReadStream(o).pipe(zlib.createGunzip())})))m=c,a+=1,(p=JSON.parse(u.trim().replace(/\,$/,"")))._id=p.doi.replace(/\//g,"_"),e.push(p),i+=1,e.length>=3e4&&(y.log("OADOI bulk loading changes",r,e.length,a),await this.src.oadoi(e),e=[]);e.length&&await this.src.oadoi(e),fs.unlink(o)}if(m)try{await fs.writeFile(g,m)}catch(t){}}return y.log(r,i),i}y.log("Timestamp day to work since is required - run load first to auto-generate")},e.src.oadoi.changes._bg=!0,e.src.oadoi.changes._async=!0,e.src.oadoi.changes._auth="root",e.src.oadoi.changes._notify=!1,e.src.oadoi.local=async function(){var t,e,i,r,s;if(e=0,this.params.local&&10===this.params.local.length&&3===this.params.local.split("-").length&&!this.params.local.includes("/")){for await(r of(i=this.S.directory+"/oadoi/"+this.params.local+".jsonl",t=[],readline.createInterface({input:fs.createReadStream(i)})))e+=1,(s=JSON.parse(r.trim().replace(/\,$/,"")))._id=s.doi.replace(/\//g,"_"),t.push(s),t.length>=5e4&&(await this.src.oadoi(t),t=[]);t.length&&await this.src.oadoi(t)}return y.log(e),e},e.src.oadoi.local._bg=!0,e.src.oadoi.local._auth="root",g=[].indexOf,null==(o=r.src).openalex&&(o.openalex={});try{r.src.openalex=JSON.parse(SECRETS_OPENALEX)}catch(t){}e.src.openalex=function(){return!0},e.src.openalex.authors={_index:{settings:{number_of_shards:9}},_prefix:!1},e.src.openalex.works={_index:{settings:{number_of_shards:9}},_prefix:!1},e.src.openalex.institutions={_index:!0,_prefix:!1},e.src.openalex.concepts={_index:!0,_prefix:!1},e.src.openalex.venues={_index:!0,_prefix:!1},e.src.openalex.works.doi=async function(t){var e,i,r,s,n,a;if(null==t&&(t=this.params.doi),!(i=await this.src.openalex.works('ids.doi:"https://doi.org/'+t+'"',1))&&(i=await this.fetch("https://api.openalex.org/works/https://doi.org/"+t))){if(null!=i.abstract_inverted_index){for(a in e=[],i.abstract_inverted_index)for(r=0,s=(n=i.abstract_inverted_index[a]).length;r<s;r++)e[n[r]]=a;e.length&&(i.abstract=e.join(" ")),delete i.abstract_inverted_index}this.waitUntil(this.src.openalex.works(t.toLowerCase(),i))}return i},e.src.openalex.load=async function(t,e,i,r,s){var n,a,l,o,u,c,h,p,d,f,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q;if(null==t&&(t=null!=(j=this.params.load)?j:this.params.openalex),"works"!==t&&"venues"!==t&&"authors"!==t&&"institutions"!==t&&"concepts"!==t)return!1;if(null==i&&(i=null!=(A=this.params.clear)&&A),null==r&&(r=null!=(I=this.params.sync)&&I),!0===i&&(await this.src.openalex[t](""),await this.sleep(3e5)),c=null!=(E=this.params.howmany)?E:-1,R=0,d=this.S.directory+"/openalex/openalex-snapshot/data/"+t,"string"==typeof e)e=[e];else if(!0===e){y.log("Checking for Openalex changes in",t),e=[];try{S=JSON.parse((await fs.readFile(d+"/manifest")).toString()),s=await this.epoch(S.entries[S.entries.length-1].url.split("=")[1].split("/")[0])}catch(t){s=0}for(r?(P=await this._child("aws",["s3","sync","s3://openalex",this.S.directory+"/openalex/openalex-snapshot","--no-sign-request"]),y.log("Openalex sync returned",P)):(await fs.writeFile(d+"/manifest",await this.fetch("https://openalex.s3.amazonaws.com/data/"+t+"/manifest",{buffer:!0})),y.log("Openalex manifest updated")),u=!1,h=0,w=(D=(S=JSON.parse((await fs.readFile(d+"/manifest")).toString())).entries).length;h<w;h++)l=D[h].url.split("=")[1].split("/")[0],u||await this.epoch(l)>s&&(u=!0),u&&g.call(e,l)<0&&e.push(l);e.length&&y.log("Found changes",e)}if(!r&&e&&e.length)for(f=0,_=e.length;f<_;f++){a=e[f],y.log("Openalex syncing files",t,a);try{await fs.stat(d+"/updated_date="+a)}catch(e){await this._child("aws",["s3","sync","s3://openalex/data/"+t+"/updated_date="+a,d+"/updated_date="+a,"--no-sign-request"])}}for(o=0,k=0,T=0,v=[],m=0,x=(C=await fs.readdir(d)).length;m<x;m++)if(!(q=C[m]).startsWith("manifest")&&(!e||0===e.length||(N=q.split("=")[1],g.call(e,N)>=0))){for(n=async i=>{var r,s,n,a,l,o,u,h,p,f,m,b,w,_,x,O,S,j,A,I;for await(p of(s=[],n=[],readline.createInterface({input:fs.createReadStream(d+"/"+q+"/"+i).pipe(zlib.createGunzip())}))){if(R===c)break;if(b=JSON.parse(p.trim().replace(/\,$/,"")),R+=1,"venues"===t||"institutions"===t||"concepts"===t||"authors"===t){if(b._id=b.id.split("/").pop(),"authors"===t&&null!=b.x_concepts)for(l=0,o=(S=b.x_concepts).length;l<o;l++)null!=(I=S[l]).score&&(I.score=Math.floor(I.score))}else if("works"===t){try{for(j=b.concepts,f=0,u=j.length;f<u;f++)null!=(I=j[f]).score&&(I.score=Math.floor(I.score))}catch(t){}try{b._id=null!=(w=null!=(_=b.doi)?_:b.DOI)?w:null!=(x=b.ids)?x.doi:void 0,b._id.includes("http")&&b._id.includes("/10.")&&(b._id="10."+b._id.split("/10.").pop()),b._id&&b._id.startsWith("10.")||(b._id=b.id.split("/").pop())}catch(t){b._id=b.id.split("/").pop()}e&&b.id&&b._id&&b._id.startsWith("10.")&&b._id!==b.id&&await this.src.openalex.works({_id:b.id},1)&&n.push(b.id);try{for(A in r=[],b.abstract_inverted_index)for(O=b.abstract_inverted_index[A],m=0,h=O.length;m<h;m++)r[O[m]]=A;r.length&&(b.abstract=r.join(" "))}catch(t){}try{delete b.abstract_inverted_index}catch(t){}}try{for(a in await this.flatten(b))g.call(v,a)<0&&(v.push(a),y.log("openalex seeing new key",v.length,a))}catch(t){}s.push(b),s.length>=3e4&&(y.log("Openalex "+t+" bulk loading",q,i,s.length,R),await this.src.openalex[t](s),s=[])}return n.length&&await this.index._bulk("src_openalex_works",n,"delete"),s.length&&await this.src.openalex[t](s),y.log("removing",d+"/"+q+"/"+i),await fs.unlink(d+"/"+q+"/"+i),k+=1,T-=1,!0},b=0,O=(L=await fs.readdir(d+"/"+q)).length;b<O;b++){for(p=L[b],y.log("Openalex load running",T),o+=1;3===T;)await this.sleep(5e3),y.log("Openalex load running",T);T+=1,n(p)}for(;0!==T;)await this.sleep(5e3);await fs.rmdir(d+"/"+q)}return y.log(o,k,R),{expected:o,processed:k,total:R}},e.src.openalex.load._bg=!0,e.src.openalex.load._async=!0,e.src.openalex.load._auth="root",e.src.openalex.changes=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,m,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N;if(null==t&&(t=null!=(m=this.params.changes)?m:this.params.openalex),null==e&&(e=this.params.last),null==e&&(e=await this.date(await this.epoch()-864e5)),D=["works"],t){if(g.call(D,t)<0)return!1}else t=D;for(A=0,a=0,c=(v=Array.isArray(t)?t:[t]).length;a<c;a++){E=v[a];try{for(r=[],n=[],s="*",I="https://api.openalex.org/"+E+"?filter=from_updated_date:"+e+"&api_key="+this.S.src.openalex.apikey+"&per-page=200&cursor=",j=await this.fetch(I+s);null!=j&&"object"==typeof j&&Array.isArray(j.results)&&j.results.length;){for(b=j.results,l=0,h=b.length;l<h;l++){f=b[l];try{for(w=f.concepts,o=0,p=w.length;o<p;o++)null!=(N=w[o]).score&&(N.score=Math.floor(N.score))}catch(t){}try{f._id=null!=(_=null!=(x=f.doi)?x:f.DOI)?_:null!=(O=f.ids)?O.doi:void 0,f._id.includes("http")&&f._id.includes("/10.")&&(f._id="10."+f._id.split("/10.").pop()),f._id&&f._id.startsWith("10.")||(f._id=f.id.split("/").pop())}catch(t){f._id=f.id.split("/").pop()}f.id&&f._id&&f._id.startsWith("10.")&&f._id!==f.id&&await this.src.openalex.works({_id:f.id},1)&&n.push(f.id);try{for(C in i=[],f.abstract_inverted_index)for(S=f.abstract_inverted_index[C],u=0,d=S.length;u<d;u++)i[S[u]]=C;i.length&&(f.abstract=i.join(" "))}catch(t){}try{delete f.abstract_inverted_index}catch(t){}r.push(f)}r.length>=3e4&&(y.log("Openalex "+t+" bulk loading changes",r.length,A),A+=r.length,await this.src.openalex[t](r),r=[]),(null!=(k=j.meta)?k.next_cursor:void 0)&&(s=j.meta.next_cursor,j=await this.fetch(I+encodeURIComponent(s)))}r.length&&(A+=r.length,await this.src.openalex[t](r),r=[]),n.length&&await this.index._bulk("src_openalex_works",n,"delete")}catch(t){}}return A},e.src.openalex.changes._bg=!0,e.src.openalex.changes._async=!0,e.src.openalex.changes._auth="root",e.src.openalex.fixids=async function(){var t,e,i,r;for await(i of(r=0,t=[],e=await this.src.openalex.works.count("NOT DOI:* AND NOT doi:* AND NOT ids.doi:*"),y.log("openalex fix IDs expecting to process",e),this.index._for("src_openalex_works","NOT DOI:* AND NOT doi:* AND NOT ids.doi:*",{scroll:"30m",include:["_id","id"]})))r%100==0&&y.log(r,t.length),r+=1,await this.src.openalex.works.count('id.keyword:"'+i.id+'" AND (DOI:* OR doi:* OR ids.doi:*)')&&t.push(i.id),3e4===t.length&&(await this.index._bulk("src_openalex_works",t,"delete"),t=[],y.log("deleting obsoletes from openalex works",r,e));return t.length&&await this.index._bulk("src_openalex_works",t,"delete"),y.log("deleting obsoletes from openalex works finished having done",r,e),r},e.src.openalex.fixids._bg=!0,e.src.openalex.fixids._async=!0,e.src.openalex.fixids._auth="root",e.src.openalex.latest=async function(t){var e,i,r,s,n,a,l,o,u,c,h;if(null==t&&(t=null!=(o=this.params.latest)?o:this.params.openalex),h=["works","venues","authors","institutions","concepts"],g.call(h,t)<0)return!1;for(n=this.S.directory+"/openalex/openalex-snapshot/data/"+t,(c={last:void 0,changes:[],count:0,manifest:{previous:JSON.parse((await fs.readFile(n+"/manifest")).toString()),latest:await this.fetch("https://openalex.s3.amazonaws.com/data/"+t+"/manifest")}}).last=c.manifest.previous.entries[c.manifest.previous.entries.length-1].url.split("=")[1].split("/")[0],a=await this.epoch(c.last),r=!1,s=0,l=(u=c.manifest.latest.entries).length;s<l;s++)e=(i=u[s]).url.split("=")[1].split("/")[0],r||await this.epoch(e)>a&&(r=!0),r&&(g.call(c.changes,e)<0&&c.changes.push(e),c.count+=i.meta.record_count);return c},g=[].indexOf,e.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},e.src.pubmed.doi=async function(t){var e;if(null==t&&(t=this.params.doi),t&&(e=await this.src.pubmed('identifier.doi:"'+t+'"',1)))return e},e.src.pubmed.pmc=async function(t){var e;if(null==t&&(t=this.params.pmc),t&&(e=await this.src.pubmed('identifier.pmc:"PMC'+t.toString().toLowerCase().replace("pmc","")+'"',1)))return e},e.src.pubmed.entrez={},e.src.pubmed.entrez.summary=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b;b="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),b+="&id="+i):b+="&query_key="+t+"&WebEnv="+e;try{for(h=await this.convert.xml2json(await this.fetch(b)),d=[],Array.isArray(h.eSummaryResult.DocSum)||(h.eSummaryResult.DocSum=[h.eSummaryResult.DocSum]),f=h.eSummaryResult.DocSum,s=0,o=f.length;s<o;s++){for(r={id:(p=f[s]).Id},y=p.Item,a=0,u=y.length;a<u;a++)if("List"===(n=y[a])._.Type){if(r[n._.Name]=[],null!=n.Item)for(m=n.Item,l=0,c=m.length;l<c;l++)g=m[l],(v={})[g._.Name]=g.$,r[n._.Name].push(v)}else r[n._.Name]=n.$;if(d.push(r),null==i||!i.includes(","))return d[0]}return d}catch(t){}},e.src.pubmed.entrez.pmid=async function(t){var e,i,r;null==t&&(t=this.params.pmid),r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+t;try{return e=await this.fetch(r),i=await this.convert.xml2json(e),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey,i.ePostResult.WebEnv)}catch(t){}},e.src.pubmed.search=async function(t,e,i=10,r=!1){var s,n,a,l,o,u,c,h,p,d,f,y;null==t&&(t=null!=(c=this.params.search)?c:this.params.q),y="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+t;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))p={total:r.length,data:[]};else{if(p=await this.fetch(y),p={total:(d=await this.convert.xml2json(p)).eSearchResult.Count[0],data:[]},!0===r)return p.data=d.eSearchResult.IdList[0].Id,p;r=d.eSearchResult.IdList[0].Id}if(e)for(s=0,a=r.length;s<a&&(f=r[s],o=await this.src.pubmed.pmid(f),p.data.push(o),p.data.length!==i);s++);else for(h=await this.src.pubmed.entrez.summary(void 0,void 0,r),n=0,l=h.length;n<l&&(u=h[n],p.data.push(u),p.data.length!==i);n++);return p}catch(t){}},e.src.pubmed.pmid=function(t){null==t&&(t=this.params.pmid);try{return this.src.pubmed.entrez.pmid(t)}catch(t){}},e.src.pubmed.aheadofprint=async function(t){null==t&&(t=this.params.pmid);try{return(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+t+"?report=xml")).includes("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(t){}},e.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},e.src.pubmed.availability=async function(t){var e,i,r,s,n;return null==t&&(t=null!=(e=null!=(i=null!=(r=null!=(s=null!=(n=this.params.pubmed)?n:this.params.availability)?s:this.params.pmc)?r:this.params.pmcid)?i:this.params.PMC)?e:this.params.PMCID),t="pmc"+(t+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(t)},e.src.pubmed.availability.statement=function(t,i){return e.src.epmc.statement(t,i)},e.src.pubmed.load=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,m;for(null==t&&"changes"===this.params.load&&(t=!0),f=null!=(c=this.params.streamers)?c:2,a=null!=(h=this.params.howmany)?h:-1,this.refresh&&!t&&await this.src.pubmed(""),i=t?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",s=[],n="number"==typeof this.params.load?this.params.load:"number"==typeof this.params.changes?this.params.changes:void 0,l=0,o=(p=(await this.fetch(i)).split('href="')).length;l<o;l++)(r=p[l].split('"')[0]).endsWith(".gz")&&r.includes(n+".xml")||!n&&r.startsWith("pubmed")&&r.endsWith(".gz")&&("baseline"===this.params.load||this.refresh&&!t||!await this.src.pubmed.count('srcfile:"'+i+r+'"'))?s.push(i+r):r.endsWith(".md5")||y.log("pubmed load skipping file",i+r);for(d=0,m=0,e=async e=>{var i,r,n,l,o,u,c,h,p,f,v,b,w,_,x,O,S,k,j,A,I;y.log("Pubmed loading"+(t?" changes":""),e,s.length,d),u=[],x={};try{for await(b of readline.createInterface({input:(await fetch(e)).body.pipe(zlib.createGunzip())}))if("</PubmedArticle>"===(b=b.trim().replace("&amp;","&"))){if(m+=1,x.srcfile=e,x._id=x.PMID,u.push(x),x={},m===a)break}else if(!(b.startsWith("<?")||b.includes("?xml")||b.includes("!DOCTYPE")||b.includes("/>")||b.includes("PubmedArticle")||b.includes("PubmedData")||b.includes("History")||b.includes("ArticleIdList")||b.includes("List>"))){for(p in b.split(">")[0].split(" ")[0].replace("<",""),f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(b.includes(p)||b.includes(p.replace(">"," ")))&&null==x[_=f[p]]&&(x[_]=b.split(">")[1].split("</")[0]);if(b.includes("<MedlinePgn>"))x.pages=b.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ");else if(b.includes("<ISSN"))null==x.ISSN&&(x.ISSN=[]),I=b.split(">")[1].split("</")[0],g.call(x.ISSN,I)<0&&x.ISSN.push(I);else if(b.includes("<Keyword>"))null==x.keyword&&(x.keyword=[]),I=b.split(">")[1].split("</")[0],g.call(x.keyword,I)<0&&x.keyword.push(I);else if(b.includes("<GeneSymbol>"))null==x.gene&&(x.gene=[]),I=b.split(">")[1].split("</")[0],g.call(x.gene,I)<0&&x.gene.push(I);else if(b.includes("<PublicationType>")||b.includes("<PublicationType "))null==x.type&&(x.type=[]),I=b.split(">")[1].split("</")[0],g.call(x.type,I)<0&&x.type.push(I);else if(b.includes("<Chemical>"))null==x.chemical&&(x.chemical=[]),x.chemical.push({});else if(b.includes("<NameOfSubstance>")||b.includes("<NameOfSubstance "))null==x.chemical&&(x.chemical=[{}]),x.chemical[x.chemical.length-1].name=b.split(">")[1].split("</")[0],x.chemical[x.chemical.length-1].nameID=b.split('UI="')[1].split('"')[0];else if(b.includes("<RegistryNumber>"))null==x.chemical&&(x.chemical=[{}]),x.chemical[x.chemical.length-1].registry=b.split(">")[1].split("</")[0];else if(b.includes("<DataBank>")||b.includes("<DataBank "))null==x.databank&&(x.databank=[]),x.databank.push({});else if(b.includes("<DataBankName>"))null==x.databank&&(x.databank=[{}]),x.databank[x.databank.length-1].name=b.split(">")[1].split("</")[0];else if(b.includes("<AccessionNumber>"))null==x.databank&&(x.databank=[{}]),null==(r=x.databank[x.databank.length-1]).accession&&(r.accession=[]),x.databank[x.databank.length-1].accession.push(b.split(">")[1].split("</")[0]);else if(b.includes("<Grant>")||b.includes("<Grant "))null==x.grant&&(x.grant=[]),x.grant.push({});else if(b.includes("<GrantID>"))null==x.grant&&(x.grant=[{}]),x.grant[x.grant.length-1].id=b.split(">")[1].split("</")[0];else if(b.includes("<Acronym>"))null==x.grant&&(x.grant=[{}]),x.grant[x.grant.length-1].acronym=b.split(">")[1].split("</")[0];else if(b.includes("<Agency>"))null==x.grant&&(x.grant=[{}]),x.grant[x.grant.length-1].agency=b.split(">")[1].split("</")[0];else if(b.includes("<Country>"))x.grant&&!x.grant[x.grant.length-1].country||x.country?x.grant&&x.grant.length&&(x.grant[x.grant.length-1].country=b.split(">")[1].split("</")[0]):x.country=b.split(">")[1].split("</")[0];else if(b.includes("<MeshHeading>")||b.includes("<MeshHeading "))null==x.mesh&&(x.mesh=[]),x.mesh.push({});else if(b.includes("<DescriptorName>")||b.includes("<DescriptorName "))null==x.mesh&&(x.mesh=[{}]),x.mesh[x.mesh.length-1].description=b.split(">")[1].split("</")[0],x.mesh[x.mesh.length-1].descriptionID=b.split('UI="')[1].split('"')[0];else if(b.includes("<QualifierName>")||b.includes("<QualifierName "))null==x.mesh&&(x.mesh=[{}]),null==(n=x.mesh[x.mesh.length-1]).qualifier&&(n.qualifier=[]),x.mesh[x.mesh.length-1].qualifier.push({name:b.split(">")[1].split("</")[0],id:b.split('UI="')[1].split('"')[0]});else if(b.includes("<Author>")||b.includes("<Author ")||b.includes("<Investigator>")||b.includes("<Investigator "))null==x.author&&(x.author=[]),x.author.push(b.includes("<Investigator")?{investigator:!0}:{});else if(b.includes("<LastName>"))null==x.author&&(x.author=[{}]),x.author[x.author.length-1].lastname=b.split(">")[1].split("</")[0];else if(b.includes("<ForeName>"))null==x.author&&(x.author=[{}]),x.author[x.author.length-1].firstname=b.split(">")[1].split("</")[0];else if(b.includes("<Affiliation>"))null==x.author&&(x.author=[{}]),x.author[x.author.length-1].affiliation=b.split(">")[1].split("</")[0];else if(b.includes("<Identifier>"))null==x.author&&(x.author=[{}]),x.author[x.author.length-1].identifier=b.split(">")[1].split("</")[0];else if(b.includes("<Note>")||b.includes("<Note ")||b.includes("<GeneralNote>")||b.includes("<GeneralNote "))null==x.notes&&(x.notes=[]),x.notes.push(b.split(">")[1].split("</")[0]);else if(b.includes("<DeleteCitation>")||b.includes("<DeleteCitation "))x.deletedFromMedline=!0;else if(b.includes("<ArticleId>")||b.includes("<ArticleId ")){null==x.identifier&&(x.identifier={});try{c=b.split('IdType="')[1].split('"')[0],null==(l=x.identifier)[c]&&(l[c]=b.split(">")[1].split("</")[0])}catch(t){}}else if(!b.includes("</")&&(b.includes("Date>")||b.includes("<Date")||b.includes("<PubMedPubDate")||b.includes("<ArticleDate>")||b.includes("ArticleDate ")||b.includes("<PubDate>")||b.includes("<PubDate "))){j=b.split(">")[0].split(" ")[0].replace("<","");try{(w=b.toLowerCase()).includes("pubstatus")&&(A=w.split(">")[0].split("pubstatus")[1]),A.includes('"')&&(A=A.split('"')[1])}catch(t){}}else if(j&&(b.includes("<Year>")||b.includes("<Month>")||b.includes("<Day>"))){null==x.dates&&(x.dates={}),k=j+(A?"_"+A:""),null==(o=x.dates)[k]&&(o[k]={}),x.dates[k][b.split(">")[0].replace("<","").toLowerCase()]=b.split(">")[1].split("</")[0],delete x.dates[k].date,delete x.dates[k].timestamp;try{x.dates[k]=await this.dateparts(x.dates[k])}catch(t){}try{A&&(x.dates[k].pubstatus=A)}catch(t){}}else if(j&&b.includes("</"+j))j="",A="";else if(b.includes("<Reference>")||b.includes("<Reference "))null==x.references&&(x.references=[]);else if(b.includes("<Citation")){null==x.references&&(x.references=[]),S={author:[]};try{for(O=b.split(". ")[0].split(", "),h=0,v=O.length;h<v;h++)i=O[h],S.author.push({name:i})}catch(t){}try{S.title=b.split(". ")[1].split("?")[0].trim()}catch(t){}try{S.journal=b.replace(/\?/g,".").split(". ")[2].trim()}catch(t){}try{b.includes("doi.org/")&&(S.doi=b.split("doi.org/")[1].split(" ")[0].trim())}catch(t){}try{S.url="http"+rc.split("http")[1].split(" ")[0]}catch(t){}"{}"!==JSON.stringify(S)&&x.references.push(S)}}u.length&&(await this.src.pubmed(u),y.log(e,m))}catch(t){}return d-=1};s.length&&!(a>0&&m>=a);)await this.sleep(1e3),d<f&&(d+=1,u=s.shift(),await e(u));return y.log(m,s.length),this.params.howmany?batch:m},e.src.pubmed.load._bg=!0,e.src.pubmed.load._async=!0,e.src.pubmed.load._auth="root",e.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},e.src.pubmed.changes._bg=!0,e.src.pubmed.changes._async=!0,e.src.pubmed.changes._auth="root",e.src.pubmed.changes._notify=!1,e.src.ror=async function(t){if(null==t&&(t=this.params.ror),"string"==typeof t&&!t.includes(" ")&&(t=t.split("/").pop()).length<11)return this.src.ror._format(await this.fetch("https://api.ror.org/organizations/"+t))},e.src.ror._index=!0,e.src.ror._prefix=!1,e.src.ror.query=function(t){var e;if(null==t&&(t=null!=(e=this.params.query)?e:this.params.q),"string"==typeof t)return this.fetch('https://api.ror.org/organizations?query="'+t+'"')},e.src.ror.grid=async function(t){var e,i,r,s;if(null==t&&(t=this.params.grid),"string"==typeof t&&t.startsWith("grid.")){if((null!=(r=await this.src.ror('external_ids.GRID.all:"'+t+'"'))?r.id:void 0)||1===(null!=r&&null!=(e=r.hits)?e.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(t))&&null!=(i=r.items)?i[0]:void 0)return s=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(s)),s}},e.src.ror.title=async function(t){var e,i,r,s,n;if(null==t&&(t=null!=(e=this.params.title)?e:this.params.q),"string"==typeof t){if(this.refresh||(s=await this.src.ror('title:"'+t+'"')),(null!=s?s.id:void 0)||1===(null!=s&&null!=(i=s.hits)?i.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(t))&&null!=(r=s.items)?r[0]:void 0)return n=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(n)),n}},e.src.ror._format=function(t){try{t._id=t.id.split("/").pop()}catch(t){}return t},e.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},e.src.ror.load=async function(){var t,e,i,r,s,n,a,l,o,u,c,h;h=0,t=[];try{r=await this.src.ror.dumps(),a=await this.epoch(r.hits.hits[0].files[0].created)}catch(t){}if(null!=(null!=(n=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?n.hits:void 0)&&(n=n.hits.hits[0]._source),y.log(a,null!=n?n.createdAt:void 0,null!=n?n.src:void 0),null!=n&&n.createdAt<a)for await(l of(s=r.hits.hits[0].files[0].links.self,y.log(s),e=await this.epoch(),c=!1,i=!1,o="",await this.src.ror(""),readline.createInterface({input:(await fetch(s)).body.pipe(zlib.createGunzip())})))try{c||5!==l.length||"{"!==l.replace(/\s\s\s\s/,"")?i||5!==l.replace(",","").length||"}"!==l.replace(/\s\s\s\s/,"").replace(",","")?"["!==l&&"]"!==l&&(o+=l):(i=!0,o+="}"):(c=!0,o="{"),!0===c&&!0===i&&(c=!1,i=!1,(u=await this.src.ror._format(JSON.parse(o))).src=s,u.createdAt=e,o="",h+=1,t.push(u),2e4===t.length&&(y.log("ROR bulk loading",t.length,h),await this.src.ror(t),t=[]))}catch(t){}return t.length&&await this.src.ror(t),y.log(h),h},e.src.ror.load._bg=!0,e.src.ror.load._async=!0,e.src.ror.load._auth="root",null==(o=r.src).zenodo&&(o.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(t){}e.src.zenodo={deposition:{},records:{}},e.src.zenodo.records.search=function(t,e){var i,r,s;return null==t&&(t=this.params),null==e&&(e=this.params.dev),r=null!=(i=this.params.size)?i:10,s="https://"+(this.S.dev||e?"sandbox.":"")+"zenodo.org/api/records?size="+r+"&q="+encodeURIComponent(t),this.fetch(s)},e.src.zenodo.records.record=function(t,e){var i;return null==t&&(t=null!=(i=this.params.record)?i:this.params.id),null==e&&(e=this.params.dev),this.fetch("https://"+(this.S.dev||e?"sandbox.":"")+"zenodo.org/api/records/"+t)},e.src.zenodo.records.get=async function(t,e){var i;null==t&&(t=this.params.get),null==e&&(e=this.params.dev),i=await this.src.zenodo.records.search(t,e);try{return i.hits.hits[0]}catch(t){}},e.src.zenodo.records.doi=function(t,e){return null==t&&(t=this.params.doi),null==e&&(e=this.params.dev),this.src.zenodo.records.get('doi:"'+t+'"',e)},e.src.zenodo.records.title=function(t,e){return null==t&&(t=this.params.title),null==e&&(e=this.params.dev),this.src.zenodo.records.get('title:"'+t+'"',e)},e.src.zenodo.records.format=function(t){var e,i,r,s,n,a,l,o,u,c,h;null==t&&(t=this.params),o={};try{null==o.pdf&&(o.pdf=t.pdf)}catch(t){}try{null==o.url&&(o.url=t.url)}catch(t){}null==o.doi&&(o.doi=t.doi);try{if("string"==typeof t.metadata.publication_date&&3===t.metadata.publication_date.split("-").length){o.published=t.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(t){}}}catch(t){}try{null==o.title&&(o.title=t.metadata.title)}catch(t){}try{null==o.journal&&(o.journal=t.metadata.journal.title)}catch(t){}try{null==o.issue&&(o.issue=t.metadata.journal.issue)}catch(t){}try{null==o.page&&(o.page=t.metadata.journal.pages)}catch(t){}try{null==o.volume&&(o.volume=t.metadata.journal.volume)}catch(t){}try{null==o.keyword&&(o.keyword=t.metadata.keywords)}catch(t){}try{null==o.licence&&(o.licence=t.metadata.license.id)}catch(t){}try{o.abstract=t.metadata.description}catch(t){}try{(t.metadata.access_right="open")&&(null==o.url&&(o.url=null!=t.files&&t.files.length&&null!=(null!=(u=t.files[0].links)?u.self:void 0)?t.files[0].links.self:t.links.html),null==o.open&&(o.open=o.url))}catch(t){}try{for(c=t.files,s=0,a=c.length;s<a;s++)if("pdf"===(r=c[s]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(t){}try{for(null==o.author&&(o.author=[]),h=t.metadata.creators,n=0,l=h.length;n<l;n++){if("string"==typeof(e=h[n])&&(e={name:e}),null!=e.name&&"unknown"!==e.name.toLowerCase()){i=e.name.split(" ");try{e.family=i[i.length-1]}catch(t){}try{e.given=e.name.replace(e.family,"").trim()}catch(t){}}null!=e.affiliation&&(_.isArray(e.affiliation)&&(e.affiliation=e.affiliation[0]),"string"==typeof e.affiliation&&(e.affiliation={name:e.affiliation})),o.author.push(e)}}catch(t){}return o},e.src.zenodo.deposition.create=async function(t,e,i,r){var s,n,a,l,o,u,c,h,p;return null==r&&(r=null!=(a=this.params.dev)?a:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=r?null!=(l=this.S.src)&&null!=(o=l.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==t&&(t=this.params.metadata),null!=i&&null!=t&&null!=t.title&&null!=t.description&&(p="https://"+(r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(n={metadata:t}).metadata.upload_type||(n.metadata.upload_type="publication",n.metadata.publication_type="article"),null==(s=n.metadata).creators&&(s.creators=[{name:"Works, Open Access"}]),null!=e?(null!=(null!=(h=await this.fetch(p,{method:"POST",body:n}))?h.id:void 0)&&(e.content||e.file)&&(h.uploaded=await this.src.zenodo.deposition.upload(h.id,e.content,e.file,e.name,e.url,i,r)),e.publish&&(h.published=await this.src.zenodo.deposition.publish(h.id,i,r)),h):await this.fetch(p,{method:"POST",body:n}))},e.src.zenodo.deposition.upload=async function(t,e,i,r,s,n,a){var l,o,u,c;if(null==t&&(t=null!=(l=this.params.upload)?l:this.params.id),null==e&&(e=this.params.content),null==r&&(r=this.params.filename),!e&&!i)try{i=this.request.files[0]}catch(t){}if(s&&!e&&!i)try{e=await this.fetch(s,{buffer:!0})}catch(t){}return null==n&&(n=this.params.token),null==n&&(n=this.S.dev||a?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==a&&(a=this.params.dev),null!=n&&null!=t&&(s="https://"+(this.S.dev||a?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"/files?access_token="+n,this.fetch(s,{file:null!=e?e:i,filename:r}))},e.src.zenodo.deposition.publish=function(t,e,i){var r,s,n,a,l;return null==t&&(t=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==e&&(e=this.params.token),null==e&&(e=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src)&&null!=(a=n.zenodo)?a.token:void 0),null!=e&&null!=t&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"/actions/publish?access_token="+e,this.fetch(l,{method:"POST"}))},e.src.zenodo.deposition.delete=async function(t,e,i){var r,s,n,a;return null==t&&(t=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==e&&(e=this.params.token),null==e&&(e=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src.zenodo)?n.token:void 0),null!=e&&null!=t&&(a="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"?access_token="+e,await this.fetch(a,{method:"DELETE"}),!0)},e.blacklist=async function(t){var e,i,r,s,n,a,l,o;if(null==t&&(t=this.params.url),"number"==typeof t&&(t=t.toString()),null!=t&&(t.length<4||-1===t.indexOf(".")))return!1;for(i=[],s=0,a=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;s<a;s++)r=o[s],i.push(r.url.toLowerCase());if(t){if(!t.startsWith("http")&&t.includes(" "))return!1;for(n=0,l=i.length;n<l;n++)if(e=i[n],t.includes(e.toLowerCase()))return!0;return!1}return i},e.bug=function(){var t,e,i,r,s,n,a,l,o,u,c;if(this.params.contact)return"";for(t in c=["help@oa.works"],u="",this.params)u+=t+": "+JSON.stringify(this.params[t],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(r=this.params)?r.form:void 0)?o+=" Wrong article":"bug"===(null!=(s=this.params)?s.form:void 0)?o+=" Bug":"general"===(null!=(n=this.params)?n.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(a=null!=(l=this.params)?l.form:void 0)&&"uninstall"!==a||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:e=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:e}},e.cache=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==t&&(t=this.request);try{for(p=t.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)n=u[l],-1!==p.indexOf(n+"=")&&(a=new RegExp(n+"=.*?&"),p=p.replace(a,"")),-1!==p.indexOf("&"+n+"=")&&(p=p.split("&"+n+"=")[0]);s=new URL(p)}catch(t){}}catch(t){}if(null!=t)try{if(null==s&&(s=new URL(t.url)),r=new Request(s.toString().replace("?refresh=true","").replace("&refresh=true",""),t),null==e||""===e)return h=await caches.default.match(r),""===e&&this.waitUntil(caches.default.delete(r)),h;e=e.clone(),(c=new Response(e.body,e)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c))}catch(t){}}},e.cache._auth="system",g=[].indexOf,null==e.convert&&(e.convert={}),e.convert.json2csv=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_,x,O,S;if(null==t&&(t=null!=(y=this.body)?y:this.params),null==e&&(e=this.params),e.url&&(t=await this.fetch(e.url)),e.es||null!=(null!=t&&null!=(m=t.hits)?m.hits:void 0))try{t=t.hits.hits,e.es=!0}catch(t){}if(Array.isArray(t)||(t=[t]),h=null!=(v=e.quote)?v:'"',S=null!=(b=e.separator)?b:",",u=null!=(w=e.newline)?w:"\n",t.length){for(r=null!=(_=e.keys)?_:[],f="",s=0,l=t.length;s<l;s++){if(d=t[s],f.length&&(f+=u),!1!==e.es&&(d._source||d.fields)){for(c in p={},O=null!=(x=d._source)?x:d.fields)null==p[c]&&(p[c]=O[c]);d=p}if(e.flatten&&(d=await this.flatten(d)),e.subset&&(d=await this.dot(d,e.subset)),!e.keys)for(a in d)null!=d[a]&&g.call(r,a)<0&&r.push(a);for(n=0,o=r.length;n<o;n++){if(i=r[n],f.length&&!f.endsWith(u)&&(f+=S),f+=h,null!=d[i]){try{Array.isArray(d[i])&&1===d[i].length&&Array.isArray(d[i][0])&&(d[i]=d[i][0])}catch(t){}try{Array.isArray(d[i])&&d[i].length&&"object"!=typeof d[i][0]&&(d[i]=d[i].join(","))}catch(t){}try{"object"==typeof d[i]&&(d[i]=JSON.stringify(d[i]))}catch(t){}try{'"'===h&&-1!==d[i].indexOf(h)&&(d[i]=d[i].replace(/"/g,h+h))}catch(t){}try{d[i]=d[i].replace(/\n/g," ")}catch(t){}try{d[i]=d[i].replace(/\s\s/g," ")}catch(t){}try{f+=d[i]}catch(t){}}f+=h}}return h+r.join(h+S+h)+h+"\n"+f}return""},e.convert.csv2json=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if(null==e&&(e=this.params),null==t&&(t=null!=(d=this.body)?d:this.params.csv),(e.url||"string"==typeof t&&t.startsWith("http"))&&(t=await this.fetch(null!=(f=e.url)?f:t)),v=[],"string"==typeof t&&t.length&&(p=null!=(y=e.quote)?y:'"',w=null!=(m=e.separator)?m:",",c=null!=(g=e.newline)?g:"\n",(u=t.split(c)).length))for(r=u.shift().split(p+w),h="",s=0,a=u.length;s<a;s++)if((_=(h+=(h?c:"")+(o=u[s])).split(p+w)).length===r.length&&(!p||o.endsWith(p))){for(h="",b={},n=0,l=r.length;n<l;n++)if((i=r[n]).startsWith(p)&&(i=i.replace(p,"")),i.endsWith(p)&&(i=i.substring(0,i.length-1)),_.length&&(b[i]=_.shift(),b[i])){b[i].startsWith(p)&&(b[i]=b[i].replace(p,"")),!_.length&&b[i].endsWith(p)&&(b[i]=b[i].substring(0,b[i].length-1));try{b[i]=JSON.parse(b[i])}catch(t){}}v.push(b)}return v},e.convert.csv2html=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(null==t&&(t=null!=(h=this.body)?h:this.params.csv),null==e&&(e=this.params),(e.url||"string"==typeof t&&t.startsWith("http"))&&(t=await this.fetch(null!=(p=e.url)?p:t)),'"',y="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",y+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(t=t.replace(/,,/g,',"",'))&&t.length&&(o=t.split("\n")).length){for(y+="<thead><tr>",u=0,i=0,s=(d=o.shift().split('","')).length;i<s;i++)y+='<th style="padding:2px; border:1px solid #ccc;">'+d[i].replace(/"/g,"")+"</th>",u+=1;for(y+="</tr></thead>\n<tbody>\n",r=0,n=o.length;r<n;r++){for(l=o[r],y+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(g=0,c=0,a=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<a;c++)g+=1,y+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(m=(m=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===m.indexOf("{")||0===m.indexOf("[")?(y+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",y+=await this.convert.json2html(JSON.parse(m.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),y+="</div>"):y+=m.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),y+="</td>";for(;g<u;)y+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',g+=1;y+="</tr>\n"}y+="</tbody>\n"}return y+"</table>"},e.convert.json2html=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p;if(null==t&&(t=null!=(u=this.body)?u:this.params),null==e&&(e=this.params),e.url&&(t=await this.fetch(url)),e.new)for(null==e.edit&&(e.edit=!0),t={},r=0,n=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;r<n;r++)t[c[r]]="";if(e.subset&&!Array.isArray(t))for(o=e.subset.split(".");(l=o.shift())&&"object"==typeof t&&!Array.isArray(t)&&null!=t[l];)t=t[l];if(Array.isArray(t)||null!=(null!=t&&null!=(h=t.hits)?h.hits:void 0)&&!1!==e.es)return null!=o&&(e.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(t,e));if(p="<div>",e.flatten&&(t=await this.flatten(t),p+='<input type="hidden" id="options_flatten" value="true">'),e.subset){if(o.length)for(s=0,a=o.length;s<a;s++)t=t[o[s]];p+="<h3>"+e.subset+":</h3>",p+='<input type="hidden" id="options_subset" value="'+e.subset+'">'}return i=t=>{var r,s,n,a,l,o,u,c,h,d,f;if(e.edit&&null==t.comments&&(t.comments=""),e.keys)for(a=0,s=(c=e.keys).length;a<s;a++)null==t[u=c[a]]&&(t[u]="");for(r in d=[],t){try{Array.isArray(t[r])&&1===t[r].length&&Array.isArray(t[r][0])&&(t[r]=t[r][0])}catch(t){}if(null==t[r]||Array.isArray(t[r])&&!t[r].length||e.keys&&!(g.call(e.keys,r)>=0))d.push(void 0);else{if(p+='<div style="clear:both; '+(e.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",p+='<div style="float:left;">',p+=e.edit?'<textarea class="PForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(t[r]))if("object"==typeof t[r][0])for(l=0,n=(h=t[r]).length;l<n;l++)o=h[l],i(o);else{try{f=t[r].join(", ")}catch(e){try{f=JSON.stringify(t[r])}catch(e){f=t[r]}}try{p+=(e.edit?"":"<p>")+f+(e.edit?"":"</p>")}catch(t){}}else"object"==typeof t[r]?i(t[r]):p+=(e.edit?"":"<p>")+t[r]+(e.edit?"":"</p>");p+=e.edit?"</textarea>":"",d.push(p+="</div></div>")}}return d},i(t),p+="</div>"},e.convert.json2txt=async function(t){var e,i,r;return null==t&&(t=null!=(i=this.body)?i:this.params),this.params.url&&(t=await this.fetch(this.params.url)),r=[],e=async function(t){var i,s,n,a,l;if(Array.isArray(t)){for(a=[],s=0,n=t.length;s<n;s++)i=t[s],a.push(await e(i));return a}if("object"==typeof t){for(i in l=[],t)l.push(await e(t[i]));return l}if(t)return r.push(t)},await e(t),r.join(" ")},e.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},e.convert.hex2bin=function(t){var i,r,s,n,a;for(a=[],i=0,s=(n=Array.isArray(t)?t:[t]).length;i<s;i++)r=n[i],a.push(e.convert._hexMatch[r.toLowerCase()]);return a.join("")},e.convert.bin2hex=function(t){var i,r,s,n,a,l,o,u,c;if(!Array.isArray(t)){for(i=[],c=t.split(""),o="";c.length;)4===(o+=c.shift()).length&&(i.push(o),o="");t=i}for(n in u=[],r={},e.convert._hexMatch)r[e.convert._hexMatch[n]]=n;for(s=0,l=t.length;s<l;s++)a=t[s],u.push("0x"+r[a]);return new m(u).toString()},e.convert.buf2bin=async function(t){var i,r;for(m.isBuffer(t)&&(t=t.toString("hex")),t=t.replace(/^0x/,""),r="",i=0;i<t.length;)r+=await e.convert.hex2bin(t[i]),i++;return r},e.convert.stream2txt=function(t){var e;return e=[],new Promise(((i,r)=>(t.on("data",(t=>e.push(m.from(t)))),t.on("error",(t=>r(t))),t.on("end",(()=>i(m.concat(e).toString("utf8")))))))},e.convert.xml2json=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d,f,m,g;if(null==t&&(t=null!=(p=this.params.xml2json)?p:this.params.url),f={},"string"==typeof t)for(t.startsWith("http")&&(t=await this.fetch(t)),i="",u="",m=!1,r=!1;e=t[0];)if(t=t.slice(1),"\ufeff"!==e&&"\t"!==e&&"\r"!==e&&"\n"!==e&&(" "!==e||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==e&&"?"!==e&&"!"!==e&&(m=!0),((i+=e).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(r=!0),">"===e)){if(y.log(u),r){if(r=!1,""!==(i=i.split("</")[0])){if(h=await this.dot(f,u,void 0,void 0,!0))Array.isArray(h)?(h.length||(h=[{}]),null!=h[h.length-1].$?(Array.isArray(h[h.length-1].$)||(h[h.length-1].$=[h[h.length-1].$]),h[h.length-1].$.push(i)):h[h.length-1].$=i):h.$=i,i=h;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(t){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(m){for(m=!1,l={},s=0,a=(d=i.replace("<","").replace(">","").split(" ")).length;s<a;s++)(o=d[s]).includes("=")?o.length&&([n,g]=o.split("="),l[n.trim().replace(/"/g,"")]=g.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(h=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(h)||(h=[h]),h.push("{}"!==JSON.stringify(l)?{_:l}:{}),await this.dot(f,u,h,void 0,!0)):"{}"!==JSON.stringify(l)&&await this.dot(f,u+"._",l,void 0,!0)}i=""}return f},e.dateparts=async function(t){var e,i,r,s,n,a,l,o,u;e={},null==t&&(t=null!=(n=this.params.dateparts)?n:e.date);try{if("object"==typeof t){for(i in t)e[i]=t[i];t=null!=(a=e.date)?a:""}else if(null==t){for(i in params)null==e[i]&&(e[i]=this.params[i]);t=null!=(l=e.date)?l:""}if(("number"==typeof t||"string"==typeof t&&!t.includes(" ")&&!t.includes("/")&&!t.includes("-")&&t.length>8&&!t.includes("T"))&&(t=await this.date(t)),t.includes("T")&&t.includes("-")&&(t=t.split("T")[0]),(t=(t=t.trim().toLowerCase().replace(", "," ").replace(" of ","").replace("st "," ").replace("nd "," ").replace("rd "," ").replace("th "," ")).replace(/-/g," ").replace(/\//g," ")).includes(" "))for(i in s=t.split(" "))(r=s[i]).length>=3?isNaN(parseInt(r))?(e.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(r.toLowerCase().substr(0,3)),e.month="number"==typeof e.month&&e.month>=0?e.month+1:""):e.year=r:parseInt(r)<13&&(2===s.length||3===s.length&&"1"===i)?e.month=r:1===s.length?e.year=r:e.day=r;e.day=(null!=(o=e.day)?o:"01").toString(),1===e.day.length&&(e.day="0"+e.day),"string"==typeof e.month&&e.month.length&&isNaN(parseInt(e.month))&&(e.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(e.month.toLowerCase().substr(0,3)),e.month="number"==typeof e.month&&e.month>=0?e.month+1:""),e.month=(null!=(u=e.month)?u:"01").toString(),1===e.month.length&&(e.month="0"+e.month),e.year=e.year.toString(),2===e.year.length&&(e.year=parseInt(e.year)<30?"20":"19"+e.year),e.date=e.year+"-"+e.month+"-"+e.day;try{e.timestamp=await this.epoch(e.date)}catch(t){}}catch(t){}return e},e.dateparts._cache=!1,e.date=function(t,e,i=!0,r=!0){var s,n,a,l,o;if(null==t&&(t=null!=(a=this.params.date)?a:Date.now()),null==e&&(e=this.params.time),"number"==typeof t||"string"==typeof t&&!t.includes(" ")&&!t.includes("/")&&!t.includes("-")&&t.length>8&&!t.includes("T"))try{return o=(o=new Date(parseInt(t))).toISOString(),e?i?r||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(t){}try{if("number"==typeof t&&(t=t.toString()),Array.isArray(t)&&1===t.length&&Array.isArray(t[0])&&(t=t[0]),"string"!=typeof t)try{for(s in t)"number"!=(l=typeof t[s])&&"string"!==l&&(t[s]="01");t=t.join("-")}catch(t){}return(t=decodeURIComponent(t)).includes("T")&&(t=t.split("T")[0]),(t=t.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).includes("-")||(t+="-01-01"),3!==t.split("-").length&&(t+="-01"),3!==(n=t.split("-")).length&&(t=void 0),n[0].length<n[2].length&&(t=n.reverse().join("-")),t}catch(t){}},e.date._cache=!1,e.datetime=function(t,e){var i,r;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(r=null!=t?t:this.params.secs)?r:this.params.s,null!=e?e:this.params.ms)},e.datetime._cache=!1,e.epoch=function(t){var e,i,r,s,n,a;if(null==t&&(t=this.params.epoch),"number"==typeof t&&(t=t.toString()),"string"==typeof t&&t.includes("/")&&(3===(r=t.split("/")).length&&4===r[2].length&&r.reverse(),t=r.join("-")),!t)return Date.now();if(!(t.startsWith("+")||t.startsWith("-")||2===t.split("+").length&&t.split("+")[0].length>4||2===t.split("-").length&&t.split("-")[0].length>4)){if(t.length>8&&!t.includes("-")&&!isNaN(parseInt(t)))return this.date(t,null==(s=this.params.time)||s);for(4===t.length&&(t+="-01"),t.split("-").length<3&&(t+="-01"),t.includes("T")||(t+="T"),t.includes(":")||(t+="00:00"),t.split(":").length<3&&(t+=":00"),t.includes(".")||(t+="."),[n,i]=t.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return i.includes("Z")||(i+="Z"),new Date(n+"."+i).valueOf()}return(t.startsWith("+")||t.startsWith("-"))&&(t=Date.now()+t),t.includes("+")?([t,e]=t.replace("/","").split("+"),(parseInt(t)+parseInt(e)).toString()):t.includes("-")?([t,a]=t.replace("/","").split("-"),(parseInt(t)-parseInt(a)).toString()):void 0},e.epoch._cache=!1,e.uid=function(e){var i,r,s,n,a,l,o,u,c,h,p;return null==e&&(e="uid"===this.fn&&null!=(i=null!=(r=null!=(s=null!=(n=null!=this&&null!=(a=this.params)?a.len:void 0)?n:null!=this&&null!=(l=this.params)?l.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?r:null!=this&&null!=(u=this.params)?u.uid:void 0)?i:21),"string"==typeof e&&(p=parseInt(e),e=isNaN(p)?void 0:p),((t,e,i)=>{let r=(2<<Math.log(t.length-1)/Math.LN2)-1,s=-~(1.6*r*e/t.length);return()=>{let n="";for(;;){let a=i(s),l=s;for(;l--;)if(n+=t[a[l]&r]||"",n.length===e)return n}}})(null!=(c=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",e,t)()},e.uid._cache=!1,e.encrypt=async function(t){var e,i,r,s,n,a;null==t&&(t=null!=(i=null!=(r=null!=(s=null!=(n=this.params.encrypt)?n:this.params.content)?s:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(t=await this.fetch(this.params.url))}catch(t){}return"string"!=typeof t&&(t=JSON.stringify(t)),e=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(a=this.params.iv)?a:this.S.encrypt.iv),m.concat([e.update(t),e.final()]).toString("hex")},e.encrypt._cache=!1,e.encrypt._bg=!0,e.decrypt=async function(t){var e,i,r,s,n,a,l;null==t&&(t=null!=(r=null!=(s=null!=(n=null!=(a=this.params.decrypt)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body);try{this.params.url&&(t=await this.fetch(this.params.url))}catch(t){}return"object"==typeof t?(i=t.iv,t=t.content):i=null!=(l=this.params.iv)?l:this.S.encrypt.iv,"string"!=typeof t&&(t=JSON.stringify(t)),e=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),m.concat([e.update(m.from(t,"hex")),e.final()]).toString()},e.decrypt._cache=!1,e.decrypt._bg=!0,e.decrypt._auth="@oa.works",e.hash=async function(t){var e,i,r,s,n,a,l,o,u,c;null==t&&(t=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(t=await this.fetch(this.params.url))}catch(t){}"string"!=typeof t&&(t=JSON.stringify(t));try{for(t=(new TextEncoder).encode(t),r=await crypto.subtle.digest("SHA-256",t),e=new Uint8Array(r),a=[],s=0,n=e.length;s<n;s++)i=e[s],a.push(("00"+i.toString(16)).slice(-2));return a.join("")}catch(e){return crypto.createHash("sha256").update(t,"utf8").digest("hex")}},e.hashcode=function(t){var e,i,r,s,n,a;for(null==t&&(t=null!=(r=null!=(s=null!=(n=null!=(a=this.params.hashcode)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body),"string"!=typeof t&&(t=JSON.stringify(t)),e=0,i=0;i<t.length;)e=(e<<5)-e+t.charCodeAt(i),e&=e,i++;return e},e.hashhex=function(t){var e;return null==t&&(t=this.params.hashhex),(e=this.hashcode(t))<0&&(e=4294967295+e+1),e.toString(16)},e.shorthash=function(t,e){var i,r,s,n,a,l,o,u;for(null==t&&(t=null!=(s=null!=(n=null!=(a=null!=(l=this.params.shorthash)?l:this.params.content)?a:this.params.q)?n:this.params)?s:this.body),"string"!=typeof t&&(t=JSON.stringify(t)),r=this.hashcode(t),e?(u=e.substring(0,1),e=e.replace(u,"")):(e="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=e.length,o=r<0?u:"",r=Math.abs(r);r>=i;)o+=e[r%i],r=Math.floor(r/i);return o+(r>0?e[r]:"")},e.fetch=async function(t,e){var i,s,n,a,l,o,u,c,h,p,d,f,g,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V;if(null==t&&null==e)try{e=this.copy(this.params)}catch(t){}for("object"==typeof t&&null==e&&(t=(e=t).url),null==e&&(e={}),"number"==typeof e&&(e={cache:e}),"number"==typeof e.cache&&(null==e.cf&&(e.cf={cacheEverything:!0}),e.cf.cacheTtl=e.cache,delete e.cache),!t&&e.url&&(t=e.url,delete e.url),!0===e.bg&&"string"==typeof r.bg&&(e.url=t,t=r.bg+"/fetch",delete e.bg),e.username&&e.password&&(e.auth=e.username+":"+e.password,delete e.username,delete e.password),t.split("?")[0].includes("@")&&t.includes(":")&&t.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(e.auth=t.split("//")[1].split("@")[0],t=t.replace(e.auth+"@","")),e.auth&&(null==e.headers&&(e.headers={}),e.headers.Authorization="Basic "+m.from(e.auth).toString("base64"),delete e.auth),h=0,g=(N=["data","content","json"]).length;h<g;h++)null!=e[a=N[h]]&&(e.body=e[a],delete e[a]);if(null==e.attachment&&(e.attachment=e.attachments),null==e.file&&(e.file=e.attachment),null!=e.file){for(null==e.headers&&(e.headers={}),null!=e.body&&null==e.form&&(e.form=e.body),e.body=new FormData,Array.isArray(e.file)||(u="object"==typeof e.file&&null!=e.file.file?[{file:e.file.file,filename:null!=(L=null!=(q=e.file.filename)?q:e.file.name)?L:e.filename}]:[{file:e.file,filename:e.filename}],e.file=u),p=0,v=(U=e.file).length;p<v;p++)null==(null!=(c=U[p])?c.file:void 0)&&null==(null!=c?c.data:void 0)||e.body.append(null!=e.attachment?"attachment":"file",null!=(W=c.file)?W:c.data,null!=(B=null!=(M=null!=(z=c.filename)?z:c.name)?M:e.filename)?B:"file");delete e.filename,null==e.method&&(e.method="POST")}else null!=e.body&&(null==e.headers&&(e.headers={}),null==e.headers["Content-Type"]&&null==e.headers["content-type"]&&(e.headers["Content-Type"]="object"==typeof e.body?"application/json":"text/plain"),"object"!=(F=typeof e.body)&&"boolean"!==F&&"number"!==F||(e.body=JSON.stringify(e.body)),null==e.method&&(e.method="POST"));if(null!=e.form){if(null!=e.file){if("object"==typeof e.form)for(o in e.form)for(f=0,b=(J=Array.isArray(e.form[o])?e.form[o]:[e.form[o]]).length;f<b;f++)s=J[f],e.body.append(o,"object"==typeof s?JSON.stringify(s):s)}else{if(null==e.headers&&(e.headers={}),null==e.headers["Content-Type"]&&null==e.headers["content-type"]&&(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof e.form){for(j in A="",e.form)for(""!==A&&(A+="&"),x=0,w=(T=Array.isArray(e.form[j])?e.form[j]:[e.form[j]]).length;x<w;x++)null!=(I=T[x])&&(A.endsWith("&")||(A+="&"),A+=j+"="+encodeURIComponent("object"==typeof I?JSON.stringify(I):I));e.form=A}e.body=e.form}delete e.form,null==e.method&&(e.method="POST")}if(delete e.file,delete e.attachment,delete e.attachments,"string"!=typeof t);else{if(!t.startsWith("http:")&&t.includes("localhost"))try{null==e.agent&&(e.agent=new https.Agent({rejectUnauthorized:!1}))}catch(t){}if(t.includes("?")){for(k=(D=t.split("?")).shift()+"?",O=0,_=(P=D.join("?").split("&")).length;O<_;O++)C=P[O],k.endsWith("?")||(k+="&"),[d,V]=C.split("="),null==V&&(V=""),d&&(k+=encodeURIComponent(d)+(V?"="+(V.includes("%")?V:encodeURIComponent(V)):""));t=k}if(e.params&&"{}"!==JSON.stringify(e.params)){for(d in t.includes("?")||(t+="?"),R=e.params)V=R[d],t.endsWith("&")||t.endsWith("?")||(t+="&"),d&&(t+=encodeURIComponent(d)+"="+encodeURIComponent("object"==typeof V?JSON.stringify(V):V));delete e.params}r.system&&("string"==typeof r.bg&&t.startsWith(r.bg)||"string"==typeof r.async&&t.startsWith(r.async)||"string"==typeof r.kv&&r.kv.startsWith("http")&&t.startsWith(r.kv))&&(null==e.headers&&(e.headers={}),null==(n=e.headers)[S="x-"+r.name.toLowerCase()+"-system"]&&(n[S]=r.system),e.headers.Authorization||e.headers.authorization||e.headers["x-apikey"]||!this.user||(e.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,n,a,l,o,u,c;if(e.stream)return delete e.stream,fetch(t,e);i=!1,e.buffer&&(i=!0,delete e.buffer),c=await fetch(t,e);try{(!t.includes("localhost")||200!==(o=c.status)&&404!==o)&&r.dev&&!0===r.bg&&y.log(c.status+" "+t),e.verbose&&(c.status>300&&y.log(c.body),y.log(c.status+" "+t))}catch(t){y.log("Error logging to console for fetch"),y.log(c)}if(i)l=await c.buffer();else if("HEAD"===e.method)for(l={status:c.status},a=0,n=(u=[...c.headers]).length;a<n;a++)l[(s=u[a])[0]]=s[1];else{try{l=await c.text()}catch(t){}try{"string"==typeof l&&(l.startsWith("{")||l.startsWith("["))&&(l=JSON.parse(l))}catch(t){}}return 404!==c.status?c.status>=400?(r.dev&&!0===r.bg&&y.log(e,JSON.stringify(l),"FETCH ERROR",c.status),{status:c.status}):l:void 0};try{e.timeout&&null!=(null!=this?this._timeout:void 0)?(E=!0===e.timeout?3e4:e.timeout,delete e.timeout,$=await this._timeout(E,i())):$=await i();try{(($=$.trim()).startsWith("[")||$.startsWith("{"))&&($=JSON.parse($))}catch(t){}return $}catch(e){l=e,r.dev&&!0===r.bg&&y.log("ERROR TRYING TO CALL FETCH",t,l,JSON.stringify(l));try{this.log(l)}catch(t){}}}},e.fetch._auth="system",e._timeout=function(t,e){return new Promise(((e,i)=>{var r;return r=setTimeout((()=>i(new Error("TIMEOUT"))),t),promise.then(value((()=>(clearTimeout(r),e(value))))).catch(reason((()=>(clearTimeout(r),i(reason)))))}))},g=[].indexOf,null==r.index&&(r.index={}),null==(o=r.index).name&&(o.name=null!=(c=r.name)?c:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(u=r.index).url&&(u.url=r.bg+"/index"),e.index=async function(t,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if("object"==typeof t&&(i=t,t=void 0),null==t&&null==i&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(h=this.parts[1])||"src"===h))return{status:403};if("object"==typeof this.body?i=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(i=this.body):i=this.copy(this.params),delete i.route,delete i.index,delete i[this.fn.split(".").pop()],delete i._id,null!=i.script||-1!==JSON.stringify(i).toLowerCase().indexOf("<script"))return}if("object"!=typeof i||Array.isArray(i)||(null==t&&(t=null!=(p=i.route)?p:i.index),delete i.route,delete i.index),null==t)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in g=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||g.push(l);return g}2===this.parts.length?t=this.parts[1]:this.parts.length>2&&(t=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(t=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(t+="/"+this.parts.join("_").replace(t+"_","")));if("string"==typeof t)if(t.includes("?")?([t,_]=t.split("?"),_="?"+_):_="",t.endsWith("/")&&(t=t.replace(/\/$/,"")),"object"==typeof i&&!Array.isArray(i)&&i._id&&(a=(i=null!=(null!=this?this.copy:void 0)?this.copy(i):e.copy(i))._id.replace(/\//g,"_").toLowerCase(),-1===t.indexOf("/")&&-1===t.indexOf(a)&&(t+="/"+a),delete i._id,"{}"===JSON.stringify(i)&&(i=void 0)),w=(t=t.toLowerCase()).split("/").length,null==this.index&&(this.index=e.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===t.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===i)v=await this.index._send(t.replace("/","/_doc/")+_,"");else if(1===w){if("string"==typeof i&&(""===i||-1!==i.indexOf("\n"))||Array.isArray(i))return""===i?this.index._send(t+_,i):this.index._bulk(t+_,i);if("object"!=(d=typeof i)&&"string"!==d)return this.index._send(t+"/_search"+_);if("{}"!==JSON.stringify(i)&&(c=await this.index.translate(i,r)))return this.index._send(t+"/_search"+_,c);if("object"==typeof i){for(n=null!=(null!=this?this.copy:void 0)?this.copy(i):e.copy(i),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete n[f[o]];return"{}"===JSON.stringify(n)?(await this.index._send(t+_)||await this.index._send(t+_,{settings:i.settings,aliases:i.aliases,mappings:null!=(y=i.mappings)?y:i.mapping}),this.index._send(t+"/_search"+_)):"created"===(null!=(v=await this.index._send(t+"/_doc"+_,i))?v.result:void 0)&&v._id?v._id:v}}else if(2===w&&(null==i||"object"==typeof i&&!Array.isArray(i)))return t.startsWith("_")||t.includes("/_")||(t=t.replace("/","/_doc/")),null!=i&&"{}"!==JSON.stringify(i)?("object"==typeof i&&null!=i.script&&(t+="_update",_+=(_.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(v=await this.index._send(t+_,i))?v.result:void 0)&&v._id?v._id:v):("object"==typeof(v=await this.index._send(t+_))&&(v._source||v.fields)&&(null==(b=null!=(m=v._source)?m:v.fields)._id&&(b._id=v._id),v=b),v)},e.index._auths="system",e.index._caches=!1,e.index.status=async function(){var t,e,i,r,s,n,a,l,o,u,c,h,p,d,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(t){}for(i in c.indices={},h=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),h.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:h.indices[i].primaries.docs.count,size:Math.ceil(h.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,a=d.length;r<a;r++)(p=d[r]).index===i&&"p"===p.prirep&&(null==(t=c.indices[i]).shards&&(t.shards=0),c.indices[i].shards+=1,null==(e=c.indices[i]).failed&&(e.failed=0),"UNASSIGNED"===p.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(t){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),n=0,l=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;n<l;n++)s=u[n],delete c.cluster[s]}catch(t){}return c},e.index.keys=async function(t,e){var i,r,s,n,a,l;return null==t&&(t=null!=(n=null!=(a=this.params.index)?a:this.params.keys)?n:this.fn.replace(/\./g,"/")),t=t.replace("index/","").replace("/keys",""),null==e&&(e=null!=(l=this.params.type)?l:this.params.types),"string"==typeof e&&(e=[e]),r=!0===e?{}:[],s="object"==typeof t?t:await this.index.mapping(t),i=async(t,s="")=>{var n,a,l,o;for(n in s&&(s+="."),o=[],t)null!=t[n].properties?o.push(await i(t[n].properties,s+n)):!e||!0===e||(a=t[n].type,g.call(e,a)>=0)?!0===e?o.push(r[s+n]=t[n].type):(l=s+n,g.call(r,l)<0?o.push(r.push(s+n)):o.push(void 0)):o.push(void 0);return o},"object"==typeof s&&await i(s),r},e.index.terms=async function(t,e,i,r=100,s=!0,n="count"){var a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;if(null==t&&(t=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),t=t.replace("index/","").replace("/terms",""),!e||!i){if(null==e&&(e=null!=(y=this.params.terms)?y:this.params.key),null==e&&-1!==t.indexOf("/")&&([t,e]=t.split("/")),!e)return[];for(a=this.copy(this.params),l=0,u=(m=["index","route","terms","key"]).length;l<u;l++)delete a[m[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(a)),d="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:e}}]}}},"string"==typeof i&&d.query.bool.must.push({query_string:{query:i}}),null==d.aggregations&&(d.aggregations={}),null==d.size&&(d.size=0),null!=this.params.size&&(r=this.params.size),null!=this.params.counts&&(s=this.params.counts),null!=this.params.order&&(n=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof n&&null!=h[n]&&(n=h[n]),d.aggregations[e]={terms:{field:e+(e.endsWith(".keyword")?"":".keyword"),size:r,order:n}},_=[],o=0,c=(w=null!=(g=null!=(x=await this.index._send("/"+t+"/_search",d,"POST"))&&null!=(v=x.aggregations)&&null!=(b=v[e])?b.buckets:void 0)?g:[]).length;o<c;o++)p=w[o],_.push(s?{term:p.key,count:p.doc_count}:p.key);return _},e.index.suggest=async function(t,e,i,r=100,s){var n,a,l,o,u,c,h,p,d,f,y,m,v;if(e&&i||(null==e&&(e=null!=(p=this.params.suggest)?p:this.params.key),"string"==typeof e&&e.includes("/")&&([e,i]=e.split("/"))),!e)return this.index.keys(t,"text");if(null==t&&(t=null!=(d=this.params.index)?d:this.fn.replace(/\./g,"/")),t=t.replace("index/","").split("/suggest")[0],null==s&&(s=this.params.include),"string"==typeof s&&(s=s.replace(/,\s/g,",").split(",")),Array.isArray(s)&&g.call(s,e)<0&&s.push(e),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(v={should:[{match:{}},{prefix:{}},{query_string:{query:e+":"+i.split(" ").join(" AND "+e+":")+"*"}}]}).should[0].match[e]={query:i,boost:3},v.should[1].prefix[e]={value:i,boost:2}),y=[],m=[],s){for await(h of this.index._for(t,null!=v?v:i,{sort:e+".keyword",until:r,include:!0===s?[e]:s}))if(l=await this.dot(h,e)){for(;Array.isArray(l)&&(n=l.shift());)n.toLowerCase().includes(c)&&(l=n);o=l.toLowerCase(),g.call(m,o)<0&&(!c||o.includes(c))&&y.push(h),m.push(o)}}else for(a=0,u=(f=await this.index.terms(t,e,null!=v?v:i,r,!1,"term")).length;a<u;a++)o=(l=f[a]).toLowerCase(),g.call(m,o)<0&&(!c||o.includes(c))&&y.push(l),m.push(o);return y},e.index.count=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d;for(null==i&&(i=null!=(l=this.params.count)?l:this.params.key),null==t&&(t=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(t=t.replace("index/","").split("/count")[0]).indexOf("/")&&([t,i]=t.split("/")),r=this.copy(this.params),s=0,n=(u=["index","route","count","key"]).length;s<n;s++)delete r[u[s]];return null==e&&(a=await this.index.translate(r))&&(e=a),"string"==typeof e&&(e=await this.index.translate(e)),null==e&&(e={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),e.size=0,e.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(d=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(c=d.aggregations)&&null!=(h=c.keyed)?h.value:void 0):null!=(d=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(p=d.hits)?p.total:void 0},e.index.percent=async function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d,f,y;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==t&&(t=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(t=t.replace("index/","").split("/count")[0]).indexOf("/")&&([t,i]=t.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","count","key"]).length;n<a;n++)delete s[c[n]];return null==e&&(l=await this.index.translate(s))&&(e=l),"string"==typeof e&&(e=await this.index.translate(e)),null==e&&(e={query:{bool:{must:[],filter:[]}}}),y=await this.index.count(t,"*"),r=0,i?(i.endsWith(".keyword")||(i+=".keyword"),e.size=0,e.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},r=null!=(f=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(h=f.aggregations)&&null!=(p=h.keyed)?p.value:void 0):r=null!=(f=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(d=f.hits)?d.total:void 0,Math.ceil(r/y*1e4)/100},e.index.min=async function(t,e,i,r="min"){var s,n,a,l,o,u,c,h;for(null==e&&(e=null!=(o=this.params[r])?o:this.params.key),null==t&&(t=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(t=t.replace("index/","").replace("/"+r,"")).indexOf("/")&&([t,e]=t.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","min","max","key","sum","average"]).length;n<a;n++)delete s[c[n]];return null==i&&(i=await this.index.translate(s)),(l="object"==typeof e?e:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:e}}]}}}).size=0,"sum"===r?l.aggs={sum:{sum:{field:e}}}:"average"===r?l.aggs={average:{avg:{field:e}}}:(l.aggs={},"min"!==r&&"range"!==r||(l.aggs.min={min:{field:e}}),"max"!==r&&"range"!==r||(l.aggs.max={max:{field:e}})),h=await this.index._send("/"+t+"/_search",l,"POST"),"range"===r?{min:h.aggregations.min.value,max:h.aggregations.max.value}:h.aggregations[r].value},e.index.max=function(t,e,i){return this.index.min(t,e,i,"max")},e.index.range=function(t,e,i){return this.index.min(t,e,i,"range")},e.index.sum=function(t,e,i){return this.index.min(t,e,i,"sum")},e.index.average=function(t,e,i){return this.index.min(t,e,i,"average")},e.index.mapping=async function(t){var e;return-1===(t=t.replace(/^\//,"")).indexOf("/")&&(t+="/"),-1===t.indexOf("_mapping")&&(t=t.replace("/","/_mapping")),(e=await this.index._send(t))[(await this.keys(e))[0]].mappings.properties},e.index._for=async function*(t,e,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,g;for("number"==typeof i&&(i={until:i}),(null!=i?i.scroll:void 0)?("number"!=typeof(g=i.scroll)&&g.endsWith("m")||(g+="m"),delete i.scroll):g="2m",((null!=i?i.until:void 0)||(null!=i?i.max:void 0))&&(a=null!=(c=i.until)?c:i.max,delete i.until,delete i.max),null==e&&(e="*"),null==(o=await this.index.translate(e,i)).from&&(o.from=0),null==o.size&&(o.size=500),null==o.sort&&(o.sort=["_doc"]),(null!=(y=await this.index._send(t+"/_search?scroll="+g,o,void 0,r,s))?y._scroll_id:void 0)&&(l=y._scroll_id.replace(/==$/,"")),(null!=y&&null!=(h=y.hits)?h.total:void 0)&&(null==a||a>y.hits.total)&&(a=y.hits.total),n=0;;){if((null!=y&&null!=(p=y.hits)?p.hits:void 0)&&0!==y.hits.hits.length||!(null!=y?y._scroll_id:void 0)||(null!=(y=await this.index._send("/_search/scroll?scroll="+g+"&scroll_id="+y._scroll_id,void 0,void 0,r,s))?y._scroll_id:void 0)!==l&&(await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,r,s),l=null!=y?y._scroll_id:void 0),n===a||null==(null!=y&&null!=(d=y.hits)?d.hits:void 0)||!y.hits.hits.length){l&&await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,r,s);break}n+=1,null==(m=null!=(f=(u=y.hits.hits.shift())._source)?f:u.fields)._id&&(m._id=u._id),yield m}},e.index._each=async function(t,e,i,r,s,n){var a,l,o,u,c,h,p,d,f,g,v;for await(p of(null==r&&null==i&&"function"==typeof e&&(r=e,e="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(a=i,i=void 0),(null!=i?i.action:void 0)&&(a=i.action,delete i.action),(g=null!=(d=i.size)?d:"object"==typeof e&&null!=e.size?e.size:1e3)>50&&((h=await this.index.translate(e,i)).size=1,null!=(null!=(l=await this.index._send(t,h,void 0,s,n))&&null!=(f=l.hits)?f.total:void 0)&&0!==l.hits.total&&(u=Math.floor(1e9/(m.byteLength(JSON.stringify(l.hits.hits[0]))*l._shards.total)))<g&&(g=u),h.size=g),c=0,v=[],this.index._for(t,null!=h?h:e,i,s,n)))c+=1,null==(o=await r.call(this,p))||"object"!=typeof o&&"string"!=typeof o||v.push(o),a&&v.length>g&&(await this.index._bulk(t,v,a,void 0,s,n),v=[]);if(a&&v.length&&this.index._bulk(t,v,a,void 0,s,n),this.S.dev&&!0===this.S.bg)return y.log("_each processed "+c)},e.index._bulk=async function(t,i,r="index",s=5e4,n,a){var l,o,u,c,h,p,d,f,m,g,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T;if(!0===r&&(r="index"),T=t.split("/")[0],o=await this.dot(e,T.replace(/_/g,".")),null==a&&(a=null!=(v=null!=(x=this.params._alias)?x:null!=(O=this.S.alias)?O[T.startsWith(this.S.index.name+"_")?T.replace(this.S.index.name+"_",""):T]:void 0)?v:null!=o?o._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),(T=t.split("/")[0]).endsWith(a)||(t=t.replace(T,T+a))),null==n&&(n=null!=o?o._prefix:void 0),!1!==n&&(t=("string"==typeof n?n:this.S.index.name)+"_"+t),null==this.index&&(this.index=e.index),"string"==typeof i&&-1!==i.indexOf("\n"))return await this.index._send("/_bulk",{body:i,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,a),!0;for(g in N="object"!=typeof i||Array.isArray(i)||null==(null!=i&&null!=(S=i.hits)?S.hits:void 0)?i:i.hits.hits,Array.isArray(N)||(N=[N]),l=0,u=0,m="",N)if(l+=1,"object"==typeof(C=N[g])&&("string"==typeof(D=null!=(k=null!=(j=C._id)?j:null!=(A=C._source)?A._id:void 0)?k:await this.uid())&&(D=D.replace(/\//g,"_")),C._source&&(C=C._source),delete C._id),(f={})[r]={_index:t},f[r]._id="delete"!==r||"string"!=(I=typeof C)&&"number"!==I?D:C,m+=JSON.stringify(f)+"\n","create"===r||"index"===r?m+=JSON.stringify(C)+"\n":"update"===r&&(m+=JSON.stringify({doc:C})+"\n"),l===s||parseInt(g)===N.length-1||m.length>7e7){if(L=await this.index._send("/_bulk",{body:m,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,a),(null!=this&&null!=(E=this.S)?E.dev:void 0)&&!0===(null!=this&&null!=(b=this.S)?b.bg:void 0)&&(null!=L?L.errors:void 0)){for(c=[],p=0,d=(w=L.items).length;p<d;p++){h=w[p];try{200!==(_=h[r].status)&&201!==_&&(c.push(h[r]),u+=1)}catch(t){u+=1}}try{y.log(c)}catch(t){}try{y.log(0===c.length?"SOME":c.length,"INDEX ERRORS BULK LOADING",L.items.length)}catch(t){}}m="",l=0}return N.length-u},e.index.translate=function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,S,k,j,A,I,E,D,C,N,L,T,P,R,q,U,W,B,M,z,F,J,$,V,G,X,Y,H,Z,K,Q,tt,et,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==t&&(t=null!=this?this.params:void 0),"string"==typeof t){if(""===t||-1!==t.indexOf("\n"))return}else{if("object"!=typeof t||Array.isArray(t))return;for(m=0,b=(T=["settings","aliases","mappings","index","_id"]).length;m<b;m++)if(null!=t[g=T[m]])return;if(L=!1,t.source)try{L=JSON.parse(decodeURIComponent(t.source))}catch(t){}if("{}"!==JSON.stringify(t)&&null==t.q&&null==t.query&&!1===L&&null==t.must&&null==t.should&&null==t.must_not&&null==t.filter&&null==t.aggs&&null==t.aggregations)return}try{"object"==typeof t&&(t=this.copy(t))}catch(t){}try{"object"==typeof e&&(e=this.copy(e))}catch(t){}if(null==e&&(e={}),("string"==typeof e||Array.isArray(e))&&(e={fields:e}),"random"===e&&(e={random:!0}),"number"==typeof e&&(e={size:e}),!0===e&&(e={newest:!0}),!1===e&&(e={newest:!1}),null!=e.newest&&(e.sort={createdAt:e.newest?"desc":"asc"},delete e.newest),null==(N=null!=($=null!=e?e.query:void 0)?$:{}).query&&(N.query={}),null==(n=N.query).bool&&(n.bool={must:[],filter:[]}),"string"==typeof t)at={query_string:{query:t}},null!=(null!=e?e.fields:void 0)&&(at.query_string.fields="string"==typeof e.fields?e.fields.split(","):e.fields,delete e.fields),N.query.bool.filter.push(at);else if("object"==typeof t)if(null!=t.query)N=t;else for(I in null!=t.source?"string"==typeof t.source&&"object"==typeof L?N=L:"object"==typeof t.source&&(N=t.source):null!=t.q&&("object"==typeof t.q?N.query=t.q:(t.q=decodeURIComponent(t.q),null!=t.prefix&&-1!==t.q.indexOf(":")?(delete t.prefix,(D={})[(C=t.q.split(":"))[0]]=C[1],N.query.bool.must.push({prefix:D})):null!=t.fields?(N.query.bool.filter.push({query_string:{query:t.q,fields:t.fields.split(",")}}),delete t.fields):N.query.bool.filter.push({query_string:{query:t.q}}))),t)null==e[I]&&(e[I]=t[I]);if(null!=(null!=(Y=N.query)&&null!=(H=Y.filtered)&&null!=(Z=H.query)?Z.bool:void 0)&&(N.query.bool=N.query.filtered.query.bool,N.query.bool.filter=N.query.filtered.filter,delete N.query.filtered),null!=N.facets&&(N.aggregations=JSON.parse(JSON.stringify(N.facets).replace(/\.exact/g,".keyword")),delete N.facets),null!=N.query&&null==N.query.bool&&"{}"!==JSON.stringify(N.query)&&(N.query={bool:{must:[],filter:[N.query]}}),null==N.query&&(N.query={bool:{must:[],filter:[]}}),null==(a=N.query).bool&&(a.bool={must:[],filter:[]}),null==(l=N.query.bool).filter&&(l.filter=[]),"string"==typeof e.sort){for(nt=[],v=0,w=(K=e.sort.split(",")).length;v<w;v++)st=K[v],[g,I]=st.split(":"),I?(nt.push({}),nt[nt.length-1][g.trim()]=I.trim()):nt.push(g.trim());e.sort=nt}if(e.random&&(d={function_score:{random_score:{}}},null!=e.seed&&(d.function_score.random_score.seed=seed),d.function_score.query=N.query,N.query=d,delete e.random,delete e.seed),(y=null!=(Q=null!=(tt=null!=(et=e._include)?et:e.include)?tt:e._includes)?Q:e.includes)&&(null==N._source&&(N._source={}),N._source.includes="string"==typeof y?y.replace(/,\s/g,",").split(","):y),h=null!=(P=null!=(R=null!=(q=e._exclude)?q:e.exclude)?R:e._excludes)?P:e.excludes)for(null==N._source&&(N._source={}),N._source.excludes="string"==typeof h?h.replace(/,\s/g,",").split(","):h,A=0,_=(B=null!=(U=null!=(W=N._source)?W.includes:void 0)?U:[]).length;A<_;A++)f=B[A],N._source.excludes=N._source.excludes.filter((function(t){return t!==f}));for(lt=0,x=(M=["filter","restrict","must","and","must_not","not","should","or"]).length;lt<x;lt++)if(null!=e[ut=M[lt]])for(j=Array.isArray(e[ut])?e[ut]:[e[ut]],delete e[ut],c="filter"===ut||"restrict"===ut||"must"===ut||"and"===ut?"filter":"must_not"===ut||"not"===ut?"must_not":"should",null==(o=N.query.bool)[c]&&(o[c]=[]),ct=0,O=j.length;ct<O;ct++)"object"==typeof(rt=j[ct])?1===(it=this.keys(rt)).length&&"object"!=typeof rt[it[0]]&&(rt={term:rt}):rt={query_string:{query:rt}},N.query.bool[c].push(rt);if(null!=e.terms){try{e.terms=e.terms.replace(/,\s/g,",").split(",")}catch(t){}for(null==N.aggregations&&(N.aggregations={}),pt=0,S=(z=e.terms).length;pt<S;pt++)ot=z[pt],N.aggregations[ot]={terms:{field:ot+(ot.endsWith(".keyword")?"":".keyword"),size:1e3}};delete e.terms}for(dt=0,k=(F=["aggs","aggregations"]).length;dt<k;dt++)if(null!=e[i=F[dt]]){for(p in null==N[i]&&(N[i]={}),e[i])N[i][p]=e[i][p];delete e[i]}for(g in e){if(ht=e[g],("from"===g||"size"===g)&&"number"!=typeof ht)try{ht=parseInt(ht),isNaN(ht)&&(ht=void 0)}catch(t){}null!=ht&&"apikey"!==g&&"_"!==g&&"callback"!==g&&"refresh"!==g&&"key"!==g&&"counts"!==g&&"index"!==g&&"search"!==g&&"source"!==g&&"q"!==g&&"_alias"!==g&&"include"!==(J=g.replace("_","").replace("s",""))&&"exclude"!==J&&(N[g]=ht)}try{for(r in E={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},N.aggregations)"string"==typeof(null!=(V=N.aggregations[r].terms)?V.order:void 0)&&null!=E[N.aggregations[r].terms.order]&&(N.aggregations[r].terms.order=E[N.aggregations[r].terms.order])}catch(t){}if(null!=(null!=(G=N.query)?G.bool:void 0))for(u in N.query.bool)for(s in N.query.bool[u])"string"==typeof(null!=(X=N.query.bool[u][s].query_string)?X.query:void 0)&&-1!==N.query.bool[u][s].query_string.query.indexOf("/")&&-1===N.query.bool[u][s].query_string.query.indexOf('"')&&(N.query.bool[u][s].query_string.query='"'+N.query.bool[u][s].query_string.query+'"');return null!=N._source&&null!=N.fields&&delete N._source,N},e.index.translate._auth=!1,e.index._send=async function(t,i,s,n,a){var l,o,u,c,h,p,d,f,m,g,v,b,w,_,x;if(t.includes("?")?([t,w]=t.split("?"),w="?"+w):w="",(t=t.toLowerCase()).startsWith("/")&&(t=t.replace("/","")),t.endsWith("/")&&(t=t.replace(/\/$/,"")),null==s&&(s=""===i?"DELETE":null==i||-1!==t.indexOf("/")&&-1===t.indexOf("/_create")&&(-1===t.indexOf("/_doc")||t.endsWith("/_doc"))?null!=i||"_refresh"===(c=t.split("/").pop().split("?")[0])||"_aliases"===c?"POST":"GET":"PUT"),"DELETE"===s&&-1!==t.indexOf("/_all"))return!1;if(!t.startsWith("http")){if(_=t.split("/")[0],l=await this.dot(e,_.replace(/_/g,".")),null==a&&(a=null!=(h=null!=(p=this.params._alias)?p:null!=(d=this.S.alias)?d[_.startsWith(this.S.index.name+"_")?_.replace(this.S.index.name+"_",""):_]:void 0)?h:null!=l?l._alias:void 0),"string"!=typeof a||t.startsWith("_")||(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),_.endsWith(a)||(t=t.replace(_,_+a))),!this.S.index.name||t.startsWith(this.S.index.name)||t.startsWith("_")||(null==n&&(n=null!=l?l._prefix:void 0),!1!==n&&(t=("string"==typeof n?n:this.S.index.name)+"_"+t)),x=(null!=this&&null!=(f=this.S)&&null!=(m=f.index)?m.url:void 0)?this.S.index.url:null!=(g=r.index)?g.url:void 0,Array.isArray(x)&&(x=x[Math.floor(Math.random()*x.length)]),"string"!=typeof x)return;t=x+"/"+t}if(t.startsWith("http")){if(u=!1,t.includes("/_search")&&"object"==typeof i&&(null!=i.scroll_id||i.scroll)&&(!0===i.scroll&&(i.scroll="2m"),("number"==typeof i.scroll||"string"==typeof i.scroll&&!i.scroll.endsWith("m"))&&(i.scroll+="m"),t+=(-1===t.indexOf("?")?"?":"&")+"scroll="+(null!=(v=i.scroll)?v:"2m"),i.scroll_id?(u=i.scroll_id,t=t.split("://")[0]+"://"+t.split("://")[1].split("/")[0]+"/_search/scroll"+(t.includes("?")?"?"+t.split("?")[1]:""),t+=(-1===t.indexOf("?")?"?":"&")+"scroll_id="+i.scroll_id,i=void 0):(delete i.scroll_id,delete i.scroll)),o=-1!==(t=t+=w).indexOf("/_bulk")||"object"==typeof i&&"object"==typeof i.headers?i:{body:i},-1===t.indexOf("/_search")||"GET"!==s&&"POST"!==s||(t+=(-1===t.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),o.method=s,!(null==(b=await this.fetch(t,o))||"object"==typeof b&&"number"==typeof b.status&&b.status>=400&&b.status<=600)){if(this.S.dev&&"object"==typeof b&&null!=b.hits){try{null!=(null!=i?i.query:void 0)&&(b.q=i)}catch(t){}try{a&&(b._alias=a)}catch(t){}}return(null!=b?b._scroll_id:void 0)&&(b._scroll_id=b._scroll_id.replace(/==$/,"")),u&&u!==(null!=b?b._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+u,""),b}}else y.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!i.g[r.kv]&&(i.g[r.kv]={},i.g[r.kv].get=function(t){return e.fetch(r.kv+"/"+t)},i.g[r.kv].getWithMetadata=async function(t){return{value:await e.fetch(r.kv+"/"+t),metadata:{}}},i.g[r.kv].put=function(t,i){return e.fetch(r.kv+"/"+t,{body:i})},i.g[r.kv].delete=function(t){return e.fetch(r.kv+"/"+t,{method:"DELETE"})},i.g[r.kv].list=function(t){return null==t&&(t={}),e.fetch(r.kv+"/list"+(t.prefix?"/"+t.prefix:"")+(t.cursor?"?cursor="+t.cursor:""))}),e.kv=async function(t,e,r,s,n){var a,l,o,u,c,h,p,d,f,y,m,g,v,b;if(null==t&&(t=null!=(p=null!=(d=this.params.kv)?d:this.params.key)?p:this.parts.join("_"),null==e)){if("DELETE"===this.request.method)e="";else if(this.body)e=this.body;else if(this.params.val)e=this.params.val;else{for(e=this.params,a=0,u=(f=["key","kv","refresh","apikey"]).length;a<u;a++)delete e[o=f[a]];for(l=0,c=(y=this.parts).length;l<c;l++)delete e[o=y[l]]}"string"!=typeof e||0!==e.indexOf("[")&&0!==e.indexOf("{")||(e=JSON.parse(e)),"{}"!==(m=JSON.stringify(e))&&"[]"!==m||(e=void 0)}if("object"!=typeof e||"{}"!==(g=JSON.stringify(e))&&"[]"!==g||(e=void 0),"object"==typeof t&&null==e&&(t=null!=(v=(e=t)._id)?v:await this.uid()),null!=t&&this.S.kv&&i.g[this.S.kv]){if(null!=e&&""!==e){if(h={metadata:s},"number"==typeof r&&(1e3*r>Date.now()?h.expiration=r:h.expirationTtl=r),"object"==typeof e&&(!0===r&&(r=await this.kv(t)),"object"==typeof r))for(o in r)null==e[o]&&(e[o]=r[o]);return this.waitUntil(i.g[this.S.kv].put(t,"object"==typeof e?JSON.stringify(e):e,h)),e}if(({value:b,metadata:s}=await i.g[this.S.kv].getWithMetadata(t,n)),null!=b){try{b=JSON.parse(b)}catch(t){}try{s=JSON.parse(s)}catch(t){}return""===e&&this.waitUntil(i.g[this.S.kv].delete(t)),!0===s?{value:b,metadata:s}:b}}},e.kv._auths="system",e.kv._caches=!1,e.kv.list=async function(t,e){var r,s;try{null==t&&(t=null!=(r=null!=(s=this.params.kv)?s:this.params.prefix)?r:this.params.list)}catch(t){}try{null==e&&(e=this.params.cursor)}catch(t){}return await i.g[this.S.kv].list({prefix:t,cursor:e})},e.kv.count=async function(t){var e,r,s,n,a,l,o,u,c;if(r=0,this.S.kv&&null!=i.g[this.S.kv])for(null==t&&(t=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),e=!1,s=void 0;!e;){for(s=(l=await i.g[this.S.kv].list({prefix:t,cursor:s})).cursor,n=0,a=(c=l.keys).length;n<a;n++)c[n],r+=1;e=l.list_complete}return r},e.kv.prefixes=async function(){var t;return t={},await this.kv._each(void 0,(function(e){var i;return i=e.split("/")[0],null==t[i]&&(t[i]=0),t[i]+=1})),t},e.kv.clear=function(t){var e;if(this.S.dev)return null==t&&(t=null!=(e=this.params.clear)?e:this.params.kv),this.waitUntil(this.kv._each(t,(function(t){return this.waitUntil(i.g[this.S.kv].delete(t))}))),!0},e.kv.delete=async function(t){var e,i,r,s;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==t&&(t=null!=(i=null!=(r=this.params.kv)?r:this.params.delete)?i:this.params.prefix),s=e=await this.fetch(this.S.kv+"/count"+(t?"/"+t:""));e&&"0"!==e;)this.S.dev&&y.log(t,e),await this.fetch(this.S.kv+"/clear"+(t?"/"+t:"")),await this.sleep(500),e=await this.fetch(this.S.kv+"/count"+(t?"/"+t:""));return s}},e.kv.delete._bg=!0,e.kv._each=async function(t,e){var r,s,n,a,l,o,u,c;if(this.S.kv&&null!=i.g[this.S.kv]){for("function"==typeof t&&null==e&&(e=t,t=void 0),r=!1,s=void 0,c=[];!r;){for(s=(o=await i.g[this.S.kv].list({prefix:t,cursor:s})).cursor,n=0,l=(u=o.keys).length;n<l;n++)a=u[n],"function"==typeof e?this.waitUntil(e.call(this,a.name)):""===e?this.waitUntil(i.g[this.S.kv].delete(a.name)):null!=e&&this.waitUntil(this.kv(a.name,e));c.push(r=o.list_complete)}return c}},null==r.log&&(r.log={}),p=[],d=!1,h=!1,e.log=function(t,e){var i,s,n,a,l,o,u,c,f,m;if(i=async()=>{var t,e;for(!1!==d&&clearTimeout(d),d=setTimeout(i,3e4),h=Date.now(),e=new Date(h).toISOString().replace("T"," ").split(".")[0],t=[];t.length<400&&p.length;)t.push(p.shift());return t.length?(!0===this.S.bg&&y.log("Writing "+t.length+" logs to index",t[0]._id,t[t.length-1]._id,e),await this.index("logs",t)||(await this.index("logs",{}),await this.index("logs",t)),[]):!0===this.S.bg?y.log("Checked log batch but none to save",e):void 0},!1!==this.S.log&&!0!==this.nolog){if(!0!==e&&(e=null==t),"string"==typeof t)t=-1!==t.indexOf("/")&&-1===t.indexOf(" ")?{fn:t}:{msg:t};else if(Array.isArray(t)){for(s=0,l=t.length;s<l;s++)a=t[s],this._logs.push(a);t=void 0}if(null==t){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return p.push(this.body),!1===d&&i(),!0;t="object"==typeof this.body?this.body:this.params,Array.isArray(t)&&(t={logs:t})}null==t&&(t={});try{t.request={url:this.request.url,method:this.request.method}}catch(t){}try{t.request.body=null!=this.body}catch(t){}try{t.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(t){}try{t.request.headers=this.headers,t.request.headers.cookie&&(t.cookie=!0,delete t.request.headers.cookie)}catch(t){}try{null==t.fn&&null!=this.fn&&(t.fn=this.fn),this.refresh&&(t.refresh=this.refresh),t.parts=this.parts,this.completed&&(t.completed=this.completed),this.cached&&(t.cached=this.cached)}catch(t){}try{for(u in t.params={},this.params)t.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(t){}try{t.apikey=null!=this.apikey}catch(t){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(t.user=this.user._id)}catch(t){}this.unauthorised&&(t.unauthorised=!0)}if(e){if(!t.logs&&(t.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(n=0,o=(f=this._logs).length;n<o;n++)(a=f[n]).alert&&null==t.alert&&(t.alert=a.alert),a.notify&&null==t.notify&&(t.notify=a.notify),t.logs.push(a);t.createdAt=new Date,null==t.name&&(t.name=r.name),null==t.version&&(t.version=r.version),t.base=this.base,this.domain&&(t.domain=this.domain),!0===this.S.bg&&(t.bg=!0),!0===this.system&&(t.system=!0),!0===this.scheduled&&(t.scheduled=!0);try{t.started=this.started,t.took=Date.now()-this.started}catch(t){}if(t._id=this.rid,null!=(null!=(m=this.S.index)?m.url:void 0))!0===this.S.bg?(p.push(t),("object"==typeof this.S.log&&!1===this.S.log.batch||p.length>300||!1===h||Date.now()>h+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(p.push(t),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:t}));else try{this.kv("logs/"+t._id,t)}catch(e){y.log("Logging unable to save to kv or index"),consolg.log(t)}}else this._logs.push(t)}else this.S.dev&&!0===this.S.bg&&y.log("NOT logging",t);return!0},e.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(t){r.mail={}}e.mail=async function(t){var i,s,n,a,l,o,u,c,h,p,d,f,m,g,v,b,w,_,x,O,S,k,j,A;if(null!=(h=r.mail)?h.disabled:void 0)return{};if("string"==typeof t&&(t={text:t}),null==t&&(t=null!=(p=this.copy(null!=this?this.params:void 0))?p:{}),t.template){for(o in u=await this.template(t.template,null!=(b=null!=(w=t.vars)?w:t.params)?b:t))t[o]=u[o];delete t.template,delete t.vars,delete t.params}if(!t.text&&!t.html&&(t.text=null!=(_=null!=(x=null!=(O=null!=(S=t.content)?S:t.msg)?O:t.body)?x:this.body)?_:"","object"==typeof t.text))try{t.text=await this.convert.json2html(t.text)}catch(e){t.text=JSON.stringify(t.text)}if(delete t.content,delete t.body,t.html||"string"!=typeof t.text||-1===t.text.indexOf("<")||-1===t.text.indexOf(">")||(t.html=t.text),l=(t.svc||t.service)&&null!=(null!=(k=this.S.svc[null!=(j=t.svc)?j:t.service])?k.mail:void 0)?this.S.svc[null!=(d=t.svc)?d:t.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:r.mail,null==t.from&&(t.from=l.from),null==t.to&&(t.to=l.to),delete t.svc,A="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(t.to)&&(t.to=t.to.join(",")),t.to){for(i=null!=(g=null!=this?this.fetch:void 0)?g:e.fetch,c={method:"POST",auth:"api:"+l.apikey},n=0,a=(v=["file","files","attachment","attachments"]).length;n<a;n++)null!=t[s=v[n]]&&(c[s]=t[s],delete t[s]);return c.form=t,await i(A,c)}return y.log(t),y.log("NO ADDRESS TO EMAIL TO"),{}},e.mail._auth="system",e.mail.validate=async function(t,e){var i,r,s,n,a;if(null==t&&(t=null!=this&&null!=(s=this.params)?s.email:void 0),"string"==typeof t&&t.length&&(-1===t.indexOf(" ")||t.startsWith('"')&&2===t.split('"@').length)){try{if("string"==typeof e)return null!=(n=(a=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(t)+"&api_key="+e)).did_you_mean)?n:a.is_valid}catch(t){}if(2===(i=t.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(r=i[1].split(".")).length>1&&(2!==r.length||"example"!==r[0]))return!0}return!1},g=[].indexOf,e.copy=function(t){try{null==t&&(t=this.params)}catch(t){}return JSON.parse(JSON.stringify(t))},e.dot=function(t,i,r,s,n){var a,l,o;return"string"==typeof i?e.dot(t,i.split("."),r,s,n):1!==i.length||null==r&&null==s?0===i.length?t:null==t[i[0]]?null!=r?(t[i[0]]="number"!=typeof i[0]&&isNaN(parseInt(i[0]))?{}:[],e.dot(t[i[0]],i.slice(1),r,s,n)):n&&Array.isArray(t)&&t.length&&(o=t[t.length-1]&&"object"==typeof o&&null!=o[i[0]])?e.dot(o[i[0]],i.slice(1),r,s,n):void 0:n&&Array.isArray(t)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))&&t.length&&"object"==typeof t[t.length-1]?(null!=r&&null==(a=t[t.length-1])[l=i[0]]&&(a[l]={}),e.dot(t[t.length-1][i[0]],i.slice(1),r,s,n)):e.dot(t[i[0]],i.slice(1),r,s,n):null!=s?(t instanceof Array?t.splice(i[0],1):delete t[i[0]],!0):(n&&Array.isArray(t)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))?(t.length||(t=[{}]),t[t.length-1][i[0]]=r):t[i[0]]=r,!0)},e.flatten=async function(t,e){var i,r,s,n,a,l,o;if(null==e&&(e=null!=(a=this.params.arrayed)&&a),null==t&&delete(t=this.params).arrayed,l={},i=async function(t,r){var s,n,a,o,u,c,h;for(a in c=[],t){n=!1;try{n=!isNaN(parseInt(a))}catch(t){}u=n&&!e?r:r?r+"."+a:a,"object"!=typeof(h=t[a])?null!=l[u]?(Array.isArray(l[u])||(l[u]=[l[u]]),c.push(l[u].push(h))):c.push(l[u]=h):Array.isArray(h)?"object"==typeof h[0]?c.push(await async function(){var t;for(o in t=[],h)t.push(await i(h[o],u+(e?"."+o:"")));return t}()):(null==l[u]&&(l[u]=[]),Array.isArray(l[u])||(l[u]=[l[u]]),c.push(function(){var t,e,i;for(i=[],t=0,e=h.length;t<e;t++)s=h[t],i.push(l[u].push(s));return i}())):c.push(await i(h,u))}return c},Array.isArray(t)){for(o=[],s=0,n=data.length;s<n;s++)r=data[s],l={},o.push(await i(r));return o}return await i(t),l},e.keys=function(t){var e,i;try{null==t&&(t=this.params)}catch(t){}for(e in i=[],null!=t?t:{})null!=t[e]&&g.call(i,e)<0&&i.push(e);return i},e.pings={_index:!0},e.ping=async function(){var t,e,i;return t=this.copy(this.params),"{}"!==JSON.stringify(t)&&(t.ip=null!=(e=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?e:this.headers["x-real-ip"],t.forwarded=this.headers["x-forwarded-for"],await this.pings(t),!0)},e.scrape=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,S,k,j,A,I,E,D;if(null==t&&(t=null!=(S=null!=(k=this.params.scrape)?k:this.params.content)?S:this.params.url),null==e&&(e=this.params.doi),f={doi:e},"string"==typeof t&&t.startsWith("http")&&(f.doi||(D=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(t)))&&D.length>1&&9<D[1].length&&D[1].length<45&&-1!==D[1].indexOf("/")&&0===D[1].indexOf("10.")&&(f.doi=D[1]),t=await this.fetch(t)),"string"!=typeof t)return{};if(0!==t.indexOf("<")&&t.length>6e3?t=t.substring(0,6e3):t.length>5e4&&(t=t.substring(0,5e4)),!f.doi)try{-1!==(i=t.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(t){}if(!f.doi)try{null==i&&(i=t.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(t){}if(!f.doi)try{for(r=0,j=t.split(" "),n=0,o=j.length;n<o;n++)if(E=j[n],(r+=1)<600&&(-1!==(E=E.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(E=E.split("doi.org")[1]),0===E.indexOf("/")&&(E=E.replace("/","")),0===(E=E.trim()).indexOf("10.")&&-1!==E.indexOf("/"))){f.doi=E;break}}catch(t){}if(!f.doi)try{for(A=(s=await this.extract({content:t,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=A.length;l<u;l++)w=A[l],!f.doi&&9<s.matches[w].result[1].length&&s.matches[w].result[1].length<45&&(f.doi=s.matches[w].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(t){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=t.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(t){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(y=(await this.extract({content:t,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=y[0];else for(_=0,c=y.length;_<c;_++)(b=y[_]).length>2&&(f.year=b)}catch(t){}if(!f.keywords)try{-1!==(a=(await this.extract({content:t,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(a=a.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=a.split(";")):(a=a.replace(/, /g,",").replace(/ ,/g,","),f.keywords=a.split(","))}catch(t){}if(!f.email){m=[];try{for(I=(await this.extract({content:t,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=I.length;x<h;x++)(g=I[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===m.indexOf(g)&&m.push(g)}catch(t){}for(m.sort((function(t,e){return e.length-t.length})),v="",O=0,p=m.length;O<p;O++)d=m[O],null==f.email&&(f.email=[]),-1===v.indexOf(d)&&f.email.push(d),v+=d}return f},e.sleep=function(t){try{null==t&&(t=this.params.ms)}catch(t){}return new Promise((e=>setTimeout(e,null!=t?t:1e3)))},e.sleep._auth="root",g=[].indexOf,e.template=async function(t,e){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,v,b,w,_;if(null==t&&(t=null!=(f=null!=(y=this.params.content)?y:this.params.template)?f:this.body),null==e&&(e=this.params),(this.params.url||t.startsWith("http"))&&(t=await this.fetch(null!=(m=this.params.url)?m:t)),-1===t.indexOf(" ")&&-1!==t.indexOf(".")&&t.length<100)try{r=await this.templates(t),t=r.content}catch(t){}if(b={},(i=function(e,r=""){var s,n,a,l;for(s in a=[],e)n=r?r+"."+s:s,"object"!=typeof e[s]||Array.isArray(e[s])?-1!==t.toLowerCase().indexOf("{{"+n+"}}")?(l=new RegExp("{{"+n+"}}","gi"),a.push(t=t.replace(l,Array.isArray(e[s])?e[s].join(", "):"string"==typeof e[s]?e[s]:!0===e[s]?"Yes":!1===e[s]?"No":""))):a.push(void 0):a.push(i(e[s],r+(""===r?"":".")+s));return a})(e),u=new RegExp("{{.*?}}","gi"),-1!==t.indexOf("{{")){for(_=["subject","from","to","cc","bcc"],s=0,h=(v=t.toLowerCase().split("{{")).length;s<h;s++)d=v[s].split("{{")[0].split("}}")[0].split(" ")[0],g.call(_,d)<0&&_.push(d);for(n=0,p=_.length;n<p;n++)a=_[n],(l=-1!==t.toLowerCase().indexOf("{{"+a)?a:void 0)&&(o=-1!==t.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(w=t.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(w=w.replace(u,"")),(w=w.split("}}")[0].trim())&&(b[l]=w),c=new RegExp("{{"+o+".*?}}","gi"),t=t.replace(c,""))}return-1!==t.indexOf("{{")&&(t=t.replace(u,"")),b.content=t,b},e.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},e.levenshtein=function(t,e,i){var r,s,n,a,l,o,u,c,h,p,d,f,y;for(null==t&&(t=null!=this&&null!=(p=this.params)?p.a:void 0),null==e&&(e=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(y=this.params)?y.lowercase:void 0)||f),i&&(t=t.toLowerCase(),e=e.toLowerCase()),o=function(t,e,i){return t<=e&&t<=i?t:e<=t&&e<=i?e:i},(l=t.length)<(u=e.length)&&(r=t,t=e,e=r,c=l,l=u,u=c),h=[[]],r=0;r<u+1;)h[0][r]=r,r++;for(n=1;n<l+1;){for(h[n]=[n],a=1;a<u+1;)s=t.charAt(n-1)===e.charAt(a-1)?0:1,h[n][a]=o(h[n-1][a]+1,h[n][a-1]+1,h[n-1][a-1]+s),a++;n++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:l,b:u}}},e.extract=async function(t){var e,i,r,s,n,a,l,o,u,c,h;if(null==t&&(t=this.copy(this.params)),t.url&&!t.content&&(-1!==t.url.indexOf(".pdf")||-1!==t.url.indexOf("/pdf")?null==t.convert&&(t.convert="pdf"):t.content=await this.fetch(t.url)),t.convert)try{h=await this.convert[t.convert+"2txt"](null!=(o=t.url)?o:t.content)}catch(t){}if(null==h&&(h=t.content),null==t.matchers&&(t.matchers=[t.match]),null!=t.start&&(l=h.split(t.start),h=l.length>1?l[1]:l[0]),null!=t.end&&(h=h.split(t.end)[0]),t.lowercase&&(h=h.toLowerCase()),t.ascii&&(h=h.replace(/[^a-z0-9]/g,"")),!1===t.spaces&&(h=h.replace(/ /g,"")),c={length:h.length,matched:0,matches:[],matchers:t.matchers,text:h},h&&"number"!=typeof h)for(e=0,r=(u="string"==typeof t.matchers?t.matchers.split(","):t.matchers).length;e<r;e++){"string"==typeof(n=u[e])?(a="",0===n.indexOf("/")?(i=n.lastIndexOf("/"))+1!==n.length&&(a=n.substring(i+1),n=n.substring(1,i)):n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):a="",t.lowercase&&(a+="i");try{(s=new RegExp(n,a).exec(h))&&(c.matched+=1,c.matches.push({matched:n.toString(),result:s}))}catch(t){}}return c},e.decode=async function(t){var e,i,r,s,n,a,l,o,u,c,h,p,d;for(null==t&&(t=null!=(a=null!=(l=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?l:null!=this&&null!=(h=this.params)?h.text:void 0)?a:null!=this?this.body:void 0),e=function(t){var e,i;return i=/&(nbsp|amp|quot|lt|gt);/g,e={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},t.replace(i,(function(t,i){return e[i]})).replace(/&#(\d+);/gi,(function(t,e){var i;return i=parseInt(e,10),String.fromCharCode(i)}))},d=(d=await e(t)).replace(/\n/g," "),r=0,s=(p=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<s;r++)i=p[r],n=new RegExp(i.bad,"g"),d=d.replace(n,i.good);return-1!==d.indexOf("%2")&&(d=decodeURIComponent(d)),-1!==d.indexOf("%2")&&(d=decodeURIComponent(d)),d},r.built="Mon Jul 03 2023 01:29:53 GMT+0100",e.convert.doc2txt={_bg:!0},e.convert.docx2txt={_bg:!0},e.convert.pdf2txt={_bg:!0}})()})();