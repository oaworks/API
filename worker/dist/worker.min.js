!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";i.d(e,"a",(function(){return r}));let s=t=>crypto.getRandomValues(new Uint8Array(t)),r=(t,e)=>((t,e,i)=>{let s=(2<<Math.log(t.length-1)/Math.LN2)-1,r=-~(1.6*s*e/t.length);return()=>{let a="";for(;;){let n=i(r),l=r;for(;l--;)if(a+=t[n[l]&s]||"",a.length===e)return a}}})(t,e,s)},function(t,e,i){"use strict";i.r(e),function(t,e){var s,r,a,n,l,o=i(1),u=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(t){}try{for(l in a=JSON.parse(SECRETS_SERVER))r[l]=a[l]}catch(t){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0),null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(t){return!1!==r.pass&&t.passThroughOnException(),t.respondWith(s.call(t))}))}catch(t){}n={},(s=async function(){var e,i,a,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt;this.started=Date.now();try{null==(a=r.headers)[C="x-"+r.name.toLowerCase()]&&(a[C]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(t){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(o=this.S).cache&&(o.cache=!1),this.waitUntil=function(t){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),t[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(P="",b=0,O=(U=this.request.url.split("?")[1].split("&")).length;b<O;b++)if((x=(q=U[b]).split("="))[0].length){if(1===x.length&&P&&(x[0].startsWith(" ")||x[0].includes("%")))this.params[P]+="&"+decodeURIComponent(x[0]);else{if(this.params[x[0]]=1===x.length||("string"==typeof x[1]&&"true"===x[1].toLowerCase()||("string"!=typeof x[1]||"false"!==x[1].toLowerCase())&&(!!q.endsWith("=")||x[1])),"string"!=typeof this.params[x[0]]||0!==this.params[x[0]].replace(/[0-9]/g,"").length||this.params[x[0]].startsWith("0")||(k=parseInt(this.params[x[0]]),isNaN(k)||(this.params[x[0]]=k)),"string"==typeof this.params[x[0]]&&this.params[x[0]].includes("%"))try{this.params[x[0]]=decodeURIComponent(this.params[x[0]])}catch(t){}if("string"==typeof this.params[x[0]]&&(this.params[x[0]].startsWith("[")||this.params[x[0]].startsWith("{")))try{this.params[x[0]]=JSON.parse(this.params[x[0]])}catch(t){}}P=x[0]}this.headers={};try{for(M=[...this.request.headers],w=0,A=M.length;w<A;w++)_=M[w],this.headers[_[0].toLowerCase()]=_[1]}catch(t){try{for(v in this.request.headers)this.headers[v.toLowerCase()]=this.request.headers[v]}catch(t){}}if(null==(c=this.headers).ip&&(c.ip=null!=(H=this.headers["x-real-ip"])?H:this.headers["x-forwarded-for"]),f=null!=(et=this.headers["content-type"])?et:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(f.includes("/json"))this.body=await this.request.json();else if(f.includes("form")){for(g in d={},(await this.request.formData()).entries())g[0]&&(null!=d[g[0]]?(Array.isArray(d[g[0]])||(d[g[0]]=[d[g[0]]]),d[g[0]].push(g[1])):d[g[0]]=g[1]);null!=d&&"{}"!==JSON.stringify(d)&&(this.body=d)}if(null==this.body&&("POST"===(it=this.request.method)||"PUT"===it||"DELETE"===it)){try{d=await this.request.text()}catch(t){}d&&(this.body=d)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(t){}if("object"==typeof this.body&&!Array.isArray(this.body))for(q in this.body)q&&null==(h=this.params)[q]&&(h[q]=this.body[q]);try{this.cookie=null!=(st=this.headers.Cookie)?st:this.headers.cookie}catch(t){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(t){}null==this.rid&&(this.rid=s.uid());try{this.apikey=null!=(rt=null!=(at=this.headers["x-apikey"])?at:this.headers.apikey)?rt:this.params.apikey}catch(t){}for(S=0,j=(nt=["x-apikey","apikey"]).length;S<j;S++)ct=nt[S],null!=this.headers[ct]&&delete this.headers[ct],null!=this.params[ct]&&delete this.params[ct];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(t){}this.parts=(null!=m?m:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(m=decodeURIComponent(this.url))}catch(t){}this.parts=this.url.length?(null!=m?m:this.url).split("/"):[];try{this.base=this.headers.host}catch(t){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(N=this.parts[this.parts.length-1].split(".").pop(),this.format=N,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+N,"")),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(lt=this.parts[0],u.call(this.S.pass,lt)>=0))throw new Error;if(ht="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[ht]===this.S.system&&(delete this.headers[ht],this.system=!0),this._logs=[],this.nolog=!1,this.params._nolog&&(this.nolog=this.S.nolog&&this.params._nolog===this.S.nolog,delete this.params._nolog),this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(W=this.request.method)||"OPTIONS"===W?s._response.call(this,""):s._response.call(this,{name:null!=(z=this.S.name)?z:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=(J=null!=(B=this.user)?B.email:void 0)?J:void 0});for(y=void 0,T=[...this.parts],L=void 0,E=[],(e=(t,i,r,a,o)=>{var c,h,d,p,f,m,g,_,v,b,w,x,k,S,O,A;if(L&&this.fn.startsWith(r))for(;T.length&&null==t[T[0]];)this.params[L]=(this.params[L]?this.params[L]+"/":"")+T.shift(),u.call(E,L)<0&&E.push(L);for(l in O=[],t)if("function"!=(k=typeof t[l])&&"object"!==k)O.push(i[l]=t[l]);else if(null!=t[l]){if(w=r+(r?".":"")+l,"object"!=typeof t[l]||t[l]._index||t[l]._indexed||t[l]._sheet||t[l]._kv||t[l]._bg){if(null==(d=t[l])._auth&&(d._auth=null!=(p=t[l])._auths?p._auths:p._auths=a),Array.isArray(t[l]._auths)&&0===t[l]._auths.length&&(t[l]._auths=w.split(".")),Array.isArray(t[l]._auth)&&0===t[l]._auth.length&&(t[l]._auth=w.split(".")),null==(f=t[l])._cache&&(f._cache=null!=(m=t[l])._caches?m._caches:m._caches=o),w.startsWith("auth")&&null==(g=t[l])._cache&&(g._cache=!1),t[l]._sheet&&null==(_=t[l])._index&&(_._index=!0),t[l]._index)for(x=0,b=(S=["keys","terms","suggest","count","min","max","range","mapping","history","_for","_each","_bulk","_refresh"]).length;x<b;x++)v=S[x],null==(c=t[l])[v]&&(c[v]={_indexed:v,_auth:v.startsWith("_")?"system":t[l]._auth});for(A in"function"!=typeof t[l]||t[l]._index||t[l]._indexed||t[l]._kv||t[l]._bg||w.includes(".")&&!r.startsWith("index")&&!w.split(".").pop().startsWith("_")?i[l]=s._wrapper(t[l],w).bind(this):i[l]=t[l].bind(this),t[l])A.startsWith("_")&&(i[l][A]=t[l][A])}else i[l]=JSON.parse(JSON.stringify(t[l]));null==(h=i[l])._name&&(h._name=w),i[l]._schedule&&!n[w]&&!0===this.S.bg&&!1===this.S.cron&&(console.log("Adding schedule",i[l]._schedule,w),n[w]={schedule:i[l]._schedule,fn:i[l]},cron.schedule(i[l]._schedule,async()=>{var t;n[w].last=await this.datetime();try{y._sheet&&(this.refresh=!0),t=await n[w].fn(n[w].fn._args);try{n[w].result=JSON.stringify(t).substr(0,200)}catch(t){}return n[w].success=!0,console.log("scheduled task result",t),this.refresh=void 0}catch(t){return n[w].success=!1}})),l.startsWith("_")||(T.length&&T[0]===l&&this.fn.startsWith(r)&&(L=T.shift(),this.fn+=(""===this.fn?"":".")+L,"function"!=typeof i[l]||r.includes("._")||(y=i[l])),"function"==typeof i[l]&&1===w.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(w.replace(/\./g,"/"))),Array.isArray(t[l])||l.startsWith("_")&&"function"!=typeof i[l]?O.push(void 0):O.push(e(t[l],i[l],w,null!=a?a:t[l]._auths,null!=o?o:t[l]._caches))}else O.push(void 0);return O})(s,this,""),L&&T.length&&(this.params[L]=this.params[L]?this.params[L]+"/"+T.join("/"):T.join("/")),D=0,I=E.length;D<I;D++)p=E[D],"true"===this.params[p].toLowerCase()&&(this.params[p]=!0),"false"===this.params[p].toLowerCase()&&(this.params[p]=!1),"string"!=typeof this.params[p]||0!==this.params[p].replace(/[0-9]/g,"").length||this.params[p].startsWith("0")||(R=parseInt(this.params[p]),isNaN(R)||(this.params[p]=R));if(this.S.dev&&!0===this.S.bg&&console.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(Y=typeof y)||"function"===Y)&&y._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("function"==typeof y&&("object"==typeof(i="auth"===this.fn?void 0:await this.auth())&&i._id&&i.email&&(this.user=i),(i="function"==typeof y._auth?await y._auth():!0===y._auth&&null!=this.user||(!y._auth||await this.auth.role(y._auth)))||this.system?"HEAD"===(F=this.request.method)||"OPTIONS"===F?ot="":!1!==y._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(ot=await this.cache())?(this.cached="cache",(ot=new Response(ot.body,ot)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),ot.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(ot=await y(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(ot={status:401}).body=await this.auth(!1))),(null==ot||"object"==typeof ot&&404===ot.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(ot=""),ut="object"!=typeof ot||Array.isArray(ot)||"function"!=typeof(null!=(X=ot.headers)?X.append:void 0)?await this._response(ot,y):ot,this.parts.length&&"log"!==(V=this.parts[0])&&"status"!==V&&(!this.system||"kv"!==($=this.parts[0])&&"index"!==$)&&"HEAD"!==(G=this.request.method)&&"OPTIONS"!==G&&null!=ot&&""!==ot&&(!this.completed||!1===y._cache||200!==ut.status||"object"==typeof ot&&!Array.isArray(ot)&&0===(null!=(Z=ot.hits)?Z.total:void 0)||"number"==typeof ot&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(dt=y._cache)||"object"!=typeof ot||Array.isArray(ot)||null==(null!=(Q=ot.hits)?Q.hits:void 0)||(dt=60),this.cache(void 0,ut,dt)),("object"!=(K=typeof y)&&"function"!==K||!1!==y._log)&&this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(tt=this.request.method)||"OPTIONS"===tt)return ut;throw new Error})._response=async function(t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O;if(null==(a=this.S).headers&&(a.headers={}),null==t)t=404,S=404;else if("status"!==this.fn&&"object"==typeof t&&!Array.isArray(t)&&("number"==typeof t.status&&t.status>300&&t.status<600||t.headers)){if(null!=t.headers){for(o in t.headers)this.S.headers[o]=t.headers[o];delete t.headers}S=null!=(_=t.status)?_:200,delete t.status,0===(p=this.keys(t)).length?t=S:1===p.length&&(t=t[p[0]])}else S=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&("html"===(v=this.format)||"csv"===v)){if("string"!=typeof t)try{t=await this.convert["json2"+this.format](t)}catch(t){}if("string"==typeof t&&"html"===this.format&&!(t=t.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(x='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',x+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',t.includes("<title")?([y,O]=t.split("<title"),[O,r]=O.split("</title>"),x+="<title"+O+"</title>\n",t=y+r):t.includes('id="title"')&&(x+="<title>"+t.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),h=0,f=(b=["<meta ","<link "]).length;h<f;h++)if(u=b[h],t.includes(u))for(d=0,m=(w=t.split(u)).length;d<m;d++)k=u+w[d].split(">")[0],t=t.replace(k,""),x+=k+"\n";t.includes("<head>")&&([g,c]=t.split("<head>"),[c,s]=c.split("</head>"),x+=c,t=g+s),x.includes("icon")||(x+='<link rel="icon" href="data:,">'),x+="\n</head>\n",x+=t.includes("<body")?t:"\n<body>\n"+t+"\n</body>\n",t=x+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof t)try{t=JSON.stringify(t,"",2)}catch(t){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(l=this.S.headers)["Content-Length"]&&(l["Content-Length"]=e.byteLength(t))}catch(t){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(t){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(t){}try{return new Response(t,{status:S,headers:this.S.headers})}catch(e){return{status:S,headers:this.S.headers,body:t}}},s._wrapper=function(t,e){return async function(){var i,s,r,a,n,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q;if(T=Date.now(),P=e.replace(/\./g,"_"),m={fn:e},t._limit)for(g=await this.kv("limit/"+e);g;)null==m.limited&&(m.limited=0),m.limited+=g,await this.sleep(g-T),g=await this.kv("limit/"+e);if("string"==(b=typeof this.params._async)||"number"===b)if(R=await this.kv("async/"+this.params._async,"")){if("string"==typeof R&&R.includes("/")&&!R.includes(" ")&&!R.includes(":")&&!R.startsWith("10.")&&2===R.split("/").length){try{t._kv&&(R=await this.kv(R))}catch(t){}try{null==R&&t._index&&(R=await this.index(R))}catch(t){}}try{"string"==typeof R&&(R.startsWith("{")||R.startsWith("["))&&(R=JSON.parse(R))}catch(t){}}else R={_async:this.params._async};else if(this.fn===e&&t._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)R={status:302},t._sheet.startsWith("http")?R.body=t._sheet:"json"===this.format?R.body="https://sheets.googleapis.com/v4/spreadsheets/"+t._sheet.split("/")[0]+"/values/"+(null!=(w=null!=(O=t._sheetid)?O:t._sheet.split("/")[1])?w:"Sheet1")+"?alt=json":R.body="https://docs.google.com/spreadsheets/d/"+t._sheet.split("/")[0],R.headers={Location:R.body};else if(t._indexed)(s=[...arguments]).unshift(P.replace("_"+t._indexed,"")),R=await this.index[t._indexed](...s);else if((t._index||t._kv)&&(!t._sheet||this.fn!==e||!this.refresh)){if(this.fn===e?(this.fn.replace(/\./g,"/")!==this.route&&(m.key=this.route.split(e.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!m.key&&t._index&&(_=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\:\*~\?=%"]/g,"").length&&(m.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(m.key=arguments[0].toString()),t._index&&!m.key&&(_=await this.index.translate(arguments[0],arguments[1])),v=null!=_?void 0:m.key?arguments[1]:t._index?arguments[0]:void 0),"object"==typeof v)if(Array.isArray(v)){if(v.length)for(o=0,d=v.length;o<d;o++)null==(n=v[o])._id&&(n._id=(null!=(I=n[t._key])?I:this.uid()).replace(/\//g,"_").toLowerCase())}else null==v._id&&(v._id=(null!=(A=null!=(j=m.key)?j:v[t._key])?A:this.uid()).replace(/\//g,"_").toLowerCase()),null==m.key&&(m.key=v._id);if((null!=v||!this.refresh||"function"!=typeof t)&&(t._kv&&m.key&&null!=(R=await this.kv(P+"/"+m.key,v))&&null==v&&(m.cached="kv"),t._index)){if(null!=(R=await this.index(P+(m.key?"/"+m.key:""),null!=v?v:_))||m.key&&null!=v||(await this.index(P,"object"!=typeof t._index?{}:{settings:t._index.settings,mappings:null!=(C=t._index.mappings)?C:t._index.mapping,aliases:t._index.aliases}),""!==v&&(R=await this.index(P+(m.key?"/"+m.key:""),null!=v?v:m.key?void 0:_))),null==R&&null==v&&m.key&&"string"==typeof arguments[0]&&(_=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(y=await this.index(P,_))&&null!=(D=y.hits)?D.total:void 0))for(c=0,p=(N=await this.keys(y.hits.hits[0]._source)).length;c<p;c++)if(l=N[c],"string"==typeof y.hits.hits[0]._source[l]&&arguments[0]===y.hits.hits[0]._source[l]||Array.isArray(y.hits.hits[0]._source[l])&&(L=arguments[0],u.call(y.hits.hits[0]._source[l],L)>=0)){null==(R=y.hits.hits[0]._source)._id&&(R._id=y.hits.hits[0]._id);break}1===(null!=_?_.size:void 0)&&"object"==typeof R&&null!=(null!=(x=R.hits)?x.hits:void 0)&&(R.hits.hits.length?(null==(r=R.hits.hits[0]._source)._id&&(r._id=R.hits.hits[0]._id),R=R.hits.hits[0]._source):R=void 0)}null!=_&&(m.qry=JSON.stringify(_)),null==R||null!=v||m.cached||(m.cached="index"),m.cached&&this.fn===e&&(this.cached=m.cached)}if(null==R&&(t._bg||t._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(a={headers:{},body:v,params:this.copy(this.params)},this.refresh&&(a.params.refresh=!0),a.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,R=await this.fetch(this.S.bg+"/"+P.replace(/\_/g,"/"),a),m.bg=!0),null==R&&t._sheet&&""!==v&&(this.refresh&&this.fn===e||!await this.index(P)))if(t._sheet.startsWith("http")&&t._sheet.includes("csv")?E=await this.convert.csv2json(t._sheet):t._sheet.startsWith("http")&&t._sheet.includes("json")?(E=await this.fetch(t._sheet))&&!Array.isArray(E)&&(E=[E]):E=await this.src.google.sheets(t._sheet),Array.isArray(E)&&E.length){if("function"==typeof t&&(E=await t.apply(this,[E])),t._key)for(h=0,f=E.length;h<f;h++)null==(q=E[h])._id&&(q._id=(null!=(k=q[t._key])?k:this.uid()).replace(/\//g,"_").toLowerCase());await this.index(P,""),await this.index(P,"object"!=typeof t._index?{}:{settings:t._index.settings,mappings:null!=(S=t._index.mappings)?S:t._index.mapping,aliases:t._index.aliases}),arguments.length||"{}"!==JSON.stringify(this.params)?await this.index(P,E):(this.waitUntil(this.index(P,E)),R=E.length)}else R=0;return null!=R||t._index&&""===v||"function"!=typeof t||(i=async(t,i,s,r)=>{var a,l,o,u,c,h,d,p;if(i._limit&&(a=!0===i._limit?86400:i._limit,await this.kv("limit/"+e,T+a,a)),"object"==typeof(c=await i.apply(this,s))&&(i._kv||i._index)&&null==c.took&&null==c.hits){if(i._key&&Array.isArray(c)&&c.length&&null==c[0]._id&&null!=c[0][i._key])for(u=0,o=c.length;u<o;u++)null==(n=c[u])._id&&(n._id=n[i._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(c)?"":"/"+(null!=(h=null!=(d=c[i._key])?d:c._id)?h:this.uid()).replace(/\//g,"_").toLowerCase(),i._kv&&!Array.isArray(c)&&this.kv(t+l,R,i._kv),i._index&&this.waitUntil(this.index(t+l,c))}return!0===i._limit&&await this.kv("limit/"+e,""),i._async&&(this.kv("async/"+this.rid,null==l||Array.isArray(c)?Array.isArray(c)?c.length:c:t+l,172800),this.fn===e&&!1!==i._notify&&(p=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(c)+"\n\n"+this.base+"/"+t+"?_async="+this.rid,r&&this.mail({to:r,text:p}))),c},t._async?(m.async=!0,R={_async:this.rid},this.waitUntil(i(P,t,arguments,this.params.notify))):R=await i(P,t,arguments)),!1!==t._log&&(m.took=Date.now()-T,this.log(m)),R}},s.svc={},s.src={},s.status=async function(){var e,i,s,a,o,u,c,h,d;for(h={name:r.name,version:r.version,built:r.built},e=0,s=(o=["rid","params","base","parts","opts","routes"]).length;e<s;e++){l=o[e];try{null==h[l]&&(h[l]=this[l])}catch(t){}}if(!0===this.S.bg)try{for(d in h.schedule={},n)for(l in h.schedule[d]={},n[d])"fn"!==l&&(h.schedule[d][l]=n[d][l])}catch(t){}!0===this.S.bg&&(h.bg=!0),h.kv=("string"==typeof this.S.kv&&t[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{h.index=await this.index.status()}catch(t){}if(r.dev){if(h.bg=this.S.bg,!0!==this.S.bg)try{h.request=this.request}catch(t){}for(i=0,a=(u=["headers","cookie","user","body"]).length;i<a;i++){l=u[i];try{null==h[l]&&(h[l]=this[l])}catch(t){}}}else{try{h.index=h.index.status}catch(t){}h.kv&&(h.kv=!0),h.user=null!=(c=this.user)?c.email:void 0}return h};u=[].indexOf;s.auth=async function(t){var e,i,s,a,n,l,o,u,c,h,d,p,f;if("string"==typeof t)return this.users._get(t);if(t||null==this.user||"auth"!==this.fn&&!1!==t){if(!1!==t&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(a=this.params.token)?a:this.params.auth),"")))&&((f=await this.users._get(null!=(n=null!=s?s.email:void 0)?n:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(p=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(p))),!f&&(this.params.resume||this.cookie))){if(!(h=this.params.resume))try{h=(e=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"pradm")+"=")[1].split(";")[0])).resume,p=e._id}catch(t){}null==p&&(p=this.headers["x-id"]),this.params.email&&!p&&(p=this.hashhex(this.params.email.trim().toLowerCase())),h&&p&&await this.kv("auth/resume/"+p+"/"+h)&&null!=(f=await this.users._get(p))&&(f.resume=h)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),t||"html"!==this.format?f:(d="<body>",d+='<script type="text/javascript" src="/client/pradm.min.js?v='+this.S.version+'"><\/script>\n',d+='<script type="text/javascript" src="/client/pradmLogin.min.js?v='+this.S.version+'"><\/script>\n',d+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(d+='<input autofocus id="PEmail" class="PEmail" type="text" name="email" placeholder="email">',d+='<input id="PToken" class="PToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',d+='<p class="PWelcome" style="display:none;">Welcome back</p>',d+='<p class="PLogout" style="display:none;"><a id="PLogout" href="#">logout</a></p>'):d+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',d+"</body>")},s.auth.token=function(t,e,i,s,a,n,l){var o,u,c;if(null==t&&(t=this.params.email),t)return t=t.trim().toLowerCase(),null==e&&(e=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&console.log(t,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,t,1200),this.waitUntil(this.mail({from:e,to:t,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=a?a:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:t}},s.auth.role=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p,f,m,g;if(null==t&&(t=this.params.role),e="object"==typeof e?e:e||this.params.auth?await this.users._get(null!=e?e:this.params.auth):this.user,"system"===t&&this.system)return"system";if((null!=e?e.email:void 0)&&(c=e.email,u.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],c)>=0))return"root";if(null!=(null!=e?e.roles:void 0))for(a=0,l=(h="string"==typeof t?t.split(","):t||[]).length;a<l;a++){if(s=h[a],[r,g]=s.replace("/",".").split("."),r===e._id)return"owner";if(g){if(u.call(null!=(d=e.roles[r])?d:[],g)>=0)return g;if(null!=e.roles[r]&&-1<(f=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(g)))for(n=0,o=(p=i.splice(0,f)).length;n<o;n++)if(m=p[n],u.call(e.roles[r],m)>=0)return m}}return!1},s.auth.add=async function(t,e,i,s){var r,a,n,l,o,c,h;return e="object"==typeof e?e:e||this.params.auth?await this.users._get(null!=e?e:this.params.auth):this.user,!(!t&&this.user._id!==e._id&&!await this.auth.role("system"))&&(null==t&&(t=null!=(n=null!=(l=this.params.add)?l:this.params.remove)?n:this.params.deny),!!t&&([a,h]=t.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==a&&"root"!==h&&(s?(e.roles[a]=["deny"],this.users._update(e)):h?(null!=(o=e.roles)?o[a]:void 0)&&u.call(e.roles[a],h)>=0?null!=i&&(e.roles[a].splice(e.roles[a].indexOf(h),1),e.roles[a].length||delete e.roles[a],this.users._update(e)):("request"!==h||u.call(null!=(c=e.roles[a])?c:[],"deny")<0)&&(null==(r=e.roles)[a]&&(r[a]=[]),u.call(e.roles[a],"request")>=0&&(e.roles[a]=e.roles[a].splice(e.roles[a].indexOf("request"),1)),e.roles.group.push(h),this.users._update(e)):null!=e.roles[a]?null!=i&&(delete e.roles[a],this.users._update(e)):(e.roles[a]=["user"],this.users._update(e)),e)))},s.auth.remove=function(t,e){return this.auth.add(t,e,!0)},s.auth.deny=function(t,e){return this.auth.add(t,e,void 0,!0)},s.auth.request=function(t,e){return null==t&&(t=this.params.request),t=t.split("/")[0]+"/request",this.auth.add(t,e)},s.auth.logout=async function(t){return null==t&&(t=this.user),!!t&&(await this.kv._each("auth/resume/"+("string"==typeof t?t.includes("@")?this.hashhex(t.trim().toLowerCase()):t:t._id),""),!0)},s.auth._oauth=async function(t,e){var i,s,a,n,l,o,u,c,h,d,p,f,m,g;if({},t)try{if(g=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+t,{method:"POST"}),null==e&&(e=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=r.use)&&null!=(d=h.google)&&null!=(p=d.oauth)&&null!=(f=p.client)?f.id:void 0),null!=e&&(null!=(a=g.data)?a.aud:void 0)===e)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+t)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(n=m.data.name)?n:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(t){}},s.users={_index:!0,_auth:"system"},s.users._get=async function(t,e){var i,s,r;if(e)try{1===(null!=(s=await this.index("users",'apikey:"'+e+'"'))&&null!=(i=s.hits)?i.total:void 0)&&(r=s.hits.hits[0]._source)}catch(t){}else if("string"==typeof t){if(t.startsWith("users/")&&(t=t.replace("users/","")),t.includes("@")&&(t=this.hashhex(t.trim().toLowerCase())),!0!==this.S.bg)try{r=await this.kv("users/"+t)}catch(t){}if(null==r){try{r=await this.index("users/"+t)}catch(t){}if(null!=r&&!0!==this.S.bg){try{await this.kv("users/"+t,r)}catch(t){}try{await this.kv("auth/apikey/"+r.apikey,t)}catch(t){}}}}return r},s.users._create=async function(t){var e;if("string"==typeof t&&(t={email:t}),"string"!=typeof t.email||!t.email.includes("@"))return!1;e={_id:this.hashhex(t.email.trim().toLowerCase()),email:t.email,apikey:this.uid()},delete t.email;try{e.profile=t}catch(t){}try{e.creation=this.base+"/"+this.route}catch(t){}e.roles={},e.createdAt=new Date;try{await this.kv("users/"+e._id,e)}catch(t){}try{await this.kv("auth/apikey/"+e.apikey,e._id)}catch(t){}try{this.waitUntil(this.index("users/"+e._id,e))}catch(t){}return e},s.users._update=async function(t,e){if("object"==typeof t&&e._id&&null==e&&(t=(e=t)._id),"string"==typeof t&&"object"==typeof e&&"{}"!==JSON.stringify(e)){t.startsWith("users/")&&(t=t.replace("users/","")),t.includes("@")&&(t=this.hashhex(t.trim().toLowerCase())),e.updatedAt=new Date;try{await this.kv("users/"+t,e)}catch(t){}try{this.waitUntil(this.index("users/"+t,e))}catch(t){}return!0}return!1},s.users._delete=async function(t){var e,i;if(i="object"==typeof t?t:(null!=(e=this.user)?e._id:void 0)===t?this.user:await this.users._get(t)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(t){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(t){}try{await this.kv("users/"+i._id,"")}catch(t){}try{return await this.index("users/"+i._id,"")}catch(t){}}},s.deal={_index:!0,_prefix:!1},s.deal.institution={_index:!0,_prefix:!1},s.deal.import=async function(){var t,e,i,s,r,a,n,l,o;for(e={},s=0,r=(o=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;s<r;s++){l=o[s];try{if(l.value=parseInt(l.packageprice.replace(/[^0-9]/g,"")),"string"==typeof l.fte)try{l.fte=parseInt(l.fte)}catch(t){delete l.fte}"string"==typeof l.notes&&l.notes.toLowerCase().includes("canadian")?(l.gbpvalue=Math.floor(.57*l.value),l.usdvalue=Math.floor(.75*l.value)):l.packageprice.includes("$")?(l.gbpvalue=Math.floor(.77*l.value),l.usdvalue=Math.floor(l.value)):(l.gbpvalue=Math.floor(l.value),l.usdvalue=Math.floor(1.3*l.value))}catch(t){}null==l.usdvalue&&(l.usdvalue="");try{"2103"===l.years&&(l.years="2013")}catch(t){}try{"yes"!==l.shareurlpublicly.toLowerCase()&&delete l.url}catch(t){}try{delete l.shareurlpublicly}catch(t){}try{""===l.collection&&(l.collection="Unclassified")}catch(t){}try{l.carnegiebasicclassification=l["2015carnegiebasicclassification"],delete l["2015carnegiebasicclassification"]}catch(t){}try{null==e[a=l.institution]&&(e[a]={institution:l.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),n=JSON.parse(JSON.stringify(l));try{delete n.institution}catch(t){}try{e[l.institution].value+=l.value,e[l.institution].gbpvalue+=l.gbpvalue,e[l.institution].usdvalue+=l.usdvalue}catch(t){}e[l.institution].deals.push(n)}catch(t){}}for(t in i=[],e)i.push(e[t]);return await this.deal(""),await this.deal.institution(""),await this.deal(o),await this.deal.institution(i),{retrieved:o.length,institutions:i.length}};u=[].indexOf;s.deposits={_index:!0},s.deposit=async function(t,e,i){var s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt,pt,ft,mt,gt,yt,_t,vt,bt,wt,xt,kt,St;for(null==t&&(t=this.copy(this.params)),(null!=(C=t.metadata)?C.doi:void 0)&&!t.doi&&(t.doi=t.metadata.doi),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),null==i&&(i=this.S.dev),(d={createdAt:Date.now()}).created_date=await this.datetime(d.createdAt),f=0,_=(D=["embedded","demo","pilot","live","email","plugin"]).length;f<_;f++)d[y=D[f]]=t[y];if(!0===d.pilot&&(d.pilot=Date.now()),!0===d.live&&(d.live=Date.now()),d.name=null!=(z=null!=e?e.filename:void 0)?z:null!=e?e.name:void 0,"anonymous"!==t.from&&(d.from=t.from),t.confirmed&&(d.confirmed=decodeURIComponent(t.confirmed)),d.doi=null!=(Q=t.doi)?Q:null!=(ut=t.metadata)?ut.doi:void 0,null==t.metadata&&t.doi&&(t.metadata=await this.metadata(t.doi)),d.metadata=t.metadata,wt=t.config,"string"==typeof t.config&&(wt=JSON.parse(t.config)),!t.config&&t.from&&(wt=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+t.from)),d.permissions=null!=(pt=t.permissions)?pt:await this.permissions(null!=(ft=t.metadata)?ft:t.doi),d.archivable=await this.archivable(e,void 0,d.confirmed,t.metadata,d.permissions,i),null!=(null!=(mt=d.archivable)?mt.metadata:void 0)&&delete d.archivable.metadata,(null!=(gt=d.archivable)?gt.archivable:void 0)&&(!d.confirmed||d.confirmed===d.archivable.checksum)){for((kt={content:e.data,name:d.archivable.name}).publish=!0,h=[],g=0,v=(L=null!=(yt=null!=(N=t.metadata)?N.author:void 0)?yt:[]).length;g<v;g++)if(null!=(s=L[g]).family){a={name:s.family+(s.given?", "+s.given:"")};try{s.ORCID&&(a.orcid=s.ORCID.split("/").pop())}catch(t){}try{"object"==typeof s.affiliation&&null!=s.affiliation.name&&(a.affiliation=s.affiliation.name)}catch(t){}h.push(a)}0===h.length&&(h=[{name:"Unknown"}]),p=t.metadata.abstract?t.metadata.abstract+"<br><br>":"",(p=(p+=null!=(R=null!=(P=d.permissions.best_permission)?P.deposit_statement:void 0)?R:null!=t.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+t.metadata.doi:"").trim()).lastIndexOf(".")!==p.length-1&&(p+="."),p.length&&(p+=" "),p+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",S={title:null!=(E=t.metadata.title)?E:"Unknown",description:p.trim(),creators:h,version:"preprint"===d.archivable.version?"Submitted Version":"postprint"===d.archivable.version?"Accepted Version":"publisher pdf"===d.archivable.version?"Published Version":"Accepted Version",journal_title:t.metadata.journal,journal_volume:t.metadata.volume,journal_issue:t.metadata.issue,journal_pages:t.metadata.page},t.doi&&((null!=(St=await this.src.zenodo.records.search('"'+t.doi+'"',i))&&null!=(T=St.hits)?T.total:void 0)&&(m=St.hits.hits[0]),m&&d.confirmed!==d.archivable.checksum&&!i?d.zenodo={already:m.id}:S.related_identifiers=[{relation:"postprint"===S.version||"AAM"===S.version||"preprint"===S.version?"isPreviousVersionOf":"isIdenticalTo",identifier:t.doi}]),S.prereserve_doi=!0,S.access_right="open",S.license=null!=(q=null!=(U=d.permissions.best_permission)?U.licence:void 0)?q:"cc-by",S.license.includes("other")&&S.license.includes("closed")&&(S.license="other-closed"),S.license.includes("other")&&S.license.includes("non")&&S.license.includes("commercial")&&(S.license="other-nc"),S.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(S.license.substring(S.license.length-1)))&&(S.license+="-4.0");try{(null!=(M=d.permissions.best_permission)?M.embargo_end:void 0)&&await this.epoch(d.permissions.best_permission.embargo_end)>Date.now()&&(S.access_right="embargoed",S.embargo_date=d.permissions.best_permission.embargo_end,d.embargo=d.permissions.best_permission.embargo_end)}catch(t){}try{null!=t.metadata.published&&"string"==typeof t.metadata.published&&(S.publication_date=t.metadata.published)}catch(t){}if(null!=wt){if(d.config=wt,null!=wt.community_ID&&null==wt.community&&(wt.community=wt.community_ID),wt.community)for(null==wt.communities&&(wt.communities=[]),k=0,b=(W="string"==typeof wt.community?wt.community.split(","):wt.community).length;k<b;k++)o=W[k],wt.communities.push({identifier:o});if(null!=wt.community||null!=wt.communities)for(null==wt.communities&&(wt.communities=wt.community),Array.isArray(wt.communities)||(wt.communities=[wt.communities]),S.communities=[],A=0,w=(J=wt.communities).length;A<w;A++)c=J[A],S.communities.push("string"==typeof c?{identifier:c}:c);S.communities&&S.communities.length&&(d.community=S.communities[0].identifier)}if(_t=i||d.demo?null!=(B=this.S.src.zenodo)?B.sandbox:void 0:null!=(Y=this.S.src.zenodo)?Y.token:void 0){if(!(null!=(F=d.zenodo)?F.already:void 0))if((xt=await this.src.zenodo.deposition.create(S,kt,_t,i)).id)d.zenodo={id:xt.id,url:"https://"+(i||d.demo?"sandbox.":"")+"zenodo.org/record/"+xt.id,doi:null!=(null!=(X=xt.metadata)&&null!=(V=X.prereserve_doi)?V.doi:void 0)?xt.metadata.prereserve_doi.doi:void 0,file:null!=($=null!=(G=xt.uploaded)&&null!=(H=G.links)?H.download:void 0)?$:null!=(Z=xt.uploaded)&&null!=(K=Z.links)?K.download:void 0},null==d.doi&&(d.doi=d.zenodo.doi),d.type="zenodo";else{d.error="Deposit to Zenodo failed";try{d.error+=": "+JSON.stringify(xt)}catch(t){}d.type="review"}}else d.error="No Zenodo credentials available",d.type="review"}if(d.version=null!=(tt=d.archivable)?tt.version:void 0,d.type||!t.from||d.embedded&&(d.embedded.includes("oa.works")||d.embedded.includes("openaccessbutton.org")||d.embedded.includes("shareyourpaper.org"))||(d.type=t.redeposit?"redeposit":e?"forward":"dark"),d.doi&&!d.error&&(null==d.type&&(d.type="review"),d.url="string"==typeof t.redeposit?t.redeposit:t.url?t.url:void 0,await this.deposits(d),("review"!==d.type||null!=e)&&!1!==(null!=(et=d.archivable)?et.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(it=exists.zenodo)?it.already:void 0)||i))){for(l=["joe@oa.works"],i&&l.push("mark@oa.works"),bt=[],"string"==typeof(null!=wt?wt.owner:void 0)&&wt.owner.includes("@")?bt.push(wt.owner):(null!=wt?wt.email:void 0)&&bt.push(wt.email),0===bt.length&&(bt=this.copy(l),l=[]),r=[],j=0,x=(at=null!=(st=null!=(rt=d.metadata)?rt.author:void 0)?st:[]).length;j<x;j++)(n=at[j]).family&&r.push((n.given?n.given+" ":"")+n.family);d.metadata.author=r,d.adminlink=d.embedded?d.embedded:"https://shareyourpaper.org"+(d.metadata.doi?"/"+d.metadata.doi:""),d.adminlink+=d.adminlink.includes("?")?"&":"?",null!=(null!=(nt=d.archivable)?nt.checksum:void 0)&&(d.confirmed=encodeURIComponent(d.archivable.checksum),d.adminlink+="confirmed="+d.confirmed+"&"),lt=d.email,u.call(d.adminlink,lt)<0&&(d.adminlink+="email="+d.email),vt=await this.templates(d.type+"_deposit"),I=await this.template(vt.content,d),delete d.adminlink,delete d.confirmed,O={from:"deposits@oa.works",to:bt,subject:null!=(ot=I.subject)?ot:d.type+" deposit",html:I.content},l&&l.length&&(O.bcc=l),e&&(O.attachment={file:e.data,filename:null!=(ct=null!=(ht=null!=(dt=d.archivable)?dt.name:void 0)?ht:e.name)?ct:e.filename}),await this.mail(O)}if(d.embargo)try{d.embargo_UI=new Date(d.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(t){}return d},s.deposit._bg=!0,s.archivable=async function(t,e,i,s,r,a){var n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z;if(null==a&&(a=this.S.dev),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),f={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},("string"==typeof s||null==s&&(this.params.doi||this.params.title))&&(s=await this.metadata(null!=(N=null!=s?s:this.params.doi)?N:this.params.title)),null==s&&(s={}),"string"==typeof t&&(t={data:t}),null==t&&null!=e&&(t=await this.fetch(e)),null!=t){null==t.name&&(t.name=t.filename);try{f.name=t.name}catch(t){}try{f.format=null!=t.name&&t.name.includes(".")?t.name.split(".").pop():"html"}catch(t){}if(f.format=f.format.toLowerCase(),t.data){if(null==h&&null!=f.format&&null!=this.convert[f.format+"2txt"])try{h=await this.convert[f.format+"2txt"](t.data)}catch(t){}try{null==h&&(h=t.data)}catch(t){}try{h=h.toString()}catch(t){}}}if(null!=h||i){A=((O=(d=h.length<2e4?h:h.substring(0,6e3)+h.substring(h.length-6e3,h.length)).toLowerCase()).length<6e3?O:O.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==f.name&&(f.name=s.title);try{f.checksum=crypto.createHash("md5").update(h,"utf8").digest("base64")}catch(t){}f.same_paper_evidence={};try{f.same_paper_evidence.words_count=h.split(" ").length}catch(t){}try{f.same_paper_evidence.words_more_than_threshold=f.same_paper_evidence.words_count>500}catch(t){}try{f.same_paper_evidence.doi_match=!(!s.doi||!A.includes(s.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(t){}try{f.same_paper_evidence.title_match=!(!s.title||!A.includes(s.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(t){}if(null!=s.author)try{for(u=0,f.same_paper_evidence.author_match=!1,"string"==typeof s.author&&(s.author={name:s.author}),Array.isArray(s.author)||(s.author=[s.author]),W=s.author,y=0,x=W.length;y<x&&(n=W[y],!0!==f.same_paper_evidence.author_match);y++)try{if(o=(null!=(z=null!=(J=null!=(B=null!=(Y=n.last)?Y:n.lastname)?B:n.family)?J:n.surname)?z:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),l=(null!=(F=null!=(X=null!=(V=n.first)?V:n.firstname)?X:n.given)?F:n.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),_=A.indexOf(o),o.length>2&&l.length>0&&-1!==_&&A.substring(_-20,_+o.length+20).includes(l)&&(u+=1,s.author.length<3&&1===u||s.author.length>2&&u>1)){f.same_paper_evidence.author_match=!0;break}}catch(t){}}catch(t){}if(null!=f.format)for(b=0,k=(R=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;b<k;b++)if(m=R[b],f.format.includes(m)){f.same_paper_evidence.document_format=!0;break}f.same_paper=!!(f.same_paper_evidence.words_more_than_threshold&&(f.same_paper_evidence.doi_match||f.same_paper_evidence.title_match||f.same_paper_evidence.author_match)&&f.same_paper_evidence.document_format),f.same_paper_evidence.words_count<150&&"pdf"===f.format&&(f.same_paper_evidence.words_count=0,f.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),f.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(P=await this.src.google.sheets(a?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),I=0,S=P.length;I<S;I++){w=P[I],f.version_evidence.strings_checked+=1,Z=w["what to search"],$=w["where to search"],g=w["how to search"],v=w["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&null!=s[(H=Z.split("<<")[1].split(">>")[0]).toLowerCase()]&&(Z=Z.replace("<<"+H+">>",s[H.toLowerCase()])),C=!1,"string"===g?C=!!("file"===$&&d.includes(Z)||"file"!==$&&(null!=s.title&&s.title.includes(Z)||null!=f.name&&f.name.includes(Z))):(D=new RegExp(Z,"gium"),C="file"===$&&null!==O.match(D)||"file"!==$&&(null!=s.title&&null!==s.title.match(D)||null!=f.name&&null!==f.name.match(D))),C){if("string"==typeof(G=w.value))try{G=parseInt(G)}catch(t){}"number"!=typeof G&&(G=1),!v||"publisher pdf"!==(E=v.toLowerCase())&&"publishedversion"!==E?f.version_evidence.score-=G:f.version_evidence.score+=G,f.version_evidence.strings_matched.push({indicates:v,found:g+" "+Z,in:$,score_value:G})}}catch(t){p=t,null==(c=f.version_evidence).strings_errored&&(c.strings_errored=[]),f.version_evidence.strings_errored.push({tried:g+" "+Z,in:$,error:p.toString()})}}}catch(t){}f.version_evidence.score>0&&(f.version="publishedVersion"),f.version_evidence.score<0&&(f.version="acceptedVersion"),"unknown"===f.version&&f.version_evidence.strings_checked>0&&(f.version="acceptedVersion");try{null!=(null!=(j=await this.licence(void 0,O))?j.licence:void 0)&&(f.licence=j.licence,f.licence_evidence=j)}catch(t){}f.archivable=!1,i?(f.archivable=!0,i===f.checksum?(f.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",f.admin_confirms=!0):(f.archivable_reason="The depositor says that this file is a version that can be archived",f.depositor_says=!0)):f.same_paper?("pdf"!==f.format&&(f.archivable=!0,f.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!f.archivable&&null!=f.licence&&f.licence.toLowerCase().startsWith("cc")&&(f.archivable=!0,f.archivable_reason="It appears this file contains a "+f.licence+" licence statement. Under this licence the article can be archived"),f.archivable||(f.version?(null!=s&&"{}"!==JSON.stringify(s)&&null==r&&(r=await this.permissions(s)),f.version===(null!=r&&null!=(T=r.best_permission)?T.version:void 0)?(f.archivable=!0,f.archivable_reason="We believe this is a "+f.version.split("V")[0]+" version and our permission system says that version can be shared"):null==f.archivable_reason&&(f.archivable_reason="We believe this file is a "+f.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):f.archivable_reason="We cannot confirm if it is an archivable version or not")):null==f.archivable_reason&&(f.archivable_reason=f.same_paper_evidence.words_more_than_threshold?f.same_paper_evidence.document_format?s.doi||s.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+f.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==t&&null==e||(f.error=null!=(L=t.error)?L:"Could not extract any content");return f.archivable&&null==f.licence&&((null!=r&&null!=(q=r.best_permission)?q.licence:void 0)?f.licence=r.best_permission.licence:(null!=(U=null!=r&&null!=(M=r.best_permission)?M.deposit_statement:void 0)?U:"").toLowerCase().startsWith("cc")&&(f.licence=r.best_permission.deposit_statement)),f.metadata=s,f},s.archivable._bg=!0;u=[].indexOf;s.metadata=async function(t){var e;return null!=(e=await this.find(t))?e.metadata:void 0},s.find=async function(t,e={},i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A;O={},r=async t=>{var i,s;for(s in i=await this.citation(t))"url"===s||"paywall"===s?null==O[s]&&(O[s]=i[s]):null==e[s]&&(e[s]=i[s]);return!0},"string"==typeof t&&(t=t.split("doi.org/").pop().startsWith("10.")?{doi:t}:{title:t});try{null==t&&(t=this.copy(this.params))}catch(t){}null==t&&(t={}),null==i&&(i=null!=(g=t.dom)?g:"string"==typeof this.body?this.body:void 0),t.metadata&&(t.find=t.metadata),t.find&&(t.find.startsWith("10.")&&t.find.includes("/")?t.doi=t.find:t.url=t.find,delete t.find),null==t.url&&(t.url=null!=(y=t.q)?y:t.id),t.url&&("number"==typeof t.url&&(t.url=t.url.toString()),t.url.startsWith("/10.")&&(u="10."+t.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&u.split("/")[0].length>6&&u.length>8&&((c=u.split("/")).length>2&&(u=c.join("/")),null==e.doi&&(e.doi=u)),t.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==e.doi&&(e.doi=t.url.replace("doi:","").replace("doi.org/","").trim()),t.url="https://doi.org/"+e.doi):t.url.toLowerCase().startsWith("pmc")?(null==e.pmcid&&(e.pmcid=t.url.toLowerCase().replace("pmcid","").replace("pmc","")),t.url="http://europepmc.org/articles/PMC"+e.pmcid):t.url.replace(/pmid/i,"").replace(":","").length<10&&t.url.includes(".")&&!isNaN(parseInt(t.url.replace(/pmid/i,"").replace(":","").trim()))?(null==e.pmid&&(e.pmid=t.url.replace(/pmid/i,"").replace(":","").trim()),t.url="https://www.ncbi.nlm.nih.gov/pubmed/"+e.pmid):null!=e.title||t.url.startsWith("http")||(t.url.includes("{")||(null!=(_=t.url.replace("...","").match(/\./gi))?_:[]).length>3||(null!=(v=t.url.match(/\(/gi))?v:[]).length>2?t.citation=t.url:e.title=t.url),t.url.startsWith("http")&&t.url.includes(".")||delete t.url),"string"==typeof t.title&&(t.title.includes("{")||(null!=(b=t.title.replace("...","").match(/\./gi))?b:[]).length>3||(null!=(w=t.title.match(/\(/gi))?w:[]).length>2)&&(t.citation=t.title,delete t.title),null==e.doi&&(e.doi=t.doi),null==e.title&&(e.title=t.title),null==e.pmid&&(e.pmid=t.pmid),null==e.pmcid&&(e.pmcid=null!=(x=t.pmcid)?x:t.pmc),t.citation&&await r(t.citation);try{e.title=e.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(t){}try{e.title=await this.decode(e.title)}catch(t){}try{e.doi=e.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(t){}for("string"==typeof e.doi&&e.doi.startsWith("10.")||delete e.doi,!e.title&&i&&"string"==typeof t.url&&(t.url.includes("alma.exlibrisgroup.com")||t.url.includes("/exlibristest"))&&delete t.url,null!=t.demo&&(O.demo=t.demo),("10.1234/567890"===e.doi||null!=e.doi&&e.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===e.title||"qZooaHWRz9NLFNcgR"===(k=t.from)||"eZwJ83xp3oZDaec86"===k)&&null==O.demo&&(O.demo=!0),O.demo&&null==O.test&&(O.test=!0),h=!1,f=!1,n=async()=>{var s,a,n,l,o;return null==i&&null==t.url||e.doi||null!=e.pmid||null!=e.pmcid||null!=e.title||(o=await this.scrape(null!=i?i:t.url),await r(o)),e.doi||((e.pmid||e.pmcid)&&(h=await this.src.epmc[e.pmcid?"pmc":"pmid"](null!=(l=e.pmcid)?l:e.pmid),await r(h)),!e.doi&&e.title&&e.title.length>8&&e.title.split(" ").length>1&&(e.title=e.title.replace(/\+/g," "),(null!=(n=await this.src.crossref.works.title(e.title))?n.type:void 0)&&(null!=n?n.DOI:void 0)&&await r(n),e.doi||!1!==(f=await this.src.microsoft.graph(e.title))&&(null!=f?f.PaperTitle:void 0)&&await r(f),e.doi||h||!1!==(h=await this.src.epmc.title(e.title))&&await r(h))),e.doi&&(a=async()=>{var t;return null==(t=await this.src.oadoi(e.doi))&&(O.doi_not_in_oadoi=e.doi),(null!=t?t.doi:void 0)&&(null!=e?e.doi:void 0)&&t.doi.toLowerCase()===e.doi.toLowerCase()&&await r(t),!0},s=async()=>{if(null!=(n=await this.src.crossref.works(e.doi))?n.type:void 0){try{n.published=await this.src.crossref.works.published(n);try{n.year=n.published.split("-")[0]}catch(t){}try{n.year=parseInt(n.year)}catch(t){}try{n.publishedAt=await this.epoch(n.published)}catch(t){}}catch(t){}await r(n)}else O.doi_not_in_crossref=e.doi;return!0},await Promise.all([a(),s()])),!0},await n(),!1!==f&&!e.doi&&!i&&!t.url&&!h&&e.title&&e.title.length>8&&e.title.split(" ").length>1&&(m=e.title.toLowerCase().replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),(null!=(o=await this.src.microsoft.bing(m))?o.data:void 0)&&o.data.length&&(l=o.data[0].name.toLowerCase().replace("(pdf)","").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),m.replace(/ /g,"").startsWith(l.replace(/ /g,""))&&(t.url=o.data[0].url.replace(/"/g,""),"string"==typeof t.url&&t.url.includes("pubmed.ncbi")&&(e.pmid=t.url.replace(/\/$/,"").split("/").pop()),"string"==typeof t.url&&t.url.includes("/10.")&&null==e.doi&&(e.doi="10."+t.url.split("/10.")[1]))),(e.doi||e.pmid||t.url)&&await n()),s=async()=>{var i;if((e.doi||e.title&&e.title.length>8&&e.title.split(" ").length>1)&&(t.from||null!=t.config)&&("instantill"===t.plugin||!0===t.ill))try{null==O.ill&&(O.ill={subscription:await this.ill.subscription(null!=(i=t.config)?i:t.from,e)})}catch(t){}return!0},a=async()=>{var i;return e.doi&&(t.permissions||"shareyourpaper"===t.plugin)&&null==O.permissions&&(O.permissions=await this.permissions(e,null!=(i=t.config)?i.ror:void 0,!1)),!0},await Promise.all([s(),a()]),d=0,p=(S=["title","journal","year","doi"]).length;d<p;d++)t[A=S[d]]&&t[A]!==e[A]&&(e[A]=t[A]);return O.metadata=e,O},s.citation=function(t){var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt,pt,ft,mt,gt,yt,_t,vt,bt,wt,xt,kt,St,Ot,At,jt,It,Ct,Dt,Nt,Lt,Rt,Pt,Et,Tt,qt,Ut,Mt,Wt,zt,Jt,Bt,Yt,Ft;Ut={};try{null==t&&(t=null!=(P=this.params.citation)?P:this.params)}catch(t){}if("string"==typeof t&&(t.startsWith("{")||t.startsWith("[")))try{t=JSON.parse(t)}catch(t){}if("object"==typeof t){Ut.doi=null!=(E=t.DOI)?E:t.doi,t.pmid&&(Ut.pmid=t.pmid),t.pmcid&&(Ut.pmcid=t.pmcid);try{Ut.type=null!=(X=t.type)?X:t.genre}catch(t){}null==Ut.issn&&(Ut.issn=null!=(st=null!=(ft=null!=(Ot=t.ISSN)?Ot:t.issn)?ft:null!=(Pt=t.journalInfo)&&null!=(Et=Pt.journal)?Et.issn:void 0)?st:null!=(Tt=t.journal)?Tt.issn:void 0),null!=(null!=(qt=t.journalInfo)&&null!=(T=qt.journal)?T.eissn:void 0)&&(null==Ut.issn&&(Ut.issn=[]),"string"==typeof Ut.issn&&(Ut.issn=[Ut.issn]),Ut.issn.push(t.journalInfo.journal.eissn)),t.journal_issns&&null==Ut.issn&&(Ut.issn=t.journal_issns.split(","));try{Array.isArray(t.title)&&null==Ut.title&&(Ut.title=t.title[0])}catch(t){}try{null!=t.subtitle&&t.subtitle.length&&t.subtitle[0].length&&(Ut.title+=": "+t.subtitle[0])}catch(t){}null==Ut.title&&(Ut.title=null!=(q=t.dctitle)?q:null!=(U=t.bibjson)?U.title:void 0),404!==(M=t.title)&&"404"!==M&&null==Ut.title&&(Ut.title=t.title),"string"==typeof Ut.title&&(Ut.title=Ut.title.replace(/\s\s+/g," ").trim());try{null==Ut.journal&&(Ut.journal=t["container-title"][0])}catch(t){}try{Ut.shortname=t["short-container-title"][0]}catch(t){}try{Ut.shortname=null!=(W=t.journalInfo.journal.isoabbreviation)?W:t.journalInfo.journal.medlineAbbreviation}catch(t){}Ut.shortname&&!Ut.journal_short&&(Ut.journal_short=Ut.shortname),null==Ut.journal&&(Ut.journal=null!=(z=null!=(J=t.journal_name)?J:null!=(B=t.journalInfo)&&null!=(Y=B.journal)?Y.title:void 0)?z:null!=(F=t.journal)?F.title:void 0),t.journal&&(Ut.journal=t.journal.split("(")[0].trim());try{for(c=0,m=(V=["title","journal"]).length;c<m;c++)Ut[p=V[c]]=Ut[p].charAt(0).toUpperCase()+Ut[p].slice(1)}catch(t){}null==Ut.publisher&&(Ut.publisher=t.publisher),Ut.publisher&&(Ut.publisher=Ut.publisher.trim());try{null!=t.issue&&null==Ut.issue&&(Ut.issue=t.issue)}catch(t){}try{(null!=($=t.journalInfo)?$.issue:void 0)&&null==Ut.issue&&(Ut.issue=t.journalInfo.issue)}catch(t){}try{null!=t.volume&&null==Ut.volume&&(Ut.volume=t.volume)}catch(t){}try{(null!=(G=t.journalInfo)?G.volume:void 0)&&null==Ut.volume&&(Ut.volume=t.journalInfo.volume)}catch(t){}try{null!=t.page&&null==Ut.page&&(Ut.page=t.page.toString())}catch(t){}for(t.pageInfo&&(Ut.page=t.pageInfo.toString()),(t.abstract||t.abstractText)&&(Ut.abstract=null!=(H=t.abstract)?H:t.abstractText),h=0,g=(Z=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;h<g;h++)if(C=Z[h],"string"!=typeof Ut.published){if(Wt=null!=(Q=null!=(K=t[C])?K:null!=(tt=t["journal-issue"])?tt[C.replace("journal-issue.","")]:void 0)?Q:null!=(et=t.journalInfo)?et[C.replace("journalInfo.","")]:void 0){"number"==typeof Wt&&(Wt=Wt.toString());try{"string"!=typeof Wt&&(Wt=Wt["date-time"].toString())}catch(t){}if("string"!=typeof Wt)try{for(d in Wt["date-parts"][0])"number"!=(it=typeof Wt["date-parts"][0][d])&&"string"!==it&&(Wt["date-parts"][0][d]="01");Wt=Wt["date-parts"][0].join("-")}catch(t){}"string"==typeof Wt&&(Ut.published=Wt.includes("T")?Wt.split("T")[0]:Wt,Ut.published=Ut.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),Ut.published.includes("-")||(Ut.published+="-01"),3!==Ut.published.split("-").length&&(Ut.published+="-01"),null==Ut.year&&(Ut.year=Ut.published.split("-")[0]),3!==Ut.published.split("-").length&&delete Ut.published,4!==Ut.year.toString().length&&delete Ut.year)}if(Ut.published)break}t.year&&null==Ut.year&&(Ut.year=t.year);try{null==Ut.year&&(Ut.year=t.journalInfo.yearOfPublication.trim())}catch(t){}if(null==Ut.author&&(null!=t.author||null!=t.z_authors||(null!=(rt=t.authorList)?rt.author:void 0))){null==Ut.author&&(Ut.author=[]);try{for(lt=null!=(at=null!=(nt=t.author)?nt:t.z_authors)?at:t.authorList.author,j=0,y=lt.length;j<y;j++)if("string"==typeof(e=lt[j]))Ut.author.push({name:e});else{if((r={}).given=null!=(ot=e.given)?ot:e.firstName,r.family=null!=(ut=e.family)?ut:e.lastName,r.name=(r.given?r.given+" ":"")+(null!=(ct=r.family)?ct:""),null!=e.affiliation)try{for(ht=r.affiliation?Array.isArray(e.affiliation)?e.affiliation:[e.affiliation]:r.authorAffiliationDetailsList.authorAffiliation,I=0,_=ht.length;I<_;I++)"string"==typeof(i=ht[I])?(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:(null!=(dt=i.name)?dt:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(t){}Ut.author.push(r)}}catch(t){}}try{null!=t.subject&&t.subject.length&&"string"==typeof t.subject[0]&&(Ut.subject=t.subject)}catch(t){}try{null!=(null!=(pt=t.keywordList)?pt.keyword:void 0)&&t.keywordList.keyword.length&&"string"==typeof t.keywordList.keyword[0]&&(Ut.keyword=t.keywordList.keyword)}catch(t){}try{for(vt=[...null!=(mt=null!=(gt=t.meshHeadingList)?gt.meshHeading:void 0)?mt:[],...null!=(yt=null!=(_t=t.chemicalList)?_t.chemical:void 0)?yt:[]],L=0,v=vt.length;L<v;L++)O=vt[L],null==Ut.keyword&&(Ut.keyword=[]),"string"==typeof(A="string"==typeof O?O:null!=(bt=O.name)?bt:O.descriptorName)&&A&&u.call(Ut.keyword,A)<0&&Ut.keyword.push(A)}catch(t){}"string"==typeof t.license&&(Ut.licence=t.license.trim().replace(/ /g,"-")),"string"==typeof t.licence&&(Ut.licence=t.licence.trim().replace(/ /g,"-"));try{(null!=(wt=t.best_oa_location)?wt.license:void 0)&&null!==(null!=(xt=t.best_oa_location)?xt.license:void 0)&&null==Ut.licence&&(Ut.licence=t.best_oa_location.license)}catch(t){}if(!Ut.licence){if(Array.isArray(t.assertion))for(R=0,b=(kt=t.assertion).length;R<b;R++)"OPEN ACCESS"===(e=kt[R]).label&&e.URL&&e.URL.includes("creativecommons")&&null==Ut.licence&&(Ut.licence=e.URL);if(Array.isArray(t.license))for(zt=0,w=(At=null!=(St=t.license)?St:[]).length;zt<w;zt++)!(f=At[zt]).URL||!f.URL.includes("creativecommons")||Ut.licence&&Ut.licence.includes("creativecommons")||null==Ut.licence&&(Ut.licence=f.URL)}if("string"==typeof Ut.licence&&Ut.licence.includes("/licenses/")&&(Ut.licence="cc-"+Ut.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==Ut.url&&(Ut.url=null!=(jt=null!=(It=t.best_oa_location)?It.url_for_pdf:void 0)?jt:null!=(Ct=t.best_oa_location)?Ct.url:void 0),!Ut.url&&null!=(null!=(Dt=t.fullTextUrlList)?Dt.fullTextUrl:void 0))for(Bt=0,x=(Nt=t.fullTextUrlList.fullTextUrl).length;Bt<x;Bt++)"oa"!==(Lt=(n=Nt[Bt]).availabilityCode.toLowerCase())&&"f"!==Lt||Ut.url&&("pdf"!==n.documentStyle||Ut.url.includes("pdf"))||(Ut.url=n.url)}else if("string"==typeof t)try{(t=t.replace(/citation\:/gi,"").trim()).includes("title")&&(t=t.split("title")[1].trim()),(t=t.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(Ut.doi=t.split("doi:")[1].split(",")[0].split(" ")[0].trim()),t.includes("doi.org/")&&(Ut.doi=t.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!Ut.doi&&t.includes("http")&&(Ut.url="http"+t.split("http")[1].split(" ")[0].trim());try{(t.includes("|")||t.includes("}"))&&(Ut.title=t.split("|")[0].split("}")[0].trim()),t.split('"').length>2?Ut.title=t.split('"')[1].trim():t.split("'").length>2&&null==Ut.title&&(Ut.title=t.split("'")[1].trim())}catch(t){}try{for(N=t.replace(/,\./g," ").split(" "),Yt=0,k=N.length;Yt<k;Yt++)D=N[Yt],Ut.year||4===(D=D.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Jt=parseInt(D))||isNaN(Jt)||(Ut.year=Jt))}catch(t){}try{!Ut.title&&Ut.year&&t.indexOf(Ut.year)<t.length/4&&(Ut.title=t.split(Ut.year)[1].trim(),(!Ut.title.includes("(")||Ut.title.indexOf(")")<Ut.title.indexOf("("))&&(Ut.title=Ut.title.replace(")","")),Ut.title.indexOf(".")<3&&(Ut.title=Ut.title.replace(".","")),Ut.title.indexOf(",")<3&&(Ut.title=Ut.title.replace(",","")),Ut.title=Ut.title.trim(),Ut.title.includes(".")?Ut.title=Ut.title.split(".")[0]:Ut.title.includes(",")&&(Ut.title=Ut.title.split(",")[0]))}catch(t){}if(Ut.title){try{if(a=t.split(Ut.title)[0],Ut.year&&a.includes(Ut.year)&&(a=a.split(Ut.year)[0]),Ut.url&&a.indexOf(Ut.url)>0&&(a=a.split(Ut.url)[0]),Ut.url&&a.startsWith(Ut.url)&&(a=a.replace(Ut.url)),Ut.doi&&a.startsWith(Ut.doi)&&(a=a.replace(Ut.doi)),a.indexOf(".")<3&&(a=a.replace(".","")),a.indexOf(",")<3&&(a=a.replace(",","")),a.lastIndexOf("(")>a.length-3&&(a=a.substring(0,a.lastIndexOf("("))),a.lastIndexOf(")")>a.length-3&&(a=a.substring(0,a.lastIndexOf(")"))),a.lastIndexOf(",")>a.length-3&&(a=a.substring(0,a.lastIndexOf(","))),a.lastIndexOf(".")>a.length-3&&(a=a.substring(0,a.lastIndexOf("."))),(a=a.trim()).length>6)if(a.includes(","))for(Ut.author=[],Rt=a.split(","),Ft=0,S=Rt.length;Ft<S;Ft++)s=Rt[Ft],Ut.author.push({name:s});else Ut.author=[{name:a}]}catch(t){}try{Mt=t.split(Ut.title)[1],Ut.url&&Mt.includes(Ut.url)&&(Mt=Mt.replace(Ut.url)),Ut.doi&&Mt.includes(Ut.doi)&&(Mt=Mt.replace(Ut.doi)),Mt.indexOf(".")<3&&(Mt=Mt.replace(".","")),Mt.indexOf(",")<3&&(Mt=Mt.replace(",","")),(Mt=Mt.trim()).length>6&&(Ut.journal=Mt,Mt.includes(",")&&(Ut.journal=Ut.journal.split(",")[0].replace(/in /gi,"").trim()),Ut.journal.indexOf(".")<3&&(Ut.journal=Ut.journal.replace(".","")),Ut.journal.indexOf(",")<3&&(Ut.journal=Ut.journal.replace(",","")),Ut.journal=Ut.journal.trim())}catch(t){}}try{if(Ut.journal&&(Mt=t.split(Ut.journal)[1],Ut.url&&Mt.includes(Ut.url)&&(Mt=Mt.replace(Ut.url)),Ut.doi&&Mt.includes(Ut.doi)&&(Mt=Mt.replace(Ut.doi)),Mt.indexOf(".")<3&&(Mt=Mt.replace(".","")),Mt.indexOf(",")<3&&(Mt=Mt.replace(",","")),(Mt=Mt.trim()).length>4)){if(Mt.includes("retrieved")&&(Mt=Mt.split("retrieved")[0]),Mt.includes("Retrieved")&&(Mt=Mt.split("Retrieved")[0]),Ut.volume=Mt,Ut.volume.includes("(")){Ut.volume=Ut.volume.split("(")[0],Ut.volume=Ut.volume.trim();try{Ut.issue=Mt.split("(")[1].split(")")[0],Ut.issue=Ut.issue.trim()}catch(t){}}if(Ut.volume.includes(",")){Ut.volume=Ut.volume.split(",")[0],Ut.volume=Ut.volume.trim();try{Ut.issue=Mt.split(",")[1],Ut.issue=Ut.issue.trim()}catch(t){}}if(Ut.volume)try{isNaN(parseInt(Ut.volume))&&delete Ut.volume}catch(t){}if(Ut.issue){Ut.issue.includes(",")&&(Ut.issue=Ut.issue.split(",")[0].trim());try{isNaN(parseInt(Ut.issue))&&delete Ut.issue}catch(t){}}if(Ut.volume&&Ut.issue)try{(Mt=t.split(Ut.journal)[1]).includes("retriev")&&(Mt=Mt.split("retriev")[0]),Mt.includes("Retriev")&&(Mt=Mt.split("Retriev")[0]),Ut.url&&Mt.includes(Ut.url)&&(Mt=Mt.split(Ut.url)[0]),Ut.doi&&Mt.includes(Ut.doi)&&(Mt=Mt.split(Ut.doi)[0]),(Mt=(Mt=Mt.substring(Mt.indexOf(Ut.volume)+(Ut.volume+"").length)).substring(Mt.indexOf(Ut.issue)+(Ut.issue+"").length)).indexOf(".")<2&&(Mt=Mt.replace(".","")),Mt.indexOf(",")<2&&(Mt=Mt.replace(",","")),Mt.indexOf(")")<2&&(Mt=Mt.replace(")","")),Mt=Mt.trim(),isNaN(parseInt(Mt.substring(0,1)))||(Ut.pages=Mt.split(" ")[0].split(".")[0].trim(),Ut.pages.length>5&&(Ut.pages=Ut.pages.split(", ")[0]))}catch(t){}}}catch(t){}if(!Ut.author&&t.includes("et al")&&(o=t.split("et al")[0].trim(),t.startsWith(o)&&(Ut.author=[{name:o+"et al"}])),Ut.title&&!Ut.volume)try{(l=t.split(Ut.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(Ut.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!Ut.issue&&l.includes("iss")&&(Ut.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!Ut.pages&&l.includes("page")&&(Ut.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(t){}}catch(t){}return"number"==typeof Ut.year&&(Ut.year=Ut.year.toString()),Ut},s.availability=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C;if(null==t&&(t=this.copy(this.params)),delete this.params.dom,t.availability&&(t.availability.startsWith("10.")&&t.availability.includes("/")?t.doi=t.availability:t.availability.includes(" ")?t.title=t.availability:t.id=t.availability,delete t.availability),Array.isArray(t.url)&&(t.url=t.url[0]),!t.test&&t.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=t&&(i.data.match=null!=(a=null!=(n=null!=(y=null!=(b=null!=(w=null!=(x=null!=(k=null!=(S=t.doi)?S:t.pmid)?k:t.pmc)?x:t.pmcid)?w:t.title)?b:t.url)?y:t.id)?n:t.citation)?a:t.q),"object"==typeof e&&"{}"!==JSON.stringify(e)&&null!=e.metadata&&(i.v2=e),null==i.v2&&(i.v2=await this.find(t)),null!=i.v2){null==(s=i.data).match&&(s.match=null!=(O=null!=(A=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(d=i.v2.metadata)?d.title:void 0)?o:null!=(p=i.v2.metadata)?p.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?A:null!=(m=i.v2.metadata)?m.pmcid:void 0)?O:null!=(g=i.v2.metadata)?g.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(t){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(r=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(I=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+r+" AND type:article&sort=createdAt:desc"))&&null!=(_=I.hits)?_.total:void 0)&&((C={type:"article",_id:(j=I.hits.hits[0]._source)._id}).ucreated=!(!t.uid||(null!=(v=j.user)?v.id:void 0)!==t.uid),i.data.requests.push(C))}catch(t){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i};u=[].indexOf;s.ill=async function(t){var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x;null==t&&(t=this.copy(this.params)).ill&&(t.doi=t.ill,delete t.ill),null==t.metadata&&(t.metadata=await this.metadata(t)),!0===t.pilot&&(t.pilot=Date.now()),!0===t.live&&(t.live=Date.now()),r=t.config;try{r=JSON.parse(r)}catch(t){}for(d in("string"==typeof r||!r&&t.from)&&(null!=(r=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=t.from)?m:r)))&&"{}"!==JSON.stringify(r)||(r=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(g=t.from)?g:r)))),null==r&&(r={}),x={name:"librarian",details:""},p=["title","author","volume","issue","date","pages"],t)if("metadata"===d){for(h in t[d])"email"!==h&&(t[h]=t[d][h],u.call(p,h)<0&&p.push(h));delete t.metadata}else u.call(p,d)<0&&p.push(d);for(n=0,o=p.length;n<o;n++)if(t[f=p[n]]&&(x[f]=t[f],"author"===f)){for("<p>Authors:<br>",a=!0,s=[],l=0,c=(y=t[f]).length;l<c;l++)(e=y[l]).family&&(a?a=!1:", ",i=e.family+(e.given?" "+e.given:""),s.push(i));x[f]=s}return null!=t.author&&delete t.author,x.illid=t._id=await this.uid(),r.search&&r.search.length&&(t.issn||t.journal)&&(-1!==r.search.indexOf("worldcat")?(b=r.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=t.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(_=t.issn)?_:t.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=r.search,b+=t.issn?t.issn:t.journal),x.worldcatsearchurl=b),w=(w=await this.templates("instantill_create")).content,t.forwarded||t.resolved||!r.email&&!t.email||this.mail({svc:"oaworks",vars:x,template:w,to:null!=(v=r.email)?v:t.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+t._id}),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:x,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+t._id,to:"mark@cottagelabs.com"})),t},s.ill._index=!0,s.ill.collect=async function(t){var e,i,s;for(e in null==t&&(t=this.copy(this.params)),i=t.collect,null==t._id&&(t._id=await this.uid()),s="https://script.google.com/macros/s/"+i+"/exec?",t)"collect"!==e&&(s+=("_id"===e?"uuid":e)+"="+t[e]+"&");return this.waitUntil(this.fetch(s)),this.waitUntil(this.svc.rscvd(t)),!0},s.ill.openurl=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p;for(s in null==t&&(t=null!=(u=this.params.config)?u:{}),null==e&&(e=null!=(c=this.params.meta)?c:await this.metadata()),t.ill_redirect_base_url&&null==t.ill_form&&(t.ill_form=t.ill_redirect_base_url),t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),r={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})t[s]||(t[s]=r[s]);for(n in d="",t.ill_added_params&&(d+=t.ill_added_params.replace("?","")+"&"),d+=t.sid+"=InstantILL&",e){if(p="","author"===n)for(a=0,l=(h=Array.isArray(e.author)?e.author:[e.author]).length;a<l;a++)i=h[a],p.length&&(p+=", "),p+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==n&&"pmid"!==n&&"pmc"!==n&&"pmcid"!==n&&"url"!==n&&"journal"!==n&&"title"!==n&&"year"!==n&&"issn"!==n&&"volume"!==n&&"issue"!==n&&"page"!==n&&"crossref_type"!==n&&"publisher"!==n&&"published"!==n&&"notes"!==n||(p=e[n]);p&&(d+=(t[n]?t[n]:n)+"="+encodeURIComponent(p)+"&")}return e.usermetadata&&(o=t.notes?t.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},s.ill.subscription=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(t||e||!this.params.sub&&!this.params.subscription||((t=this.copy(this.params)).sub&&(t.subscription=t.sub),this.params.meta?(e=this.params.meta,delete t.meta):t.doi&&2===this.keys(t).length?(console.log(t.doi),e=await this.metadata(t.doi),delete t.doi):(e=this.copy(t),delete t.doi)),null==t&&(t=null!=(l=this.params.config)?l:{}),"string"==typeof t&&(null!=(t=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+t))&&"{}"!==JSON.stringify(t)||(t=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:t)))),null==e&&(e=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=t.subscription)for(h in t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),a=await this.ill.openurl(t,e),t.ill_added_params&&(a=a.replace(t.ill_added_params.replace("?",""),"")),"string"==typeof t.subscription&&(t.subscription=t.subscription.split(",")),"string"==typeof t.subscription_type&&(t.subscription_type=t.subscription_type.split(",")),null==t.subscription_type&&(t.subscription_type=[]),t.subscription)if("object"==typeof(p=t.subscription[h])?(f=p.type,p=p.url):f=null!=(u=t.subscription_type[h])?u:"unknown",p=p.trim()){"serialssolutions"===f||-1!==p.indexOf("serialssolutions")?(-1!==(g=p.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),p="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===p.indexOf("sfx.")||-1!==p.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===p.indexOf(".exlibris")||-1!==p.indexOf("response_type")||(p=p.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):p+=(-1===p.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(y=p+(-1===p.indexOf("?")?"?":"&")+a).indexOf("snc.idm.oclc.org/login?url=")&&(y=y.split("snc.idm.oclc.org/login?url=")[1]),y=y.replace("cache=true",""),("sfx"===f||-1!==p.indexOf("sfx.")&&-1!==y.indexOf("=10."))&&(y=y.replace("=10.","=doi:10.")),("exlibris"===f||-1!==p.indexOf(".exlibris")&&-1!==y.indexOf("doi=10."))&&(y=y.replace("doi=10.","ID=doi:10.")),n="",d="",i=!1,c.lookups.push(y);try{d=-1!==(n=-1!==y.indexOf(".xml.serialssolutions")||-1!==y.indexOf("sfx.response_type=simplexml")||-1!==y.indexOf("response_type=xml")?await this.fetch(y):await this.puppet(y)).indexOf("<body")?n.toLowerCase().split("<body")[1].split("</body")[0]:n,c.contents.push(d)}catch(t){t,i=!0}if("sfx"===f||-1!==y.indexOf("sfx.")){if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{if(c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}catch(t){}else if(-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=y,c.findings.sfx=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}else if("eds"===f||-1!==y.indexOf("ebscohost.")){if(i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==n.indexOf('<a data-auto="menu-link" href="')&&(c.url=y.replace("://","______").split("/")[0].replace("______","://")+n.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="eds",c;c.url=void 0}}else if("serialssolutions"===f||-1!==y.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">')){if((s=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=s,c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}else if(-1===d.indexOf("ss_noresults"))try{if(m=y.split("?")[0]+"?ShowSupressedLinks"+n.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(r=await this.puppet(m)).indexOf("ArticleCL")&&-1!==r.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+r.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}catch(t){i&&c.error.push("serialssolutions")}}else if(("exlibris"===f||-1!==y.indexOf(".exlibris"))&&(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")))return c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris",c}return c},s.licence=async function(t,e,i,s){var r,a,n,l,o,u,c,h,d,p,f,m,g;null==t&&(t=this.params.url),null==e&&(e=null!=(c=this.params.content)?c:this.body),t||e||!this.params.licence&&!this.params.doi||(t="https://doi.org/"+(null!=(h=this.params.licence)?h:this.params.doi)),null!=t&&(t=t.replace(/(^\s*)|(\s*$)/g,""));try{null==e&&(e=await this.puppet(t))}catch(t){}if("number"==typeof e&&(e=void 0),null==i&&(i=this.params.start),null==s&&(s=this.params.end),l={},t&&(l.url=t),"string"==typeof e)for(null!=i&&e.includes(i)&&(e=e.split(i)[1]),s&&(e=e.split(s)[0]),e.length>1e6&&(l.large=!0,e=e.substring(0,5e5)+e.substring(e.length-5e5,e.length)),r=0,n=(f=null!=(d=null!=(o=await this.licences("*",1e4))&&null!=(p=o.hits)?p.hits:void 0)?d:[]).length;r<n;r++)if((!(a=f[r]._source).matchesondomains||"*"===a.matchesondomains||null==t||a.matchesondomains.toLowerCase().includes(t.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=a.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(m=!!(g=!!a.matchtext.includes("://")&&a.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&e.toLowerCase().includes(g))||e.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){l.licence=a.licencetype,l.match=a.matchtext,l.matched=m?g:u;break}return l},s.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1};u=[].indexOf;s.permissions=async function(t,e,i,s,a){var n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt,pt,ft,mt,gt,yt,_t,vt,bt,wt,xt,kt,St,Ot,At,jt,It,Ct;if(U=!1,m=!1,n=async function(e){var i,s,n,l,o,u,c,h,d,p,f,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R;if(m&&e.embargo_months&&(t.published||t.year)&&(s=new Date(Date.parse(null!=(y=t.published)?y:t.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+e.embargo_months)),e.embargo_end=s.toISOString().split("T")[0]),""===e.embargo_end&&delete e.embargo_end,e.copyright_name=e.copyright_owner&&"publisher"===e.copyright_owner.toLowerCase()?"string"==typeof e.issuer.parent_policy?e.issuer.parent_policy:"string"==typeof e.issuer.id?e.issuer.id:e.issuer.id[0]:!e.copyright_owner||"journal"!==(_=e.copyright_owner.toLowerCase())&&"affiliation"!==_?m&&e.copyright_owner&&e.copyright_owner.toLowerCase().includes("author")&&null!=t.author&&t.author.length&&(t.author[0].name||t.author[0].family)?(null!=(A=t.author[0].name)?A:t.author[0].family)+(t.author.length>1?" et al":""):"":null!=(O=t.journal)?O:"",("publisher"===(j=e.copyright_name.toLowerCase())||"journal"===j)&&(a||t.doi||(null!=(I=e.provenance)?I.example:void 0)))for(null==a&&(a=await this.src.crossref.works(null!=(C=t.doi)?C:e.provenance.example)),o=0,h=(N=null!=(D=null!=a?a.assertion:void 0)?D:[]).length;o<h;o++)if("copyright"===(i=N[o]).name.toLowerCase()){try{e.copyright_name=i.value}catch(t){}try{e.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(t){}}if(m&&""===e.copyright_year&&t.year&&(e.copyright_year=t.year),""===e.copyright_year&&delete e.copyright_year,m&&null!=e.deposit_statement&&e.deposit_statement.includes("<<")){for(l="",u=0,d=(L=e.deposit_statement.split("<<")).length;u<d;u++)if(g=L[u],""!==l||g.includes(">>")){if(null!=(R={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(n=g.split(">>"))[0].toLowerCase()]&&(f=R[f]),"author"===f)try{l+=(null!=(v=t.author[0].name)?v:t.author[0].family)+(t.author.length>1?" et al":"")}catch(t){}else l+=null!=(b=null!=(w=t[f])?w:e[f])?b:"";try{l+=n[1]}catch(t){}}else l+=g;e.deposit_statement=l}for(null!=e._id&&(null==e.meta&&(e.meta={}),e.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(e.issuer.type?e.issuer.type+"/":"")+e._id),"string"!=typeof(null!=(x=e.issuer)?x.has_policy:void 0)||"not publisher"!==(k=e.issuer.has_policy.toLowerCase().trim())&&"takedown"!==k||(U=e.issuer.has_policy),c=0,p=(S=["_id","hide"]).length;c<p;c++)delete e[S[c]];return e},o=t=>{var e,i,s,r,a,n;return n=t.can_archive?1e3:0,"In DOAJ"===(null!=(e=t.provenance)?e.oa_evidence:void 0)&&(n+=1e3),null!=t.requirements?n-=10:n+="publishedVersion"===t.version?200:"acceptedVersion"===t.version?100:0,t.licence&&(n-=5),n+="journal"===(null!=(i=t.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(s=t.issuer)?s.type.toLowerCase():void 0)?4:"university"===(null!=(r=t.issuer)?r.type.toLowerCase():void 0)?3:"article"===(null!=(a=t.issuer)?a.type.toLowerCase():void 0)?2:0,t.embargo_months&&t.embargo_months>=36&&(!t.embargo_end||Date.parse(t.embargo_end)<Date.now())&&(n-=25),n},"string"==typeof t&&(t=t.startsWith("10.")?{doi:t}:{issn:t}),null==t&&(t=this.copy(this.params)),!0===(null!=t?t.metadata:void 0)&&delete t.metadata,null!=(null!=t?t.permissions:void 0)&&(t.permissions.startsWith("journal/")?t.issn=t.permissions.replace("journal/",""):t.permissions.startsWith("affiliation/")?t.ror=t.permissions.replace("affiliation/",""):t.permissions.startsWith("publisher/")?t.publisher=t.permissions.replace("publisher/",""):t.permissions.startsWith("10.")&&t.permissions.includes("/")?t.doi=t.permissions:t.permissions.includes("-")&&t.permissions.length<10&&t.permissions.length>6?t.issn=t.permissions:t.permissions.includes(" ")||t.permissions.includes(",")||t.permissions.replace(/[0-9]/g,"").length===t.permissions.length?t.publisher=t.permissions:t.ror=t.permissions,delete t.permissions),t.affiliation&&(t.ror=t.affiliation,delete t.affiliation),null==t.ror&&(t.ror=e),"string"==typeof t.ror&&t.ror.includes(",")&&(t.ror=t.ror.split(",")),t.journal&&!t.journal.includes(" ")&&t.journal.includes("-")&&(t.issn=t.journal,delete t.journal),_=Array.isArray(t.issn)?t.issn:[],"string"==typeof t.issn&&t.issn.includes(",")&&(t.issn=t.issn.split(",")),"{}"===JSON.stringify(t)||t.issn&&!JSON.stringify(t.issn).includes("-")||t.doi&&("string"!=typeof t.doi||!t.doi.startsWith("10.")||!t.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(l=async()=>{var e,i,s,r,n;if(i=this.copy(t),"{}"!==JSON.stringify(i)){for(e in r=[],n=null!=(s=null!=a?a:await this.metadata(t.doi))?s:{})r.push(null!=t[e]?t[e]:t[e]=n[e]);return r}},!1===i||!t.doi||t.publisher&&t.issn||await l(),!t.published&&t.year&&(t.published=t.year+"-01-01"),m=null!=t.doi,t.issn){if("string"==typeof t.issn&&(t.issn=[t.issn]),!_.length)for(g=0,x=(F=t.issn).length;g<x;g++)y=F[g],u.call(_,y)<0&&_.push(y);try{null==t.doi&&(t.doi=await this.permissions.journals.example(_))}catch(t){}!m&&t.doi&&await l()}if(m&&"journal-article"!==t.type)return{body:"DOI is not a journal article",status:501};t.publisher&&t.publisher.includes("(")&&t.publisher.lastIndexOf(")")>.7*t.publisher.length&&(t.publisher=t.publisher.substring(0,t.publisher.lastIndexOf("(")).trim());try{t.citation="[",t.title&&(t.citation+=t.title+". "),t.journal&&(t.citation+=t.journal+" "),t.volume&&(t.citation+=t.volume+(t.issue?", ":" ")),t.issue&&(t.citation+=t.issue+" "),null==t.page&&null==t.pages||(t.citation+="p"+(null!=(tt=t.page)?tt:t.pages)),(t.year||t.published)&&(t.citation+=" ("+(null!=(ct=t.year)?ct:t.published).split("-")[0]+")"),t.citation=t.citation.trim(),t.citation+="]"}catch(t){}if(z={best_permission:void 0,all_permissions:[]},_t=[],null!=t.ror){if("string"==typeof t.ror&&(t.ror=[t.ror]),!(null!=(wt=await this.permissions.affiliations('issuer.id:"'+t.ror.join('" OR issuer.id:"')+'"'))&&null!=(ht=wt.hits)?ht.total:void 0))try{(null!=(dt=(xt=await this.src.ror(1===t.ror.length?t.ror[0]:'id:"'+t.ror.join(" OR id:")+'"')).hits)?dt.total:void 0)&&(xt=xt.hits.hits[0]._source),xt.country.country_code&&(wt=await this.permissions.affiliations('issuer.id:"'+xt.country.country_code+'"'))}catch(t){}for(v=0,k=(mt=null!=(pt=null!=wt&&null!=(ft=wt.hits)?ft.hits:void 0)?pt:[]).length;v<k;v++)bt=mt[v],(Ot=await n(bt._source)).score=await o(Ot),_t.push(Ot)}if(_.length)for(Y=_.length?'issuer.id:"'+_.join('" OR issuer.id:"')+'"':"",w=0,S=(V=null!=(gt=null!=(B=await this.permissions.journals(Y))&&null!=(X=B.hits)?X.hits:void 0)?gt:[]).length;w<S;w++)M=V[w],(vt=await n(M._source)).score=await o(vt),z.all_permissions.push(vt);if(_.length&&(c=await this.journal('ISSN:"'+_.join('" OR ISSN:"')+'"',1)),t.publisher){for(Y='issuer.id:"'+t.publisher+'"',E=0,O=(H=null!=($=null!=(B=await this.permissions.publishers(Y))&&null!=(G=B.hits)?G.hits:void 0)?$:[]).length;E<O;E++)M=H[E],(vt=await n(M._source)).score=await o(vt),z.all_permissions.push(vt);null==c&&null==(c=await this.journal('publisher:"'+t.publisher+'"',1))&&((null!=(f=await this.journal('publisher:"'+t.publisher.split(" ").join('" AND publisher:"')+'"',1))?f.publisher:void 0)===t.publisher?c=f:(null!=f?f.publisher:void 0)&&(R=(P=await this.levenshtein(f.publisher,t.publisher)).length.a>P.length.b?P.length.a:P.length.b,(P.distance<5||R/P.distance>10)&&(c=f)))}if((null!=c?c.publisher:void 0)&&!c.indoaj&&(J=(await this.permissions.publishers.oa(c.publisher)).oa),(null!=c?c.indoaj:void 0)||J){h={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes",id:c.issn},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}};try{for(Z=c.doaj.bibjson.license,T=0,A=Z.length;T<A;T++)d=Z[T],(!h.licence||h.licence.length>d.type)&&(h.licence=d.type)}catch(t){}if(null==h.licence)try{for(Q=c.license,q=0,j=Q.length;q<j;q++)L=Q[q],(!h.licence||h.licence.length>L.type)&&(h.licence=L.type)}catch(t){}c.indoaj?(h.embargo_months=0,h.provenance={oa_evidence:"In DOAJ"}):J&&(h.meta.creator=["joe+oapublisher@oa.works"],h.meta.contributors=["joe+oapublisher@oa.works"],h.provenance={oa_evidence:"OA publisher"}),"string"==typeof h.licence?(h.licence=h.licence.toLowerCase().trim(),h.licence.startsWith("cc")?h.licence=h.licence.replace(/ /g,"-"):h.licence.includes("creative")?h.licence=h.licence.includes("0")||h.licence.includes("zero")?"cc0":h.licence.includes("share")?"ccbysa":h.licence.includes("derivative")?"ccbynd":"ccby":delete h.licence):delete h.licence,h.score=await o(h),z.all_permissions.push(h)}if(t.doi&&(null==s&&(s=await this.src.oadoi(t.doi)),m&&(null!=s&&null!=(K=s.best_oa_location)?K.license:void 0)&&s.best_oa_location.license.includes("cc")&&((p={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:t.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(p.versions="submittedVersion"===p.version?["submittedVersion"]:"acceptedVersion"===p.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),p.score=await o(p),z.all_permissions.push(p))),z.all_permissions.length){for(z.all_permissions.sort((t,e)=>t.score<e.score?1:-1),kt=0,I=(et=z.all_permissions).length;kt<I;kt++){if(Ct=et[kt],!_&&"journal"!==(null!=(it=Ct.issuer)?it.type:void 0)||Ct.issuer.journal_oa_type||(Ct.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=_?_:Ct.issuer.id,c,s,a)),!(null!=(st=Ct.provenance)?st.enforcement_from:void 0)){z.best_permission=this.copy(Ct);break}if(!t.published||Date.parse(t.published)>Date.parse(Ct.provenance.enforcement_from.split("/").reverse().join("-"))){z.best_permission=this.copy(Ct);break}}if(_t.length)for(_t.sort((t,e)=>t.score<e.score?1:-1),St=0,C=_t.length;St<C;St++)if(yt=_t[St],!_&&"journal"!==(null!=(rt=yt.issuer)?rt.type:void 0)||yt.issuer.journal_oa_type||(yt.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=_?_:yt.issuer.id,c,s,a)),z.all_permissions.push(yt),null==(null!=(at=z.best_permission)?at.author_affiliation_requirement:void 0)&&null!=z.best_permission&&(!(null!=(nt=yt.provenance)?nt.enforcement_from:void 0)||!t.published||Date.parse(t.published)>Date.parse(yt.provenance.enforcement_from.split("/").reverse().join("-")))){for(W=this.copy(z.best_permission),At=0,D=(lt=["versions","locations"]).length;At<D;At++)for(jt=0,N=(ot=yt[b=lt[At]]).length;jt<N;jt++)It=ot[jt],null==W[b]&&(W[b]=[]),u.call(W[b],It)<0&&W[b].push(It);W.version=u.call(W.versions,"publishedVersion")>=0?"publishedVersion":u.call(W.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",W.embargo_end&&yt.embargo_end&&Date.parse(yt.embargo_end)<Date.parse(W.embargo_end)&&(W.embargo_end=yt.embargo_end),W.embargo_months&&null!=yt.embargo_months&&yt.embargo_months<W.embargo_months&&(W.embargo_months=yt.embargo_months),!0===yt.can_archive&&(W.can_archive=!0),null==W.requirements&&(W.requirements={}),W.requirements.author_affiliation_requirement=null==t.ror?yt.issuer.id:"string"==typeof t.ror?t.ror:t.ror[0],W.issuer.affiliation=yt.issuer,null==W.meta&&(W.meta={}),W.meta.affiliation=yt.meta,null==W.provenance&&(W.provenance={}),W.provenance.affiliation=yt.provenance,W.score=parseInt(W.score)+parseInt(yt.score),z.best_permission=W,z.all_permissions.push(W)}}return U?{body:"string"!=typeof U?U:null!=(ut={"not publisher":"Please find another DOI for this article as this is provided as this doesn’t allow us to find required information like who published it"}[U.toLowerCase()])?ut:U,status:501}:(!0!==this.params.metadata&&!0!==i||(z.metadata=t),z)},s.permissions.journals=function(t){return this.permissions._format(t)},s.permissions.journals._sheet="1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",s.permissions.journals._prefix=!1,s.permissions.publishers=function(t){return this.permissions._format(t)},s.permissions.publishers._sheet="11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",s.permissions.publishers._prefix=!1,s.permissions.affiliations=function(t){return this.permissions._format(t)},s.permissions.affiliations._sheet="15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",s.permissions.affiliations._prefix=!1,s.permissions.journals.example=async function(t){var e;null==t&&(t=null!=(e=this.params.doi)?e:this.params.issn),"string"==typeof t&&(t=t.split(","));try{return(await this.src.crossref.works('ISSN:"'+t.join('" OR ISSN:"')+'"',1)).DOI}catch(t){}},s.permissions.journals.oa=async function(t,e){var i,s,r,a,n,l;try{null==t&&(t=null!=(s=null!=(r=null!=(a=this.params.journals)?a:this.params.journal)?r:this.params.issn)?s:this.params.oa)}catch(t){}return l={},t&&(l.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+t+'"'),l.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+t+'" AND is_oa:true'),l.articles===l.open&&(l.oa=!0),await this.journal('ISSN:"'+t+'" AND indoaj:true',1)&&(l.open=l.articles,l.doaj=!0,l.oa=!0),(i=await this.permissions.journals.example(t))&&(null==e&&(e=await this.src.oadoi(i,1)),null!=e?(delete l.oa,l.open=l.articles,l.oadoi=!0,l.oa=(null!=e&&null!=(n=e.best_oa_location)?n.license:void 0)&&e.best_oa_location.license.includes("cc")):l.oa=!1)),l},s.permissions.journals.oa.type=async function(t,e,i,s){var r,a,n,l,o,u,c,h,d,p;return"string"==typeof t&&t.startsWith("10.")&&(null==i&&(i=await this.src.oadoi(t)),null==s&&(s=await this.src.crossref.works(t)),t=void 0),null==t&&(t=null!=(a=null!=(n=null!=(l=null!=(o=null!=(u=null!=(c=null!=i?i.journal_issns:void 0)?c:null!=s?s.ISSN:void 0)?u:this.params.journals)?o:this.params.journal)?l:this.params.type)?n:this.params.issn)?a:this.params.issns),"string"==typeof t&&(t=t.split(",")),r="unknown",null!=(null!=s?s.type:void 0)&&"journal-article"!==s.type?r="not applicable":(null!=s?s.type:void 0)&&"journal-article"!==s.type||(r="gold"===(null!=i?i.oa_status:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",((null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0))&&(r="gold"),t&&("closed"===r&&await this.src.oadoi.hybrid(t)&&(r="hybrid"),null==e&&(e=await this.journal('ISSN:"'+t.join('" OR ISSN:"')+'"',1)),(null!=e?e.tj:void 0)?r="transformative":!1===(null!=e&&null!=(h=e.doaj)&&null!=(d=h.bibjson)&&null!=(p=d.apc)?p.has_apc:void 0)&&(r="diamond"))),r},s.permissions.publishers.oa=async function(t){var e,i,s,r,a;try{null==t&&(t=null!=(r=this.params.publisher)?r:this.params.oa)}catch(t){}for(s='publisher:"'+t.replace(/&/g,"")+'" AND NOT doaj.bibjson.discontinued_date:* AND NOT doaj.bibjson.is_replaced_by:* AND (',e=(i=parseInt((await this.date()).split("-")[0]))-2;i>e;)s+=(s.endsWith("(")?"":" OR ")+"years:"+i,i-=1;return s+=")",(a={journals:await this.journal.count(s),open:await this.journal.count(s+" AND indoaj:true")}).percent=Math.ceil(a.open/a.journals*100),a.oa=a.journals&&a.journals===a.open,a},s.permissions._format=async function(t=[]){var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b;for(m=[],r=0,c=(y="object"!=typeof t||Array.isArray(t)?t:[t]).length;r<c;r++){for(n in f={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},g=y[r])if("string"==typeof g[n]&&(g[n]=g[n].trim()),"id"===n)if(f.issuer.id="string"==typeof g.id&&g.id.includes(",")?g.id.split(","):g.id,"string"==typeof f.issuer.id&&f.issuer.id.startsWith("10.")&&f.issuer.id.includes("/")&&!f.issuer.id.includes(" "))f.DOI=f.issuer.id;else{for(s=[],a=0,h=(_="string"==typeof f.issuer.id?[f.issuer.id]:f.issuer.id).length;a<h;a++){if(p=(p=_[a]).trim(),"journal"===f.issuer.type&&p.includes("-")&&!p.includes(" ")&&(p=p.toUpperCase(),e=await this.journal('ISSN:"'+p+'"',1)))for(o=0,d=(v=e.issn).length;o<d;o++)i=v[o],u.call(s,i)<0&&s.push(i);u.call(s,p)<0&&s.push(p)}f.issuer.id=s}else"embargo_months"===n?(l="number"==typeof g[n]?g[n]:"string"==typeof g[n]?parseInt(g[n].trim()):void 0)&&"number"==typeof l&&(f.embargo_months=l,f.embargo_end=""):n&&null!=g[n]&&""!==(b=g[n])&&"none"!==b&&"unclear"!==b&&("versions"===n&&g.versions.length&&(f.can_archive=!0,f.version=g.versions.includes("ublish")?"publishedVersion":g.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==n&&"locations"!==n&&"meta.contributors"!==n&&"meta.creator"!==n&&"meta.reviewer"!==n&&"provenance.archiving_policy"!==n&&"requirements.funder"!==n&&"licences"!==n&&"journal"!==n||(g[n]=g[n].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(f,"license"===n?"licence":n,g[n]));f.copyright_owner&&"journal"!==f.copyright_owner.toLowerCase()||!f.issuer.type||(f.copyright_owner=f.issuer.type),"{}"===JSON.stringify(f.requirements)&&delete f.requirements,m.push(f)}return 1===m.length?m[0]:m},s.journal={_index:!0,_prefix:!1},s.journal.load=async function(){var t,e,i,s,r,a,n,l,o,c,h,d,p,f;for(i=0,f=!1,2e4,e=[],s=0,5e3,await this.journal("");!1===f||i<f;){for(p=await this.fetch("https://api.jct.cottagelabs.com/journal?q=*&from="+s+"&size=5000"),!1===f&&(f=p.hits.total),r=0,n=(h=p.hits.hits).length;r<n;r++){if(i+=1,(c=h[r])._source.issn)for(null==(t=c._source).ISSN&&(t.ISSN=[]),a=0,l=(d="string"==typeof c._source.issn?[c._source.issn]:c._source.issn).length;a<l;a++)o=d[a],u.call(c._source.ISSN,o)<0&&c._source.ISSN.push(o);e.push(c._source),e.length>=2e4&&(await this.journal(e),e=[])}s+=5e3}return e.length&&await this.journal(e),i},s.journal.load._bg=!0,s.journal.load._async=!0,s.journal.load._auth="root";u=[].indexOf;s.report=function(){return this.format="html",'<script src="/client/svc/oaworks/report.min.js"><\/script>'},s.report.supplements={_index:!0,_prefix:!1,_key:"DOI"},s.report.check=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt,pt,ft,mt,gt,yt,_t,vt,bt,wt,xt,kt,St,Ot,At,jt,It,Ct,Dt,Nt,Lt,Rt,Pt,Et,Tt,qt,Ut,Mt,Wt,zt,Jt,Bt,Yt,Ft,Xt,Vt,$t,Gt,Ht,Zt,Qt,Kt,te,ee,ie,se,re,ae,ne,le,oe;if(null==e&&(e=null!=(pt=null!=(ft=this.params.check)?ft:this.params.reload)?pt:this.params.sheet),Kt=await this.epoch(),ie=await this.datetime(!1).replace(/[-T\: ]/g,"_"),console.log("OA check running",ie,e),i=async t=>{var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J;t.published=await this.src.crossref.works.published(t);try{t.year=t.published.split("-")[0]}catch(t){}try{t.year=parseInt(t.year)}catch(t){}try{r={DOI:t.DOI.toLowerCase(),title:null!=(N=t.title)?N[0]:void 0,journal:null!=(L=t["container-title"])?L[0]:void 0,ISSN:t.ISSN,publisher:t.publisher,crossref_published:t.published,crossref_year:t.year,citations:t["reference-count"],crossref_is_oa:t.is_oa,crossref_subject:t.subject};try{r.title=r.title.replace(/\n/g,"").replace(/\s\s+/g," ")}catch(t){}for(r.funder_grant_ids=[],r.funder_name=[],P=null!=(R=t.funder)?R:[],l=0,h=P.length;l<h;l++)if("10.13039/100000865"===(a=P[l]).DOI||a.name&&a.name.toLowerCase().includes("gates"))for("bank of canada"===a.name.toLowerCase()&&(a.name="Bill and Melinda Gates Foundation"),E=a.name,u.call(r.funder_name,E)<0&&r.funder_name.push(a.name),q=null!=(T=a.award)?T:[],o=0,d=q.length;o<d;o++)for(U=q[o].split(","),_=0,p=U.length;_<p;_++)n=(n=U[_]).trim(),u.call(r.funder_grant_ids,n)<0&&r.funder_grant_ids.push(n);for(r.author_names=[],r.author_affiliation=[],x=null!=(w=t.author)?w:[],b=0,f=x.length;b<f;b++)for((s=null!=(k=(e=x[b]).name)?k:(e.given?e.given+" ":"")+(null!=(S=e.family)?S:""))&&r.author_names.push(s),A=null!=(O=e.affiliation)?O:[],M=0,m=A.length;M<m;M++)(i=A[M]).name&&i.name.toLowerCase().includes("gates")&&(j=i.name,u.call(r.author_affiliation,j)<0)&&r.author_affiliation.push(i.name);try{for(I=t.license,W=0,g=I.length;W<g;W++)"am"!==(C=(c=I[W])["content-version"])&&"vor"!==C&&"tdm"!==C&&"unspecified"!==C||(null==r[v="crossref_license_url_"+c["content-version"]]&&(r[v]=[]),r["crossref_license_url_"+c["content-version"]].push(c.URL))}catch(t){}for(r.crossref=t,z=0,y=(D=["assertion","reference","relation"]).length;z<y;z++)J=D[z],delete r.crossref[J];return r}catch(e){console.log("from crossref parse error",JSON.stringify(t))}},dt={},!e){for await(ht of(it="/home/cloo/static/report/OAreport_"+ie+".csv",(at="funder.award:OPP* OR funder.award:INV*").includes("journal-article")||(at='type:"journal-article" AND ('+at+")"),V=[/Melinda\sGates\sFoundation/g,/BMGF/g,/Gates\sCambridge\sTrust/g,/IID\s?\d{5}/gi,/OPPG[HD]\s?\d{4}/g,/OPP\s?1\s?\d{6}/g,/OPP\s?[45]\s?\d{4}/g,/INV\‐\d{6}/g],this.index._for("src_crossref_works",at)))if(ht.DOI=ht.DOI.toLowerCase(),(v=await this.extract({content:JSON.stringify(ht),matchers:V})).matched)for(dt[ht.DOI]=await i(ht),dt[ht.DOI].matches=[],S=0,L=(Et=v.matches).length;S<L;S++)((Z=Et[S]).matched||Z.result)&&dt[ht.DOI].matches.push({matcher:Z.matched,matched:Z.result.join(",")});for await(ht of('"10.13039/100000865" OR "gates foundation" OR "gates cambridge trust"',b=["funder.DOI","funder.name","author.affiliation.name"],this.index._for("src_crossref_works",'"10.13039/100000865" OR "gates foundation" OR "gates cambridge trust"',{fields:b})))if("journal-article"===ht.type)if($=[],(j=JSON.stringify(ht)).includes("10.13039/100000865")&&$.push({field:"funder.DOI",matched:"10.13039/100000865"}),j.includes("gates foundation")&&$.push({field:"funder.name",matched:"gates foundation"}),j.includes("gates cambridge trust")&&$.push({field:"funder.name",matched:"gates cambridge trust"}),ht.DOI=ht.DOI.toLowerCase(),dt[ht.DOI]){for(N=0,R=$.length;N<R;N++)H=$[N],dt[ht.DOI].matches.push(H);null==(r=dt[ht.DOI]).duplicate&&(r.duplicate=0),dt[ht.DOI].duplicate+=1}else dt[ht.DOI]=await i(ht),dt[ht.DOI].matches=$}if(Zt={finance:"1nhykkqxYQ4DNPAj-WnXHcYnSd4dmt_Hf0xEVDZxaPLY",oasupport:"180562eXtmMANfIlioclUrQDaUSWkTOz7igOymfnv2pg",staff:"1EZI0iNAXnJ-qbIJFGmtplHWP03NVT7hhf0ICazI0YXw",grants:"1lDNHAwH-8x89fgLK-JLs9bBv2cdHsJRnb1Pj86QYWZI",names:"1ZowZub-nwOHJrzP7IbhbdoydOAmBRxLysejw38Xt32Y",emails:"1U3YXF1DLhGvP4PgqxNQuHOSR99RWuwVeMmdTAmSM45U",lens:"1XulUi2Bk3QNsJLekx0PpNb6REhrwQi6Q9M1x_KIUH_0",chronos:"1SxIFu4SoROqinOXAZMepOE0d1oxAZgC8LR_nTRi4vpU",oacheck:"1hRZGE-LfHdloHOEVVbt_ULjvwU76gECfa8MrthF9EV8",asap:"14Cs80bpyKym6R1kKqIrI1R5MMELms7ArPQzF67YOOgM",gates_funded_pmc:"1tE6it4EcW83-ZUCotdFMnj6LsyKfQCPdkBcrr36PkVM"},e)if(Qt=Zt[e])(Zt={})[e]=Qt;else for(Qt in Zt)if(Zt[Qt]===e){(Zt={})[Qt]=e;break}for(Gt in Zt){for(k=[],Q=0,T=(Mt=(Vt=await this.src.google.sheets({sheetid:Zt[Gt],sheet:"Export",headers:!1})).shift()).length;Q<T;Q++)x=Mt[Q],k.push(x.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(K=0,q=Vt.length;K<q;K++){for(w in Xt=Vt[K],ht={},k)ht[k[w].toLowerCase()]=Xt[w]?"true"===(Wt=Xt[w].trim().toLowerCase())||"yes"===Wt||"false"!==(zt=Xt[w].trim().toLowerCase())&&"no"!==zt&&("grant_id"===(Jt=k[w].toLowerCase())||"ror"===Jt?Xt[w].replace(/\//g,",").replace(/ /g,"").split(","):Xt[w]):void 0;if(ht.doi&&"string"==typeof ht.doi)if((ct=ht.doi.split(",")[0].toLowerCase().replace(/\.$/,"").replace(/\s/,"").split(" ")[0].split("?")[0].trim()).startsWith("10.")&&ct.includes("/")&&ct.length>6){if(e)for(I in dt[ct]=await this.report.supplements(ct),null==dt[ct]&&(null==dt[ct]&&(dt[ct]=await this.src.crossref.works(ct)),null!=dt[ct]?dt[ct]=await i(dt[ct]):dt[ct]={}),ht)dt[ct][I]=ht[I];else null!=dt[ct]?(null==(a=dt[ct]).duplicate&&(a.duplicate=0),dt[ct].duplicate+=1):(m=await this.src.crossref.works(ct))?dt[ct]=await i(m):(dt[ct]={DOI:ct,in_crossref:!1},await this.fetch("https://doi.org/"+ct)||(dt[ct].doi_resolves=!1));try{for(null==(n=dt[ct]).sheets&&(n.sheets=[]),u.call(dt[ct].sheets,Gt)<0&&dt[ct].sheets.push(Gt),null==(l=dt[ct]).ror&&(l.ror=[]),mt=null!=(Bt=ht.ror)?Bt:["0456r8d26"],te=0,U=mt.length;te<U;te++)$t=mt[te],u.call(dt[ct].ror,$t)<0&&dt[ct].ror.push($t);for(nt in ht)if("apc_cost"===nt){try{lt=parseInt(ht[nt])}catch(t){lt=0}null==(o=dt[ct])[nt]&&(o[nt]=0),dt[ct][nt]+=lt}else null!=dt[ct][nt]?(dt[ct][nt]?Array.isArray(dt[ct][nt])||(dt[ct][nt]=[dt[ct][nt]]):dt[ct][nt]=[],null!=ht[nt]&&("string"!=typeof ht[nt]||ht[nt].trim().length)&&(gt=ht[nt],u.call(dt[ct][nt],gt)<0)&&dt[ct][nt].push(ht[nt])):null!=ht[nt]&&""!==ht[nt]&&(dt[ct][nt]=ht[nt])}catch(t){console.log("sheet fields merge error",ct)}}else console.log("bad doi",ct)}}if(y=await this.keys(dt).length,console.log(y),!e)for(s={title:"Paper title",journal:"Journal Title",publisher:"Publisher name",published:"Published date",year:"Published year"},se=0,M=(D=this.params.keys?this.params.keys.split(","):["DOI","PMCID","in_oadoi","in_crossref","doi_resolves","compliant","can_archive","journal_oa_type","crossref_is_oa","oadoi_is_oa","is_oa","oadoi_oa_status","best_oa_location_url","best_oa_location_url_for_pdf","has_repository_copy","repository_license","repository_url_for_pdf","repository_url","repository_url_in_pmc","repository_version","publisher_license","publisher_url_for_pdf","publisher_version","has_oa_locations_embargoed","epmc_licence","epmc_licence_source","pmc_has_data_availability_statement","title","journal","ISSN","publisher","published","crossref_published","oadoi_published","year","crossref_year","oadoi_year","author_names","author_affiliation","funder_name","funder_grant_ids","crossref_license_url_am","crossref_license_url_vor","crossref_license_url_tdm","crossref_license_url_unspecified","crossref_subject","grant_id","invoice_date","invoice_number","tdm_is_oa","mturk_is_oa","staff_is_oa","apc_cost","oawork_finance_internal_id","type","to","status","sent","last_contact","last_heard_from","completed","follow_up_due","follow_ups_sent","clicked","author_name","email","author_email_name","citations","sheets","matches_targets","matches_found"]).length;se<M;se++)C=D[se],await fs.appendFile(it,("DOI"!==C?',"':'"')+(null!=(yt=s[C])?yt:C)+'"');for(g in c=[],f=0,G=null!=(_t=this.params.max)?_t:0,dt){if(G&&f>G)break;if(f+=1,null==(Ft=dt[g]))console.log(g);else{if(tt=await this.src.oadoi(Ft.DOI)){for(Ft.oadoi=tt,Ft.journal_oa_type=await this.permissions.journals.oa.type(void 0,void 0,tt,Ft.crossref),re=0,W=(bt=null!=(vt=tt.oa_locations)?vt:[]).length;re<W;re++)if("publisher"===(F=bt[re]).host_type&&(null==Ft.publisher_license&&(Ft.publisher_license=F.license),null==Ft.publisher_url_for_pdf&&(Ft.publisher_url_for_pdf=F.url_for_pdf),null==Ft.publisher_version&&(Ft.publisher_version=F.version)),"repository"===F.host_type){if(F.url&&F.url.toLowerCase().includes("pmc")){if(!Ft.PMCID&&!Ft.pmcid)try{(st=F.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0]).length&&st.replace(/[^0-9]/g,"").length===st.length&&!isNaN(parseInt(st))&&(Ft.PMCID="PMC"+st)}catch(t){}F.license&&!Ft.epmc_licence&&(Ft.epmc_licence=F.license,Ft.epmc_licence_source="oadoi EPMC repository oa_location")}if(!Ft.repository_url||!Ft.repository_url.includes("pmc"))for(ne=0,z=(wt=["license","url_for_pdf","url","version"]).length;ne<z;ne++)F[et=wt[ne]]&&(Ft["repository_"+et]=F[et])}Ft.repository_url&&Ft.repository_url.toLowerCase().includes("pmc")&&(Ft.repository_url_in_pmc=!0),Ft.best_oa_location_url=null!=(xt=tt.best_oa_location)?xt.url:void 0,Ft.best_oa_location_url_for_pdf=null!=(kt=tt.best_oa_location)?kt.url_for_pdf:void 0,Ft.oadoi_is_oa=tt.is_oa,Ft.is_oa=Ft.oadoi_is_oa||Ft.crossref_is_oa,Ft.oadoi_oa_status=tt.oa_status,Ft.has_repository_copy=tt.has_repository_copy,Ft.has_oa_locations_embargoed=!(null==tt.oa_locations_embargoed||!tt.oa_locations_embargoed.length),null==Ft.title&&(Ft.title=tt.title),null==Ft.journal&&(Ft.journal=tt.journal_name),tt.journal_issns&&null==Ft.ISSN&&(Ft.ISSN=tt.journal_issns.split(",")),null==Ft.publisher&&(Ft.publisher=tt.publisher),Ft.oadoi_published=tt.published_date,Ft.oadoi_year=tt.year}else Ft.in_oadoi=!1;if(null==Ft.year&&(Ft.year=null!=(St=Ft.oadoi_year)?St:Ft.crossref_year),null==Ft.published&&(Ft.published=null!=(Ot=Ft.oadoi_published)?Ot:Ft.crossref_published),(null!=(At=null!=tt&&null!=(jt=tt.best_oa_location)?jt.license:void 0)?At:"").includes("cc")||(null!=tt?tt.journal_is_in_doaj:void 0)?Ft.can_archive=!0:((ut=this.copy(null!=(It=Ft.crossref)?It:{})).doi=ut.DOI,Ft.permissions=await this.permissions(ut,void 0,void 0,tt,"{}"===JSON.stringify(ut)?void 0:ut),Ft.can_archive=null!=(Ct=Ft.permissions)&&null!=(Dt=Ct.best_permission)?Dt.can_archive:void 0),Ft.compliant=await this.report.compliant(Ft),_=void 0,rt=void 0,Ft.PMCID||(!Ft.pmcid||Array.isArray(Ft.pmcid)&&!Ft.pmcid.length?(rt=await this.src.pubmed.doi(Ft.DOI))?(null!=(Nt=rt.identifier)?Nt.pmc:void 0)&&(Ft.PMCID=rt.identifier.pmc,Ft.PMCID="PMC"+Ft.PMCID.toLowerCase().replace("pmc","")):Ft.repository_url_in_pmc&&(_=await this.src.epmc.doi(Ft.DOI))&&(Ft.PMCID=_.pmcid):(Ft.PMCID="PMC"+Ft.pmcid.toString().toLowerCase().replace("pmc",""),Array.isArray(Ft.PMCID)&&(Ft.PMCID=Ft.PMCID[0]))),Ft.PMCID&&Ft.repository_url_in_pmc&&!Ft.epmc_licence&&(Y=await this.src.epmc.licence(Ft.PMCID,_),Ft.epmc_licence=null!=Y?Y.licence:void 0,Ft.epmc_licence_source=null!=Y?Y.source:void 0),Ft.pmc_has_data_availability_statement=Ft.PMCID&&await this.src.pubmed.availability(Ft.PMCID),Ft.author_names&&Ft.email)if(1===Ft.author_names.length)Ft.author_email_name="Dr. "+Ft.author_names[0].split(" ").pop();else{for(Yt=("string"==typeof Ft.email?Ft.email:Ft.email[0]).split("@")[0].toLowerCase().replace(/[^a-z]/g,""),h="",d="",p=1e6,le=0,J=(Lt=Ft.author_names).length;le<J;le++)ot=Lt[le],(Ht=(await this.levenshtein(Yt,ot.toLowerCase().replace(/[^a-z]/g,""))).distance/ot.length)<p&&(p=Ht,d=ot),p>.2&&(Yt.endsWith(ot.split(" ").pop().toLowerCase())||ot.split(" ")[0].length>4&&Yt.includes(ot.split(" ")[0].toLowerCase()))&&(p=.1,d=ot),!h&&Yt.startsWith((ot.split(" ")[0].slice(0,1)+ot.split(" ").pop().slice(0,1)).toLowerCase())&&(h=ot);p<.7&&(Ft.author_email_name="Dr. "+d.split(" ").pop()),!Ft.author_email_name&&h&&(Ft.author_email_name="Dr. "+h)}if(c.push(Ft),!e)for(await fs.appendFile(it,"\n"),oe=0,B=D.length;oe<B;oe++){if(ae=null==Ft[I=D[oe]]?"":Array.isArray(Ft[I])?Ft[I].join(","):"object"==typeof Ft[I]?JSON.stringify(Ft[I]):Ft[I],"matches_targets"===I)for(O=0,P=(Pt=null!=(Rt=Ft.matches)?Rt:[]).length;O<P;O++)((X=Pt[O]).field||X.matcher)&&(ae+=(ae?",":"")+(null!=(Tt=X.field)?Tt:X.matcher));else if("matches_found"===I)for(A=0,E=(Ut=null!=(qt=Ft.matches)?qt:[]).length;A<E;A++)ae+=(ae?",":"")+(X=Ut[A]).matched;await fs.appendFile(it,("DOI"!==I?',"':'"')+ae.toString().replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")+'"')}c.length%100==0&&console.log("Gates OA checking",c.length,y)}}return e||await this.report.supplements(""),await this.report.supplements(c),ee=Math.ceil((await this.epoch()-Kt)/6e4),console.log("OA check done after "+ee+" minutes",e),e||this.mail({to:["mark@oa.works","joe@oa.works","sarah@oa.works"],subject:"Gates OA check done "+c.length+" in "+ee+" minutes",text:"https://static.oa.works/report/"+(null!=it?it:"").split("/report/").pop()}),c.length},s.report.check._bg=!0,s.report.check._async=!0,s.report.check._notify=!1,s.report.compliant=function(t,e){var i,s,r,a,n,l,o,u;return u=(null!=(i=null!=(s=t.oadoi)&&null!=(r=s.best_oa_location)?r.license:void 0)?i:"").toLowerCase().replace(/-/g,""),"Cold Spring Harbor Laboratory"===(a=t.publisher)||"Research Square"===a||"Data in Brief"===t.journal||t.DOI.startsWith("10.2139/ssrn")||t.DOI.startsWith("10.21203/rs")||t.DOI.startsWith("10.31234/osf.io/")?"n/a":t.journal_oa_type&&"closed"!==(n=t.journal_oa_type)&&"green"!==n&&(u.includes("ccby")||u.includes("cc0")||u.includes("pd")||u.includes("public")&&u.includes("domain"))?t.repository_url_in_pmc?"yes":"expected":null!=t.journal_oa_type&&u&&(null!=(l=t.oadoi)&&null!=(o=l.best_oa_location)?o.url:void 0)?"no":"unknown"},s.report.compliance=async function(t){var e,i,s,r,a;return null==t&&(t=null!=(r=null!=(a=this.params.report)?a:this.params.compliance)?r:this.params.ror),i=await this.report.supplements.count(),e=await this.report.supplements.count("compliant:yes"),(s=Math.ceil(e/i*1e3)/10)>100?100:s},s.report.rating=async function(t){var e,i,s,r,a,n;return null==t&&(t=null!=(a=null!=(n=this.params.report)?n:this.params.rating)?a:this.params.ror),t?("object"!=typeof t&&(t=await this.src.ror(t)),e='type:"journal-article" AND ("'+t.name+'" OR "'+t._id+'")',s=await this.src.crossref.works.count(e),i=await this.src.crossref.works.count(e+" AND is_oa:true")):(s=await this.report.supplements.count(),i=await this.report.supplements.count("is_oa:true")),(r=Math.ceil(i/s*1e3)/10)>100?100:r},s.report.citations=async function(t){var e,i,s,r;if(e={papers:0,citations:0,oa:{papers:0,citations:0},closed:{papers:0,citations:0}},"object"==typeof t&&(t=t._id),r=null!=(s=this.params.report)?s:this.params.citations,"string"==typeof t&&t.length<10&&!t.includes(" ")&&(r=t),r&&(t='type:"journal-article"'+(r?' AND ("'+r.name+'" OR "'+r._id+'")':"")),"0456r8d26"===r)for await(i of this.index._for("svc_oaworks_report_supplements","citations:*",{include:["citations","is_oa"]}))e.papers+=1,e.citations+=i.citations,e[i.is_oa?"oa":"closed"].papers+=1,e[i.is_oa?"oa":"closed"].citations+=i.citations;else if(t)for await(i of this.index._for("src_crossref_works",t+" AND reference-count:*",{include:["reference-count","is_oa"]}))e.papers+=1,e.citations+=i["reference-count"],e[i.is_oa?"oa":"closed"].papers+=1,e[i.is_oa?"oa":"closed"].citations+=i["reference-count"];return e.oa.average=Math.ceil(e.oa.citations/e.oa.papers),e.closed.average=Math.ceil(e.closed.citations/e.closed.papers),e.oa.average>e.closed.average&&(e.oa_extra_percent=Math.ceil((e.oa.average-e.closed.average)/e.closed.average*100)),e},s.report.publishers=async function(t){var e,i,r,a,n,l,o,u,c,h,d,p,f;if(t||!(h=s.report._publishers)){for(d={},i=0,a=(p=await this.src.crossref.works.terms("publisher",t,200)).length;i<a;i++)d[(c=p[i]).term]={papers:c.count};for(null==t&&(t=""),t.includes(" OR ")&&!t.includes(")")&&(t="("+t+")"),e=(t?t+" AND ":"")+"is_oa:true",r=0,n=(f=await this.src.crossref.works.terms("publisher",e,200)).length;r<n;r++)null==d[l=(o=f[r]).term]&&(d[l]={}),d[o.term].open=o.count;for(u in h=[],d)d[u].name=u,null!=d[u].open&&null==d[u].papers&&(d[u].papers=await this.src.crossref.works.count(t+(t?" AND ":"")+' publisher.keyword:"'+u+'"')),d[u].papers&&null==d[u].open&&(d[u].open=await this.src.crossref.works.count(e+' AND publisher.keyword:"'+u+'"')),d[u].rating=d[u].open&&d[u].papers?d[u].open/d[u].papers:0,d[u].percent=Math.ceil(1e3*d[u].rating)/10,d[u].percent>100&&(d[u].percent=100),d[u].papers&&d[u].rating&&h.push(d[u]);h.sort((t,e)=>e.rating-t.rating||e.open-t.open),s.report._publishers=h}return h},s.report.journals=async function(){var t,e,i,r,a,n,l,o,u,c,h,d;if(!(r=s.report._journals)){for(a={},t=0,l=(h=await this.src.crossref.works.terms("container-title",void 0,200)).length;t<l;t++)a[(i=h[t]).term]={papers:i.count};for(n=0,o=(d=await this.src.crossref.works.terms("container-title","is_oa:true",200)).length;n<o;n++)null==a[u=(c=d[n]).term]&&(a[u]={}),a[c.term].open=c.count;for(e in r=[],a)a[e].name=e,null!=a[e].open&&null==a[e].papers&&(a[e].papers=await this.src.crossref.works.count('container-title.keyword:"'+e+'"')),a[e].papers&&null==a[e].open&&(a[e].open=await this.src.crossref.works.count('is_oa:true AND container-title.keyword:"'+e+'"')),a[e].rating=a[e].open&&a[e].papers?a[e].open/a[e].papers:0,a[e].percent=Math.ceil(1e3*a[e].rating)/10,a[e].percent>100&&(a[e].percent=100),a[e].papers&&a[e].rating&&r.push(a[e]);r.sort((t,e)=>e.rating-t.rating||e.open-t.open),s.report._journals=r}return r},s.report.compare=async function(){var t,e,i,s,r,a,n,l,o,c,h,d,p;for await(r of(d={crossref:await this.src.crossref.works.count('(funder.DOI:"10.13039/100000865" OR funder.name:"gates foundation" OR funder.name:"gates cambridge trust" OR author.affiliation.name:"melinda gates" OR author.affiliation.name:"gates cambridge trust")'),pubmed:await this.src.pubmed.count('grant.agency:"melinda gates" OR grant.agency:"gates cambridge trust" OR author.affiliation:"melinda gates" OR author.affiliation:"gates cambridge trust"'),pubmednodoi:0,pubmednotcrossref:0,pubmednotepmc:0,mag:0,magnodoi:0,magnodoimatchedtitle:0,magnotcrossref:0,magnotcrossrefviatitle:0,magnotcrossrefnotpubmed:0},s=[],this.index._for("src_pubmed",'grant.agency:"melinda gates" OR grant.agency:"gates cambridge trust" OR author.affiliation:"melinda gates" OR author.affiliation:"gates cambridge trust"')))(null!=(a=r.identifier)?a.pmc:void 0)||(d.pubmednotepmc+=1),(null!=(n=r.identifier)?n.doi:void 0)?(t=await this.src.crossref.works(r.identifier.doi))&&((e=JSON.stringify(t).toLowerCase()).includes("10.13039/100000865")||e.includes("gates foundation")||e.includes("gates cambridge trust"))||(d.pubmednotcrossref+=1,s.push(r.identifier.doi)):d.pubmednodoi+=1;for await(r of(p=[],this.index._for("src_microsoft_graph_relation",'OriginalAffiliation:"melinda gates"')))l=r.PaperId,u.call(p,l)<0&&(p.push(r.PaperId),d.mag+=1,(i=await this.src.microsoft.graph(r.PaperId)).Doi?(t=await this.src.crossref.works(i.Doi))?(e=JSON.stringify(t).toLowerCase()).includes("10.13039/100000865")||e.includes("gates foundation")||e.includes("gates cambridge trust")||(d.magnotcrossref+=1,o=i.Doi,u.call(s,o)<0&&(d.magnotcrossrefnotpubmed+=1)):(d.magnotcrossref+=1,c=i.Doi,u.call(s,c)<0&&(d.magnotcrossrefnotpubmed+=1)):(d.magnodoi+=1,i.PaperTitle&&(t=await this.src.crossref.works('title:"'+i.PaperTitle+'"'))&&(0!==(null!=t&&null!=(h=t.hits)?h.total:void 0)?(d.magnodoimatchedtitle+=1,t=t.hits.hits[0]._source,(e=JSON.stringify(t).toLowerCase()).includes("10.13039/100000865")||e.includes("gates foundation")||e.includes("gates cambridge trust")||(d.magnotcrossref+=1,d.magnotcrossrefviatitle+=1)):d.magnotcrossrefnotpubmed+=1)));return d};u=[].indexOf;null==s.svc&&(s.svc={}),s.svc.rscvd={_index:!0},s.svc.rscvd.form=async function(){var t,e,i,s,r,a,n,l;if(this.keys(this.params).length>1){delete(e=this.copy(this.params)).form,e.status="Awaiting verification";try{(n=await this.svc.rscvd.requestees('email:"'+e.email+'"'))&&((null!=n?n.verified:void 0)||"Approved"===(null!=n?n.verification:void 0)?(e.status="Verified",e.verified=!0):((null!=n?n.denied:void 0)||"Denied"===(null!=n?n.verification:void 0))&&(e.status="Denied",e.verified=!1))}catch(t){}if("Awaiting verification"===e.status)try{(null!=(t=await this.svc.rscvd('email:"'+e.email+'" AND verified:*'))&&null!=(i=t.hits)?i.hits:void 0)&&!0===t.hits.hits[0]._source.verified?(e.status="Verified",e.verified=!0):!1===t.hits.hits[0]._source.verified&&(e.status="Denied",e.verified=!1)}catch(t){}null==e.type&&(e.type="paper");try{e.createdAt=new Date}catch(t){}try{e.neededAt=await this.epoch(e["needed-by"])}catch(t){}e._id=await this.svc.rscvd(e);try{l="Hi "+e.name+",<br><br>We got your request:<br><br>Title: "+(null!=(s=null!=(r=e.atitle)?r:e.title)?s:"Unknown")+"\nReference (if provided): "+(null!=(a=e.reference)?a:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+e._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:e.email,subject:"RSCVD Request Receipt",text:l})}catch(t){}return e}},s.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},s.svc.rscvd.resolves=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p;for(null==t&&(t=this.params.resolves),null==e&&(e=this.params.resolver),t?n="object"==typeof t?t:await this.svc.rscvd(t):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+e+'" AND NOT unresolved:"'+e+'"'),d={},i=0,s=(c=null!=n?[n]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<s;i++)null!=(a=c[i])._source&&null==(n=a._source)._id&&(n._id=a._id),(r=this.copy(n)).title&&(r.journal=r.title),r.atitle&&(r.title=r.atitle),(null!=(p=await this.ill.subscription({subscription:e},r))?p.url:void 0)?(null==n.resolved&&(n.resolved=[]),n.resolved.push(e),null==n.resolves&&(n.resolves=[]),n.resolves.push({resolver:e,url:p.url,user:null!=(h=this.user)?h._id:void 0}),d[a._id]=!0):(null==n.unresolved&&(n.unresolved=[]),n.unresolved.push(e),d[a._id]=!1),this.svc.rscvd(n);return t&&d[t]?d[t]:d},s.svc.rscvd.cancel=async function(){var t;if(this.params.cancel)return(t=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(t),t},s.svc.rscvd.verify=async function(t,e=!0){var i,s;if(null==t&&(t=this.params.verify),t)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+t+'"'))&&null!=(s=i.hits)?s.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:t,createdAt:Date.now()}),e?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+t+'"',{action:"index"},(function(t){return t.status&&"Awaiting verification"!==t.status||(t.verified=e,e?(t.status="Verified",t.verified_by=this.user.email):(t.status="Denied",t.denied_by=this.user.email)),t})),!0},s.svc.rscvd.verify._auth=!0,s.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},s.svc.rscvd.deny._auth=!0,s.svc.rscvd.status=async function(){var t,e,i;if(this.params.status){[e,i]=this.params.status.split("/"),(t=await this.svc.rscvd(e)).status=i;try{"Done"===t.status?t.done_by=this.user.email:"In Progress"===t.status&&(t.progressed_by=this.user.email)}catch(t){}return this.svc.rscvd(t),t}},s.svc.rscvd.status._auth=!0,s.svc.rscvd.poll=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L;if(this.nolog=!0,null==t&&(t=null!=(b=this.params.poll)?b:Date.now()-18e4),"string"==typeof(e=null!=(w=this.params.which)?w:["new","verify","deny","cancel","status","overdue"])&&(e=e.split(",")),u.call(e,"overdue")>=0&&this.svc.rscvd.overdue(),C={new:[],verify:[],deny:[],cancel:[],status:{}},u.call(e,"new")>=0)for(n=0,h=(S=null!=(x=null!=(v=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+t,500))&&null!=(k=v.hits)?k.hits:void 0)?x:[]).length;n<h;n++)null==(i=(y=S[n])._source)._id&&(i._id=y._id),C.new.push(y._source);if(u.call(e,"verify")>=0)for(l=0,d=(O=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<d;l++)L=O[l]._source.parts.pop(),u.call(C.verify,L)<0&&C.verify.push(L);if(u.call(e,"deny")>=0)for(o=0,p=(A=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<p;o++)a=A[o]._source.parts.pop(),u.call(C.deny,a)<0&&C.deny.push(a);if(u.call(e,"cancel")>=0)for(c=0,f=(j=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;c<f;c++)r=j[c]._source.parts.pop(),u.call(C.cancel,r)<0&&C.cancel.push(r);if(u.call(e,"status")>=0)for(g=0,m=(I=(await this.index("logs","createdAt:>"+t+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;g<m;g++)N=(D=I[g])._source.parts.pop(),null==(s=C.status)[_=D._source.parts.pop()]&&(s[_]=N);return C},s.svc.rscvd.overdue=async function(){var t,e,i,s,r,a,n,l,o,u,c;if(e=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(s=0,a=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;s<a;s++)null==(t=(l=c[s])._source)._id&&(t._id=l._id),u.push(l._source);for(r=0,n=u.length;r<n;r++)(o=u[r]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),e+=1;return e};u=[].indexOf;s.src.crossref=function(){return"Crossref API wrapper"},s.src.crossref.works=async function(t){var e,i,s,r,a,n,l;if(null==t&&(t=null!=(e=null!=(i=null!=(s=this.params.works)?s:this.params.doi)?i:this.params.title)?e:this.params.q),"string"==typeof t&&(0!==t.indexOf("10.")?n=await this.src.crossref.works.title(t):(0===t.indexOf("http")&&(t=t.split("//")[1]),0!==t.indexOf("10.")&&-1!==t.indexOf("/10.")&&(t="10."+t.split("/10.")[1]),l="https://api.crossref.org/works/"+t,n=await this.fetch(l,{headers:{"User-Agent":this.S.name+"; mailto:"+(null!=(r=this.S.mail)?r.to:void 0)}})),null!=(null!=n&&null!=(a=n.message)?a.DOI:void 0)))return this.src.crossref.works._format(n.message)},s.src.crossref.works._index={settings:{number_of_shards:9}},s.src.crossref.works._key="DOI",s.src.crossref.works._prefix=!1,s.src.crossref.works.title=async function(t){var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_;if(null==t&&(t=null!=(o=this.params.title)?o:this.params.q),n='title:"'+t+'"',t.split(" ").length>2){for(n+=" OR (",e=0,s=(c=t.split(" ")).length;e<s;e++)_=c[e],n.endsWith("(")||(n+=" AND "),n+='(title:"'+_+'" OR subtitle:"'+_+'")';n+=")"}for(f=await this.src.crossref.works(n),a=t.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),i=0,r=(p=null!=(h=null!=f&&null!=(d=f.hits)?d.hits:void 0)?h:[]).length;i<r;i++)(l=p[i])._source.DOI&&l._source.title&&l._source.title.length&&(g=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(y=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&y.length&&u.call(g,y)<0&&(g+=" "+y),g=g.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==a.indexOf(g)||-1!==g.indexOf(a))&&a.length/g.length>.7&&a.length/g.length<1.3&&("journal-article"===l._source.type||null==m||"journal-article"!==m.type&&"journal-article"===l._source.type)&&(m=l._source));return m},s.src.crossref.works._format=async function(t){var e,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g;for(t.abstract&&(t.abstract=t.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==t._id&&(t._id=t.DOI.replace(/\//g,"_")),s=0,n=(h=null!=(c=t.assertion)?c:[]).length;s<n;s++)"OPEN ACCESS"===(e=h[s]).label&&(e.URL&&-1!==e.URL.indexOf("creativecommons")&&(null==t.license&&(t.license=[]),t.license.push({URL:e.URL})),t.is_oa=!0);for(r=0,l=(p=null!=(d=t.license)?d:[]).length;r<l;r++)if((a=p[r]).URL&&-1!==a.URL.indexOf("creativecommons")&&(!t.licence||-1===t.licence.indexOf("creativecommons"))){t.licence=a.URL;try{t.licence="cc-"+t.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(t){}t.is_oa=!0}try{t.reference&&t.reference.length>100&&(t.reference_original_length=t.reference.length,t.reference=t.reference.slice(0,100))}catch(t){}try{t.relation&&t.relation.length>100&&(t.relation_original_length=t.relation.length,t.relation=t.relation.slice(0,100))}catch(t){}for(u=0,o=(m=null!=(f=t.author)?f:[]).length;u<o;u++)(i=m[u]).name=(i.given?i.given+" ":"")+(null!=(g=i.family)?g:"");if(t.published=await this.src.crossref.works.published(t)){try{t.year=t.published.split("-")[0]}catch(t){}try{parseInt(t.year)}catch(t){}try{t.publishedAt=await this.epoch(t.published)}catch(t){}}return t},s.src.crossref.works.published=async function(t){var e,i,s,r,a,n,l,o,u;if(null==t&&(t=this.params.published),"string"==typeof t&&(t=await this.src.crossref.works(t)),null!=t){for(a=void 0,r=void 0,e=0,i=(l=["published","published-print","published-online","issued","deposited"]).length;e<i;e++)"object"==typeof t[s=l[e]]&&(n=void 0,"string"==typeof t[s]["date-time"]&&3===t[s]["date-time"].split("T")[0].split("-").length?n=t[s]["date-time"].split("T")[0]:Array.isArray(t[s]["date-parts"])&&t[s]["date-parts"].length&&Array.isArray(t[s]["date-parts"][0])&&("string"!=(o=typeof(u=t[s]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(n=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),n&&(!r||a>await this.epoch(n))&&(r=n,a=await this.epoch(r)));return r}},s.src.crossref.works.search=async function(t,e,i,s,r,a,n,l){var o,u,c,h,d,p,f,m,g,y,_,v;if(null==t&&(t=null!=(d=null!=(p=this.params.q)?p:this.params.search)?d:this.params),null==e&&(e=this.params.from),null==i&&(i=this.params.size),null==s&&(s=this.params.filter),null==r&&(r=this.params.start),null==a&&(a=this.params.end),null==n&&(n=this.params.sort),null==l&&(l=null!=(f=this.params.order)?f:"asc"),r&&(o=null!=(m=null!=s?s:n)?m:"created","string"==typeof r&&-1!==r.indexOf("-")||(r=await this.date(r)),s=(s?s+",":"")+"from-"+o.replace("lished","").replace("xed","x").replace("ited","it")+"-date:"+r),a&&(null==o&&(o=null!=(g=null!=s?s:n)?g:"created"),"string"==typeof a&&-1!==a.indexOf("-")||(a=await this.date(a)),s=(s?s+",":"")+"until-"+o.replace("lished","").replace("xed","x").replace("ited","it")+"-date:"+a),v="https://api.crossref.org/works?",null!=n&&(v+="sort="+n+"&order="+l+"&"),"object"==typeof t)for(c in t)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(v+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(t[c])+"&");else t&&"all"!==t&&(h=(h=t.replace(/\w+?\:/g,"")).replace(/ /g,"+"),v+="query="+encodeURIComponent(h)+"&");if(null!=e){if("*"!==e&&"string"==typeof e&&!e.replace(/[0-9]/g,"").length)try{u=parseInt(e),isNaN(u)||(e=u)}catch(t){}v+="number"!=typeof e?"cursor="+encodeURIComponent(e)+"&":"offset="+e+"&"}null!=i&&(v+="rows="+i+"&"),null!=s&&""!==s&&(v+="filter="+encodeURIComponent(s)+"&"),v=v.replace("?&","?").replace(/&$/,"");try{return{total:(_=await this.fetch(v,{headers:{"User-Agent":this.S.name+"; mailto:"+(null!=(y=this.S.mail)?y.to:void 0)}})).message["total-results"],cursor:_.message["next-cursor"],data:_.message.items,facets:_.message.facets}}catch(t){}},s.src.crossref.load=async function(){var t,e,i,s,r,a,n,l,o,u,c,h,d;i=null!=(c=this.params.howmany)?c:-1,r=this.S.directory+"/crossref/crossref_public_data_file_2021_01/",a=this.S.directory+"/crossref/last",e=0;try{this.refresh||(e=parseInt((await fs.readFile(a)).toString()))}catch(t){}for(d=0,t=[];e>=0&&-1!==e&&e<40229;){if(9999!==e){if(d===i)break;for await(l of(console.log("Crossref load starting file",e),o="",readline.createInterface({input:fs.createReadStream(r+e+".json.gz").pipe(zlib.createGunzip())})))o+=l;for(s=0,n=(h=JSON.parse(o).items).length;s<n&&(u=h[s],d!==i);s++)d+=1,(u=await this.src.crossref.works._format(u)).srcfile=e,t.push(u),3e4===t.length&&(console.log("Crossref load "+e,d),await this.src.crossref.works(t),await fs.writeFile(a,e),t=[])}e+=1}return t.length&&await this.src.crossref.works(t),console.log(d),d},s.src.crossref.load._bg=!0,s.src.crossref.load._async=!0,s.src.crossref.load._auth="root",s.src.crossref.changes=async function(t){var e,i,s,r,a,n,l,o,u,c,h,d,p,f;if(2e4,null==t&&(t=this.params.changes),!t)try{t=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday}catch(t){}for(null==t&&(t=16071264e5),r=Date.now(),u=0,s=0,e=[];t<r;){for(console.log("Crossref changes",t,s),i="*",s+=1,f=!1,n=0;!1===f||n<f;)if(await this.sleep(500),null!=(p=await this.src.crossref.works.search(void 0,i,1e3,void 0,t,t))?p.data:void 0){for(l=0,o=(h=p.data).length;l<o;l++)c=h[l],(a=await this.src.crossref.works._format(c)).srcday=t,e.push(a),u+=1;e.length>=2e4&&(console.log("Crossref bulk load",t,s,f,n,u),await this.src.crossref.works(e),e=[]),!1===f&&(f=null!=(d=p.total)?d:0,console.log(t,f)),n+=1e3,i=p.cursor}else console.log("crossref error"),await this.sleep(2e3);t+=864e5}return e.length&&await this.src.crossref.works(e),console.log(u,s),u},s.src.crossref.changes._bg=!0,s.src.crossref.changes._async=!0,s.src.crossref.changes._auth="root",s.src.crossref.changes._notify=!1,s.src.epmc={_index:!0,_prefix:!1,_key:"id"},s.src.epmc.search=async function(t,e,i){var s,r,a,n,l,o,u,c;return null==t&&(t=null!=(s=null!=(r=null!=(a=this.params.search)?a:this.params.epmc)?r:this.params.doi)?s:""),t.startsWith("10.")&&!t.includes(" ")&&t.split("/").length>=2&&(t="DOI:"+t),"string"!=typeof t||t.startsWith("PMCID:")||!t.toLowerCase().startsWith("pmc")||t.includes(" ")||(t="PMCID:PMC"+t.toLowerCase().replace("pmc","")),"number"==typeof t&&(t="PMCID:PMC"+t),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+t+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=e&&(c+="&cursorMark="+e),u={},await this.sleep(200),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(n=null!=(l=o.resultList)?l.result:void 0)?n:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},s.src.epmc.doi=async function(t){var e;return null==t&&(t=this.params.doi),(e=await this.src.epmc('doi:"'+t+'"',1))?e:(e=await this.src.epmc.search("DOI:"+t)).total?e.data[0]:void 0},s.src.epmc.pmid=async function(t){var e;return null==t&&(t=this.params.pmid),(e=await this.src.epmc('pmid:"'+t+'"',1))?e:(e=await this.src.epmc.search("EXT_ID:"+t+" AND SRC:MED")).total?e.data[0]:void 0},s.src.epmc.pmc=async function(t){var e,i;return null==t&&(t=null!=(e=this.params.pmc)?e:this.params.pmcid),t="PMC"+t.toLowerCase().replace("pmc",""),(i=await this.src.epmc('pmcid:"'+t+'"',1))?i:(i=await this.src.epmc.search("PMCID:"+t)).total?i.data[0]:void 0},s.src.epmc.title=async function(t){var e;null==t&&(t=this.params.title);try{t=t.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(t){}return(e=await this.src.epmc('title:"'+t+'"',1))?e:(e=await this.src.epmc.search('title:"'+t+'"')).total?e.data[0]:void 0},s.src.epmc.licence=async function(t,e,i,s){var r,a,n,l,o;if(null==t&&(t=null!=(n=null!=(l=this.params.licence)?l:this.params.pmcid)?n:this.params.epmc),t&&(t="PMC"+t.toLowerCase().replace("pmc","")),null==s&&(s=this.refresh),t&&null==e&&(e=await this.src.epmc.pmc(t)),e||i){if(null!=(null!=e?e.calculated_licence:void 0)&&!s)return e.calculated_licence;if(null==t&&(t=null!=e?e.pmcid:void 0),(null!=e?e.license:void 0)&&"string"==typeof e.license)(r={licence:e.license,source:"epmc_api"}).licence.startsWith("cc")&&(r.licence=r.licence.replace(/ /g,"-"));else if(!i&&t&&(i=await this.src.epmc.xml(t,e)),null!=this.licence&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(r=await this.licence(void 0,i,"<permissions>","</permissions>"))?r.licence:void 0)&&(r.source="epmc_xml_permissions"),null==(null!=r?r.licence:void 0)&&null!=(null!=(r=await this.licence(void 0,i))?r.licence:void 0)&&(r.source="epmc_xml_outside_permissions")),null==(null!=r?r.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(r={licence:"non-standard-licence",source:"epmc_xml_permissions"}),t&&null!=this.licence&&(null==(null!=r?r.licence:void 0)||"non-standard-licence"===(null!=r?r.licence:void 0))&&(await this.sleep(1e3),o="https://europepmc.org/articles/PMC"+t.toLowerCase().replace("pmc",""),a=await this.puppet(o))){try{r=await this.licence(void 0,a)}catch(t){}null!=(null!=r?r.licence:void 0)&&(r.source="epmc_html")}if(null!=(null!=r?r.licence:void 0))return e.calculated_licence=r,await this.src.epmc(e.id,e),r}},s.src.epmc.xml=async function(t,e){var i,s,r;if(null==t&&(t=null!=(s=null!=(r=this.params.xml)?r:this.params.pmcid)?s:this.params.epmc),t&&(t="PMC"+t.toLowerCase().replace("pmc","")),t)try{return(i=await fs.readFile("/home/cloo/static/epmc/fulltext/"+t+".xml")).toString()}catch(s){if(null==e&&(e=await this.src.epmc.pmc(t)),!(null!=e?e.no_ft:void 0)){if(await this.sleep(200),"string"==typeof(i=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+t+"/fullTextXML"))&&i.length){try{await fs.writeFile("/home/cloo/static/epmc/fulltext/"+t+".xml",i)}catch(t){}return i}null!=e&&(e.no_ft=!0,await this.src.epmc(e.id,e))}}},s.src.epmc.aam=async function(t,e,i){var s,r,a;if(null==t&&(t=null!=(r=null!=(a=this.params.aam)?a:this.params.pmcid)?r:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{t&&!e&&(e=await this.src.epmc.pmc(t))}catch(t){}return null==t&&(t=null!=e?e.pmcid:void 0),t?"string"==typeof(i=await this.src.epmc.xml(t,e))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(2e3),(s=await this.puppet("https://europepmc.org/articles/PMC"+t.toLowerCase().replace("pmc","")))?"string"==typeof s?("Author Manuscript; Accepted for publication in peer reviewed journal","Author manuscript; available in PMC","logo-nihpa.gif","logo-wtpa2.gif",s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}):null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},null==(c=r.src).google&&(c.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(t){}s.src.google=async function(t,e,i){var s,r,a,n,l,o,u,c,h,d;return null==t&&(t=null!=(s=null!=this&&null!=(r=this.params)?r.q:void 0)?s:null!=this&&null!=(a=this.params)?a.google:void 0),null==e&&(e=null!=(n=this.S.src.google)&&null!=(l=n.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),t&&e&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+e+"&q="+t,await this.fetch(d)):{}},s.src.google.sheets=async function(t){var e,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w;if(null==t&&(t=this.copy(this.params)),"string"==typeof t&&(t={sheetid:t}),null==t.sheets&&null==t.sheet||null!=t.sheetid||(t.sheetid=null!=(c=t.sheet)?c:t.sheets,delete t.sheet,delete t.sheets),!t.sheetid)return[];if(t.sheetid.startsWith("http")?v=t.sheetid:(t.sheetid.includes("/spreadsheets/")?(y=t.sheetid.split("/spreadsheets/")[1].split("/")[0],!t.sheet&&t.sheetid.includes("/values/")&&(t.sheet=t.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),t.sheetid=y):2===t.sheetid.split("/").length&&([t.sheetid,t.sheet]=t.sheetid.split("/")),null==t.sheet&&(t.sheet="Sheet1"),v="https://sheets.googleapis.com/v4/spreadsheets/"+t.sheetid+"/values/"+t.sheet+"?alt=json&key="+(null!=(h=null!=(d=this.S.src.google)&&null!=(p=d.secrets)?p.serverkey:void 0)?h:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),e=await this.fetch(v,{headers:{"Cache-Control":"no-cache"}}),!1===t.values)return e;if(!1===t.headers)return e.values;if(Array.isArray(t.headers))r=t.headers;else if(r=[],null!=e.values)for(a=0,o=(_=e.values.shift()).length;a<o;a++)s=_[a],r.push(s);for(w=[],n=0,u=(g=e.values).length;n<u;n++){for(i in l=g[n],b={},r)try{b[r[i]]=l[i]}catch(t){}"{}"!==JSON.stringify(b)&&w.push(b)}return w},s.src.google.sheets._bg=!0;u=[].indexOf;null==(c=r.src).microsoft&&(c.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(t){}s.src.microsoft={},s.src.microsoft.bing=async function(t,e,i,s,a){var n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x;return null==t&&(t=null!=(n=null!=(l=null!=this&&null!=(p=this.params)?p.bing:void 0)?l:null!=this&&null!=(f=this.params)?f.q:void 0)?n:null!=this&&null!=(m=this.params)?m.query:void 0),null==e&&(e=null!=(g=null!=this&&null!=(y=this.params)?y.key:void 0)?g:null!=(_=r.src.microsoft.bing)?_.key:void 0),null==i&&(i=null!=(v=null!=this&&null!=(b=this.params)?b.market:void 0)?v:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==a&&(a=null!=(c=null!=this&&null!=(h=this.params)?h.cache:void 0)?c:259200),null!=t&&null!=e&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+t,null!=(w=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":e},cache:a}))&&null!=(d=w.webPages)?d.value:void 0)?{total:w.webPages.totalEstimatedMatches,data:w.webPages.value}:{total:0,data:[]}},s.src.microsoft.bing._auth="root",s.src.microsoft.graph={_prefix:!1,_index:{settings:{number_of_shards:9}}},s.src.microsoft.graph.journal={_prefix:!1,_index:!0},s.src.microsoft.graph.author={_prefix:!1,_index:{settings:{number_of_shards:9}}},s.src.microsoft.graph.affiliation={_prefix:!1,_index:!0},s.src.microsoft.graph.urls={_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.microsoft.graph.abstract={_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.microsoft.graph.relation={_prefix:!1,_index:{settings:{number_of_shards:12}}},s.src.microsoft.graph.paper=async function(t){var e,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w;if(w={1:"html",2:"text",3:"pdf",4:"doc",5:"ppt",6:"xls",8:"rtf",12:"xml",13:"rss",20:"swf",27:"ics",31:"pub",33:"ods",34:"odp",35:"odt",36:"zip",40:"mp3"},this.params.title&&!t)return this.src.microsoft.graph.paper.title();for(s=0,n=(m=null!=(p=null!=(_="object"==typeof(t=null!=(h=null!=(d=this.params.q)?d:this.params.paper)?h:this.params)&&t.PaperId&&t.Rank?t:await this.src.microsoft.graph(t))&&null!=(f=_.hits)?f.hits:void 0)?p:_?[_]:[]).length;s<n;s++){c=m[s];try{for(g=(await this.src.microsoft.graph.urls('PaperId:"'+c._source.PaperId+'"')).hits.hits,r=0,l=g.length;r<l;r++){b=g[r],null==(e=c._source).url&&(e.url=[]),u={url:b._source.SourceUrl,language:b._source.LanguageCode};try{u.type=w[b._source.SourceType.toString()]}catch(t){}c._source.url.push(u)}}catch(t){}try{for(y=(await this.src.microsoft.graph.relation('PaperId:"'+c._source.PaperId+'"',100)).hits.hits,a=0,o=y.length;a<o;a++)(v=y[a])._source.AuthorId&&(null==(i=c._source).author&&(i.author=[]),c._source.author.push({name:v._source.OriginalAuthor,sequence:v._source.AuthorSequenceNumber,id:v._source.AuthorId,affiliation:{name:v._source.OriginalAffiliation,id:v._source.AffiliationId}}))}catch(t){}}return _},s.src.microsoft.graph.title=async function(t){var e,i,s,r,a,n,l,o;if(null==t&&(t=null!=(s=this.params.title)?s:this.params.q),"string"==typeof t&&(o=t.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(null!=(n=await this.src.microsoft.graph('PaperTitle:"'+o+'"',1))&&null!=(r=n.hits)?r.hits:void 0)&&(n=null!=(a=n.hits.hits[0])?a._source:void 0),(null!=n?n.PaperTitle:void 0)&&(l=n.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),e=(i=await this.levenshtein(o,l,!1)).length.a>i.length.b?i.length.a:i.length.b,i.distance<2||e/i.distance>10)))return this.src.microsoft.graph.paper(n)},s.src.microsoft.load=async function(t){var e,i,s,r,a,n,l,o,c,h,d,p,f,m,g,y;for(n=null!=(g=this.params.howmany)?g:-1,h={paper:["PaperId","Rank","Doi","DocType","PaperTitle","OriginalTitle","BookTitle","Year","Date","OnlineDate","Publisher","JournalId","ConferenceSeriesId","ConferenceInstanceId","Volume","Issue","FirstPage","LastPage","ReferenceCount","CitationCount","EstimatedCitation","OriginalVenue","FamilyId","FamilyRank","CreatedDate"]},null==t&&(t=this.params.load?this.params.load.split(","):this.params.kinds?this.params.kinds.split(","):this.keys(h)),o=this.S.directory+"/mag/2021-04-26/",d=this.S.directory+"/mag/last",y=0,i=0,r=!this.params.parallel,a={},f=0,m={},{1:"html",2:"text",3:"pdf",4:"doc",5:"ppt",6:"xls",8:"rtf",12:"xml",13:"rss",20:"swf",27:"ics",31:"pub",33:"ods",34:"odp",35:"odt",36:"zip",40:"mp3"},e=async t=>{var e,s,r,l,u,c,p,g,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q;console.log("MAG loading",t),l="abstract"===t?2e4:"relation"===t?75e3:"urls"===t?1e5:5e4,s=[],k=d+"_"+t,S=0;try{this.refresh||(A=parseInt((await fs.readFile(k)).toString().split(" ")[0]))}catch(t){}if("DONE"!==A){for await(D of(A||("paper"===t?await this.src.microsoft.graph(""):await this.src.microsoft.graph[t]("")),p=("urls"===t?o.replace("2021-04-26/",""):o)+("relation"===t?"PaperAuthorAffiliations.txt":("urls"===t?"Paper":"")+t.substr(0,1).toUpperCase()+t.substr(1)+("urls"===t?"":"s")+".txt"),readline.createInterface({input:fs.createReadStream(p)}))){if(S+=1,y===n)break;T=D.split("\t");try{A&&!(S/1e5).toString().includes(".")&&console.log(t,"waiting",S,A)}catch(t){}if(!A||S===A||parseInt(T[0])===A){if(A=void 0,y+=1,w=0,N={},"relation"!==t&&"urls"!==t){N._id=T[0];try{N._id=N._id.trim()}catch(t){}N._id||delete N._id}if(N._id||"relation"===t||"urls"===t){if("abstract"===t)try{for(N.PaperId=parseInt(T[0]),c=JSON.parse(T[1]),e=[];e.length<c.IndexLength;)e.push("");for(R=c.InvertedIndex,u=0,j=R.length;u<j;u++)for(b=R[u],P=c.InvertedIndex[b],g=0,I=P.length;g<I;g++)e[P[g]]=b;N.Abstract=e.join(" ").replace(/\n/g," ")}catch(t){}else for(O=0,C=(E=h[t]).length;O<C;O++){x=E[O],q=T[w];try{q.trim()}catch(t){}if(q&&"NormalizedName"!==x&&(N[x]=q),"Rank"===x||"AuthorSequenceNumber"===x||"Year"===x||"EstimatedCitation"===x||"FamilyRank"===x||"SourceType"===x||x.endsWith("Count")||x.endsWith("Id"))try{L=parseInt(N[x]),isNaN(L)||(N[x]=L)}catch(t){}w+=1}if("paper"===t&&N.JournalId)try{v=N.JournalId.toString(),(_=m[v])?N.journal={title:_.DisplayName,ISSN:_.Issn.split(","),url:_.Webpage,id:N.JournalId}:(_=await this.src.microsoft.graph.journal(v))&&(m[v]=_,f+=1,console.log(f),N.journal={title:_.DisplayName,ISSN:_.Issn.split(","),url:_.Webpage})}catch(t){}}"{}"!==JSON.stringify(N)?s.push(N):i+=1}s.length===l&&(console.log(t,y,S,i),"paper"===t?await this.src.microsoft.graph(s):(r=await this.src.microsoft.graph[t](s),console.log("batch returned",r)),await fs.writeFile(k,S+" "+T[0]),s=[])}s.length&&("paper"===t?await this.src.microsoft.graph(s):await this.src.microsoft.graph[t](s)),await fs.writeFile(k,"DONE")}return a[b]=!0},l=0,p=t.length;l<p;l++)c=t[l],this.params.parallel?"paper"!==c&&(a[c]=!1,e(c)):await e(c);for(;!r;){for(s in r=!0,a)!1===a[s]&&(r=!1);r&&u.call(t,"paper")>=0&&await e("paper"),await this.sleep(1e3)}return console.log(y,i),y},s.src.microsoft.load._bg=!0,s.src.microsoft.load._async=!0,s.src.microsoft.load._auth="root",null==(c=r.src).oadoi&&(c.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(t){}s.src.oadoi=async function(t){var e,i,s,a;if(null==t&&(t=null!=(e=null!=(i=this.params)?i.oadoi:void 0)?e:null!=(s=this.params)?s.doi:void 0),"string"==typeof t&&t.startsWith("10."))return await this.sleep(900),a="https://api.oadoi.org/v2/"+t+"?email="+r.mail.to,this.fetch(a)},s.src.oadoi._index={settings:{number_of_shards:9}},s.src.oadoi._key="doi",s.src.oadoi._prefix=!1,s.src.oadoi.hybrid=async function(t){var e,i,s,r,a,n;if(null==t&&(t=null!=(r=null!=(a=this.params.hybrid)?a:this.params.issn)?r:this.params.issns),"object"!=typeof t||Array.isArray(t)||(t=null!=(n=t.journal_issns)?n:t.ISSN),"string"==typeof t&&(t=t.replace(/\s/g,"").split(",")),Array.isArray(t)&&t.length)return(s="journal_issns.keyword:*"+t.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(s="("+s+")"),e=await this.src.oadoi.count(s+' AND oa_status:"closed"'),i=await this.src.oadoi.count(s+' AND oa_status:"hybrid"'),!!(e&&i/e>.001)},s.src.oadoi.load=async function(){var t,e,i,s,r,a,n,l,o;e=null!=(l=this.params.howmany)?l:-1,i=this.S.directory+"/oadoi/snapshot.jsonl",s=this.S.directory+"/oadoi/last";try{this.refresh||(r=(await fs.readFile(s)).toString())}catch(t){}for await(a of(r||await this.src.oadoi(""),o=0,t=[],readline.createInterface({input:fs.createReadStream(i).pipe(zlib.createGunzip())}))){if(o===e)break;try{n=JSON.parse(a.trim().replace(/\,$/,"")),r&&r!==n.doi||(r=void 0,o+=1,n._id=n.doi.replace(/\//g,"_"),t.push(n),3e4===t.length&&(console.log("OADOI bulk loading",t.length,o),await this.src.oadoi(t),t=[],await fs.writeFile(s,n.doi)))}catch(t){}}return t.length&&await this.src.oadoi(t),console.log(o),o},s.src.oadoi.load._bg=!0,s.src.oadoi.load._async=!0,s.src.oadoi.load._auth="root",s.src.oadoi.changes=async function(t){var e,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(3e4,g=this.S.directory+"/oadoi/upto",this.S.directory+"/oadoi/errors",null==t&&(t=this.params.changes),!t)try{t=parseInt((await fs.readFile(g)).toString())}catch(t){}if(!t)try{a=await this.src.oadoi("*",{size:1,sort:{updated:{order:"desc"}}}),t=new Date(a.updated).valueOf()}catch(t){}if(t){for(i=0,s=0,m=!1,r=0,l=(p=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;r<l;r++){if(h=p[r],c=new Date(h.last_modified).valueOf(),console.log(h.last_modified,c,t,null!=a?a.updated:void 0),"jsonl"===h.filetype&&(!t||c>t)){for await(u of(console.log("OADOI importing changes for",h.last_modified),s+=1,e=[],n=0,o=this.S.directory+"/oadoi/"+h.date+".jsonl.gz",f=await fetch(h.url),y=fs.createWriteStream(o),await new Promise((t,e)=>(f.body.pipe(y),f.body.on("error",e),y.on("finish",t))),readline.createInterface({input:fs.createReadStream(o).pipe(zlib.createGunzip())})))m=c,n+=1,(d=JSON.parse(u.trim().replace(/\,$/,"")))._id=d.doi.replace(/\//g,"_"),e.push(d),i+=1,e.length>=3e4&&(console.log("OADOI bulk loading changes",s,e.length,n),await this.src.oadoi(e),e=[]);e.length&&await this.src.oadoi(e),fs.unlink(o)}if(m)try{await fs.writeFile(g,m)}catch(t){}}return console.log(s,i),i}console.log("Timestamp day to work since is required - run load first to auto-generate")},s.src.oadoi.changes._bg=!0,s.src.oadoi.changes._async=!0,s.src.oadoi.changes._auth="root",s.src.oadoi.changes._notify=!1,s.src.oadoi.local=async function(){var t,e,i,s,r;if(5e4,e=0,this.params.local&&10===this.params.local.length&&3===this.params.local.split("-").length&&!this.params.local.includes("/")){for await(s of(i=this.S.directory+"/oadoi/"+this.params.local+".jsonl",t=[],readline.createInterface({input:fs.createReadStream(i)})))e+=1,(r=JSON.parse(s.trim().replace(/\,$/,"")))._id=r.doi.replace(/\//g,"_"),t.push(r),t.length>=5e4&&(await this.src.oadoi(t),t=[]);t.length&&await this.src.oadoi(t)}return console.log(e),e},s.src.oadoi.local._bg=!0,s.src.oadoi.local._auth="root";u=[].indexOf;s.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.pubmed.doi=async function(t){var e;if(null==t&&(t=this.params.doi),t&&(e=await this.src.pubmed('identifier.doi:"'+t+'"',1)))return e},s.src.pubmed.pmc=async function(t){var e;if(null==t&&(t=this.params.pmc),t&&(e=await this.src.pubmed('identifier.pmc:"PMC'+t.toString().toLowerCase().replace("pmc","")+'"',1)))return e},s.src.pubmed.entrez={},s.src.pubmed.entrez.summary=async function(t,e,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b;b="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),b+="&id="+i):b+="&query_key="+t+"&WebEnv="+e;try{for(y=await this.fetch(b),h=await this.convert.xml2json(y),p=[],f=h.eSummaryResult.DocSum,r=0,o=f.length;r<o;r++){for(s={id:(d=f[r]).Id[0]},m=d.Item,n=0,u=m.length;n<u;n++)if("List"===(a=m[n]).$.Type){if(s[a.$.Name]=[],null!=a.Item)for(g=a.Item,l=0,c=g.length;l<c;l++)_=g[l],(v={})[_.$.Name]=_._,s[a.$.Name].push(v)}else s[a.$.Name]=a._;if(p.push(s),null==i||-1===i.indexOf(","))return p[0]}return p}catch(t){}},s.src.pubmed.entrez.pmid=async function(t){var e,i,s;s="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+t;try{return e=await this.fetch(s),i=await this.convert.xml2json(e),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey[0],i.ePostResult.WebEnv[0])}catch(t){}},s.src.pubmed.search=async function(t,e,i=10,s=!1){var r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w;b="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+t;try{if("string"==typeof s&&(s=s.split(",")),Array.isArray(s))y={total:s.length,data:[]};else{if(y=await this.fetch(b),y={total:(_=await this.convert.xml2json(y)).eSearchResult.Count[0],data:[]},!0===s)return y.data=_.eSearchResult.IdList[0].Id,y;s=_.eSearchResult.IdList[0].Id}if(e)for(r=0,o=s.length;r<o&&(v=s[r],p=await this.src.pubmed.pmid(v),y.data.push(p),y.data.length!==i);r++);else{for(w=[],n=0,u=s.length;n<u&&(a=s[n],y.data.length!==i);n++)if(w.push(a),40===w.length){for(m=await this.src.pubmed.entrez.summary(void 0,void 0,w),l=0,c=m.length;l<c&&(f=m[l],y.data.push(await this.src.pubmed.format(f)),y.data.length!==i);l++);w=[]}if(w.length)for(g=await this.src.pubmed.entrez.summary(void 0,void 0,w),d=0,h=g.length;d<h&&(f=g[d],y.data.push(await this.src.pubmed.format(f)),y.data.length!==i);d++);}return y}catch(t){}},s.src.pubmed.pmid=async function(t){var e,i;try{if(i="https://www.ncbi.nlm.nih.gov/pubmed/"+t+"?report=xml",0===(e=await this.fetch(i)).indexOf("<"))return this.src.pubmed.format(await this.decode(e.split("<pre>")[1].split("</pre>")[0].replace("\n","")))}catch(t){}try{return this.src.pubmed.format(await this.src.pubmed.entrez.pmid(t))}catch(t){}},s.src.pubmed.aheadofprint=async function(t){try{return-1!==(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+t+"?report=xml")).indexOf("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(t){}},s.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},s.src.pubmed.availability=async function(t){var e,i,s,r,a;return null==t&&(t=null!=(e=null!=(i=null!=(s=null!=(r=null!=(a=this.params.pubmed)?a:this.params.availability)?r:this.params.pmc)?s:this.params.pmcid)?i:this.params.PMC)?e:this.params.PMCID),t="PMC"+(t+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(t)},s.src.pubmed.format=async function(t,e={}){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J;if("string"==typeof t&&0===t.indexOf("<")&&(t=await this.convert.xml2json(t)),null!=(null!=(C=t.eSummaryResult)?C.DocSum:void 0)||t.ArticleIds){if(n={},null!=(null!=(L=t.eSummaryResult)?L.DocSum:void 0))for(l=0,h=(R=(t=md.eSummaryResult.DocSum[0]).Item).length;l<h;l++)if("List"===(o=R[l]).$.Type){if(n[o.$.Name]=[],null!=o.Item)for(u=0,d=(P=o.Item).length;u<d;u++)(J={})[(z=P[u]).$.Name]=z._,n[o.$.Name].push(J)}else n[o.$.Name]=o._;else n=t;try{null==e.pmid&&(e.pmid=t.Id[0])}catch(t){}try{null==e.pmid&&(e.pmid=t.id)}catch(t){}try{null==e.title&&(e.title=n.Title)}catch(t){}try{null==e.issn&&(e.issn=n.ISSN)}catch(t){}try{null==e.essn&&(e.essn=n.ESSN)}catch(t){}try{null==e.doi&&(e.doi=n.DOI)}catch(t){}try{null==e.journal&&(e.journal=n.FullJournalName)}catch(t){}try{null==e.journal_short&&(e.journal_short=n.Source)}catch(t){}try{null==e.volume&&(e.volume=n.Volume)}catch(t){}try{null==e.issue&&(e.issue=n.Issue)}catch(t){}try{null==e.page&&(e.page=n.Pages)}catch(t){}try{null==e.year&&(e.year=n[n.PubDate?"PubDate":"EPubDate"].split(" ")[0])}catch(t){}try{k=n[n.PubDate?"PubDate":"EPubDate"].split(" "),null==e.published&&(e.published=k[0]+"-"+(["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(k[1].toLowerCase())+1)+"-"+(3===k.length?k[2]:"01"))}catch(t){}if(null!=n.AuthorList)for(null==e.author&&(e.author=[]),c=0,p=(E=n.AuthorList).length;c<p;c++){i=E[c];try{i.family=i.Author.split(" ")[0],i.given=i.Author.replace(i.family+" ",""),i.name=i.given+" "+i.family,e.author.push(i)}catch(t){}}if(null!=n.ArticleIds&&null==e.pmcid)for(v=0,f=(T=n.ArticleIds).length;v<f;v++)if((s=T[v]).pmc){null==e.pmcid&&(e.pmcid=s.pmc);break}}else if(null!=t.PubmedArticle){b=(t=t.PubmedArticle).MedlineCitation[0];try{null==e.pmid&&(e.pmid=b.PMID[0]._)}catch(t){}try{null==e.title&&(e.title=b.Article[0].ArticleTitle[0])}catch(t){}try{null==e.issn&&(e.issn=b.Article[0].Journal[0].ISSN[0]._)}catch(t){}try{null==e.journal&&(e.journal=b.Article[0].Journal[0].Title[0])}catch(t){}try{null==e.journal_short&&(e.journal_short=b.Article[0].Journal[0].ISOAbbreviation[0])}catch(t){}try{S=b.Article[0].Journal[0].JournalIssue[0].PubDate[0];try{null==e.year&&(e.year=S.Year[0])}catch(t){}try{null==e.published&&(e.published=S.Year[0]+"-"+(S.Month?["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(S.Month[0].toLowerCase())+1:"01")+"-"+(S.Day?S.Day[0]:"01"))}catch(t){}}catch(t){}try{for(null==e.author&&(e.author=[]),q=b.Article[0].AuthorList[0].Author,w=0,m=q.length;w<m;w++){a=q[w],(i={}).family=a.LastName[0],i.given=a.ForeName[0],i.name=(i.given?i.given+" ":"")+(null!=(U=i.family)?U:"");try{i.affiliation=a.AffiliationInfo[0].Affiliation[0]}catch(t){}null!=i.affiliation&&(Array.isArray(i.affiliation)&&(i.affiliation=i.affiliation[0]),"string"==typeof i.affiliation&&(i.affiliation={name:i.affiliation})),e.author.push(i)}}catch(t){}try{for(M=t.PubmedData[0].ArticleIdList[0].ArticleId,x=0,g=M.length;x<g;x++)if("doi"===(O=M[x]).$.IdType){null==e.doi&&(e.doi=O._);break}}catch(t){}try{for(null==e.reference&&(e.reference=[]),D=t.PubmedData[0].ReferenceList[0].Reference,A=0,y=D.length;A<y;A++){I=D[A].Citation[0],W={},-1!==I.indexOf("doi.org/")&&(W.doi=I.split("doi.org/")[1].trim());try{for(W.author=[],N=I.split(". ")[0].split(", "),j=0,_=N.length;j<_;j++)r=N[j],W.author.push({name:r})}catch(t){}try{W.title=I.split(". ")[1].split("?")[0].trim()}catch(t){}try{W.journal=I.replace(/\?/g,".").split(". ")[2].trim()}catch(t){}try{W.url="http"+I.split("http")[1].split(" ")[0],-1!==W.url.indexOf("doi.org")&&delete W.url}catch(t){}"{}"!==JSON.stringify(W)&&e.reference.push(W)}}catch(t){}}try{null==e.pdf&&(e.pdf=t.pdf)}catch(t){}try{null==e.url&&(e.url=t.url)}catch(t){}return e},s.src.pubmed.load=async function(t){var e,i,s,r,a,n,l,o,c,h,d;for(-1,1,a=null!=(o=this.params.howmany)?o:-1,this.refresh&&!t&&await this.src.pubmed(""),i=t?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",r=[],n=0,l=(c=(await this.fetch(i)).split('href="')).length;n<l;n++)(s=c[n].split('"')[0]).startsWith("pubmed")&&s.endsWith(".gz")&&(this.refresh&&!t||!await this.src.pubmed.count('srcfile:"'+i+s+'"'))&&r.push(i+s);for(h=0,d=0,e=async e=>{var i,s,n,l,o,c,p,f,m,g,y,_,v,b,w;for await(m of(console.log("Pubmed loading"+(t?" changes":""),e,r.length,h),l=[],_={},y=!1,c=!1,readline.createInterface({input:(await fetch(e)).body.pipe(zlib.createGunzip())})))if("</PubmedArticle>"===(m=m.trim().replace("&amp;","&"))){if(d+=1,!1!==y&&y.year&&(_.year=parseInt(y.year),y.month&&y.month.length>2&&(y.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(y.month.toLowerCase().substr(0,3))),"number"==typeof y.month&&(y.month=y.month.toString()),y.month&&1===y.month.length&&(y.month="0"+y.month),"number"==typeof y.day&&(y.day=y.day.toString()),y.day&&1===y.day.length&&(y.day="0"+y.day),_.published=y.year+"-"+(null!=(v=y.month)?v:"01")+"-"+(null!=(b=y.day)?b:"01"),_.publishedAt=await this.epoch(_.published)),_.srcfile=e,_._id=_.PMID,l.push(_),_={},y=!1,c=!1,d===a)break}else{for(p in f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(m.includes(p)||m.includes(p.replace(">"," ")))&&null==_[g=f[p]]&&(_[g]=m.split(">")[1].split("</")[0]);m.includes("<MedlinePgn>")&&(_.pages=m.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ")),(m.includes("<ISSN>")||m.includes("<ISSN ")||m.includes("<ISSNLinking>"))&&(null==_.ISSN&&(_.ISSN=[]),w=m.split(">")[1].split("</")[0],u.call(_.ISSN,w)<0&&_.ISSN.push(w)),m.includes("<Keyword>")&&(null==_.keyword&&(_.keyword=[]),w=m.split(">")[1].split("</")[0],u.call(_.keyword,w)<0&&_.keyword.push(w)),m.includes("<GeneSymbol>")&&(null==_.gene&&(_.gene=[]),w=m.split(">")[1].split("</")[0],u.call(_.gene,w)<0&&_.gene.push(w)),(m.includes("<PublicationType>")||m.includes("<PublicationType "))&&(null==_.type&&(_.type=[]),w=m.split(">")[1].split("</")[0],u.call(_.type,w)<0&&_.type.push(w)),m.includes("<Chemical>")&&(null==_.chemical&&(_.chemical=[]),_.chemical.push({})),(m.includes("<NameOfSubstance>")||m.includes("<NameOfSubstance "))&&(_.chemical[_.chemical.length-1].name=m.split(">")[1].split("</")[0],_.chemical[_.chemical.length-1].nameID=m.split('UI="')[1].split('"')[0]),m.includes("<RegistryNumber>")&&(_.chemical[_.chemical.length-1].registry=m.split(">")[1].split("</")[0]),(m.includes("<DataBank>")||m.includes("<DataBank "))&&(null==_.databank&&(_.databank=[]),_.databank.push({})),m.includes("<DataBankName>")&&(_.databank[_.databank.length-1].name=m.split(">")[1].split("</")[0]),m.includes("<AccessionNumber>")&&(null==(i=_.databank[_.databank.length-1]).accession&&(i.accession=[]),_.databank[_.databank.length-1].accession.push(m.split(">")[1].split("</")[0])),(m.includes("<Grant>")||m.includes("<Grant "))&&(null==_.grant&&(_.grant=[]),_.grant.push({})),m.includes("<GrantID>")&&(_.grant[_.grant.length-1].id=m.split(">")[1].split("</")[0]),m.includes("<Acronym>")&&(_.grant[_.grant.length-1].acronym=m.split(">")[1].split("</")[0]),m.includes("<Agency>")&&(_.grant[_.grant.length-1].agency=m.split(">")[1].split("</")[0]),m.includes("<Country>")&&(_.grant&&!_.grant[_.grant.length-1].country||_.country?_.grant[_.grant.length-1].country=m.split(">")[1].split("</")[0]:_.country=m.split(">")[1].split("</")[0]),(m.includes("<MeshHeading>")||m.includes("<MeshHeading "))&&(null==_.mesh&&(_.mesh=[]),_.mesh.push({})),(m.includes("<DescriptorName>")||m.includes("<DescriptorName "))&&(_.mesh[_.mesh.length-1].description=m.split(">")[1].split("</")[0],_.mesh[_.mesh.length-1].descriptionID=m.split('UI="')[1].split('"')[0]),(m.includes("<QualifierName>")||m.includes("<QualifierName "))&&(null==(s=_.mesh[_.mesh.length-1]).qualifier&&(s.qualifier=[]),_.mesh[_.mesh.length-1].qualifier.push({name:m.split(">")[1].split("</")[0],id:m.split('UI="')[1].split('"')[0]})),(m.includes("<Investigator>")||m.includes("<Investigator "))&&(null==_.author&&(_.author=[]),_.author.push({}),c=!0),(m.includes("<Author>")||m.includes("<Author "))&&(null==_.author&&(_.author=[]),_.author.push({}),c=!1);try{m.includes("<LastName>")&&(_.author[_.author.length-1].lastname=m.split(">")[1].split("</")[0],c&&(_.author[_.author.length-1].investigator=!0)),m.includes("<ForeName>")&&(_.author[_.author.length-1].firstname=m.split(">")[1].split("</")[0]),m.includes("<Affiliation>")&&(_.author[_.author.length-1].affiliation=m.split(">")[1].split("</")[0]),m.includes("<Identifier>")&&(_.author[_.author.length-1].identifier=m.split(">")[1].split("</")[0])}catch(t){}if(m.includes("<Note>")||m.includes("<Note ")||m.includes("<GeneralNote>")||m.includes("<GeneralNote "))try{null==_.notes&&(_.notes=[]),_.notes.push(m.split(">")[1].split("</")[0])}catch(t){}(m.includes("<DeleteCitation>")||m.includes("<DeleteCitation "))&&(_.deletedFromMedline=!0),(m.includes("<ArticleId>")||m.includes("<ArticleId "))&&(null==_.identifier&&(_.identifier={}),o=m.split('IdType="')[1].split('"')[0],null==(n=_.identifier)[o]&&(n[o]=m.split(">")[1].split("</")[0])),(m.includes("<ArticleDate>")||m.includes("ArticleDate ")||m.includes("<PubDate>")||m.includes("<PubDate "))&&(y={}),!1!==y&&(m.includes("<Year>")||m.includes("<Month>")||m.includes("<Day>"))&&(y[m.split(">")[0].replace("<","").toLowerCase()]=m.split(">")[1].split("</")[0])}return l.length&&(await this.src.pubmed(l),l=[],console.log(e,d)),h-=1};r.length&&!(a>0&&d>=a);)await this.sleep(1e3),h<1&&(h+=1,e(r.shift()));return console.log(d),d},s.src.pubmed.load._bg=!0,s.src.pubmed.load._async=!0,s.src.pubmed.load._auth="root",s.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},s.src.pubmed.changes._bg=!0,s.src.pubmed.changes._async=!0,s.src.pubmed.changes._auth="root",s.src.pubmed.changes._notify=!1,s.src.ror=async function(t){if(null==t&&(t=this.params.ror),"string"==typeof t&&!t.includes(" ")&&(t=t.split("/").pop()).length<11)return this.src.ror._format(await this.fetch("https://api.ror.org/organizations/"+t))},s.src.ror._index=!0,s.src.ror._prefix=!1,s.src.ror.query=function(t){var e;if(null==t&&(t=null!=(e=this.params.query)?e:this.params.q),"string"==typeof t)return this.fetch('https://api.ror.org/organizations?query="'+t+'"')},s.src.ror.grid=async function(t){var e,i,s,r;if(null==t&&(t=this.params.grid),"string"==typeof t&&t.startsWith("grid.")){if((null!=(s=await this.src.ror('external_ids.GRID.all:"'+t+'"'))?s.id:void 0)||1===(null!=s&&null!=(e=s.hits)?e.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(t))&&null!=(i=s.items)?i[0]:void 0)return r=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(r)),r}},s.src.ror.title=async function(t){var e,i,s,r,a;if(null==t&&(t=null!=(e=this.params.title)?e:this.params.q),"string"==typeof t){if(this.refresh||(r=await this.src.ror('title:"'+t+'"')),(null!=r?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(t))&&null!=(s=r.items)?s[0]:void 0)return a=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(a)),a}},s.src.ror._format=function(t){try{t._id=t.id.split("/").pop()}catch(t){}return t},s.src.ror.load=async function(){var t,e,i,s,r,a,n,l,o,u;for await(r of(2e4,i=null!=(l=this.params.howmany)?l:-1,s=this.S.directory+"/ror/2021-03-25-ror-data.json",this.refresh&&await this.src.ror(""),u=0,t=[],o=!1,e=!1,a="",readline.createInterface({input:fs.createReadStream(s)}))){if(u===i)break;try{o||5!==r.length||"{"!==r.replace(/\s\s\s\s/,"")?e||5!==r.replace(",","").length||"}"!==r.replace(/\s\s\s\s/,"").replace(",","")?"["!==r&&"]"!==r&&(a+=r):(e=!0,a+="}"):(o=!0,a="{"),!0===o&&!0===e&&(o=!1,e=!1,n=await this.src.ror._format(JSON.parse(a)),a="",u+=1,t.push(n),2e4===t.length&&(console.log("ROR bulk loading",t.length,u),await this.src.ror(t),t=[]))}catch(t){}}return t.length&&await this.src.ror(t),console.log(u),u},s.src.ror.load._bg=!0,s.src.ror.load._async=!0,s.src.ror.load._auth="root",null==(c=r.src).zenodo&&(c.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(t){}s.src.zenodo={deposition:{},records:{}},s.src.zenodo.records.search=function(t,e){var i,s,r;return null==t&&(t=this.params),null==e&&(e=this.params.dev),s=null!=(i=this.params.size)?i:10,r="https://"+(this.S.dev||e?"sandbox.":"")+"zenodo.org/api/records?size="+s+"&q="+encodeURIComponent(t),this.fetch(r)},s.src.zenodo.records.record=function(t,e){var i;return null==t&&(t=null!=(i=this.params.record)?i:this.params.id),null==e&&(e=this.params.dev),this.fetch("https://"+(this.S.dev||e?"sandbox.":"")+"zenodo.org/api/records/"+t)},s.src.zenodo.records.get=async function(t,e){var i;null==t&&(t=this.params.get),null==e&&(e=this.params.dev),i=await this.src.zenodo.records.search(t,e);try{return i.hits.hits[0]}catch(t){}},s.src.zenodo.records.doi=function(t,e){return null==t&&(t=this.params.doi),null==e&&(e=this.params.dev),this.src.zenodo.records.get('doi:"'+t+'"',e)},s.src.zenodo.records.title=function(t,e){return null==t&&(t=this.params.title),null==e&&(e=this.params.dev),this.src.zenodo.records.get('title:"'+t+'"',e)},s.src.zenodo.records.format=function(t){var e,i,s,r,a,n,l,o,u,c,h;null==t&&(t=this.params),o={};try{null==o.pdf&&(o.pdf=t.pdf)}catch(t){}try{null==o.url&&(o.url=t.url)}catch(t){}null==o.doi&&(o.doi=t.doi);try{if("string"==typeof t.metadata.publication_date&&3===t.metadata.publication_date.split("-").length){o.published=t.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(t){}}}catch(t){}try{null==o.title&&(o.title=t.metadata.title)}catch(t){}try{null==o.journal&&(o.journal=t.metadata.journal.title)}catch(t){}try{null==o.issue&&(o.issue=t.metadata.journal.issue)}catch(t){}try{null==o.page&&(o.page=t.metadata.journal.pages)}catch(t){}try{null==o.volume&&(o.volume=t.metadata.journal.volume)}catch(t){}try{null==o.keyword&&(o.keyword=t.metadata.keywords)}catch(t){}try{null==o.licence&&(o.licence=t.metadata.license.id)}catch(t){}try{o.abstract=t.metadata.description}catch(t){}try{(t.metadata.access_right="open")&&(null==o.url&&(o.url=null!=t.files&&t.files.length&&null!=(null!=(u=t.files[0].links)?u.self:void 0)?t.files[0].links.self:t.links.html),null==o.open&&(o.open=o.url))}catch(t){}try{for(c=t.files,r=0,n=c.length;r<n;r++)if("pdf"===(s=c[r]).type){null==o.pdf&&(o.pdf=s.links.self);break}}catch(t){}try{for(null==o.author&&(o.author=[]),h=t.metadata.creators,a=0,l=h.length;a<l;a++){if("string"==typeof(e=h[a])&&(e={name:e}),null!=e.name&&"unknown"!==e.name.toLowerCase()){i=e.name.split(" ");try{e.family=i[i.length-1]}catch(t){}try{e.given=e.name.replace(e.family,"").trim()}catch(t){}}null!=e.affiliation&&(_.isArray(e.affiliation)&&(e.affiliation=e.affiliation[0]),"string"==typeof e.affiliation&&(e.affiliation={name:e.affiliation})),o.author.push(e)}}catch(t){}return o},s.src.zenodo.deposition.create=async function(t,e,i,s){var r,a,n,l,o,u,c,h,d;return null==s&&(s=null!=(n=this.params.dev)?n:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=s?null!=(l=this.S.src)&&null!=(o=l.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==t&&(t=this.params.metadata),null!=i&&null!=t&&null!=t.title&&null!=t.description&&(d="https://"+(s?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(a={metadata:t}).metadata.upload_type||(a.metadata.upload_type="publication",a.metadata.publication_type="article"),null==(r=a.metadata).creators&&(r.creators=[{name:"Works, Open Access"}]),null!=e?(null!=(null!=(h=await this.fetch(d,{method:"POST",body:a}))?h.id:void 0)&&(e.content||e.file)&&(h.uploaded=await this.src.zenodo.deposition.upload(h.id,e.content,e.file,e.name,e.url,i,s)),e.publish&&(h.published=await this.src.zenodo.deposition.publish(h.id,i,s)),h):await this.fetch(d,{method:"POST",body:a}))},s.src.zenodo.deposition.upload=async function(t,e,i,s,r,a,n){var l,o,u,c;if(null==t&&(t=null!=(l=this.params.upload)?l:this.params.id),null==e&&(e=this.params.content),null==s&&(s=this.params.filename),!e&&!i)try{i=this.request.files[0]}catch(t){}if(r&&!e&&!i)try{e=await this.fetch(r,{buffer:!0})}catch(t){}return null==a&&(a=this.params.token),null==a&&(a=this.S.dev||n?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==n&&(n=this.params.dev),null!=a&&null!=t&&(r="https://"+(this.S.dev||n?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"/files?access_token="+a,this.fetch(r,{file:null!=e?e:i,filename:s}))},s.src.zenodo.deposition.publish=function(t,e,i){var s,r,a,n,l;return null==t&&(t=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==e&&(e=this.params.token),null==e&&(e=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src)&&null!=(n=a.zenodo)?n.token:void 0),null!=e&&null!=t&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"/actions/publish?access_token="+e,this.fetch(l,{method:"POST"}))},s.src.zenodo.deposition.delete=async function(t,e,i){var s,r,a,n;return null==t&&(t=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==e&&(e=this.params.token),null==e&&(e=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src.zenodo)?a.token:void 0),null!=e&&null!=t&&(n="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+t+"?access_token="+e,await this.fetch(n,{method:"DELETE"}),!0)},s.blacklist=async function(t){var e,i,s,r,a,n,l,o;if(null==t&&(t=this.params.url),"number"==typeof t&&(t=t.toString()),null!=t&&(t.length<4||-1===t.indexOf(".")))return!1;for(i=[],r=0,n=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;r<n;r++)s=o[r],i.push(s.url.toLowerCase());if(t){if(!t.startsWith("http")&&t.includes(" "))return!1;for(a=0,l=i.length;a<l;a++)if(e=i[a],t.includes(e.toLowerCase()))return!0;return!1}return i},s.bug=function(){var t,e,i,s,r,a,n,l,o,u,c;if(this.params.contact)return"";for(t in c=["help@oa.works"],u="",this.params)u+=t+": "+JSON.stringify(this.params[t],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(s=this.params)?s.form:void 0)?o+=" Wrong article":"bug"===(null!=(r=this.params)?r.form:void 0)?o+=" Bug":"general"===(null!=(a=this.params)?a.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(n=null!=(l=this.params)?l.form:void 0)&&"uninstall"!==n||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:e=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:e}},s.cache=async function(t,e,i){var s,r,a,n,l,o,u,c,h,d;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==t&&(t=this.request);try{for(d=t.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)a=u[l],-1!==d.indexOf(a+"=")&&(n=new RegExp(a+"=.*?&"),d=d.replace(n,"")),-1!==d.indexOf("&"+a+"=")&&(d=d.split("&"+a+"=")[0]);r=new URL(d)}catch(t){}}catch(t){}if(null!=t)try{if(null==r&&(r=new URL(t.url)),s=new Request(r.toString().replace("?refresh=true","").replace("&refresh=true",""),t),null==e||""===e)return h=await caches.default.match(s),""===e&&this.waitUntil(caches.default.delete(s)),h;e=e.clone(),(c=new Response(e.body,e)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(s,c))}catch(t){}}},s.cache._auth="system";u=[].indexOf;null==s.convert&&(s.convert={}),s.convert.json2csv=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O;if(null==t&&(t=null!=(y=this.body)?y:this.params),null==e&&(e=this.params),e.url&&(t=await this.fetch(e.url)),e.es||null!=(null!=t&&null!=(_=t.hits)?_.hits:void 0))try{t=t.hits.hits,e.es=!0}catch(t){}if(Array.isArray(t)||(t=[t]),p=null!=(v=e.quote)?v:'"',O=null!=(b=e.separator)?b:",",h=null!=(w=e.newline)?w:"\n",t.length){for(s=null!=(x=e.keys)?x:[],g="",r=0,o=t.length;r<o;r++){if(m=t[r],g.length&&(g+=h),!1!==e.es&&(m._source||m.fields)){for(d in S=null!=(k=m._source)?k:m.fields,f={},a=!0,(!e.keys||u.call(e.keys,"_id")>=0)&&(f._id="<a onclick=\"this.setAttribute('href', window.location.href.split('.html')[0].split('/').pop() + '/' + this.getAttribute('href') )\" href=\""+m._id+'.html">'+m._id+"</a>",a=!1),S)if(null==f[d]&&(f[d]=S[d]),a&&d===e.keys[0]){try{f[d]="<a onclick=\"this.setAttribute('href', window.location.href.split('.html')[0].split('/').pop() + '/' + this.getAttribute('href') )\" href=\""+m._id+'.html">'+S[d]+"</a>"}catch(t){}a=!1}m=f}if(e.flatten&&(m=await this.flatten(m)),e.subset&&(m=await this.dot(m,e.subset)),!e.keys)for(l in m)null!=m[l]&&u.call(s,l)<0&&s.push(l);for(n=0,c=s.length;n<c;n++){if(i=s[n],g.length&&!g.endsWith(h)&&(g+=O),g+=p,null!=m[i]){try{Array.isArray(m[i])&&1===m[i].length&&Array.isArray(m[i][0])&&(m[i]=m[i][0])}catch(t){}try{Array.isArray(m[i])&&m[i].length&&"object"!=typeof m[i][0]&&(m[i]=m[i].join(","))}catch(t){}try{"object"==typeof m[i]&&(m[i]=JSON.stringify(m[i]))}catch(t){}try{'"'===p&&-1!==m[i].indexOf(p)&&(m[i]=m[i].replace(/"/g,p+p))}catch(t){}try{m[i]=m[i].replace(/\n/g," ")}catch(t){}try{m[i]=m[i].replace(/\s\s/g," ")}catch(t){}try{g+=m[i]}catch(t){}}g+=p}}return p+s.join(p+O+p)+p+"\n"+g}return""},s.convert.csv2json=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w;if(null==e&&(e=this.params),null==t&&(t=null!=(p=this.body)?p:this.params.csv),(e.url||"string"==typeof t&&t.startsWith("http"))&&(t=await this.fetch(null!=(f=e.url)?f:t)),_=[],"string"==typeof t&&t.length&&(d=null!=(m=e.quote)?m:'"',b=null!=(g=e.separator)?g:",",c=null!=(y=e.newline)?y:"\n",(u=t.split(c)).length))for(s=u.shift().split(d+b),h="",r=0,n=u.length;r<n;r++)if((w=(h+=(h?c:"")+(o=u[r])).split(d+b)).length===s.length&&(!d||o.endsWith(d))){for(h="",v={},a=0,l=s.length;a<l;a++)if((i=s[a]).startsWith(d)&&(i=i.replace(d,"")),i.endsWith(d)&&(i=i.substring(0,i.length-1)),w.length&&(v[i]=w.shift(),v[i])){v[i].startsWith(d)&&(v[i]=v[i].replace(d,"")),!w.length&&v[i].endsWith(d)&&(v[i]=v[i].substring(0,v[i].length-1));try{v[i]=JSON.parse(v[i])}catch(t){}}_.push(v)}return _},s.convert.csv2html=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(null==t&&(t=null!=(h=this.body)?h:this.params.csv),null==e&&(e=this.params),(e.url||"string"==typeof t&&t.startsWith("http"))&&(t=await this.fetch(null!=(d=e.url)?d:t)),'"',",","\n",m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(t=t.replace(/,,/g,',"",'))&&t.length&&(o=t.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,r=(p=o.shift().split('","')).length;i<r;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+p[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",s=0,a=o.length;s<a;s++){for(l=o[s],m+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(y=0,c=0,n=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<n;c++)y+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(g=(g=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===g.indexOf("{")||0===g.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;y<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',y+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},s.convert.json2html=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p;if(null==t&&(t=null!=(c=this.body)?c:this.params),null==e&&(e=this.params),e.url&&(t=await this.fetch(url)),e.new)for(null==e.edit&&(e.edit=!0),t={},s=0,a=(h=await this.index.keys(this.route.replace(/\//g,"_"))).length;s<a;s++)t[h[s]]="";if(e.subset&&!Array.isArray(t))for(o=e.subset.split(".");(l=o.shift())&&"object"==typeof t&&!Array.isArray(t)&&null!=t[l];)t=t[l];if(Array.isArray(t)||null!=(null!=t&&null!=(d=t.hits)?d.hits:void 0)&&!1!==e.es)return null!=o&&(e.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(t,e));if(p="<div>",e.flatten&&(t=await this.flatten(t),p+='<input type="hidden" id="options_flatten" value="true">'),e.subset){if(o.length)for(r=0,n=o.length;r<n;r++)t=t[o[r]];p+="<h3>"+e.subset+":</h3>",p+='<input type="hidden" id="options_subset" value="'+e.subset+'">'}return(i=t=>{var s,r,a,n,l,o,c,h,d,f,m;if(e.edit&&null==t.comments&&(t.comments=""),e.keys)for(n=0,r=(h=e.keys).length;n<r;n++)null==t[c=h[n]]&&(t[c]="");for(s in f=[],t){try{Array.isArray(t[s])&&1===t[s].length&&Array.isArray(t[s][0])&&(t[s]=t[s][0])}catch(t){}if(null==t[s]||Array.isArray(t[s])&&!t[s].length||e.keys&&!(u.call(e.keys,s)>=0))f.push(void 0);else{if(p+='<div style="clear:both; '+(e.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+s+"</p></b></div>",p+='<div style="float:left;">',p+=e.edit?'<textarea class="PForm" id="'+s+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(t[s]))if("object"==typeof t[s][0])for(l=0,a=(d=t[s]).length;l<a;l++)o=d[l],i(o);else{try{m=t[s].join(", ")}catch(e){try{m=JSON.stringify(t[s])}catch(e){m=t[s]}}try{p+=(e.edit?"":"<p>")+m+(e.edit?"":"</p>")}catch(t){}}else"object"==typeof t[s]?i(t[s]):p+=(e.edit?"":"<p>")+t[s]+(e.edit?"":"</p>");p+=e.edit?"</textarea>":"",f.push(p+="</div></div>")}}return f})(t),p+="</div>"},s.convert.json2txt=async function(t){var e,i,s;return null==t&&(t=null!=(i=this.body)?i:this.params),this.params.url&&(t=await this.fetch(this.params.url)),s=[],e=async function(t){var i,r,a,n,l;if(Array.isArray(t)){for(n=[],r=0,a=t.length;r<a;r++)i=t[r],n.push(await e(i));return n}if("object"==typeof t){for(i in l=[],t)l.push(await e(t[i]));return l}if(t)return s.push(t)},await e(t),s.join(" ")},s.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},s.convert.hex2bin=function(t){var e,i,r,a,n;for(n=[],e=0,r=(a=Array.isArray(t)?t:[t]).length;e<r;e++)i=a[e],n.push(s.convert._hexMatch[i.toLowerCase()]);return n.join("")},s.convert.bin2hex=function(t){var i,r,a,n,l,o,u,c,h;if(!Array.isArray(t)){for(i=[],h=t.split(""),u="";h.length;)4===(u+=h.shift()).length&&(i.push(u),u="");t=i}for(n in c=[],r={},s.convert._hexMatch)r[s.convert._hexMatch[n]]=n;for(a=0,o=t.length;a<o;a++)l=t[a],c.push("0x"+r[l]);return new e(c).toString()},s.convert.buf2bin=async function(t){var i,r;for(e.isBuffer(t)&&(t=t.toString("hex")),t=t.replace(/^0x/,""),r="",i=0;i<t.length;)r+=await s.convert.hex2bin(t[i]),i++;return r},s.convert.stream2txt=function(t){var i;return i=[],new Promise((s,r)=>(t.on("data",t=>i.push(e.from(t))),t.on("error",t=>r(t)),t.on("end",()=>s(e.concat(i).toString("utf8")))))},s.date=function(t,e,i=!0,s=!0){var r,a,n,l,o;if(null==t&&(t=null!=(n=this.params.date)?n:Date.now()),null==e&&(e=this.params.time),"number"==typeof t||"string"==typeof t&&-1===t.indexOf(" ")&&-1===t.indexOf("/")&&-1===t.indexOf("-")&&t.length>8&&-1===t.indexOf("T"))try{return o=(o=new Date(parseInt(t))).toISOString(),e?i?s||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(t){}try{if("number"==typeof t&&(t=t.toString()),Array.isArray(t)&&1===t.length&&Array.isArray(t[0])&&(t=t[0]),"string"!=typeof t)try{for(r in t)"number"!=(l=typeof t[r])&&"string"!==l&&(t[r]="01");t=t.join("-")}catch(t){}return-1!==(t=decodeURIComponent(t)).indexOf("T")&&(t=t.split("T")[0]),-1===(t=t.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).indexOf("-")&&(t+="-01"),3!==(a=t.split("-")).length&&(a=(t+="-01").split("-")),3!==a.length&&(t=void 0),a[0].length<a[2].length&&(t=a.reverse().join("-")),t}catch(t){}},s.date._cache=!1,s.datetime=function(t,e){var i,s;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(s=null!=t?t:this.params.secs)?s:this.params.s,null!=e?e:this.params.ms)},s.datetime._cache=!1,s.epoch=function(t){var e,i,s,r,a;if(null==t&&(t=this.params.epoch),"number"==typeof t&&(t=t.toString()),!t)return Date.now();if(!(t.startsWith("+")||t.startsWith("-")||2===t.split("+").length&&t.split("+")[0].length>4||2===t.split("-").length&&t.split("-")[0].length>4)){if(t.length>8&&!t.includes("-")&&!isNaN(parseInt(t)))return this.date(t,null==(s=this.params.time)||s);for(4===t.length&&(t+="-01"),t.split("-").length<3&&(t+="-01"),-1===t.indexOf("T")&&(t+="T"),-1===t.indexOf(":")&&(t+="00:00"),t.split(":").length<3&&(t+=":00"),-1===t.indexOf(".")&&(t+="."),[r,i]=t.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return-1===i.indexOf("Z")&&(i+="Z"),new Date(r+"."+i).valueOf()}return(t.startsWith("+")||t.startsWith("-"))&&(t=Date.now()+t),t.includes("+")?([t,e]=t.replace("/","").split("+"),(parseInt(t)+parseInt(e)).toString()):t.includes("-")?([t,a]=t.replace("/","").split("-"),(parseInt(t)-parseInt(a)).toString()):void 0},s.epoch._cache=!1,s.fetch=async function(t,i){var s,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F;if(null==t&&null==i)try{i=this.copy(this.params)}catch(t){}for("object"==typeof t&&null==i&&(t=(i=t).url),null==i&&(i={}),"number"==typeof i&&(i={cache:i}),"number"==typeof i.cache&&(null==i.cf&&(i.cf={cacheEverything:!0}),i.cf.cacheTtl=i.cache,delete i.cache),!t&&i.url&&(t=i.url,delete i.url),!0===i.bg&&"string"==typeof r.bg&&(i.url=t,t=r.bg+"/fetch",delete i.bg),i.username&&i.password&&(i.auth=i.username+":"+i.password,delete i.username,delete i.password),t.includes("@")&&t.includes(":")&&t.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(i.auth=t.split("//")[1].split("@")[0],t=t.replace(i.auth+"@","")),i.auth&&(null==i.headers&&(i.headers={}),i.headers.Authorization="Basic "+e.from(i.auth).toString("base64"),delete i.auth),d=0,g=(N=["data","content","json"]).length;d<g;d++)null!=i[l=N[d]]&&(i.body=i[l],delete i[l]);if(null==i.attachment&&(i.attachment=i.attachments),null==i.file&&(i.file=i.attachment),null!=i.file){for(null==i.headers&&(i.headers={}),null!=i.body&&null==i.form&&(i.form=i.body),i.body=new FormData,Array.isArray(i.file)||(c="object"==typeof i.file&&null!=i.file.file?[{file:i.file.file,filename:null!=(L=null!=(T=i.file.filename)?T:i.file.name)?L:i.filename}]:[{file:i.file,filename:i.filename}],i.file=c),p=0,y=(q=i.file).length;p<y;p++)null==(null!=(h=q[p])?h.file:void 0)&&null==(null!=h?h.data:void 0)||i.body.append(null!=i.attachment?"attachment":"file",null!=(U=h.file)?U:h.data,null!=(M=null!=(W=null!=(z=h.filename)?z:h.name)?W:i.filename)?M:"file");delete i.filename,null==i.method&&(i.method="POST")}else null!=i.body&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="object"==typeof i.body?"application/json":"text/plain"),"object"!=(J=typeof i.body)&&"boolean"!==J&&"number"!==J||(i.body=JSON.stringify(i.body)),null==i.method&&(i.method="POST"));if(null!=i.form){if(null!=i.file){if("object"==typeof i.form)for(u in i.form)for(m=0,_=(B=Array.isArray(i.form[u])?i.form[u]:[i.form[u]]).length;m<_;m++)a=B[m],i.body.append(u,"object"==typeof a?JSON.stringify(a):a)}else{if(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof i.form){for(O in A="",i.form)for(""!==A&&(A+="&"),w=0,v=(R=Array.isArray(i.form[O])?i.form[O]:[i.form[O]]).length;w<v;w++)null!=(j=R[w])&&(A.endsWith("&")||(A+="&"),A+=O+"="+encodeURIComponent("object"==typeof j?JSON.stringify(j):j));i.form=A}i.body=i.form}delete i.form,null==i.method&&(i.method="POST")}if(delete i.file,delete i.attachment,delete i.attachments,"string"!=typeof t);else{if(t.includes("localhost"))try{null==i.agent&&(i.agent=new https.Agent({rejectUnauthorized:!1}))}catch(t){}if(t.includes("?")){for(S=(C=t.split("?")).shift()+"?",x=0,b=(P=C.join("?").split("&")).length;x<b;x++)D=P[x],S.endsWith("?")||(S+="&"),[f,F]=D.split("="),null==F&&(F=""),f&&(S+=encodeURIComponent(f)+(F?"="+(F.includes("%")?F:encodeURIComponent(F)):""));t=S}if(i.params&&"{}"!==JSON.stringify(i.params)){for(f in t.includes("?")||(t+="?"),E=i.params)F=E[f],t.endsWith("&")||t.endsWith("?")||(t+="&"),f&&(t+=encodeURIComponent(f)+"="+encodeURIComponent("object"==typeof F?JSON.stringify(F):F));delete i.params}r.system&&("string"==typeof r.bg&&t.startsWith(r.bg)||"string"==typeof r.kv&&r.kv.startsWith("http")&&t.startsWith(r.kv))&&(null==i.headers&&(i.headers={}),null==(n=i.headers)[k="x-"+r.name.toLowerCase()+"-system"]&&(n[k]=r.system),i.headers.Authorization||i.headers.authorization||i.headers["x-apikey"]||!this.user||(i.headers["x-apikey"]=this.user.apikey)),s=async()=>{var e,s,a;if(i.stream)return delete i.stream,fetch(t,i);if(e=!1,i.buffer&&(e=!0,delete i.buffer),a=await fetch(t,i),t.includes("localhost")&&200===a.status||!r.dev||!0!==r.bg||console.log(a.status+" "+t),e)s=await a.buffer();else{s=await a.text();try{"string"==typeof s&&(s.startsWith("{")||s.startsWith("["))&&(s=JSON.parse(s))}catch(t){}}return 404!==a.status?a.status>=400?(r.dev&&!0===r.bg&&console.log(i,JSON.stringify(s),"FETCH ERROR",a.status),{status:a.status}):s:void 0};try{i.timeout&&null!=(null!=this?this._timeout:void 0)?(I=!0===i.timeout?3e4:i.timeout,delete i.timeout,Y=await this._timeout(I,s())):Y=await s();try{((Y=Y.trim()).startsWith("[")||Y.startsWith("{"))&&(Y=JSON.parse(Y))}catch(t){}return Y}catch(t){o=t,r.dev&&!0===r.bg&&console.log(o,JSON.stringify(o),"ERROR TRYING TO CALL FETCH");try{this.log(o)}catch(t){}}}},s.fetch._auth="system",s._timeout=function(t,e){return new Promise((e,i)=>{var s;return s=setTimeout(()=>i(new Error("TIMEOUT")),t),promise.then(value(()=>(clearTimeout(s),e(value)))).catch(reason(()=>(clearTimeout(s),i(reason))))})},s.hash=async function(t){var e,i,s,r,a,n,l,o,u,c;null==t&&(t=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(t=await this.fetch(this.params.url))}catch(t){}"string"!=typeof t&&(t=JSON.stringify(t));try{for(t=(new TextEncoder).encode(t),s=await crypto.subtle.digest("SHA-256",t),e=new Uint8Array(s),n=[],r=0,a=e.length;r<a;r++)i=e[r],n.push(("00"+i.toString(16)).slice(-2));return n.join("")}catch(e){return crypto.createHash("sha256").update(t,"utf8").digest("hex")}},s.hashcode=function(t){var e,i,s,r,a,n;for(null==t&&(t=null!=(s=null!=(r=null!=(a=null!=(n=this.params.hashcode)?n:this.params.content)?a:this.params.q)?r:this.params)?s:this.body),"string"!=typeof t&&(t=JSON.stringify(t)),e=0,i=0;i<t.length;)e=(e<<5)-e+t.charCodeAt(i),e&=e,i++;return e},s.hashhex=function(t){var e;return null==t&&(t=this.params.hashhex),(e=this.hashcode(t))<0&&(e=4294967295+e+1),e.toString(16)},s.shorthash=function(t,e){var i,s,r,a,n,l,o,u;for(null==t&&(t=null!=(r=null!=(a=null!=(n=null!=(l=this.params.shorthash)?l:this.params.content)?n:this.params.q)?a:this.params)?r:this.body),"string"!=typeof t&&(t=JSON.stringify(t)),s=this.hashcode(t),e?(u=e.substring(0,1),e=e.replace(u,"")):(e="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=e.length,o=s<0?u:"",s=Math.abs(s);s>=i;)o+=e[s%i],s=Math.floor(s/i);return o+(s>0?e[s]:"")};var c,h,d,p,f,m;u=[].indexOf;null==r.index&&(r.index={}),null==(c=r.index).name&&(c.name=null!=(d=r.name)?d:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(h=r.index).url&&(h.url=r.bg+"/index"),s.index=async function(t,e,i,r){var a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w;if("object"==typeof t&&(e=t,t=void 0),null==t&&null==e&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(h=this.parts[1])||"src"===h))return{status:403};if("object"==typeof this.body?e=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(e=this.body):e=this.copy(this.params),delete e.route,delete e.index,delete e[this.fn.split(".").pop()],delete e._id,null!=e.script||-1!==JSON.stringify(e).toLowerCase().indexOf("<script"))return}if("object"!=typeof e||Array.isArray(e)||(null==t&&(t=null!=(d=e.route)?d:e.index),delete e.route,delete e.index),null==t)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in y=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||y.push(l);return y}2===this.parts.length?t=this.parts[1]:this.parts.length>2&&(t=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(t=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(t+="/"+this.parts.join("_").replace(t+"_","")));if("string"==typeof t)if(t.includes("?")?([t,w]=t.split("?"),w="?"+w):w="",t.endsWith("/")&&(t=t.replace(/\/$/,"")),"object"==typeof e&&!Array.isArray(e)&&e._id&&(n=(e=null!=(null!=this?this.copy:void 0)?this.copy(e):s.copy(e))._id.replace(/\//g,"_"),-1===t.indexOf("/")&&-1===t.indexOf(n)&&(t+="/"+n),delete e._id),b=(t=t.toLowerCase()).split("/").length,null==this.index&&(this.index=s.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===t.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===e)_=await this.index._send(t.replace("/","/_doc/")+w,"");else if(1===b){if("string"==typeof e&&(""===e||-1!==e.indexOf("\n"))||Array.isArray(e))return""===e?this.index._send(t+w,e):this.index._bulk(t+w,e);if("object"!=(p=typeof e)&&"string"!==p)return this.index._send(t+"/_search"+w);if("{}"!==JSON.stringify(e)&&(c=await this.index.translate(e,i)))return this.index._send(t+"/_search"+w,c);if("object"==typeof e){for(a=null!=(null!=this?this.copy:void 0)?this.copy(e):s.copy(e),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete a[f[o]];return"{}"===JSON.stringify(a)?(await this.index._send(t+w)||await this.index._send(t+w,{settings:e.settings,aliases:e.aliases,mappings:null!=(m=e.mappings)?m:e.mapping}),this.index._send(t+"/_search"+w)):"created"===(null!=(_=await this.index._send(t+"/_doc"+w,e))?_.result:void 0)&&_._id?_._id:_}}else if(2===b&&(null==e||"object"==typeof e&&!Array.isArray(e)))return t.startsWith("_")||t.includes("/_")||(t=t.replace("/","/_doc/")),null!=e&&"{}"!==JSON.stringify(e)?("object"==typeof e&&null!=e.script&&(t+="_update",w+=(w.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(_=await this.index._send(t+w,e))?_.result:void 0)&&_._id?_._id:_):("object"==typeof(_=await this.index._send(t+w))&&(_._source||_.fields)&&(null==(v=null!=(g=_._source)?g:_.fields)._id&&(v._id=_._id),_=v),_)},s.index._auths="system",s.index._caches=!1,s.index.status=async function(){var t,e,i,s,r,a,n,l,o,u,c,h,d;for(e in(u={status:"green"}).indices={},c=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),c.indices)if(!e.startsWith(".")&&!e.startsWith("security-"))for(u.indices[e]={docs:c.indices[e].primaries.docs.count,size:Math.ceil(c.indices[e].primaries.store.size_in_bytes/1024/1024)+"mb"},i=0,a=d.length;i<a;i++)(h=d[i]).index===e&&"p"===h.prirep&&(null==(t=u.indices[e]).shards&&(t.shards=0),u.indices[e].shards+=1);try{for("green"!==(l=u.cluster.status)&&"yellow"!==l&&(u.status="red"),r=0,n=(o=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;r<n;r++)s=o[r],delete u.cluster[s]}catch(t){}return u},s.index.keys=async function(t,e){var i,s,r,a,n,l;return null==t&&(t=null!=(a=null!=(n=this.params.index)?n:this.params.keys)?a:this.fn.replace(/\./g,"/")),t=t.replace("index/","").replace("/keys",""),null==e&&(e=null!=(l=this.params.type)?l:this.params.types),"string"==typeof e&&(e=[e]),s=!0===e?{}:[],r="object"==typeof t?t:await this.index.mapping(t),i=async(t,r="")=>{var a,n,l,o;for(a in r&&(r+="."),o=[],t)null!=t[a].properties?o.push(await i(t[a].properties,r+a)):!e||!0===e||(n=t[a].type,u.call(e,n)>=0)?!0===e?o.push(s[r+a]=t[a].type):(l=r+a,u.call(s,l)<0?o.push(s.push(r+a)):o.push(void 0)):o.push(void 0);return o},"object"==typeof r&&await i(r),s},s.index.terms=async function(t,e,i,s=100,r=!0,a="count"){var n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x;if(null==t&&(t=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),t=t.replace("index/","").replace("/terms",""),!e||!i){if(null==e&&(e=null!=(m=this.params.terms)?m:this.params.key),null==e&&-1!==t.indexOf("/")&&([t,e]=t.split("/")),!e)return[];for(n=this.copy(this.params),l=0,u=(g=["index","route","terms","key"]).length;l<u;l++)delete n[g[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(n)),p="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:e}}]}}},"string"==typeof i&&p.query.bool.must.push({query_string:{query:i}}),null==p.aggregations&&(p.aggregations={}),null==p.size&&(p.size=0),null!=this.params.size&&(s=this.params.size),null!=this.params.counts&&(r=this.params.counts),null!=this.params.order&&(a=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof a&&null!=h[a]&&(a=h[a]),p.aggregations[e]={terms:{field:e+(e.endsWith(".keyword")?"":".keyword"),size:s,order:a}},x=await this.index._send("/"+t+"/_search",p,"POST"),console.log(JSON.stringify(p)),console.log(JSON.stringify(x)),w=[],o=0,c=(b=null!=(y=null!=x&&null!=(_=x.aggregations)&&null!=(v=_[e])?v.buckets:void 0)?y:[]).length;o<c;o++)d=b[o],w.push(r?{term:d.key,count:d.doc_count}:d.key);return w},s.index.suggest=async function(t,e,i,s=100,r){var a,n,l,o,c,h,d,p,f,m,g,y,_;if(e&&i||(null==e&&(e=null!=(p=this.params.suggest)?p:this.params.key),"string"==typeof e&&e.includes("/")&&([e,i]=e.split("/"))),!e)return this.index.keys(t,"text");if(null==t&&(t=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),t=t.replace("index/","").split("/suggest")[0],null==r&&(r=this.params.include),"string"==typeof r&&(r=r.replace(/,\s/g,",").split(",")),Array.isArray(r)&&u.call(r,e)<0&&r.push(e),"string"==typeof i&&(h=(i=i.trim()).toLowerCase(),(_={should:[{match:{}},{prefix:{}},{query_string:{query:e+":"+i.split(" ").join(" AND "+e+":")+"*"}}]}).should[0].match[e]={query:i,boost:3},_.should[1].prefix[e]={value:i,boost:2}),g=[],y=[],r){for await(d of this.index._for(t,null!=_?_:i,{sort:e+".keyword",until:s,include:!0===r?[e]:r}))if(l=await this.dot(d,e)){for(;Array.isArray(l)&&(a=l.shift());)a.toLowerCase().includes(h)&&(l=a);o=l.toLowerCase(),u.call(y,o)<0&&(!h||o.includes(h))&&g.push(d),y.push(o)}}else for(n=0,c=(m=await this.index.terms(t,e,null!=_?_:i,s,!1,"term")).length;n<c;n++)o=(l=m[n]).toLowerCase(),console.log(o),u.call(y,o)<0&&(!h||o.includes(h))&&g.push(l),y.push(o);return g},s.index.count=async function(t,e,i){var s,r,a,n,l,o,u,c,h,d,p;for(null==i&&(i=null!=(l=this.params.count)?l:this.params.key),null==t&&(t=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(t=t.replace("index/","").split("/count")[0]).indexOf("/")&&([t,i]=t.split("/")),s=this.copy(this.params),r=0,a=(u=["index","route","count","key"]).length;r<a;r++)delete s[u[r]];return null==e&&(n=await this.index.translate(s))&&(e=n),"string"==typeof e&&(e=await this.index.translate(e)),null==e&&(e={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),e.size=0,e.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(p=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(c=p.aggregations)&&null!=(h=c.keyed)?h.value:void 0):null!=(p=await this.index._send("/"+t+"/_search",e,"POST"))&&null!=(d=p.hits)?d.total:void 0},s.index.min=async function(t,e,i,s="min"){var r,a,n,l,o,u,c,h;for(null==e&&(e=null!=(o=this.params[s])?o:this.params.key),null==t&&(t=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(t=t.replace("index/","").replace("/"+s,"")).indexOf("/")&&([t,e]=t.split("/")),r=this.copy(this.params),a=0,n=(c=["index","route","min","max","key"]).length;a<n;a++)delete r[c[a]];return null==i&&(i=await this.index.translate(r)),(l="object"==typeof e?e:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:e}}]}}}).size=0,l.aggs={},"min"!==s&&"range"!==s||(l.aggs.min={min:{field:e}}),"max"!==s&&"range"!==s||(l.aggs.max={max:{field:e}}),h=await this.index._send("/"+t+"/_search",l,"POST"),"range"===s?{min:h.aggregations.min.value,max:h.aggregations.max.value}:h.aggregations[s].value},s.index.max=function(t,e,i){return this.index.min(t,e,i,"max")},s.index.range=function(t,e,i){return this.index.min(t,e,i,"range")},s.index.mapping=async function(t){return-1===(t=t.replace(/^\//,"")).indexOf("/")&&(t+="/"),-1===t.indexOf("_mapping")&&(t=t.replace("/","/_mapping")),(await this.index._send(t))[t.replace("/_mapping","").replace(/\//g,"_").replace(/^_/,"")].mappings.properties},s.index.history=function(t,e){var i;try{null==e&&(e=null!=(i=this.params.history)?i:this.params.index)}catch(t){}return[]},s.index._for=async function*(t,e,i){var s,r,a,n,l,o,u,c,h,d,p,f,m;for("number"==typeof i&&(i={until:i}),(null!=i?i.scroll:void 0)?("number"!=typeof(m=i.scroll)&&m.endsWith("m")||(m+="m"),delete i.scroll):m="2m",((null!=i?i.until:void 0)||(null!=i?i.max:void 0))&&(r=null!=(o=i.until)?o:i.max,delete i.until,delete i.max),null==e&&(e="*"),null==(n=await this.index.translate(e,i)).from&&(n.from=0),null==n.size&&(n.size=500),null==n.sort&&(n.sort=["_doc"]),(null!=(p=await this.index._send(t+"/_search?scroll="+m,n))?p._scroll_id:void 0)&&(a=p._scroll_id.replace(/==$/,"")),(null!=p&&null!=(u=p.hits)?u.total:void 0)&&(null==r||r>p.hits.total)&&(r=p.hits.total),s=0;;){if((null!=p&&null!=(c=p.hits)?c.hits:void 0)&&0!==p.hits.hits.length||!(null!=p?p._scroll_id:void 0)||(null!=(p=await this.index._send("/_search/scroll?scroll="+m+"&scroll_id="+p._scroll_id))?p._scroll_id:void 0)!==a&&(await this.index._send("/_search/scroll?scroll_id="+a,""),a=null!=p?p._scroll_id:void 0),s===r||null==(null!=p&&null!=(h=p.hits)?h.hits:void 0)||!p.hits.hits.length){a&&await this.index._send("/_search/scroll?scroll_id="+a,"");break}s+=1,null==(f=null!=(d=(l=p.hits.hits.shift())._source)?d:l.fields)._id&&(f._id=l._id),yield f}},s.index._each=async function(t,i,s,r){var a,n,l,o,u,c,h,d,p,f,m;for await(h of(null==r&&null==s&&"function"==typeof i&&(r=i,i="*"),null==r&&"function"==typeof s&&(r=s,s=void 0),null==s&&(s={}),"string"==typeof s&&(a=s,s=void 0),(null!=s?s.action:void 0)&&(a=s.action,delete s.action),(f=null!=(d=s.size)?d:"object"==typeof i&&null!=i.size?i.size:1e3)>50&&((c=await this.index.translate(i,s)).size=1,null!=(null!=(n=await this.index._send(t,c))&&null!=(p=n.hits)?p.total:void 0)&&0!==n.hits.total&&(o=Math.floor(1e9/(e.byteLength(JSON.stringify(n.hits.hits[0]))*n._shards.total)))<f&&(f=o),c.size=f),u=0,m=[],this.index._for(t,null!=c?c:i,s)))u+=1,null==(l=await r.call(this,h))||"object"!=typeof l&&"string"!=typeof l||m.push(l),a&&m.length>f&&(await this.index._bulk(t,m,a),m=[]);if(a&&m.length&&this.index._bulk(t,m,a),this.S.dev&&!0===this.S.bg)return console.log("_each processed "+u)},s.index._bulk=async function(t,e,i="index",r=5e4){var a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A;if(!0===i&&(i="index"),!1!==await this.dot(s,t.split("/")[0].replace(/_/g,".")+"._prefix")&&(t=this.S.index.name+"_"+t),null==this.index&&(this.index=s.index),"string"==typeof e&&-1!==e.indexOf("\n"))return await this.index._send("/_bulk",{body:e,headers:{"Content-Type":"application/x-ndjson"}}),!0;for(p in O="object"!=typeof e||Array.isArray(e)||null==(null!=e&&null!=(f=e.hits)?f.hits:void 0)?e:e.hits.hits,Array.isArray(O)||(O=[O]),a=0,n=0,d="",O)if(a+=1,"object"==typeof(S=O[p])&&("string"==typeof(k=null!=(m=null!=(g=S._id)?g:null!=(y=S._source)?y._id:void 0)?m:await this.uid())&&(k=k.replace(/\//g,"_")),S._source&&(S=S._source),delete S._id),(h={})[i]={_index:t},h[i]._id="delete"!==i||"string"!=(_=typeof S)&&"number"!==_?k:S,d+=JSON.stringify(h)+"\n","create"===i||"index"===i?d+=JSON.stringify(S)+"\n":"update"===i&&(d+=JSON.stringify({doc:S})+"\n"),a===r||parseInt(p)===O.length-1||d.length>7e7){if(A=await this.index._send("/_bulk",{body:d,headers:{"Content-Type":"application/x-ndjson"}}),(null!=this&&null!=(v=this.S)?v.dev:void 0)&&!0===(null!=this&&null!=(b=this.S)?b.bg:void 0)&&(null!=A?A.errors:void 0)){for(l=[],u=0,c=(w=A.items).length;u<c;u++){o=w[u];try{200!==(x=o[i].status)&&201!==x&&(l.push(o[i]),n+=1)}catch(t){n+=1}}try{console.log(l)}catch(t){}try{console.log(0===l.length?"SOME":l.length,"INDEX ERRORS BULK LOADING",A.items.length)}catch(t){}}d="",a=0}return O.length-n},s.index.translate=function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D,N,L,R,P,E,T,q,U,M,W,z,J,B,Y,F,X,V,$,G,H,Z,Q,K,tt,et,it,st,rt,at,nt,lt,ot,ut,ct,ht,dt;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==t&&(t=null!=this?this.params:void 0),"string"==typeof t){if(""===t||-1!==t.indexOf("\n"))return}else{if("object"!=typeof t||Array.isArray(t))return;for(g=0,v=(R=["settings","aliases","mappings","index","_id"]).length;g<v;g++)if(null!=t[y=R[g]])return;if("{}"!==JSON.stringify(t)&&null==t.q&&null==t.query&&null==t.source&&null==t.must&&null==t.should&&null==t.must_not&&null==t.filter&&null==t.aggs&&null==t.aggregations)return}try{"object"==typeof t&&(t=this.copy(t))}catch(t){}try{"object"==typeof e&&(e=this.copy(e))}catch(t){}if(null==e&&(e={}),("string"==typeof e||Array.isArray(e))&&(e={fields:e}),"random"===e&&(e={random:!0}),"number"==typeof e&&(e={size:e}),!0===e&&(e={newest:!0}),!1===e&&(e={newest:!1}),null!=e.newest&&(e.sort={createdAt:e.newest?"desc":"asc"},delete e.newest),null==(L=null!=(Y=null!=e?e.query:void 0)?Y:{}).query&&(L.query={}),null==(a=L.query).bool&&(a.bool={must:[],filter:[]}),"string"==typeof t)at={query_string:{query:t}},null!=(null!=e?e.fields:void 0)&&(at.query_string.fields="string"==typeof e.fields?e.fields.split(","):e.fields,delete e.fields),L.query.bool.filter.push(at);else if("object"==typeof t)if(null!=t.query)L=t;else{if(null!=t.source)if("string"==typeof t.source)try{L=JSON.parse(decodeURIComponent(t.source))}catch(t){}else"object"==typeof t.source&&(L=t.source);else null!=t.q&&("object"==typeof t.q?L.query=t.q:(t.q=decodeURIComponent(t.q),null!=t.prefix&&-1!==t.q.indexOf(":")?(delete t.prefix,(D={})[(N=t.q.split(":"))[0]]=N[1],L.query.bool.must.push({prefix:D})):null!=t.fields?(L.query.bool.filter.push({query_string:{query:t.q,fields:t.fields.split(",")}}),delete t.fields):L.query.bool.filter.push({query_string:{query:t.q}})));for(I in t)null==e[I]&&(e[I]=t[I])}if(null!=(null!=($=L.query)&&null!=(G=$.filtered)&&null!=(H=G.query)?H.bool:void 0)&&(L.query.bool=L.query.filtered.query.bool,L.query.bool.filter=L.query.filtered.filter,delete L.query.filtered),null!=L.facets&&(L.aggregations=JSON.parse(JSON.stringify(L.facets).replace(/\.exact/g,".keyword")),delete L.facets),null!=L.query&&null==L.query.bool&&JSON.stringify("{}"!==L.query)&&(L.query={bool:{must:[],filter:[L.query]}}),null==L.query&&(L.query={bool:{must:[],filter:[]}}),null==(n=L.query).bool&&(n.bool={must:[],filter:[]}),null==(l=L.query.bool).filter&&(l.filter=[]),"string"==typeof e.sort){for(rt=[],_=0,b=(Z=e.sort.split(",")).length;_<b;_++)st=Z[_],[y,I]=st.split(":"),I?(rt.push({}),rt[rt.length-1][y.trim()]=I.trim()):rt.push(y.trim());e.sort=rt}if(e.random&&(p={function_score:{random_score:{}}},null!=e.seed&&(p.function_score.random_score.seed=seed),p.function_score.query=L.query,L.query=p,delete e.random,delete e.seed),(m=null!=(Q=null!=(K=null!=(tt=e._include)?tt:e.include)?K:e._includes)?Q:e.includes)&&(null==L._source&&(L._source={}),L._source.includes="string"==typeof m?m.replace(/,\s/g,",").split(","):m),h=null!=(P=null!=(E=null!=(T=e._exclude)?T:e.exclude)?E:e._excludes)?P:e.excludes)for(null==L._source&&(L._source={}),L._source.excludes="string"==typeof h?h.replace(/,\s/g,",").split(","):h,j=0,w=(M=null!=(q=null!=(U=L._source)?U.includes:void 0)?q:[]).length;j<w;j++)f=M[j],L._source.excludes=L._source.excludes.filter((function(t){return t!==f}));for(nt=0,x=(W=["filter","restrict","must","and","must_not","not","should","or"]).length;nt<x;nt++)if(null!=e[ot=W[nt]])for(A=Array.isArray(e[ot])?e[ot]:[e[ot]],delete e[ot],c="filter"===ot||"restrict"===ot||"must"===ot||"and"===ot?"filter":"must_not"===ot||"not"===ot?"must_not":"should",null==(o=L.query.bool)[c]&&(o[c]=[]),ut=0,k=A.length;ut<k;ut++)"object"==typeof(it=A[ut])?1===(et=this.keys(it)).length&&"object"!=typeof it[et[0]]&&(it={term:it}):it={query_string:{query:it}},L.query.bool[c].push(it);if(null!=e.terms){try{e.terms=e.terms.replace(/,\s/g,",").split(",")}catch(t){}for(null==L.aggregations&&(L.aggregations={}),ht=0,S=(z=e.terms).length;ht<S;ht++)lt=z[ht],L.aggregations[lt]={terms:{field:lt+(lt.endsWith(".keyword")?"":".keyword"),size:1e3}};delete e.terms}for(dt=0,O=(J=["aggs","aggregations"]).length;dt<O;dt++)if(null!=e[i=J[dt]]){for(d in null==L[i]&&(L[i]={}),e[i])L[i][d]=e[i][d];delete e[i]}for(y in e){if(ct=e[y],("from"===y||"size"===y)&&"number"!=typeof ct)try{ct=parseInt(ct),isNaN(ct)&&(ct=void 0)}catch(t){}null!=ct&&"apikey"!==y&&"_"!==y&&"callback"!==y&&"refresh"!==y&&"key"!==y&&"counts"!==y&&"index"!==y&&"search"!==y&&"source"!==y&&"q"!==y&&"include"!==(B=y.replace("_","").replace("s",""))&&"exclude"!==B&&(L[y]=ct)}try{for(s in C={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},L.aggregations)"string"==typeof(null!=(F=L.aggregations[s].terms)?F.order:void 0)&&null!=C[L.aggregations[s].terms.order]&&(L.aggregations[s].terms.order=C[L.aggregations[s].terms.order])}catch(t){}if(null!=(null!=(X=L.query)?X.bool:void 0))for(u in L.query.bool)for(r in L.query.bool[u])"string"==typeof(null!=(V=L.query.bool[u][r].query_string)?V.query:void 0)&&-1!==L.query.bool[u][r].query_string.query.indexOf("/")&&-1===L.query.bool[u][r].query_string.query.indexOf('"')&&(L.query.bool[u][r].query_string.query='"'+L.query.bool[u][r].query_string.query+'"');return null!=L._source&&null!=L.fields&&delete L._source,L},s.index.translate._auth=!1,s.index._send=async function(t,e,i){var a,n,l,o,u,c,h,d,p;if(t.includes("?")?([t,d]=t.split("?"),d="?"+d):d="",(t=t.toLowerCase()).startsWith("/")&&(t=t.replace("/","")),t.endsWith("/")&&(t=t.replace(/\/$/,"")),null==i&&(i=""===e?"DELETE":null==e||-1!==t.indexOf("/")&&-1===t.indexOf("/_create")&&(-1===t.indexOf("/_doc")||t.endsWith("/_doc"))?null!=e||"_refresh"===(l=t.split("/").pop().split("?")[0])||"_aliases"===l?"POST":"GET":"PUT"),"DELETE"===i&&-1!==t.indexOf("/_all"))return!1;if(!t.startsWith("http")){if(!this.S.index.name||t.startsWith(this.S.index.name)||t.startsWith("_")||!1!==(n=await this.dot(s,t.split("/")[0].replace(/_/g,".")+"._prefix"))&&(t=("string"==typeof n?n:this.S.index.name)+"_"+t),p=(null!=this&&null!=(o=this.S)&&null!=(u=o.index)?u.url:void 0)?this.S.index.url:null!=(c=r.index)?c.url:void 0,Array.isArray(p)&&(p=p[Math.floor(Math.random()*p.length)]),"string"!=typeof p)return;t=p+"/"+t}if(t.startsWith("http")){if(a=-1!==(t=t+=d).indexOf("/_bulk")||"object"==typeof(null!=e?e.headers:void 0)?e:{body:e},-1===t.indexOf("/_search")||"GET"!==i&&"POST"!==i||(t+=(-1===t.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),!this.S.dev||!0!==this.S.bg||null!=(null!=e?e.query:void 0)||t.includes("/_doc/")||"DELETE"!==i&&t.includes("_search/scroll")||console.log("INDEX",i,t),a.method=i,!(null==(h=await this.fetch(t,a))||"object"==typeof h&&"number"==typeof h.status&&h.status>=400&&h.status<=600)){try{this.S.dev&&null!=(null!=e?e.query:void 0)&&(h.q=e)}catch(t){}return h}}else console.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!t[r.kv]&&(t[r.kv]={},t[r.kv].get=function(t){return s.fetch(r.kv+"/"+t)},t[r.kv].getWithMetadata=async function(t){return{value:await s.fetch(r.kv+"/"+t),metadata:{}}},t[r.kv].put=function(t,e){return s.fetch(r.kv+"/"+t,{body:e})},t[r.kv].delete=function(t){return s.fetch(r.kv+"/"+t,{method:"DELETE"})},t[r.kv].list=function(t){return null==t&&(t={}),s.fetch(r.kv+"/list"+(t.prefix?"/"+t.prefix:"")+(t.cursor?"?cursor="+t.cursor:""))}),s.kv=async function(e,i,s,r,a){var n,l,o,u,c,h,d,p,f,m,g,y,_,v;if(null==e&&(e=null!=(d=null!=(p=this.params.kv)?p:this.params.key)?d:this.parts.join("_"),null==i)){if("DELETE"===this.request.method)i="";else if(this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,n=0,u=(f=["key","kv","refresh","apikey"]).length;n<u;n++)delete i[o=f[n]];for(l=0,c=(m=this.parts).length;l<c;l++)delete i[o=m[l]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(g=JSON.stringify(i))&&"[]"!==g||(i=void 0)}if("object"!=typeof i||"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=void 0),"object"==typeof e&&null==i&&(e=null!=(_=(i=e)._id)?_:await this.uid()),null!=e&&this.S.kv&&t[this.S.kv]){if(null!=i&&""!==i){if(h={metadata:r},"number"==typeof s&&(1e3*s>Date.now()?h.expiration=s:h.expirationTtl=s),"object"==typeof i&&(!0===s&&(s=await this.kv(e)),"object"==typeof s))for(o in s)null==i[o]&&(i[o]=s[o]);return this.waitUntil(t[this.S.kv].put(e,"object"==typeof i?JSON.stringify(i):i,h)),i}if(({value:v,metadata:r}=await t[this.S.kv].getWithMetadata(e,a)),null!=v){try{v=JSON.parse(v)}catch(t){}try{r=JSON.parse(r)}catch(t){}return""===i&&this.waitUntil(t[this.S.kv].delete(e)),!0===r?{value:v,metadata:r}:v}}},s.kv._auths="system",s.kv._caches=!1,s.kv.list=async function(e,i){var s,r;try{null==e&&(e=null!=(s=null!=(r=this.params.kv)?r:this.params.prefix)?s:this.params.list)}catch(t){}try{null==i&&(i=this.params.cursor)}catch(t){}return await t[this.S.kv].list({prefix:e,cursor:i})},s.kv.count=async function(e){var i,s,r,a,n,l,o,u,c;if(s=0,this.S.kv&&null!=t[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),i=!1,r=void 0;!i;){for(r=(l=await t[this.S.kv].list({prefix:e,cursor:r})).cursor,a=0,n=(c=l.keys).length;a<n;a++)c[a],s+=1;i=l.list_complete}return s},s.kv.prefixes=async function(){var t;return t={},await this.kv._each(void 0,(function(e){var i;return i=e.split("/")[0],null==t[i]&&(t[i]=0),t[i]+=1})),t},s.kv.clear=function(e){var i;if(this.S.dev)return null==e&&(e=null!=(i=this.params.clear)?i:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(t[this.S.kv].delete(e))}))),!0},s.kv.delete=async function(t){var e,i,s,r;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==t&&(t=null!=(i=null!=(s=this.params.kv)?s:this.params.delete)?i:this.params.prefix),r=e=await this.fetch(this.S.kv+"/count"+(t?"/"+t:""));e&&"0"!==e;)this.S.dev&&console.log(t,e),await this.fetch(this.S.kv+"/clear"+(t?"/"+t:"")),await this.sleep(500),e=await this.fetch(this.S.kv+"/count"+(t?"/"+t:""));return r}},s.kv.delete._bg=!0,s.kv._each=async function(e,i){var s,r,a,n,l,o,u,c;if(0,this.S.kv&&null!=t[this.S.kv]){for("function"==typeof e&&null==i&&(i=e,e=void 0),s=!1,r=void 0,c=[];!s;){for(r=(o=await t[this.S.kv].list({prefix:e,cursor:r})).cursor,a=0,l=(u=o.keys).length;a<l;a++)n=u[a],1,"function"==typeof i?this.waitUntil(i.call(this,n.name)):""===i?this.waitUntil(t[this.S.kv].delete(n.name)):null!=i&&this.waitUntil(this.kv(n.name,i));c.push(s=o.list_complete)}return c}},null==r.log&&(r.log={}),f=[],m=!1,p=!1,s.log=function(t,e){var i,s,a,n,l,o,u,c,h,d;if(i=async()=>{var t,e;for(!1!==m&&clearTimeout(m),m=setTimeout(i,3e4),p=Date.now(),e=new Date(p).toISOString().replace("T"," ").split(".")[0],t=[];t.length<400&&f.length;)t.push(f.shift());return t.length?(!0===this.S.bg&&console.log("Writing "+t.length+" logs to index",t[0]._id,t[t.length-1]._id,e),await this.index("logs",t)||(await this.index("logs",{}),await this.index("logs",t)),[]):!0===this.S.bg?console.log("Checked log batch but none to save",e):void 0},!1!==this.S.log&&!0!==this.nolog){if(!0!==e&&(e=null==t),"string"==typeof t)t=-1!==t.indexOf("/")&&-1===t.indexOf(" ")?{fn:t}:{msg:t};else if(Array.isArray(t)){for(s=0,l=t.length;s<l;s++)n=t[s],this._logs.push(n);t=void 0}if(null==t){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return f.push(this.body),!1===m&&i(),!0;t="object"==typeof this.body?this.body:this.params,Array.isArray(t)&&(t={logs:t})}null==t&&(t={});try{t.request={url:this.request.url,method:this.request.method}}catch(t){}try{t.request.body=null!=this.body}catch(t){}try{t.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(t){}try{t.request.headers=this.headers,t.request.headers.cookie&&(t.cookie=!0,delete t.request.headers.cookie)}catch(t){}try{null==t.fn&&null!=this.fn&&(t.fn=this.fn),this.refresh&&(t.refresh=this.refresh),t.parts=this.parts,this.completed&&(t.completed=this.completed),this.cached&&(t.cached=this.cached)}catch(t){}try{for(u in t.params={},this.params)t.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(t){}try{t.apikey=null!=this.apikey}catch(t){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(t.user=this.user._id)}catch(t){}this.unauthorised&&(t.unauthorised=!0)}if(e){if(!t.logs&&(t.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(a=0,o=(h=this._logs).length;a<o;a++)(n=h[a]).alert&&null==t.alert&&(t.alert=n.alert),n.notify&&null==t.notify&&(t.notify=n.notify),t.logs.push(n);t.createdAt=new Date,null==t.name&&(t.name=r.name),null==t.version&&(t.version=r.version),t.base=this.base,this.domain&&(t.domain=this.domain),!0===this.S.bg&&(t.bg=!0),!0===this.system&&(t.system=!0),!0===this.scheduled&&(t.scheduled=!0);try{t.started=this.started,t.took=Date.now()-this.started}catch(t){}if(t._id=this.rid,null!=(null!=(d=this.S.index)?d.url:void 0))!0===this.S.bg?(f.push(t),("object"==typeof this.S.log&&!1===this.S.log.batch||f.length>300||!1===p||Date.now()>p+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(f.push(t),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:t}));else try{this.kv("logs/"+t._id,t)}catch(e){console.log("Logging unable to save to kv or index"),consolg.log(t)}}else this._logs.push(t)}else this.S.dev&&!0===this.S.bg&&console.log("NOT logging",t);return!0},s.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(t){r.mail={}}s.mail=async function(t){var e,i,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A;if(null!=(h=r.mail)?h.disabled:void 0)return{};if("string"==typeof t&&(t={text:t}),null==t&&(t=null!=(d=this.copy(null!=this?this.params:void 0))?d:{}),t.template){for(o in u=await this.template(t.template,null!=(_=null!=(v=t.vars)?v:t.params)?_:t))t[o]=u[o];delete t.template,delete t.vars,delete t.params}if(!t.text&&!t.html&&(t.text=null!=(b=null!=(w=null!=(x=null!=(k=t.content)?k:t.msg)?x:t.body)?w:this.body)?b:"","object"==typeof t.text))try{t.text=await this.convert.json2html(t.text)}catch(e){t.text=JSON.stringify(t.text)}if(delete t.content,delete t.body,t.html||"string"!=typeof t.text||-1===t.text.indexOf("<")||-1===t.text.indexOf(">")||(t.html=t.text),l=(t.svc||t.service)&&null!=(null!=(S=this.S.svc[null!=(O=t.svc)?O:t.service])?S.mail:void 0)?this.S.svc[null!=(p=t.svc)?p:t.service].mail:null!=(f=null!=this&&null!=(m=this.S)?m.mail:void 0)?f:r.mail,null==t.from&&(t.from=l.from),null==t.to&&(t.to=l.to),delete t.svc,A="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(t.to)&&(t.to=t.to.join(",")),t.to){for(e=null!=(g=null!=this?this.fetch:void 0)?g:s.fetch,c={method:"POST",auth:"api:"+l.apikey},a=0,n=(y=["file","files","attachment","attachments"]).length;a<n;a++)null!=t[i=y[a]]&&(c[i]=t[i],delete t[i]);return c.form=t,await e(A,c)}return console.log(t),console.log("NO ADDRESS TO EMAIL TO"),{}},s.mail._auth="system",s.mail.validate=async function(t,e){var i,s,r,a,n;if(null==t&&(t=null!=this&&null!=(r=this.params)?r.email:void 0),"string"==typeof t&&t.length&&(-1===t.indexOf(" ")||t.startsWith('"')&&2===t.split('"@').length)){try{if("string"==typeof e)return null!=(a=(n=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(t)+"&api_key="+e)).did_you_mean)?a:n.is_valid}catch(t){}if(2===(i=t.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(s=i[1].split(".")).length>1&&(2!==s.length||"example"!==s[0]))return!0}return!1};u=[].indexOf;s.copy=function(t){try{null==t&&(t=this.params)}catch(t){}return JSON.parse(JSON.stringify(t))},s.dot=function(t,e,i,r){return"string"==typeof e?s.dot(t,e.split("."),i,r):1!==e.length||null==i&&null==r?0===e.length?t:null==t[e[0]]?null!=i?(t[e[0]]="number"!=typeof e[0]&&isNaN(parseInt(e[0]))?{}:[],s.dot(t[e[0]],e.slice(1),i,r)):void 0:s.dot(t[e[0]],e.slice(1),i,r):null!=r?(t instanceof Array?t.splice(e[0],1):delete t[e[0]],!0):(t[e[0]]=i,!0)},s.flatten=async function(t){var e,i,s,r,a,n;if(null==t&&(t=this.params),a={},e=async function(t,i){var s,r,n,l,o;for(s in l=[],t)n=i?i+"."+s:s,"string"==typeof(o=t[s])?l.push(a[n]=o):Array.isArray(o)?"object"==typeof o[0]?l.push(await async function(){var t;for(r in t=[],o)t.push(await e(o[r],n+"."+r));return t}()):l.push(a[n]=o.join(", ")):l.push(await e(o,n));return l},Array.isArray(t)){for(n=[],s=0,r=data.length;s<r;s++)i=data[s],a={},n.push(await e(i));return n}return await e(t),a},s.keys=function(t){var e,i;try{null==t&&(t=this.params)}catch(t){}for(e in i=[],null!=t?t:{})null!=t[e]&&u.call(i,e)<0&&i.push(e);return i},s.scrape=async function(t,e){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,_,v,b,w,x,k,S,O,A,j,I,C,D;if(null==t&&(t=null!=(S=null!=(O=this.params.scrape)?O:this.params.content)?S:this.params.url),null==e&&(e=this.params.doi),f={doi:e},"string"==typeof t&&t.startsWith("http")&&(f.doi||(D=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(t)))&&D.length>1&&9<D[1].length&&D[1].length<45&&-1!==D[1].indexOf("/")&&0===D[1].indexOf("10.")&&(f.doi=D[1]),t=await this.puppet(t)),"string"!=typeof t)return{};if(0!==t.indexOf("<")&&t.length>6e3?t=t.substring(0,6e3):t.length>5e4&&(t=t.substring(0,5e4)),!f.doi)try{-1!==(i=t.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(t){}if(!f.doi)try{null==i&&(i=t.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(t){}if(!f.doi)try{for(s=0,A=t.split(" "),a=0,o=A.length;a<o;a++)if(C=A[a],(s+=1)<600&&(-1!==(C=C.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(C=C.split("doi.org")[1]),0===C.indexOf("/")&&(C=C.replace("/","")),0===(C=C.trim()).indexOf("10.")&&-1!==C.indexOf("/"))){f.doi=C;break}}catch(t){}if(!f.doi)try{for(j=(r=await this.extract({content:t,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=j.length;l<u;l++)b=j[l],!f.doi&&9<r.matches[b].result[1].length&&r.matches[b].result[1].length<45&&(f.doi=r.matches[b].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(t){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=t.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(t){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.extract({content:t,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,c=m.length;w<c;w++)(v=m[w]).length>2&&(f.year=v)}catch(t){}if(!f.keywords)try{-1!==(n=(await this.extract({content:t,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(n=n.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=n.split(";")):(n=n.replace(/, /g,",").replace(/ ,/g,","),f.keywords=n.split(","))}catch(t){}if(!f.email){g=[];try{for(I=(await this.extract({content:t,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=I.length;x<h;x++)(y=I[x].result[1].replace("mailto:","")).endsWith(".")&&(y=y.substring(0,y.length-1)),-1===g.indexOf(y)&&g.push(y)}catch(t){}for(g.sort((function(t,e){return e.length-t.length})),_="",k=0,d=g.length;k<d;k++)p=g[k],null==f.email&&(f.email=[]),-1===_.indexOf(p)&&f.email.push(p),_+=p}return f},s.sleep=function(t){try{null==t&&(t=this.params.ms)}catch(t){}return new Promise(e=>setTimeout(e,null!=t?t:1e3))},s.sleep._auth="root";u=[].indexOf;s.template=async function(t,e){var i,s,r,a,n,l,o,c,h,d,p,f,m,g,y,_,v,b,w;if(null==t&&(t=null!=(m=null!=(g=this.params.content)?g:this.params.template)?m:this.body),null==e&&(e=this.params),(this.params.url||t.startsWith("http"))&&(t=await this.fetch(null!=(y=this.params.url)?y:t)),-1===t.indexOf(" ")&&-1!==t.indexOf(".")&&t.length<100)try{s=await this.templates(t),t=s.content}catch(t){}if(v={},(i=function(e,s=""){var r,a,n,l;for(r in n=[],e)a=s?s+"."+r:r,"object"!=typeof e[r]||Array.isArray(e[r])?-1!==t.toLowerCase().indexOf("{{"+a+"}}")?(l=new RegExp("{{"+a+"}}","gi"),n.push(t=t.replace(l,Array.isArray(e[r])?e[r].join(", "):"string"==typeof e[r]?e[r]:!0===e[r]?"Yes":!1===e[r]?"No":""))):n.push(void 0):n.push(i(e[r],s+(""===s?"":".")+r));return n})(e),c=new RegExp("{{.*?}}","gi"),-1!==t.indexOf("{{")){for(w=["subject","from","to","cc","bcc"],r=0,d=(_=t.toLowerCase().split("{{")).length;r<d;r++)f=_[r].split("{{")[0].split("}}")[0].split(" ")[0],u.call(w,f)<0&&w.push(f);for(a=0,p=w.length;a<p;a++)n=w[a],(l=-1!==t.toLowerCase().indexOf("{{"+n)?n:void 0)&&(o=-1!==t.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(b=t.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(b=b.replace(c,"")),(b=b.split("}}")[0].trim())&&(v[l]=b),h=new RegExp("{{"+o+".*?}}","gi"),t=t.replace(h,""))}return-1!==t.indexOf("{{")&&(t=t.replace(c,"")),v.content=t,v},s.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},s.levenshtein=function(t,e,i){var s,r,a,n,l,o,u,c,h,d,p,f,m;for(null==t&&(t=null!=this&&null!=(d=this.params)?d.a:void 0),null==e&&(e=null!=this&&null!=(p=this.params)?p.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(t=t.toLowerCase(),e=e.toLowerCase()),o=function(t,e,i){return t<=e&&t<=i?t:e<=t&&e<=i?e:i},(l=t.length)<(u=e.length)&&(s=t,t=e,e=s,c=l,l=u,u=c),h=[[]],s=0;s<u+1;)h[0][s]=s,s++;for(a=1;a<l+1;){for(h[a]=[a],n=1;n<u+1;)r=t.charAt(a-1)===e.charAt(n-1)?0:1,h[a][n]=o(h[a-1][n]+1,h[a][n-1]+1,h[a-1][n-1]+r),n++;a++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:l,b:u}}},s.extract=async function(t){var e,i,s,r,a,n,l,o,u,c,h;if(null==t&&(t=this.copy(this.params)),t.url&&!t.content&&(-1!==t.url.indexOf(".pdf")||-1!==t.url.indexOf("/pdf")?null==t.convert&&(t.convert="pdf"):t.content=await this.puppet(t.url)),t.convert)try{h=await this.convert[t.convert+"2txt"](null!=(o=t.url)?o:t.content)}catch(t){}if(null==h&&(h=t.content),null==t.matchers&&(t.matchers=[t.match]),null!=t.start&&(l=h.split(t.start),h=l.length>1?l[1]:l[0]),null!=t.end&&(h=h.split(t.end)[0]),t.lowercase&&(h=h.toLowerCase()),t.ascii&&(h=h.replace(/[^a-z0-9]/g,"")),!1===t.spaces&&(h=h.replace(/ /g,"")),c={length:h.length,matched:0,matches:[],matchers:t.matchers,text:h},h&&"number"!=typeof h)for(e=0,s=(u="string"==typeof t.matchers?t.matchers.split(","):t.matchers).length;e<s;e++){"string"==typeof(a=u[e])?(n="",0===a.indexOf("/")?(i=a.lastIndexOf("/"))+1!==a.length&&(n=a.substring(i+1),a=a.substring(1,i)):a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):n="",t.lowercase&&(n+="i");try{(r=new RegExp(a,n).exec(h))&&(c.matched+=1,c.matches.push({matched:a.toString(),result:r}))}catch(t){}}return c},s.decode=async function(t){var e,i,s,r,a,n,l,o,u,c;for(null==t&&(t=null!=(n=null!=(l=null!=(o=this.params.decode)?o:this.params.content)?l:this.params.text)?n:this.body),e=function(t){var e,i;return i=/&(nbsp|amp|quot|lt|gt);/g,e={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},t.replace(i,(function(t,i){return e[i]})).replace(/&#(\d+);/gi,(function(t,e){var i;return i=parseInt(e,10),String.fromCharCode(i)}))},c=(c=await e(t)).replace(/\n/g," "),s=0,r=(u=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;s<r;s++)i=u[s],a=new RegExp(i.bad,"g"),c=c.replace(a,i.good);return-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),c},s.uid=function(t){var e,i,s,r,a,n,l,u,c,h,d;return null==t&&(t="uid"===this.fn&&null!=(e=null!=(i=null!=(s=null!=(r=null!=this&&null!=(a=this.params)?a.len:void 0)?r:null!=this&&null!=(n=this.params)?n.length:void 0)?s:null!=this&&null!=(l=this.params)?l.size:void 0)?i:null!=this&&null!=(u=this.params)?u.uid:void 0)?e:21),"string"==typeof t&&(d=parseInt(t),t=isNaN(d)?void 0:d),Object(o.a)(null!=(c=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",t)()},s.uid._cache=!1,r.built="Fri Feb 25 2022 07:49:52 GMT+0000",s.testcron={_bg:!0},s.convert.doc2txt={_bg:!0},s.convert.docx2txt={_bg:!0},s.convert.pdf2txt={_bg:!0},s.puppet={_bg:!0},s.puppet._auth="system",s.puppet._hide=!0}.call(this,i(0),i(3).Buffer)},function(t,e,i){"use strict";(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var s=i(4),r=i(5),a=i(6);function n(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(t,e){if(n()<e)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=o.prototype:(null===t&&(t=new o(e)),t.length=e),t}function o(t,e,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(t,e,i);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return h(this,t)}return u(this,t,e,i)}function u(t,e,i,s){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,i,s){if(e.byteLength,i<0||e.byteLength<i)throw new RangeError("'offset' is out of bounds");if(e.byteLength<i+(s||0))throw new RangeError("'length' is out of bounds");e=void 0===i&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,i):new Uint8Array(e,i,s);o.TYPED_ARRAY_SUPPORT?(t=e).__proto__=o.prototype:t=d(t,e);return t}(t,e,i,s):"string"==typeof e?function(t,e,i){"string"==typeof i&&""!==i||(i="utf8");if(!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var s=0|f(e,i),r=(t=l(t,s)).write(e,i);r!==s&&(t=t.slice(0,r));return t}(t,e,i):function(t,e){if(o.isBuffer(e)){var i=0|p(e.length);return 0===(t=l(t,i)).length||e.copy(t,0,0,i),t}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||(s=e.length)!=s?l(t,0):d(t,e);if("Buffer"===e.type&&a(e.data))return d(t,e.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function c(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function h(t,e){if(c(e),t=l(t,e<0?0:0|p(e)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<e;++i)t[i]=0;return t}function d(t,e){var i=e.length<0?0:0|p(e.length);t=l(t,i);for(var s=0;s<i;s+=1)t[s]=255&e[s];return t}function p(t){if(t>=n())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n().toString(16)+" bytes");return 0|t}function f(t,e){if(o.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var i=t.length;if(0===i)return 0;for(var s=!1;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return W(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return z(t).length;default:if(s)return W(t).length;e=(""+e).toLowerCase(),s=!0}}function m(t,e,i){var s=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return C(this,e,i);case"utf8":case"utf-8":return A(this,e,i);case"ascii":return j(this,e,i);case"latin1":case"binary":return I(this,e,i);case"base64":return O(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return D(this,e,i);default:if(s)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),s=!0}}function g(t,e,i){var s=t[e];t[e]=t[i],t[i]=s}function y(t,e,i,s,r){if(0===t.length)return-1;if("string"==typeof i?(s=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=r?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(r)return-1;i=t.length-1}else if(i<0){if(!r)return-1;i=0}if("string"==typeof e&&(e=o.from(e,s)),o.isBuffer(e))return 0===e.length?-1:_(t,e,i,s,r);if("number"==typeof e)return e&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):_(t,[e],i,s,r);throw new TypeError("val must be string, number or Buffer")}function _(t,e,i,s,r){var a,n=1,l=t.length,o=e.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(t.length<2||e.length<2)return-1;n=2,l/=2,o/=2,i/=2}function u(t,e){return 1===n?t[e]:t.readUInt16BE(e*n)}if(r){var c=-1;for(a=i;a<l;a++)if(u(t,a)===u(e,-1===c?0:a-c)){if(-1===c&&(c=a),a-c+1===o)return c*n}else-1!==c&&(a-=a-c),c=-1}else for(i+o>l&&(i=l-o),a=i;a>=0;a--){for(var h=!0,d=0;d<o;d++)if(u(t,a+d)!==u(e,d)){h=!1;break}if(h)return a}return-1}function v(t,e,i,s){i=Number(i)||0;var r=t.length-i;s?(s=Number(s))>r&&(s=r):s=r;var a=e.length;if(a%2!=0)throw new TypeError("Invalid hex string");s>a/2&&(s=a/2);for(var n=0;n<s;++n){var l=parseInt(e.substr(2*n,2),16);if(isNaN(l))return n;t[i+n]=l}return n}function b(t,e,i,s){return J(W(e,t.length-i),t,i,s)}function w(t,e,i,s){return J(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,s)}function x(t,e,i,s){return w(t,e,i,s)}function k(t,e,i,s){return J(z(e),t,i,s)}function S(t,e,i,s){return J(function(t,e){for(var i,s,r,a=[],n=0;n<t.length&&!((e-=2)<0);++n)i=t.charCodeAt(n),s=i>>8,r=i%256,a.push(r),a.push(s);return a}(e,t.length-i),t,i,s)}function O(t,e,i){return 0===e&&i===t.length?s.fromByteArray(t):s.fromByteArray(t.slice(e,i))}function A(t,e,i){i=Math.min(t.length,i);for(var s=[],r=e;r<i;){var a,n,l,o,u=t[r],c=null,h=u>239?4:u>223?3:u>191?2:1;if(r+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(a=t[r+1]))&&(o=(31&u)<<6|63&a)>127&&(c=o);break;case 3:a=t[r+1],n=t[r+2],128==(192&a)&&128==(192&n)&&(o=(15&u)<<12|(63&a)<<6|63&n)>2047&&(o<55296||o>57343)&&(c=o);break;case 4:a=t[r+1],n=t[r+2],l=t[r+3],128==(192&a)&&128==(192&n)&&128==(192&l)&&(o=(15&u)<<18|(63&a)<<12|(63&n)<<6|63&l)>65535&&o<1114112&&(c=o)}null===c?(c=65533,h=1):c>65535&&(c-=65536,s.push(c>>>10&1023|55296),c=56320|1023&c),s.push(c),r+=h}return function(t){var e=t.length;if(e<=4096)return String.fromCharCode.apply(String,t);var i="",s=0;for(;s<e;)i+=String.fromCharCode.apply(String,t.slice(s,s+=4096));return i}(s)}e.Buffer=o,e.SlowBuffer=function(t){+t!=t&&(t=0);return o.alloc(+t)},e.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=n(),o.poolSize=8192,o._augment=function(t){return t.__proto__=o.prototype,t},o.from=function(t,e,i){return u(null,t,e,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(t,e,i){return function(t,e,i,s){return c(e),e<=0?l(t,e):void 0!==i?"string"==typeof s?l(t,e).fill(i,s):l(t,e).fill(i):l(t,e)}(null,t,e,i)},o.allocUnsafe=function(t){return h(null,t)},o.allocUnsafeSlow=function(t){return h(null,t)},o.isBuffer=function(t){return!(null==t||!t._isBuffer)},o.compare=function(t,e){if(!o.isBuffer(t)||!o.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var i=t.length,s=e.length,r=0,a=Math.min(i,s);r<a;++r)if(t[r]!==e[r]){i=t[r],s=e[r];break}return i<s?-1:s<i?1:0},o.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(t,e){if(!a(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return o.alloc(0);var i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;var s=o.allocUnsafe(e),r=0;for(i=0;i<t.length;++i){var n=t[i];if(!o.isBuffer(n))throw new TypeError('"list" argument must be an Array of Buffers');n.copy(s,r),r+=n.length}return s},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)g(this,e,e+1);return this},o.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)g(this,e,e+3),g(this,e+1,e+2);return this},o.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)g(this,e,e+7),g(this,e+1,e+6),g(this,e+2,e+5),g(this,e+3,e+4);return this},o.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?A(this,0,t):m.apply(this,arguments)},o.prototype.equals=function(t){if(!o.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===o.compare(this,t)},o.prototype.inspect=function(){var t="",i=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(t+=" ... ")),"<Buffer "+t+">"},o.prototype.compare=function(t,e,i,s,r){if(!o.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===s&&(s=0),void 0===r&&(r=this.length),e<0||i>t.length||s<0||r>this.length)throw new RangeError("out of range index");if(s>=r&&e>=i)return 0;if(s>=r)return-1;if(e>=i)return 1;if(this===t)return 0;for(var a=(r>>>=0)-(s>>>=0),n=(i>>>=0)-(e>>>=0),l=Math.min(a,n),u=this.slice(s,r),c=t.slice(e,i),h=0;h<l;++h)if(u[h]!==c[h]){a=u[h],n=c[h];break}return a<n?-1:n<a?1:0},o.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},o.prototype.indexOf=function(t,e,i){return y(this,t,e,i,!0)},o.prototype.lastIndexOf=function(t,e,i){return y(this,t,e,i,!1)},o.prototype.write=function(t,e,i,s){if(void 0===e)s="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)s=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(i)?(i|=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}var r=this.length-e;if((void 0===i||i>r)&&(i=r),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var a=!1;;)switch(s){case"hex":return v(this,t,e,i);case"utf8":case"utf-8":return b(this,t,e,i);case"ascii":return w(this,t,e,i);case"latin1":case"binary":return x(this,t,e,i);case"base64":return k(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,t,e,i);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function j(t,e,i){var s="";i=Math.min(t.length,i);for(var r=e;r<i;++r)s+=String.fromCharCode(127&t[r]);return s}function I(t,e,i){var s="";i=Math.min(t.length,i);for(var r=e;r<i;++r)s+=String.fromCharCode(t[r]);return s}function C(t,e,i){var s=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>s)&&(i=s);for(var r="",a=e;a<i;++a)r+=M(t[a]);return r}function D(t,e,i){for(var s=t.slice(e,i),r="",a=0;a<s.length;a+=2)r+=String.fromCharCode(s[a]+256*s[a+1]);return r}function N(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function L(t,e,i,s,r,a){if(!o.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>r||e<a)throw new RangeError('"value" argument is out of bounds');if(i+s>t.length)throw new RangeError("Index out of range")}function R(t,e,i,s){e<0&&(e=65535+e+1);for(var r=0,a=Math.min(t.length-i,2);r<a;++r)t[i+r]=(e&255<<8*(s?r:1-r))>>>8*(s?r:1-r)}function P(t,e,i,s){e<0&&(e=4294967295+e+1);for(var r=0,a=Math.min(t.length-i,4);r<a;++r)t[i+r]=e>>>8*(s?r:3-r)&255}function E(t,e,i,s,r,a){if(i+s>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function T(t,e,i,s,a){return a||E(t,0,i,4),r.write(t,e,i,s,23,4),i+4}function q(t,e,i,s,a){return a||E(t,0,i,8),r.write(t,e,i,s,52,8),i+8}o.prototype.slice=function(t,e){var i,s=this.length;if((t=~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),(e=void 0===e?s:~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),e<t&&(e=t),o.TYPED_ARRAY_SUPPORT)(i=this.subarray(t,e)).__proto__=o.prototype;else{var r=e-t;i=new o(r,void 0);for(var a=0;a<r;++a)i[a]=this[a+t]}return i},o.prototype.readUIntLE=function(t,e,i){t|=0,e|=0,i||N(t,e,this.length);for(var s=this[t],r=1,a=0;++a<e&&(r*=256);)s+=this[t+a]*r;return s},o.prototype.readUIntBE=function(t,e,i){t|=0,e|=0,i||N(t,e,this.length);for(var s=this[t+--e],r=1;e>0&&(r*=256);)s+=this[t+--e]*r;return s},o.prototype.readUInt8=function(t,e){return e||N(t,1,this.length),this[t]},o.prototype.readUInt16LE=function(t,e){return e||N(t,2,this.length),this[t]|this[t+1]<<8},o.prototype.readUInt16BE=function(t,e){return e||N(t,2,this.length),this[t]<<8|this[t+1]},o.prototype.readUInt32LE=function(t,e){return e||N(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},o.prototype.readUInt32BE=function(t,e){return e||N(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},o.prototype.readIntLE=function(t,e,i){t|=0,e|=0,i||N(t,e,this.length);for(var s=this[t],r=1,a=0;++a<e&&(r*=256);)s+=this[t+a]*r;return s>=(r*=128)&&(s-=Math.pow(2,8*e)),s},o.prototype.readIntBE=function(t,e,i){t|=0,e|=0,i||N(t,e,this.length);for(var s=e,r=1,a=this[t+--s];s>0&&(r*=256);)a+=this[t+--s]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*e)),a},o.prototype.readInt8=function(t,e){return e||N(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},o.prototype.readInt16LE=function(t,e){e||N(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(t,e){e||N(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(t,e){return e||N(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},o.prototype.readInt32BE=function(t,e){return e||N(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},o.prototype.readFloatLE=function(t,e){return e||N(t,4,this.length),r.read(this,t,!0,23,4)},o.prototype.readFloatBE=function(t,e){return e||N(t,4,this.length),r.read(this,t,!1,23,4)},o.prototype.readDoubleLE=function(t,e){return e||N(t,8,this.length),r.read(this,t,!0,52,8)},o.prototype.readDoubleBE=function(t,e){return e||N(t,8,this.length),r.read(this,t,!1,52,8)},o.prototype.writeUIntLE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||L(this,t,e,i,Math.pow(2,8*i)-1,0);var r=1,a=0;for(this[e]=255&t;++a<i&&(r*=256);)this[e+a]=t/r&255;return e+i},o.prototype.writeUIntBE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||L(this,t,e,i,Math.pow(2,8*i)-1,0);var r=i-1,a=1;for(this[e+r]=255&t;--r>=0&&(a*=256);)this[e+r]=t/a&255;return e+i},o.prototype.writeUInt8=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,1,255,0),o.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},o.prototype.writeUInt16LE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):R(this,t,e,!0),e+2},o.prototype.writeUInt16BE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):R(this,t,e,!1),e+2},o.prototype.writeUInt32LE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):P(this,t,e,!0),e+4},o.prototype.writeUInt32BE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):P(this,t,e,!1),e+4},o.prototype.writeIntLE=function(t,e,i,s){if(t=+t,e|=0,!s){var r=Math.pow(2,8*i-1);L(this,t,e,i,r-1,-r)}var a=0,n=1,l=0;for(this[e]=255&t;++a<i&&(n*=256);)t<0&&0===l&&0!==this[e+a-1]&&(l=1),this[e+a]=(t/n>>0)-l&255;return e+i},o.prototype.writeIntBE=function(t,e,i,s){if(t=+t,e|=0,!s){var r=Math.pow(2,8*i-1);L(this,t,e,i,r-1,-r)}var a=i-1,n=1,l=0;for(this[e+a]=255&t;--a>=0&&(n*=256);)t<0&&0===l&&0!==this[e+a+1]&&(l=1),this[e+a]=(t/n>>0)-l&255;return e+i},o.prototype.writeInt8=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,1,127,-128),o.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},o.prototype.writeInt16LE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):R(this,t,e,!0),e+2},o.prototype.writeInt16BE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):R(this,t,e,!1),e+2},o.prototype.writeInt32LE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):P(this,t,e,!0),e+4},o.prototype.writeInt32BE=function(t,e,i){return t=+t,e|=0,i||L(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):P(this,t,e,!1),e+4},o.prototype.writeFloatLE=function(t,e,i){return T(this,t,e,!0,i)},o.prototype.writeFloatBE=function(t,e,i){return T(this,t,e,!1,i)},o.prototype.writeDoubleLE=function(t,e,i){return q(this,t,e,!0,i)},o.prototype.writeDoubleBE=function(t,e,i){return q(this,t,e,!1,i)},o.prototype.copy=function(t,e,i,s){if(i||(i=0),s||0===s||(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-i&&(s=t.length-e+i);var r,a=s-i;if(this===t&&i<e&&e<s)for(r=a-1;r>=0;--r)t[r+e]=this[r+i];else if(a<1e3||!o.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)t[r+e]=this[r+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+a),e);return a},o.prototype.fill=function(t,e,i,s){if("string"==typeof t){if("string"==typeof e?(s=e,e=0,i=this.length):"string"==typeof i&&(s=i,i=this.length),1===t.length){var r=t.charCodeAt(0);r<256&&(t=r)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!o.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;var a;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(a=e;a<i;++a)this[a]=t;else{var n=o.isBuffer(t)?t:W(new o(t,s).toString()),l=n.length;for(a=0;a<i-e;++a)this[a+e]=n[a%l]}return this};var U=/[^+\/0-9A-Za-z-_]/g;function M(t){return t<16?"0"+t.toString(16):t.toString(16)}function W(t,e){var i;e=e||1/0;for(var s=t.length,r=null,a=[],n=0;n<s;++n){if((i=t.charCodeAt(n))>55295&&i<57344){if(!r){if(i>56319){(e-=3)>-1&&a.push(239,191,189);continue}if(n+1===s){(e-=3)>-1&&a.push(239,191,189);continue}r=i;continue}if(i<56320){(e-=3)>-1&&a.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&(e-=3)>-1&&a.push(239,191,189);if(r=null,i<128){if((e-=1)<0)break;a.push(i)}else if(i<2048){if((e-=2)<0)break;a.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;a.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;a.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return a}function z(t){return s.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(U,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function J(t,e,i,s){for(var r=0;r<s&&!(r+i>=e.length||r>=t.length);++r)e[r+i]=t[r];return r}}).call(this,i(0))},function(t,e,i){"use strict";e.byteLength=function(t){var e=u(t),i=e[0],s=e[1];return 3*(i+s)/4-s},e.toByteArray=function(t){var e,i,s=u(t),n=s[0],l=s[1],o=new a(function(t,e,i){return 3*(e+i)/4-i}(0,n,l)),c=0,h=l>0?n-4:n;for(i=0;i<h;i+=4)e=r[t.charCodeAt(i)]<<18|r[t.charCodeAt(i+1)]<<12|r[t.charCodeAt(i+2)]<<6|r[t.charCodeAt(i+3)],o[c++]=e>>16&255,o[c++]=e>>8&255,o[c++]=255&e;2===l&&(e=r[t.charCodeAt(i)]<<2|r[t.charCodeAt(i+1)]>>4,o[c++]=255&e);1===l&&(e=r[t.charCodeAt(i)]<<10|r[t.charCodeAt(i+1)]<<4|r[t.charCodeAt(i+2)]>>2,o[c++]=e>>8&255,o[c++]=255&e);return o},e.fromByteArray=function(t){for(var e,i=t.length,r=i%3,a=[],n=0,l=i-r;n<l;n+=16383)a.push(c(t,n,n+16383>l?l:n+16383));1===r?(e=t[i-1],a.push(s[e>>2]+s[e<<4&63]+"==")):2===r&&(e=(t[i-2]<<8)+t[i-1],a.push(s[e>>10]+s[e>>4&63]+s[e<<2&63]+"="));return a.join("")};for(var s=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,o=n.length;l<o;++l)s[l]=n[l],r[n.charCodeAt(l)]=l;function u(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function c(t,e,i){for(var r,a,n=[],l=e;l<i;l+=3)r=(t[l]<<16&16711680)+(t[l+1]<<8&65280)+(255&t[l+2]),n.push(s[(a=r)>>18&63]+s[a>>12&63]+s[a>>6&63]+s[63&a]);return n.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(t,e){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
e.read=function(t,e,i,s,r){var a,n,l=8*r-s-1,o=(1<<l)-1,u=o>>1,c=-7,h=i?r-1:0,d=i?-1:1,p=t[e+h];for(h+=d,a=p&(1<<-c)-1,p>>=-c,c+=l;c>0;a=256*a+t[e+h],h+=d,c-=8);for(n=a&(1<<-c)-1,a>>=-c,c+=s;c>0;n=256*n+t[e+h],h+=d,c-=8);if(0===a)a=1-u;else{if(a===o)return n?NaN:1/0*(p?-1:1);n+=Math.pow(2,s),a-=u}return(p?-1:1)*n*Math.pow(2,a-s)},e.write=function(t,e,i,s,r,a){var n,l,o,u=8*a-r-1,c=(1<<u)-1,h=c>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:a-1,f=s?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(l=isNaN(e)?1:0,n=c):(n=Math.floor(Math.log(e)/Math.LN2),e*(o=Math.pow(2,-n))<1&&(n--,o*=2),(e+=n+h>=1?d/o:d*Math.pow(2,1-h))*o>=2&&(n++,o/=2),n+h>=c?(l=0,n=c):n+h>=1?(l=(e*o-1)*Math.pow(2,r),n+=h):(l=e*Math.pow(2,h-1)*Math.pow(2,r),n=0));r>=8;t[i+p]=255&l,p+=f,l/=256,r-=8);for(n=n<<r|l,u+=r;u>0;t[i+p]=255&n,p+=f,n/=256,u-=8);t[i+p-f]|=128*m}},function(t,e){var i={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==i.call(t)}}]);