/*! For license information please see worker.min.js.LICENSE.txt */
(()=>{var e={282:(e,t,i)=>{"use strict";var r=i(155),s=i(108);function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}var a,l,o=i(136).codes,u=o.ERR_AMBIGUOUS_ARGUMENT,c=o.ERR_INVALID_ARG_TYPE,h=o.ERR_INVALID_ARG_VALUE,p=o.ERR_INVALID_RETURN_VALUE,d=o.ERR_MISSING_ARGS,f=i(961),y=i(539).inspect,m=i(539).types,g=m.isPromise,v=m.isRegExp,b=Object.assign?Object.assign:i(91).assign,w=Object.is?Object.is:i(609);function _(){var e=i(158);a=e.isDeepEqual,l=e.isDeepStrictEqual}new Map;var x=!1,O=e.exports=A,k={};function S(e){if(e.message instanceof Error)throw e.message;throw new f(e)}function j(e,t,i,r){if(!i){var s=!1;if(0===t)s=!0,r="No value argument passed to `assert.ok()`";else if(r instanceof Error)throw r;var n=new f({actual:i,expected:!0,message:r,operator:"==",stackStartFn:e});throw n.generatedMessage=s,n}}function A(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];j.apply(void 0,[A,t.length].concat(t))}O.fail=function e(t,i,n,a,l){var o,u=arguments.length;if(0===u?o="Failed":1===u?(n=t,t=void 0):(!1===x&&(x=!0,(r.emitWarning?r.emitWarning:s.warn.bind(s))("assert.fail() with more than one argument is deprecated. Please use assert.strictEqual() instead or only pass a message.","DeprecationWarning","DEP0094")),2===u&&(a="!=")),n instanceof Error)throw n;var c={actual:t,expected:i,operator:void 0===a?"fail":a,stackStartFn:l||e};void 0!==n&&(c.message=n);var h=new f(c);throw o&&(h.message=o,h.generatedMessage=!0),h},O.AssertionError=f,O.ok=A,O.equal=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");t!=i&&S({actual:t,expected:i,message:r,operator:"==",stackStartFn:e})},O.notEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");t==i&&S({actual:t,expected:i,message:r,operator:"!=",stackStartFn:e})},O.deepEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),a(t,i)||S({actual:t,expected:i,message:r,operator:"deepEqual",stackStartFn:e})},O.notDeepEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),a(t,i)&&S({actual:t,expected:i,message:r,operator:"notDeepEqual",stackStartFn:e})},O.deepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),l(t,i)||S({actual:t,expected:i,message:r,operator:"deepStrictEqual",stackStartFn:e})},O.notDeepStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");void 0===a&&_(),l(t,i)&&S({actual:t,expected:i,message:r,operator:"notDeepStrictEqual",stackStartFn:e})},O.strictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");w(t,i)||S({actual:t,expected:i,message:r,operator:"strictEqual",stackStartFn:e})},O.notStrictEqual=function e(t,i,r){if(arguments.length<2)throw new d("actual","expected");w(t,i)&&S({actual:t,expected:i,message:r,operator:"notStrictEqual",stackStartFn:e})};var I=function e(t,i,r){var s=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i.forEach((function(e){e in t&&(void 0!==r&&"string"==typeof r[e]&&v(t[e])&&t[e].test(r[e])?s[e]=r[e]:s[e]=t[e])}))};function E(e,t,i,r){if("function"!=typeof t){if(v(t))return t.test(e);if(2===arguments.length)throw new c("expected",["Function","RegExp"],t);if("object"!==n(e)||null===e){var s=new f({actual:e,expected:t,message:i,operator:"deepStrictEqual",stackStartFn:r});throw s.operator=r.name,s}var o=Object.keys(t);if(t instanceof Error)o.push("name","message");else if(0===o.length)throw new h("error",t,"may not be an empty object");return void 0===a&&_(),o.forEach((function(s){"string"==typeof e[s]&&v(t[s])&&t[s].test(e[s])||function(e,t,i,r,s,n){if(!(i in e)||!l(e[i],t[i])){if(!r){var a=new I(e,s),o=new I(t,s,e),u=new f({actual:a,expected:o,operator:"deepStrictEqual",stackStartFn:n});throw u.actual=e,u.expected=t,u.operator=n.name,u}S({actual:e,expected:t,message:r,operator:n.name,stackStartFn:n})}}(e,t,s,i,o,r)})),!0}return void 0!==t.prototype&&e instanceof t||!Error.isPrototypeOf(t)&&!0===t.call({},e)}function D(e){if("function"!=typeof e)throw new c("fn","Function",e);try{e()}catch(e){return e}return k}function C(e){return g(e)||null!==e&&"object"===n(e)&&"function"==typeof e.then&&"function"==typeof e.catch}function N(e){return Promise.resolve().then((function(){var t;if("function"==typeof e){if(!C(t=e()))throw new p("instance of Promise","promiseFn",t)}else{if(!C(e))throw new c("promiseFn",["Function","Promise"],e);t=e}return Promise.resolve().then((function(){return t})).then((function(){return k})).catch((function(e){return e}))}))}function L(e,t,i,r){if("string"==typeof i){if(4===arguments.length)throw new c("error",["Object","Error","Function","RegExp"],i);if("object"===n(t)&&null!==t){if(t.message===i)throw new u("error/message",'The error message "'.concat(t.message,'" is identical to the message.'))}else if(t===i)throw new u("error/message",'The error "'.concat(t,'" is identical to the message.'));r=i,i=void 0}else if(null!=i&&"object"!==n(i)&&"function"!=typeof i)throw new c("error",["Object","Error","Function","RegExp"],i);if(t===k){var s="";i&&i.name&&(s+=" (".concat(i.name,")")),s+=r?": ".concat(r):".";var a="rejects"===e.name?"rejection":"exception";S({actual:void 0,expected:i,operator:e.name,message:"Missing expected ".concat(a).concat(s),stackStartFn:e})}if(i&&!E(t,i,r,e))throw t}function P(e,t,i,r){if(t!==k){if("string"==typeof i&&(r=i,i=void 0),!i||E(t,i)){var s=r?": ".concat(r):".",n="doesNotReject"===e.name?"rejection":"exception";S({actual:t,expected:i,operator:e.name,message:"Got unwanted ".concat(n).concat(s,"\n")+'Actual message: "'.concat(t&&t.message,'"'),stackStartFn:e})}throw t}}function q(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];j.apply(void 0,[q,t.length].concat(t))}O.throws=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];L.apply(void 0,[e,D(t)].concat(r))},O.rejects=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return L.apply(void 0,[e,t].concat(r))}))},O.doesNotThrow=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];P.apply(void 0,[e,D(t)].concat(r))},O.doesNotReject=function e(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return N(t).then((function(t){return P.apply(void 0,[e,t].concat(r))}))},O.ifError=function e(t){if(null!=t){var i="ifError got unwanted exception: ";"object"===n(t)&&"string"==typeof t.message?0===t.message.length&&t.constructor?i+=t.constructor.name:i+=t.message:i+=y(t);var r=new f({actual:t,expected:null,operator:"ifError",message:i,stackStartFn:e}),s=t.stack;if("string"==typeof s){var a=s.split("\n");a.shift();for(var l=r.stack.split("\n"),o=0;o<a.length;o++){var u=l.indexOf(a[o]);if(-1!==u){l=l.slice(0,u);break}}r.stack="".concat(l.join("\n"),"\n").concat(a.join("\n"))}throw r}},O.strict=b(q,O,{equal:O.strictEqual,deepEqual:O.deepStrictEqual,notEqual:O.notStrictEqual,notDeepEqual:O.notDeepStrictEqual}),O.strict.strict=O.strict},961:(e,t,i)=>{"use strict";var r=i(155);function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t){return!t||"object"!==p(t)&&"function"!=typeof t?l(e):t}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return u(e,arguments,h(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},o(e)}function u(e,t,i){return u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,i){var r=[null];r.push.apply(r,t);var s=new(Function.bind.apply(e,r));return i&&c(s,i.prototype),s},u.apply(null,arguments)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function p(e){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p(e)}var d=i(539).inspect,f=i(136).codes.ERR_INVALID_ARG_TYPE;function y(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-t.length,i)===t}var m="",g="",v="",b="",w={deepStrictEqual:"Expected values to be strictly deep-equal:",strictEqual:"Expected values to be strictly equal:",strictEqualObject:'Expected "actual" to be reference-equal to "expected":',deepEqual:"Expected values to be loosely deep-equal:",equal:"Expected values to be loosely equal:",notDeepStrictEqual:'Expected "actual" not to be strictly deep-equal to:',notStrictEqual:'Expected "actual" to be strictly unequal to:',notStrictEqualObject:'Expected "actual" not to be reference-equal to "expected":',notDeepEqual:'Expected "actual" not to be loosely deep-equal to:',notEqual:'Expected "actual" to be loosely unequal to:',notIdentical:"Values identical but not reference-equal:"};function _(e){var t=Object.keys(e),i=Object.create(Object.getPrototypeOf(e));return t.forEach((function(t){i[t]=e[t]})),Object.defineProperty(i,"message",{value:e.message}),i}function x(e){return d(e,{compact:!1,customInspect:!1,depth:1e3,maxArrayLength:1/0,showHidden:!1,breakLength:1/0,showProxy:!1,sorted:!0,getters:!0})}var O=function(e){function t(e){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),"object"!==p(e)||null===e)throw new f("options","Object",e);var s=e.message,n=e.operator,o=e.stackStartFn,u=e.actual,c=e.expected,d=Error.stackTraceLimit;if(Error.stackTraceLimit=0,null!=s)i=a(this,h(t).call(this,String(s)));else if(r.stderr&&r.stderr.isTTY&&(r.stderr&&r.stderr.getColorDepth&&1!==r.stderr.getColorDepth()?(m="[34m",g="[32m",b="[39m",v="[31m"):(m="",g="",b="",v="")),"object"===p(u)&&null!==u&&"object"===p(c)&&null!==c&&"stack"in u&&u instanceof Error&&"stack"in c&&c instanceof Error&&(u=_(u),c=_(c)),"deepStrictEqual"===n||"strictEqual"===n)i=a(this,h(t).call(this,function(e,t,i){var s="",n="",a=0,l="",o=!1,u=x(e),c=u.split("\n"),h=x(t).split("\n"),d=0,f="";if("strictEqual"===i&&"object"===p(e)&&"object"===p(t)&&null!==e&&null!==t&&(i="strictEqualObject"),1===c.length&&1===h.length&&c[0]!==h[0]){var _=c[0].length+h[0].length;if(_<=10){if(!("object"===p(e)&&null!==e||"object"===p(t)&&null!==t||0===e&&0===t))return"".concat(w[i],"\n\n")+"".concat(c[0]," !== ").concat(h[0],"\n")}else if("strictEqualObject"!==i&&_<(r.stderr&&r.stderr.isTTY?r.stderr.columns:80)){for(;c[0][d]===h[0][d];)d++;d>2&&(f="\n  ".concat(function(e,t){if(t=Math.floor(t),0==e.length||0==t)return"";var i=e.length*t;for(t=Math.floor(Math.log(t)/Math.log(2));t;)e+=e,t--;return e+e.substring(0,i-e.length)}(" ",d),"^"),d=0)}}for(var O=c[c.length-1],k=h[h.length-1];O===k&&(d++<2?l="\n  ".concat(O).concat(l):s=O,c.pop(),h.pop(),0!==c.length&&0!==h.length);)O=c[c.length-1],k=h[h.length-1];var S=Math.max(c.length,h.length);if(0===S){var j=u.split("\n");if(j.length>30)for(j[26]="".concat(m,"...").concat(b);j.length>27;)j.pop();return"".concat(w.notIdentical,"\n\n").concat(j.join("\n"),"\n")}d>3&&(l="\n".concat(m,"...").concat(b).concat(l),o=!0),""!==s&&(l="\n  ".concat(s).concat(l),s="");var A=0,I=w[i]+"\n".concat(g,"+ actual").concat(b," ").concat(v,"- expected").concat(b),E=" ".concat(m,"...").concat(b," Lines skipped");for(d=0;d<S;d++){var D=d-a;if(c.length<d+1)D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(h[d-2]),A++),n+="\n  ".concat(h[d-1]),A++),a=d,s+="\n".concat(v,"-").concat(b," ").concat(h[d]),A++;else if(h.length<d+1)D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(b," ").concat(c[d]),A++;else{var C=h[d],N=c[d],L=N!==C&&(!y(N,",")||N.slice(0,-1)!==C);L&&y(C,",")&&C.slice(0,-1)===N&&(L=!1,N+=","),L?(D>1&&d>2&&(D>4?(n+="\n".concat(m,"...").concat(b),o=!0):D>3&&(n+="\n  ".concat(c[d-2]),A++),n+="\n  ".concat(c[d-1]),A++),a=d,n+="\n".concat(g,"+").concat(b," ").concat(N),s+="\n".concat(v,"-").concat(b," ").concat(C),A+=2):(n+=s,s="",1!==D&&0!==d||(n+="\n  ".concat(N),A++))}if(A>20&&d<S-2)return"".concat(I).concat(E,"\n").concat(n,"\n").concat(m,"...").concat(b).concat(s,"\n")+"".concat(m,"...").concat(b)}return"".concat(I).concat(o?E:"","\n").concat(n).concat(s).concat(l).concat(f)}(u,c,n)));else if("notDeepStrictEqual"===n||"notStrictEqual"===n){var O=w[n],k=x(u).split("\n");if("notStrictEqual"===n&&"object"===p(u)&&null!==u&&(O=w.notStrictEqualObject),k.length>30)for(k[26]="".concat(m,"...").concat(b);k.length>27;)k.pop();i=1===k.length?a(this,h(t).call(this,"".concat(O," ").concat(k[0]))):a(this,h(t).call(this,"".concat(O,"\n\n").concat(k.join("\n"),"\n")))}else{var S=x(u),j="",A=w[n];"notDeepEqual"===n||"notEqual"===n?(S="".concat(w[n],"\n\n").concat(S)).length>1024&&(S="".concat(S.slice(0,1021),"...")):(j="".concat(x(c)),S.length>512&&(S="".concat(S.slice(0,509),"...")),j.length>512&&(j="".concat(j.slice(0,509),"...")),"deepEqual"===n||"equal"===n?S="".concat(A,"\n\n").concat(S,"\n\nshould equal\n\n"):j=" ".concat(n," ").concat(j)),i=a(this,h(t).call(this,"".concat(S).concat(j)))}return Error.stackTraceLimit=d,i.generatedMessage=!s,Object.defineProperty(l(i),"name",{value:"AssertionError [ERR_ASSERTION]",enumerable:!1,writable:!0,configurable:!0}),i.code="ERR_ASSERTION",i.actual=u,i.expected=c,i.operator=n,Error.captureStackTrace&&Error.captureStackTrace(l(i),o),i.stack,i.name="AssertionError",a(i)}var i,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),i=t,o=[{key:"toString",value:function(){return"".concat(this.name," [").concat(this.code,"]: ").concat(this.message)}},{key:d.custom,value:function(e,t){return d(this,function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter((function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})))),r.forEach((function(t){s(e,t,i[t])}))}return e}({},t,{customInspect:!1,depth:0}))}}],o&&n(i.prototype,o),t}(o(Error));e.exports=O},136:(e,t,i)=>{"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function n(e,t){return n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,t)}var a,l,o={};function u(e,t,i){i||(i=Error);var a=function(i){function a(i,n,l){var o,u,c;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),u=this,c=s(a).call(this,function(e,i,r){return"string"==typeof t?t:t(e,i,r)}(i,n,l)),o=!c||"object"!==r(c)&&"function"!=typeof c?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(u):c,o.code=e,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(a,i),a}(i);o[e]=a}function c(e,t){if(Array.isArray(e)){var i=e.length;return e=e.map((function(e){return String(e)})),i>2?"one of ".concat(t," ").concat(e.slice(0,i-1).join(", "),", or ")+e[i-1]:2===i?"one of ".concat(t," ").concat(e[0]," or ").concat(e[1]):"of ".concat(t," ").concat(e[0])}return"of ".concat(t," ").concat(String(e))}u("ERR_AMBIGUOUS_ARGUMENT",'The "%s" argument is ambiguous. %s',TypeError),u("ERR_INVALID_ARG_TYPE",(function(e,t,s){var n,l,o,u,h;if(void 0===a&&(a=i(282)),a("string"==typeof e,"'name' must be a string"),"string"==typeof t&&(l="not ",t.substr(0,4)===l)?(n="must not be",t=t.replace(/^not /,"")):n="must be",function(e,t,i){return(void 0===i||i>e.length)&&(i=e.length),e.substring(i-9,i)===t}(e," argument"))o="The ".concat(e," ").concat(n," ").concat(c(t,"type"));else{var p=("number"!=typeof h&&(h=0),h+1>(u=e).length||-1===u.indexOf(".",h)?"argument":"property");o='The "'.concat(e,'" ').concat(p," ").concat(n," ").concat(c(t,"type"))}return o+". Received type ".concat(r(s))}),TypeError),u("ERR_INVALID_ARG_VALUE",(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"is invalid";void 0===l&&(l=i(539));var s=l.inspect(t);return s.length>128&&(s="".concat(s.slice(0,128),"...")),"The argument '".concat(e,"' ").concat(r,". Received ").concat(s)}),TypeError,RangeError),u("ERR_INVALID_RETURN_VALUE",(function(e,t,i){var s;return s=i&&i.constructor&&i.constructor.name?"instance of ".concat(i.constructor.name):"type ".concat(r(i)),"Expected ".concat(e,' to be returned from the "').concat(t,'"')+" function but got ".concat(s,".")}),TypeError),u("ERR_MISSING_ARGS",(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];void 0===a&&(a=i(282)),a(t.length>0,"At least one arg needs to be specified");var s="The ",n=t.length;switch(t=t.map((function(e){return'"'.concat(e,'"')})),n){case 1:s+="".concat(t[0]," argument");break;case 2:s+="".concat(t[0]," and ").concat(t[1]," arguments");break;default:s+=t.slice(0,n-1).join(", "),s+=", and ".concat(t[n-1]," arguments")}return"".concat(s," must be specified")}),TypeError),e.exports.codes=o},158:(e,t,i)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=[],r=!0,s=!1,n=void 0;try{for(var a,l=e[Symbol.iterator]();!(r=(a=l.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){s=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(s)throw n}}return i}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}var n=void 0!==/a/g.flags,a=function(e){var t=[];return e.forEach((function(e){return t.push(e)})),t},l=function(e){var t=[];return e.forEach((function(e,i){return t.push([i,e])})),t},o=Object.is?Object.is:i(609),u=Object.getOwnPropertySymbols?Object.getOwnPropertySymbols:function(){return[]},c=Number.isNaN?Number.isNaN:i(360);function h(e){return e.call.bind(e)}var p=h(Object.prototype.hasOwnProperty),d=h(Object.prototype.propertyIsEnumerable),f=h(Object.prototype.toString),y=i(539).types,m=y.isAnyArrayBuffer,g=y.isArrayBufferView,v=y.isDate,b=y.isMap,w=y.isRegExp,_=y.isSet,x=y.isNativeError,O=y.isBoxedPrimitive,k=y.isNumberObject,S=y.isStringObject,j=y.isBooleanObject,A=y.isBigIntObject,I=y.isSymbolObject,E=y.isFloat32Array,D=y.isFloat64Array;function C(e){if(0===e.length||e.length>10)return!0;for(var t=0;t<e.length;t++){var i=e.charCodeAt(t);if(i<48||i>57)return!0}return 10===e.length&&e>=Math.pow(2,32)}function N(e){return Object.keys(e).filter(C).concat(u(e).filter(Object.prototype.propertyIsEnumerable.bind(e)))}function L(e,t){if(e===t)return 0;for(var i=e.length,r=t.length,s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0}var P=0,q=1,T=2,R=3;function W(e,t,i,r){if(e===t)return 0!==e||!i||o(e,t);if(i){if("object"!==s(e))return"number"==typeof e&&c(e)&&c(t);if("object"!==s(t)||null===e||null===t)return!1;if(Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1}else{if(null===e||"object"!==s(e))return(null===t||"object"!==s(t))&&e==t;if(null===t||"object"!==s(t))return!1}var a,l,u,h,p=f(e);if(p!==f(t))return!1;if(Array.isArray(e)){if(e.length!==t.length)return!1;var d=N(e),y=N(t);return d.length===y.length&&M(e,t,i,r,q,d)}if("[object Object]"===p&&(!b(e)&&b(t)||!_(e)&&_(t)))return!1;if(v(e)){if(!v(t)||Date.prototype.getTime.call(e)!==Date.prototype.getTime.call(t))return!1}else if(w(e)){if(!w(t)||(u=e,h=t,!(n?u.source===h.source&&u.flags===h.flags:RegExp.prototype.toString.call(u)===RegExp.prototype.toString.call(h))))return!1}else if(x(e)||e instanceof Error){if(e.message!==t.message||e.name!==t.name)return!1}else{if(g(e)){if(i||!E(e)&&!D(e)){if(!function(e,t){return e.byteLength===t.byteLength&&0===L(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}(e,t))return!1}else if(!function(e,t){if(e.byteLength!==t.byteLength)return!1;for(var i=0;i<e.byteLength;i++)if(e[i]!==t[i])return!1;return!0}(e,t))return!1;var C=N(e),W=N(t);return C.length===W.length&&M(e,t,i,r,P,C)}if(_(e))return!(!_(t)||e.size!==t.size)&&M(e,t,i,r,T);if(b(e))return!(!b(t)||e.size!==t.size)&&M(e,t,i,r,R);if(m(e)){if(l=t,(a=e).byteLength!==l.byteLength||0!==L(new Uint8Array(a),new Uint8Array(l)))return!1}else if(O(e)&&!function(e,t){return k(e)?k(t)&&o(Number.prototype.valueOf.call(e),Number.prototype.valueOf.call(t)):S(e)?S(t)&&String.prototype.valueOf.call(e)===String.prototype.valueOf.call(t):j(e)?j(t)&&Boolean.prototype.valueOf.call(e)===Boolean.prototype.valueOf.call(t):A(e)?A(t)&&BigInt.prototype.valueOf.call(e)===BigInt.prototype.valueOf.call(t):I(t)&&Symbol.prototype.valueOf.call(e)===Symbol.prototype.valueOf.call(t)}(e,t))return!1}return M(e,t,i,r,P)}function U(e,t){return t.filter((function(t){return d(e,t)}))}function M(e,t,i,n,o,c){if(5===arguments.length){c=Object.keys(e);var h=Object.keys(t);if(c.length!==h.length)return!1}for(var f=0;f<c.length;f++)if(!p(t,c[f]))return!1;if(i&&5===arguments.length){var y=u(e);if(0!==y.length){var m=0;for(f=0;f<y.length;f++){var g=y[f];if(d(e,g)){if(!d(t,g))return!1;c.push(g),m++}else if(d(t,g))return!1}var v=u(t);if(y.length!==v.length&&U(t,v).length!==m)return!1}else{var b=u(t);if(0!==b.length&&0!==U(t,b).length)return!1}}if(0===c.length&&(o===P||o===q&&0===e.length||0===e.size))return!0;if(void 0===n)n={val1:new Map,val2:new Map,position:0};else{var w=n.val1.get(e);if(void 0!==w){var _=n.val2.get(t);if(void 0!==_)return w===_}n.position++}n.val1.set(e,n.position),n.val2.set(t,n.position);var x=function(e,t,i,n,o,u){var c=0;if(u===T){if(!function(e,t,i,r){for(var n=null,l=a(e),o=0;o<l.length;o++){var u=l[o];if("object"===s(u)&&null!==u)null===n&&(n=new Set),n.add(u);else if(!t.has(u)){if(i)return!1;if(!F(e,t,u))return!1;null===n&&(n=new Set),n.add(u)}}if(null!==n){for(var c=a(t),h=0;h<c.length;h++){var p=c[h];if("object"===s(p)&&null!==p){if(!B(n,p,i,r))return!1}else if(!i&&!e.has(p)&&!B(n,p,i,r))return!1}return 0===n.size}return!0}(e,t,i,o))return!1}else if(u===R){if(!function(e,t,i,n){for(var a=null,o=l(e),u=0;u<o.length;u++){var c=r(o[u],2),h=c[0],p=c[1];if("object"===s(h)&&null!==h)null===a&&(a=new Set),a.add(h);else{var d=t.get(h);if(void 0===d&&!t.has(h)||!W(p,d,i,n)){if(i)return!1;if(!J(e,t,h,p,n))return!1;null===a&&(a=new Set),a.add(h)}}}if(null!==a){for(var f=l(t),y=0;y<f.length;y++){var m=r(f[y],2),g=(h=m[0],m[1]);if("object"===s(h)&&null!==h){if(!$(a,e,h,g,i,n))return!1}else if(!(i||e.has(h)&&W(e.get(h),g,!1,n)||$(a,e,h,g,!1,n)))return!1}return 0===a.size}return!0}(e,t,i,o))return!1}else if(u===q)for(;c<e.length;c++){if(!p(e,c)){if(p(t,c))return!1;for(var h=Object.keys(e);c<h.length;c++){var d=h[c];if(!p(t,d)||!W(e[d],t[d],i,o))return!1}return h.length===Object.keys(t).length}if(!p(t,c)||!W(e[c],t[c],i,o))return!1}for(c=0;c<n.length;c++){var f=n[c];if(!W(e[f],t[f],i,o))return!1}return!0}(e,t,i,c,n,o);return n.val1.delete(e),n.val2.delete(t),x}function B(e,t,i,r){for(var s=a(e),n=0;n<s.length;n++){var l=s[n];if(W(t,l,i,r))return e.delete(l),!0}return!1}function z(e){switch(s(e)){case"undefined":return null;case"object":return;case"symbol":return!1;case"string":e=+e;case"number":if(c(e))return!1}return!0}function F(e,t,i){var r=z(i);return null!=r?r:t.has(r)&&!e.has(r)}function J(e,t,i,r,s){var n=z(i);if(null!=n)return n;var a=t.get(n);return!(void 0===a&&!t.has(n)||!W(r,a,!1,s))&&!e.has(n)&&W(r,a,!1,s)}function $(e,t,i,r,s,n){for(var l=a(e),o=0;o<l.length;o++){var u=l[o];if(W(i,u,s,n)&&W(r,t.get(u),s,n))return e.delete(u),!0}return!1}e.exports={isDeepEqual:function(e,t){return W(e,t,!1)},isDeepStrictEqual:function(e,t){return W(e,t,!0)}}},742:(e,t)=>{"use strict";t.byteLength=function(e){var t=l(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,n=l(e),a=n[0],o=n[1],u=new s(function(e,t,i){return 3*(t+i)/4-i}(0,a,o)),c=0,h=o>0?a-4:a;for(i=0;i<h;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,u[c++]=255&t),1===o&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,n=[],a=16383,l=0,u=r-s;l<u;l+=a)n.push(o(e,l,l+a>u?u:l+a));return 1===s?(t=e[r-1],n.push(i[t>>2]+i[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],n.push(i[t>>10]+i[t>>4&63]+i[t<<2&63]+"=")),n.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0;a<64;++a)i[a]=n[a],r[n.charCodeAt(a)]=a;function l(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function o(e,t,r){for(var s,n,a=[],l=t;l<r;l+=3)s=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),a.push(i[(n=s)>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(e,t,i)=>{"use strict";var r=i(108);const s=i(742),n=i(645),a="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.lW=u,t.h2=50;const l=2147483647;function o(e){if(e>l)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,u.prototype),t}function u(e,t,i){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return p(e)}return c(e,t,i)}function c(e,t,i){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!u.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const i=0|m(e,t);let r=o(i);const s=r.write(e,t);return s!==i&&(r=r.slice(0,s)),r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(H(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return d(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(H(e,ArrayBuffer)||e&&H(e.buffer,ArrayBuffer))return f(e,t,i);if("undefined"!=typeof SharedArrayBuffer&&(H(e,SharedArrayBuffer)||e&&H(e.buffer,SharedArrayBuffer)))return f(e,t,i);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return u.from(r,t,i);const s=function(e){if(u.isBuffer(e)){const t=0|y(e.length),i=o(t);return 0===i.length||e.copy(i,0,0,t),i}return void 0!==e.length?"number"!=typeof e.length||Z(e.length)?o(0):d(e):"Buffer"===e.type&&Array.isArray(e.data)?d(e.data):void 0}(e);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return u.from(e[Symbol.toPrimitive]("string"),t,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function h(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function p(e){return h(e),o(e<0?0:0|y(e))}function d(e){const t=e.length<0?0:0|y(e.length),i=o(t);for(let r=0;r<t;r+=1)i[r]=255&e[r];return i}function f(e,t,i){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===i?new Uint8Array(e):void 0===i?new Uint8Array(e,t):new Uint8Array(e,t,i),Object.setPrototypeOf(r,u.prototype),r}function y(e){if(e>=l)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l.toString(16)+" bytes");return 0|e}function m(e,t){if(u.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||H(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const i=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return G(e).length;default:if(s)return r?-1:V(e).length;t=(""+t).toLowerCase(),s=!0}}function g(e,t,i){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return C(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return E(this,t,i);case"latin1":case"binary":return D(this,t,i);case"base64":return j(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function v(e,t,i){const r=e[t];e[t]=e[i],e[i]=r}function b(e,t,i,r,s){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),Z(i=+i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=u.from(t,r)),u.isBuffer(t))return 0===t.length?-1:w(e,t,i,r,s);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):w(e,[t],i,r,s);throw new TypeError("val must be string, number or Buffer")}function w(e,t,i,r,s){let n,a=1,l=e.length,o=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;a=2,l/=2,o/=2,i/=2}function u(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(s){let r=-1;for(n=i;n<l;n++)if(u(e,n)===u(t,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===o)return r*a}else-1!==r&&(n-=n-r),r=-1}else for(i+o>l&&(i=l-o),n=i;n>=0;n--){let i=!0;for(let r=0;r<o;r++)if(u(e,n+r)!==u(t,r)){i=!1;break}if(i)return n}return-1}function _(e,t,i,r){i=Number(i)||0;const s=e.length-i;r?(r=Number(r))>s&&(r=s):r=s;const n=t.length;let a;for(r>n/2&&(r=n/2),a=0;a<r;++a){const r=parseInt(t.substr(2*a,2),16);if(Z(r))return a;e[i+a]=r}return a}function x(e,t,i,r){return Y(V(t,e.length-i),e,i,r)}function O(e,t,i,r){return Y(function(e){const t=[];for(let i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function k(e,t,i,r){return Y(G(t),e,i,r)}function S(e,t,i,r){return Y(function(e,t){let i,r,s;const n=[];for(let a=0;a<e.length&&!((t-=2)<0);++a)i=e.charCodeAt(a),r=i>>8,s=i%256,n.push(s),n.push(r);return n}(t,e.length-i),e,i,r)}function j(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);const r=[];let s=t;for(;s<i;){const t=e[s];let n=null,a=t>239?4:t>223?3:t>191?2:1;if(s+a<=i){let i,r,l,o;switch(a){case 1:t<128&&(n=t);break;case 2:i=e[s+1],128==(192&i)&&(o=(31&t)<<6|63&i,o>127&&(n=o));break;case 3:i=e[s+1],r=e[s+2],128==(192&i)&&128==(192&r)&&(o=(15&t)<<12|(63&i)<<6|63&r,o>2047&&(o<55296||o>57343)&&(n=o));break;case 4:i=e[s+1],r=e[s+2],l=e[s+3],128==(192&i)&&128==(192&r)&&128==(192&l)&&(o=(15&t)<<18|(63&i)<<12|(63&r)<<6|63&l,o>65535&&o<1114112&&(n=o))}}null===n?(n=65533,a=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=a}return function(e){const t=e.length;if(t<=I)return String.fromCharCode.apply(String,e);let i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=I));return i}(r)}u.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),u.TYPED_ARRAY_SUPPORT||void 0===r||"function"!=typeof r.error||r.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}}),u.poolSize=8192,u.from=function(e,t,i){return c(e,t,i)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array),u.alloc=function(e,t,i){return function(e,t,i){return h(e),e<=0?o(e):void 0!==t?"string"==typeof i?o(e).fill(t,i):o(e).fill(t):o(e)}(e,t,i)},u.allocUnsafe=function(e){return p(e)},u.allocUnsafeSlow=function(e){return p(e)},u.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==u.prototype},u.compare=function(e,t){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),H(t,Uint8Array)&&(t=u.from(t,t.offset,t.byteLength)),!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let i=e.length,r=t.length;for(let s=0,n=Math.min(i,r);s<n;++s)if(e[s]!==t[s]){i=e[s],r=t[s];break}return i<r?-1:r<i?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);let i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;const r=u.allocUnsafe(t);let s=0;for(i=0;i<e.length;++i){let t=e[i];if(H(t,Uint8Array))s+t.length>r.length?(u.isBuffer(t)||(t=u.from(t)),t.copy(r,s)):Uint8Array.prototype.set.call(r,t,s);else{if(!u.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,s)}s+=t.length}return r},u.byteLength=m,u.prototype._isBuffer=!0,u.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)v(this,t,t+1);return this},u.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},u.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},u.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?A(this,0,e):g.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){let e="";const i=t.h2;return e=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(e+=" ... "),"<Buffer "+e+">"},a&&(u.prototype[a]=u.prototype.inspect),u.prototype.compare=function(e,t,i,r,s){if(H(e,Uint8Array)&&(e=u.from(e,e.offset,e.byteLength)),!u.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),t<0||i>e.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&t>=i)return 0;if(r>=s)return-1;if(t>=i)return 1;if(this===e)return 0;let n=(s>>>=0)-(r>>>=0),a=(i>>>=0)-(t>>>=0);const l=Math.min(n,a),o=this.slice(r,s),c=e.slice(t,i);for(let e=0;e<l;++e)if(o[e]!==c[e]){n=o[e],a=c[e];break}return n<a?-1:a<n?1:0},u.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},u.prototype.indexOf=function(e,t,i){return b(this,e,t,i,!0)},u.prototype.lastIndexOf=function(e,t,i){return b(this,e,t,i,!1)},u.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return _(this,e,t,i);case"utf8":case"utf-8":return x(this,e,t,i);case"ascii":case"latin1":case"binary":return O(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,e,t,i);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const I=4096;function E(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(127&e[s]);return r}function D(e,t,i){let r="";i=Math.min(e.length,i);for(let s=t;s<i;++s)r+=String.fromCharCode(e[s]);return r}function C(e,t,i){const r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=t;r<i;++r)s+=K[e[r]];return s}function N(e,t,i){const r=e.slice(t,i);let s="";for(let e=0;e<r.length-1;e+=2)s+=String.fromCharCode(r[e]+256*r[e+1]);return s}function L(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,i,r,s,n){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<n)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function q(e,t,i,r,s){F(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n,n>>=8,e[i++]=n;let a=Number(t>>BigInt(32)&BigInt(4294967295));return e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a,a>>=8,e[i++]=a,i}function T(e,t,i,r,s){F(t,r,s,e,i,7);let n=Number(t&BigInt(4294967295));e[i+7]=n,n>>=8,e[i+6]=n,n>>=8,e[i+5]=n,n>>=8,e[i+4]=n;let a=Number(t>>BigInt(32)&BigInt(4294967295));return e[i+3]=a,a>>=8,e[i+2]=a,a>>=8,e[i+1]=a,a>>=8,e[i]=a,i+8}function R(e,t,i,r,s,n){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function W(e,t,i,r,s){return t=+t,i>>>=0,s||R(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function U(e,t,i,r,s){return t=+t,i>>>=0,s||R(e,0,i,8),n.write(e,t,i,r,52,8),i+8}u.prototype.slice=function(e,t){const i=this.length;(e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,u.prototype),r},u.prototype.readUintLE=u.prototype.readUIntLE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return r},u.prototype.readUintBE=u.prototype.readUIntBE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e+--t],s=1;for(;t>0&&(s*=256);)r+=this[e+--t]*s;return r},u.prototype.readUint8=u.prototype.readUInt8=function(e,t){return e>>>=0,t||L(e,1,this.length),this[e]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(e,t){return e>>>=0,t||L(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(e,t){return e>>>=0,t||L(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(e,t){return e>>>=0,t||L(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(e,t){return e>>>=0,t||L(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readBigUInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,s=this[++e]+256*this[++e]+65536*this[++e]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),u.prototype.readBigUInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],s=this[++e]*2**24+65536*this[++e]+256*this[++e]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),u.prototype.readIntLE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=this[e],s=1,n=0;for(;++n<t&&(s*=256);)r+=this[e+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*t)),r},u.prototype.readIntBE=function(e,t,i){e>>>=0,t>>>=0,i||L(e,t,this.length);let r=t,s=1,n=this[e+--r];for(;r>0&&(s*=256);)n+=this[e+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*t)),n},u.prototype.readInt8=function(e,t){return e>>>=0,t||L(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){e>>>=0,t||L(e,2,this.length);const i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt16BE=function(e,t){e>>>=0,t||L(e,2,this.length);const i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},u.prototype.readInt32LE=function(e,t){return e>>>=0,t||L(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return e>>>=0,t||L(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readBigInt64LE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),u.prototype.readBigInt64BE=Q((function(e){J(e>>>=0,"offset");const t=this[e],i=this[e+7];void 0!==t&&void 0!==i||$(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+i)})),u.prototype.readFloatLE=function(e,t){return e>>>=0,t||L(e,4,this.length),n.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return e>>>=0,t||L(e,4,this.length),n.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return e>>>=0,t||L(e,8,this.length),n.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return e>>>=0,t||L(e,8,this.length),n.read(this,e,!1,52,8)},u.prototype.writeUintLE=u.prototype.writeUIntLE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=1,n=0;for(this[t]=255&e;++n<i&&(s*=256);)this[t+n]=e/s&255;return t+i},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(e,t,i,r){e=+e,t>>>=0,i>>>=0,r||P(this,e,t,i,Math.pow(2,8*i)-1,0);let s=i-1,n=1;for(this[t+s]=255&e;--s>=0&&(n*=256);)this[t+s]=e/n&255;return t+i},u.prototype.writeUint8=u.prototype.writeUInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,255,0),this[t]=255&e,t+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigUInt64LE=Q((function(e,t=0){return q(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeBigUInt64BE=Q((function(e,t=0){return T(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),u.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=0,n=1,a=0;for(this[t]=255&e;++s<i&&(n*=256);)e<0&&0===a&&0!==this[t+s-1]&&(a=1),this[t+s]=(e/n>>0)-a&255;return t+i},u.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*i-1);P(this,e,t,i,r-1,-r)}let s=i-1,n=1,a=0;for(this[t+s]=255&e;--s>=0&&(n*=256);)e<0&&0===a&&0!==this[t+s+1]&&(a=1),this[t+s]=(e/n>>0)-a&255;return t+i},u.prototype.writeInt8=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},u.prototype.writeInt16LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},u.prototype.writeInt16BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},u.prototype.writeInt32LE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},u.prototype.writeInt32BE=function(e,t,i){return e=+e,t>>>=0,i||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},u.prototype.writeBigInt64LE=Q((function(e,t=0){return q(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeBigInt64BE=Q((function(e,t=0){return T(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),u.prototype.writeFloatLE=function(e,t,i){return W(this,e,t,!0,i)},u.prototype.writeFloatBE=function(e,t,i){return W(this,e,t,!1,i)},u.prototype.writeDoubleLE=function(e,t,i){return U(this,e,t,!0,i)},u.prototype.writeDoubleBE=function(e,t,i){return U(this,e,t,!1,i)},u.prototype.copy=function(e,t,i,r){if(!u.isBuffer(e))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);const s=r-i;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,i,r):Uint8Array.prototype.set.call(e,this.subarray(i,r),t),s},u.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;let s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{const n=u.isBuffer(e)?e:u.from(e,r),a=n.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<i-t;++s)this[s+t]=n[s%a]}return this};const M={};function B(e,t,i){M[e]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function z(e){let t="",i=e.length;const r="-"===e[0]?1:0;for(;i>=r+4;i-=3)t=`_${e.slice(i-3,i)}${t}`;return`${e.slice(0,i)}${t}`}function F(e,t,i,r,s,n){if(e>i||e<t){const r="bigint"==typeof t?"n":"";let s;throw s=n>3?0===t||t===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(n+1)}${r}`:`>= -(2${r} ** ${8*(n+1)-1}${r}) and < 2 ** ${8*(n+1)-1}${r}`:`>= ${t}${r} and <= ${i}${r}`,new M.ERR_OUT_OF_RANGE("value",s,e)}!function(e,t,i){J(t,"offset"),void 0!==e[t]&&void 0!==e[t+i]||$(t,e.length-(i+1))}(r,s,n)}function J(e,t){if("number"!=typeof e)throw new M.ERR_INVALID_ARG_TYPE(t,"number",e)}function $(e,t,i){if(Math.floor(e)!==e)throw J(e,i),new M.ERR_OUT_OF_RANGE(i||"offset","an integer",e);if(t<0)throw new M.ERR_BUFFER_OUT_OF_BOUNDS;throw new M.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${t}`,e)}B("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),B("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),B("ERR_OUT_OF_RANGE",(function(e,t,i){let r=`The value of "${e}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=z(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=z(s)),s+="n"),r+=` It must be ${t}. Received ${s}`,r}),RangeError);const X=/[^+/0-9A-Za-z-_]/g;function V(e,t){let i;t=t||1/0;const r=e.length;let s=null;const n=[];for(let a=0;a<r;++a){if(i=e.charCodeAt(a),i>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&n.push(239,191,189);continue}if(a+1===r){(t-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;n.push(i)}else if(i<2048){if((t-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function G(e){return s.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(X,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,i,r){let s;for(s=0;s<r&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function H(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Z(e){return e!=e}const K=function(){const e="0123456789abcdef",t=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)t[r+s]=e[i]+e[s]}return t}();function Q(e){return"undefined"==typeof BigInt?ee:e}function ee(){throw new Error("BigInt not supported")}},924:(e,t,i)=>{"use strict";var r=i(210),s=i(559),n=s(r("String.prototype.indexOf"));e.exports=function(e,t){var i=r(e,!!t);return"function"==typeof i&&n(e,".prototype.")>-1?s(i):i}},559:(e,t,i)=>{"use strict";var r=i(612),s=i(210),n=s("%Function.prototype.apply%"),a=s("%Function.prototype.call%"),l=s("%Reflect.apply%",!0)||r.call(a,n),o=s("%Object.getOwnPropertyDescriptor%",!0),u=s("%Object.defineProperty%",!0),c=s("%Math.max%");if(u)try{u({},"a",{value:1})}catch(e){u=null}e.exports=function(e){var t=l(r,a,arguments);return o&&u&&o(t,"length").configurable&&u(t,"length",{value:1+c(0,e.length-(arguments.length-1))}),t};var h=function(){return l(r,n,arguments)};u?u(e.exports,"apply",{value:h}):e.exports.apply=h},108:(e,t,i)=>{var r=i(539),s=i(282);function n(){return(new Date).getTime()}var a,l=Array.prototype.slice,o={};a=void 0!==i.g&&i.g.console?i.g.console:"undefined"!=typeof window&&window.console?window.console:{};for(var u=[[function(){},"log"],[function(){a.log.apply(a,arguments)},"info"],[function(){a.log.apply(a,arguments)},"warn"],[function(){a.warn.apply(a,arguments)},"error"],[function(e){o[e]=n()},"time"],[function(e){var t=o[e];if(!t)throw new Error("No such label: "+e);delete o[e];var i=n()-t;a.log(e+": "+i+"ms")},"timeEnd"],[function(){var e=new Error;e.name="Trace",e.message=r.format.apply(null,arguments),a.error(e.stack)},"trace"],[function(e){a.log(r.inspect(e)+"\n")},"dir"],[function(e){if(!e){var t=l.call(arguments,1);s.ok(!1,r.format.apply(null,t))}},"assert"]],c=0;c<u.length;c++){var h=u[c],p=h[0],d=h[1];a[d]||(a[d]=p)}e.exports=a},289:(e,t,i)=>{"use strict";var r=i(215),s="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),n=Object.prototype.toString,a=Array.prototype.concat,l=Object.defineProperty,o=i(44)(),u=l&&o,c=function(e,t,i,r){if(t in e)if(!0===r){if(e[t]===i)return}else if("function"!=typeof(s=r)||"[object Function]"!==n.call(s)||!r())return;var s;u?l(e,t,{configurable:!0,enumerable:!1,value:i,writable:!0}):e[t]=i},h=function(e,t){var i=arguments.length>2?arguments[2]:{},n=r(t);s&&(n=a.call(n,Object.getOwnPropertySymbols(t)));for(var l=0;l<n.length;l+=1)c(e,n[l],t[n[l]],i[n[l]])};h.supportsDescriptors=!!u,e.exports=h},91:e=>{"use strict";function t(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var i=Object(e),r=1;r<arguments.length;r++){var s=arguments[r];if(null!=s)for(var n=Object.keys(Object(s)),a=0,l=n.length;a<l;a++){var o=n[a],u=Object.getOwnPropertyDescriptor(s,o);void 0!==u&&u.enumerable&&(i[o]=s[o])}}return i}e.exports={assign:t,polyfill:function(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:t})}}},29:(e,t,i)=>{"use strict";var r=i(320),s=Object.prototype.toString,n=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){if(!r(t))throw new TypeError("iterator must be a function");var a;arguments.length>=3&&(a=i),"[object Array]"===s.call(e)?function(e,t,i){for(var r=0,s=e.length;r<s;r++)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,a):"string"==typeof e?function(e,t,i){for(var r=0,s=e.length;r<s;r++)null==i?t(e.charAt(r),r,e):t.call(i,e.charAt(r),r,e)}(e,t,a):function(e,t,i){for(var r in e)n.call(e,r)&&(null==i?t(e[r],r,e):t.call(i,e[r],r,e))}(e,t,a)}},648:e=>{"use strict";var t=Array.prototype.slice,i=Object.prototype.toString;e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==i.call(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var s,n=t.call(arguments,1),a=Math.max(0,r.length-n.length),l=[],o=0;o<a;o++)l.push("$"+o);if(s=Function("binder","return function ("+l.join(",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var i=r.apply(this,n.concat(t.call(arguments)));return Object(i)===i?i:this}return r.apply(e,n.concat(t.call(arguments)))})),r.prototype){var u=function(){};u.prototype=r.prototype,s.prototype=new u,u.prototype=null}return s}},612:(e,t,i)=>{"use strict";var r=i(648);e.exports=Function.prototype.bind||r},210:(e,t,i)=>{"use strict";var r,s=SyntaxError,n=Function,a=TypeError,l=function(e){try{return n('"use strict"; return ('+e+").constructor;")()}catch(e){}},o=Object.getOwnPropertyDescriptor;if(o)try{o({},"")}catch(e){o=null}var u=function(){throw new a},c=o?function(){try{return u}catch(e){try{return o(arguments,"callee").get}catch(e){return u}}}():u,h=i(405)(),p=i(185)(),d=Object.getPrototypeOf||(p?function(e){return e.__proto__}:null),f={},y="undefined"!=typeof Uint8Array&&d?d(Uint8Array):r,m={"%AggregateError%":"undefined"==typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":h&&d?d([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":f,"%AsyncGenerator%":f,"%AsyncGeneratorFunction%":f,"%AsyncIteratorPrototype%":f,"%Atomics%":"undefined"==typeof Atomics?r:Atomics,"%BigInt%":"undefined"==typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Error,"%eval%":eval,"%EvalError%":EvalError,"%Float32Array%":"undefined"==typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":n,"%GeneratorFunction%":f,"%Int8Array%":"undefined"==typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":h&&d?d(d([][Symbol.iterator]())):r,"%JSON%":"object"==typeof JSON?JSON:r,"%Map%":"undefined"==typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&h&&d?d((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?r:Promise,"%Proxy%":"undefined"==typeof Proxy?r:Proxy,"%RangeError%":RangeError,"%ReferenceError%":ReferenceError,"%Reflect%":"undefined"==typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&h&&d?d((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":h&&d?d(""[Symbol.iterator]()):r,"%Symbol%":h?Symbol:r,"%SyntaxError%":s,"%ThrowTypeError%":c,"%TypedArray%":y,"%TypeError%":a,"%Uint8Array%":"undefined"==typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?r:Uint32Array,"%URIError%":URIError,"%WeakMap%":"undefined"==typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?r:WeakSet};if(d)try{null.error}catch(e){var g=d(d(e));m["%Error.prototype%"]=g}var v=function e(t){var i;if("%AsyncFunction%"===t)i=l("async function () {}");else if("%GeneratorFunction%"===t)i=l("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=l("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(i=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var s=e("%AsyncGenerator%");s&&d&&(i=d(s.prototype))}return m[t]=i,i},b={"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},w=i(612),_=i(642),x=w.call(Function.call,Array.prototype.concat),O=w.call(Function.apply,Array.prototype.splice),k=w.call(Function.call,String.prototype.replace),S=w.call(Function.call,String.prototype.slice),j=w.call(Function.call,RegExp.prototype.exec),A=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,I=/\\(\\)?/g,E=function(e,t){var i,r=e;if(_(b,r)&&(r="%"+(i=b[r])[0]+"%"),_(m,r)){var n=m[r];if(n===f&&(n=v(r)),void 0===n&&!t)throw new a("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:r,value:n}}throw new s("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new a("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new a('"allowMissing" argument must be a boolean');if(null===j(/^%?[^%]*%?$/,e))throw new s("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=S(e,0,1),i=S(e,-1);if("%"===t&&"%"!==i)throw new s("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new s("invalid intrinsic syntax, expected opening `%`");var r=[];return k(e,A,(function(e,t,i,s){r[r.length]=i?k(s,I,"$1"):t||e})),r}(e),r=i.length>0?i[0]:"",n=E("%"+r+"%",t),l=n.name,u=n.value,c=!1,h=n.alias;h&&(r=h[0],O(i,x([0,1],h)));for(var p=1,d=!0;p<i.length;p+=1){var f=i[p],y=S(f,0,1),g=S(f,-1);if(('"'===y||"'"===y||"`"===y||'"'===g||"'"===g||"`"===g)&&y!==g)throw new s("property names with quotes must have matching quotes");if("constructor"!==f&&d||(c=!0),_(m,l="%"+(r+="."+f)+"%"))u=m[l];else if(null!=u){if(!(f in u)){if(!t)throw new a("base intrinsic for "+e+" exists, but the property is not available.");return}if(o&&p+1>=i.length){var v=o(u,f);u=(d=!!v)&&"get"in v&&!("originalValue"in v.get)?v.get:u[f]}else d=_(u,f),u=u[f];d&&!c&&(m[l]=u)}}return u}},296:(e,t,i)=>{"use strict";var r=i(210)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(e){r=null}e.exports=r},44:(e,t,i)=>{"use strict";var r=i(210)("%Object.defineProperty%",!0),s=function(){if(r)try{return r({},"a",{value:1}),!0}catch(e){return!1}return!1};s.hasArrayLengthDefineBug=function(){if(!s())return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=s},185:e=>{"use strict";var t={foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!({__proto__:null}instanceof i)}},405:(e,t,i)=>{"use strict";var r="undefined"!=typeof Symbol&&Symbol,s=i(419);e.exports=function(){return"function"==typeof r&&"function"==typeof Symbol&&"symbol"==typeof r("foo")&&"symbol"==typeof Symbol("bar")&&s()}},419:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0}},410:(e,t,i)=>{"use strict";var r=i(419);e.exports=function(){return r()&&!!Symbol.toStringTag}},642:(e,t,i)=>{"use strict";var r=i(612);e.exports=r.call(Function.call,Object.prototype.hasOwnProperty)},645:(e,t)=>{t.read=function(e,t,i,r,s){var n,a,l=8*s-r-1,o=(1<<l)-1,u=o>>1,c=-7,h=i?s-1:0,p=i?-1:1,d=e[t+h];for(h+=p,n=d&(1<<-c)-1,d>>=-c,c+=l;c>0;n=256*n+e[t+h],h+=p,c-=8);for(a=n&(1<<-c)-1,n>>=-c,c+=r;c>0;a=256*a+e[t+h],h+=p,c-=8);if(0===n)n=1-u;else{if(n===o)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),n-=u}return(d?-1:1)*a*Math.pow(2,n-r)},t.write=function(e,t,i,r,s,n){var a,l,o,u=8*n-s-1,c=(1<<u)-1,h=c>>1,p=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:n-1,f=r?1:-1,y=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,a=c):(a=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-a))<1&&(a--,o*=2),(t+=a+h>=1?p/o:p*Math.pow(2,1-h))*o>=2&&(a++,o/=2),a+h>=c?(l=0,a=c):a+h>=1?(l=(t*o-1)*Math.pow(2,s),a+=h):(l=t*Math.pow(2,h-1)*Math.pow(2,s),a=0));s>=8;e[i+d]=255&l,d+=f,l/=256,s-=8);for(a=a<<s|l,u+=s;u>0;e[i+d]=255&a,d+=f,a/=256,u-=8);e[i+d-f]|=128*y}},717:e=>{"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e}}},584:(e,t,i)=>{"use strict";var r=i(410)(),s=i(924)("Object.prototype.toString"),n=function(e){return!(r&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===s(e)},a=function(e){return!!n(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==s(e)&&"[object Function]"===s(e.callee)},l=function(){return n(arguments)}();n.isLegacyArguments=a,e.exports=l?n:a},320:e=>{"use strict";var t,i,r=Function.prototype.toString,s="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof s&&"function"==typeof Object.defineProperty)try{t=Object.defineProperty({},"length",{get:function(){throw i}}),i={},s((function(){throw 42}),null,t)}catch(e){e!==i&&(s=null)}else s=null;var n=/^\s*class\b/,a=function(e){try{var t=r.call(e);return n.test(t)}catch(e){return!1}},l=function(e){try{return!a(e)&&(r.call(e),!0)}catch(e){return!1}},o=Object.prototype.toString,u="function"==typeof Symbol&&!!Symbol.toStringTag,c=!(0 in[,]),h=function(){return!1};if("object"==typeof document){var p=document.all;o.call(p)===o.call(document.all)&&(h=function(e){if((c||!e)&&(void 0===e||"object"==typeof e))try{var t=o.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}e.exports=s?function(e){if(h(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{s(e,null,t)}catch(e){if(e!==i)return!1}return!a(e)&&l(e)}:function(e){if(h(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(u)return l(e);if(a(e))return!1;var t=o.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&l(e)}},662:(e,t,i)=>{"use strict";var r,s=Object.prototype.toString,n=Function.prototype.toString,a=/^\s*(?:function)?\*/,l=i(410)(),o=Object.getPrototypeOf;e.exports=function(e){if("function"!=typeof e)return!1;if(a.test(n.call(e)))return!0;if(!l)return"[object GeneratorFunction]"===s.call(e);if(!o)return!1;if(void 0===r){var t=function(){if(!l)return!1;try{return Function("return function*() {}")()}catch(e){}}();r=!!t&&o(t)}return o(e)===r}},611:e=>{"use strict";e.exports=function(e){return e!=e}},360:(e,t,i)=>{"use strict";var r=i(559),s=i(289),n=i(611),a=i(415),l=i(194),o=r(a(),Number);s(o,{getPolyfill:a,implementation:n,shim:l}),e.exports=o},415:(e,t,i)=>{"use strict";var r=i(611);e.exports=function(){return Number.isNaN&&Number.isNaN(NaN)&&!Number.isNaN("a")?Number.isNaN:r}},194:(e,t,i)=>{"use strict";var r=i(289),s=i(415);e.exports=function(){var e=s();return r(Number,{isNaN:e},{isNaN:function(){return Number.isNaN!==e}}),e}},692:(e,t,i)=>{"use strict";var r=i(430);e.exports=function(e){return!!r(e)}},244:e=>{"use strict";var t=function(e){return e!=e};e.exports=function(e,i){return 0===e&&0===i?1/e==1/i:e===i||!(!t(e)||!t(i))}},609:(e,t,i)=>{"use strict";var r=i(289),s=i(559),n=i(244),a=i(624),l=i(281),o=s(a(),Object);r(o,{getPolyfill:a,implementation:n,shim:l}),e.exports=o},624:(e,t,i)=>{"use strict";var r=i(244);e.exports=function(){return"function"==typeof Object.is?Object.is:r}},281:(e,t,i)=>{"use strict";var r=i(624),s=i(289);e.exports=function(){var e=r();return s(Object,{is:e},{is:function(){return Object.is!==e}}),e}},987:(e,t,i)=>{"use strict";var r;if(!Object.keys){var s=Object.prototype.hasOwnProperty,n=Object.prototype.toString,a=i(414),l=Object.prototype.propertyIsEnumerable,o=!l.call({toString:null},"toString"),u=l.call((function(){}),"prototype"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],h=function(e){var t=e.constructor;return t&&t.prototype===e},p={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},d=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!p["$"+e]&&s.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{h(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();r=function(e){var t=null!==e&&"object"==typeof e,i="[object Function]"===n.call(e),r=a(e),l=t&&"[object String]"===n.call(e),p=[];if(!t&&!i&&!r)throw new TypeError("Object.keys called on a non-object");var f=u&&i;if(l&&e.length>0&&!s.call(e,0))for(var y=0;y<e.length;++y)p.push(String(y));if(r&&e.length>0)for(var m=0;m<e.length;++m)p.push(String(m));else for(var g in e)f&&"prototype"===g||!s.call(e,g)||p.push(String(g));if(o)for(var v=function(e){if("undefined"==typeof window||!d)return h(e);try{return h(e)}catch(e){return!1}}(e),b=0;b<c.length;++b)v&&"constructor"===c[b]||!s.call(e,c[b])||p.push(c[b]);return p}}e.exports=r},215:(e,t,i)=>{"use strict";var r=Array.prototype.slice,s=i(414),n=Object.keys,a=n?function(e){return n(e)}:i(987),l=Object.keys;a.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return s(e)?l(r.call(e)):l(e)})}else Object.keys=a;return Object.keys||a},e.exports=a},414:e=>{"use strict";var t=Object.prototype.toString;e.exports=function(e){var i=t.call(e),r="[object Arguments]"===i;return r||(r="[object Array]"!==i&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===t.call(e.callee)),r}},155:e=>{var t,i,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(e){if(t===setTimeout)return setTimeout(e,0);if((t===s||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(i){try{return t.call(null,e,0)}catch(i){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:s}catch(e){t=s}try{i="function"==typeof clearTimeout?clearTimeout:n}catch(e){i=n}}();var l,o=[],u=!1,c=-1;function h(){u&&l&&(u=!1,l.length?o=l.concat(o):c=-1,o.length&&p())}function p(){if(!u){var e=a(h);u=!0;for(var t=o.length;t;){for(l=o,o=[];++c<t;)l&&l[c].run();c=-1,t=o.length}l=null,u=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{return i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function f(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];o.push(new d(e,t)),1!==o.length||u||a(p)},d.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=f,r.addListener=f,r.once=f,r.off=f,r.removeListener=f,r.removeAllListeners=f,r.emit=f,r.prependListener=f,r.prependOnceListener=f,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},384:e=>{e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},955:(e,t,i)=>{"use strict";var r=i(584),s=i(662),n=i(430),a=i(692);function l(e){return e.call.bind(e)}var o="undefined"!=typeof BigInt,u="undefined"!=typeof Symbol,c=l(Object.prototype.toString),h=l(Number.prototype.valueOf),p=l(String.prototype.valueOf),d=l(Boolean.prototype.valueOf);if(o)var f=l(BigInt.prototype.valueOf);if(u)var y=l(Symbol.prototype.valueOf);function m(e,t){if("object"!=typeof e)return!1;try{return t(e),!0}catch(e){return!1}}function g(e){return"[object Map]"===c(e)}function v(e){return"[object Set]"===c(e)}function b(e){return"[object WeakMap]"===c(e)}function w(e){return"[object WeakSet]"===c(e)}function _(e){return"[object ArrayBuffer]"===c(e)}function x(e){return"undefined"!=typeof ArrayBuffer&&(_.working?_(e):e instanceof ArrayBuffer)}function O(e){return"[object DataView]"===c(e)}function k(e){return"undefined"!=typeof DataView&&(O.working?O(e):e instanceof DataView)}t.isArgumentsObject=r,t.isGeneratorFunction=s,t.isTypedArray=a,t.isPromise=function(e){return"undefined"!=typeof Promise&&e instanceof Promise||null!==e&&"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch},t.isArrayBufferView=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):a(e)||k(e)},t.isUint8Array=function(e){return"Uint8Array"===n(e)},t.isUint8ClampedArray=function(e){return"Uint8ClampedArray"===n(e)},t.isUint16Array=function(e){return"Uint16Array"===n(e)},t.isUint32Array=function(e){return"Uint32Array"===n(e)},t.isInt8Array=function(e){return"Int8Array"===n(e)},t.isInt16Array=function(e){return"Int16Array"===n(e)},t.isInt32Array=function(e){return"Int32Array"===n(e)},t.isFloat32Array=function(e){return"Float32Array"===n(e)},t.isFloat64Array=function(e){return"Float64Array"===n(e)},t.isBigInt64Array=function(e){return"BigInt64Array"===n(e)},t.isBigUint64Array=function(e){return"BigUint64Array"===n(e)},g.working="undefined"!=typeof Map&&g(new Map),t.isMap=function(e){return"undefined"!=typeof Map&&(g.working?g(e):e instanceof Map)},v.working="undefined"!=typeof Set&&v(new Set),t.isSet=function(e){return"undefined"!=typeof Set&&(v.working?v(e):e instanceof Set)},b.working="undefined"!=typeof WeakMap&&b(new WeakMap),t.isWeakMap=function(e){return"undefined"!=typeof WeakMap&&(b.working?b(e):e instanceof WeakMap)},w.working="undefined"!=typeof WeakSet&&w(new WeakSet),t.isWeakSet=function(e){return w(e)},_.working="undefined"!=typeof ArrayBuffer&&_(new ArrayBuffer),t.isArrayBuffer=x,O.working="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView&&O(new DataView(new ArrayBuffer(1),0,1)),t.isDataView=k;var S="undefined"!=typeof SharedArrayBuffer?SharedArrayBuffer:void 0;function j(e){return"[object SharedArrayBuffer]"===c(e)}function A(e){return void 0!==S&&(void 0===j.working&&(j.working=j(new S)),j.working?j(e):e instanceof S)}function I(e){return m(e,h)}function E(e){return m(e,p)}function D(e){return m(e,d)}function C(e){return o&&m(e,f)}function N(e){return u&&m(e,y)}t.isSharedArrayBuffer=A,t.isAsyncFunction=function(e){return"[object AsyncFunction]"===c(e)},t.isMapIterator=function(e){return"[object Map Iterator]"===c(e)},t.isSetIterator=function(e){return"[object Set Iterator]"===c(e)},t.isGeneratorObject=function(e){return"[object Generator]"===c(e)},t.isWebAssemblyCompiledModule=function(e){return"[object WebAssembly.Module]"===c(e)},t.isNumberObject=I,t.isStringObject=E,t.isBooleanObject=D,t.isBigIntObject=C,t.isSymbolObject=N,t.isBoxedPrimitive=function(e){return I(e)||E(e)||D(e)||C(e)||N(e)},t.isAnyArrayBuffer=function(e){return"undefined"!=typeof Uint8Array&&(x(e)||A(e))},["isProxy","isExternal","isModuleNamespaceObject"].forEach((function(e){Object.defineProperty(t,e,{enumerable:!1,value:function(){throw new Error(e+" is not supported in userland")}})}))},539:(e,t,i)=>{var r=i(155),s=i(108),n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return i},a=/%[sdj%]/g;t.format=function(e){if(!w(e)){for(var t=[],i=0;i<arguments.length;i++)t.push(c(arguments[i]));return t.join(" ")}i=1;for(var r=arguments,s=r.length,n=String(e).replace(a,(function(e){if("%%"===e)return"%";if(i>=s)return e;switch(e){case"%s":return String(r[i++]);case"%d":return Number(r[i++]);case"%j":try{return JSON.stringify(r[i++])}catch(e){return"[Circular]"}default:return e}})),l=r[i];i<s;l=r[++i])v(l)||!O(l)?n+=" "+l:n+=" "+c(l);return n},t.deprecate=function(e,i){if(void 0!==r&&!0===r.noDeprecation)return e;if(void 0===r)return function(){return t.deprecate(e,i).apply(this,arguments)};var n=!1;return function(){if(!n){if(r.throwDeprecation)throw new Error(i);r.traceDeprecation?s.trace(i):s.error(i),n=!0}return e.apply(this,arguments)}};var l={},o=/^$/;if(r.env.NODE_DEBUG){var u=r.env.NODE_DEBUG;u=u.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),o=new RegExp("^"+u+"$","i")}function c(e,i){var r={seen:[],stylize:p};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),g(i)?r.showHidden=i:i&&t._extend(r,i),_(r.showHidden)&&(r.showHidden=!1),_(r.depth)&&(r.depth=2),_(r.colors)&&(r.colors=!1),_(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=h),d(r,e,r.depth)}function h(e,t){var i=c.styles[t];return i?"["+c.colors[i][0]+"m"+e+"["+c.colors[i][1]+"m":e}function p(e,t){return e}function d(e,i,r){if(e.customInspect&&i&&j(i.inspect)&&i.inspect!==t.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(r,e);return w(s)||(s=d(e,s,r)),s}var n=function(e,t){if(_(t))return e.stylize("undefined","undefined");if(w(t)){var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string")}return b(t)?e.stylize(""+t,"number"):g(t)?e.stylize(""+t,"boolean"):v(t)?e.stylize("null","null"):void 0}(e,i);if(n)return n;var a=Object.keys(i),l=function(e){var t={};return e.forEach((function(e,i){t[e]=!0})),t}(a);if(e.showHidden&&(a=Object.getOwnPropertyNames(i)),S(i)&&(a.indexOf("message")>=0||a.indexOf("description")>=0))return f(i);if(0===a.length){if(j(i)){var o=i.name?": "+i.name:"";return e.stylize("[Function"+o+"]","special")}if(x(i))return e.stylize(RegExp.prototype.toString.call(i),"regexp");if(k(i))return e.stylize(Date.prototype.toString.call(i),"date");if(S(i))return f(i)}var u,c="",h=!1,p=["{","}"];return m(i)&&(h=!0,p=["[","]"]),j(i)&&(c=" [Function"+(i.name?": "+i.name:"")+"]"),x(i)&&(c=" "+RegExp.prototype.toString.call(i)),k(i)&&(c=" "+Date.prototype.toUTCString.call(i)),S(i)&&(c=" "+f(i)),0!==a.length||h&&0!=i.length?r<0?x(i)?e.stylize(RegExp.prototype.toString.call(i),"regexp"):e.stylize("[Object]","special"):(e.seen.push(i),u=h?function(e,t,i,r,s){for(var n=[],a=0,l=t.length;a<l;++a)D(t,String(a))?n.push(y(e,t,i,r,String(a),!0)):n.push("");return s.forEach((function(s){s.match(/^\d+$/)||n.push(y(e,t,i,r,s,!0))})),n}(e,i,r,l,a):a.map((function(t){return y(e,i,r,l,t,h)})),e.seen.pop(),function(e,t,i){return e.reduce((function(e,t){return t.indexOf("\n"),e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]}(u,c,p)):p[0]+c+p[1]}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function y(e,t,i,r,s,n){var a,l,o;if((o=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]}).get?l=o.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):o.set&&(l=e.stylize("[Setter]","special")),D(r,s)||(a="["+s+"]"),l||(e.seen.indexOf(o.value)<0?(l=v(i)?d(e,o.value,null):d(e,o.value,i-1)).indexOf("\n")>-1&&(l=n?l.split("\n").map((function(e){return"  "+e})).join("\n").slice(2):"\n"+l.split("\n").map((function(e){return"   "+e})).join("\n")):l=e.stylize("[Circular]","special")),_(a)){if(n&&s.match(/^\d+$/))return l;(a=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.slice(1,-1),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+l}function m(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function v(e){return null===e}function b(e){return"number"==typeof e}function w(e){return"string"==typeof e}function _(e){return void 0===e}function x(e){return O(e)&&"[object RegExp]"===A(e)}function O(e){return"object"==typeof e&&null!==e}function k(e){return O(e)&&"[object Date]"===A(e)}function S(e){return O(e)&&("[object Error]"===A(e)||e instanceof Error)}function j(e){return"function"==typeof e}function A(e){return Object.prototype.toString.call(e)}function I(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(e){if(e=e.toUpperCase(),!l[e])if(o.test(e)){var i=r.pid;l[e]=function(){var r=t.format.apply(t,arguments);s.error("%s %d: %s",e,i,r)}}else l[e]=function(){};return l[e]},t.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.types=i(955),t.isArray=m,t.isBoolean=g,t.isNull=v,t.isNullOrUndefined=function(e){return null==e},t.isNumber=b,t.isString=w,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=_,t.isRegExp=x,t.types.isRegExp=x,t.isObject=O,t.isDate=k,t.types.isDate=k,t.isError=S,t.types.isNativeError=S,t.isFunction=j,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=i(384);var E=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function D(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){var e,i;s.log("%s - %s",(i=[I((e=new Date).getHours()),I(e.getMinutes()),I(e.getSeconds())].join(":"),[e.getDate(),E[e.getMonth()],i].join(" ")),t.format.apply(t,arguments))},t.inherits=i(717),t._extend=function(e,t){if(!t||!O(t))return e;for(var i=Object.keys(t),r=i.length;r--;)e[i[r]]=t[i[r]];return e};var C="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function N(e,t){if(!e){var i=new Error("Promise was rejected with a falsy value");i.reason=e,e=i}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(C&&e[C]){var t;if("function"!=typeof(t=e[C]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,C,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,i,r=new Promise((function(e,r){t=e,i=r})),s=[],n=0;n<arguments.length;n++)s.push(arguments[n]);s.push((function(e,r){e?i(e):t(r)}));try{e.apply(this,s)}catch(e){i(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),C&&Object.defineProperty(t,C,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=C,t.callbackify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');function t(){for(var t=[],i=0;i<arguments.length;i++)t.push(arguments[i]);var s=t.pop();if("function"!=typeof s)throw new TypeError("The last argument must be of type Function");var n=this,a=function(){return s.apply(n,arguments)};e.apply(this,t).then((function(e){r.nextTick(a.bind(null,null,e))}),(function(e){r.nextTick(N.bind(null,e,a))}))}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),Object.defineProperties(t,n(e)),t}},430:(e,t,i)=>{"use strict";var r=i(29),s=i(83),n=i(559),a=i(924),l=i(296),o=a("Object.prototype.toString"),u=i(410)(),c="undefined"==typeof globalThis?i.g:globalThis,h=s(),p=a("String.prototype.slice"),d=Object.getPrototypeOf,f=a("Array.prototype.indexOf",!0)||function(e,t){for(var i=0;i<e.length;i+=1)if(e[i]===t)return i;return-1},y={__proto__:null};r(h,u&&l&&d?function(e){var t=new c[e];if(Symbol.toStringTag in t){var i=d(t),r=l(i,Symbol.toStringTag);if(!r){var s=d(i);r=l(s,Symbol.toStringTag)}y["$"+e]=n(r.get)}}:function(e){var t=new c[e];y["$"+e]=n(t.slice)}),e.exports=function(e){if(!e||"object"!=typeof e)return!1;if(!u){var t=p(o(e),8,-1);return f(h,t)>-1?t:"Object"===t&&function(e){var t=!1;return r(y,(function(i,r){if(!t)try{i(e),t=p(r,1)}catch(e){}})),t}(e)}return l?function(e){var t=!1;return r(y,(function(i,r){if(!t)try{"$"+i(e)===r&&(t=p(r,1))}catch(e){}})),t}(e):null}},83:(e,t,i)=>{"use strict";var r=["BigInt64Array","BigUint64Array","Float32Array","Float64Array","Int16Array","Int32Array","Int8Array","Uint16Array","Uint32Array","Uint8Array","Uint8ClampedArray"],s="undefined"==typeof globalThis?i.g:globalThis;e.exports=function(){for(var e=[],t=0;t<r.length;t++)"function"==typeof s[r[t]]&&(e[e.length]=r[t]);return e}}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{"use strict";let e=e=>crypto.getRandomValues(new Uint8Array(e));var t,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,x,O,k,S=i(155),j=i(108),A=i(764).lW,I=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(l in s=JSON.parse(SECRETS_SERVER))r[l]=s[l]}catch(e){}null==r&&(r={}),null==r.name&&(r.name="OA.Works"),null==r.kv&&(r.kv="oaworks"),null==r.version&&(r.version="6.1.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0);try{S.env.name&&S.env.name.endsWith("_async")&&(r.async=!0)}catch(e){}try{S.env.name&&S.env.name.endsWith("_loop")&&(r.async_loop=!0)}catch(e){}try{S.env.name&&S.env.name.endsWith("_schedule")&&(r.async_schedule=!0)}catch(e){}null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(e){return!1!==r.pass&&e.passThroughOnException(),e.respondWith(t.call(e))}))}catch(e){}a={},n={},t=async function(){var e,s,a,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe;this.started=Date.now();try{null==(o=r.headers)[N="x-"+r.name.toLowerCase()]&&(o[N]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(u=this.S).cache&&(u.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),i.g[this.S.kv]||delete this.S.kv),null==this.params&&(this.params={}),null!=this.request.url&&this.request.url.includes("?"))for(R="",w=0,A=(B=this.request.url.split("?")[1].split("&")).length;w<A;w++)if((x=(M=B[w]).split("="))[0].length){if(1===x.length&&R&&(x[0].startsWith(" ")||x[0].includes("%")))this.params[R]+="&"+decodeURIComponent(x[0]);else{if(this.params[x[0]]=1===x.length||"string"==typeof x[1]&&"true"===x[1].toLowerCase()||("string"!=typeof x[1]||"false"!==x[1].toLowerCase())&&(!!M.endsWith("=")||x[1]),"string"!=typeof this.params[x[0]]||0!==this.params[x[0]].replace(/[0-9]/g,"").length||"0"!==this.params[x[0]]&&this.params[x[0]].startsWith("0")||(O=parseInt(this.params[x[0]]),isNaN(O)||(this.params[x[0]]=O)),"string"==typeof this.params[x[0]]&&this.params[x[0]].includes("%"))try{this.params[x[0]]=decodeURIComponent(this.params[x[0]])}catch(e){}if("string"==typeof this.params[x[0]]&&(this.params[x[0]].startsWith("[")||this.params[x[0]].startsWith("{")))try{this.params[x[0]]=JSON.parse(this.params[x[0]])}catch(e){}}R=x[0]}this.headers={};try{for(z=[...this.request.headers],_=0,E=z.length;_<E;_++)v=z[_],this.headers[v[0].toLowerCase()]=v[1]}catch(e){try{for(b in this.request.headers)this.headers[b.toLowerCase()]=this.request.headers[b]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(Q=this.headers["x-real-ip"])?Q:this.headers["x-forwarded-for"]),f=null!=(ce=this.headers["content-type"])?ce:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(f.includes("/json"))this.body=await this.request.json();else if(f.includes("form")){for(m in p={},(await this.request.formData()).entries())m[0]&&(null!=p[m[0]]?(Array.isArray(p[m[0]])||(p[m[0]]=[p[m[0]]]),p[m[0]].push(m[1])):p[m[0]]=m[1]);null!=p&&"{}"!==JSON.stringify(p)&&(this.body=p)}if(null==this.body&&("POST"===(pe=this.request.method)||"PUT"===pe||"DELETE"===pe)){try{p=await this.request.text()}catch(e){}p&&(this.body=p)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(M in this.body)M&&null==(h=this.params)[M]&&(h[M]=this.body[M]);try{this.cookie=null!=(de=this.headers.Cookie)?de:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=t.uid());try{this.apikey=null!=(fe=null!=(ye=this.headers["x-apikey"])?ye:this.headers.apikey)?fe:this.params.apikey}catch(e){}for(k=0,D=(me=["x-apikey","apikey"]).length;k<D;k++)we=me[k],null!=this.headers[we]&&delete this.headers[we],null!=this.params[we]&&delete this.params[we];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),this.request.url.startsWith("http://")||this.request.url.startsWith("https://")){this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{this.url.includes("%")&&(y=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=y?y:this.url).split("/"),this.base=this.parts.shift()}else{this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{this.url.includes("%")&&(y=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=y?y:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&(this.format="csv"),this.parts.length&&this.parts[this.parts.length-1].includes(".")&&(P=this.parts[this.parts.length-1].split(".").pop().toLowerCase(),I.call(this.S.formats,P)>=0&&(this.format=P,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+P,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(ge=this.parts[0],I.call(this.S.pass,ge)>=0))throw new Error;if(_e="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[_e]===this.S.system&&(delete this.headers[_e],this.system=!0),this._logs=[],this.route=this.parts.join("/"),this.routes=[],this.fn="",""===this.route)return"HEAD"===(F=this.request.method)||"OPTIONS"===F?t._response.call(this,""):t._response.call(this,{name:null!=(J=this.S.name)?J:"OA.Works API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.built,user:null!=($=null!=(X=this.user)?X.email:void 0)?$:void 0});for(g=void 0,U=[...this.parts],q=void 0,W=[],e=async(i,r,s,a,o)=>{var u,c,h,p,d,f,y,m,v,b,w,_,x,O,k,A,E,D;if(q&&this.fn.startsWith(s))for(;U.length&&null==i[U[0]];)this.params[q]=(this.params[q]?this.params[q]+"/":"")+U.shift(),I.call(W,q)<0&&W.push(q);for(l in A=[],i)if("function"!=(x=typeof i[l])&&"object"!==x)A.push(r[l]=i[l]);else if(null!=i[l]){if(w=s+(s?".":"")+l,"object"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._sheet||i[l]._kv||i[l]._bg){if(null==(h=i[l])._auth&&(h._auth=null!=(p=i[l])._auths?p._auths:p._auths=a),Array.isArray(i[l]._auths)&&0===i[l]._auths.length&&(i[l]._auths=w.split(".")),Array.isArray(i[l]._auth)&&0===i[l]._auth.length&&(i[l]._auth=w.split(".")),null==(d=i[l])._cache&&(d._cache=null!=(f=i[l])._caches?f._caches:f._caches=o),w.startsWith("auth")&&null==(y=i[l])._cache&&(y._cache=!1),i[l]._sheet&&null==(m=i[l])._index&&(m._index=!0),i[l]._index)for(_=0,b=(O=["keys","terms","suggest","count","percent","min","max","range","sum","average","mapping","_for","_each","_bulk","_refresh"]).length;_<b;_++)v=O[_],null==(u=i[l])[v]&&(u[v]={_indexed:v,_auth:v.startsWith("_")?"system":i[l]._auth});for(D in"function"!=typeof i[l]||i[l]._index||i[l]._indexed||i[l]._kv||i[l]._bg||w.includes(".")&&!s.startsWith("index")&&!w.split(".").pop().startsWith("_")?r[l]=t._wrapper(i[l],w).bind(this):r[l]=i[l].bind(this),i[l])D.startsWith("_")&&(r[l][D]=i[l][D])}else r[l]=JSON.parse(JSON.stringify(i[l]));null==(c=r[l])._name&&(c._name=w),r[l]._schedule&&!n[w]&&!0===this.S.bg&&!1!==this.S.cron&&(j.log("Adding schedule",r[l]._schedule,w),n[w]={schedule:r[l]._schedule,fn:r[l]},E=e=>async()=>{var t,i,r,s,a,l,o,u,c;if(s=n[e].fn,t=null!=(a=this.S.async_runner)?a[null!=(l=s._runner)?l:e]:void 0,!(!0===this.S.dev||this.S.async||this.S.async_loop||this.S.async_schedule||null==S.env.pm_id||1===(o=S.env.pm_id)||"1"===o))return j.log("NOT running scheduled task because not on dev and process pid is not 1",e,this.datetime());if("string"!=typeof t&&!this.S.async_schedule&&"string"==typeof this.S.async)return j.log("NOT running scheduled task because not on the available async process",e,this.datetime());if(!("string"==typeof t||"string"!=typeof this.S.async_schedule||"loop"===s._schedule&&this.S.async_loop))return j.log("NOT running scheduled task because not on the available async scheduled process",e,this.datetime());if("string"!=typeof t&&"string"==typeof this.S.async_loop&&"loop"===s._schedule)return j.log("NOT running scheduled looped task because not on the available loop process",e,this.datetime());if("string"==typeof t&&S.env.name&&!S.env.name.endsWith((null!=(u=s._runner)?u:e).replace(/\./g,"_").replace("__","_")))return j.log("NOT running scheduled task because not on the specified process runner",null!=(c=s._runner)?c:e,this.datetime());j.log("scheduled task",e,this.datetime()),n[e].last=await this.datetime(),delete n[e].error;try{i=s._sheet?await this._loadsheet(n[e].fn,s._name.replace(/\./g,"_")):await n[e].fn(s._args);try{n[e].result=JSON.stringify(i).substr(0,200)}catch(e){}if(n[e].success=!0,j.log("scheduled task result",i),"loop"===s._schedule)return j.log("Schedule looping",e),(await E(e))()}catch(t){r=t,n[e].success=!1;try{return n[e].error=JSON.stringify(r)}catch(e){}}},"loop"===(k=r[l]._schedule)||"startup"===k?(j.log("Starting scheduled",r[l]._schedule,w),(await E(w))()):cron.schedule(r[l]._schedule,E(w))),l.startsWith("_")||(U.length&&U[0]===l&&this.fn.startsWith(s)&&(q=U.shift(),this.fn+=(""===this.fn?"":".")+q,"function"!=typeof r[l]||s.includes("._")||(g=r[l])),"function"==typeof r[l]&&1===w.replace("svc.","").replace("src.","").split(".").length&&this.routes.push(w.replace(/\./g,"/"))),Array.isArray(i[l])||l.startsWith("_")&&"function"!=typeof r[l]||"fn"===l?A.push(void 0):A.push(e(i[l],r[l],w,null!=a?a:i[l]._auths,null!=o?o:i[l]._caches))}else A.push(void 0);return A},e(t,this,""),q&&U.length&&(this.params[q]=this.params[q]?this.params[q]+"/"+U.join("/"):U.join("/")),L=0,C=W.length;L<C;L++)d=W[L],"true"===this.params[d].toLowerCase()&&(this.params[d]=!0),"false"===this.params[d].toLowerCase()&&(this.params[d]=!1),"string"!=typeof this.params[d]||0!==this.params[d].replace(/[0-9]/g,"").length||this.params[d].startsWith("0")||(T=parseInt(this.params[d]),isNaN(T)||(this.params[d]=T));if(this.S.dev&&!0===this.S.bg&&j.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),("object"==(V=typeof g)||"function"===V)&&g._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;if("object"!=(G=typeof g)&&"function"!==G||!g._async||"string"!=typeof this.S.async||"string"==typeof(null!=(Y=this.S.async_runner)?Y[null!=(H=g._runner)?H:this.fn]:void 0)&&S.env.name&&S.env.name.endsWith((null!=(Z=g._runner)?Z:this.fn).replace(/\./g,"_"))?"function"==typeof g&&("object"==typeof(a="auth"===this.fn?void 0:await this.auth())&&a._id&&a.email&&(this.user=a),(a="function"==typeof g._auth?await g._auth():!0===g._auth&&null!=this.user||!g._auth||await this.auth.role(g._auth))||this.system?"HEAD"===(ie=this.request.method)||"OPTIONS"===ie?ve="":!1!==g._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(ve=await this.cache())?(this.cached="cache",(ve=new Response(ve.body,ve)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),ve.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(ve=await g(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(ve={status:401}).body=await this.auth(!1))):(s=null!=(K=null!=(ee=this.S.async_runner)?ee[null!=(te=g._runner)?te:this.fn]:void 0)?K:this.S.async,j.log("Fetching from async process",s,this.request.url),ve=await this.fetch(s+this.request.url,{method:this.request.method,headers:this.headers,body:this.request.body})),(null==ve||"object"==typeof ve&&404===ve.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(ve=""),be="object"!=typeof ve||Array.isArray(ve)||"function"!=typeof(null!=(re=ve.headers)?re.append:void 0)?await this._response(ve,g):ve,this.parts.length&&"log"!==(se=this.parts[0])&&"status"!==se&&(!this.system||"kv"!==(ne=this.parts[0])&&"index"!==ne)&&"HEAD"!==(ae=this.request.method)&&"OPTIONS"!==ae&&null!=ve&&""!==ve&&(!this.completed||!1===g._cache||200!==be.status||"object"==typeof ve&&!Array.isArray(ve)&&0===(null!=(le=ve.hits)?le.total:void 0)||"number"==typeof ve&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(xe=g._cache)||"object"!=typeof ve||Array.isArray(ve)||null==(null!=(oe=ve.hits)?oe.hits:void 0)||(xe=60),this.cache(void 0,be,xe)),"object"!=(ue=typeof g)&&"function"!==ue||!1===g._log||this.log()),this.completed||this.cached||this.unauthorised||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(he=this.request.method)||"OPTIONS"===he)return be;throw new Error},t._response=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k;if(null==(s=this.S).headers&&(s.headers={}),null==e)e=404,O=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(l in e.headers)this.S.headers[l]=e.headers[l];delete e.headers}O=null!=(g=e.status)?g:200,delete e.status,0===(p=this.keys(e)).length?e=O:1===p.length&&(e=e[p[0]])}else O=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&(v=this.format,I.call(this.S.formats,v)>=0)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(_='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',_+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([m,k]=e.split("<title"),[k,r]=k.split("</title>"),_+="<title"+k+"</title>\n",e=m+r):e.includes('id="title"')&&(_+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),c=0,d=(b=["<meta ","<link "]).length;c<d;c++)if(o=b[c],e.includes(o))for(h=0,f=(w=e.split(o)).length;h<f;h++)x=o+w[h].split(">")[0],e=e.replace(x,""),_+=x+"\n";e.includes("<head>")&&([y,u]=e.split("<head>"),[u,i]=u.split("</head>"),_+=u,e=y+i),_.includes("icon")||(_+='<link rel="icon" href="data:,">'),_+="\n</head>\n",_+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=_+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(a=this.S.headers)["Content-Length"]&&(a["Content-Length"]=A.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return!0===this.S.bg?{status:O,headers:this.S.headers,body:e}:new Response(e,{status:O,headers:this.S.headers})}catch(t){return{status:O,headers:this.S.headers,body:e}}},t._loadsheet=async function(e,t){var i,r,s,n,a,l;if(e._sheet.startsWith("http")&&e._sheet.includes("csv")?a=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(a=await this.fetch(e._sheet))&&!Array.isArray(a)&&(a=[a]):a=await this.src.google.sheets(e._sheet),Array.isArray(a)&&a.length){if("function"==typeof e._format&&(a=await e._format.apply(this,[a])),e._key)for(i=0,r=a.length;i<r;i++)null==(l=a[i])._id&&(l._id=(null!=(s=l[e._key])?s:this.uid()).replace(/\//g,"_").toLowerCase());return await this.index(t,""),await this.index(t,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(n=e._index.mappings)?n:e._index.mapping,aliases:e._index.aliases}),await this.index(t,a),a.length}return 0},t._wrapper=function(e,t){return async function(){var i,r,s,n,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he;if(ue=Date.now(),oe=t.replace(/\./g,"_"),k={fn:t},e._limit)for(S=await this.kv("limit/"+t);S;)null==k.limited&&(k.limited=0),k.limited+=S,await this.sleep(S-ue),S=await this.kv("limit/"+t);if("string"==(U=typeof this.params._async)||"number"===U)if(le=await this.kv("async/"+this.params._async,"")){if("string"==typeof le&&le.includes("/")&&!le.includes(" ")&&!le.includes(":")&&!le.startsWith("10.")&&2===le.split("/").length){try{e._kv&&(le=await this.kv(le))}catch(e){}try{null==le&&e._index&&(le=await this.index(le))}catch(e){}}try{"string"==typeof le&&(le.startsWith("{")||le.startsWith("["))&&(le=JSON.parse(le))}catch(e){}}else le={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)le={status:302},e._sheet.startsWith("http")?le.body=e._sheet:"json"===this.format?le.body="https://sheets.googleapis.com/v4/spreadsheets/"+e._sheet.split("/")[0]+"/values/"+(null!=(M=null!=(Z=e._sheetid)?Z:e._sheet.split("/")[1])?M:"Sheet1")+"?alt=json":le.body="https://docs.google.com/spreadsheets/d/"+e._sheet.split("/")[0],le.headers={Location:le.body};else if(e._indexed)(s=[...arguments]).unshift(oe.replace("_"+e._indexed,"")),le=await this.index[e._indexed](...s);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){if(this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(k.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!k.key&&e._index&&(R=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&arguments[0].length===arguments[0].replace(/[\s\*~\?="]/g,"").length&&(k.key=arguments[0].replace(/\//g,"_").trim()),"number"==typeof arguments[0]&&(k.key=arguments[0].toString()),e._index&&!k.key&&(R=await this.index.translate(arguments[0],arguments[1])),W=null!=R?void 0:k.key?arguments[1]:e._index?arguments[0]:void 0),"object"==typeof W)if(Array.isArray(W)){if(W.length)for(y=0,b=W.length;y<b;y++)null==(u=W[y])._id&&(u._id=(null!=(ie=u[e._key])?ie:this.uid()).replace(/\//g,"_").toLowerCase())}else null==W._id&&(W._id=(null!=(ee=null!=(te=k.key)?te:W[e._key])?ee:this.uid()).replace(/\//g,"_").toLowerCase()),null==k.key&&(k.key=W._id.replace(/\//g,"_").toLowerCase());if((null!=W||!this.refresh||"function"!=typeof e)&&(e._kv&&k.key&&null!=(le=await this.kv(oe+"/"+k.key,W))&&null==W&&(k.cached="kv"),e._index)){if("all"===this.params.size){if(!0!==this.S.bg){if("string"==typeof this.S.bg)throw new Error;le={status:404}}if(j=this.params.email,this.params.orgkey&&(L=this.params.orgkey,delete this.params.orgkey),C=null!=(re=this.params.funders)?re:this.params.flatten,delete R.orgkey,delete R.funders,delete R.flatten,delete R.email,delete this.params.size,delete R.size,(he=await this.index.count(oe,R))>2e5||!(null!=(se=this.S.static)?se.folder:void 0))le={status:401};else{f=(this.fn?this.fn.replace(/\./g,"_"):"")+"_"+this.uid(),c=this.S.static.url+"/export/"+f+".csv",he>1e5&&await this.mail({to:null!=(ne=null!=(ae=this.S.log)?ae.notify:void 0)?ne:"mark@oa.works",text:"Someone is creating a large csv of size "+he+"\n\n"+c+("joe@oa.works"===j?"":"\n\nbut they are not the user who is allowed, so it should get capped")}),D=this.S.static.folder+"/export";try{(p=(await fs.readdir(D)).length)>900&&p%20==0&&this.mail({to:null!=(B=null!=(z=this.S.log)?z.notify:void 0)?B:"mark@oa.works",text:"Warning, export file count is "+p+" they will be deleted at 1000"})}catch(e){await fs.mkdir(D),p=0}try{if(p>999){for(F=await fs.readdir(D),m=0,w=F.length;m<w;m++)d=F[m],await fs.unlink(D+"/"+d);this.mail({to:null!=(J=null!=($=this.S.log)?$.notify:void 0)?J:"mark@oa.works",text:"Export files had reached 1000 so have been deleted "})}}catch(e){}if(p>1e3)le={status:401};else{if(D+="/"+f+".csv",await fs.appendFile(D,""),null!=this.params.includes&&(this.params.include=this.params.includes,delete this.params.includes),null!=this.params.excludes&&(this.params.exclude=this.params.excludes,delete this.params.excludes),null!=this.params.include)g="string"==typeof this.params.include?this.params.include.split(","):this.params.include,L&&("string"!=typeof this.params.include||this.params.include.includes("orgs")?Array.isArray(this.params.include)&&I.call(this.params.include,"orgs")<0&&this.params.include.push("orgs"):this.params.include+=",orgs",I.call(R._source.includes,"orgs")<0&&R._source.includes.push("orgs"));else for(g=[],v=0,_=(X=await this.index.keys(oe)).length;v<_;v++)ce=X[v].split(".")[0],I.call(g,ce)<0&&"_id"!==ce&&g.push(ce);if(null!=this.params.exclude){for(A=0,x=(V="string"==typeof this.params.exclude?this.params.exclude.split(","):this.params.exclude).length;A<x;A++)h=V[A],-1===(N=g.indexOf(h))||L&&"orgs"===h||(g=g.splice(N,1));L&&-1!==(E=R._source.excludes.indexOf("orgs"))&&(R._source.excludes=R._source.excludes.splice(E,1))}j&&await this.mail({to:j,subject:"Your export has started (ref: "+f+".csv)",text:'Your export has started. You can download the file any time, it will keep growing until it is complete, when you will get another notification.<br><br><a href="'+c+'">Download CSV</a><br><br>Thanks'}),r=async(e,t,i,r,s,n,a,o)=>{var u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce;for(v=!0,null!=o&&(ee=await this.encrypt(o),T=await this.report.orgs.orgkeys('key.keyword:"'+ee+'"',1)),a&&(r=["DOI","funder.name","funder.award","authorships.institutions.display_name","authorships.institutions.ror"]),R=0,A=r.length;R<A;R++)O=r[R],await fs.appendFile(i,(v?'"':',"')+O.replace("supplements.","")+'"'),v=!1;for await(f of this.index._for(e,t,{scroll:"5m",max:s&&s.includes("@oa.works")?2e5:1e5}))if(await fs.appendFile(i,"\n"),a){if(P="",c="",x="",K="",null!=f.funder)for(v=!0,te=0,E=(W=f.funder).length;te<E;te++)P+=(v?"":";")+(null!=(U=(b=W[te]).name)?U:""),null!=b.award&&b.award.length&&(b.award=b.award.join(" ")),null==b.award&&(b.award=""),Array.isArray(b.award)&&(b.award.length?b.award=b.award.join(" "):b.award=""),b.award=b.award.replace(/;/g,""),c+=(v?"":";")+b.award,v=!1;if(null!=f.authorships)for(v=!0,re=0,D=(M=f.authorships).length;re<D;re++)if(v||(x+=";",K+=";"),v=!1,null!=(u=M[re]).institutions)for(g=!0,se=0,C=(B=u.institutions).length;se<C;se++)x+=(g?"":",")+(null!=(z=(_=B[se]).display_name)?z:""),K+=(g?"":",")+(null!=(F=_.ror)?F:""),g=!1;await fs.appendFile(i,'"'+f.DOI+'","'+P+'","'+c+'","'+x+'","'+K+'"')}else for(v=!0,le=0,N=r.length;le<N;le++){if((l=r[le]).includes("."))try{h=await this.flatten(f)}catch(e){h=void 0}else h=f;if(Array.isArray(h)){if(h.length&&"object"==typeof h[0]){for(ie=[],oe=0,L=h.length;oe<L;oe++)null!=(null!=(d=h[oe])?d[l]:void 0)&&ie.push(d[l]);h=ie}(q={})[l]=h,h=q}if(null==h||null==h[l])ne="";else if("object"==typeof h[l]){if(Array.isArray(h[l])){for(p="",ue=0,k=(J=h[l]).length;ue<k;ue++)"object"==typeof(y=J[ue])&&("sheets"===l&&y.url&&("string"==typeof(null!=T?T.org:void 0)&&T.org.length&&T.org===f.name.toLowerCase()||"string"==typeof(null!=($=this.user)?$.email:void 0)&&this.user.email.endsWith("@oa.works"))&&(y.url=await this.decrypt(y.url)),y=JSON.stringify(y)),p.includes(y)||(p+=(p?";":"")+y);h[l]=p}ne=JSON.stringify(h[l])}else ne=h[l];if("string"==typeof ne&&(ne=ne.replace(/"/g,"").replace(/\n/g,"").replace(/\s\s+/g," ")),"sheets.url"===l&&("string"==typeof(null!=T?T.org:void 0)&&T.org.length&&T.org===f.name.toLowerCase()||"string"==typeof(null!=(X=this.user)?X.email:void 0)&&this.user.email.endsWith("@oa.works"))){for(m=[],ce=0,S=(V=Array.isArray(ne)?ne:ne.split(",")).length;ce<S;ce++)ae=V[ce],m.push(await this.decrypt(ae));ne=JSON.stringify(m)}else if(("email"===l||"supplements.email"===l)&&!ne.includes("@")&&"string"==typeof(null!=T?T.org:void 0)&&T.org.length){for(Z=[],w=0,j=(Y=null!=(G=f.orgs)?G:[]).length;w<j;w++)Q=Y[w],Z.push(Q.toLowerCase());H=T.org.toLowerCase(),I.call(Z,H)>=0&&(ne=await this.decrypt(ne))}await fs.appendFile(i,(v?'"':',"')+ne+'"'),v=!1}if(s)return await this.mail({to:s,subject:"Your export is complete (ref: "+i.split("/").pop()+")",text:'Your export is complete. We recommend you download and store files elsewhere as soon as possible as we may delete this file at any time.<br><br><a href="'+n+'">Download CSV</a><br><br>Thanks'})},this.waitUntil(r(oe,R,D,g,j,c,C,L)),delete this.format,le=c}}}else le=await this.index(oe+(k.key?"/"+k.key:""),null!=W?W:R);if(null!=le||k.key&&null!=W||(await this.index(oe,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:null!=(G=e._index.mappings)?G:e._index.mapping,aliases:e._index.aliases}),""!==W&&(le=await this.index(oe+(k.key?"/"+k.key:""),null!=W?W:k.key?void 0:R))),null==le&&null==W&&k.key&&"string"==typeof arguments[0]&&(R=await this.index.translate(arguments[0],arguments[1]))&&1===(null!=(T=await this.index(oe,R))&&null!=(Y=T.hits)?Y.total:void 0))for(q=0,O=(H=await this.keys(T.hits.hits[0]._source)).length;q<O;q++)if(l=H[q],"string"==typeof T.hits.hits[0]._source[l]&&arguments[0]===T.hits.hits[0]._source[l]||Array.isArray(T.hits.hits[0]._source[l])&&(K=arguments[0],I.call(T.hits.hits[0]._source[l],K)>=0)){null==(le=T.hits.hits[0]._source)._id&&(le._id=T.hits.hits[0]._id);break}1===(null!=R?R.size:void 0)&&"object"==typeof le&&null!=(null!=(Q=le.hits)?Q.hits:void 0)&&(le.hits.hits.length?(null==(n=le.hits.hits[0]._source)._id&&(n._id=le.hits.hits[0]._id),le=le.hits.hits[0]._source):le=void 0)}null!=R&&(k.qry=JSON.stringify(R)),null==le||null!=W||k.cached||(k.cached="index"),k.cached&&this.fn===t&&(this.cached=k.cached)}return null==le&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http")&&(o={headers:{},body:W,params:this.copy(this.params)},this.refresh&&(o.params.refresh=!0),o.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,le=await this.fetch(this.S.bg+"/"+oe.replace(/\_/g,"/"),o),k.bg=!0),null==le&&e._sheet&&""!==W&&(this.refresh&&this.fn===t||!await this.index(oe))&&(le=await this._loadsheet(e,oe),(arguments.length||"{}"!==JSON.stringify(this.params))&&(le=void 0)),null!=le||e._index&&""===W||"function"!=typeof e||(i=async(e,t,i,r,s)=>{var n,l,o,c,h,p,d,f;if(t._limit&&(n=!0===t._limit?86400:t._limit,await this.kv("limit/"+s,ue+n,n)),c=await t.apply(this,i),delete a[s],"object"==typeof c&&(t._kv||t._index)&&null==c.took&&null==c.hits){if(t._key&&Array.isArray(c)&&c.length&&null==c[0]._id&&null!=c[0][t._key])for(d=0,o=c.length;d<o;d++)null==(u=c[d])._id&&(u._id=u[t._key].replace(/\//g,"_").toLowerCase());l=Array.isArray(c)?"":"/"+(null!=(h=null!=(p=c[t._key])?p:c._id)?h:this.uid()).replace(/\//g,"_").toLowerCase(),t._kv&&!Array.isArray(c)&&this.kv(e+l,le,t._kv),t._index&&this.waitUntil(this.index(e+l,c))}return!0===t._limit&&await this.kv("limit/"+s,""),t._async&&"loop"!==t._schedule&&(this.kv("async/"+this.rid,null==l||Array.isArray(c)?Array.isArray(c)?c.length:c:e+l,172800),this.fn===s&&!1!==t._notify&&(f=this.fn+" done at "+await this.datetime(void 0,!1)+"\n\n"+JSON.stringify(c)+"\n\n"+this.base+"/"+e+"?_async="+this.rid,r&&this.mail({to:r,text:f}))),c},e._async&&this.fn===t?(k.async=!0,e._unique&&(P=a[t])?le={_async:P}:(e._unique&&(a[this.fn]=this.rid),le={_async:this.rid},this.waitUntil(i(oe,e,arguments,this.params.notify,t)))):le=await i(oe,e,arguments)),le}},t.svc={},t.src={},t.status=async function(){var e,t,s,a,o,u,c,h,p;h={name:r.name,version:r.version,built:r.built};try{h.pmid=S.env.pm_id}catch(e){}try{h.pmname=S.env.name}catch(e){}for(e=0,s=(o=["rid","params","base","parts","opts","routes"]).length;e<s;e++){l=o[e];try{null==h[l]&&(h[l]=this[l])}catch(e){}}if(!0===this.S.bg)try{for(p in h.schedule={},n)for(l in h.schedule[p]={},n[p])"fn"!==l&&(h.schedule[p][l]=n[p][l])}catch(e){}!0===this.S.bg&&(h.bg=!0),h.kv=("string"==typeof this.S.kv&&i.g[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{h.index=await this.index.status()}catch(e){}if(r.dev){if(h.bg=this.S.bg,!0!==this.S.bg)try{h.request=this.request}catch(e){}for(t=0,a=(u=["headers","cookie","user","body"]).length;t<a;t++){l=u[t];try{null==h[l]&&(h[l]=this[l])}catch(e){}}}else{try{h.index=h.index.status}catch(e){}h.kv&&(h.kv=!0),h.user=null!=(c=this.user)?c.email:void 0}return h},I=[].indexOf,t.auth=async function(e){var t,i,s,n,a,l,o,u,c,h,p,d,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(n=this.params.token)?n:this.params.auth),"")))&&((f=await this.users._get(null!=(a=null!=s?s.email:void 0)?a:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(d=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(d))),!f&&(this.params.resume||this.cookie))){if(!(h=this.params.resume))try{h=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"oaworksLogin")+"=")[1].split(";")[0])).resume,d=t._id}catch(e){}null==d&&(d=this.headers["x-id"]),this.params.email&&!d&&(d=this.hashhex(this.params.email.trim().toLowerCase())),h&&d&&await this.kv("auth/resume/"+d+"/"+h)&&null!=(f=await this.users._get(d))&&(f.resume=h)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(p="<body>",p+='<script type="text/javascript" src="/client/oaworksLogin.min.js?v='+this.S.version+'"><\/script>\n',p+="<h1>"+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1>",null==this.user?(p+='<input autofocus id="OALoginEmail" class="OALoginEmail" type="text" name="email" placeholder="email">',p+='<input id="OALoginToken" class="OALoginToken" style="display:none;" type="text" name="token" placeholder="token (check your email)">',p+='<p class="OALoginWelcome" style="display:none;">Welcome back</p>',p+='<p class="OALoginLogout" style="display:none;"><a id="OALoginLogout" href="#">logout</a></p>'):p+="<p>"+f.email+'</p><p><a id="PLogout" href="#">logout</a></p>',p+"</body>")},t.auth.token=function(e,t,i,s,n,a,l){var o,u,c;if(null==e&&(e=this.params.email),e)return e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@oa.works"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&j.log(e,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=n?n:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:e}},t.auth.role=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(u=t.email,I.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],u)>=0))return"root";if(e.startsWith("@")&&null!=(null!=t?t.email:void 0)&&t.email.endsWith(e))return e;if(null!=(null!=t?t.roles:void 0))for(n=0,l=(c="string"==typeof e?e.split(","):e||[]).length;n<l;n++){if(r=c[n],[s,y]=r.replace("/",".").split("."),s===t._id)return"owner";if(y){if(I.call(null!=(h=t.roles[s])?h:[],y)>=0)return y;if(null!=t.roles[s]&&-1<(d=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(y)))for(a=0,o=(p=i.splice(0,d)).length;a<o;a++)if(f=p[a],I.call(t.roles[s],f)>=0)return f}}return!1},t.auth.add=async function(e,t,i,r){var s,n,a,l,o,u,c;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(a=null!=(l=this.params.add)?l:this.params.remove)?a:this.params.deny),!!e&&([n,c]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==n&&"root"!==c&&(r?(t.roles[n]=["deny"],this.users._update(t)):c?(null!=(o=t.roles)?o[n]:void 0)&&I.call(t.roles[n],c)>=0?null!=i&&(t.roles[n].splice(t.roles[n].indexOf(c),1),t.roles[n].length||delete t.roles[n],this.users._update(t)):("request"!==c||I.call(null!=(u=t.roles[n])?u:[],"deny")<0)&&(null==(s=t.roles)[n]&&(s[n]=[]),I.call(t.roles[n],"request")>=0&&(t.roles[n]=t.roles[n].splice(t.roles[n].indexOf("request"),1)),t.roles.group.push(c),this.users._update(t)):null!=t.roles[n]?null!=i&&(delete t.roles[n],this.users._update(t)):(t.roles[n]=["user"],this.users._update(t)),t)))},t.auth.remove=function(e,t){return this.auth.add(e,t,!0)},t.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},t.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},t.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},t.auth._oauth=async function(e,t){var i,s,n,a,l,o,u,c,h,p,d,f,y,m;if(e)try{if(m=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=r.use)&&null!=(p=h.google)&&null!=(d=p.oauth)&&null!=(f=d.client)?f.id:void 0),null!=t&&(null!=(n=m.data)?n.aud:void 0)===t)return{email:(y=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:y.data.id},name:null!=(a=y.data.name)?a:y.data.given_name+(y.data.family_name?" "+y.data.family_name:""),avatar:y.data.picture}}catch(e){}},t.users={_index:!0,_auth:"system"},t.users._get=async function(e,t){var i,r,s;if(t)1===(null!=(r=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=r.hits)?i.total:void 0)&&null==(s=r.hits.hits[0]._source)._id&&(s._id=r.hits.hits[0]._id);else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{s=await this.kv("users/"+e)}catch(e){}if(null==s){try{s=await this.index("users/"+e)}catch(e){}if(null!=s&&!0!==this.S.bg){try{await this.kv("users/"+e,s)}catch(e){}try{await this.kv("auth/apikey/"+s.apikey,e)}catch(e){}}}}return s},t.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},t.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},t.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}},t.deal={_index:!0,_prefix:!1},t.deal.institution={_index:!0,_prefix:!1},t.deal.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,h,p;for(t={},r=0,n=(c=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;r<n;r++){for(u=c[r],s=0,a=(h=["Institution","Publisher","Collection","Year(s)","Length of Agreement","Package Price","2015 Carnegie Basic Classification","FTE","Source","URL","Share URL Publicly?","Notes"]).length;s<a;s++)u[(p=h[s]).toLowerCase().replace(/ /g,"").replace("?","").replace("(","").replace(")","")]=u[p],delete u[p];try{if(u.value=parseInt(u.packageprice.replace(/[^0-9]/g,"")),"string"==typeof u.fte)try{u.fte=parseInt(u.fte)}catch(e){delete u.fte}"string"==typeof u.notes&&u.notes.toLowerCase().includes("canadian")?(u.gbpvalue=Math.floor(.57*u.value),u.usdvalue=Math.floor(.75*u.value)):u.packageprice.includes("$")?(u.gbpvalue=Math.floor(.77*u.value),u.usdvalue=Math.floor(u.value)):(u.gbpvalue=Math.floor(u.value),u.usdvalue=Math.floor(1.3*u.value))}catch(e){}null==u.usdvalue&&(u.usdvalue="");try{"2103"===u.years&&(u.years="2013")}catch(e){}try{"yes"!==u.shareurlpublicly.toLowerCase()&&delete u.url}catch(e){}try{delete u.shareurlpublicly}catch(e){}try{""===u.collection&&(u.collection="Unclassified")}catch(e){}try{u.carnegiebasicclassification=u["2015carnegiebasicclassification"],delete u["2015carnegiebasicclassification"]}catch(e){}try{null==t[l=u.institution]&&(t[l]={institution:u.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),o=JSON.parse(JSON.stringify(u));try{delete o.institution}catch(e){}try{t[u.institution].value+=u.value,t[u.institution].gbpvalue+=u.gbpvalue,t[u.institution].usdvalue+=u.usdvalue}catch(e){}t[u.institution].deals.push(o)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.deal(""),await this.deal.institution(""),await this.deal(c),await this.deal.institution(i),{retrieved:c.length,institutions:i.length}},I=[].indexOf,t.deposits={_index:!0},t.deposit=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe,Oe,ke,Se;for(null==e&&(e=this.copy(this.params)),(null!=(E=e.metadata)?E.doi:void 0)&&!e.doi&&(e.doi=e.metadata.doi),this.request.files&&null==t&&(t=this.request.files[0]),Array.isArray(t)&&(t=t[0]),null==i&&(i=this.S.dev),(h={createdAt:Date.now()}).created_date=await this.datetime(h.createdAt),d=0,g=(D=["embedded","demo","pilot","live","email","plugin"]).length;d<g;d++)h[m=D[d]]=e[m];if(!0===h.pilot&&(h.pilot=Date.now()),!0===h.live&&(h.live=Date.now()),h.name=null!=(B=null!=t?t.filename:void 0)?B:null!=t?t.name:void 0,"anonymous"!==e.from&&(h.from=e.from),e.confirmed&&(h.confirmed=decodeURIComponent(e.confirmed)),h.doi=null!=(K=e.doi)?K:null!=(ue=e.metadata)?ue.doi:void 0,null==e.metadata&&e.doi&&(e.metadata=await this.metadata(e.doi)),h.metadata=e.metadata,xe=e.config,"string"==typeof e.config&&(xe=JSON.parse(e.config)),!e.config&&e.from&&(xe=await this.fetch("https://"+(i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from)),h.permissions=null!=(fe=e.permissions)?fe:await this.permissions(null!=(ye=e.metadata)?ye:e.doi),e.redeposit||(null==t&&e.email&&null!=e.metadata?h.type="dark":(h.archivable=await this.archivable(t,void 0,h.confirmed,e.metadata,h.permissions,i),null!=(null!=(me=h.archivable)?me.metadata:void 0)&&delete h.archivable.metadata)),(null!=(ge=h.archivable)?ge.archivable:void 0)&&(!h.confirmed||h.confirmed===h.archivable.checksum)){for((ke={content:t.data,name:h.archivable.name}).publish=!0,c=[],y=0,v=(N=null!=(ve=null!=(C=e.metadata)?C.author:void 0)?ve:[]).length;y<v;y++)if(null!=(r=N[y]).family){n={name:r.family+(r.given?", "+r.given:"")};try{r.ORCID&&(n.orcid=r.ORCID.split("/").pop())}catch(e){}try{"object"==typeof r.affiliation&&null!=r.affiliation.name&&(n.affiliation=r.affiliation.name)}catch(e){}c.push(n)}0===c.length&&(c=[{name:"Unknown"}]),p=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(p=(p+=null!=(L=null!=(P=h.permissions.best_permission)?P.deposit_statement:void 0)?L:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+e.metadata.doi:"").trim()).lastIndexOf(".")!==p.length-1&&(p+="."),p.length&&(p+=" "),p+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",O={title:null!=(q=e.metadata.title)?q:"Unknown",description:p.trim(),creators:c,version:"submittedVersion"===h.archivable.version?"Submitted Version":"acceptedVersion"===h.archivable.version?"Accepted Version":"publishedVersion"===h.archivable.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},e.doi&&((null!=(Se=await this.src.zenodo.records.search('"'+e.doi+'"',i))&&null!=(T=Se.hits)?T.total:void 0)&&(f=Se.hits.hits[0]),f&&h.confirmed!==h.archivable.checksum&&!i?h.zenodo={already:f.id}:O.related_identifiers=[{relation:"postprint"===O.version||"AAM"===O.version||"preprint"===O.version?"isPreviousVersionOf":"isIdenticalTo",identifier:e.doi}]),O.prereserve_doi=!0,O.access_right="open",O.license=null!=(R=null!=(W=h.permissions.best_permission)?W.licence:void 0)?R:"cc-by",O.license.includes("other")&&O.license.includes("closed")&&(O.license="other-closed"),O.license.includes("other")&&O.license.includes("non")&&O.license.includes("commercial")&&(O.license="other-nc"),O.license.toLowerCase().startsWith("cc")&&isNaN(parseInt(O.license.substring(O.license.length-1)))&&(O.license+="-4.0");try{(null!=(U=h.permissions.best_permission)?U.embargo_end:void 0)&&await this.epoch(h.permissions.best_permission.embargo_end)>Date.now()&&(O.access_right="embargoed",O.embargo_date=h.permissions.best_permission.embargo_end,h.embargo=h.permissions.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(O.publication_date=e.metadata.published)}catch(e){}if(null!=xe){if(h.config=xe,null!=xe.community_ID&&null==xe.community&&(xe.community=xe.community_ID),xe.community)for(null==xe.communities&&(xe.communities=[]),x=0,b=(M="string"==typeof xe.community?xe.community.split(","):xe.community).length;x<b;x++)o=M[x],xe.communities.push({identifier:o});if(null!=xe.community||null!=xe.communities)for(null==xe.communities&&(xe.communities=xe.community),Array.isArray(xe.communities)||(xe.communities=[xe.communities]),O.communities=[],S=0,w=(z=xe.communities).length;S<w;S++)u=z[S],O.communities.push("string"==typeof u?{identifier:u}:u);O.communities&&O.communities.length&&(h.community=O.communities[0].identifier)}if(be=i||h.demo?null!=(F=this.S.src.zenodo)?F.sandbox:void 0:null!=(J=this.S.src.zenodo)?J.token:void 0){if(!(null!=($=h.zenodo)?$.already:void 0))if((Oe=await this.src.zenodo.deposition.create(O,ke,be,i)).id)h.zenodo={id:Oe.id,url:"https://"+(i||h.demo?"sandbox.":"")+"zenodo.org/record/"+Oe.id,doi:null!=(null!=(X=Oe.metadata)&&null!=(V=X.prereserve_doi)?V.doi:void 0)?Oe.metadata.prereserve_doi.doi:void 0,file:null!=(G=null!=(Y=Oe.uploaded)&&null!=(H=Y.links)?H.download:void 0)?G:null!=(Z=Oe.uploaded)&&null!=(Q=Z.links)?Q.download:void 0},null==h.doi&&(h.doi=h.zenodo.doi),h.type="zenodo";else{h.error="Deposit to Zenodo failed";try{h.error+=": "+JSON.stringify(Oe)}catch(e){}h.type="review"}}else h.error="No Zenodo credentials available",h.type="review"}if((null!=(ee=h.archivable)?ee.timeout:void 0)&&(h.error="Archivable timeout",h.type="review"),h.version=null!=(te=h.archivable)?te.version:void 0,h.type||!e.from||h.embedded&&(h.embedded.includes("oa.works")||h.embedded.includes("openaccessbutton.org")||h.embedded.includes("shareyourpaper.org"))||(h.type=e.redeposit?"redeposit":t?"forward":"dark"),h.doi&&(null==h.type&&(h.type="review"),h.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,await this.deposits(h),("review"!==h.type||null!=t)&&!1!==(null!=(ie=h.archivable)?ie.archivable:void 0)&&(!("undefined"!=typeof exists&&null!==exists&&null!=(re=exists.zenodo)?re.already:void 0)||i))){for(l=["joe@oa.works","shared@oa.works"],i&&l.push("mark@oa.works"),_e=[],"string"==typeof(null!=xe?xe.owner:void 0)&&xe.owner.includes("@")&&!h.error?_e.push(xe.owner):(null!=xe?xe.email:void 0)&&_e.push(xe.email),0===_e.length&&(_e=this.copy(l),l=[]),s=[],j=0,_=(ae=null!=(se=null!=(ne=h.metadata)?ne.author:void 0)?se:[]).length;j<_;j++)(a=ae[j]).family&&s.push((a.given?a.given+" ":"")+a.family);h.metadata.author=s,h.adminlink=h.embedded?h.embedded:"https://shareyourpaper.org"+(h.metadata.doi?"/"+h.metadata.doi:""),h.adminlink+=h.adminlink.includes("?")?"&":"?",null!=(null!=(le=h.archivable)?le.checksum:void 0)&&(h.confirmed=encodeURIComponent(h.archivable.checksum),h.adminlink+="confirmed="+h.confirmed+"&"),oe=h.email,I.call(h.adminlink,oe)<0&&(h.adminlink+="email="+h.email),we=await this.templates(h.type+"_deposit"),A=await this.template(we.content,h),delete h.adminlink,delete h.confirmed,k={from:"deposits@oa.works",to:_e,subject:null!=(ce=A.subject)?ce:h.type+" deposit",html:A.content},l&&l.length&&(k.bcc=l),t&&(k.attachment={file:t.data,filename:null!=(he=null!=(pe=null!=(de=h.archivable)?de.name:void 0)?pe:t.name)?he:t.filename}),await this.mail(k)}if(h.embargo)try{h.embargo_UI=new Date(h.embargo).toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"}).replace(/(11|12|13) /,"$1th ").replace("1 ","1st ").replace("2 ","2nd ").replace("3 ","3rd ").replace(/([0-9]) /,"$1th ")}catch(e){}return h},t.deposit._bg=!0,t.archivable=async function(e,t,i,r,s,n){var a,l,o;for(null==n&&(n=this.S.dev),this.request.files&&null==e&&(e=this.request.files[0]),Array.isArray(e)&&(e=e[0]),l={archivable:void 0,archivable_reason:void 0,version:"unknown",same_paper:void 0,licence:void 0},a=async()=>{var a,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,I,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z;if(("string"==typeof r||null==r&&(this.params.doi||this.params.title))&&(r=await this.metadata(null!=(C=null!=r?r:this.params.doi)?C:this.params.title)),null==r&&(r={}),"string"==typeof e&&(e={data:e}),null==e&&null!=t&&(e=await this.fetch(t)),null!=e){null==e.name&&(e.name=e.filename);try{l.name=e.name}catch(e){}try{l.format=null!=e.name&&e.name.includes(".")?e.name.split(".").pop():"html"}catch(e){}if(l.format=l.format.toLowerCase(),e.data){if(null==p&&null!=l.format&&null!=this.convert[l.format+"2txt"])try{p=await this.convert[l.format+"2txt"](e.data)}catch(e){}try{null==p&&(p=e.data)}catch(e){}try{p=p.toString()}catch(e){}}}if(null!=p||i){j=((S=(d=p.length<2e4?p:p.substring(0,6e3)+p.substring(p.length-6e3,p.length)).toLowerCase()).length<6e3?S:S.substring(0,6e3)).replace(/[^a-z0-9\/]+/g,""),null==l.name&&(l.name=r.title);try{l.checksum=crypto.createHash("md5").update(p,"utf8").digest("base64")}catch(e){}l.same_paper_evidence={};try{l.same_paper_evidence.words_count=p.split(" ").length}catch(e){}try{l.same_paper_evidence.words_more_than_threshold=l.same_paper_evidence.words_count>500}catch(e){}try{l.same_paper_evidence.doi_match=!(!r.doi||!j.includes(r.doi.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}try{l.same_paper_evidence.title_match=!(!r.title||!j.includes(r.title.toLowerCase().replace(/[^a-z0-9\/]+/g,"")))}catch(e){}if(null!=r.author)try{for(c=0,l.same_paper_evidence.author_match=!1,"string"==typeof r.author&&(r.author={name:r.author}),Array.isArray(r.author)||(r.author=[r.author]),M=r.author,g=0,x=M.length;g<x&&(a=M[g],!0!==l.same_paper_evidence.author_match);g++)try{if(u=(null!=(B=null!=(z=null!=(F=null!=(J=a.last)?J:a.lastname)?F:a.family)?z:a.surname)?B:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),o=(null!=($=null!=(X=null!=(V=a.first)?V:a.firstname)?X:a.given)?$:a.name).trim().split(",")[0].split(" ")[0].toLowerCase().replace(/[^a-z0-9\/]+/g,""),v=j.indexOf(u),u.length>2&&o.length>0&&-1!==v&&j.substring(v-20,v+u.length+20).includes(o)&&(c+=1,r.author.length<3&&1===c||r.author.length>2&&c>1)){l.same_paper_evidence.author_match=!0;break}}catch(e){}}catch(e){}if(null!=l.format)for(w=0,O=(L=["doc","tex","pdf","htm","xml","txt","rtf","odf","odt","page"]).length;w<O;w++)if(y=L[w],l.format.includes(y)){l.same_paper_evidence.document_format=!0;break}l.same_paper=!!(l.same_paper_evidence.words_more_than_threshold&&(l.same_paper_evidence.doi_match||l.same_paper_evidence.title_match||l.same_paper_evidence.author_match)&&l.same_paper_evidence.document_format),l.same_paper_evidence.words_count<150&&"pdf"===l.format&&(l.same_paper_evidence.words_count=0,l.archivable_reason="We could not find any text in the provided PDF. It is possible the PDF is a scan in which case text is only contained within images which we do not yet extract. Or, the PDF may have errors in it's structure which stops us being able to machine-read it"),l.version_evidence={score:0,strings_checked:0,strings_matched:[]};try{for(P=await this.src.google.sheets(n?"1XA29lqVPCJ2FQ6siLywahxBTLFaDCZKaN5qUeoTuApg":"10DNDmOG19shNnuw6cwtCpK-sBnexRCCtD4WnxJx_DPQ"),I=0,k=P.length;I<k;I++){_=P[I],l.version_evidence.strings_checked+=1,Z=_["what to search"],G=_["where to search"],m=_["how to search"],b=_["what it Indicates"];try{if(Z.includes("<<")&&Z.includes(">>")&&(H=Z.split("<<")[1].split(">>")[0],null!=r[H.toLowerCase()]&&(Z=Z.replace("<<"+H+">>",r[H.toLowerCase()]))),E=!1,"string"===m?E=!!("file"===G&&d.includes(Z)||"file"!==G&&(null!=r.title&&r.title.includes(Z)||null!=l.name&&l.name.includes(Z))):(D=new RegExp(Z,"gium"),E="file"===G&&null!==S.match(D)||"file"!==G&&(null!=r.title&&null!==r.title.match(D)||null!=l.name&&null!==l.name.match(D))),E){if("string"==typeof(Y=_.value))try{Y=parseInt(Y)}catch(e){}"number"!=typeof Y&&(Y=1),!b||"publisher pdf"!==(q=b.toLowerCase())&&"publishedversion"!==q?l.version_evidence.score-=Y:l.version_evidence.score+=Y,l.version_evidence.strings_matched.push({indicates:b,found:m+" "+Z,in:G,score_value:Y})}}catch(e){f=e,null==(h=l.version_evidence).strings_errored&&(h.strings_errored=[]),l.version_evidence.strings_errored.push({tried:m+" "+Z,in:G,error:f.toString()})}}}catch(e){}l.version_evidence.score>0&&(l.version="publishedVersion"),l.version_evidence.score<0&&(l.version="acceptedVersion"),"unknown"===l.version&&l.version_evidence.strings_checked>0&&(l.version="acceptedVersion");try{null!=(null!=(A=await this.licence(void 0,S))?A.licence:void 0)&&(l.licence=A.licence,l.licence_evidence=A)}catch(e){}l.archivable=!1,i?(l.archivable=!0,i===l.checksum?(l.archivable_reason="The administrator has confirmed that this file is a version that can be archived.",l.admin_confirms=!0):(l.archivable_reason="The depositor says that this file is a version that can be archived",l.depositor_says=!0)):l.same_paper?("pdf"!==l.format&&(l.archivable=!0,l.archivable_reason="Since the file is not a PDF, we assume it is an accepted version"),!l.archivable&&null!=l.licence&&l.licence.toLowerCase().startsWith("cc")&&(l.archivable=!0,l.archivable_reason="It appears this file contains a "+l.licence+" licence statement. Under this licence the article can be archived"),l.archivable||(l.version?(null!=r&&"{}"!==JSON.stringify(r)&&null==s&&(s=await this.permissions(r)),l.version===(null!=s&&null!=(T=s.best_permission)?T.version:void 0)?(l.archivable=!0,l.archivable_reason="We believe this is a "+l.version.split("V")[0]+" version and our permission system says that version can be shared"):null==l.archivable_reason&&(l.archivable_reason="We believe this file is a "+l.version.split("V")[0]+" version and our permission system does not list that as an archivable version")):l.archivable_reason="We cannot confirm if it is an archivable version or not")):null==l.archivable_reason&&(l.archivable_reason=l.same_paper_evidence.words_more_than_threshold?l.same_paper_evidence.document_format?r.doi||r.title?"File does not contain expected metadata such as DOI or title":"We have insufficient metadata to validate file is for the correct paper ":"File is an unexpected format "+l.format:"The file is less than 500 words, and so does not appear to be a full article")}else null==e&&null==t||(l.error=null!=(N=e.error)?N:"Could not extract any content");return l.archivable&&null==l.licence&&((null!=s&&null!=(R=s.best_permission)?R.licence:void 0)?l.licence=s.best_permission.licence:(null!=(W=null!=s&&null!=(U=s.best_permission)?U.deposit_statement:void 0)?W:"").toLowerCase().startsWith("cc")&&(l.licence=s.best_permission.deposit_statement)),l.metadata=r},a(),setTimeout((()=>l.timeout=!0),null!=(o=this.params.timeout)?o:6e4);null==l.archivable&&!l.timeout;)await this.sleep(500);return l},t.archivable._bg=!0,I=[].indexOf,t.metadata=async function(e){var t;return null!=(t=await this.find(e))?t.metadata:void 0},t.metadata._log=!1,t.find=async function(e,t={},i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;_={},s=async e=>{var i,r;for(r in i=await this.citation(e))"url"===r||"paywall"===r?null==_[r]&&(_[r]=i[r]):null==t[r]&&(t[r]=i[r]);return!0},"string"==typeof e&&(e=e.split("doi.org/").pop().startsWith("10.")?{doi:e}:{title:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(p=e.dom)?p:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(e.find.startsWith("10.")&&e.find.includes("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(d=e.q)?d:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),e.url.startsWith("/10.")&&(l="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).includes("/")&&l.split("/")[0].length>6&&l.length>8&&((o=l.split("/")).length>2&&(l=o.join("/")),null==t.doi&&(t.doi=l)),e.url.replace("doi:","").replace("doi.org/","").trim().startsWith("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):e.url.toLowerCase().startsWith("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&e.url.includes(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null!=t.title||e.url.startsWith("http")||(e.url.includes("{")||(null!=(f=e.url.replace("...","").match(/\./gi))?f:[]).length>3||(null!=(y=e.url.match(/\(/gi))?y:[]).length>2?e.citation=e.url:t.title=e.url),e.url.startsWith("http")&&e.url.includes(".")||delete e.url),"string"==typeof e.title&&(e.title.includes("{")||(null!=(m=e.title.replace("...","").match(/\./gi))?m:[]).length>3||(null!=(g=e.title.match(/\(/gi))?g:[]).length>2)&&(e.citation=e.title,delete e.title),e.doi&&(e.doi=await this.decode(e.doi)),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(v=e.pmcid)?v:e.pmc),e.citation&&await s(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}for("string"==typeof t.doi&&t.doi.startsWith("10.")||delete t.doi,!t.title&&i&&"string"==typeof e.url&&(e.url.includes("alma.exlibrisgroup.com")||e.url.includes("/exlibristest"))&&delete e.url,null!=e.demo&&(_.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&t.doi.startsWith("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(b=e.from)||"eZwJ83xp3oZDaec86"===b)&&null==_.demo&&(_.demo=!0),_.demo&&null==_.test&&(_.test=!0),u=!1,a=async()=>{var r,n,a,l,o;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(o=await this.scrape(null!=i?i:e.url),await s(o)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(l=t.pmcid)?l:t.pmid),await s(u)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(a=await this.src.crossref.works.title(t.title))?a.type:void 0)&&(null!=a?a.DOI:void 0)&&await s(a),t.doi||u||!1!==(u=await this.src.epmc.title(t.title))&&await s(u))),t.doi&&(n=async()=>{var e;return null==(e=await this.src.oadoi(t.doi))&&(_.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await s(e),!0},r=async()=>{var e;if(null!=(null!=(a=await this.src.crossref.works(t.doi))&&null!=(e=a.hits)?e.total:void 0)&&(a=void 0),null==a&&(a=await this.src.crossref.works.doi(t.doi,!0)),null!=a?a.type:void 0){try{a.published=await this.src.crossref.works.published(a);try{a.year=a.published.split("-")[0]}catch(e){}try{a.year=parseInt(a.year)}catch(e){}try{a.publishedAt=await this.epoch(a.published)}catch(e){}}catch(e){}await s(a)}else _.doi_not_in_crossref=t.doi;return!0},await Promise.all([n(),r()])),!0},await a(),r=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==_.ill&&(_.ill={subscription:await this.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},n=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==_.permissions&&(_.permissions=await this.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([r(),n()]),c=0,h=(w=["title","journal","year","doi"]).length;c<h;c++)e[x=w[c]]&&e[x]!==t[x]&&(t[x]=e[x]);return _.metadata=t,_},t.citation=function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe,Oe,ke,Se,je,Ae,Ie,Ee,De,Ce,Ne,Le,Pe,qe,Te,Re,We,Ue,Me,Be,ze,Fe,Je,$e;We={};try{null==e&&(e=null!=(P=this.params.citation)?P:this.params)}catch(e){}if("string"==typeof e&&(e.startsWith("{")||e.startsWith("[")))try{e=JSON.parse(e)}catch(e){}if("object"==typeof e){We.doi=null!=(q=e.DOI)?q:e.doi,e.pmid&&(We.pmid=e.pmid),e.pmcid&&(We.pmcid=e.pmcid);try{We.type=null!=(X=e.type)?X:e.genre}catch(e){}null==We.issn&&(We.issn=null!=(re=null!=(fe=null!=(Se=e.ISSN)?Se:e.issn)?fe:null!=(Pe=e.journalInfo)&&null!=(qe=Pe.journal)?qe.issn:void 0)?re:null!=(Te=e.journal)?Te.issn:void 0),null!=(null!=(Re=e.journalInfo)&&null!=(T=Re.journal)?T.eissn:void 0)&&(null==We.issn&&(We.issn=[]),"string"==typeof We.issn&&(We.issn=[We.issn]),We.issn.push(e.journalInfo.journal.eissn)),e.journal_issns&&null==We.issn&&(We.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==We.title&&(We.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(We.title+=": "+e.subtitle[0])}catch(e){}null==We.title&&(We.title=null!=(R=e.dctitle)?R:null!=(W=e.bibjson)?W.title:void 0),404!==(U=e.title)&&"404"!==U&&null==We.title&&(We.title=e.title),"string"==typeof We.title&&(We.title=We.title.replace(/\s\s+/g," ").trim());try{null==We.journal&&(We.journal=e["container-title"][0])}catch(e){}try{We.shortname=e["short-container-title"][0]}catch(e){}try{We.shortname=null!=(M=e.journalInfo.journal.isoabbreviation)?M:e.journalInfo.journal.medlineAbbreviation}catch(e){}We.shortname&&!We.journal_short&&(We.journal_short=We.shortname),null==We.journal&&(We.journal=null!=(B=null!=(z=e.journal_name)?z:null!=(F=e.journalInfo)&&null!=(J=F.journal)?J.title:void 0)?B:null!=($=e.journal)?$.title:void 0),e.journal&&(We.journal=e.journal.split("(")[0].trim());try{for(u=0,f=(V=["title","journal"]).length;u<f;u++)We[p=V[u]]=We[p].charAt(0).toUpperCase()+We[p].slice(1)}catch(e){}null==We.publisher&&(We.publisher=e.publisher),We.publisher&&(We.publisher=We.publisher.trim());try{null!=e.issue&&null==We.issue&&(We.issue=e.issue)}catch(e){}try{(null!=(G=e.journalInfo)?G.issue:void 0)&&null==We.issue&&(We.issue=e.journalInfo.issue)}catch(e){}try{null!=e.volume&&null==We.volume&&(We.volume=e.volume)}catch(e){}try{(null!=(Y=e.journalInfo)?Y.volume:void 0)&&null==We.volume&&(We.volume=e.journalInfo.volume)}catch(e){}try{null!=e.page&&null==We.page&&(We.page=e.page.toString())}catch(e){}for(e.pageInfo&&(We.page=e.pageInfo.toString()),(e.abstract||e.abstractText)&&(We.abstract=null!=(H=e.abstract)?H:e.abstractText),c=0,y=(Z=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited"]).length;c<y;c++)if(E=Z[c],"string"!=typeof We.published){if(Me=null!=(K=null!=(Q=e[E])?Q:null!=(ee=e["journal-issue"])?ee[E.replace("journal-issue.","")]:void 0)?K:null!=(te=e.journalInfo)?te[E.replace("journalInfo.","")]:void 0){"number"==typeof Me&&(Me=Me.toString());try{"string"!=typeof Me&&(Me=Me["date-time"].toString())}catch(e){}if("string"!=typeof Me)try{for(h in Me["date-parts"][0])"number"!=(ie=typeof Me["date-parts"][0][h])&&"string"!==ie&&(Me["date-parts"][0][h]="01");Me=Me["date-parts"][0].join("-")}catch(e){}"string"==typeof Me&&(We.published=Me.includes("T")?Me.split("T")[0]:Me,We.published=We.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),We.published.includes("-")||(We.published+="-01"),3!==We.published.split("-").length&&(We.published+="-01"),null==We.year&&(We.year=We.published.split("-")[0]),3!==We.published.split("-").length&&delete We.published,4!==We.year.toString().length&&delete We.year)}if(We.published)break}e.year&&null==We.year&&(We.year=e.year);try{null==We.year&&(We.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(null==We.author&&(null!=e.author||null!=e.z_authors||(null!=(se=e.authorList)?se.author:void 0))){null==We.author&&(We.author=[]);try{for(le=null!=(ne=null!=(ae=e.author)?ae:e.z_authors)?ne:e.authorList.author,j=0,m=le.length;j<m;j++)if("string"==typeof(t=le[j]))We.author.push({name:t});else{if((s={}).given=null!=(oe=t.given)?oe:t.firstName,s.family=null!=(ue=t.family)?ue:t.lastName,s.name=(s.given?s.given+" ":"")+(null!=(ce=s.family)?ce:""),null!=t.affiliation)try{for(he=s.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:s.authorAffiliationDetailsList.authorAffiliation,A=0,g=he.length;A<g;A++)"string"==typeof(i=he[A])?(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==s.affiliation&&(s.affiliation=[]),s.affiliation.push({name:(null!=(pe=i.name)?pe:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(e){}We.author.push(s)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(We.subject=e.subject)}catch(e){}try{null!=(null!=(de=e.keywordList)?de.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(We.keyword=e.keywordList.keyword)}catch(e){}try{for(be=[...null!=(ye=null!=(me=e.meshHeadingList)?me.meshHeading:void 0)?ye:[],...null!=(ge=null!=(ve=e.chemicalList)?ve.chemical:void 0)?ge:[]],N=0,v=be.length;N<v;N++)k=be[N],null==We.keyword&&(We.keyword=[]),"string"==typeof(S="string"==typeof k?k:null!=(we=k.name)?we:k.descriptorName)&&S&&I.call(We.keyword,S)<0&&We.keyword.push(S)}catch(e){}"string"==typeof e.license&&(We.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(We.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(_e=e.best_oa_location)?_e.license:void 0)&&null!==(null!=(xe=e.best_oa_location)?xe.license:void 0)&&null==We.licence&&(We.licence=e.best_oa_location.license)}catch(e){}if(!We.licence){if(Array.isArray(e.assertion))for(L=0,b=(Oe=e.assertion).length;L<b;L++)"OPEN ACCESS"===(t=Oe[L]).label&&t.URL&&t.URL.includes("creativecommons")&&null==We.licence&&(We.licence=t.URL);if(Array.isArray(e.license))for(Be=0,w=(je=null!=(ke=e.license)?ke:[]).length;Be<w;Be++)!(d=je[Be]).URL||!d.URL.includes("creativecommons")||We.licence&&We.licence.includes("creativecommons")||null==We.licence&&(We.licence=d.URL)}if("string"==typeof We.licence&&We.licence.includes("/licenses/")&&(We.licence="cc-"+We.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==We.url&&(We.url=null!=(Ae=null!=(Ie=e.best_oa_location)?Ie.url_for_pdf:void 0)?Ae:null!=(Ee=e.best_oa_location)?Ee.url:void 0),!We.url&&null!=(null!=(De=e.fullTextUrlList)?De.fullTextUrl:void 0))for(Fe=0,_=(Ce=e.fullTextUrlList.fullTextUrl).length;Fe<_;Fe++)"oa"!==(Ne=(a=Ce[Fe]).availabilityCode.toLowerCase())&&"f"!==Ne||We.url&&("pdf"!==a.documentStyle||We.url.includes("pdf"))||(We.url=a.url)}else if("string"==typeof e)try{(e=e.replace(/citation\:/gi,"").trim()).includes("title")&&(e=e.split("title")[1].trim()),(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).includes("doi:")&&(We.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),e.includes("doi.org/")&&(We.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),!We.doi&&e.includes("http")&&(We.url="http"+e.split("http")[1].split(" ")[0].trim());try{(e.includes("|")||e.includes("}"))&&(We.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?We.title=e.split('"')[1].trim():e.split("'").length>2&&null==We.title&&(We.title=e.split("'")[1].trim())}catch(e){}try{for(C=e.replace(/,\./g," ").split(" "),Je=0,x=C.length;Je<x;Je++)D=C[Je],We.year||4===(D=D.replace(/[^0-9]/g,"")).length&&("number"!=typeof(ze=parseInt(D))||isNaN(ze)||(We.year=ze))}catch(e){}try{!We.title&&We.year&&e.indexOf(We.year)<e.length/4&&(We.title=e.split(We.year)[1].trim(),(!We.title.includes("(")||We.title.indexOf(")")<We.title.indexOf("("))&&(We.title=We.title.replace(")","")),We.title.indexOf(".")<3&&(We.title=We.title.replace(".","")),We.title.indexOf(",")<3&&(We.title=We.title.replace(",","")),We.title=We.title.trim(),We.title.includes(".")?We.title=We.title.split(".")[0]:We.title.includes(",")&&(We.title=We.title.split(",")[0]))}catch(e){}if(We.title){try{if(n=e.split(We.title)[0],We.year&&n.includes(We.year)&&(n=n.split(We.year)[0]),We.url&&n.indexOf(We.url)>0&&(n=n.split(We.url)[0]),We.url&&n.startsWith(We.url)&&(n=n.replace(We.url)),We.doi&&n.startsWith(We.doi)&&(n=n.replace(We.doi)),n.indexOf(".")<3&&(n=n.replace(".","")),n.indexOf(",")<3&&(n=n.replace(",","")),n.lastIndexOf("(")>n.length-3&&(n=n.substring(0,n.lastIndexOf("("))),n.lastIndexOf(")")>n.length-3&&(n=n.substring(0,n.lastIndexOf(")"))),n.lastIndexOf(",")>n.length-3&&(n=n.substring(0,n.lastIndexOf(","))),n.lastIndexOf(".")>n.length-3&&(n=n.substring(0,n.lastIndexOf("."))),(n=n.trim()).length>6)if(n.includes(","))for(We.author=[],Le=n.split(","),$e=0,O=Le.length;$e<O;$e++)r=Le[$e],We.author.push({name:r});else We.author=[{name:n}]}catch(e){}try{Ue=e.split(We.title)[1],We.url&&Ue.includes(We.url)&&(Ue=Ue.replace(We.url)),We.doi&&Ue.includes(We.doi)&&(Ue=Ue.replace(We.doi)),Ue.indexOf(".")<3&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<3&&(Ue=Ue.replace(",","")),(Ue=Ue.trim()).length>6&&(We.journal=Ue,Ue.includes(",")&&(We.journal=We.journal.split(",")[0].replace(/in /gi,"").trim()),We.journal.indexOf(".")<3&&(We.journal=We.journal.replace(".","")),We.journal.indexOf(",")<3&&(We.journal=We.journal.replace(",","")),We.journal=We.journal.trim())}catch(e){}}try{if(We.journal&&(Ue=e.split(We.journal)[1],We.url&&Ue.includes(We.url)&&(Ue=Ue.replace(We.url)),We.doi&&Ue.includes(We.doi)&&(Ue=Ue.replace(We.doi)),Ue.indexOf(".")<3&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<3&&(Ue=Ue.replace(",","")),(Ue=Ue.trim()).length>4)){if(Ue.includes("retrieved")&&(Ue=Ue.split("retrieved")[0]),Ue.includes("Retrieved")&&(Ue=Ue.split("Retrieved")[0]),We.volume=Ue,We.volume.includes("(")){We.volume=We.volume.split("(")[0],We.volume=We.volume.trim();try{We.issue=Ue.split("(")[1].split(")")[0],We.issue=We.issue.trim()}catch(e){}}if(We.volume.includes(",")){We.volume=We.volume.split(",")[0],We.volume=We.volume.trim();try{We.issue=Ue.split(",")[1],We.issue=We.issue.trim()}catch(e){}}if(We.volume)try{isNaN(parseInt(We.volume))&&delete We.volume}catch(e){}if(We.issue){We.issue.includes(",")&&(We.issue=We.issue.split(",")[0].trim());try{isNaN(parseInt(We.issue))&&delete We.issue}catch(e){}}if(We.volume&&We.issue)try{(Ue=e.split(We.journal)[1]).includes("retriev")&&(Ue=Ue.split("retriev")[0]),Ue.includes("Retriev")&&(Ue=Ue.split("Retriev")[0]),We.url&&Ue.includes(We.url)&&(Ue=Ue.split(We.url)[0]),We.doi&&Ue.includes(We.doi)&&(Ue=Ue.split(We.doi)[0]),(Ue=(Ue=Ue.substring(Ue.indexOf(We.volume)+(We.volume+"").length)).substring(Ue.indexOf(We.issue)+(We.issue+"").length)).indexOf(".")<2&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<2&&(Ue=Ue.replace(",","")),Ue.indexOf(")")<2&&(Ue=Ue.replace(")","")),Ue=Ue.trim(),isNaN(parseInt(Ue.substring(0,1)))||(We.pages=Ue.split(" ")[0].split(".")[0].trim(),We.pages.length>5&&(We.pages=We.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(!We.author&&e.includes("et al")&&(o=e.split("et al")[0].trim(),e.startsWith(o)&&(We.author=[{name:o+"et al"}])),We.title&&!We.volume)try{(l=e.split(We.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).includes("vol")&&(We.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),!We.issue&&l.includes("iss")&&(We.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),!We.pages&&l.includes("page")&&(We.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof We.year&&(We.year=We.year.toString()),We},t.availability=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,I,E;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&e.availability.includes("/")?e.doi=e.availability:e.availability.includes(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(n=null!=(a=null!=(g=null!=(w=null!=(_=null!=(x=null!=(O=null!=(k=e.doi)?k:e.pmid)?O:e.pmc)?x:e.pmcid)?_:e.title)?w:e.url)?g:e.id)?a:e.citation)?n:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.find(e)),null!=i.v2){null==(r=i.data).match&&(r.match=null!=(S=null!=(j=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(p=i.v2.metadata)?p.title:void 0)?o:null!=(d=i.v2.metadata)?d.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?j:null!=(y=i.v2.metadata)?y.pmcid:void 0)?S:null!=(m=i.v2.metadata)?m.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(s=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(I=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+s+" AND type:article&sort=createdAt:desc"))&&null!=(v=I.hits)?v.total:void 0)&&((E={type:"article",_id:(A=I.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(b=A.user)?b.id:void 0)!==e.uid),i.data.requests.push(E))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},I=[].indexOf,t.ill=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),s=e.config;try{s=JSON.parse(s)}catch(e){}for(h in("string"==typeof s||!s&&e.from)&&(null!=(s=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(f=e.from)?f:s)))&&"{}"!==JSON.stringify(s)||(s=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(y=e.from)?y:s)))),null==s&&(s={}),_={name:"librarian",details:""},p=["title","author","volume","issue","date","pages"],e)if("metadata"===h){for(c in e[h])"email"!==c&&(e[c]=e[h][c],I.call(p,c)<0&&p.push(c));delete e.metadata}else I.call(p,h)<0&&p.push(h);for(a=0,o=p.length;a<o;a++)if(e[d=p[a]]&&(_[d]=e[d],"author"===d)){for(n=!0,r=[],l=0,u=(m=e[d]).length;l<u;l++)(t=m[l]).family&&(n&&(n=!1),i=t.family+(t.given?" "+t.given:""),r.push(i));_[d]=r}return null!=e.author&&delete e.author,_.illid=e._id=await this.uid(),s.search&&s.search.length&&(e.issn||e.journal)&&(-1!==s.search.indexOf("worldcat")?(b=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",b+=null!=e.issn?"in%3A":"ti%3A",b+="&si0qs="+(null!=(g=e.issn)?g:e.journal),b+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(b=s.search,b+=e.issn?e.issn:e.journal),_.worldcatsearchurl=b),await this.ills(e),w=(w=await this.templates("instantill_create")).content,e.forwarded||e.resolved||!s.email&&!e.email||this.waitUntil(this.mail({svc:"oaworks",vars:_,template:w,to:null!=(v=s.email)?v:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id})),w=w.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:_,template:w,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:"joe@oa.works"})),e},t.ills={_index:!0},t.ill.collect=async function(e){var t,i,r;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),r="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(r+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(r)),this.waitUntil(this.svc.rscvd(e)),!0},t.ill.openurl=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d;for(r in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),s={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[r]||(e[r]=s[r]);for(a in p="",e.ill_added_params&&(p+=e.ill_added_params.replace("?","")+"&"),p+=e.sid+"=InstantILL&",t){if(d="","author"===a)for(n=0,l=(h=Array.isArray(t.author)?t.author:[t.author]).length;n<l;n++)i=h[n],d.length&&(d+=", "),d+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==a&&"pmid"!==a&&"pmc"!==a&&"pmcid"!==a&&"url"!==a&&"journal"!==a&&"title"!==a&&"year"!==a&&"issn"!==a&&"volume"!==a&&"issue"!==a&&"page"!==a&&"crossref_type"!==a&&"publisher"!==a&&"published"!==a&&"notes"!==a||(d=t[a]);d&&(p+=(e[a]?e[a]:a)+"="+encodeURIComponent(d)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(p=p.replace("usermetadata=true","")).indexOf(o+"=")?p+="&"+o+"=The user provided some metadata.":p=p.replace(o+"=",o+"=The user provided some metadata. ")),p.replace("/&&/g","&")},t.ill.subscription=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(t=await this.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(l=this.params.config)?l:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(h in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),n=await this.ill.openurl(e,t),e.ill_added_params&&(n=n.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(d=e.subscription[h])?(f=d.type,d=d.url):f=null!=(u=e.subscription_type[h])?u:"unknown",d=d.trim()){"serialssolutions"===f||-1!==d.indexOf("serialssolutions")?(-1!==(m=d.split(".search")[0]).indexOf("//")&&(m=m.split("//")[1]),d="http://"+m+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===d.indexOf("sfx.")||-1!==d.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===d.indexOf(".exlibris")||-1!==d.indexOf("response_type")||(d=d.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):d+=(-1===d.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(g=d+(-1===d.indexOf("?")?"?":"&")+n).indexOf("snc.idm.oclc.org/login?url=")&&(g=g.split("snc.idm.oclc.org/login?url=")[1]),g=g.replace("cache=true",""),("sfx"===f||-1!==d.indexOf("sfx.")&&-1!==g.indexOf("=10."))&&(g=g.replace("=10.","=doi:10.")),("exlibris"===f||-1!==d.indexOf(".exlibris")&&-1!==g.indexOf("doi=10."))&&(g=g.replace("doi=10.","ID=doi:10.")),a="",p="",i=!1,c.lookups.push(g);try{p=-1!==(a=await this.fetch(g)).indexOf("<body")?a.toLowerCase().split("<body")[1].split("</body")[0]:a,c.contents.push(p)}catch(e){i=!0}if("sfx"===f||-1!==g.indexOf("sfx."))if(i&&c.error.push("sfx"),-1!==p.indexOf("getFullTxt")&&-1!==p.indexOf("<target_url>"))try{c.url=p.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0))}catch(e){}else-1!==p.indexOf('<a title="navigate to target in new window')&&-1!==p.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=g,c.findings.sfx=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="sfx":(c.url=void 0,c.findings.sfx=void 0)));else if("eds"===f||-1!==g.indexOf("ebscohost."))i&&c.error.push("eds"),-1!==p.indexOf("view this ")&&-1!==a.indexOf('<a data-auto="menu-link" href="')&&(c.url=g.replace("://","______").split("/")[0].replace("______","://")+a.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="eds":c.url=void 0));else if("serialssolutions"===f||-1!==g.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==p.indexOf('<ssopenurl:url type="article">'))(r=p.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=r,c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)));else if(-1===p.indexOf("ss_noresults"))try{y=g.split("?")[0]+"?ShowSupressedLinks"+a.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(s=await this.fetch(y)).indexOf("ArticleCL")&&-1!==s.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=y.split("?")[0]+s.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url&&(-1===c.url.indexOf("getitnow")?c.found="serials":(c.url=void 0,c.findings.serials=void 0)))}catch(e){i&&c.error.push("serialssolutions")}}else"exlibris"!==f&&-1===g.indexOf(".exlibris")||(i&&c.error.push("exlibris"),-1!==p.indexOf("full_text_indicator")&&0===p.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==p.indexOf("resolution_url")&&(c.url=p.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris"))}return c.url&&(c.url=await this.decode(c.url)),c},t.licence=async function(e,t,i,r){var s,n,a,l,o,u,c,h,p,d,f,y,m;if(null==e&&(e=this.params.url),null==t&&(t=null!=(c=this.params.content)?c:this.body),e||t||!this.params.licence&&!this.params.doi||(e="https://doi.org/"+(null!=(h=this.params.licence)?h:this.params.doi)),e&&(e=e.replace(/(^\s*)|(\s*$)/g,""),!t)){j.log(e);try{t=await this.fetch(e)}catch(e){}}if("number"==typeof t&&(t=void 0),null==i&&(i=this.params.start),null==r&&(r=this.params.end),l={},e&&(l.url=e),"string"==typeof t)for(null!=i&&t.includes(i)&&(t=t.split(i)[1]),r&&(t=t.split(r)[0]),t.length>1e5&&(l.large=!0,t=t.substring(0,5e4)+t.substring(t.length-5e4,t.length)),s=0,a=(f=null!=(p=null!=(o=await this.licences("*",1e4))&&null!=(d=o.hits)?d.hits:void 0)?p:[]).length;s<a;s++)if((!(n=f[s]._source).matchesondomains||"*"===n.matchesondomains||null==e||n.matchesondomains.toLowerCase().includes(e.toLowerCase().replace("http://","").replace("https://","").replace("www.","").split("/")[0]))&&(u=n.matchtext.toLowerCase().replace(/[^a-z0-9]/g,""),(y=!!(m=!!n.matchtext.includes("://")&&n.matchtext.toLowerCase().split("://")[1].split('"')[0].split(" ")[0])&&t.toLowerCase().includes(m))||t.toLowerCase().replace(/[^a-z0-9]/g,"").includes(u))){l.licence=n.licencetype,l.match=n.matchtext,l.matched=y?m:u;break}return l},t.licences={_sheet:"1yJOpE_YMdDxCKaK0DqWoCJDdq8Ep1b-_J1xYVKGsiYI",_prefix:!1},I=[].indexOf,t.permissions=async function(e,t,i,s,n,a){var l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe,Oe,ke,Se,je,Ae,Ie,Ee,De,Ce,Ne,Le,Pe,qe,Te;if(R=!1,y=!1,l=async function(t){var i,s,a,l,o,u,c,h,p,d,f,m,g,v,b,w,_,x,O,k,S,j,A,I,E,D,C,N,L;if(y&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(g=e.published)?g:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name=t.copyright_owner&&"publisher"===t.copyright_owner.toLowerCase()?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:!t.copyright_owner||"journal"!==(v=t.copyright_owner.toLowerCase())&&"affiliation"!==v?y&&t.copyright_owner&&t.copyright_owner.toLowerCase().includes("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(j=e.author[0].name)?j:e.author[0].family)+(e.author.length>1?" et al":""):"":null!=(S=e.journal)?S:"",("publisher"===(A=t.copyright_name.toLowerCase())||"journal"===A)&&(n||e.doi||(null!=(I=t.provenance)?I.example:void 0)))for(null==n&&(n=await this.src.crossref.works(null!=(E=e.doi)?E:t.provenance.example)),o=0,h=(C=null!=(D=null!=n?n.assertion:void 0)?D:[]).length;o<h;o++)if("copyright"===(i=C[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(y&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,y&&null!=t.deposit_statement&&t.deposit_statement.includes("<<")){for(l="",u=0,p=(N=t.deposit_statement.split("<<")).length;u<p;u++)if(m=N[u],""!==l||m.includes(">>")){if(null!=(L={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(a=m.split(">>"))[0].toLowerCase()]&&(f=L[f]),"author"===f)try{l+=(null!=(b=e.author[0].name)?b:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else l+=null!=(w=null!=(_=e[f])?_:t[f])?w:"";try{l+=a[1]}catch(e){}}else l+=m;t.deposit_statement=l}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"beta.oa.works/permissions/":"api.oa.works/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(x=t.issuer)?x.has_policy:void 0)||"not publisher"!==(O=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==O||(R=t.issuer.has_policy),c=0,d=(k=["_id","hide"]).length;c<d;c++)delete t[k[c]];return t},u=e=>{var t,i,r,s,n,a;return a=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(a+=1e3),null!=e.requirements?a-=10:a+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,e.licence&&(a-=5),a+="journal"===(null!=(i=e.issuer)?i.type.toLowerCase():void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type.toLowerCase():void 0)?4:"university"===(null!=(s=e.issuer)?s.type.toLowerCase():void 0)?3:"article"===(null!=(n=e.issuer)?n.type.toLowerCase():void 0)?2:0,e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(a-=25),a},"string"==typeof e&&(e=e.startsWith("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&"string"==typeof e.permissions&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):e.permissions.startsWith("10.")&&e.permissions.includes("/")?e.doi=e.permissions:e.permissions.includes("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.permissions.includes(" ")||e.permissions.includes(",")||e.permissions.replace(/[0-9]/g,"").length===e.permissions.length?e.publisher=e.permissions:e.ror=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&e.ror.includes(",")&&(e.ror=e.ror.split(",")),e.journal&&!e.journal.includes(" ")&&e.journal.includes("-")&&(e.issn=e.journal,delete e.journal),b=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&e.issn.includes(",")&&(e.issn=e.issn.split(",")),delete e.best,"{}"===JSON.stringify(e)||e.issn&&!JSON.stringify(e.issn).includes("-")||e.doi&&("string"!=typeof e.doi||!e.doi.startsWith("10.")||!e.doi.includes("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(null==a&&(a=this.params.best),a&&e.doi&&!e.ror.length&&(h=await this.permissions.best(e.doi))&&(!0===a||h.updated>a))return delete h.updated,delete h.DOI,{best_permission:h};if(o=async()=>{var t,i,r,s,a;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in s=[],a=null!=(r=null!=n?n:await this.metadata(e.doi))?r:{})s.push(null!=e[t]?e[t]:e[t]=a[t]);return s}},!1===i||!e.doi||e.publisher&&e.issn||await o(),!e.published&&e.year&&(e.published=e.year+"-01-01"),y=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!b.length)for(m=0,x=(X=e.issn).length;m<x;m++)v=X[m],I.call(b,v)<0&&b.push(v);try{null==e.doi&&(e.doi=await this.permissions.journals.example(b))}catch(e){}!y&&e.doi&&await o()}if(y&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&e.publisher.includes("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(te=e.page)?te:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ce=e.year)?ce:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(M={best_permission:void 0,all_permissions:[]},je=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(Ee=await this.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(we=Ee.hits)?we.total:void 0))try{(null!=(_e=(De=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?_e.total:void 0)&&(De=De.hits.hits[0]._source),De.country.country_code&&(Ee=await this.permissions.affiliations('issuer.id:"'+De.country.country_code+'"'))}catch(e){}for(w=0,O=(ke=null!=(xe=null!=Ee&&null!=(Oe=Ee.hits)?Oe.hits:void 0)?xe:[]).length;w<O;w++)Ie=ke[w],(Le=await l(Ie._source)).score=await u(Le),je.push(Le)}if(g=void 0,b){for await($ of this.index._for("src_doaj_journals",'bibjson.pissn:"'+b.join('" OR bibjson.pissn:"')+'" OR bibjson.eissn:"'+b.join('" OR bibjson.eissn:"')+'"'))g||(g=$),V=$.bibjson.pissn,I.call(b,V)<0&&b.push($.bibjson.pissn),G=$.bibjson.eissn,I.call(b,G)<0&&b.push($.bibjson.eissn);if(b.length)for(P=0,S=(Z=null!=(Y=null!=(B=await this.permissions.journals('issuer.id:"'+b.join('" OR issuer.id:"')+'"'))&&null!=(H=B.hits)?H.hits:void 0)?Y:[]).length;P<S;P++)W=Z[P],(Ae=await l(W._source)).score=await u(Ae),M.all_permissions.push(Ae)}if(e.publisher)for(F='issuer.id:"'+e.publisher+'"',q=0,j=(ee=null!=(K=null!=(B=await this.permissions.publishers(F))&&null!=(Q=B.hits)?Q.hits:void 0)?K:[]).length;q<j;q++)W=ee[q],(Ae=await l(W._source)).score=await u(Ae),M.all_permissions.push(Ae);if(c={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,locations:["institutional repository"],embargo_months:void 0,issuer:{type:"Journal",has_policy:"yes"},meta:{creator:"joe+doaj@oa.works",contributors:["joe+doaj@oa.works"],monitoring:"Automatic"}},b&&(null!=g?g:g=await this.src.doaj.journals('bibjson.eissn.keyword:"'+b.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+b.join('" OR bibjson.pissn.keyword:"')+'"',1))){for(T=0,A=(se=null!=(ie=null!=(re=g.bibjson)?re.license:void 0)?ie:[]).length;T<A;T++)d=se[T],(!c.licence||c.licence.length>d.type)&&(c.licence=d.type),null==c.licences&&(c.licences=[]),c.licences.push({type:d.type});if(null==c.licence&&(p=await this.src.crossref.journals('ISSN.keyword:"'+b.join('" OR ISSN.keyword:"')+'"',1)))for(z=0,E=(ae=null!=(ne=p.license)?ne:[]).length;z<E;z++)L=ae[z],(!c.licence||c.licence.length>L.type)&&(c.licence=L.type);"string"==typeof c.licence?(c.licence=c.licence.toLowerCase().trim(),c.licence.startsWith("cc")?c.licence=c.licence.replace(/ /g,"-"):c.licence.includes("creative")?c.licence=c.licence.includes("0")||c.licence.includes("zero")?"cc0":c.licence.includes("share")?"ccbysa":c.licence.includes("derivative")?"ccbynd":"ccby":delete c.licence):delete c.licence,c.issuer.id=g.bibjson.eissn&&g.bibjson.pissn?[g.bibjson.pissn,g.bibjson.eissn]:g.bibjson.pissn?[g.bibjson.pissn]:[g.bibjson.eissn],c.embargo_months=0,c.provenance={oa_evidence:"In DOAJ"},c.score=await u(c),M.all_permissions.push(c)}else!b&&e.publisher&&(await this.permissions.publishers.oa(e.publisher)).oa&&(c.issuer.id=e.publisher,c.meta.creator=["joe+oapublisher@oa.works"],c.meta.contributors=["joe+oapublisher@oa.works"],c.provenance={oa_evidence:"OA publisher"},c.score=await u(c),M.all_permissions.push(c));if(e.doi&&(null==s&&(s=await this.src.oadoi(e.doi)),y&&(null!=s&&null!=(le=s.best_oa_location)?le.license:void 0)&&s.best_oa_location.license.includes("cc")&&((f={can_archive:!0,version:s.best_oa_location.version,versions:[],licence:s.best_oa_location.license,locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:"support@unpaywall.org",contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:s.best_oa_location.updated},provenance:{oa_evidence:s.best_oa_location.evidence}}).version&&(f.versions="submittedVersion"===f.version?["submittedVersion"]:"acceptedVersion"===f.version?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),f.score=await u(f),M.all_permissions.push(f))),M.all_permissions.length){for(M.all_permissions.sort(((e,t)=>e.score<t.score?1:-1)),J=0,D=(oe=M.all_permissions).length;J<D;J++)null==(Te=oe[J]).licences&&(Te.licences=[],Te.licence&&Te.licences.push({type:Te.licence})),y&&(null!=(ue=Te.issuer)?ue.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Te.issuer.journal_oa_type_from)&&delete Te.issuer.journal_oa_type,delete Te.issuer.journal_oa_type_from,!b&&"journal"!==(null!=(he=Te.issuer)?he.type:void 0)||Te.issuer.journal_oa_type||(Te.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=b?b:Te.issuer.id,g,s,n)),(null!=(pe=Te.provenance)?pe.enforcement_from:void 0)?(!e.published||Date.parse(e.published)>Date.parse(Te.provenance.enforcement_from.split("/").reverse().join("-")))&&null==M.best_permission&&(M.best_permission=this.copy(Te)):null==M.best_permission&&(M.best_permission=this.copy(Te));if(je.length)for(je.sort(((e,t)=>e.score<t.score?1:-1)),Ce=0,C=je.length;Ce<C;Ce++)if(Se=je[Ce],y&&(null!=(de=Se.issuer)?de.journal_oa_type_from:void 0)&&e.published&&Date.parse(e.published)<Date.parse(Se.issuer.journal_oa_type_from)&&delete Se.issuer.journal_oa_type,delete Se.issuer.journal_oa_type_from,!b&&"journal"!==(null!=(fe=Se.issuer)?fe.type:void 0)||Se.issuer.journal_oa_type||(Se.issuer.journal_oa_type=await this.permissions.journals.oa.type(null!=b?b:Se.issuer.id,g,s,n)),M.all_permissions.push(Se),null==(null!=(ye=M.best_permission)?ye.author_affiliation_requirement:void 0)&&null!=M.best_permission&&(!(null!=(me=Se.provenance)?me.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(Se.provenance.enforcement_from.split("/").reverse().join("-")))){for(U=this.copy(M.best_permission),Ne=0,N=(ge=["versions","locations"]).length;Ne<N;Ne++)for(Pe=0,k=(ve=Se[_=ge[Ne]]).length;Pe<k;Pe++)qe=ve[Pe],null==U[_]&&(U[_]=[]),I.call(U[_],qe)<0&&U[_].push(qe);U.version=I.call(U.versions,"publishedVersion")>=0?"publishedVersion":I.call(U.versions,"acceptedVersion")>=0?"acceptedVersion":"submittedVersion",U.embargo_end&&Se.embargo_end&&Date.parse(Se.embargo_end)<Date.parse(U.embargo_end)&&(U.embargo_end=Se.embargo_end),U.embargo_months&&null!=Se.embargo_months&&Se.embargo_months<U.embargo_months&&(U.embargo_months=Se.embargo_months),!0===Se.can_archive&&(U.can_archive=!0),null==U.requirements&&(U.requirements={}),U.requirements.author_affiliation_requirement=null==e.ror?Se.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],U.issuer.affiliation=Se.issuer,null==U.meta&&(U.meta={}),U.meta.affiliation=Se.meta,null==U.provenance&&(U.provenance={}),U.provenance.affiliation=Se.provenance,U.score=parseInt(U.score)+parseInt(Se.score),M.best_permission=U,M.all_permissions.push(U)}}return R?{body:"string"!=typeof R?R:null!=(be={"not publisher":"Please find another DOI for this article as this is provided as this does not allow us to find required information like who published it"}[R.toLowerCase()])?be:R,status:501}:(e.doi&&!je.length&&M.best_permission&&((h=await this.copy(M.best_permission)).updated=await this.epoch(),h.DOI=e.doi,this.waitUntil(this.permissions.best(h))),!0!==this.params.metadata&&!0!==i||(M.metadata=e),M)},t.permissions._log=!1,t.permissions.best={_index:!0,_key:"DOI"},t.permissions.journals={_sheet:"1ZTcYJUzhNJYIuxsjKzdVFCbOhJsviVik-8K1DpU7-eE/Main",_prefix:!1,_format:async function(e=[]){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b;for(f=[],s=0,u=(m="object"!=typeof e||Array.isArray(e)?e:[e]).length;s<u;s++){for(a in d={can_archive:void 0,version:void 0,versions:[],licence:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,copyright_owner:"",copyright_name:"",copyright_year:"",issuer:{},meta:{},provenance:{},requirements:{}},y=m[s])if("string"==typeof y[a]&&(y[a]=y[a].trim()),"id"===a)if(d.issuer.id="string"==typeof y.id&&y.id.includes(",")?y.id.split(","):y.id,"string"==typeof d.issuer.id&&d.issuer.id.startsWith("10.")&&d.issuer.id.includes("/")&&!d.issuer.id.includes(" "))d.DOI=d.issuer.id;else{for(r=[],n=0,c=(g="string"==typeof d.issuer.id?[d.issuer.id]:d.issuer.id).length;n<c;n++){if(p=(p=g[n]).trim(),"journal"===d.issuer.type&&p.includes("-")&&!p.includes(" ")&&(p=p.toUpperCase(),t=await this.src.openalex.sources('issn:"'+p+'"',1)))for(o=0,h=(v=t.issn).length;o<h;o++)i=v[o],I.call(r,i)<0&&r.push(i);I.call(r,p)<0&&r.push(p)}d.issuer.id=r}else"embargo_months"===a?(l="number"==typeof y[a]?y[a]:"string"==typeof y[a]?parseInt(y[a].trim()):void 0)&&"number"==typeof l&&(d.embargo_months=l,d.embargo_end=""):a&&null!=y[a]&&""!==(b=y[a])&&"none"!==b&&"unclear"!==b&&("versions"===a&&y.versions.length&&(d.can_archive=!0,d.version=y.versions.includes("ublish")?"publishedVersion":y.versions.includes("ccept")?"acceptedVersion":"submittedVersion"),"versions"!==a&&"locations"!==a&&"meta.contributors"!==a&&"meta.creator"!==a&&"meta.reviewer"!==a&&"provenance.archiving_policy"!==a&&"requirements.funder"!==a&&"journal"!==a||(y[a]=y[a].trim().replace(/\, /,",").replace(/ \,/,",").split(",")),await this.dot(d,"license"===a?"licence":a,y[a]));d.copyright_owner&&"journal"!==d.copyright_owner.toLowerCase()||!d.issuer.type||(d.copyright_owner=d.issuer.type),"{}"===JSON.stringify(d.requirements)&&delete d.requirements,f.push(d)}return 1===f.length?f[0]:f}},t.permissions.publishers={_sheet:"11rsHmef1j9Q9Xb0WtQ_BklQceaSkkFEIm7tJ4qz0fJk/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.affiliations={_sheet:"15fa1DADj6y_3aZQcP9-zBalhaThxzZw9dyEbxMBBb5Y/Main",_prefix:!1,_format:t.permissions.journals._format},t.permissions.journals.example=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.src.crossref.works('ISSN:"'+e.join('" OR ISSN:"')+'"',1)).DOI}catch(e){}},t.permissions.journals.example._log=!1,t.permissions.journals.transformative={_index:!0,_prefix:!1},t.permissions.journals.transformative.load=async function(){var e,t,i,r,s;for(e=[],t=0,i=(s=(await this.fetch("https://api.journalcheckertool.org/journal?q=tj:true&include=issn&size=10000")).hits.hits).length;t<i;t++)r=s[t],e.push(r._source);return e.length&&(await this.permissions.journals.transformative(""),await this.permissions.journals.transformative(e)),e.length},t.permissions.journals.transformative.load._bg=!0,t.permissions.journals.transformative.load._async=!0,t.permissions.journals.transformative.load._auth="root",t.permissions.journals.oa=async function(e,t){var i,r,s,n,a,l;try{null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.journals)?n:this.params.journal)?s:this.params.issn)?r:this.params.oa)}catch(e){}return l={},e&&(l.articles=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'"'),l.open=await this.src.crossref.works.count('type:"journal-article" AND ISSN:"'+e+'" AND is_oa:true'),l.articles===l.open&&(l.oa=!0),await this.src.doaj.journals('bibjson.pissn:"'+e+'" OR bibjson.eissn:"'+e+'"',1)&&(l.open=l.articles,l.doaj=!0,l.oa=!0),(i=await this.permissions.journals.example(e))&&(null==t&&(t=await this.src.oadoi(i,1)),null!=t?(delete l.oa,l.open=l.articles,l.oadoi=!0,l.oa=(null!=t&&null!=(a=t.best_oa_location)?a.license:void 0)&&t.best_oa_location.license.includes("cc")):l.oa=!1)),l},t.permissions.journals.oa._log=!1,t.permissions.journals.oa.type=async function(e,t,i,r){var s,n,a,l,o,u,c,h,p,d;return null==e&&(e=null!=(n=null!=(a=null!=(l=null!=(o=null!=(u=null!=(c=null!=i?i.journal_issns:void 0)?c:null!=r?r.ISSN:void 0)?u:this.params.journals)?o:this.params.journal)?l:this.params.type)?a:this.params.issn)?n:this.params.issns),"string"==typeof e&&(e.includes("doi.org/")&&(e=e.split("doi.org/")[1]),e.startsWith("10.")&&(null==i&&(i=await this.src.oadoi(e)),null==r&&(r=await this.src.crossref.works(e)),e=null!=(h=null!=i?i.journal_issns:void 0)?h:null!=r?r.ISSN:void 0)),"string"==typeof e&&(e=e.split(",")),s="unknown",null!=(null!=r?r.type:void 0)&&"journal-article"!==r.type?s="not applicable":(null!=r?r.type:void 0)&&"journal-article"!==r.type||(s="gold"===(null!=i?i.oa_status:void 0)||(null!=i?i.journal_is_oa:void 0)||(null!=i?i.journal_is_in_doaj:void 0)?"gold":"bronze"===(null!=i?i.oa_status:void 0)?"closed":"hybrid"===(null!=i?i.oa_status:void 0)?"hybrid":"closed",null==t&&e&&(t=await this.src.doaj.journals('bibjson.eissn.keyword:"'+e.join('" OR bibjson.eissn.keyword:"')+'" OR bibjson.pissn.keyword:"'+e.join('" OR bibjson.pissn.keyword:"')+'"',1)),null!=t?s=!1===(null!=(p=t.bibjson)&&null!=(d=p.apc)?d.has_apc:void 0)?"diamond":"gold":e&&(e&&await this.permissions.journals.transformative.count('issn:"'+e.join('" OR issn:"')+'"')?s="transformative":"closed"===s&&await this.src.oadoi.hybrid(e)&&(s="hybrid"))),s},t.permissions.journals.oa.type._log=!1,t.permissions.publishers.oa=async function(e){var t,i,r,s;return s={publisher:(null!=(r=null!=e?e:this.params.publisher)?r:this.params.oa).replace(/&/g,"")},await this.src.crossref.journals('publisher:"'+s.publisher+'"',1)||((t=await this.src.crossref.journals('publisher:"'+s.publisher.split(" ").join('" AND publisher:"')+'"',1))?t.publisher.toLowerCase()!==s.publisher.toLowerCase()&&((i=await this.levenshtein(t.publisher,s.publisher)).distance<5||(i.length.a>i.length.b?i.length.a:i.length.b)/i.distance>10)&&(s.publisher=t.publisher):s.journals=0),null==s.journals&&(s.journals=await this.src.crossref.journals.count('publisher:"'+s.publisher+'" AND NOT discontinued:true')),s.open=await this.src.doaj.journals.count('publisher:"'+s.publisher+'" AND NOT bibjson.discontinued_date:* AND NOT .bibjson.is_replaced_by:*'),s.percent=s.journals?Math.ceil(s.open/s.journals*100):s.open?100:0,s.oa=!s.journals&&s.open||s.journals&&s.journals===s.open,s},t.permissions.publishers.oa._log=!1,I=[].indexOf;try{r.report=JSON.parse(SECRETS_REPORT)}catch(e){}null==r.report&&(r.report={}),t.report=function(){return"OA.Works report"},t.report.chat=async function(e,t,i,r){var s,n,a;return(s=this.params.pmcid)&&(r=await this.src.epmc.xml(s),!0!==this.params.xml&&(r=r.split("<ref-list>")[0].replace(/\n/g," ").replace(/(<([^>]+)>)/gi,""))),null==e&&(e=null!=(n=this.params.prompt)?n:"Please return the data availability statement"),r&&(e+=" of the following research article: "+r),null==t&&(t=null!=(a=this.params.role)?a:"You are a terse text and data mining extraction tool in the scientific research publishing field"),r?this.src.openai.chat(e,t,this.params.model,this.params.json):{}},t.report.chat._auth="@oa.works",d=[],y=[],f=Date.now(),o=[],u=[],p=[],c=[],h=Date.now(),t.report.queued={_index:!0},t.report.queue=async function(e,t,i,r,s="default"){var n,a,l,o,u,c,h,p,m,g,v,b,w,_,x,O,k;if(this.params.empty)if("string"==typeof this.params.empty)for await(c of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_queued",'action.keyword:"'+this.params.empty+'"'))await this.report.queued(c._id,"");else await this.report.queued("");if(null==e&&(e=null!=(h=null!=(p=null!=(m=this.params.queue)?m:this.params.doi)?p:this.params.openalex)?h:this.params.pmcid),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),e)for(o=0,u=(g=Array.isArray(e)?e:[e]).length;o<u;o++)(k="object"==typeof(l=g[o])?null!=(v=null!=(b=null!=(w=null!=(_=null!=(x=l.ident)?x:l.identifier)?_:l.DOI)?w:l.doi)?b:l.openalex)?v:l.pmcid:l).startsWith("w")&&(k=k.replace("w","W")),k.startsWith("pmc")&&(k=k.replace("pmc","PMC")),k.includes("10.")&&(k=await this.report.cleandoi(k)),k&&"string"==typeof k&&(k.startsWith("10.")||k.startsWith("W")||k.startsWith("PMC"))&&I.call(y,k)<0&&(y.push(k),O=!0===(O="object"==typeof l&&null!=l.refresh?l.refresh:i)?0:!1===O?void 0:O,d.push({ident:k,refresh:O,everything:"object"==typeof l&&null!=l.everything?l.everything:r,action:"object"==typeof l&&null!=l.action?l.action:s}));if(d.length>2e3||Date.now()>f+15e3){for(n=[];a=d.shift();)y.shift(),n.push({_id:a.ident.toLowerCase(),identifier:a.ident,refresh:a.refresh,everything:a.everything,action:a.action,createdAt:Date.now()}),n.length>=1e4&&(await this.report.queued(n),n=[]);n.length&&await this.report.queued(n),f=Date.now()}return{queue:d.length}},t.report.queue._log=!1,t.report.queue._auth="@oa.works",t.report._runqueue=async function(e,t,i){var r,s,n,a,l,m,g,v,b,w,_,x,O,k;if(null==t&&(t='action:"default"'),null==i&&(i="desc"),null!=e)t="for requested identifier "+e;else{if(o.length)t="";else for((null!=(g=await this.report.queued(t,{size:2e3,sort:{createdAt:i}}))&&null!=(b=g.hits)?b.total:void 0)||'action:"default"'!==t||(j.log("no queued records found for specified qry",t,"checking for any other queued records..."),g=await this.report.queued("NOT action:*",{size:2e3,sort:{createdAt:i}}),t="queried * as none for qry "+t),(null!=g&&null!=(w=g.hits)?w.total:void 0)||d.length||(j.log("no queued records to process, waiting 5s..."),await this.sleep(5e3)),a=0,l=(O=null!=(_=null!=g&&null!=(x=g.hits)?x.hits:void 0)?_:[]).length;a<l;a++)v=O[a],o.push(v._source);e=null!=(k=null!=(m=o.shift())?m.identifier:void 0)?k:null!=m?m.DOI:void 0}if(j.log("report run queue",t,e,m,u.length,c.length,p,p.length),"string"==typeof e&&(e.startsWith("10.")||e.startsWith("W")||e.startsWith("PMC"))&&I.call(p,e)<0&&I.call(u,e)<0){for(await this.sleep(10);p.length>=5;)await this.sleep(500);p.push(e),this.report.works.process(e,void 0,null!=m?m.refresh:void 0,null!=m?m.everything:void 0,void 0,e)}if(c.length>=2e3||Date.now()>h+15e3||0===p.length&&I.call(u,e)>=0){for(j.log("run queue saving batch",c.length),await this.report.works(c),c=[];n=u.shift();)await this.report.queued(n.toLowerCase(),"");h=Date.now()}if(d.length>2e3||Date.now()>f+15e3){for(r=[];s=d.shift();)y.shift(),r.push({_id:s.ident.toLowerCase(),identifier:s.ident,refresh:s.refresh,everything:s.everything,createdAt:Date.now()}),r.length>=1e4&&(await this.report.queued(r),r=[]);j.log("run queue saving queued batch",d.length,r.length),r.length&&await this.report.queued(r),f=Date.now()}return!0},t.report._doqueue=function(){return this.report._runqueue()},t.report._doqueue._log=!1,t.report._doqueue._bg=!0,t.report._doreversequeue=function(){return this.report._runqueue(void 0,void 0,"asc")},t.report._doreversequeue._log=!1,t.report._doreversequeue._bg=!0,t.report._dochangesqueue=function(){return this.report._runqueue(void 0,'action:"changes" OR action:"years"')},t.report._dochangesqueue._log=!1,t.report._dochangesqueue._bg=!0,t.report.dev2live=async function(e){var t,i,r,s,n,a;for await(s of("number"==typeof(a=this.params.toalias)&&(a+=""),e?(r="paradigm_report_works",n="paradigm_b_report_works"):(r="paradigm_b_report_works",n="paradigm_report_works"),this.params.clear&&await this.index._send(n,"",void 0,!1,a),i=0,t=[],this.index._for(r,void 0,{scroll:"30m"})))i+=1,t.push(s),5e4===t.length&&(j.log("report works",e?"live2dev":"dev2live",r,n,a,i),await this.index._bulk(n,t,void 0,void 0,!1,a),t=[]);return t.length&&(await this.index._bulk(n,t,void 0,void 0,!1,a),t=[]),j.log(i,"report works",e?"live2dev":"dev2live",r,n,a,"complete"),i},t.report.dev2live._async=!0,t.report.dev2live._bg=!0,t.report.live2dev=function(){return this.report.dev2live(!0)},t.report.live2dev._async=!0,t.report.live2dev._bg=!0,t.report.live2dev._auth="root",t.report.oapolicy={_sheet:r.report.oapolicy_sheet,_format:function(e=[]){var t,i,r,s,n,a,l,o;for(a=[],r=0,s=(o="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<s;r++){for(i in n={},l=o[r]){if("string"==typeof l[i])if(l[i]=l[i].trim(),"true"===l[i].toLowerCase())l[i]=!0;else if("false"===l[i].toLowerCase())l[i]=!1;else if(l[i].startsWith("[")&&l[i].endsWith("]")||l[i].startsWith("{")&&l[i].endsWith("}"))try{l[i]=JSON.parse(l[i])}catch(e){t=e,j.log("cant parse "+i,l[i],t)}else l[i].includes(";")&&(l[i]=l[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(null!=l[i]&&""!==l[i])if(i.includes("."))try{this.dot(n,i,l[i])}catch(e){}else n[i]=l[i]}"{}"!==JSON.stringify(n)&&a.push(n)}return 1===a.length?a[0]:a}},t.report.cleandoi=function(e){var t;null==e&&(e=null!=(t=this.params.cleandoi)?t:this.params.doi);try{e.startsWith("http")&&(e="10."+e.split("/10.")[1])}catch(e){}try{e.startsWith("doi ")&&(e=e.toLowerCase().replace("doi ",""))}catch(e){}try{e=e.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{e=e.split(",http")[0]}catch(e){}return"string"==typeof e&&e.startsWith("10.")&&!e.includes("@")?e:""},t.report.cleandoi._log=!1,t.report.orgs={_sheet:r.report.orgs_sheet,_format:async function(e=[]){var t,i,r,s,n,a,l,o,u,c,h,p;for(o=[],r=0,n=(c="object"!=typeof e||Array.isArray(e)?e:[e]).length;r<n;r++){for(i in l={},u=c[r]){if("string"==typeof u[i])if(u[i]=u[i].trim(),"true"===u[i].toLowerCase())u[i]=!0;else if("false"===u[i].toLowerCase())u[i]=!1;else if(u[i].startsWith("[")&&u[i].endsWith("]")||u[i].startsWith("{")&&u[i].endsWith("}"))try{u[i]=JSON.parse(u[i])}catch(e){t=e,j.log("cant parse "+i,u[i],t)}else u[i].includes(";")&&(u[i]=u[i].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(i.includes("."))try{this.dot(l,i,u[i])}catch(e){}else l[i]=u[i]}if(Array.isArray(l.sheets))for(s=0,a=(h=l.sheets).length;s<a;s++)(p=h[s]).url=await this.encrypt(p.url);else delete l.sheets;"{}"!==JSON.stringify(l)&&o.push(l)}return 1===o.length?o[0]:o}},t.report.orgs.orgkeys={_index:!0,_auth:"@oa.works"},t.report.orgs.key=async function(e){var t,i;if(null==e&&(e=this.params.org),null!=e){if(e=e.toLowerCase(),null==(i=await this.report.orgs.orgkeys('org.keyword:"'+e+'"',1))||this.refresh){if(null!=i){i.lastRefreshedAt=await this.epoch();try{i.lastRefreshedBy=this.user.email}catch(e){}}else{i={org:e,createdAt:await this.epoch()};try{i.createdBy=this.user.email}catch(e){}}return t=await this.uid(),i.key=await this.encrypt(t),await this.report.orgs.orgkeys(i),t}i.lastRetrievedAt=await this.epoch();try{i.lastRetrievedBy=this.user.email}catch(e){}return await this.report.orgs.orgkeys(i),this.decrypt(i.key)}},t.report.orgs.key._log=!1,t.report.orgs.key._auth="@oa.works",t.report.orgs.supplements={_index:!0,_auth:"@oa.works"},t.report.orgs.supplements.load=async function(e,t,i){var s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe,Oe,ke,Se,je,Ae,Ie,Ee,De;if(Se=await this.epoch(),"report.orgs.supplements.load"===this.fn&&null==i&&(i=this.params.clear),i&&await this.report.orgs.supplements(""),null==e&&(e=this.params.org),null==t&&(t=this.params.sheet),T=await this.src.google.sheets(r.report.orgs_sheet),Ie=0,h=[],ge={},Oe=[],ke={},xe=[],!i)for await(je of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements","replaced:*"))ge[je.replaced]=je.DOI;for(p=0,g=(R="object"!=typeof T||Array.isArray(T)?T:[T]).length;p<g;p++){for(a in A={},q=R[p]){if("string"==typeof q[a])if(q[a]=q[a].trim(),"true"===q[a].toLowerCase())q[a]=!0;else if("false"===q[a].toLowerCase())q[a]=!1;else if(q[a].startsWith("[")&&q[a].endsWith("]")||q[a].startsWith("{")&&q[a].endsWith("}"))try{q[a]=JSON.parse(q[a])}catch(e){}else q[a].includes(";")&&(q[a]=q[a].replace(/; /g,";").replace(/ ;/g,";").trim().split(";"));if(a.includes("."))try{await this.dot(A,a,q[a])}catch(e){}else A[a]=q[a]}if(Array.isArray(A.sheets))for(d=0,v=(V=A.sheets).length;d<v;d++)if(_e=V[d],!(e&&A.name!==e||t&&_e.name!==t)){if(j.log(A.name,_e.name,_e.url),P=0,E=[],o=[],be=[],De=null==(ie=this.params.update)||ie,f=!1,Ae=[],await this.sleep(1e3),null==this.params.update)try{if(n=await this.src.google.sheets({sheetid:_e.url,sheet:"m_admin",headers:!1}),await this.sleep(1e3),Array.isArray(n)&&n.length&&"last updated"===n[0][0].toLowerCase()&&(f=n[0][1])){if([m,O]=f.split(" "),m=m.split("/").reverse().join("-"),f=await this.epoch(m+"T"+O),j.log(A.name,_e.name,"last updated",f),"number"==typeof f&&f>15778368e5){if(!(y=ke[_e.name])){try{y=await this.report.orgs.supplements('sheets.keyword:"'+_e.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=y&&null!=(he=y.hits)?he.hits:void 0)&&(y=y.hits.hits[0]._source,ke[_e.name]=y)}(null!=y?y.updated:void 0)&&f<=y.updated&&(De=f)}}else{if(!(y=ke[_e.name])){try{y=await this.report.orgs.supplements('sheets.keyword:"'+_e.name+'"',{size:1,sort:{updated:"desc"}})}catch(e){}null!=(null!=y&&null!=(pe=y.hits)?pe.hits:void 0)&&(y=y.hits.hits[0]._source,ke[_e.name]=y)}(null!=y?y.updated:void 0)&&y.updated>=Se-864e5&&(De=!1)}}catch(e){}if(!0!==De)j.log(A.name,_e.name,"NOT loading because",f,"is not after",De);else{await this.sleep(1e3);try{be=await this.src.google.sheets({sheetid:_e.url,sheet:"Export",headers:!1})}catch(e){}for(Ee=0;(!Array.isArray(be)||!be.length)&&Ee<5;){await this.sleep(5e3),Ee+=1;try{be=await this.src.google.sheets({sheetid:_e.url,sheet:"Export",headers:!1})}catch(e){}}if(Array.isArray(be)&&be.length){for(k=0,b=(de=be.shift()).length;k<b;k++)l=de[k],o.push(l.toLowerCase().trim().replace(/ /g,"_").replace("?",""));for(S=0,w=be.length;S<w;S++){for(u in ve=be[S],P+=1,we={org:A.name,sheets:_e.name,ror:A.ror,paid:!0===A.paid?A.paid:void 0},o)if("pmcid"===(a=o[u]).toLowerCase())we[a]=ve[u],we.pmcid="PMC"+ve[u].toLowerCase().replace("pmc","");else if("doi"===a||"DOI"===a)we[a]=ve[u];else{if(c="","apc_cost"===a||"wellcome.apc_paid_actual_currency_excluding_vat"===a||"wellcome.apc_paid_gbp_inc_vat_if_charged"===a||"wellcome.additional_publication_fees_gbp"===a||"wellcome.amount_of_apc_charged_to_coaf_grant_inc_vat_if_charged_in_gbp"===a||"wellcome.amount_of_apc_charged_to_rcuk_oa_fund_inc_vat_if_charged_in_gbp"===a||"wellcome.amount_of_apc_charged_to_wellcome_grant_inc_vat_in_gbp"===a)try{c=parseFloat(ve[u])}catch(e){}else c="number"==typeof ve[u]?ve[u]:ve[u]?"true"===(fe=ve[u].trim().toLowerCase())||"yes"===fe||"false"!==(ye=ve[u].trim().toLowerCase())&&"no"!==ye&&("grant_id"===(me=a.toLowerCase())||"ror"===me?ve[u].replace(/\//g,",").replace(/ /g,"").split(","):ve[u]):void 0,"string"==typeof ve[u]&&ve[u].includes(";")&&(c=ve[u].split(";"));null!=c&&""!==c&&(a.includes(".")?await this.dot(we,a,c):we[a]=c)}we.doi?null==we.DOI&&(we.DOI=we.doi+""):we.doi=(null!=(W=we.DOI)?W:"")+"";try{we.DOI.startsWith("http")&&(we.DOI="10."+we.DOI.split("/10.")[1])}catch(e){}try{we.DOI.startsWith("doi ")&&(we.DOI=we.DOI.toLowerCase().replace("doi ",""))}catch(e){}try{we.DOI=we.DOI.toLowerCase().trim().split("\\")[0].replace(/\/\//g,"/").replace(/\/ /g,"/").replace(/^\//,"").split(" ")[0].split("?")[0].split("#")[0].split(" pmcid")[0].split("\n")[0].replace(/[\u{0080}-\u{FFFF}]/gu,"").trim()}catch(e){}try{we.DOI=we.DOI.split(",http")[0]}catch(e){}("string"==typeof we.DOI&&we.DOI.startsWith("10.")&&!we.DOI.includes("@")||we.openalex||we.pmcid)&&(!i&&we.DOI&&null!=ge[we.DOI]&&(we.replaced=we.DOI,we.DOI=ge[we.DOI]),"string"==typeof we.email&&we.email.includes("@")&&(we.email=await this.encrypt(we.email)),we.osdid=(A.name.replace(/[^a-zA-Z0-9-_ ]/g,"")+"_"+_e.name+"_"+(null!=(U=null!=(M=we.DOI)?M:we.openalex)?U:we.pmcid)).replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),we._id=we.osdid,E.push(we.osdid),B=null!=(z=null!=(F=we.DOI)?F:we.openalex)?z:we.pmcid,I.call(h,B)<0&&h.push(null!=(J=null!=($=we.DOI)?$:we.openalex)?J:we.pmcid),we.updated=Se,Ae.push(we),Ie+=1)}j.log(A.name,_e.name,Ae.length,h.length),await this.report.orgs.supplements(Ae)}for await(je of(await this.sleep(2e3),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'org.keyword:"'+A.name+'" AND sheets.keyword:"'+_e.name+'"',{scroll:"30m",include:["osdid","DOI","openalex","pmcid"]})))X=je.osdid,I.call(E,X)<0&&(await this.report.orgs.supplements(je.osdid,""),G=null!=(Y=null!=(H=je.DOI)?H:je.openalex)?Y:je.pmcid,I.call(h,G)<0&&h.push(null!=(Z=null!=(K=je.DOI)?K:je.openalex)?Z:je.pmcid))}Oe.push({org:A.name,sheet:_e.name,rows:P,update:De,supplements:Ae.length}),xe.push(_e.name)}}if(!i&&!e&&!t)for(C=0,_=(Q=await this.report.works.suggest("supplements.sheets",void 0,5e3)).length;C<_;C++)if(s=Q[C],I.call(xe,s)<0){for await(je of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'sheets.keyword:"'+s+'"',{scroll:"30m",include:["osdid"]}))await this.report.orgs.supplements(je.osdid,"");for await(D of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",'supplements.sheets.keyword:"'+s+'"',{scroll:"30m",include:["DOI","openalex","pmcid"]}))(D.DOI&&(ee=D.DOI,I.call(h,ee)<0)||!D.DOI&&D.openalex&&(te=D.openalex,I.call(h,te)<0)||!D.DOI&&!D.openalex&&D.pmcid&&(re=D.pmcid,I.call(h,re)<0))&&h.push(null!=(se=null!=(ne=D.DOI)?ne:D.openalex)?se:D.pmcid)}if(i)for(L=0,x=(ae=await this.report.works("orgs:* OR supplements.sheets:*",{include:["DOI","openalex","pmcid"]})).length;L<x;L++)((N=ae[L]).DOI&&(le=N.DOI,I.call(h,le)<0)||!N.DOI&&N.openalex&&(oe=N.openalex,I.call(h,oe)<0)||!N.DOI&&!N.openalex&&N.pmcid&&(ue=N.pmcid,I.call(h,ue)<0))&&h.push(null!=(ce=N.DOI)?ce:N.openalex);return await this.sleep(6e4),j.log("report orgs supplements load",Ie,h.length,await this.epoch()-Se),h.length&&(j.log("report orgs supplements load ready to call works load",h.length),await this.report.works.load(void 0,void 0,h,void 0,void 0,Se,void 0,Oe)),Ie},t.report.orgs.supplements.load._bg=!0,t.report.orgs.supplements.load._async=!0,t.report.orgs.supplements.load._log=!1,t.report.emails={_sheet:r.report.emails_sheet,_key:"doi",_auth:"@oa.works"},t.report.email=async function(e){var t,i,r,s,n,a,l,o,u,c;if((e||this.params.orgkey)&&(null==e&&(e=null!=(n=this.params.email)?n:this.params.doi),null!=e&&(null!=(s=await this.report.works(e))?s.email:void 0))){if(s.email.includes("@"))return s.email;if(c=await this.encrypt(this.params.orgkey),"string"==typeof(null!=(r=await this.report.orgs.orgkeys('key.keyword:"'+c+'"',1))?r.org:void 0)&&r.org.length){for(o=[],t=0,i=(a=s.orgs).length;t<i;t++)u=a[t],o.push(u.toLowerCase());if(l=r.org,I.call(o,l)>=0)return this.decrypt(s.email)}}},t.report.email._log=!1,t.report.works={_index:!0},t.report.works.process=async function(e,t,i,r,s,n){var a,l,o,h,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de,fe,ye,me,ge,ve,be,we,_e,xe,Oe,ke,Se,je,Ae,Ie,Ee,De,Ce,Ne,Le,Pe,qe,Te,Re,We,Ue,Me,Be,ze,Fe,Je,$e,Xe,Ve,Ge,Ye,He,Ze,Ke,Qe,et,tt,it,rt,st,nt,at,lt,ot,ut,ct,ht,pt,dt,ft,yt,mt;try{if(at=await this.epoch(),null==e&&(e=this.params.process),k=!1,0===i&&(i=!0),null==i&&(i=this.refresh),null==r&&(r=this.params.everything),"string"==typeof e&&e.toLowerCase().startsWith("pmc")&&(k=e.toLowerCase().replace("pmc","PMC"),e=void 0,null==t&&(t=await this.src.openalex.works('ids.pmcid:"'+k.toLowerCase().replace("pmc","")+'"',1)),null==t&&(_=await this.src.epmc.pmc(k,i))&&(e=_.doi)),!t&&e&&(e.includes("openalex.org/")||e.startsWith("W"))&&(e.includes("openalex.org/")&&(e=e.split("openalex.org/")[1]),t=e,e=void 0),"string"==typeof t&&((t=(t=t.split(t.includes("doi.org")?"doi.org/":"/").pop()).replace(/\/$/,"")).startsWith("10.")&&(t=t.toLowerCase(),null==e&&(e=t)),t.startsWith("W")||t.startsWith("10.")))try{Z=await this.src.openalex.works(t.startsWith("W")?'id.keyword:"https://openalex.org/'+t+'"':'ids.doi:"https://doi.org/'+t+'"',1);try{(null!=Z&&null!=(ae=Z.hits)&&null!=(le=ae.hits)?le.length:void 0)&&(Z=Z.hits.hits[0]._source)}catch(e){}(null!=Z?Z.id:void 0)&&(t=Z)}catch(e){}if(!0!==i&&("object"==typeof t&&(null!=(ge=t.ids)?ge.doi:void 0)||"string"==typeof t&&t.startsWith("10."))&&(!(null!=(O=await this.report.works("string"==typeof t?t:t.ids.doi.split(".org/")[1]))?O.updated:void 0)||i&&O&&O.updated<i)&&(O=void 0),"string"!=typeof t||t.startsWith("W")||t.startsWith("10.")||(t=void 0),null==e&&"object"==typeof t&&(null!=t&&null!=(Ie=t.ids)?Ie.doi:void 0)&&(e=t.ids.doi),"string"==typeof e&&e.includes("doi.org/")&&(e=e.split("doi.org/").pop()),"string"!=typeof e||e.startsWith("10.")||(e=void 0),"string"==typeof e&&(e=e.toLowerCase()),"string"==typeof e&&(ft=await this.src.crossref.works(e))&&(e=ft),"object"!=typeof e||e.DOI||(e=void 0),null!=e&&!0!==i&&(null==O&&(O=await this.report.works("string"==typeof e?e:e.DOI)),(!(null!=O?O.updated:void 0)||i&&O&&O.updated<i)&&(O=void 0)),null!=e&&null==t&&(t=await this.src.openalex.works("object"==typeof e?e.DOI:e)),"string"!=typeof t&&(null!=t?t.id:void 0)||(t=void 0),"object"==typeof e&&e.DOI){for((null!=O?O.updated:void 0)&&(null!=(We=e.indexed)?We.timestamp:void 0)&&O.updated<e.indexed.timestamp&&(O=void 0),ne={DOI:e.DOI.toLowerCase(),subject:e.subject,subtitle:e.subtitle,volume:e.volume,published_year:e.year,issue:e.issue,publisher:e.publisher,published_date:e.published,funder:e.funder,issn:e.ISSN,subtype:e.subtype},Ke=null!=(Ye=e.assertion)?Ye:[],A=0,N=Ke.length;A<N;A++)(h=(null!=(Qe=(o=Ke[A]).label)?Qe:"").toLowerCase()).includes("accepted")&&h.split(" ").length<3&&(null!=(l=await this.dateparts(o.value))?l.date:void 0)&&(l.timestamp?null==ne.accepted_date&&(ne.accepted_date=l.date):null==ne.bad_accepted_date&&(ne.bad_accepted_date="bad date "+l.date)),h.includes("received")&&(null!=(st=await this.dateparts(o.value))?st.date:void 0)&&(st.timestamp?null==ne.submitted_date&&(ne.submitted_date=st.date):null==ne.bad_submitted_date&&(ne.bad_submitted_date="bad date "+st.date));for(tt=null!=(et=ne.funder)?et:[],D=0,L=tt.length;D<L;D++)delete tt[D]["doi-asserted-by"];for(e.title&&"string"!=typeof e.title&&e.title.length&&(ne.title=e.title[0]),e["container-title"]&&e["container-title"].length&&(ne.journal=e["container-title"][0]),null!=e["reference-count"]&&(ne["reference-count"]=e["reference-count"]),ue=null!=(oe=e.license)?oe:[],V=0,R=ue.length;V<R;V++)"am"!==(ce=(C=ue[V])["content-version"])&&"vor"!==ce&&"tdm"!==ce&&"unspecified"!==ce||(ne["crossref_license_url_"+C["content-version"]]=C.URL);for(ne.crossref_is_oa=null!=e.is_oa&&e.is_oa,m=[],a=async(t,i)=>(t.DOI=e.DOI,t.replaced=i,await this.report.orgs.supplements(t.osdid,""),t._id=t.osdid=t.osdid.split("_10.")[0]+"_"+t.DOI.replace(/[\u{0080}-\u{FFFF}]/gu,"").toLowerCase().replace(/\//g,"_").replace(/ /g,"_"),m.push(t)),pe=null!=(he=e["update-to"])?he:[],G=0,W=pe.length;G<W;G++)if((ut=pe[G]).DOI!==e.DOI&&"erratum"!==(de=ut.type.toLowerCase())&&"correction"!==de)for await(lt of(ne.replaces=[],ne.replaces.push({DOI:ut.DOI,type:ut.type,updated:null!=(fe=ut.updated)?fe.timestamp:void 0}),await this.report.works(ut.DOI)&&await this.report.works(ut.DOI,""),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",'DOI.keyword:"'+ut.DOI+'"')))a(lt,ut.DOI);m.length&&await this.report.orgs.supplements(m),s&&(null==ne.replaces&&(ne.replaces=[]),ne.replaces.push({DOI:s,type:"relation"}))}if(null!=t){try{(null!=O?O.updated:void 0)&&!t.is_paratext&&!t.is_retracted&&t.updated_date&&O.updated<await this.epoch(t.updated_date)&&(O=void 0)}catch(e){}for(null==ne&&(ne={}),ne.openalx=t,t.id&&(ne.openalex=t.id.split("/").pop()),ne.DOI||null==(null!=(ye=t.ids)?ye.doi:void 0)||(ne.DOI=t.ids.doi.split("doi.org/").pop().toLowerCase()),(null!=(me=t.ids)?me.pmid:void 0)&&(ne.PMID=t.ids.pmid.split("/").pop()),!ne.PMCID&&(null!=(ve=t.ids)?ve.pmcid:void 0)&&(ne.PMCID="PMC"+t.ids.pmcid.split("/").pop().toLowerCase().replace("pmc","")),t.title&&(ne.title=t.title),K=0,U=(be=["authorships","concepts","cited_by_count","type","is_paratext","is_retracted"]).length;K<U;K++)ne[H=be[K]]=t[H];for(t.publication_date&&(ne.published_date=t.publication_date),t.publication_year&&(ne.published_year=t.publication_year),(null!=(we=t.host_venue)?we.issn:void 0)&&t.host_venue.issn.length&&(ne.issn=t.host_venue.issn),t.biblio&&(ne.biblio=t.biblio),t.referenced_works&&(ne.referenced_works=t.referenced_works.length),xe=null!=(_e=ne.concepts)?_e:[],re=0,M=xe.length;re<M;re++){delete(g=xe[re]).wikidata;try{g.score=Math.floor(100*g.score)}catch(e){}}for(ke=null!=(Oe=ne.authorships)?Oe:[],ot=0,B=ke.length;ot<B;ot++)for(je=null!=(Se=ke[ot].institutions)?Se:[],ht=0,z=je.length;ht<z;ht++)delete je[ht].type}if(null==ne&&(ne={}),ne.DOI||"string"!=typeof e||(ne.DOI=e.toLowerCase()),k&&!ne.PMCID&&(ne.PMCID=k),!(null!=O?O.oadoi:void 0)&&ne.DOI){for(ne.oadoi=!0,Ee=null!=(Ae=null!=(Y=await this.src.oadoi(ne.DOI))?Y.oa_locations:void 0)?Ae:[],pt=0,F=Ee.length;pt<F;pt++)if("publisher"===(X=Ee[pt]).host_type&&(null==ne.publisher_license&&(ne.publisher_license=X.license),null==ne.publisher_url_for_pdf&&(ne.publisher_url_for_pdf=X.url_for_pdf),null==ne.publisher_version&&(ne.publisher_version=X.version)),"repository"===X.host_type&&(X.url&&X.url.toLowerCase().includes("pmc")&&(ne.PMCID||(ee=X.url.toLowerCase().split("pmc")[1].split("/")[0].split("?")[0].split("#")[0].split(".")[0].replace(/[^0-9]/g,"")).length&&!isNaN(parseInt(ee))&&(ne.PMCID="PMC"+ee),X.license&&!ne.epmc_licence&&(ne.epmc_licence=X.license)),!ne.repository_url||!ne.repository_url.includes("pmc")||!ne.repository_url.includes("ncbi.")&&X.url.includes("ncbi.")))for(dt=0,J=(De=["license","url_for_pdf","url","version"]).length;dt<J;dt++)X[H=De[dt]]&&(ne["repository_"+H]=X[H]);ne.repository_url&&(ne.repository_url.toLowerCase().includes("europepmc.")||ne.repository_url.toLowerCase().includes("ncbi."))&&(null==ne.PMCID&&(ne.PMCID="PMC"+ne.repository_url.toLowerCase().split("pmc").pop().split("/")[0].split("#")[0].split("?")[0].split(".")[0].replace(/[^0-9]/g,"")),ne.repository_url_in_pmc=!0),null!=Y&&(ne.best_oa_location_url=null!=(Ce=Y.best_oa_location)?Ce.url:void 0,ne.best_oa_location_url_for_pdf=null!=(Ne=Y.best_oa_location)?Ne.url_for_pdf:void 0,ne.oa_status=Y.oa_status,ne.has_repository_copy=Y.has_repository_copy,ne.has_oa_locations_embargoed=!(null==Y.oa_locations_embargoed||!Y.oa_locations_embargoed.length),ne.title=Y.title,!ne.issn&&"string"==typeof Y.journal_issns&&Y.journal_issns.length&&(ne.issn=Y.journal_issns.split(",")),null==ne.journal&&(ne.journal=Y.journal_name),null==ne.publisher&&(ne.publisher=Y.publisher),Y.published_date&&(ne.published_date=Y.published_date),Y.year&&(ne.published_year=Y.year),null!=Y.is_oa&&(ne.oadoi_is_oa=Y.is_oa))}if(ne.supplements=[],ne.orgs=[],ne.DOI||ne.openalex||ne.PMCID)for await(lt of(nt="",ne.DOI&&(nt+='DOI.keyword:"'+ne.DOI+'"'),ne.openalex&&(nt+=(nt?" OR ":"")+'openalex.keyword:"'+ne.openalex+'"'),ne.PMCID&&(nt+=(nt?" OR ":"")+'pmcid.keyword:"'+ne.PMCID+'"'),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",nt,{sort:{"osdid.keyword":"asc"}})))Le=lt.org,I.call(ne.orgs,Le)<0&&ne.orgs.push(lt.org),lt.paid&&(ne.paid=!0),!ne.email&&lt.email&&(ne.email=lt.email),lt.author_email_name_ic&&(ne.author_email_name=lt.author_email_name_ic),ne.supplements.push(lt);if(null!=O){if(null==i)for(E in!ne.author_email_name&&O.author_email_name&&O.email&&ne.email&&ne.email.toLowerCase()===O.email.toLowerCase()&&(ne.author_email_name=O.author_email_name),O)null==ne[E]&&(ne[E]=O[E]);null==ne.PMCID&&(ne.PMCID=O.PMCID)}if(null!=ne.authorships&&ne.email&&!ne.author_email_name&&(null==(null!=O?O.authorships:void 0)||!(null!=O?O.email:void 0)))if(w=ne.email.includes("@")?ne.email:await this.decrypt(ne.email),1===ne.authorships.length)ne.author_email_name="Dr. "+(null!=(Pe=ne.authorships[0].author)?Pe.display_name:void 0);else{for(it=w.split("@")[0].toLowerCase().replace(/[^a-z]/g,""),d="",f="",y=1e6,qe=ne.authorships,yt=0,P=qe.length;yt<P;yt++)(se=null!=(Te=qe[yt].author)?Te.display_name:void 0)&&((rt=(await this.levenshtein(it,se.toLowerCase().replace(/[^a-z]/g,""))).distance/se.length)<y&&(y=rt,f=se),y>.2&&(it.endsWith(se.split(" ").pop().toLowerCase())||se.split(" ")[0].length>4&&it.includes(se.split(" ")[0].toLowerCase()))&&(y=.1,f=se),!d&&it.startsWith((se.split(" ")[0].slice(0,1)+se.split(" ").pop().slice(0,1)).toLowerCase())&&(d=se));f&&y<.7&&(ne.author_email_name="Dr. "+f.split(" ").pop()),!ne.author_email_name&&d&&(ne.author_email_name="Dr. "+d)}if("string"==typeof ne.email&&ne.email.includes("@")&&(ne.email=await this.encrypt(ne.email)),ne.PMCID&&ne.PMID&&null!=ne.pubtype&&ne.submitted_date&&ne.accepted_date||(ie=ne.PMID?await this.src.pubmed(ne.PMID):ne.DOI?await this.src.pubmed.doi(ne.DOI):void 0)&&(!ne.PMCID&&(null!=ie&&null!=(Re=ie.identifier)?Re.pmc:void 0)&&(ne.PMCID="PMC"+ie.identifier.pmc.toLowerCase().replace("pmc","")),!ne.PMID&&(null!=ie&&null!=(Ue=ie.identifier)?Ue.pubmed:void 0)&&(ne.PMID=ie.identifier.pubmed),ne.pubtype=ie.type,null==ne.submitted_date&&(ne.submitted_date=null!=(Me=ie.dates)&&null!=(Be=Me.PubMedPubDate_received)?Be.date:void 0),null==ne.accepted_date&&(ne.accepted_date=null!=(ze=ie.dates)&&null!=(Fe=ze.PubMedPubDate_accepted)?Fe.date:void 0)),ne.DOI&&!ne.journal_oa_type&&(Q=await this.permissions(await this.copy(ne),void 0,void 0,Y,e,at-12096e5),ne.can_archive=null!=Q&&null!=(Je=Q.best_permission)?Je.can_archive:void 0,null==ne.can_archive&&((null!=($e=null!=Y&&null!=(Xe=Y.best_oa_location)?Xe.license:void 0)?$e:"").includes("cc")||(null!=Y?Y.journal_is_in_doaj:void 0))&&(ne.can_archive=!0),ne.version=null!=Q&&null!=(Ve=Q.best_permission)?Ve.version:void 0,ne.journal_oa_type=await this.permissions.journals.oa.type(ne.issn,void 0,Y,e),null==ne.journal_oa_type&&(ne.journal_oa_type="unsuccessful")),ne.orgs.length&&(r=!0),r){if((ne.DOI||ne.PMCID)&&(null!=_||!ne.PMCID||null==ne.pubtype)&&(null!=_?_:_=ne.PMCID?await this.src.epmc.pmc(ne.PMCID,i):await this.src.epmc.doi(ne.DOI,i)))for(!ne.PMCID&&_.pmcid&&(ne.PMCID=_.pmcid),Ze=null!=(Ge=null!=(He=_.pubTypeList)?He.pubType:void 0)?Ge:[],mt=0,q=Ze.length;mt<q;mt++)te=Ze[mt],null==ne.pubtype&&(ne.pubtype=[]),I.call(ne.pubtype,te)<0&&ne.pubtype.push(te);if(!ne.PMCID||ne.epmc_licence||!i&&ne.tried_epmc_licence||(ne.tried_epmc_licence=!0,$=await this.src.epmc.licence(ne.PMCID,_,void 0,i),ne.epmc_licence=null!=$?$.licence:void 0),null==ne.pmc_has_data_availability_statement&&(ne.pmc_has_data_availability_statement=ne.PMCID&&await this.src.pubmed.availability(ne.PMCID)),ne.PMCID&&(i||!ne.data_availability_statement)&&(ne.data_availability_statement=await this.src.epmc.statement(ne.PMCID,_,i),ne.data_availability_statement&&(ct=await this.src.epmc.statement.url(ne.PMCID,_,ne.data_availability_statement,i))))for(S=0,T=ct.length;S<T;S++)(v=ct[S]).includes("doi.org/")?(b=v.split("doi.org/")[1].toLowerCase(),null==ne.data_availability_doi&&(ne.data_availability_doi=[]),I.call(ne.data_availability_doi,b)<0&&ne.data_availability_doi.push(b)):(null==ne.data_availability_url&&(ne.data_availability_url=[]),I.call(ne.data_availability_url,v)<0&&ne.data_availability_url.push(v))}return ne.is_oa=ne.oadoi_is_oa||ne.crossref_is_oa||"gold"===ne.journal_oa_type,null==ne._id&&(ne._id=ne.DOI?ne.DOI.toLowerCase().replace(/\//g,"_"):ne.openalex?ne.openalex.toLowerCase():ne.PMCID?ne.PMCID.toLowerCase():void 0),ne.supplemented=await this.epoch(),ne.updated=ne.supplemented,ne.took=ne.supplemented-at,this.params.process&&!1!==this.params.save&&(ne.DOI&&ne.DOI.toLowerCase()===this.params.process.toLowerCase()||ne.openalex&&ne.openalex.toLowerCase()===this.params.process.toLowerCase()||ne.PMCID&&ne.PMCID.toLowerCase()===this.params.process.toLowerCase())?await this.report.works(ne):n&&(u.push(n),null!=ne._id&&c.push(ne),p.splice(p.indexOf(n),1)),ne}catch(t){x=t,j.log("report works process error",x,"object"==typeof e?e.DOI:e),n&&(await this.sleep(3e3),p.splice(p.indexOf(n),1),this.report.queue(n,void 0,i,r))}},t.report.works.process._log=!1,t.report.works.load=async function(e,t,i,r,s,n,a,l){var o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E,D,C,N,L,P,q,T;if(C=await this.epoch(),null==r&&(r=null!=(y=this.params.load)?y:(await this.date()).split("-")[0]),null==t&&(t=null!=(m=null!=(x=this.params.org)?x:this.params.orgs)?m:"orgs"===this.params.load),null==i&&"string"==typeof this.params.load&&(this.params.load.startsWith("10.")||this.params.load.toLowerCase().startsWith("pmc")||this.params.load.toLowerCase().startsWith("w"))&&(i=this.params.load),"string"==typeof i&&(i=[i]),this.fn.startsWith("report.works.load")&&null==s&&(s=this.params.clear),E=this.refresh,null==a&&(a="everything"===this.params.load),T=0,this.params.q){for await(L of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works",this.params.q,{scroll:"5m",include:["DOI","openalex","PMCID"]})))D=null!=(O=null!=(k=L.DOI)?k:L.openalex)?O:L.PMCID,I.call(i,D)<0&&i.push(D);j.log("report works supplements to load from query",this.params.q)}else if("supplements"===this.params.load){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs_supplements",e?"updated:<"+e:t?'org:"'+t+'"':void 0,{scroll:"5m",include:["DOI","openalex","pmcid"]})))D=null!=(S=null!=(A=N.DOI)?A:N.openalex)?S:N.pmcid,I.call(i,D)<0&&i.push(D);j.log("report works supplements to load",e,t,i.length)}else if(a){for await(N of(null==i&&(i=[]),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","NOT pmc_has_data_availability_statement:*",{scroll:"5m",include:["DOI","openalex","PMCID"]})))D=null!=(g=null!=(v=N.DOI)?v:N.openalex)?g:N.PMCID,I.call(i,D)<0&&i.push(D);j.log("report works supplements to load everything for records that do not yet have everything",i.length)}if(Array.isArray(i))j.log("report works queueing identifiers batch",i.length),await this.report.queue(i,void 0,null!=e?e:E,a),T+=i.length;else{for await(f of(o=async(i,s)=>{var n,l,o;for await(l of(null==i&&(i="(funder.name:* OR author.affiliation.name:*) AND year.keyword:"+r),e&&(i="("+i+") AND srcday:>"+e),o=await this.src.crossref.works.count(i),n=[],j.log("report works load crossref by query expects",i,o),this.index._for("src_crossref_works",i,{include:["DOI"],scroll:"30m"})))!t&&r===this.params.load&&await this.report.works(l.DOI)||(T+=1,n.push(l.DOI));if(n.length)return j.log("report works load crossref loading",n.length),await this.report.queue(n,void 0,null!=e?e:E,a,s)},!0!==t&&r===this.params.load&&await o(void 0,"years"),u=async(i,s)=>{var n,l,o,u,c;for await(l of(null==i&&(i="authorships.institutions.display_name:* AND publication_year:"+r),e&&(i="("+i+") AND updated_date:>"+e),u=await this.src.openalex.works.count(i),n=[],j.log("report works load openalex by query expects",i,u),this.index._for("src_openalex_works",i,{include:["id","ids"],scroll:"30m"})))(o=(null!=(c=l.ids)?c.doi:void 0)?"10."+l.ids.doi.split("/10.")[1]:l.id.split("openalex.org/").pop())&&(!t&&r===this.params.load&&o.startsWith("10.")&&await this.report.works(o)||(T+=1,n.push(o)));if(n.length)return j.log("report works load openalex loading",n.length),await this.report.queue(n,void 0,null!=e?e:E,a,s)},!0!==t&&r===this.params.load&&await u(void 0,"years"),this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_orgs","string"==typeof t?'name:"'+t+'"':"paid:true",{scroll:"10m"}))){if(null!=(b=f.source)?b.crossref:void 0){try{f.source.crossref.includes("%")&&(f.source.crossref=decodeURIComponent(decodeURIComponent(f.source.crossref)))}catch(e){}j.log("report works load crossref by org",f.name);try{await o(f.source.crossref)}catch(e){}}if(null!=(w=f.source)?w.openalex:void 0){try{f.source.openalex.includes("%")&&(f.source.openalex=decodeURIComponent(decodeURIComponent(f.source.openalex)))}catch(e){}j.log("report works load openalex by org",f.name);try{await u(f.source.openalex)}catch(e){}}}if(e)for await(c of this.index._for("paradigm_"+(this.S.dev?"b_":"")+"report_works","orgs:* AND updated:<"+e,{scroll:"10m"}))await this.src.crossref.works.count('DOI.keyword:"'+c.DOI+'" AND srcday:>'+e)&&await this.report.queue(c.DOI,void 0,null!=e?e:E,a)}for(q=await this.epoch()-C,P="Report works queued "+T+(this.S.dev?" (dev)":"")+"\n",i&&i.length&&(P+=i.length+" identifiers were provided to process\n"),this.params.q&&(P+="These were derived by searching for provided query"+JSON.stringify(this.params.q)+"\n"),"supplements"===this.params.load&&(P+="These were derived by searching for all works that already have supplements attached\n"),a&&(P+="These were derived by searching for all works that have not yet had everything fully processed\n"),n&&(P+="These were provided by an orgs supplements refresh which took "+Math.ceil((C-n)/1e3/60)+"m\n"),"string"==typeof t&&(P+="The load process was limited to "+t+"\n"),e&&(P+="The load process was run for changes since "+await this.datetime(e)+"\n"),!r||!this.params.load&&e||(null!=i?i:[]).length||(P+="The load process was run for year "+r+"\n"),p=0,d=(_=null!=l?l:[]).length;p<d;p++)h=_[p],P+="\n"+JSON.stringify(h)+"\n";return j.log("Report works loaded",T,q),await this.mail({to:["mark@oa.works","joe@oa.works"],subject:"OA report works loaded "+T,text:P}),T},t.report.works.load._log=!1,t.report.works.load._bg=!0,t.report.works.load._async=!0,t.report.works.load._auth="@oa.works",t.report.works.changes=function(e,t){var i,r;return null==e&&(e=null!=(i=null!=(r=this.params.changes)?r:this.params.timestamp)?i:Date.now()-9e7),null==t&&(t=this.params.org),this.report.works.load(e,t),!0},t.report.works.changes._log=!1,t.report.works.changes._bg=!0,t.report.works.changes._async=!0,t.report.works.changes._auth="@oa.works",I=[].indexOf,null==t.svc&&(t.svc={}),t.svc.rscvd={_index:!0},t.svc.rscvd.form=async function(){var e,t,i,r,s,n,a,l;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(a=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=a?a.verified:void 0)||"Approved"===(null!=a?a.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=a?a.denied:void 0)||"Denied"===(null!=a?a.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{l="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(r=null!=(s=t.atitle)?s:t.title)?r:"Unknown")+"\nReference (if provided): "+(null!=(n=t.reference)?n:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:l})}catch(e){}return t}},t.svc.rscvd.requestees={_index:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},t.svc.rscvd.resolves=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?a="object"==typeof e?e:await this.svc.rscvd(e):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),p={},i=0,r=(c=null!=a?[a]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<r;i++)null!=(n=c[i])._source&&null==(a=n._source)._id&&(a._id=n._id),(s=this.copy(a)).title&&(s.journal=s.title),s.atitle&&(s.title=s.atitle),(null!=(d=await this.ill.subscription({subscription:t},s))?d.url:void 0)?(null==a.resolved&&(a.resolved=[]),a.resolved.push(t),null==a.resolves&&(a.resolves=[]),a.resolves.push({resolver:t,url:d.url,user:null!=(h=this.user)?h._id:void 0}),p[n._id]=!0):(null==a.unresolved&&(a.unresolved=[]),a.unresolved.push(t),p[n._id]=!1),this.svc.rscvd(a);return e&&p[e]?p[e]:p},t.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},t.svc.rscvd.verify=async function(e,t=!0){var i,r;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},t.svc.rscvd.verify._auth=!0,t.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},t.svc.rscvd.deny._auth=!0,t.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},t.svc.rscvd.status._auth=!0,t.svc.rscvd.poll=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,E,D,C,N;if(null==e&&(e=null!=(b=this.params.poll)?b:Date.now()-18e4),"string"==typeof(t=null!=(w=this.params.which)?w:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),I.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),E={new:[],verify:[],deny:[],cancel:[],status:{}},I.call(t,"new")>=0)for(a=0,c=(O=null!=(_=null!=(v=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(x=v.hits)?x.hits:void 0)?_:[]).length;a<c;a++)null==(i=(m=O[a])._source)._id&&(i._id=m._id),E.new.push(m._source);if(I.call(t,"verify")>=0)for(l=0,h=(k=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<h;l++)N=k[l]._source.parts.pop(),I.call(E.verify,N)<0&&E.verify.push(N);if(I.call(t,"deny")>=0)for(o=0,p=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;o<p;o++)n=S[o]._source.parts.pop(),I.call(E.deny,n)<0&&E.deny.push(n);if(I.call(t,"cancel")>=0)for(u=0,d=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<d;u++)s=j[u]._source.parts.pop(),I.call(E.cancel,s)<0&&E.cancel.push(s);if(I.call(t,"status")>=0)for(y=0,f=(A=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;y<f;y++)C=(D=A[y])._source.parts.pop(),null==(r=E.status)[g=D._source.parts.pop()]&&(r[g]=C);return E},t.svc.rscvd.poll._log=!1,t.svc.rscvd.overdue=async function(){var e,t,i,r,s,n,a,l,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(r=0,n=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;r<n;r++)null==(e=(l=c[r])._source)._id&&(e._id=l._id),u.push(l._source);for(s=0,a=u.length;s<a;s++)(o=u[s]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t},I=[].indexOf,t.src.crossref=function(){return"Crossref API wrapper"},t.src.crossref.works={_index:{settings:{number_of_shards:15}}},t.src.crossref.works._key="DOI",t.src.crossref.works._prefix=!1,t.src.crossref.works.doi=async function(e,t){var i,r,s,n,a,l,o;if(null==e&&(e=this.params.doi),null==t&&(t=null!=(r=this.params.save)&&r),"string"==typeof e&&e.startsWith("10.")&&(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),null!=(null!=(o=await this.fetch("https://api.crossref.org/works/"+e,{headers:{"User-Agent":(null!=(s=this.S.name)?s:"OA.Works")+"; mailto:"+(null!=(n=null!=(a=this.S.mail)?a.to:void 0)?n:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}))&&null!=(l=o.message)?l.DOI:void 0)))return i=await this.src.crossref.works._format(o.message),t&&await this.src.crossref.works(i),i},t.src.crossref.works.title=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(null==e&&(e=null!=(o=this.params.title)?o:this.params.q),a='title:"'+e+'"',e.split(" ").length>2){for(a+=" OR (",t=0,i=(u=e.split(" ")).length;t<i;t++)g=u[t],a.endsWith("(")||(a+=" AND "),a+='(title:"'+g+'" OR subtitle:"'+g+'")';a+=")"}for(d=await this.src.crossref.works(a),s=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),n=0,r=(p=null!=(c=null!=d&&null!=(h=d.hits)?h.hits:void 0)?c:[]).length;n<r;n++)(l=p[n])._source.DOI&&l._source.title&&l._source.title.length&&(y=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(m=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&m.length&&I.call(y,m)<0&&(y+=" "+m),y=y.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==s.indexOf(y)||-1!==y.indexOf(s))&&s.length/y.length>.7&&s.length/y.length<1.3&&("journal-article"===l._source.type||null==f||"journal-article"!==f.type&&"journal-article"===l._source.type)&&(f=l._source));return f},t.src.crossref.works._format=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),r=0,n=(h=null!=(c=e.assertion)?c:[]).length;r<n;r++)"OPEN ACCESS"===(t=h[r]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(o=0,a=(d=null!=(p=e.license)?p:[]).length;o<a;o++)if((s=d[o]).URL&&-1!==s.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=s.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(u=0,l=(y=null!=(f=e.author)?f:[]).length;u<l;u++)(i=y[u]).name=(i.given?i.given+" ":"")+(null!=(m=i.family)?m:"");if(e.published=await this.src.crossref.works.published(e)){try{e.year=e.published.split("-")[0]}catch(e){}try{parseInt(e.year)}catch(e){}try{e.publishedAt=await this.epoch(e.published)}catch(e){}}return e},t.src.crossref.works.published=async function(e){var t,i,r,s,n,a,l,o,u;if(null==e&&(e=this.params.published),"string"==typeof e&&(e=await this.src.crossref.works(e)),null!=e){for(n=void 0,s=void 0,t=0,i=(l=["published","published-print","published-online","issued","deposited"]).length;t<i;t++)"object"==typeof e[r=l[t]]&&(a=void 0,"string"==typeof e[r]["date-time"]&&3===e[r]["date-time"].split("T")[0].split("-").length?a=e[r]["date-time"].split("T")[0]:Array.isArray(e[r]["date-parts"])&&e[r]["date-parts"].length&&Array.isArray(e[r]["date-parts"][0])&&("string"!=(o=typeof(u=e[r]["date-parts"][0])[0])&&"number"!==o||"null"===u[0]||(a=u[0]+(u.length>1?"-"+(1===u[1].toString().length?"0":"")+u[1]:"-01")+(u.length>2?"-"+(1===u[2].toString().length?"0":"")+u[2]:"-01"))),a&&(!s||n>await this.epoch(a))&&(s=a,n=await this.epoch(s)));return s}},t.src.crossref.works.published._log=!1,t.src.crossref.works.search=async function(e,t,i,r,s,n,a,l){var o,u,c,h,p,d,f,y,m,g,v;if(null==e&&(e=null!=(p=this.params.q)?p:this.params.search),null==t&&(t=this.params.from),null==i&&(i=this.params.size),null==r&&(r=this.params.filter),null==s&&(s=this.params.start),null==n&&(n=this.params.end),null==a&&(a=this.params.sort),null==l&&(l=null!=(d=this.params.order)?d:"asc"),o="",s&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof s&&-1!==s.indexOf("-")||(s=await this.date(s)),o="from-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+s),n&&(null==r&&(r=null!=a?a:"updated"),"string"==typeof n&&-1!==n.indexOf("-")||(n=await this.date(n)),o+=(o?",":"")+"until-"+r.replace("lished","").replace("xed","x").replace("ited","it").replace("dated","date")+"-date:"+n),o&&(r=o),v="https://api.crossref.org/works?",null!=a&&(v+="sort="+a+"&order="+l+"&"),"object"==typeof e)for(c in e)"from"!==c&&"size"!==c&&"filter"!==c&&"start"!==c&&"end"!==c&&"sort"!==c&&"order"!==c&&(v+=("title"===c||"citation"===c||"issn"===c?"query.bibliographic":"journal"===c?"query.container-title":"author"===c||"editor"===c||"chair"===c||"translator"===c||"contributor"===c||"affiliation"===c||"bibliographic"===c?"query."+c:c)+"="+encodeURIComponent(e[c])+"&");else e&&"all"!==e&&(h=(h=e.replace(/\w+?\:/g,"")).replace(/ /g,"+"),v+="query="+encodeURIComponent(h)+"&");if(null!=t){if("*"!==t&&"string"==typeof t&&!t.replace(/[0-9]/g,"").length)try{u=parseInt(t),isNaN(u)||(t=u)}catch(e){}v+="number"!=typeof t?"cursor="+encodeURIComponent(t)+"&":"offset="+t+"&"}null!=i&&(v+="rows="+i+"&"),r&&(v+="filter="+encodeURIComponent(r)+"&"),v=v.replace("?&","?").replace(/&$/,"");try{return{total:(g=await this.fetch(v,{headers:{"User-Agent":(null!=(f=this.S.name)?f:"OA.Works")+"; mailto:"+(null!=(y=null!=(m=this.S.mail)?m.to:void 0)?y:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}})).message["total-results"],cursor:g.message["next-cursor"],data:g.message.items,facets:g.message.facets}}catch(e){}},t.src.crossref.journals={_index:!0,_prefix:!1},t.src.crossref.journals.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E;for(await this.src.crossref.journals(""),t=0,S=0,e=[],i="*";i&&(0===t||t<S);){for(A="https://api.crossref.org/journals?cursor="+i+"&rows=1000",O=await this.fetch(A,{headers:{"User-Agent":(null!=(h=this.S.name)?h:"OA.Works")+"; mailto:"+(null!=(p=null!=(y=this.S.mail)?y.to:void 0)?p:"sysadmin@oa.works"),"Crossref-Plus-API-Token":"Bearer "+this.S.crossref}}),0===S&&(S=O.message["total-results"]),i=O.message["next-cursor"],s=0,n=(m=O.message.items).length;s<n;s++){for(null==(c=m[s]).ISSN&&(c.ISSN=[]),c.issn=[],o=0,a=(g=c.ISSN).length;o<a;o++)"string"==typeof(r=g[o])&&r.length&&I.call(c.issn,r)<0&&c.issn.push(r);if(c.dois=null!=(v=c.counts)?v["total-dois"]:void 0,null!=(null!=(b=c.breakdowns)?b["dois-by-issued-year"]:void 0)){for(c.years=[],u=0,l=(w=c.breakdowns["dois-by-issued-year"]).length;u<l;u++)2===(E=w[u]).length&&(_=E[0],I.call(c.years,_)<0)&&c.years.push(E[0]);c.years.sort()}null!=c.years&&c.years.length&&c.dois?(k=(new Date).getFullYear(),I.call(c.years,k)<0&&(x=k-1,I.call(c.years,x)<0)&&(d=k-2,I.call(c.years,d)<0)&&(f=k-3,I.call(c.years,f)<0)&&(c.discontinued=!0)):c.discontinued=!0,e.push(c)}t+=1e3,e.length>=1e4&&(await this.src.crossref.journals(e),e=[])}return e.length&&(await this.src.crossref.journals(e),e=[]),j.log(t),t},t.src.crossref.journals.load._bg=!0,t.src.crossref.journals.load._async=!0,t.src.crossref.journals.load._auth="root",t.src.crossref.changes=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,I,E,D,C,N,L,P,q,T;if(null==e&&(e=this.params.changes),"string"==typeof e&&(e.includes("/")||e.includes("-"))&&(e=await this.epoch(e)),!e)try{e=(await this.src.crossref.works("srcday:*",{size:1,sort:{srcday:"desc"}})).srcday+864e5,j.log("Crossref changes start day set from latest record srcday",await this.date(e))}catch(e){}if(!e)try{e=(await this.src.crossref.works("indexed.timestamp:*",{size:1,sort:{"indexed.timestamp":"desc"}})).indexed.timestamp,j.log("Crossref changes start day set from latest record indexed timestamp",await this.date(e))}catch(e){}for(null==e&&(e=16935264e5),e=await this.epoch(await this.date(e)),null==t&&(t=this.params.end),"string"==typeof t&&(t.includes("/")||t.includes("-"))&&(t=await this.epoch(t)),null==i&&(i=this.params.created),o=null!=t?t:Date.now(),o=await this.epoch(await this.date(o)),v=0,x=[],l=0,n=[];e<o;){for(j.log("Crossref changes",e,l),a="*",l+=1,T=!1,p=0,P=0;P<3&&(!1===T||p<T);)if(await this.sleep(500),null!=(q=await this.src.crossref.works.search(void 0,a,1e3,"indexed",e,e))?q.data:void 0){for(d=0,f=(k=q.data).length;d<f;d++)if(O=k[d],(h=await this.src.crossref.works._format(O)).srcday=e,n.push(h),v+=1,!(null==O.funder&&null==O.author||"2023"!==(S=O.year)&&"2022"!==S&&2023!==S&&2022!==S)){for(u=!1,b=0,y=(I=null!=(A=O.funder)?A:[]).length;b<y&&(c=I[b],!u);b++)null!=c.name&&(u=O.DOI);if(!u)for(w=0,m=(D=null!=(E=O.author)?E:[]).length;w<m&&(r=D[w],!u);w++)for(_=0,g=(N=null!=(C=r.affiliation)?C:[]).length;_<g&&(s=N[_],!u);_++)null!=s.name&&(u=O.DOI);u&&x.push(u)}n.length>=1e4&&(j.log("Crossref bulk load",e,l,T,p,v,x.length),await this.src.crossref.works(n),n=[]),!1===T&&(T=null!=(L=q.total)?L:0,j.log(e,T)),p+=1e3,a=q.cursor}else j.log("crossref error"),await this.sleep(2e3),P+=1;e+=864e5}return n.length&&await this.src.crossref.works(n),x.length&&await this.report.queue(x,void 0,void 0,void 0,"changes"),j.log("crossref works changes completed",v,l,x.length),v},t.src.crossref.changes._bg=!0,t.src.crossref.changes._async=!0,t.src.crossref.changes._log=!1,t.src.crossref.changes._auth="root",t.src.crossref.changes._notify=!1,t.src.crossref.plus={},t.src.crossref.plus.load=async function(){var e,t,i,r,s,n,a,l,o,u,c,h,p,d;if(c=await this.epoch(),s=0,this.params.clear)await this.src.crossref.works(""),(a={properties:{}}).properties.assertion={properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},explanation:{properties:{URL:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},group:{properties:{label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},label:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},name:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}},order:{type:"long"},value:{type:"text",fields:{keyword:{type:"keyword",ignore_above:256}}}}},await this.src.crossref.works.mapping(a);else try{s=(await this.src.crossref.works("srcfile:*",{size:1,sort:{srcfile:"desc"}})).srcfile}catch(e){}i=this.S.directory+"/import/crossref/all.json.tar.gz";try{await fs.stat(i)}catch(e){j.log("crossref downloading snapshot"),(r={})["Crossref-Plus-API-Token"]="Bearer "+this.S.crossref,o=await fetch("https://api.crossref.org/snapshots/monthly/latest/all.json.tar.gz",{headers:r}),d=fs.createWriteStream(i),await new Promise(((e,t)=>(o.body.pipe(d),o.body.on("error",t),d.on("finish",e)))),j.log("snapshot downloaded")}for(p=0,u=0,n="",e=!1,h=fs.createReadStream(i).pipe(zlib.createGunzip()),l="",h.on("data",(async e=>{var t,i,r,a,o,c,h,d,f,y;if(r=e.toString("utf8"),n+=r,(l+r).includes('\n  "items" : ['))for(;n.includes('\n  "items" : [');)if([a,n]=n.replace('\n  "items" : [',"X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),a.includes("\n  } ]")){if(o=a.split("\n  } ]"),y=parseInt(o.pop().split(".json")[0].replace(/[^0-9]/g,"")),u<s)j.log("crossref plus load waiting for file",u,s);else{for(h=[],t=0,i=(d=f=JSON.parse("["+o.join("]")+"}]")).length;t<i;t++)c=d[t],(null!=(c=await this.src.crossref.works._format(c))?c.DOI:void 0)&&(c.srcfile=u,h.push(c));j.log("crossref plus load",f.length,h.length),p+=h.length,h.length&&await this.src.crossref.works(h)}u=y}return l=r})),h.on("error",(e=>j.log("crossref plus load file stream error",JSON.stringify(e)))),h.on("end",(()=>(j.log("stream complete for crossref plus load"),e=!0)));!e;)j.log("crossref plus load streaming file",n.length,u,p,Math.floor((Date.now()-c)/1e3/60)+"m"),await this.sleep(3e4);return t=Date.now(),j.log("crossref plus load complete",u,p,c,t,Math.floor((t-c)/1e3/60)+"m"),p},t.src.crossref.plus.load._log=!1,t.src.crossref.plus.load._bg=!0,t.src.crossref.plus.load._async=!0,null==(v=r.src).doaj&&(v.doaj={});try{r.src.doaj.secrets=JSON.parse(SECRETS_DOAJ)}catch(e){}t.src.doaj={},t.src.doaj.journals={_index:!0,_prefix:!1},t.src.doaj.journals.load=async function(){var e,t,i,s,n,a,l,o;for(i="/tmp/doaj_"+await this.uid(),await fs.mkdir(i),i+="/",await fs.writeFile(i+"doaj.tar",await this.fetch("https://doaj.org/public-data-dump/journal?api_key="+r.src.doaj.secrets.apikey,{buffer:!0})),tar.extract({file:i+"doaj.tar",cwd:i,sync:!0}),e=!1,s=0,a=(l=await fs.readdir(i)).length;s<a;s++)(t=l[s]).includes("doaj_journal_data")&&(e=t);return o=0,e&&(o=(n=JSON.parse(await fs.readFile(i+e+"/journal_batch_1.json"))).length,await this.src.doaj.journals(""),await this.src.doaj.journals(n),await fs.unlink(i+e+"/journal_batch_1.json")),await fs.rmdir(i+e),await fs.unlink(i+"doaj.tar"),await fs.rmdir(i),o},t.src.doaj.journals.load._bg=!0,t.src.doaj.journals.load._async=!0,t.src.doaj.journals.load._auth="root",I=[].indexOf,t.src.epmc={_index:!0,_prefix:!1,_key:"id"},t.src.epmc.notinepmc={_index:!0,_prefix:!1,_key:"id",_hide:!0},t.src.epmc.search=async function(e,t,i){var r,s,n,a,l,o,u,c;return null==e&&(e=null!=(r=null!=(s=null!=(n=this.params.search)?n:this.params.epmc)?s:this.params.doi)?r:""),e.startsWith("10.")&&!e.includes(" ")&&e.split("/").length>=2&&(e="DOI:"+e),"string"!=typeof e||e.startsWith("PMCID:")||!e.toLowerCase().startsWith("pmc")||e.includes(" ")||(e="PMCID:PMC"+e.toLowerCase().replace("pmc","")),"number"==typeof e&&(e="PMCID:PMC"+e),c="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(c+="&pageSize="+i),null!=t&&(c+="&cursorMark="+t),u={},await this.sleep(150),o=await this.fetch(c),u.total=o.hitCount,u.data=null!=(a=null!=(l=o.resultList)?l.result:void 0)?a:[],u.cursor=o.nextCursorMark,u.data.length&&this.waitUntil(this.src.epmc(u.data)),u},t.src.epmc.doi=async function(e,t){var i,r,s,n,a;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.doi),null!=(i=await this.src.epmc('doi:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<2592e5);else{if((a=await this.src.epmc.search("DOI:"+e)).total)return a.data[0].doi||(a.data[0].doi=e,this.waitUntil(this.src.epmc(a.data[0]))),a.data[0];await this.src.epmc.notinepmc({id:e.replace(/\//g,"_"),doi:e,checkedAt:Date.now()})}},t.src.epmc.pmid=async function(e,t){var i,r,s,n,a;if(e||null==t&&(t=this.refresh),null==e&&(e=this.params.pmid),null!=(i=await this.src.epmc('pmid:"'+e+'"'))&&null!=(r=i.hits)?r.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(s=null!=(n=await this.src.epmc.notinepmc(e))?n.checkedAt:void 0)?s:0)<2592e5);else{if((a=await this.src.epmc.search("EXT_ID:"+e+" AND SRC:MED")).total)return a.data[0];await this.src.epmc.notinepmc({id:e,pmid:e,checkedAt:Date.now()})}},t.src.epmc.pmc=async function(e,t){var i,r,s,n,a,l;if(e||null==t&&(t=this.refresh),null==e&&(e=null!=(r=this.params.pmc)?r:this.params.pmcid),e="PMC"+e.toLowerCase().replace("pmc",""),null!=(i=await this.src.epmc('pmcid:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)return i.hits.hits[0]._source;if(!t&&Date.now()-(null!=(n=null!=(a=await this.src.epmc.notinepmc(e))?a.checkedAt:void 0)?n:0)<2592e5);else{if((l=await this.src.epmc.search("PMCID:"+e)).total)return l.data[0];await this.src.epmc.notinepmc({id:e,pmcid:e,checkedAt:Date.now()})}},t.src.epmc.title=async function(e){var t,i,r;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(null!=(t=await this.src.epmc('title:"'+e+'"'))&&null!=(i=t.hits)?i.total:void 0)?t.hits.hits[0]._source:(r=await this.src.epmc.search('title:"'+e+'"')).total?r.data[0]:void 0},t.src.epmc.licence=async function(e,t,i,r){var s,n,a;if(e||null==r&&(r=this.refresh),null==e&&(e=null!=(n=null!=(a=this.params.licence)?a:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),e&&null==t&&(t=await this.src.epmc.pmc(e,r)),t||i){if(null!=(null!=t?t.calculated_licence:void 0)&&!r)return"not found"===t.calculated_licence.licence?void 0:t.calculated_licence;if(null==e&&(e=null!=t?t.pmcid:void 0),(null!=t?t.license:void 0)&&"string"==typeof t.license?(s={licence:t.license,source:"epmc_api"}).licence.startsWith("cc")&&(s.licence=s.licence.replace(/ /g,"-")):(!i&&e&&(i=await this.src.epmc.xml(e,t,r)),null!=this.licence&&i&&("string"==typeof i&&i.startsWith("<")&&null!=(null!=(s=await this.licence(void 0,i,"<permissions>","</permissions>"))?s.licence:void 0)&&(s.source="epmc_xml_permissions"),null==(null!=s?s.licence:void 0)&&null!=(null!=(s=await this.licence(void 0,i))?s.licence:void 0)&&(s.source="epmc_xml_outside_permissions")),null==(null!=s?s.licence:void 0)&&"string"==typeof i&&i.includes("<permissions>")&&(s={licence:"non-standard-licence",source:"epmc_xml_permissions"})),null!=(null!=s?s.licence:void 0))return t.calculated_licence=s,await this.src.epmc(t.id,t),s;t.calculated_licence={licence:"not found"},await this.src.epmc(t.id,t)}},m=Date.now(),g=0,t.src.epmc.xml=async function(e,t,i){var r,s,n,a,l;if(null==e&&(e=null!=(n=null!=(a=this.params.xml)?a:this.params.pmcid)?n:this.params.epmc),e&&(e="PMC"+e.toLowerCase().replace("pmc","")),null==i&&(i=this.refresh),e)try{return(r=await fs.readFile(this.S.directory+"/epmc/fulltext/"+e+".xml")).toString()}catch(n){if(null==t&&(t=await this.src.epmc.pmc(e,i)),i||!(null!=t?t.no_ft:void 0)){for(s=Date.now()-m;s<500||g>=2;)await this.sleep(500-s),s=Date.now()-m;if(m=Date.now(),g+=1,l="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pmc&id="+e,r=await this.fetch(l),g-=1,"string"==typeof r&&r.length||null==t||(l="https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",r=await this.fetch(l)),"string"==typeof r&&r.length){try{await fs.writeFile(this.S.directory+"/epmc/fulltext/"+e+".xml",r)}catch(e){}return r}null!=t&&(t.no_ft=!0,await this.src.epmc(t.id,t))}}},t.src.epmc.fulltext=async function(e){var t,i,r;if(null==e&&(e=null!=(i=null!=(r=this.params.fulltext)?r:this.params.pmcid)?i:this.params.epmc),e)return await this.sleep(150),200===(null!=(t=await this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/"+e+"/fullTextXML",{method:"HEAD"}))?t.status:void 0)},t.src.epmc.aam=async function(e,t,i,r){var s,n,a,l;if(null==e&&(e=null!=(n=null!=(a=this.params.aam)?a:this.params.pmcid)?n:this.params.epmc),"string"==typeof i&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"'))return{aam:!0,info:"fulltext"};try{e&&!t&&(t=await this.src.epmc.pmc(e,r))}catch(e){}return null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e,t,r))&&i.includes("pub-id-type='manuscript'")&&i.includes('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),l="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),(s=await this.fetch(l))?"string"==typeof s?s.includes("Author Manuscript; Accepted for publication in peer reviewed journal")||s.includes("Author manuscript; available in PMC")||s.includes("logo-nihpa.gif")||s.includes("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}:null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC may be blocking access, AAM status unknown"}:{aam:!1,info:"not in EPMC (404)"}):{aam:!1,info:""}},t.src.epmc.statement=async function(e,t,i,r){var s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,I,E;if(null==e&&(e=null!=(v=null!=(b=null!=(w=null!=(_=this.params.statement)?_:this.params.pmc)?w:this.params.pmcid)?b:this.params.PMC)?v:this.params.PMCID),null==i&&(i=this.refresh),null==r&&(r=this.params.verbose),y=[],p=[],k=[],E=[],A=[],e&&(e="PMC"+(e+"").toLowerCase().replace("pmc",""),a=await this.src.epmc.xml(e,t,i)))for(j="",l=0,o=(x=['"data',">Data",">Availab",">data",">Code",">code"]).length;l<o;l++){O=x[l];try{if(a.includes(O))for(k.push(O),f="",k=a.split(O);c=k.shift();)if(f){if(y.push(f.slice(-1e3)),I=f.split("<").pop().split(">")[0].split(" ")[0],E.push(I),h=(O.startsWith('"')?c.split(/\>(.*)/s)[1]:c.startsWith("il")||c.startsWith("l")?"Availab":"Data")+c,p.push(h.slice(0,1e3)),h.includes("</"+I)&&h.indexOf("</"+I)<40&&((u=(m=f.split("<"))[m.length-2].split(">")[0].split(" ")[0]).startsWith("/")||(I=u)),S="\n"+(g=f.split("<"+I)).slice(0,g.length-1).pop().split("\n").pop()+"</"+I,h.split("</"+I)[0].includes("\n"))for(;!h.includes(S)&&k[0];)h+=(O.startsWith(">")?">":"")+(k[0].startsWith("il")||k[0].startsWith("l")?"Availab":"Data")+k.shift();d=(f+(h=(h=h.split(S)[0]).replace("</title>","|TTT|").replace(/\n/g," ").replace(/\s+/g," ").replace(/(<([^>]+)>)/gi,""))).toLowerCase(),h.length>20&&h.length<3e3&&(d.includes("availab")||d.includes("accessib"))&&((f+h).toLowerCase().includes("data")||(f+h).toLowerCase().includes("code"))&&(h.includes("|TTT|")&&(h=h.split("|TTT|")[1]),n=(s=(s=(s=(await this.decode(h.trim())).replace(/"/g,"").replace(/\s+/g," ")).replace("<title","").replace("<p","")).trim()).toLowerCase(),s.length>20&&(n.includes("data")||n.includes("code")||n.includes("availab")||n.includes("accessib"))&&!j.includes(n)&&(j+=n,A.push(s))),f=""}else f=c}catch(e){}}return r?{pmcid:e,file:"https://static.oa.works/epmc/fulltext/"+e+".xml",pres:y,posts:p,splits:k,tags:E,statements:A,url:A?await this.src.epmc.statement.url(void 0,void 0,A,i):void 0}:A.length?A:void 0},t.src.epmc.statement.url=async function(e,t,i,r){var s,n,a,l,o,u;for(null==i&&(i=await this.src.epmc.statement(e,t,r)),u=[],s=(e,t)=>{var i;if((i=t+e.split(t)[1].split(" ")[0]).length>10&&i.includes("/")&&((i=i.toLowerCase()).includes(")")&&(e.includes("(h")||e.includes("(10"))&&(i=i.split(")")[0].replace("(","")),i.endsWith(".")&&(i=i.slice(0,-1)),i.startsWith("10.")&&(i="https://doi.org/"+i),I.call(u,i)<0))return u.push(i)},a=0,l=(o=null!=i?i:[]).length;a<l;a++)(n=o[a]).includes("http")&&await s(n,"http"),n.includes("10.")&&await s(n,"10.");return u.length?u:void 0},null==(v=r.src).google&&(v.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}t.src.google=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(n=this.params)?n.google:void 0),null==t&&(t=null!=(a=this.S.src.google)&&null!=(l=a.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),e&&t&&i?(p="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(p)):{}},t.src.google.sheets=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return[];if(e.sheetid.startsWith("http")&&e.sheetid.includes("sheets.googleapis.com/v4/")?b=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(g=e.sheetid.replace("/spreadsheets/d/","/spreadsheets/").split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=g):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(h=null!=(p=this.S.src.google)&&null!=(d=p.secrets)?d.serverkey:void 0)?h:null!=(f=this.S.src.google)&&null!=(y=f.secrets)?y.apikey:void 0)),t=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===e.values)return t;if(!1===e.headers)return t.values;if(Array.isArray(e.headers))s=e.headers;else if(s=[],null!=t.values)for(n=0,o=(v=t.values.shift()).length;n<o;n++){r=v[n];try{r=r.trim()}catch(e){}s.push(r)}for(_=[],a=0,u=(m=t.values).length;a<u;a++){for(i in l=m[a],w={},s)try{w[s[i]]=l[i]}catch(e){}"{}"!==JSON.stringify(w)&&_.push(w)}return _},t.src.google.sheets._bg=!0,t.src.google.sheets._log=!1,null==(v=r.src).microsoft&&(v.microsoft={});try{r.src.microsoft=JSON.parse(SECRETS_MICROSOFT)}catch(e){}t.src.microsoft={},t.src.microsoft.bing=async function(e,t,i,s,n){var a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;return null==e&&(e=null!=(a=null!=(l=null!=this&&null!=(d=this.params)?d.bing:void 0)?l:null!=this&&null!=(f=this.params)?f.q:void 0)?a:null!=this&&null!=(y=this.params)?y.query:void 0),null==t&&(t=null!=(m=null!=this&&null!=(g=this.params)?g.key:void 0)?m:null!=(v=r.src.microsoft.bing)?v.key:void 0),null==i&&(i=null!=(b=null!=this&&null!=(w=this.params)?w.market:void 0)?b:"en-GB"),null==s&&(s=null!=(o=null!=this&&null!=(u=this.params)?u.count:void 0)?o:20),null==n&&(n=null!=(c=null!=this&&null!=(h=this.params)?h.cache:void 0)?c:259200),null!=e&&null!=t&&(x="https://api.cognitive.microsoft.com/bing/v7.0/search?",i&&(x+="mkt="+i+"&"),s&&(x+="count="+s+"&"),x+="q="+e,null!=(_=await this.fetch(x,{headers:{"Ocp-Apim-Subscription-Key":t},cache:n}))&&null!=(p=_.webPages)?p.value:void 0)?{total:_.webPages.totalEstimatedMatches,data:_.webPages.value}:{total:0,data:[]}},t.src.microsoft.bing._auth="@oa.works",null==(v=r.src).oadoi&&(v.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}t.src.oadoi={_index:{settings:{number_of_shards:15}}},t.src.oadoi._key="doi",t.src.oadoi._prefix=!1,t.src.oadoi.search=async function(e){var t,i,s,n,a,l;if(null==e&&(e=null!=(t=null!=(i=null!=(s=this.params)?s.oadoi:void 0)?i:null!=(n=this.params)?n.doi:void 0)?t:null!=(a=this.params)?a.search:void 0),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),l="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,this.fetch(l)},t.src.oadoi.hybrid=async function(e){var t,i,r,s,n,a;if(null==e&&(e=null!=(s=null!=(n=this.params.hybrid)?n:this.params.issn)?s:this.params.issns),"object"!=typeof e||Array.isArray(e)||(e=null!=(a=e.journal_issns)?a:e.ISSN),"string"==typeof e&&(e=e.replace(/\s/g,"").split(",")),Array.isArray(e)&&e.length)return(r="journal_issns.keyword:*"+e.join("* OR journals_issns.keyword:*")+"*").includes(" OR ")&&(r="("+r+")"),t=await this.src.oadoi.count(r+' AND oa_status:"closed"'),i=await this.src.oadoi.count(r+' AND oa_status:"hybrid"'),!!(t&&i/t>.001)},t.src.oadoi.load=async function(){var e,t,i,r,s,n,a,l,o,u;a=await this.epoch(),r=this.S.directory+"/import/oadoi/snapshot.jsonl";try{await fs.stat(r)}catch(e){j.log("OADOI downloading snapshot"),n=await fetch("https://api.unpaywall.org/feed/snapshot?api_key="+this.S.src.oadoi.apikey),u=fs.createWriteStream(r),await new Promise(((e,t)=>(n.body.pipe(u),n.body.on("error",t),u.on("finish",e)))),j.log("snapshot downloaded")}for(this.params.clear&&await this.src.oadoi(""),o=0,e=[],s="",t=!1,(l=fs.createReadStream(r).pipe(zlib.createGunzip())).on("data",(async t=>{var i,r,n;for("string"==typeof(i=t.toString("utf8"))&&i&&(s+=i);s.includes("\n");){[r,s]=s.replace("\n","X0X0X0X0X0X0X0X0X0X0X0").split("X0X0X0X0X0X0X0X0X0X0X0"),n={};try{n=JSON.parse(r)}catch(e){}(null!=n?n.doi:void 0)?e.push(n):j.log("oadoi load failed to parse record from string",r),e.length>=1e4&&(o+=e.length,j.log("OADOI bulk loading",e.length,o),await this.src.oadoi(e),e=[])}return null!=s?s:s=""})),l.on("error",(e=>j.log("oadoi load file stream error",JSON.stringify(e)))),l.on("end",(()=>(j.log("stream complete for oadoi load"),t=!0)));!t;)j.log("oadoi load streaming file",s.length,o,Math.floor((Date.now()-a)/1e3/60)+"m"),await this.sleep(3e4);return e.length&&await this.src.oadoi(e),i=Date.now(),j.log("oadoi load complete",o,a,i,Math.floor((i-a)/1e3/60)+"m"),o},t.src.oadoi.load._bg=!0,t.src.oadoi.load._async=!0,t.src.oadoi.load._log=!1,t.src.oadoi.changes=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(m=this.S.directory+"/import/oadoi/upto",null==e&&(e=this.params.changes),!e)try{e=parseInt((await fs.readFile(m)).toString())}catch(e){}if(!e)try{n=await this.src.oadoi("*",{size:1,sort:{updated:{order:"desc"}}}),e=new Date(n.updated).valueOf()}catch(e){}if(e){for(i=0,r=0,y=!1,s=0,l=(d=(await this.fetch("https://api.unpaywall.org/feed/changefiles?api_key="+this.S.src.oadoi.apikey+"&interval=day")).list.reverse()).length;s<l;s++){if(h=d[s],c=new Date(h.last_modified).valueOf(),j.log(h.last_modified,c,e,null!=n?n.updated:void 0),"jsonl"===h.filetype&&(!e||c>e)){for await(u of(j.log("OADOI importing changes for",h.last_modified),r+=1,t=[],a=0,o=this.S.directory+"/import/oadoi/"+h.date+".jsonl.gz",f=await fetch(h.url),g=fs.createWriteStream(o),await new Promise(((e,t)=>(f.body.pipe(g),f.body.on("error",t),g.on("finish",e)))),readline.createInterface({input:fs.createReadStream(o).pipe(zlib.createGunzip())})))y=c,a+=1,(p=JSON.parse(u.trim().replace(/\,$/,"")))._id=p.doi.replace(/\//g,"_"),t.push(p),i+=1,t.length>=3e4&&(j.log("OADOI bulk loading changes",r,t.length,a),await this.src.oadoi(t),t=[]);t.length&&await this.src.oadoi(t),fs.unlink(o)}if(y)try{await fs.writeFile(m,y)}catch(e){}}return j.log("oadoi changes complete",r,i),i}j.log("Timestamp day to work since is required - run load first to auto-generate")},t.src.oadoi.changes._bg=!0,t.src.oadoi.changes._async=!0,t.src.oadoi.changes._log=!1,t.src.oadoi.changes._auth="root",t.src.oadoi.changes._notify=!1,null==(v=r.src).openai&&(v.openai={});try{r.src.openai=JSON.parse(SECRETS_OPENAI)}catch(e){}t.src.openai={},t.src.openai.chat=async function(e,t,i,r){var s,n,a,l,o,u,c,h,p;return null==e&&(e=null!=(a=null!=(l=null!=(o=this.params.chat)?o:this.params.prompt)?l:this.params.q)?a:""),null==t&&(t=null!=(u=this.params.role)?u:"You are a helpful assistant"),null==i&&(i=null!=(c=this.params.model)?c:"gpt-4-1106-preview"),null==r&&(r=this.params.json),"string"==typeof e&&e.length&&(null!=(h=this.S.src.openai)?h.key:void 0)?(s={"Content-Type":"application/json",Authorization:"Bearer "+this.S.src.openai.key},n={model:i,messages:[]},r&&(n.response_format={type:"json_object"}),p={role:"system",content:t},n.messages.push(p),e={role:"user",content:e},n.messages.push(e),await this.fetch("https://api.openai.com/v1/chat/completions",{headers:s,body:n})):{}},t.src.openai.chat._auth="@oa.works",I=[].indexOf,null==(v=r.src).openalex&&(v.openalex={});try{r.src.openalex=JSON.parse(SECRETS_OPENALEX)}catch(e){}t.src.openalex=function(){return!0},t.src.openalex.works={_index:{settings:{number_of_shards:15}},_prefix:!1},t.src.openalex.works._format=function(e){var t,i,r,s,n,a,l,o,u,c,h,p;try{for(a=e.concepts,i=0,s=a.length;i<s;i++)null!=(p=a[i]).score&&(p.score=Math.floor(p.score))}catch(e){}try{e._id=null!=(l=null!=(o=e.doi)?o:e.DOI)?l:null!=(u=e.ids)?u.doi:void 0,e._id.includes("http")&&e._id.includes("/10.")&&(e._id="10."+e._id.split("/10.").pop()),e._id&&e._id.startsWith("10.")||(e._id=e.id.split("/").pop())}catch(t){e._id=e.id.split("/").pop()}try{for(h in t=[],e.abstract_inverted_index)for(c=e.abstract_inverted_index[h],r=0,n=c.length;r<n;r++)t[c[r]]=h;t.length&&(e.abstract=t.join(" "))}catch(e){}try{delete e.abstract_inverted_index}catch(e){}return e},t.src.openalex.works.doi=async function(e,t){var i,r;return null==e&&(e=this.params.doi),null==t&&(t=this.params.refresh),!t&&(i=await this.src.openalex.works('ids.doi:"https://doi.org/'+e+'"',1))||(i=await this.fetch("https://api.openalex.org/works/https://doi.org/"+e+((null!=(r=this.S.src.openalex)?r.apikey:void 0)?"?api_key="+this.S.src.openalex.apikey:"")))&&i.id&&(i=await this.src.openalex.works._format(i),this.waitUntil(this.src.openalex.works(i))),i},t.src.openalex.load=async function(e,t,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E,D,C,N,L,P,q,T,R;if(null==e&&(e=null!=(O=null!=(k=this.params.load)?k:this.params.openalex)?O:"works"),"works"!==e)return!1;if(null==i&&(i=null!=(S=this.params.clear)&&S),null==r&&(r=null!=(A=this.params.sync)&&A),!0===i&&(await this.src.openalex[e](""),await this.sleep(6e4)),c=null!=(E=this.params.howmany)?E:-1,T=0,p=this.S.directory+"/import/openalex/data/"+e,"string"==typeof t)t=[t];else if(!0===t){j.log("Checking for Openalex changes in",e),t=[];try{_=JSON.parse((await fs.readFile(p+"/manifest")).toString()),s=await this.epoch(_.entries[_.entries.length-1].url.split("=")[1].split("/")[0])}catch(e){s=0}for(r?(q=await this._child("aws",["s3","sync","s3://openalex",this.S.directory+"/import/openalex","--no-sign-request"]),j.log("Openalex sync returned",q)):(await fs.writeFile(p+"/manifest",await this.fetch("https://openalex.s3.amazonaws.com/data/"+e+"/manifest",{buffer:!0})),j.log("Openalex manifest updated")),u=!1,d=0,m=(D=(_=JSON.parse((await fs.readFile(p+"/manifest")).toString())).entries).length;d<m;d++)l=D[d].url.split("=")[1].split("/")[0],u||await this.epoch(l)>s&&(u=!0),u&&I.call(t,l)<0&&t.push(l);t.length&&j.log("Found changes",t)}else!0===r&&(j.log("Openalex load syncing",e),q=await this._child("aws",["s3","sync","s3://openalex/data/"+e,p,"--no-sign-request"]),j.log("Openalex sync returned",q));if(!r&&t&&t.length)for(f=0,g=t.length;f<g;f++){a=t[f],j.log("Openalex syncing files",e,a);try{await fs.stat(p+"/updated_date="+a)}catch(t){await this._child("aws",["s3","sync","s3://openalex/data/"+e+"/updated_date="+a,p+"/updated_date="+a,"--no-sign-request"])}}for(o=0,x=0,P=0,y=0,v=(C=await fs.readdir(p)).length;y<v;y++)if(!(R=C[y]).startsWith("manifest")&&(!t||0===t.length||(N=R.split("=")[1],I.call(t,N)>=0))){for(n=async t=>{var i,r,s,n,a,l,u;for await(s of(i=[],readline.createInterface({input:fs.createReadStream(p+"/"+R+"/"+t).pipe(zlib.createGunzip())}))){if(T===c)break;if(a=JSON.parse(s.trim().replace(/\,$/,"")),T+=1,"venues"===e||"institutions"===e||"concepts"===e||"authors"===e){if(a._id=a.id.split("/").pop(),"authors"===e&&null!=a.x_concepts)for(n=0,r=(l=a.x_concepts).length;n<r;n++)null!=(u=l[n]).score&&(u.score=Math.floor(u.score))}else"works"===e&&(a=await this.src.openalex.works._format(a));i.push(a),i.length>=1e4&&(j.log("Openalex "+e+" bulk loading",R,t,i.length,T),await this.src.openalex[e](i),i=[])}return i.length&&(j.log("Openalex "+e+" bulk loading final set for",R,t,i.length,o,x,T),await this.src.openalex[e](i)),j.log("removing",p+"/"+R+"/"+t),await fs.unlink(p+"/"+R+"/"+t),x+=1,P-=1,!0},w=0,b=(L=await fs.readdir(p+"/"+R)).length;w<b;w++){for(h=L[w],j.log("Openalex load running",P),o+=1;3===P;)await this.sleep(5e3),j.log("Openalex load running",P);P+=1,n(h)}for(;0!==P;)await this.sleep(5e3);await fs.rmdir(p+"/"+R)}return j.log(o,x,T),{expected:o,processed:x,total:T}},t.src.openalex.load._bg=!0,t.src.openalex.load._async=!0,t.src.openalex.load._log=!1,t.src.openalex.load._auth="root",t.src.openalex.changes=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,E,D,C,N,L,P,q,T,R;if(L=await this.epoch(),null==e&&(e=null!=(w=null!=(_=this.params.changes)?_:this.params.openalex)?w:"works"),"object"!=typeof t&&(t={updated:t}),null==t&&(t={}),this.params.last&&(t.updated=this.params.last,t.created=this.params.last),null==t.updated||null==t.created){try{t.updated=(await this.src.openalex.works("updated_date:*",{size:1,sort:{updated_date:"desc"}})).updated_date}catch(e){}try{t.created=(await this.src.openalex.works("created_date:*",{size:1,sort:{created_date:"desc"}})).created_date}catch(e){}}if(null==t.updated&&(t.updated=(await this.datetime(await this.epoch()-864e5)).replace("Z","000")),null==t.created&&(t.created=(await this.datetime(await this.epoch()-864e5)).replace("Z","000")),R=["works"],e){if(I.call(R,e)<0)return!1}else e=R;for(j.log("Openalex changes checking from",t),P=0,v=[],o=0,h=(x=Array.isArray(e)?e:[e]).length;o<h;o++)for(T=x[o],u=0,p=(O=["updated"]).length;u<p;u++)if(l=O[u],await this.epoch(t.updated)<L-36e5){r=[],s="*",q="https://api.openalex.org/"+T+"?filter=from_"+l+"_date:"+t[l]+"&api_key="+this.S.src.openalex.apikey+"&per-page=200&cursor=",j.log("Openalex changes querying",q+s);try{N=await this.fetch(q+s);try{j.log("Openalex changes query retrieved",N.results.length)}catch(e){}for(;null!=N&&"object"==typeof N&&Array.isArray(N.results)&&N.results.length;){for(k=N.results,c=0,d=k.length;c<d;c++){if(b=k[c],"works"===T&&(b=await this.src.openalex.works._format(b))._id.startsWith("10.")&&null!=b.authorships&&("2023"===(S=b.publication_year)||"2022"===S||2023===S||2022===S))for(n=!1,A=b.authorships,m=0,f=A.length;m<f&&(i=A[m],!n);m++)for(D=null!=(E=i.institutions)?E:[],g=0,y=D.length;g<y;g++)if(null!=D[g].display_name){v.push(b._id),n=!0;break}r.push(b)}r.length>=1e4&&(j.log("Openalex "+e+" "+l+" bulk loading changes",r.length,P,v.length),P+=r.length,await this.src.openalex[e](r),r=[]),(null!=(C=N.meta)?C.next_cursor:void 0)&&(s=N.meta.next_cursor,N=await this.fetch(q+encodeURIComponent(s)))}}catch(e){}r.length&&(P+=r.length,await this.src.openalex[e](r),r=[])}return v.length&&await this.report.queue(v,void 0,void 0,void 0,"changes"),a=await this.epoch(),"src.openalex.changes"!==this.fn&&a-L<36e5&&(j.log("Openalex changes waiting to loop"),await this.sleep(36e5-(a-L))),j.log("Openalex changes changed",P,v.length),P},t.src.openalex.changes._log=!1,t.src.openalex.changes._bg=!0,t.src.openalex.changes._async=!0,t.src.openalex.sources={_index:!0,_prefix:!1},t.src.openalex.sources.load=async function(){var e,t,i,r,s,n,a,l,o,u;for(await this.src.openalex.sources(""),o=0,e=[],u="https://api.openalex.org/sources?"+((null!=(s=this.S.src.openalex)?s.apikey:void 0)?"api_key="+this.S.src.openalex.apikey+"&":"")+"per-page=200&cursor=",l=await this.fetch(u+"*");null!=l&&"object"==typeof l&&Array.isArray(l.results)&&l.results.length;){for(t=0,i=(n=l.results).length;t<i;t++)(r=n[t])._id=r.id.split("/").pop(),e.push(r);e.length>=2e4?(o+=e.length,await this.src.openalex.sources(e),e=[]):await this.sleep(200),(null!=(a=l.meta)?a.next_cursor:void 0)&&(l=await this.fetch(u+encodeURIComponent(l.meta.next_cursor)))}return e.length&&await this.src.openalex.sources(e),o},t.src.openalex.sources.load._async=!0,t.src.openalex.sources.load._bg=!0,I=[].indexOf,t.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},t.src.pubmed.doi=async function(e){var t;if(null==e&&(e=this.params.doi),e&&(t=await this.src.pubmed('identifier.doi:"'+e+'"',1)))return t},t.src.pubmed.pmc=async function(e){var t;if(null==e&&(e=this.params.pmc),e&&(t=await this.src.pubmed('identifier.pmc:"PMC'+e.toString().toLowerCase().replace("pmc","")+'"',1)))return t},t.src.pubmed.entrez={},t.src.pubmed.entrez.summary=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b;b="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),b+="&id="+i):b+="&query_key="+e+"&WebEnv="+t;try{for(h=await this.convert.xml2json(await this.fetch(b)),d=[],Array.isArray(h.eSummaryResult.DocSum)||(h.eSummaryResult.DocSum=[h.eSummaryResult.DocSum]),f=h.eSummaryResult.DocSum,s=0,o=f.length;s<o;s++){for(r={id:(p=f[s]).Id},y=p.Item,a=0,u=y.length;a<u;a++)if("List"===(n=y[a])._.Type){if(r[n._.Name]=[],null!=n.Item)for(m=n.Item,l=0,c=m.length;l<c;l++)g=m[l],(v={})[g._.Name]=g.$,r[n._.Name].push(v)}else r[n._.Name]=n.$;if(d.push(r),null==i||!i.includes(","))return d[0]}return d}catch(e){}},t.src.pubmed.entrez.pmid=async function(e){var t,i,r;null==e&&(e=this.params.pmid),r="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return await this.sleep(200),t=await this.fetch(r),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey,i.ePostResult.WebEnv)}catch(e){}},t.src.pubmed.search=async function(e,t,i=10,r=!1){var s,n,a,l,o,u,c,h,p,d,f,y;null==e&&(e=null!=(c=this.params.search)?c:this.params.q),y="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof r&&(r=r.split(",")),Array.isArray(r))p={total:r.length,data:[]};else{if(await this.sleep(200),p=await this.fetch(y),p={total:(d=await this.convert.xml2json(p)).eSearchResult.Count[0],data:[]},!0===r)return p.data=d.eSearchResult.IdList[0].Id,p;r=d.eSearchResult.IdList[0].Id}if(t)for(s=0,a=r.length;s<a&&(f=r[s],o=await this.src.pubmed.pmid(f),p.data.push(o),p.data.length!==i);s++);else for(h=await this.src.pubmed.entrez.summary(void 0,void 0,r),n=0,l=h.length;n<l&&(u=h[n],p.data.push(u),p.data.length!==i);n++);return p}catch(e){}},t.src.pubmed.pmid=function(e){null==e&&(e=this.params.pmid);try{return this.src.pubmed.entrez.pmid(e)}catch(e){}},t.src.pubmed.aheadofprint=async function(e){null==e&&(e=this.params.pmid);try{return await this.sleep(100),(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).includes("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},t.src.pubmed.availabilities={_sheet:"1ZQa6tOqFsm_nF3XUk9-FhDk5gmVtXeRC4I3uldDl-gM/Export",_prefix:!1,_key:"PMC"},t.src.pubmed.availability=async function(e){var t,i,r,s,n;return null==e&&(e=null!=(t=null!=(i=null!=(r=null!=(s=null!=(n=this.params.pubmed)?n:this.params.availability)?s:this.params.pmc)?r:this.params.pmcid)?i:this.params.PMC)?t:this.params.PMCID),e="pmc"+(e+"").toLowerCase().replace("pmc",""),!!await this.src.pubmed.availabilities(e)},t.src.pubmed.availability.statement=function(e,i){return t.src.epmc.statement(e,i)},t.src.pubmed.load=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y;for(null==e&&"changes"===this.params.load&&(e=!0),f=null!=(c=this.params.streamers)?c:1,a=null!=(h=this.params.howmany)?h:-1,this.refresh&&!e&&await this.src.pubmed(""),i=e?"https://ftp.ncbi.nlm.nih.gov/pubmed/updatefiles/":"https://ftp.ncbi.nlm.nih.gov/pubmed/baseline/",s=[],n="number"==typeof this.params.load?this.params.load:"number"==typeof this.params.changes?this.params.changes:void 0,l=0,o=(p=(await this.fetch(i)).split('href="')).length;l<o;l++)(r=p[l].split('"')[0]).endsWith(".gz")&&r.includes(n+".xml")||!n&&r.startsWith("pubmed")&&r.endsWith(".gz")&&("baseline"===this.params.load||this.refresh&&!e||!await this.src.pubmed.count('srcfile:"'+i+r+'"'))?s.push(i+r):r.endsWith(".md5")||j.log("pubmed load skipping file",i+r);for(d=0,y=0,t=async t=>{var i,r,n,l,o,u,c,h,p,f,m,g,v,b,w,_,x,O,k,S,A;j.log("Pubmed loading"+(e?" changes":""),t,s.length,d),u=[],w={};try{for await(g of readline.createInterface({input:(await fetch(t)).body.pipe(zlib.createGunzip())}))if("</PubmedArticle>"===(g=g.trim().replace("&amp;","&"))){if(y+=1,w.srcfile=t,w._id=w.PMID,u.push(w),w={},y===a)break}else if(!(g.startsWith("<?")||g.includes("?xml")||g.includes("!DOCTYPE")||g.includes("/>")||g.includes("PubmedArticle")||g.includes("PubmedData")||g.includes("History")||g.includes("ArticleIdList")||g.includes("List>"))){for(p in g.split(">")[0].split(" ")[0].replace("<",""),f={"<ArticleTitle>":"title","<AbstractText>":"abstract","<ISOAbbreviation>":"iso","<Issue>":"issue","<Title>":"journal","<Language>":"language","<NlmUniqueID>":"NLMID","<PMID>":"PMID","<Volume>":"volume","<CopyrightInformation>":"copyright","<NumberOfReferences>":"references_count","<PublicationStatus>":"status","<SpaceFlightMission>":"spaceflightmission"})(g.includes(p)||g.includes(p.replace(">"," ")))&&null==w[b=f[p]]&&(w[b]=g.split(">")[1].split("</")[0]);if(g.includes("<MedlinePgn>"))w.pages=g.split(">")[1].split("</")[0].replace(" - "," to ").replace("-"," to ");else if(g.includes("<ISSN"))null==w.ISSN&&(w.ISSN=[]),A=g.split(">")[1].split("</")[0],I.call(w.ISSN,A)<0&&w.ISSN.push(A);else if(g.includes("<Keyword>"))null==w.keyword&&(w.keyword=[]),A=g.split(">")[1].split("</")[0],I.call(w.keyword,A)<0&&w.keyword.push(A);else if(g.includes("<GeneSymbol>"))null==w.gene&&(w.gene=[]),A=g.split(">")[1].split("</")[0],I.call(w.gene,A)<0&&w.gene.push(A);else if(g.includes("<PublicationType>")||g.includes("<PublicationType "))null==w.type&&(w.type=[]),A=g.split(">")[1].split("</")[0],I.call(w.type,A)<0&&w.type.push(A);else if(g.includes("<Chemical>"))null==w.chemical&&(w.chemical=[]),w.chemical.push({});else if(g.includes("<NameOfSubstance>")||g.includes("<NameOfSubstance "))null==w.chemical&&(w.chemical=[{}]),w.chemical[w.chemical.length-1].name=g.split(">")[1].split("</")[0],w.chemical[w.chemical.length-1].nameID=g.split('UI="')[1].split('"')[0];else if(g.includes("<RegistryNumber>"))null==w.chemical&&(w.chemical=[{}]),w.chemical[w.chemical.length-1].registry=g.split(">")[1].split("</")[0];else if(g.includes("<DataBank>")||g.includes("<DataBank "))null==w.databank&&(w.databank=[]),w.databank.push({});else if(g.includes("<DataBankName>"))null==w.databank&&(w.databank=[{}]),w.databank[w.databank.length-1].name=g.split(">")[1].split("</")[0];else if(g.includes("<AccessionNumber>"))null==w.databank&&(w.databank=[{}]),null==(r=w.databank[w.databank.length-1]).accession&&(r.accession=[]),w.databank[w.databank.length-1].accession.push(g.split(">")[1].split("</")[0]);else if(g.includes("<Grant>")||g.includes("<Grant "))null==w.grant&&(w.grant=[]),w.grant.push({});else if(g.includes("<GrantID>"))null==w.grant&&(w.grant=[{}]),w.grant[w.grant.length-1].id=g.split(">")[1].split("</")[0];else if(g.includes("<Acronym>"))null==w.grant&&(w.grant=[{}]),w.grant[w.grant.length-1].acronym=g.split(">")[1].split("</")[0];else if(g.includes("<Agency>"))null==w.grant&&(w.grant=[{}]),w.grant[w.grant.length-1].agency=g.split(">")[1].split("</")[0];else if(g.includes("<Country>"))w.grant&&!w.grant[w.grant.length-1].country||w.country?w.grant&&w.grant.length&&(w.grant[w.grant.length-1].country=g.split(">")[1].split("</")[0]):w.country=g.split(">")[1].split("</")[0];else if(g.includes("<MeshHeading>")||g.includes("<MeshHeading "))null==w.mesh&&(w.mesh=[]),w.mesh.push({});else if(g.includes("<DescriptorName>")||g.includes("<DescriptorName "))null==w.mesh&&(w.mesh=[{}]),w.mesh[w.mesh.length-1].description=g.split(">")[1].split("</")[0],w.mesh[w.mesh.length-1].descriptionID=g.split('UI="')[1].split('"')[0];else if(g.includes("<QualifierName>")||g.includes("<QualifierName "))null==w.mesh&&(w.mesh=[{}]),null==(n=w.mesh[w.mesh.length-1]).qualifier&&(n.qualifier=[]),w.mesh[w.mesh.length-1].qualifier.push({name:g.split(">")[1].split("</")[0],id:g.split('UI="')[1].split('"')[0]});else if(g.includes("<Author>")||g.includes("<Author ")||g.includes("<Investigator>")||g.includes("<Investigator "))null==w.author&&(w.author=[]),w.author.push(g.includes("<Investigator")?{investigator:!0}:{});else if(g.includes("<LastName>"))null==w.author&&(w.author=[{}]),w.author[w.author.length-1].lastname=g.split(">")[1].split("</")[0];else if(g.includes("<ForeName>"))null==w.author&&(w.author=[{}]),w.author[w.author.length-1].firstname=g.split(">")[1].split("</")[0];else if(g.includes("<Affiliation>"))null==w.author&&(w.author=[{}]),w.author[w.author.length-1].affiliation=g.split(">")[1].split("</")[0];else if(g.includes("<Identifier>"))null==w.author&&(w.author=[{}]),w.author[w.author.length-1].identifier=g.split(">")[1].split("</")[0];else if(g.includes("<Note>")||g.includes("<Note ")||g.includes("<GeneralNote>")||g.includes("<GeneralNote "))null==w.notes&&(w.notes=[]),w.notes.push(g.split(">")[1].split("</")[0]);else if(g.includes("<DeleteCitation>")||g.includes("<DeleteCitation "))w.deletedFromMedline=!0;else if(g.includes("<ArticleId>")||g.includes("<ArticleId ")){null==w.identifier&&(w.identifier={});try{c=g.split('IdType="')[1].split('"')[0],null==(l=w.identifier)[c]&&(l[c]=g.split(">")[1].split("</")[0])}catch(e){}}else if(!g.includes("</")&&(g.includes("Date>")||g.includes("<Date")||g.includes("<PubMedPubDate")||g.includes("<ArticleDate>")||g.includes("ArticleDate ")||g.includes("<PubDate>")||g.includes("<PubDate "))){k=g.split(">")[0].split(" ")[0].replace("<","");try{(v=g.toLowerCase()).includes("pubstatus")&&(S=v.split(">")[0].split("pubstatus")[1]),S.includes('"')&&(S=S.split('"')[1])}catch(e){}}else if(k&&(g.includes("<Year>")||g.includes("<Month>")||g.includes("<Day>"))){null==w.dates&&(w.dates={}),O=k+(S?"_"+S:""),null==(o=w.dates)[O]&&(o[O]={}),w.dates[O][g.split(">")[0].replace("<","").toLowerCase()]=g.split(">")[1].split("</")[0],delete w.dates[O].date,delete w.dates[O].timestamp;try{w.dates[O]=await this.dateparts(w.dates[O])}catch(e){}try{S&&(w.dates[O].pubstatus=S)}catch(e){}}else if(k&&g.includes("</"+k))k="",S="";else if(g.includes("<Reference>")||g.includes("<Reference "))null==w.references&&(w.references=[]);else if(g.includes("<Citation")){null==w.references&&(w.references=[]),x={author:[]};try{for(_=g.split(". ")[0].split(", "),h=0,m=_.length;h<m;h++)i=_[h],x.author.push({name:i})}catch(e){}try{x.title=g.split(". ")[1].split("?")[0].trim()}catch(e){}try{x.journal=g.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{g.includes("doi.org/")&&(x.doi=g.split("doi.org/")[1].split(" ")[0].trim())}catch(e){}try{x.url="http"+rc.split("http")[1].split(" ")[0]}catch(e){}"{}"!==JSON.stringify(x)&&w.references.push(x)}}u.length&&(await this.src.pubmed(u),j.log(t,y))}catch(e){}return d-=1};s.length&&!(a>0&&y>=a);)await this.sleep(1e3),d<f&&(d+=1,u=s.shift(),await t(u));return j.log(y,s.length),this.params.howmany?batch:y},t.src.pubmed.load._bg=!0,t.src.pubmed.load._log=!1,t.src.pubmed.changes=function(){return this.src.pubmed.load(!0)},t.src.pubmed.changes._bg=!0,t.src.pubmed.changes._log=!1,t.src.pubmed.changes._notify=!1,t.src.ror={_index:!0,_prefix:!1},t.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},t.src.ror.ror=async function(e,t){var i,r,s;if(null==t&&(t=this.refresh),null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11){if((null!=(r=t?void 0:await this.src.ror(e))?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.fetch("https://api.ror.org/organizations/"+e))?r.id:void 0)return s=await this.src.ror._format(r),this.waitUntil(this.src.ror(s)),s}},t.src.ror.grid=async function(e){var t,i,r,s;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(r=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?r.id:void 0)||1===(null!=r&&null!=(t=r.hits)?t.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(i=r.items)?i[0]:void 0)return s=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(s)),s}},t.src.ror.title=async function(e){var t,i,r,s,n;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(s=await this.src.ror('title:"'+e+'"')),(null!=s?s.id:void 0)||1===(null!=s&&null!=(i=s.hits)?i.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(r=s.items)?r[0]:void 0)return n=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(n)),n}},t.src.ror._format=async function(e,t){try{e._id=e.id.split("/").pop()}catch(e){}return null==e.createdAt&&(e.createdAt=null!=t?t:await this.epoch()),e},t.src.ror.dumps=function(){return this.fetch("https://zenodo.org/api/records/?communities=ror-data&sort=mostrecent")},t.src.ror.load=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m;null==e&&(e=this.refresh),y=0,t=[];try{n=await this.src.ror.dumps(),null==e&&(o=await this.epoch(n.hits.hits[0].created.split("+")[0]),null!=(null!=(l=await this.src.ror("src:*",{sort:{createdAt:"desc"},size:1}))?l.hits:void 0)&&(l=l.hits.hits[0]._source))}catch(e){}if(j.log(o,null!=l?l.createdAt:void 0,null!=l?l.src:void 0),e||null==l||null==o||null!=l&&null!=o&&l.createdAt<o)for await(u of(a=n.hits.hits[0].files[0].links.self,j.log(a),i=await this.epoch(),f=!1,s=!1,c="",r=a.replace("/content","").split("/").pop(),d=this.S.directory+"/import/ror/"+r,p=await fetch(a),m=fs.createWriteStream(d),await new Promise(((e,t)=>(p.body.pipe(m),p.body.on("error",t),m.on("finish",e)))),await this._child("unzip",[d,"-d",this.S.directory+"/import/ror/"]),j.log("ROR snapshot downloaded"),await this.src.ror(""),readline.createInterface({input:fs.createReadStream(d.replace(".zip",".json"))})))try{f||5!==u.length||"{"!==u.replace(/\s\s\s\s/,"")?s||5!==u.replace(",","").length||"}"!==u.replace(/\s\s\s\s/,"").replace(",","")?"["!==u&&"]"!==u&&(c+=u):(s=!0,c+="}"):(f=!0,c="{"),!0===f&&!0===s&&(f=!1,s=!1,(h=await this.src.ror._format(JSON.parse(c),i)).src=a,null==h.createdAt&&(h.createdAt=i),c="",y+=1,t.push(h),2e4===t.length&&(j.log("ROR bulk loading",t.length,y),await this.src.ror(t),t=[]))}catch(e){}return t.length&&await this.src.ror(t),j.log(y),y},t.src.ror.load._bg=!0,t.src.ror.load._async=!0,t.src.ror.load._auth="root",null==(v=r.src).zenodo&&(v.zenodo={});try{r.src.zenodo=JSON.parse(SECRETS_ZENODO)}catch(e){}t.src.zenodo={deposition:{},records:{}},t.src.zenodo.records.search=function(e,t){var i,r,s;return null==e&&(e=this.params),null==t&&(t=this.params.dev),r=null!=(i=this.params.size)?i:10,s="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+r+"&q="+encodeURIComponent(e),this.fetch(s)},t.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},t.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},t.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},t.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},t.src.zenodo.records.format=function(e){var t,i,r,s,n,a,l,o,u,c,h;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=e.metadata.description}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,s=0,a=c.length;s<a;s++)if("pdf"===(r=c[s]).type){null==o.pdf&&(o.pdf=r.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),h=e.metadata.creators,n=0,l=h.length;n<l;n++){if("string"==typeof(t=h[n])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},t.src.zenodo.deposition.create=async function(e,t,i,r){var s,n,a,l,o,u,c,h,p;return null==r&&(r=null!=(a=this.params.dev)?a:this.S.dev),null==i&&(i=this.params.token),null==i&&(i=r?null!=(l=this.S.src)&&null!=(o=l.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(p="https://"+(r?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(n={metadata:e}).metadata.upload_type||(n.metadata.upload_type="publication",n.metadata.publication_type="article"),null==(s=n.metadata).creators&&(s.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(h=await this.fetch(p,{method:"POST",body:n,mode:"cors",credentials:"include",headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))?h.id:void 0)&&(t.content||t.file)&&(h.uploaded=await this.src.zenodo.deposition.upload(h.id,t.content,t.file,t.name,t.url,i,r)),t.publish&&(h.published=await this.src.zenodo.deposition.publish(h.id,i,r)),h):await this.fetch(p,{method:"POST",body:n,headers:{referer:this.S.dev||r?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.upload=async function(e,t,i,r,s,n,a){var l,o,u,c;if(null==e&&(e=null!=(l=this.params.upload)?l:this.params.id),null==t&&(t=this.params.content),null==r&&(r=this.params.filename),!t&&!i)try{i=this.request.files[0]}catch(e){}if(s&&!t&&!i)try{t=await this.fetch(s,{buffer:!0,headers:{referer:this.S.dev||a?"https://sandbox.zenodo.org":"https://zenodo.org"}})}catch(e){}return null==n&&(n=this.params.token),null==n&&(n=this.S.dev||a?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==a&&(a=this.params.dev),null!=n&&null!=e&&(s="https://"+(this.S.dev||a?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+n,this.fetch(s,{file:null!=t?t:i,filename:r,headers:{referer:this.S.dev||a?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.publish=function(e,t,i){var r,s,n,a,l;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src)&&null!=(a=n.zenodo)?a.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(l,{method:"POST",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}))},t.src.zenodo.deposition.delete=async function(e,t,i){var r,s,n,a;return null==e&&(e=null!=(r=this.params.publish)?r:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(s=this.S.src.zenodo)?s.sandbox:void 0:null!=(n=this.S.src.zenodo)?n.token:void 0),null!=t&&null!=e&&(a="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(a,{method:"DELETE",headers:{referer:this.S.dev||i?"https://sandbox.zenodo.org":"https://zenodo.org"}}),!0)},t.blacklist=async function(e){var t,i,r,s,n,a,l,o;if(null==e&&(e=this.params.url),"number"==typeof e&&(e=e.toString()),null!=e&&(e.length<4||-1===e.indexOf(".")))return!1;for(i=[],s=0,a=(o=await this.src.google.sheets("1j1eAnBN-5UoAPLFIFlQCXEnOmXG85RhwT1rKUkrPleI")).length;s<a;s++)r=o[s],i.push(r.url.toLowerCase());if(e){if(!e.startsWith("http")&&e.includes(" "))return!1;for(n=0,l=i.length;n<l;n++)if(t=i[n],e.includes(t.toLowerCase()))return!0;return!1}return i},t.bug=function(){var e,t,i,r,s,n,a,l,o,u,c;if(this.params.contact)return"";for(e in c=["help@oa.works"],u="",this.params)u+=e+": "+JSON.stringify(this.params[e],void 0,2)+"\n\n";return o="[OAB forms]","uninstall"===(null!=(i=this.params)?i.form:void 0)?o+=" Uninstall notice":"wrong"===(null!=(r=this.params)?r.form:void 0)?o+=" Wrong article":"bug"===(null!=(s=this.params)?s.form:void 0)?o+=" Bug":"general"===(null!=(n=this.params)?n.form:void 0)?o+=" General":o+=" Other",o+=" "+Date.now(),"wrong"!==(a=null!=(l=this.params)?l.form:void 0)&&"uninstall"!==a||c.push("help@openaccessbutton.org"),this.waitUntil(this.mail({service:"openaccessbutton",from:"help@openaccessbutton.org",to:c,subject:o,text:u})),{status:302,headers:{"Content-Type":"text/plain",Location:t=(this.S.dev?"https://dev.openaccessbutton.org":"https://openaccessbutton.org")+"/feedback#defaultthanks"},body:t}},t.cache=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(p=e.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)n=u[l],-1!==p.indexOf(n+"=")&&(a=new RegExp(n+"=.*?&"),p=p.replace(a,"")),-1!==p.indexOf("&"+n+"=")&&(p=p.split("&"+n+"=")[0]);s=new URL(p)}catch(e){}}catch(e){}if(null!=e)try{if(null==s&&(s=new URL(e.url)),r=new Request(s.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return h=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),h;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,c))}catch(e){}}},t.cache._auth="system",I=[].indexOf,null==t.convert&&(t.convert={}),t.convert.json2csv=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O;if(null==e&&(e=null!=(y=this.body)?y:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(m=e.hits)?m.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),h=null!=(g=t.quote)?g:'"',O=null!=(v=t.separator)?v:",",u=null!=(b=t.newline)?b:"\n",e.length){for(r=null!=(w=t.keys)?w:[],f="",s=0,l=e.length;s<l;s++){if(d=e[s],f.length&&(f+=u),!1!==t.es&&(d._source||d.fields)){for(c in p={},x=null!=(_=d._source)?_:d.fields)null==p[c]&&(p[c]=x[c]);d=p}if(t.flatten&&(d=await this.flatten(d)),t.subset&&(d=await this.dot(d,t.subset)),!t.keys)for(a in d)null!=d[a]&&I.call(r,a)<0&&r.push(a);for(n=0,o=r.length;n<o;n++){if(i=r[n],f.length&&!f.endsWith(u)&&(f+=O),f+=h,null!=d[i]){try{Array.isArray(d[i])&&1===d[i].length&&Array.isArray(d[i][0])&&(d[i]=d[i][0])}catch(e){}try{Array.isArray(d[i])&&d[i].length&&"object"!=typeof d[i][0]&&(d[i]=d[i].join(","))}catch(e){}try{"object"==typeof d[i]&&(d[i]=JSON.stringify(d[i]))}catch(e){}try{'"'===h&&-1!==d[i].indexOf(h)&&(d[i]=d[i].replace(/"/g,h+h))}catch(e){}try{d[i]=d[i].replace(/\n/g," ")}catch(e){}try{d[i]=d[i].replace(/\s\s/g," ")}catch(e){}try{f+=d[i]}catch(e){}}f+=h}}return h+r.join(h+O+h)+h+"\n"+f}return""},t.convert.csv2json=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if(null==t&&(t=this.params),null==e&&(e=null!=(d=this.body)?d:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),v=[],"string"==typeof e&&e.length&&(p=null!=(y=t.quote)?y:'"',w=null!=(m=t.separator)?m:",",c=null!=(g=t.newline)?g:"\n",(u=e.split(c)).length))for(r=u.shift().split(p+w),h="",s=0,a=u.length;s<a;s++)if((_=(h+=(h?c:"")+(o=u[s])).split(p+w)).length===r.length&&(!p||o.endsWith(p))){for(h="",b={},n=0,l=r.length;n<l;n++)if((i=r[n]).startsWith(p)&&(i=i.replace(p,"")),i.endsWith(p)&&(i=i.substring(0,i.length-1)),_.length&&(b[i]=_.shift(),b[i])){b[i].startsWith(p)&&(b[i]=b[i].replace(p,"")),!_.length&&b[i].endsWith(p)&&(b[i]=b[i].substring(0,b[i].length-1));try{b[i]=JSON.parse(b[i])}catch(e){}}v.push(b)}return v},t.convert.csv2html=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g;if(null==e&&(e=null!=(h=this.body)?h:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(p=t.url)?p:e)),'"',y="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",y+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(y+="<thead><tr>",u=0,i=0,s=(d=o.shift().split('","')).length;i<s;i++)y+='<th style="padding:2px; border:1px solid #ccc;">'+d[i].replace(/"/g,"")+"</th>",u+=1;for(y+="</tr></thead>\n<tbody>\n",r=0,n=o.length;r<n;r++){for(l=o[r],y+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(g=0,c=0,a=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<a;c++)g+=1,y+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(m=(m=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===m.indexOf("{")||0===m.indexOf("[")?(y+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",y+=await this.convert.json2html(JSON.parse(m.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),y+="</div>"):y+=m.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),y+="</td>";for(;g<u;)y+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',g+=1;y+="</tr>\n"}y+="</tbody>\n"}return y+"</table>"},t.convert.json2html=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p;if(null==e&&(e=null!=(u=this.body)?u:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},r=0,n=(c=await this.index.keys(this.route.replace(/\//g,"_"))).length;r<n;r++)e[c[r]]="";if(t.subset&&!Array.isArray(e))for(o=t.subset.split(".");(l=o.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[l];)e=e[l];if(Array.isArray(e)||null!=(null!=e&&null!=(h=e.hits)?h.hits:void 0)&&!1!==t.es)return null!=o&&(t.subset=o.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t));if(p="<div>",t.flatten&&(e=await this.flatten(e),p+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(o.length)for(s=0,a=o.length;s<a;s++)e=e[o[s]];p+="<h3>"+t.subset+":</h3>",p+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return i=e=>{var r,s,n,a,l,o,u,c,h,d,f;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(a=0,s=(c=t.keys).length;a<s;a++)null==e[u=c[a]]&&(e[u]="");for(r in d=[],e){try{Array.isArray(e[r])&&1===e[r].length&&Array.isArray(e[r][0])&&(e[r]=e[r][0])}catch(e){}if(null==e[r]||Array.isArray(e[r])&&!e[r].length||t.keys&&!(I.call(t.keys,r)>=0))d.push(void 0);else{if(p+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+r+"</p></b></div>",p+='<div style="float:left;">',p+=t.edit?'<textarea class="PForm" id="'+r+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[r]))if("object"==typeof e[r][0])for(l=0,n=(h=e[r]).length;l<n;l++)o=h[l],i(o);else{try{f=e[r].join(", ")}catch(t){try{f=JSON.stringify(e[r])}catch(t){f=e[r]}}try{p+=(t.edit?"":"<p>")+f+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[r]?i(e[r]):p+=(t.edit?"":"<p>")+e[r]+(t.edit?"":"</p>");p+=t.edit?"</textarea>":"",d.push(p+="</div></div>")}}return d},i(e),p+="</div>"},t.convert.json2txt=async function(e){var t,i,r;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),r=[],t=async function(e){var i,s,n,a,l;if(Array.isArray(e)){for(a=[],s=0,n=e.length;s<n;s++)i=e[s],a.push(await t(i));return a}if("object"==typeof e){for(i in l=[],e)l.push(await t(e[i]));return l}if(e)return r.push(e)},await t(e),r.join(" ")},t.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},t.convert.hex2bin=function(e){var i,r,s,n,a;for(a=[],i=0,s=(n=Array.isArray(e)?e:[e]).length;i<s;i++)r=n[i],a.push(t.convert._hexMatch[r.toLowerCase()]);return a.join("")},t.convert.bin2hex=function(e){var i,r,s,n,a,l,o,u,c;if(!Array.isArray(e)){for(i=[],c=e.split(""),o="";c.length;)4===(o+=c.shift()).length&&(i.push(o),o="");e=i}for(n in u=[],r={},t.convert._hexMatch)r[t.convert._hexMatch[n]]=n;for(s=0,l=e.length;s<l;s++)a=e[s],u.push("0x"+r[a]);return new A(u).toString()},t.convert.buf2bin=async function(e){var i,r;for(A.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),r="",i=0;i<e.length;)r+=await t.convert.hex2bin(e[i]),i++;return r},t.convert.stream2txt=function(e){var t;return t=[],new Promise(((i,r)=>(e.on("data",(e=>t.push(A.from(e)))),e.on("error",(e=>r(e))),e.on("end",(()=>i(A.concat(t).toString("utf8")))))))},t.convert.xml2json=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d,f,y,m;if(null==e&&(e=null!=(p=this.params.xml2json)?p:this.params.url),f={},"string"==typeof e)for(e.startsWith("http")&&(e=await this.fetch(e)),i="",u="",y=!1,r=!1;t=e[0];)if(e=e.slice(1),"\ufeff"!==t&&"\t"!==t&&"\r"!==t&&"\n"!==t&&(" "!==t||i.length&&!i.endsWith(">"))&&("<"===i&&"/"!==t&&"?"!==t&&"!"!==t&&(y=!0),((i+=t).endsWith("</")&&i.split("</").length-1===i.split(">").length||i.endsWith("/>")&&!i.split("/>")[0].includes(">"))&&(r=!0),">"===t)){if(j.log(u),r){if(r=!1,""!==(i=i.split("</")[0])){if(h=await this.dot(f,u,void 0,void 0,!0))Array.isArray(h)?(h.length||(h=[{}]),null!=h[h.length-1].$?(Array.isArray(h[h.length-1].$)||(h[h.length-1].$=[h[h.length-1].$]),h[h.length-1].$.push(i)):h[h.length-1].$=i):h.$=i,i=h;else{i={$:i};try{(c=await this.dot(f,u.slice(0,u.lastIndexOf(".")),void 0,void 0,!0))&&(i._=c[u.split(".").pop()]._)}catch(e){}}"object"==typeof i&&null==i._&&null!=i.$&&(i=i.$),await this.dot(f,u,i,void 0,!0)}u=u.includes(".")?u.slice(0,u.lastIndexOf(".")):""}else if(y){for(y=!1,l={},s=0,a=(d=i.replace("<","").replace(">","").split(" ")).length;s<a;s++)(o=d[s]).includes("=")?o.length&&([n,m]=o.split("="),l[n.trim().replace(/"/g,"")]=m.trim().replace(/"/g,"")):u+=(u&&!u.endsWith(".")?".":"")+o;(h=await this.dot(f,u,void 0,void 0,!0))?(Array.isArray(h)||(h=[h]),h.push("{}"!==JSON.stringify(l)?{_:l}:{}),await this.dot(f,u,h,void 0,!0)):"{}"!==JSON.stringify(l)&&await this.dot(f,u+"._",l,void 0,!0)}i=""}return f},t.dateparts=async function(e){var t,i,r,s,n,a,l,o,u,c,h;t={},null==e&&(e=null!=(n=this.params.dateparts)?n:t.date);try{if("object"==typeof e){for(i in e)t[i]=e[i];e=null!=(a=t.date)?a:""}else if(null==e){for(i in params)null==t[i]&&(t[i]=this.params[i]);e=null!=(l=t.date)?l:""}if(("number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))&&(e=await this.date(e)),e.includes("T")&&e.includes("-")&&(e=e.split("T")[0]),(e=(e=e.trim().toLowerCase().replace(", "," ").replace(" of ","").replace("st "," ").replace("nd "," ").replace("rd "," ").replace("th "," ")).replace(/-/g," ").replace(/\//g," ")).includes(" "))for(i in s=e.split(" "))(r=s[i]).includes(":")||(r.length>=3?isNaN(parseInt(r))?(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(r.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""):t.year=r:parseInt(r)<13&&(2===s.length||3===s.length&&"1"===i)?t.month=r:1===s.length?t.year=r:t.day=r);t.day=(null!=(o=t.day)?o:"01").toString(),1===t.day.length&&(t.day="0"+t.day),"string"==typeof t.month&&t.month.length&&isNaN(parseInt(t.month))&&(t.month=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(t.month.toLowerCase().substr(0,3)),t.month="number"==typeof t.month&&t.month>=0?t.month+1:""),t.month=(null!=(u=t.month)?u:"01").toString(),1===t.month.length&&(t.month="0"+t.month),t.year=t.year.toString(),2===t.year.length&&(t.year=parseInt(t.year)<30?"20":"19"+t.year),"31"!==t.day||"04"!==(c=t.month)&&"06"!==c&&"09"!==c&&"11"!==c||(t.day="30"),"02"===t.month&&("30"===(h=t.day)||"31"===h||"29"===t.day&&parseInt(t.year)%4)&&(t.day="28"),t.date=t.year+"-"+t.month+"-"+t.day;try{t.timestamp=await this.epoch(t.date)}catch(e){}}catch(e){}return t},t.dateparts._cache=!1,t.date=function(e,t,i=!0,r=!0){var s,n,a,l,o;if(null==e&&(e=null!=(a=this.params.date)?a:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&!e.includes(" ")&&!e.includes("/")&&!e.includes("-")&&e.length>8&&!e.includes("T"))try{return o=(o=new Date(parseInt(e))).toISOString(),t?i?r||(o=o.split(".")[0].replace("T"," ")):o=o.split(":").slice(0,-1).join(":").replace("T"," "):o=o.split("T")[0],o}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(s in e)"number"!=(l=typeof e[s])&&"string"!==l&&(e[s]="01");e=e.join("-")}catch(e){}return(e=decodeURIComponent(e)).includes("T")&&(e=e.split("T")[0]),(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).includes("-")||(e+="-01-01"),3!==e.split("-").length&&(e+="-01"),3!==(n=e.split("-")).length&&(e=void 0),n[0].length<n[2].length&&(e=n.reverse().join("-")),e}catch(e){}},t.date._cache=!1,t.datetime=function(e,t){var i,r;return this.date(this.params.datetime,null==(i=this.params.time)||i,null!=(r=null!=e?e:this.params.secs)?r:this.params.s,null!=t?t:this.params.ms)},t.datetime._cache=!1,t.epoch=function(e){var t,i,r,s,n,a;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&e.includes("/")&&(3===(r=e.split("/")).length&&4===r[2].length&&r.reverse(),e=r.join("-")),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),e.includes("T")||(e+="T"),e.includes(":")||(e+="00:00"),e.split(":").length<3&&(e+=":00"),e.includes(".")||(e+="."),[n,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return i.includes("Z")||(i+="Z"),new Date(n+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,a]=e.replace("/","").split("-"),(parseInt(e)-parseInt(a)).toString()):void 0},t.epoch._cache=!1,t.uid=function(t){var i,r,s,n,a,l,o,u,c,h,p;return null==t&&(t="uid"===this.fn&&null!=(i=null!=(r=null!=(s=null!=(n=null!=this&&null!=(a=this.params)?a.len:void 0)?n:null!=this&&null!=(l=this.params)?l.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?r:null!=this&&null!=(u=this.params)?u.uid:void 0)?i:21),"string"==typeof t&&(p=parseInt(t),t=isNaN(p)?void 0:p),((t,i=21)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,s=-~(1.6*r*t/e.length);return(n=t)=>{let a="";for(;;){let t=i(s),l=s;for(;l--;)if(a+=e[t[l]&r]||"",a.length===n)return a}}})(t,i,e))(null!=(c=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",t)()},t.uid._cache=!1,t.encrypt=async function(e){var t,i,r,s,n,a;null==e&&(e=null!=(i=null!=(r=null!=(s=null!=(n=this.params.encrypt)?n:this.params.content)?s:this.params.q)?r:this.params)?i:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createCipheriv("aes-256-ctr",this.S.encrypt.salt,null!=(a=this.params.iv)?a:this.S.encrypt.iv),A.concat([t.update(e),t.final()]).toString("hex")},t.encrypt._cache=!1,t.encrypt._bg=!0,t.decrypt=async function(e){var t,i,r,s,n,a,l;null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(a=this.params.decrypt)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}return"object"==typeof e?(i=e.iv,e=e.content):i=null!=(l=this.params.iv)?l:this.S.encrypt.iv,"string"!=typeof e&&(e=JSON.stringify(e)),t=crypto.createDecipheriv("aes-256-ctr",this.S.encrypt.salt,i),A.concat([t.update(A.from(e,"hex")),t.final()]).toString()},t.decrypt._cache=!1,t.decrypt._bg=!0,t.decrypt._auth="@oa.works",t.hash=async function(e){var t,i,r,s,n,a,l,o,u,c;null==e&&(e=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(r),a=[],s=0,n=t.length;s<n;s++)i=t[s],a.push(("00"+i.toString(16)).slice(-2));return a.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},t.hashcode=function(e){var t,i,r,s,n,a;for(null==e&&(e=null!=(r=null!=(s=null!=(n=null!=(a=this.params.hashcode)?a:this.params.content)?n:this.params.q)?s:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},t.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},t.shorthash=function(e,t){var i,r,s,n,a,l,o,u;for(null==e&&(e=null!=(s=null!=(n=null!=(a=null!=(l=this.params.shorthash)?l:this.params.content)?a:this.params.q)?n:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),r=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=r<0?u:"",r=Math.abs(r);r>=i;)o+=t[r%i],r=Math.floor(r/i);return o+(r>0?t[r]:"")},t.fetch=async function(e,t){var i,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,I,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X;if(null==e&&null==t)try{t=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==t&&(e=(t=e).url),null==t&&(t={}),"number"==typeof t&&(t={cache:t}),"number"==typeof t.cache&&(null==t.cf&&(t.cf={cacheEverything:!0}),t.cf.cacheTtl=t.cache,delete t.cache),!e&&t.url&&(e=t.url,delete t.url),!0===t.bg&&"string"==typeof r.bg&&(t.url=e,e=r.bg+"/fetch",delete t.bg),t.username&&t.password&&(t.auth=t.username+":"+t.password,delete t.username,delete t.password),e.split("?")[0].includes("@")&&e.includes(":")&&e.split("//")[1].split("?")[0].split("@")[0].includes(":")&&(t.auth=e.split("//")[1].split("@")[0],e=e.replace(t.auth+"@","")),t.auth&&(null==t.headers&&(t.headers={}),t.headers.Authorization="Basic "+A.from(t.auth).toString("base64"),delete t.auth),h=0,y=(N=["data","content","json"]).length;h<y;h++)null!=t[a=N[h]]&&(t.body=t[a],delete t[a]);if(null==t.attachment&&(t.attachment=t.attachments),null==t.file&&(t.file=t.attachment),null!=t.file){for(null==t.headers&&(t.headers={}),null!=t.body&&null==t.form&&(t.form=t.body),t.body=new FormData,Array.isArray(t.file)||(u="object"==typeof t.file&&null!=t.file.file?[{file:t.file.file,filename:null!=(L=null!=(R=t.file.filename)?R:t.file.name)?L:t.filename}]:[{file:t.file,filename:t.filename}],t.file=u),p=0,m=(W=t.file).length;p<m;p++)null==(null!=(c=W[p])?c.file:void 0)&&null==(null!=c?c.data:void 0)||t.body.append(null!=t.attachment?"attachment":"file",null!=(U=c.file)?U:c.data,null!=(M=null!=(B=null!=(z=c.filename)?z:c.name)?B:t.filename)?M:"file");delete t.filename,null==t.method&&(t.method="POST")}else null!=t.body&&(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="object"==typeof t.body?"application/json":"text/plain"),"object"!=(F=typeof t.body)&&"boolean"!==F&&"number"!==F||(t.body=JSON.stringify(t.body)),null==t.method&&(t.method="POST"));if(null!=t.form){if(null!=t.file){if("object"==typeof t.form)for(o in t.form)for(f=0,g=(J=Array.isArray(t.form[o])?t.form[o]:[t.form[o]]).length;f<g;f++)s=J[f],t.body.append(o,"object"==typeof s?JSON.stringify(s):s)}else{if(null==t.headers&&(t.headers={}),null==t.headers["Content-Type"]&&null==t.headers["content-type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof t.form){for(k in S="",t.form)for(""!==S&&(S+="&"),w=0,v=(P=Array.isArray(t.form[k])?t.form[k]:[t.form[k]]).length;w<v;w++)null!=(I=P[w])&&(S.endsWith("&")||(S+="&"),S+=k+"="+encodeURIComponent("object"==typeof I?JSON.stringify(I):I));t.form=S}t.body=t.form}delete t.form,null==t.method&&(t.method="POST")}if(delete t.file,delete t.attachment,delete t.attachments,"string"!=typeof e);else{if(!e.startsWith("http:")&&e.includes("localhost"))try{null==t.agent&&(t.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(O=(D=e.split("?")).shift()+"?",_=0,b=(q=D.join("?").split("&")).length;_<b;_++)C=q[_],O.endsWith("?")||(O+="&"),[d,X]=C.split("="),null==X&&(X=""),d&&(O+=encodeURIComponent(d)+(X?"="+(X.includes("%")?X:encodeURIComponent(X)):""));e=O}if(t.params&&"{}"!==JSON.stringify(t.params)){for(d in e.includes("?")||(e+="?"),T=t.params)X=T[d],e.endsWith("&")||e.endsWith("?")||(e+="&"),d&&(e+=encodeURIComponent(d)+"="+encodeURIComponent("object"==typeof X?JSON.stringify(X):X));delete t.params}r.system&&("string"==typeof r.bg&&e.startsWith(r.bg)||"string"==typeof r.async&&e.startsWith(r.async)||"string"==typeof r.kv&&r.kv.startsWith("http")&&e.startsWith(r.kv))&&(null==t.headers&&(t.headers={}),null==(n=t.headers)[x="x-"+r.name.toLowerCase()+"-system"]&&(n[x]=r.system),t.headers.Authorization||t.headers.authorization||t.headers["x-apikey"]||!this.user||(t.headers["x-apikey"]=this.user.apikey)),i=async()=>{var i,s,n,a,l,o,u,c;if(t.stream)return delete t.stream,fetch(e,t);i=!1,t.buffer&&(i=!0,delete t.buffer),c=await fetch(e,t);try{(!e.includes("localhost")||200!==(o=c.status)&&404!==o)&&r.dev&&!0===r.bg&&j.log(c.status+" "+e),t.verbose&&(c.status>300&&j.log(c.body),j.log(c.status+" "+e))}catch(e){j.log("Error logging to console for fetch"),j.log(c)}if(i)l=await c.buffer();else if("HEAD"===t.method)for(l={status:c.status},a=0,n=(u=[...c.headers]).length;a<n;a++)l[(s=u[a])[0]]=s[1];else{try{l=await c.text()}catch(e){}try{"string"==typeof l&&(l.startsWith("{")||l.startsWith("["))&&(l=JSON.parse(l))}catch(e){}}return 404!==c.status?c.status>=400?(r.dev&&!0===r.bg&&j.log(t,JSON.stringify(l),"FETCH ERROR",c.status),{status:c.status}):l:void 0};try{t.timeout&&null!=(null!=this?this._timeout:void 0)?(E=!0===t.timeout?3e4:t.timeout,delete t.timeout,$=await this._timeout(E,i())):$=await i();try{(($=$.trim()).startsWith("[")||$.startsWith("{"))&&($=JSON.parse($))}catch(e){}return $}catch(t){l=t,r.dev&&!0===r.bg&&j.log("ERROR TRYING TO CALL FETCH",e,l,JSON.stringify(l));try{this.log(l)}catch(e){}}}},t.fetch._auth="system",t._timeout=function(e,t){return new Promise(((t,i)=>{var r;return r=setTimeout((()=>i(new Error("TIMEOUT"))),e),promise.then(value((()=>(clearTimeout(r),t(value))))).catch(reason((()=>(clearTimeout(r),i(reason)))))}))},I=[].indexOf,null==r.index&&(r.index={}),null==(v=r.index).name&&(v.name=null!=(w=r.name)?w:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(b=r.index).url&&(b.url=r.bg+"/index"),t.index=async function(e,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_;if("object"==typeof e&&(i=e,e=void 0),null==e&&null==i&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(h=this.parts[1])||"src"===h))return{status:403};if("object"==typeof this.body?i=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(i=this.body):i=this.copy(this.params),delete i.route,delete i.index,delete i[this.fn.split(".").pop()],delete i._id,null!=i.script||-1!==JSON.stringify(i).toLowerCase().indexOf("<script"))return}if("object"!=typeof i||Array.isArray(i)||(null==e&&(e=null!=(p=i.route)?p:i.index),delete i.route,delete i.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in g=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||g.push(l);return g}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,_]=e.split("?"),_="?"+_):_="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof i&&!Array.isArray(i)&&i._id&&(a=(i=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i))._id.replace(/\//g,"_").toLowerCase(),-1===e.indexOf("/")&&-1===e.indexOf(a)&&(e+="/"+a),delete i._id,"{}"===JSON.stringify(i)&&(i=void 0)),w=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=t.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===i)v=await this.index._send(e.replace("/","/_doc/")+_,"");else if(1===w){if("string"==typeof i&&(""===i||-1!==i.indexOf("\n"))||Array.isArray(i))return""===i?this.index._send(e+_,i):this.index._bulk(e+_,i);if("object"!=(d=typeof i)&&"string"!==d)return this.index._send(e+"/_search"+_);if("{}"!==JSON.stringify(i)&&(c=await this.index.translate(i,r)))return this.index._send(e+"/_search"+_,c);if("object"==typeof i){for(n=null!=(null!=this?this.copy:void 0)?this.copy(i):t.copy(i),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete n[f[o]];return"{}"===JSON.stringify(n)?(await this.index._send(e+_)||await this.index._send(e+_,{settings:i.settings,aliases:i.aliases,mappings:null!=(y=i.mappings)?y:i.mapping}),this.index._send(e+"/_search"+_)):"created"===(null!=(v=await this.index._send(e+"/_doc"+_,i))?v.result:void 0)&&v._id?v._id:v}}else if(2===w&&(null==i||"object"==typeof i&&!Array.isArray(i)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=i&&"{}"!==JSON.stringify(i)?("object"==typeof i&&null!=i.script&&(e+="_update",_+=(_.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(v=await this.index._send(e+_,i))?v.result:void 0)&&v._id?v._id:v):("object"==typeof(v=await this.index._send(e+_))&&(v._source||v.fields)&&(null==(b=null!=(m=v._source)?m:v.fields)._id&&(b._id=v._id),v=b),v)},t.index._auths="system",t.index._caches=!1,t.index.status=async function(){var e,t,i,r,s,n,a,l,o,u,c,h,p,d,f;c={status:"green",docs:0,size:0,shards:0,failed:0};try{for(i in(f=await this.index._send("_nodes/stats/indices/search")).nodes)null==c.scrolls&&(c.scrolls=0),c.scrolls+=f.nodes[i].indices.search.open_contexts}catch(e){}for(i in c.indices={},h=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),h.indices)if(!i.startsWith(".")&&!i.startsWith("security-")){for(c.indices[i]={docs:h.indices[i].primaries.docs.count,size:Math.ceil(h.indices[i].primaries.store.size_in_bytes/1024/1024)+"mb"},r=0,a=d.length;r<a;r++)(p=d[r]).index===i&&"p"===p.prirep&&(null==(e=c.indices[i]).shards&&(e.shards=0),c.indices[i].shards+=1,null==(t=c.indices[i]).failed&&(t.failed=0),"UNASSIGNED"===p.state&&(c.indices[i].failed+=1));c.docs+=c.indices[i].docs;try{c.size+=parseInt(c.indices[i].size.replace("mb",""))}catch(e){}c.shards+=c.indices[i].shards,c.failed+=c.indices[i].failed}c.size=Math.ceil(c.size/1e3+"gb");try{for("green"!==(o=c.cluster.status)&&"yellow"!==o&&(c.status="red"),n=0,l=(u=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;n<l;n++)s=u[n],delete c.cluster[s]}catch(e){}return c},t.index.keys=async function(e,t){var i,r,s,n,a,l;return null==e&&(e=null!=(n=null!=(a=this.params.index)?a:this.params.keys)?n:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),null==t&&(t=null!=(l=this.params.type)?l:this.params.types),"string"==typeof t&&(t=[t]),r=!0===t?{}:[],s="object"==typeof e?e:await this.index.mapping(e),i=async(e,s="")=>{var n,a,l,o;for(n in s&&(s+="."),o=[],e)null!=e[n].properties?o.push(await i(e[n].properties,s+n)):!t||!0===t||(a=e[n].type,I.call(t,a)>=0)?!0===t?o.push(r[s+n]=e[n].type):(l=s+n,I.call(r,l)<0?o.push(r.push(s+n)):o.push(void 0)):o.push(void 0);return o},"object"==typeof s&&await i(s),r},t.index.terms=async function(e,t,i,r=100,s=!0,n="count"){var a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;if(null==e&&(e=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(y=this.params.terms)?y:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(a=this.copy(this.params),l=0,u=(m=["index","route","terms","key"]).length;l<u;l++)delete a[m[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(a)),d="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&d.query.bool.must.push({query_string:{query:i}}),null==d.aggregations&&(d.aggregations={}),null==d.size&&(d.size=0),null!=this.params.size&&(r=this.params.size),null!=this.params.counts&&(s=this.params.counts),null!=this.params.order&&(n=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof n&&null!=h[n]&&(n=h[n]),d.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")?"":".keyword"),size:r,order:n}},_=[],o=0,c=(w=null!=(g=null!=(x=await this.index._send("/"+e+"/_search",d,"POST"))&&null!=(v=x.aggregations)&&null!=(b=v[t])?b.buckets:void 0)?g:[]).length;o<c;o++)p=w[o],_.push(s?{term:p.key,count:p.doc_count}:p.key);return _},t.index.suggest=async function(e,t,i,r=100,s){var n,a,l,o,u,c,h,p,d,f,y,m,g;if(t&&i||(null==t&&(t=null!=(p=this.params.suggest)?p:this.params.key),"string"==typeof t&&t.includes("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e,"text");if(null==e&&(e=null!=(d=this.params.index)?d:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==s&&(s=this.params.include),"string"==typeof s&&(s=s.replace(/,\s/g,",").split(",")),Array.isArray(s)&&I.call(s,t)<0&&s.push(t),"string"==typeof i&&(c=(i=i.trim()).toLowerCase(),(g={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},g.should[1].prefix[t]={value:i,boost:2}),y=[],m=[],s){for await(h of this.index._for(e,null!=g?g:i,{sort:t+".keyword",until:r,include:!0===s?[t]:s}))if(l=await this.dot(h,t)){for(;Array.isArray(l)&&(n=l.shift());)n.toLowerCase().includes(c)&&(l=n);o=l.toLowerCase(),I.call(m,o)<0&&(!c||o.includes(c))&&y.push(h),m.push(o)}}else for(a=0,u=(f=await this.index.terms(e,t,null!=g?g:i,r,!1,"term")).length;a<u;a++)o=(l=f[a]).toLowerCase(),I.call(m,o)<0&&(!c||o.includes(c))&&y.push(l),m.push(o);return y},t.index.count=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d;for(null==i&&(i=null!=(l=this.params.count)?l:this.params.key),null==e&&(e=null!=(o=this.params.index)?o:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),r=this.copy(this.params),s=0,n=(u=["index","route","count","key"]).length;s<n;s++)delete r[u[s]];return null==t&&(a=await this.index.translate(r))&&(t=a),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(c=d.aggregations)&&null!=(h=c.keyed)?h.value:void 0):null!=(d=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(p=d.hits)?p.total:void 0},t.index.percent=async function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d,f,y;for(null==i&&(i=null!=(o=this.params.count)?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,i]=e.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","count","key"]).length;n<a;n++)delete s[c[n]];return null==t&&(l=await this.index.translate(s))&&(t=l),"string"==typeof t&&(t=await this.index.translate(t)),null==t&&(t={query:{bool:{must:[],filter:[]}}}),y=await this.index.count(e,"*"),r=0,i?(i.endsWith(".keyword")||(i+=".keyword"),t.size=0,t.aggs={keyed:{cardinality:{field:i,precision_threshold:4e4}}},r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(h=f.aggregations)&&null!=(p=h.keyed)?p.value:void 0):r=null!=(f=await this.index._send("/"+e+"/_search",t,"POST"))&&null!=(d=f.hits)?d.total:void 0,Math.ceil(r/y*1e4)/100},t.index.min=async function(e,t,i,r="min"){var s,n,a,l,o,u,c,h;for(null==t&&(t=null!=(o=this.params[r])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+r,"")).indexOf("/")&&([e,t]=e.split("/")),s=this.copy(this.params),n=0,a=(c=["index","route","min","max","key","sum","average"]).length;n<a;n++)delete s[c[n]];return null==i&&(i=await this.index.translate(s)),(l="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,"sum"===r?l.aggs={sum:{sum:{field:t}}}:"average"===r?l.aggs={average:{avg:{field:t}}}:(l.aggs={},"min"!==r&&"range"!==r||(l.aggs.min={min:{field:t}}),"max"!==r&&"range"!==r||(l.aggs.max={max:{field:t}})),h=await this.index._send("/"+e+"/_search",l,"POST"),"range"===r?{min:h.aggregations.min.value,max:h.aggregations.max.value}:h.aggregations[r].value},t.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},t.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},t.index.sum=function(e,t,i){return this.index.min(e,t,i,"sum")},t.index.average=function(e,t,i){return this.index.min(e,t,i,"average")},t.index.mapping=async function(e,t){var i,r;return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),null!=t&&(i=await this.index._send(e,t,"PUT"),j.log(e,"mapped",i)),(r=await this.index._send(e))[(await this.keys(r))[0]].mappings.properties},t.index._for=async function*(e,t,i,r,s){var n,a,l,o,u,c,h,p,d,f,y,m,g;for("number"==typeof i&&(i={until:i}),(null!=i?i.scroll:void 0)?("number"!=typeof(g=i.scroll)&&g.endsWith("m")||(g+="m"),delete i.scroll):g="2m",((null!=i?i.until:void 0)||(null!=i?i.max:void 0))&&(a=null!=(c=i.until)?c:i.max,delete i.until,delete i.max),null==t&&(t="*"),null==(o=await this.index.translate(t,i)).from&&(o.from=0),null==o.size&&(o.size=500),null==o.sort&&(o.sort=["_doc"]),(null!=(y=await this.index._send(e+"/_search?scroll="+g,o,void 0,r,s))?y._scroll_id:void 0)&&(l=y._scroll_id.replace(/==$/,"")),(null!=y&&null!=(h=y.hits)?h.total:void 0)&&(null==a||a>y.hits.total)&&(a=y.hits.total),n=0;;){if((null!=y&&null!=(p=y.hits)?p.hits:void 0)&&0!==y.hits.hits.length||!(null!=y?y._scroll_id:void 0)||(null!=(y=await this.index._send("/_search/scroll?scroll="+g+"&scroll_id="+y._scroll_id,void 0,void 0,r,s))?y._scroll_id:void 0)!==l&&(await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,r,s),l=null!=y?y._scroll_id:void 0),n===a||null==(null!=y&&null!=(d=y.hits)?d.hits:void 0)||!y.hits.hits.length){l&&await this.index._send("/_search/scroll?scroll_id="+l,"",void 0,r,s);break}n+=1,null==(m=null!=(f=(u=y.hits.hits.shift())._source)?f:u.fields)._id&&(m._id=u._id),yield m}},t.index._each=async function(e,t,i,r,s,n){var a,l,o,u,c,h,p,d,f,y,m;for await(p of(null==r&&null==i&&"function"==typeof t&&(r=t,t="*"),null==r&&"function"==typeof i&&(r=i,i=void 0),null==i&&(i={}),"string"==typeof i&&(a=i,i=void 0),(null!=i?i.action:void 0)&&(a=i.action,delete i.action),(y=null!=(d=i.size)?d:"object"==typeof t&&null!=t.size?t.size:1e3)>50&&((h=await this.index.translate(t,i)).size=1,null!=(null!=(l=await this.index._send(e,h,void 0,s,n))&&null!=(f=l.hits)?f.total:void 0)&&0!==l.hits.total&&(u=Math.floor(1e9/(A.byteLength(JSON.stringify(l.hits.hits[0]))*l._shards.total)))<y&&(y=u),h.size=y),c=0,m=[],this.index._for(e,null!=h?h:t,i,s,n)))c+=1,null==(o=await r.call(this,p))||"object"!=typeof o&&"string"!=typeof o||m.push(o),a&&m.length>y&&(await this.index._bulk(e,m,a,void 0,s,n),m=[]);if(a&&m.length&&this.index._bulk(e,m,a,void 0,s,n),this.S.dev&&!0===this.S.bg)return j.log("_each processed "+c)},t.index._bulk=async function(e,i,r="index",s=5e4,n,a){var l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A,I,E,D,C,N,L,P,q;if(!0===r&&(r="index"),q=e.split("/")[0],o=await this.dot(t,q.replace(/_/g,".")),null==a&&(a=null!=(g=null!=(x=this.params._alias)?x:null!=(O=this.S.alias)?O[q.startsWith(this.S.index.name+"_")?q.replace(this.S.index.name+"_",""):q]:void 0)?g:null!=o?o._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),q.endsWith(a)||(e=e.replace(q,q+a))),!0===n&&(n=this.S.index.name),null==n&&(n=null!=(k=null!=o?o._prefix:void 0)?k:this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e)),null==this.index&&(this.index=t.index),"string"==typeof i&&-1!==i.indexOf("\n"))return await this.index._send("/_bulk",{body:i,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,a),!0;for(m in L="object"!=typeof i||Array.isArray(i)||null==(null!=i&&null!=(S=i.hits)?S.hits:void 0)?i:i.hits.hits,Array.isArray(L)||(L=[L]),l=0,u=0,y="",L)if(l+=1,"object"==typeof(N=L[m])&&("string"==typeof(C=null!=(A=null!=(I=N._id)?I:null!=(E=N._source)?E._id:void 0)?A:await this.uid())&&(C=C.replace(/\//g,"_")),N._source&&(N=N._source),delete N._id),(f={})[r]={_index:e},f[r]._id="delete"!==r||"string"!=(D=typeof N)&&"number"!==D?C:N,y+=JSON.stringify(f)+"\n","create"===r||"index"===r?y+=JSON.stringify(N)+"\n":"update"===r&&(y+=JSON.stringify({doc:N})+"\n"),l===s||parseInt(m)===L.length-1||y.length>7e7){if(P=await this.index._send("/_bulk",{body:y,headers:{"Content-Type":"application/x-ndjson"}},void 0,n,a),(null!=this&&null!=(v=this.S)?v.dev:void 0)&&!0===(null!=this&&null!=(b=this.S)?b.bg:void 0)&&(null!=P?P.errors:void 0)){for(c=[],p=0,d=(w=P.items).length;p<d;p++){h=w[p];try{200!==(_=h[r].status)&&201!==_&&(c.push(h[r]),u+=1)}catch(e){u+=1}}try{j.log(c)}catch(e){}try{j.log(0===c.length?"SOME":c.length,"INDEX ERRORS BULK LOADING",P.items.length)}catch(e){}}y="",l=0}return L.length-u},t.index.translate=function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,I,E,D,C,N,L,P,q,T,R,W,U,M,B,z,F,J,$,X,V,G,Y,H,Z,K,Q,ee,te,ie,re,se,ne,ae,le,oe,ue,ce,he,pe,de;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(m=0,b=(P=["settings","aliases","mappings","index","_id"]).length;m<b;m++)if(null!=e[g=P[m]])return;if(L=!1,e.source)try{L=JSON.parse(decodeURIComponent(e.source))}catch(e){}if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&!1===L&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),("string"==typeof t||Array.isArray(t))&&(t={fields:t}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(N=null!=($=null!=t?t.query:void 0)?$:{}).query&&(N.query={}),null==(n=N.query).bool&&(n.bool={must:[],filter:[]}),"string"==typeof e)ae={query_string:{query:e}},null!=(null!=t?t.fields:void 0)&&(ae.query_string.fields="string"==typeof t.fields?t.fields.split(","):t.fields,delete t.fields),N.query.bool.filter.push(ae);else if("object"==typeof e)if(null!=e.query)N=e;else for(I in null!=e.source?"string"==typeof e.source&&"object"==typeof L?N=L:"object"==typeof e.source&&(N=e.source):null!=e.q&&("object"==typeof e.q?N.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(D={})[(C=e.q.split(":"))[0]]=C[1],N.query.bool.must.push({prefix:D})):null!=e.fields?(N.query.bool.filter.push({query_string:{query:e.q,fields:e.fields.split(",")}}),delete e.fields):N.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[I]&&(t[I]=e[I]);if(null!=(null!=(Y=N.query)&&null!=(H=Y.filtered)&&null!=(Z=H.query)?Z.bool:void 0)&&(N.query.bool=N.query.filtered.query.bool,N.query.bool.filter=N.query.filtered.filter,delete N.query.filtered),null!=N.facets&&(N.aggregations=JSON.parse(JSON.stringify(N.facets).replace(/\.exact/g,".keyword")),delete N.facets),null!=N.query&&null==N.query.bool&&"{}"!==JSON.stringify(N.query)&&(N.query={bool:{must:[],filter:[N.query]}}),null==N.query&&(N.query={bool:{must:[],filter:[]}}),null==(a=N.query).bool&&(a.bool={must:[],filter:[]}),null==(l=N.query.bool).filter&&(l.filter=[]),"string"==typeof t.sort){for(ne=[],v=0,w=(K=t.sort.split(",")).length;v<w;v++)se=K[v],[g,I]=se.split(":"),I?(ne.push({}),ne[ne.length-1][g.trim()]=I.trim()):ne.push(g.trim());t.sort=ne}if(t.random&&(d={function_score:{random_score:{}}},null!=t.seed&&(d.function_score.random_score.seed=seed),d.function_score.query=N.query,N.query=d,delete t.random,delete t.seed),(y=null!=(Q=null!=(ee=null!=(te=t._include)?te:t.include)?ee:t._includes)?Q:t.includes)&&(null==N._source&&(N._source={}),N._source.includes="string"==typeof y?y.replace(/,\s/g,",").split(","):y),h=null!=(q=null!=(T=null!=(R=t._exclude)?R:t.exclude)?T:t._excludes)?q:t.excludes)for(null==N._source&&(N._source={}),N._source.excludes="string"==typeof h?h.replace(/,\s/g,",").split(","):h,A=0,_=(M=null!=(W=null!=(U=N._source)?U.includes:void 0)?W:[]).length;A<_;A++)f=M[A],N._source.excludes=N._source.excludes.filter((function(e){return e!==f}));for(le=0,x=(B=["filter","restrict","must","and","must_not","not","should","or"]).length;le<x;le++)if(null!=t[ue=B[le]])for(j=Array.isArray(t[ue])?t[ue]:[t[ue]],delete t[ue],c="filter"===ue||"restrict"===ue||"must"===ue||"and"===ue?"filter":"must_not"===ue||"not"===ue?"must_not":"should",null==(o=N.query.bool)[c]&&(o[c]=[]),ce=0,O=j.length;ce<O;ce++)"object"==typeof(re=j[ce])?1===(ie=this.keys(re)).length&&"object"!=typeof re[ie[0]]&&(re={term:re}):re={query_string:{query:re}},N.query.bool[c].push(re);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==N.aggregations&&(N.aggregations={}),pe=0,k=(z=t.terms).length;pe<k;pe++)oe=z[pe],N.aggregations[oe]={terms:{field:oe+(oe.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(de=0,S=(F=["aggs","aggregations"]).length;de<S;de++)if(null!=t[i=F[de]]){for(p in null==N[i]&&(N[i]={}),t[i])N[i][p]=t[i][p];delete t[i]}for(g in t){if(he=t[g],("from"===g||"size"===g)&&"number"!=typeof he)try{he=parseInt(he),isNaN(he)&&(he=void 0)}catch(e){}null!=he&&"apikey"!==g&&"_"!==g&&"callback"!==g&&"refresh"!==g&&"key"!==g&&"counts"!==g&&"index"!==g&&"search"!==g&&"source"!==g&&"q"!==g&&"_alias"!==g&&"include"!==(J=g.replace("_","").replace("s",""))&&"exclude"!==J&&(N[g]=he)}try{for(r in E={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},N.aggregations)"string"==typeof(null!=(X=N.aggregations[r].terms)?X.order:void 0)&&null!=E[N.aggregations[r].terms.order]&&(N.aggregations[r].terms.order=E[N.aggregations[r].terms.order])}catch(e){}if(null!=(null!=(V=N.query)?V.bool:void 0))for(u in N.query.bool)for(s in N.query.bool[u])"string"==typeof(null!=(G=N.query.bool[u][s].query_string)?G.query:void 0)&&-1!==N.query.bool[u][s].query_string.query.indexOf("/")&&-1===N.query.bool[u][s].query_string.query.indexOf('"')&&(N.query.bool[u][s].query_string.query='"'+N.query.bool[u][s].query_string.query+'"');return null!=N._source&&null!=N.fields&&delete N._source,N},t.index.translate._auth=!1,t.index._send=async function(e,i,s,n,a){var l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x;if(e.includes("?")?([e,w]=e.split("?"),w="?"+w):w="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,"")),null==s&&(s=""===i?"DELETE":null==i||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=i||"_refresh"===(c=e.split("/").pop().split("?")[0])||"_aliases"===c?"POST":"GET":"PUT"),"DELETE"===s&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(e.startsWith("_")||(_=e.split("/")[0],l=await this.dot(t,_.replace(/_/g,".")),null==a&&(a=null!=(h=null!=(p=this.params._alias)?p:null!=(d=this.S.alias)?d[_.startsWith(this.S.index.name+"_")?_.replace(this.S.index.name+"_",""):_]:void 0)?h:null!=l?l._alias:void 0),"string"==typeof a&&(a.startsWith("_")||(a="_"+a),a=a.replace(/\//g,"_"),_.endsWith(a)||(e=e.replace(_,_+a))),null==n&&(n=null!=(f=null!=l?l._prefix:void 0)?f:this.S.index.name),!0===n&&(n=this.S.index.name),"string"==typeof n&&(n.length&&!n.endsWith("_")&&(n+="_"),e.startsWith(n)||(e=n+e))),x=(null!=this&&null!=(y=this.S)&&null!=(m=y.index)?m.url:void 0)?this.S.index.url:null!=(g=r.index)?g.url:void 0,Array.isArray(x)&&(x=x[Math.floor(Math.random()*x.length)]),"string"!=typeof x)return;e=x+"/"+e}if(e.startsWith("http")){if(u=!1,e.includes("/_search")&&"object"==typeof i&&(null!=i.scroll_id||i.scroll)&&(!0===i.scroll&&(i.scroll="2m"),("number"==typeof i.scroll||"string"==typeof i.scroll&&!i.scroll.endsWith("m"))&&(i.scroll+="m"),e+=(-1===e.indexOf("?")?"?":"&")+"scroll="+(null!=(v=i.scroll)?v:"2m"),i.scroll_id?(u=i.scroll_id,e=e.split("://")[0]+"://"+e.split("://")[1].split("/")[0]+"/_search/scroll"+(e.includes("?")?"?"+e.split("?")[1]:""),e+=(-1===e.indexOf("?")?"?":"&")+"scroll_id="+i.scroll_id,i=void 0):(delete i.scroll_id,delete i.scroll)),o=-1!==(e=e+=w).indexOf("/_bulk")||"object"==typeof i&&"object"==typeof i.headers?i:{body:i},-1===e.indexOf("/_search")||"GET"!==s&&"POST"!==s||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),e.includes("/_doc/")&&e.split("/_doc/")[1].includes("%")&&(e=e.split("/_doc/")[0]+"/_doc/"+encodeURIComponent(e.split("/_doc/")[1])),o.method=s,!(null==(b=await this.fetch(e,o))||"object"==typeof b&&"number"==typeof b.status&&b.status>=400&&b.status<=600)){if(this.S.dev&&"object"==typeof b&&null!=b.hits){try{null!=(null!=i?i.query:void 0)&&(b.q=i)}catch(e){}try{a&&(b._alias=a)}catch(e){}}return(null!=b?b._scroll_id:void 0)&&(b._scroll_id=b._scroll_id.replace(/==$/,"")),u&&u!==(null!=b?b._scroll_id:void 0)&&await this.index._send("/_search/scroll?scroll_id="+u,""),b}}else j.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!i.g[r.kv]&&(i.g[r.kv]={},i.g[r.kv].get=function(e){return t.fetch(r.kv+"/"+e)},i.g[r.kv].getWithMetadata=async function(e){return{value:await t.fetch(r.kv+"/"+e),metadata:{}}},i.g[r.kv].put=function(e,i){return t.fetch(r.kv+"/"+e,{body:i})},i.g[r.kv].delete=function(e){return t.fetch(r.kv+"/"+e,{method:"DELETE"})},i.g[r.kv].list=function(e){return null==e&&(e={}),t.fetch(r.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),t.kv=async function(e,t,r,s,n){var a,l,o,u,c,h,p,d,f,y,m,g,v,b;if(null==e&&(e=null!=(p=null!=(d=this.params.kv)?d:this.params.key)?p:this.parts.join("_"),null==t)){if("DELETE"===this.request.method)t="";else if(this.body)t=this.body;else if(this.params.val)t=this.params.val;else{for(t=this.params,a=0,u=(f=["key","kv","refresh","apikey"]).length;a<u;a++)delete t[o=f[a]];for(l=0,c=(y=this.parts).length;l<c;l++)delete t[o=y[l]]}"string"!=typeof t||0!==t.indexOf("[")&&0!==t.indexOf("{")||(t=JSON.parse(t)),"{}"!==(m=JSON.stringify(t))&&"[]"!==m||(t=void 0)}if("object"!=typeof t||"{}"!==(g=JSON.stringify(t))&&"[]"!==g||(t=void 0),"object"==typeof e&&null==t&&(e=null!=(v=(t=e)._id)?v:await this.uid()),null!=e&&this.S.kv&&i.g[this.S.kv]){if(null!=t&&""!==t){if(h={metadata:s},"number"==typeof r&&(1e3*r>Date.now()?h.expiration=r:h.expirationTtl=r),"object"==typeof t&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(o in r)null==t[o]&&(t[o]=r[o]);return this.waitUntil(i.g[this.S.kv].put(e,"object"==typeof t?JSON.stringify(t):t,h)),t}if(({value:b,metadata:s}=await i.g[this.S.kv].getWithMetadata(e,n)),null!=b){try{b=JSON.parse(b)}catch(e){}try{s=JSON.parse(s)}catch(e){}return""===t&&this.waitUntil(i.g[this.S.kv].delete(e)),!0===s?{value:b,metadata:s}:b}}},t.kv._auths="system",t.kv._caches=!1,t.kv.list=async function(e,t){var r,s;try{null==e&&(e=null!=(r=null!=(s=this.params.kv)?s:this.params.prefix)?r:this.params.list)}catch(e){}try{null==t&&(t=this.params.cursor)}catch(e){}return await i.g[this.S.kv].list({prefix:e,cursor:t})},t.kv.count=async function(e){var t,r,s,n,a,l,o,u,c;if(r=0,this.S.kv&&null!=i.g[this.S.kv])for(null==e&&(e=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),t=!1,s=void 0;!t;){for(s=(l=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,a=(c=l.keys).length;n<a;n++)c[n],r+=1;t=l.list_complete}return r},t.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},t.kv.clear=function(e){var t;if(this.S.dev)return null==e&&(e=null!=(t=this.params.clear)?t:this.params.kv),this.waitUntil(this.kv._each(e,(function(e){return this.waitUntil(i.g[this.S.kv].delete(e))}))),!0},t.kv.delete=async function(e){var t,i,r,s;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(r=this.params.kv)?r:this.params.delete)?i:this.params.prefix),s=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&j.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return s}},t.kv.delete._bg=!0,t.kv._each=async function(e,t){var r,s,n,a,l,o,u,c;if(this.S.kv&&null!=i.g[this.S.kv]){for("function"==typeof e&&null==t&&(t=e,e=void 0),r=!1,s=void 0,c=[];!r;){for(s=(o=await i.g[this.S.kv].list({prefix:e,cursor:s})).cursor,n=0,l=(u=o.keys).length;n<l;n++)a=u[n],"function"==typeof t?this.waitUntil(t.call(this,a.name)):""===t?this.waitUntil(i.g[this.S.kv].delete(a.name)):null!=t&&this.waitUntil(this.kv(a.name,t));c.push(r=o.list_complete)}return c}},null==r.log&&(r.log={}),O=[],k=!1,x=!1,t.log=function(e,t){var i,s,n,a,l,o,u,c,h,p;if(i=async()=>{var e,t;for(!1!==k&&clearTimeout(k),k=setTimeout(i,3e4),x=Date.now(),t=new Date(x).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&O.length;)e.push(O.shift());return e.length?(!0===this.S.bg&&j.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]):!0===this.S.bg?j.log("Checked log batch but none to save",t):void 0},!1!==this.S.log){if(!0!==t&&(t=null==e),!0!==t&&(this._logs.length>3e4||O.length>3e4)&&(t=!0),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,l=e.length;s<l;s++)a=e[s],this._logs.push(a);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return O.push(this.body),!1===k&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(u in e.params={},this.params)e.params[u]="string"==typeof this.params[u]?this.params[u]:JSON.stringify(this.params[u])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(c=this.user)?c._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(n=0,o=(h=this._logs).length;n<o;n++)(a=h[n]).alert&&null==e.alert&&(e.alert=a.alert),a.notify&&null==e.notify&&(e.notify=a.notify),e.logs.push(a);e.createdAt=new Date,null==e.name&&(e.name=r.name),null==e.version&&(e.version=r.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(p=this.S.index)?p.url:void 0))!0===this.S.bg?(O.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||O.length>300||!1===x||Date.now()>x+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(O.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){j.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&j.log("NOT logging",e);return!0},t.logs={_index:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(e){r.mail={}}t.mail=async function(e){var i,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,A;if(null!=(h=r.mail)?h.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(p=this.copy(null!=this?this.params:void 0))?p:{}),e.template){for(o in u=await this.template(e.template,null!=(v=null!=(b=e.vars)?b:e.params)?v:e))e[o]=u[o];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(w=null!=(_=null!=(x=null!=(O=e.content)?O:e.msg)?x:e.body)?_:this.body)?w:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}if(delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),l=(e.svc||e.service)&&null!=(null!=(k=this.S.svc[null!=(S=e.svc)?S:e.service])?k.mail:void 0)?this.S.svc[null!=(d=e.svc)?d:e.service].mail:null!=(f=null!=this&&null!=(y=this.S)?y.mail:void 0)?f:r.mail,null==e.from&&(e.from=l.from),null==e.to&&(e.to=l.to),delete e.svc,A="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),e.to){for(i=null!=(m=null!=this?this.fetch:void 0)?m:t.fetch,c={method:"POST",auth:"api:"+l.apikey},n=0,a=(g=["file","files","attachment","attachments"]).length;n<a;n++)null!=e[s=g[n]]&&(c[s]=e[s],delete e[s]);return c.form=e,await i(A,c)}return j.log(e),j.log("NO ADDRESS TO EMAIL TO"),{}},t.mail._auth="system",t.mail.validate=async function(e,t){var i,r,s,n,a;if(null==e&&(e=null!=this&&null!=(s=this.params)?s.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(n=(a=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?n:a.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(r=i[1].split(".")).length>1&&(2!==r.length||"example"!==r[0]))return!0}return!1},I=[].indexOf,t.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},t.copy._log=!1,t.dot=function(e,i,r,s,n){var a,l,o;return"string"==typeof i?t.dot(e,i.split("."),r,s,n):1!==i.length||null==r&&null==s?0===i.length?e:null==e[i[0]]?null!=r?(e[i[0]]="number"!=typeof i[0]&&isNaN(parseInt(i[0]))?{}:[],t.dot(e[i[0]],i.slice(1),r,s,n)):n&&Array.isArray(e)&&e.length&&(o=e[e.length-1]&&"object"==typeof o&&null!=o[i[0]])?t.dot(o[i[0]],i.slice(1),r,s,n):void 0:n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))&&e.length&&"object"==typeof e[e.length-1]?(null!=r&&null==(a=e[e.length-1])[l=i[0]]&&(a[l]={}),t.dot(e[e.length-1][i[0]],i.slice(1),r,s,n)):t.dot(e[i[0]],i.slice(1),r,s,n):null!=s?(e instanceof Array?e.splice(i[0],1):delete e[i[0]],!0):(n&&Array.isArray(e)&&"number"!=typeof i[0]&&isNaN(parseInt(i[0]))?(e.length||(e=[{}]),e[e.length-1][i[0]]=r):e[i[0]]=r,!0)},t.dot._log=!1,t.flatten=async function(e,t){var i,r,s,n,a,l,o;if(null==t&&(t=null!=(a=this.params.arrayed)&&a),null==e&&delete(e=this.params).arrayed,l={},i=async function(e,r){var s,n,a,o,u,c,h;for(a in c=[],e){n=!1;try{n=!isNaN(parseInt(a))}catch(e){}u=n&&!t?r:r?r+"."+a:a,"object"!=typeof(h=e[a])?null!=l[u]?(Array.isArray(l[u])||(l[u]=[l[u]]),c.push(l[u].push(h))):c.push(l[u]=h):Array.isArray(h)?"object"==typeof h[0]?c.push(await async function(){var e;for(o in e=[],h)e.push(await i(h[o],u+(t?"."+o:"")));return e}()):(null==l[u]&&(l[u]=[]),Array.isArray(l[u])||(l[u]=[l[u]]),c.push(function(){var e,t,i;for(i=[],e=0,t=h.length;e<t;e++)s=h[e],i.push(l[u].push(s));return i}())):c.push(await i(h,u))}return c},Array.isArray(e)){for(o=[],s=0,n=data.length;s<n;s++)r=data[s],l={},o.push(await i(r));return o}return await i(e),l},t.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&I.call(i,t)<0&&i.push(t);return i},t.pings={_index:!0},t.ping=async function(){var e,t,i;return e=this.copy(this.params),"{}"!==JSON.stringify(e)&&(e.ip=null!=(t=null!=(i=this.headers["x-forwarded-for"])?i:this.headers["cf-connecting-ip"])?t:this.headers["x-real-ip"],e.forwarded=this.headers["x-forwarded-for"],await this.pings(e),!0)},t.scrape=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w,_,x,O,k,S,j,A,I,E,D;if(null==e&&(e=null!=(k=null!=(S=this.params.scrape)?S:this.params.content)?k:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(D=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&D.length>1&&9<D[1].length&&D[1].length<45&&-1!==D[1].indexOf("/")&&0===D[1].indexOf("10.")&&(f.doi=D[1]),e=await this.fetch(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{for(r=0,j=e.split(" "),n=0,o=j.length;n<o;n++)if(E=j[n],(r+=1)<600&&(-1!==(E=E.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(E=E.split("doi.org")[1]),0===E.indexOf("/")&&(E=E.replace("/","")),0===(E=E.trim()).indexOf("10.")&&-1!==E.indexOf("/"))){f.doi=E;break}}catch(e){}if(!f.doi)try{for(A=(s=await this.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=A.length;l<u;l++)w=A[l],!f.doi&&9<s.matches[w].result[1].length&&s.matches[w].result[1].length<45&&(f.doi=s.matches[w].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),!f.title)try{-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))}catch(e){}if(f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(y=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=y[0];else for(_=0,c=y.length;_<c;_++)(b=y[_]).length>2&&(f.year=b)}catch(e){}if(!f.keywords)try{-1!==(a=(await this.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(a=a.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=a.split(";")):(a=a.replace(/, /g,",").replace(/ ,/g,","),f.keywords=a.split(","))}catch(e){}if(!f.email){m=[];try{for(I=(await this.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=I.length;x<h;x++)(g=I[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===m.indexOf(g)&&m.push(g)}catch(e){}for(m.sort((function(e,t){return t.length-e.length})),v="",O=0,p=m.length;O<p;O++)d=m[O],null==f.email&&(f.email=[]),-1===v.indexOf(d)&&f.email.push(d),v+=d}return f},t.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise((t=>setTimeout(t,null!=e?e:1e3)))},t.sleep._auth="root",t.sleep._log=!1,I=[].indexOf,t.template=async function(e,t){var i,r,s,n,a,l,o,u,c,h,p,d,f,y,m,g,v,b,w;if(null==e&&(e=null!=(f=null!=(y=this.params.content)?y:this.params.template)?f:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(m=this.params.url)?m:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{r=await this.templates(e),e=r.content}catch(e){}if(v={},(i=function(t,r=""){var s,n,a,l;for(s in a=[],t)n=r?r+"."+s:s,"object"!=typeof t[s]||Array.isArray(t[s])?-1!==e.toLowerCase().indexOf("{{"+n+"}}")?(l=new RegExp("{{"+n+"}}","gi"),a.push(e=e.replace(l,Array.isArray(t[s])?t[s].join(", "):"string"==typeof t[s]?t[s]:!0===t[s]?"Yes":!1===t[s]?"No":""))):a.push(void 0):a.push(i(t[s],r+(""===r?"":".")+s));return a})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(w=["subject","from","to","cc","bcc"],s=0,h=(g=e.toLowerCase().split("{{")).length;s<h;s++)d=g[s].split("{{")[0].split("}}")[0].split(" ")[0],I.call(w,d)<0&&w.push(d);for(n=0,p=w.length;n<p;n++)a=w[n],(l=-1!==e.toLowerCase().indexOf("{{"+a)?a:void 0)&&(o=-1!==e.indexOf("{{"+l.toUpperCase())?l.toUpperCase():l,(b=e.split("{{"+o)[1]).split("}}")[0].indexOf("{{")&&(b=b.replace(u,"")),(b=b.split("}}")[0].trim())&&(v[l]=b),c=new RegExp("{{"+o+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),v.content=e,v},t.templates={_key:"name",_sheet:"1Xg-dBpCkVWglditd6gESYRgMtve4CAImXe-321ra2fo/Templates"},t.levenshtein=function(e,t,i){var r,s,n,a,l,o,u,c,h,p,d,f,y;for(null==e&&(e=null!=this&&null!=(p=this.params)?p.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(y=this.params)?y.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(l=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=l,l=u,u=c),h=[[]],r=0;r<u+1;)h[0][r]=r,r++;for(n=1;n<l+1;){for(h[n]=[n],a=1;a<u+1;)s=e.charAt(n-1)===t.charAt(a-1)?0:1,h[n][a]=o(h[n-1][a]+1,h[n][a-1]+1,h[n-1][a-1]+s),a++;n++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:l,b:u}}},t.extract=async function(e){var t,i,r,s,n,a,l,o,u,c,h;if(null==e&&(e=this.copy(this.params)),e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.fetch(e.url)),e.convert)try{h=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==h&&(h=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(l=h.split(e.start),h=l.length>1?l[1]:l[0]),null!=e.end&&(h=h.split(e.end)[0]),e.lowercase&&(h=h.toLowerCase()),e.ascii&&(h=h.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(h=h.replace(/ /g,"")),c={length:h.length,matched:0,matches:[],matchers:e.matchers,text:h},h&&"number"!=typeof h)for(t=0,r=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<r;t++){"string"==typeof(n=u[t])?(a="",0===n.indexOf("/")?(i=n.lastIndexOf("/"))+1!==n.length&&(a=n.substring(i+1),n=n.substring(1,i)):n=n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):a="",e.lowercase&&(a+="i");try{(s=new RegExp(n,a).exec(h))&&(c.matched+=1,c.matches.push({matched:n.toString(),result:s}))}catch(e){}}return c},t.decode=async function(e){var t,i,r,s,n,a,l,o,u,c,h,p,d;for(null==e&&(e=null!=(a=null!=(l=null!=(o=null!=this&&null!=(u=this.params)?u.decode:void 0)?o:null!=this&&null!=(c=this.params)?c.content:void 0)?l:null!=this&&null!=(h=this.params)?h.text:void 0)?a:null!=this?this.body:void 0),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(x?[0-9A-Fa-f]+);/gi,(function(e,t){var i;return i=t.startsWith("x")?parseInt(t.replace("x",""),16):parseInt(t,10),String.fromCharCode(i)}))},d=(d=await t(e)).replace(/\n/g," "),r=0,s=(p=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<s;r++)i=p[r],n=new RegExp(i.bad,"g"),d=d.replace(n,i.good);try{-1!==d.indexOf("%2")&&(d=decodeURIComponent(d))}catch(e){}try{-1!==d.indexOf("%2")&&(d=decodeURIComponent(d))}catch(e){}return d},r.built="Tue Nov 28 2023 10:46:33 GMT+0000",t.convert.doc2txt={_bg:!0},t.convert.docx2txt={_bg:!0},t.convert.pdf2txt={_bg:!0}})()})();