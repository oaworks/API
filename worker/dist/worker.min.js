!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));let r=e=>crypto.getRandomValues(new Uint8Array(e)),n=(e,t)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,n=-~(1.6*r*t/e.length);return()=>{let s="";for(;;){let l=i(n),o=n;for(;o--;)if(s+=e[l[o]&r]||"",s.length===t)return s}}})(e,t,r)},function(e,t,i){"use strict";i.r(t),function(e,t){var r,n,s=i(1);try{n=JSON.parse(SECRETS_SETTINGS)}catch(e){}null==n&&(n={}),null==n.name&&(n.name="N2"),null==n.version&&(n.version="5.2.6"),null==n.env&&(n.env="dev"),null==n.dev&&(n.dev="dev"===n.env),null==n.headers&&(n.headers={}),null==n.svc&&(n.svc={}),null==n.src&&(n.src={});try{addEventListener("fetch",(function(e){return e.respondWith(r.call(e))}))}catch(e){}(r=async function(){var e,t,i,s,l,o,a,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L,C,I,P;this.started=Date.now();try{n.dev&&!0!==n.bg&&console.log(n.version)}catch(e){}try{null==(o=n.headers)[g="X-"+n.name]&&(o[g]=(n.version?"v"+n.version:"")+(n.env?" "+n.env:"")+(n.built?" built "+n.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(n)),this.params={},null!=this.request.url&&-1!==this.request.url.indexOf("?"))for(c=0,m=(w=this.request.url.split("?")[1].split("&")).length;c<m;c++)if(d=(_=w[c]).split("="),this.params[d[0]]=1===d.length||("string"==typeof d[1]&&"true"===d[1].toLowerCase()||("string"!=typeof d[1]||"false"!==d[1].toLowerCase())&&(!!_.endsWith("=")||d[1])),"string"!=typeof this.params[d[0]]||0!==this.params[d[0]].replace(/[0-9]/g,"").length||this.params[d[0]].startsWith("0")||(f=parseInt(this.params[d[0]]),isNaN(f)||(this.params[d[0]]=f)),"string"==typeof this.params[d[0]]&&(this.params[d[0]].startsWith("[")||this.params[d[0]].startsWith("{")))try{this.params[d[0]]=JSON.parse(this.params[d[0]])}catch(e){}try{if((this.request.body.startsWith("{")||this.request.body.startsWith("["))&&(this.body=JSON.parse(this.request.body)),"object"==typeof this.body&&!Array.isArray(this.body))for(_ in this.body)null==(a=this.params)[_]&&(a[_]=this.body[_])}catch(e){}try{null==this.body&&(this.body=this.request.body)}catch(e){}this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh);try{for(this.headers={},x=[...this.request.headers],p=0,y=x.length;p<y;p++)h=x[p],this.headers[h[0]]=h[1]}catch(e){this.headers=this.request.headers,"function"!=typeof this.waitUntil&&(this.waitUntil=function(e){return console.log("waitUntil"),!0})}try{this.rid=this.headers["cf-ray"].slice(0,-4)}catch(e){}try{this.id=null!=(S=null!=(A=null!=(j=null!=(E=this.headers["x-id"])?E:this.headers.id)?j:this.headers._id)?A:this.params._id)?S:this.params.id}catch(e){}try{this.apikey=null!=(R=null!=(T=null!=(L=this.headers["x-apikey"])?L:this.headers.apikey)?T:this.params.apikey)?R:this.params.apiKey}catch(e){}this.params.apikey&&delete this.params.apikey;try{this.cookie=this.headers.cookie}catch(e){}if(-1===this.request.url.indexOf("://")?(this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,""),this.parts=this.url.length?this.url.split("/"):[]):(this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1],this.parts=this.url.split("/"),this.base=this.parts.shift()),this.route=this.parts.join("/"),this._logs=[],""===this.route)return r._response.call(this,"HEAD"===(C=this.request.method)||"OPTIONS"===C?"":{name:this.S.name,version:this.S.version,env:this.S.env,built:this.S.dev?this.S.built:void 0});if(this.routes={},this.fn="",s=async(e,t,i)=>{if(i._kv&&this.kv(e,t,"number"==typeof i._kv?i._kv:void 0),i._index&&(!1===i._kv||!1===this.S.kv||!0===this.S.index.immediate)&&!await this.index(e,t))return await this.index(e.split("/")[0],"object"!=typeof i._index?{}:{settings:i._index.settings,mappings:i._index.mappings,aliases:i._index.aliases})?this.index(e,t):this.log({fn:t.split("/")[0].replace(/\_/g,"."),msg:"Could not save/create index",level:"error"})},i=(e,t)=>{var i;return e._sheet&&null==e._index&&(e._index=!0),(i=e._index||e._kv||e._bg&&!0!==this.S.bg)||"object"!=typeof e||Array.isArray(e)||"function"==typeof e[this.request.method]?i||e._kv||"function"==typeof e?!i&&!e._kv&&-1===t.indexOf(".")||0===t.split(".").pop().indexOf("_")?e.bind(this):async function(){var i,r,l,o,a,u,h,c,p,d,f;if(f=Date.now(),d=t.replace(/\./g,"_"),l=!1,o=!1,!1,e._bg&&!0!==this.S.bg||!e._index||!(this.fn===t&&this.index._q(this.params)||this.fn!==t&&1===arguments.length&&this.index._q(arguments[0])||2===arguments.length&&this.index._q(arguments[1]))||(p=this.index(2===arguments.length&&null!=(u=arguments[0])?u:d,2===arguments.length||1===arguments.length?arguments[1]:this.params)),null!=p||this.refresh||"GET"!==this.request.method&&this.fn===t||this.fn!==t&&1!==arguments.length||!e._kv&&!e._index||(e._kv&&null!=(p=await this.kv(arguments.length?d+"/"+arguments[0].replace(/\//g,"_").replace(d+"_",""):void 0))&&(l="kv"),e._index&&null==p&&null!=(p=await this.index(arguments.length?d+"/"+arguments[0].replace(/\//g,"_").replace(d+"_",""):void 0))&&(l="index")),l&&this.fn.startsWith(t)&&(this.cached=l),null==p&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&0===this.S.bg.indexOf("http")){i=this.S.bg+"/"+t.replace(/\./g,"/")+(arguments.length&&"string"==typeof arguments[0]?arguments[0]:""),r=arguments.length&&"object"==typeof arguments[0]?{method:"POST",body:arguments[0]}:t===e?{method:"POST",body:this.params}:{},this.S.name&&this.S.system&&(r.headers={},r.headers["x-"+n.name+"-system"]=this.S.system);try{p=await this.fetch(i,r),!0}catch(e){}}if(null==p)if("function"==typeof e&&(p=await(null!=(h=e[this.request.method])?h:e).apply(this,arguments)),null==p&&e._sheet&&(p=await this.src.google.sheets(e._sheet)),null!=p){if(e._kv||e._index){try{o=null!=(c=p[e._key])?c:p._id,0!==(o=(o=Array.isArray(o)?o[0]:"string"!=typeof o?void 0:o).replace(/\//g,"_").replace(d+"_",d+"/")).indexOf(d)&&(o=d+"/"+o)}catch(e){}!1===o&&(o=d+"/"+this.uid()),o=o.toLowerCase(),this.waitUntil(s(o,p,this.copy(e)))}}else arguments.length&&arguments[0]!==d||(e._index?p=await this.index(...arguments):e._kv&&(p=""));if(a={fn:t,cached:l||void 0,bg:bg||void 0,key:o||(l&&arguments.length?arguments[0].toLowerCase():void 0)},e._index||e._kv){try{arguments.length&&(a.args=JSON.stringify([...arguments]))}catch(e){}try{a.result=null!=p}catch(e){}}try{a.took=Date.now()-f}catch(e){}return this.log(a),p}.bind(this):e:JSON.parse(JSON.stringify(e))},u=void 0,b=[...this.parts],v=void 0,(e=(t,r,n)=>{var s,l,o,a,h;for(s in h=!1,(""===n||v&&("."+n).endsWith("."+v+"."))&&b.length&&("function"==(l=typeof t[b[0]])||"object"===l?(this.fn+=(""===this.fn?"":".")+b[0],h=v=b.shift()):v&&(this.params[v]=this.params[v]?this.params[v]+"/"+b[0]:b[0],b.shift())),a=[],t)r[s]=i(t[s],n+s),"function"==(o=typeof r[s])||"object"===o?("function"==typeof r[s]&&(s.startsWith("_")||(s===h&&-1===n.indexOf("._")&&(u=r[s]),this.routes[n+s]="")),Array.isArray(t[s])||s.startsWith("_")&&"function"!=typeof t[s]?a.push(void 0):a.push(e(t[s],r[s],n+s+"."))):a.push(void 0);return a})(r,this,""),v&&b.length&&(this.params[v]=this.params[v]?this.params[v]+"/"+b.join("/"):b.join("/")),I=void 0,"function"==typeof u)if(this.S.name&&this.S.system&&this.headers["x-"+n.name+"-system"]===this.S.system?l=!0:("object"==typeof(l=this.auth())&&l._id&&l.email&&(this.user=l),l="function"==typeof u._auth?await u._auth():!0===u._auth&&null!=this.user||(!u._auth||await this.auth.role(u._auth))),l)if("HEAD"===(O=this.request.method)||"OPTIONS"===O)I="";else{if(!1!==u._cache&&!this.refresh&&"GET"===this.request.method&&(I=await this._cache()))return this.cached="cache",(P=new Response(I.body,I)).headers.append("x-"+this.S.name+"-cached","cache"),P.headers.delete("x-"+this.S.name+"-took"),this.log(),P;!0===this.S.bg?(I=await u(),this.completed=!0):(t=async()=>(I=await u(),this.completed=!0),await Promise.race([t(),this.sleep(14500)]),this.completed||(I={status:408}))}else await this.sleep(200*(1+Math.random())),I={status:401};return this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("/favicon")&&null==I&&(I=""),P=await this._response(I),this.parts.length&&"log"!==(k=this.parts[0])&&"status"!==k&&"HEAD"!==(q=this.request.method)&&"OPTIONS"!==q&&null!=I&&""!==I&&(null!=u&&!1!==u._cache&&this.completed&&200===P.status&&this._cache(void 0,P,u._cache),this.log()),P})._response=function(t){var i,r,n,s,l,o;if(null==(i=this.S).headers&&(i.headers={}),null==t)t=404,o=404;else if("status"!==this.fn&&"object"==typeof t&&!Array.isArray(t)&&("number"==typeof t.status&&t.status>300&&t.status<600||t.headers)){if(null!=t.headers){for(n in t.headers)this.S.headers[n]=t.headers[n];delete t.headers}o=null!=(l=t.status)?l:200,delete t.status,0===(s=this.keys(t)).length?t=o:1===s.length&&(t=t[s[0]])}else o=200;if(null==this.S.headers["Content-Type"]){try{t=JSON.stringify(t,"",2)}catch(e){}this.S.headers["Content-Type"]="application/json; charset=UTF-8"}try{null==(r=this.S.headers)["Content-Length"]&&(r["Content-Length"]=e.byteLength(t))}catch(e){}try{this.S.headers["x-"+this.S.name+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name+"-cached"]=this.cached)}catch(e){}try{return new Response(t,{status:o,headers:this.S.headers})}catch(e){return{status:o,headers:this.S.headers,body:t}}},r.src={},r.svc={};var l,o,a=[].indexOf;r.auth=async function(e,t){var i,r,s,l,o,a,u,h,c,p,d,f;try{if(this.S.name&&this.S.system&&this.headers["x-"+n.name+"-system"]===this.S.system)return!0}catch(e){}if("string"==typeof e)return await this.kv("user/"+e);if((null==this.params.access_token||!(f=await this.oauth()))&&(this.params.token&&(r=await this.kv("auth/token/"+this.params.token,""))&&((p=await this.kv("user/email/"+r))&&(f=await this.kv("user/"+p)),null==f&&(f=await this.auth._insert(r))),!f&&this.apikey&&(p=await this.kv("user/apikey/"+this.apikey))&&(f=await this.kv("user/"+p)),!f&&(null!=this.params.resume||this.cookie))){if((p=this.id)||null==this.params.email||(p=await this.kv("user/email/"+this.params.email)),!(c=this.params.resume))try{c=(i=JSON.parse(decodeURIComponent(this.cookie).split((null!=(s=null!=(l=null!=(o=n.auth)&&null!=(a=o.cookie)?a.name:void 0)?l:n.name)?s:"n2")+"=")[1].split(";")[0])).resume,p=i.id}catch(e){}null!=c&&null!=p&&await this.kv("auth/resume/"+p+"/"+c,this.params.resume?"":void 0)&&(f=await this.kv("user/"+p))}return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(u=f.roles)?u[this.params.service]:void 0)&&((d={}).roles=null!=(h=f.roles)?h:{},d.roles[this.params.service]="user",this.kv("user/"+f._id,d,f)),null==this.params.resume&&null==this.params.token||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,Date.now(),789e4))),f},r.auth.token=async function(e,t,i,r,s,l,o){var a,u,h,c,p,d,f,m;return null==e&&(e=null!=(a=this.params.email)?a:""),null==t&&(t=null!=(u=null!=(h=n.auth)?h.from:void 0)?u:"nobody@example.com"),null==i&&(i=null!=(c=null!=(p=n.auth)?p.subject:void 0)?c:"Please complete your login"),m=this.uid(8),null==o&&(o=(null!=(d=null!=(f=this.params.url)?f:this.request.url)?d:"https://example.com").split("?")[0].replace("/token","")+"?token="+m),this.kv("auth/token/"+m,e,900),t&&e?await this.mail.send({from:t,to:e,subject:i,text:null!=r?r:"Your login code is:\r\n\r\n{{TOKEN}}\r\n\r\nor use this link:\r\n\r\n{{URL}}\r\n\r\nnote: this single-use code is only valid for 15 minutes.",html:null!=s?s:'<html><body><p>Your login code is:</p><p><b>{{TOKEN}}</b></p><p>or click on this link</p><p><a href="{{URL}}">{{URL}}</a></p><p>note: this single-use code is only valid for 15 minutes.</p></body></html>',params:{token:m,url:o}}):m},r.auth.role=function(e,t){var i,r,n,s,l,o,u,h,c,p,d,f,m,y,g,v;if(null==e&&(e=this.params.role),null==e&&"string"==typeof(null!=(h=this.opts)?h.auth:void 0)&&(e=this.opts.auth),null==t&&(t=this.user),"string"==typeof e&&-1!==e.indexOf("/")&&null==t&&(t=e.split("/").pop(),e=e.replace("/"+t,"")),null==(null!=(v=null!=t&&t!==(null!=(c=this.user)?c._id:void 0)?this.user(t):this.user)?v.roles:void 0))return!1;for("string"==typeof e&&(e=[e]),s=0,o=e.length;s<o;s++){if(r=(r=e[s]).replace("/","."),[n,g]=r.split("."),null==g&&(g=n,n="__global__"),n===v.id)return"owner";if(a.call(null!=(p=v.roles.__global__)?p:[],"root")>=0)return"root";if(a.call(null!=(d=v.roles[n])?d:[],g)>=0)return g;if(null!=v.roles[n]&&0<(m=(i=["root","service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public"]).indexOf(g)))for(l=0,u=(f=i.splice(0,m)).length;l<u;l++)if(y=f[l],a.call(v.roles[n],y)>=0)return y}return!1},r.auth.roles=async function(e,t,i){var r,n,s,l,o,u;return null==e&&(e=null!=(s=this.user)?s:this.params.roles),"string"==typeof e&&(e=await this.kv("user/"+e)),[n,u]=t.split("."),null==u&&(u=n,n="__global__"),null==(l=a.call(null!=(o=e.roles)?o[n]:void 0,u)>=0)||l?null!=i?(e.roles[n].splice(e.roles[n].indexOf(u),1),this.kv("user/"+e._id,e)):void 0:(null==(r=e.roles)[n]&&(r[n]=[]),e.roles.group.push(u),this.kv("user/"+e._id,e))},r.auth.logout=function(e){if(null==e&&(e=this.user),null!=e)return this.kv("auth/resume/"+("string"==typeof e?e:e._id),"")},r.oauth=async function(e,t){var i,r,s,l,o,a,u,h,c,p,d,f,m,y,g,v;if(m={},null==e&&(e=this.params.access_token),e)try{v=await this.http.post("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e),null==t&&(t=null!=(i=null!=(r=n.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=r.google)&&null!=(a=o.oauth)&&null!=(u=a.client)?u.id:void 0)?i:null!=(h=n.use)&&null!=(c=h.google)&&null!=(p=c.oauth)&&null!=(d=p.client)?d.id:void 0),null!=t&&(null!=(s=v.data)?s.aud:void 0)===t&&(f=await this.http.get("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e),(y=await this.kv("user/email/"+f.data.email))&&((g=await this.kv("user/"+y))||(g=await this.auth._insert(f.data.email))),null==g.google&&(m.google={id:f.data.id}),f.data.name?g.name||(m.name=f.data.name):f.data.given_name&&!g.name&&(m.name=f.data.given_name,f.data.family_name&&(m.name+=" "+f.data.family_name)),!g.avatar&&f.data.picture&&(m.avatar=f.data.picture))}catch(e){}return null!=g&&"{}"!==JSON.stringify(m)&&(g=await this.user.update(g.id,m)),g},r.auth._insert=async function(e,t){var i,r,n,s,l;if("string"!=typeof e||null==t)return"string"==typeof e&&-1!==e.indexOf("@")&&-1!==e.indexOf(".")&&(i=e),null==e&&(null!=this&&null!=(n=this.user)?n._id:void 0)&&(e="user/"+this.user._id),-1!==e.indexOf("@")&&(e=await this.kv("user/email/"+e)),null==await this.kv("user/"+e)&&i?(!1,(s={email:i.trim(),apikey:this.uid(),profile:{}}).roles={},s.createdAt=Date.now(),s._id=this.uid(),this.kv("user/apikey/"+apikey,s._id),this.kv("user/email/"+email,s._id),this.kv("user/"+s._id,s),s):void 0;if(""===t){e.startsWith("user/")&&(e=e.replace("user/","")),l=(null!=(r=this.user)?r._id:void 0)===e?this.user:await this.kv("user/"+e);try{this.auth.logout(e)}catch(e){}try{null!=l.apikey&&this.kv("user/apikey/"+l.apikey,"-")}catch(e){}try{null!=l.email&&this.kv("user/email/"+l.email,"-")}catch(e){}return this.kv("user/"+e,"")}},r.auth._update=async function(e,t){var i;if(null==t&&(t=e.auth),e.param&&this.auth(e.param)&&"","{}"!==JSON.stringify(e.params)){for(i in null==t.profile&&(t.profile={}),e.params)t.profile[i]=pr[i];return await this.kv("user/"+t.id,t),!0}return!1},null==n.example&&(n.example={}),n.example.example=3,r.example=function(){var e;e={name:n.name,version:n.version,env:n.env,built:n.built};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}if(n.dev){try{null==e.headers&&(e.headers=this.headers)}catch(e){}try{null==e.request&&(e.request=this.request)}catch(e){}try{null==e.parts&&(e.parts=this.parts)}catch(e){}try{null==e.params&&(e.params=this.params)}catch(e){}try{null==e.opts&&(e.opts=this.opts)}catch(e){}}return e},r.example.restricted=function(){return{hello:this.user._id}},r.example.restricted._auth=!0,r.example.deep=async function(){var e;e={example:"deep",request:this.request,deeper:await this.example.deep.deeper()};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.example.deep.deeper=async function(){var e;e={hello:"deeper"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}try{e.deepest=await this.example.deep.deeper.deepest()}catch(e){}return e},r.example.deep.deeper.deepest=function(){var e;e={hello:"deepest"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.fetch=async function(t,i){var r,n,s,l,o,a,u;"object"==typeof t&&null==i&&(t=(i=t).url);try{null==i&&(i=this.copy(this.params))}catch(e){}for(null==i&&(i={}),!t&&i.url&&(t=i.url,delete i.url),i.username&&i.password&&(i.auth=i.username+":"+i.password,delete i.username,delete i.password),-1!==t.split("//")[1].split("@")[0].indexOf(":")&&(i.auth=t.split("//")[1].split("@")[0],t=t.replace(i.auth+"@","")),i.auth&&(null==i.headers&&(i.headers={}),i.headers.Authorization="Basic "+e.from(i.auth).toString("base64"),delete i.auth),s=0,l=(o=["data","content","json"]).length;s<l;s++)null!=i[n=o[s]]&&(i.body=i[n],delete i[n]);if(null!=i.body&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="object"==typeof i.body?"application/json":"text/plain"),"object"!=(a=typeof i.body)&&"boolean"!==a&&"number"!==a||(i.body=JSON.stringify(i.body))),console.log(t),"string"!=typeof t)return!1;r=async()=>{var e,r,s;i.verbose?(s=!0,delete i.verbose):s=!1;try{-1!==t.indexOf("localhost")&&null==i.agent&&(i.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}return r=await fetch(t,i),console.log(r.status),s?r:(e="string"==typeof(n=r.headers.get("content-type"))&&-1!==n.toLowerCase().indexOf("json")?await r.json():await r.text(),404===r.status?void 0:r.status>=400?(console.log(e),{status:r.status}):e)},u=await r();try{0!==(u=u.trim()).indexOf("[")&&0!==u.indexOf("{")||(u=JSON.parse(u))}catch(e){}return u},null==n.log&&(n.log={}),r.log=function(e){var t,i,r,s,l,o,a,u,h;if(h=null==e,"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(t=0,s=e.length;t<s;t++)r=e[t],this._logs.push(r);e=void 0}if(null==e){1===this.parts.length&&"log"===this.parts[0]&&null==(e="object"==typeof this.body?{logs:this.body}:this.params).fn&&(e.fn=this.params.log),null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method,body:this.request.bodyUsed}}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers={ip:this.headers["x-real-ip"],"user-agent":this.headers["user-agent"],referer:this.headers.referer}}catch(e){}try{null==e.fn&&(e.fn=this.fn),e.params=this.params,e.refresh=this.refresh,e.parts=this.parts,e.completed=this.completed,e.cached=this.cached}catch(e){}try{e.apikey=null!=this.headers.apikey||null!=this.headers["x-apikey"]}catch(e){}try{e.user=null!=(o=this.user)?o._id:void 0}catch(e){}}if(h){if(null==e.logs&&(e.logs=[]),Array.isArray(null!=this?this._logs:void 0)&&this._logs.length)for(i=0,l=(a=this._logs).length;i<l;i++)r=a[i],null==e.alert&&(e.alert=r.alert),null==e.notify&&(e.notify=r.notify),e.logs.push(r);null==e.createdAt&&(e.createdAt=Date.now()),null==e.name&&(e.name=n.name),null==e.version&&(e.version=n.version),null==e.env&&(e.env=n.env);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}e._id="log/"+(null!=(u=this.rid)?u:this.uid()),this.kv(e)}else this._logs.push(e);if(!1===n.log||!0===n.bg)return console.log("Server not logging:"),console.log(e)},r.log.schedule=function(){return this.kv._each("log","")},r.mail=async function(e){var t,i,s,l,o,a,u,h,c,p,d,f,m,y,g,v;if(null!=(u=n.mail)?u.disabled:void 0)return{};if(null==e&&(null!=(null!=this?this.params:void 0)||null!=(null!=this?this.opts:void 0)))for(o in e=null!=(h=null!=this?this.params:void 0)?h:{},this.params)e[o]=this.params[o];e.text||e.html||(e.text=null!=(c=null!=(p=e.content)?p:e.body)?c:""),delete e.content;try{for(i=0,s=(d=["subject","text","html","template"]).length;i<s;i++)if(null!=e[g=d[i]])for(a in e.params)e[g]=e[g].replace("{{"+a.toUpperCase()+"}}",e.params[a])}catch(e){}return l=null!=e.svc&&null!=(null!=(f=n.svc)&&null!=(m=f[e.svc])?m.mail:void 0)?n.svc[e.svc].mail:n.mail,null==e.from&&(e.from=l.from),null==e.to&&(e.to=l.to),delete e.svc,delete e.template,delete e.params,v="https://api.mailgun.net/v3/"+l.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),t=null!=(y=null!=this?this.fetch:void 0)?y:r.fetch,await t(v,{method:"POST",body:e,headers:{auth:"api:"+l.apikey}})},r.mail.validate=async function(e,t){var i,s,l,o;if(null==t&&(t=null!=(s=n.mail)?s.pubkey:void 0),null==e&&(e=null!=this&&null!=(l=this.params)?l.email:void 0),"string"==typeof e&&"string"==typeof t)return i=null!=(o=null!=this?this.fetch:void 0)?o:r.fetch,await i("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e.params.email)+"&api_key="+t)},r.puppet={_bg:!0},null==n.mail&&(n.mail={}),null==(h=n.mail).from&&(h.from="alert@cottagelabs.com"),null==(l=n.mail).to&&(l.to="mark@cottagelabs.com"),null==(o=n.src).google&&(o.google={});try{n.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}r.status=function(){var e,t,i,r,s;if(s={name:n.name,version:n.version,env:n.env,built:n.built},n.dev)for(e=0,i=(r=["id","request","params","parts","opts","headers","cookie","user","fn","routes"]).length;e<i;e++)if(t=r[e],!0!==this.S.bg||"request"!==t)try{null==s[t]&&(s[t]=this[t])}catch(e){}return s};a=[].indexOf;r.tdm={},r.tdm.clean=function(e){var t,i,r,n,s,l,o,a,u,h;for(null==e&&(e=null!=(l=null!=(o=null!=this&&null!=(a=this.params)?a.clean:void 0)?o:null!=this&&null!=(u=this.params)?u.text:void 0)?l:null!=this&&null!=(h=this.params)?h.q:void 0),r=0,n=(t=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;r<n;r++)i=t[r],s=new RegExp(i.bad,"g"),e=e.replace(s,i.good);return e},r.tdm.occurrence=function(e,t,i){var r,n,s,l,o,a,u,h,c,p;if(null==e&&(e=null!=(s=null!=this&&null!=(l=this.params)?l.content:void 0)?s:null!=this&&null!=(o=this.params)?o.url:void 0),0===e.indexOf("http")&&(e=this.fetch(e)),null==t&&(t=null!=(a=null!=this&&null!=(u=this.params)?u.sub:void 0)?a:null!=this&&null!=(h=this.params)?h.q:void 0),null==i&&(i=null!=this&&null!=(c=this.params)?c.overlap:void 0),e+="",(t+="").length<=0)return e.length+1;for(r=0,n=0,p=i?1:t.length;(n=e.indexOf(t,n))>=0;)++r,n+=p;return r},r.tdm.levenshtein=function(e,t,i){var r,n,s,l,o,a,u,h,c,p,d,f,m;for(null==e&&(e=null!=this&&null!=(p=this.params)?p.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),a=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(o=e.length)<(u=t.length)&&(r=e,e=t,t=r,h=o,o=u,u=h),c=[[]],r=0;r<u+1;)c[0][r]=r,r++;for(s=1;s<o+1;){for(c[s]=[s],l=1;l<u+1;)n=e.charAt(s-1)===t.charAt(l-1)?0:1,c[s][l]=a(c[s-1][l]+1,c[s][l-1]+1,c[s-1][l-1]+n),l++;s++}return{distance:c[c.length-1][c[c.length-1].length-1],length:{a:o,b:u}}},r.tdm.hamming=function(e,t,i){var r,n,s,l,o,a,u,h,c,p,d,f,m,y;if(null==e&&(e=null!=this&&null!=(h=this.params)?h.a:void 0),null==t&&(t=null!=this&&null!=(c=this.params)?c.b:void 0),null==i&&(i=null==(p=null!=this&&null!=(d=this.params)?d.lowercase:void 0)||p),i&&(e=e.toLowerCase(),t=t.toLowerCase()),e.length<t.length?(f=e,l=t):(f=t,l=e),u=l.indexOf(f),y=f.split(""),(m=l.split("")).length>y.length){if(n=m.length-y.length,0<u)for(a=0;a<u;)y.unshift(""),a++,n--;for(r=0;r<n;)y.push(""),r++}for(s in o=0,m)y[s]!==m[s]&&o++;return o},r.tdm.extract=function(e){var t,i,n,s,l,o,a,u,h,c,p,d;e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=r.http.puppeteer(e.url,!0));try{d=e.convert?r.convert.run(null!=(h=e.url)?h:e.content,e.convert,"txt"):e.content}catch(t){d=e.content}if(null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(u=d.split(e.start),d=u.length>1?u[1]:u[0]),null!=e.end&&(d=d.split(e.end)[0]),e.lowercase&&(d=d.toLowerCase()),e.ascii&&(d=d.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(d=d.replace(/ /g,"")),p={length:d.length,matched:0,matches:[],matchers:e.matchers,text:d},d&&"number"!=typeof d)for(t=0,n=(c=e.matchers).length;t<n;t++)for(l=c[t],o="g",e.lowercase&&(o+="i"),0===l.indexOf("/")?(i=l.lastIndexOf("/"))+1!==l.length&&(o=l.substring(i+1),l=l.substring(1,i)):l=l.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),a=new RegExp(l,o);s=a.exec(d);)p.matched+=1,p.matches.push({matched:l,result:s});return p},r.tdm.emails=function(e={}){var t,i,n,s,l,o,u,h,c,p,d,f,m;for(e.matchers=["/([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"],i=[],t=[],n=0,s=(h=r.tdm.extract(e).matches).length;n<s;n++)for(o=0,l=(c=h[n].result).length;o<l;o++)u=c[o],a.call(t,u)<0&&("function"!=typeof(null!=(null!=(p=r.mail)?p.validate:void 0))||r.mail.validate(u,null!=(d=r.settings.service)&&null!=(f=d.openaccessbutton)&&null!=(m=f.mail)?m.pubkey:void 0).is_valid)&&i.push(u),t.push(u);return i},r.tdm.stopwords=function(e,t,i=!0){var r,n,s,l,o,u;if(null==e&&(e=["purl","w3","http","https","ref","html","www","ref","cite","url","title","date","nbsp","doi","fig","figure","supplemental","year","time","january","february","march","april","may","june","july","august","september","october","november","december","jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec","keywords","revised","accepted","file","attribution","org","com","id","wp","main","website","blogs","media","people","years","made","location","its","asterisk","called","xp","er","image","jpeg","jpg","png","php","object","false","true","article","chapter","book","caps","isbn","scale","axis","accessed","email","e-mail","story","first1","first2","last1","last2","general","list","accessdate","view_news","d0","dq","sfnref","onepage","sfn","authorlink"]),i=["apos","as","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","aint","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","arent","around","as","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","cmon","cs","came","can","cant","cannot","cant","cause","causes","certain","certainly","changes","clearly","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldnt","course","currently","definitely","described","despite","did","didnt","different","do","does","doesnt","doing","dont","done","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadnt","happens","hardly","has","hasnt","have","havent","having","he","hes","hello","help","hence","her","here","heres","hereafter","hereby","herein","hereupon","hers","herself","hi","him","himself","his","hither","hopefully","how","howbeit","however","i","I","id","ill","im","ive","ie","if","ignored","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isnt","it","itd","itll","its","itself","just","keep","keeps","kept","know","knows","known","last","lately","later","latter","latterly","least","less","lest","let","lets","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldnt","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","ts","take","taken","tell","tends","th","than","thank","thanks","thanx","that","thats","thats","the","their","theirs","them","themselves","then","thence","there","theres","thereafter","thereby","therefore","therein","theres","thereupon","these","they","theyd","theyll","theyre","theyve","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasnt","way","we","wed","well","weve","welcome","well","went","were","werent","what","whats","whatever","when","whence","whenever","where","wheres","whereafter","whereas","whereby","wherein","whereupon","wherever","whether","which","while","whither","who","whos","whoever","whole","whom","whose","why","will","willing","wish","with","within","without","wont","wonder","would","would","wouldnt","yes","yet","you","youd","youll","youre","youve","your","yours","yourself","yourselves","zero"])for(n=0,s=i.length;n<s;n++)r=i[n],a.call(e,r)<0&&e.push(r);if(t)for("string"==typeof t&&(t=t.split(",")),u=0,l=t.length;u<l;u++)o=t[u],a.call(e,o)<0&&e.push(o);return e};a=[].indexOf;r.uid=function(e){var t,i,r,n,l;return Object(s.a)(null!=(t=this.params.alphabet)?t:"0123456789abcdefghijklmnopqrstuvwxyz-",null!=(i=null!=(r=null!=(n=null!=(l=this.params.len)?l:this.params.length)?n:this.params.size)?r:this.params.uid)?i:21)()},r.uid._cache=!1,r.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},r.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&a.call(i,t)<0&&i.push(t);return i},r.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise(t=>setTimeout(t,null!=e?e:1e3))},r.hash=async function(e){var t,i,r,n,s,l,o,a,u;try{null==e&&(e=null!=(o=null!=(a=null!=(u=this.params.hash)?u:this.request.body)?a:this.params.q)?o:this.params)}catch(e){}for("string"!=typeof e&&(e=JSON.stringify(e)),e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),l=[],n=0,s=(t=new Uint8Array(r)).length;n<s;n++)i=t[n],l.push(("00"+i.toString(16)).slice(-2));return l.join("")},r.dot=function(e,t){var i,r,n,s;for("string"==typeof e&&"object"==typeof t&&(s=e,e=t,t=s),null!=e&&(e=this.copy(e)),null==e&&null!=(null!=this&&null!=(n=this.params)?n.key:void 0)&&(t=(e=this.copy(this.params)).key,delete e.key),"string"==typeof t&&(t=t.split(".")),i=0,r=t.length;i<r;i++)e=e[t[i]];return e},r._cache=async function(e,t,i){var r,n,s,l,o,a,u,h,c,p;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?300:3600),!1!==this.S.cache&&!0!==this.S.bg){try{null==e&&(e=this.request);try{for(p=e.url.toString(),o=0,a=(u=["refresh"]).length;o<a;o++)s=u[o],-1!==p.indexOf(s+"=")&&(l=new RegExp(s+"=.*?&"),p=p.replace(l,"")),-1!==p.indexOf("&"+s+"=")&&(p=p.split("&"+s+"=")[0]);n=new URL(p)}catch(e){}}catch(e){}if(null!=e)try{return null==n&&(n=new URL(e.url)),r=new Request(n.toString(),e),null==t||""===t?(c=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),c):(t=t.clone(),(h=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,h)))}catch(e){return}}};a=[].indexOf;null==n.index&&(n.index={}),null==(h=n.index).name&&(h.name=null!=(u=n.name)?u:"n2"),r.index=async function(e,t){var i,n,s,l,o,a,u,h,c,p,d,f;if(console.log(e),console.log(t),!e&&null==t&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]&&this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(a=this.parts[1])||"src"===a||null!=r[this.parts[1]]))return{status:403};if("object"==typeof e&&(t=e,e=void 0),e||null!=t||(delete(t="object"==typeof this.body?this.copy(this.body):"string"==typeof this.body?this.body:this.copy(this.params)).route,delete t.index,delete t[this.fn.split(".").pop()],delete t._id,null==t.script&&-1===JSON.stringify(t).toLowerCase().indexOf("<script"))){if("object"!=typeof t||Array.isArray(t)||(null==e&&(e=null!=(u=t.route)?u:t.index),delete t.route,delete t.index),!e)if("index"===this.parts[0]){if(1===this.parts.length)return await this.index._indices();2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_",""));if("object"==typeof t&&!Array.isArray(t)&&t._id&&(n=t._id.replace(/\//g,"_"),-1===e.indexOf("/")&&-1===e.indexOf(n)&&(e+="/"+t._id),delete t._id),f=(e=e.toLowerCase()).split("/").length,("index"!==this.parts[0]||"DELETE"!==this.request.method&&!this.params._delete)&&""!==t){if(1===f){if("string"==typeof t&&-1===t.indexOf("\n"))try{t=this.index.translate(t)}catch(e){}if("string"==typeof t||Array.isArray(t))return this.index._bulk(e,t);if("object"==typeof t){if(this.index._q(t))return this.index._submit(e+"/_search",this.index.translate(t));for(i=this.copy(t),l=0,o=(h=["settings","aliases","mappings"]).length;l<o;l++)delete i[h[l]];return"{}"===JSON.stringify(i)?(await this.index._submit(e)||(s=this.index._q(t)?{}:{settings:t.settings,aliases:t.aliases,mappings:t.mappings},await this.index._submit(e,s)),this.index._submit(e+"/_search")):this.index._submit(e+"/_doc",t)}return this.index._submit(e+"/_search")}return 2!==f||null!=t&&("object"!=typeof t||Array.isArray(t))?void 0:null!=t&&"{}"!==JSON.stringify(t)?(e=null!=t.script?e+"/_update?retry_on_conflict=2":e.replace("/","/_create/"),this.index._submit(e,t)):("object"==typeof(p=await this.index._submit(e.replace("/","/_doc/")))&&(p._source||p.fields)&&(null==(d=null!=(c=p._source)?c:p.fields)._id&&(d._id=p._id),p=d),p)}p=await this.index._submit(e.replace("/","/_doc/"),"")}},r.index._submit=async function(e,t,i,s=!0){var l,o,a,u,h,c,p,d;if(console.log(e),console.log(t),0===(e=e.toLowerCase()).indexOf("/")&&(e=e.replace("/","")),null==i&&(i="/_pit"===e||""===t?"DELETE":null==t||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=t||"_refresh"===(o=e.split("/").pop().split("?")[0])||"_pit"===o||"_aliases"===o?"POST":"GET":"PUT"),console.log(i),"DELETE"===i&&(!0!==s||-1!==e.indexOf("/_all")))return!1;if(!e.startsWith("http")){if(d=(null!=this&&null!=(a=this.S)&&null!=(u=a.index)?u.url:void 0)?this.S.index.url:null!=(h=n.index)?h.url:void 0,Array.isArray(d)&&(d=d[Math.floor(Math.random()*d.length)]),"string"!=typeof d)return;e=d+"/"+e}if((l=-1!==e.indexOf("/_bulk")||"object"==typeof(null!=t?t.headers:void 0)?t:{body:t}).method=i,!(null==(p=null!=(null!=this?this.fetch:void 0)?await this.fetch(e,l):await r.fetch(e,l))||"object"==typeof p&&"number"==typeof p.status&&p.status>=400&&p.status<=600)){try{this.S.dev&&null!=(null!=l&&null!=(c=l.body)?c.query:void 0)&&(p.q=l.body)}catch(e){}return p}},r.index._mapping=async function(e){return"string"==typeof e&&(-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),await this.index._submit(e))},r.index.keys=function(e){var t,i;i=[];try{(t=function(r,n=""){var s,l,o;if(null==r&&(r="object"==typeof e?e:this.index._mapping(e)),null!=r.properties){for(s in n.length&&(n+="."),o=[],r.properties)l=n+s,a.call(i,l)<0&&i.push(n+s),null!=r.properties[s].properties?o.push(t(r.properties[s],n+s)):o.push(void 0);return o}})()}catch(e){}return i},r.index.terms=function(e,t,i,r=1e3,n=!1,s="count"){var l,o;l="object"==typeof i?i:{query:{filtered:{filter:{exists:{field:t}}}},size:0,facets:{}},"string"==typeof i&&(l.filtered.query={query_string:{query:i}}),null==l.facets&&(l.facets={}),l.facets[t]={terms:{field:t,size:r,order:s}};try{return null==(null!=(o=this.index._submit("/"+e+"/_search",l,"POST"))?o.facets:void 0)?[]:n?o.facets[t].terms:_.pluck(o.facets[t].terms,"term")}catch(e){return e,[]}},r.index.count=function(e,t,i){var r,n,s,l,o,a;return null==i&&(i={query:{filtered:{filter:{bool:{must:[]}}}}}),null!=t?(i.size=0,i.aggs={keycard:{cardinality:{field:t,precision_threshold:4e4}}},null!=(r=this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(n=r.aggregations)&&null!=(s=n.keycard)?s.value:void 0):null!=(l=this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(o=l.hits)&&null!=(a=o.total)?a.value:void 0},r.index.min=function(e,t,i){var r;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={min:{min:{field:t}}},this.index._submit("/"+e+"/_search",r,"POST").aggregations.min.value},r.index.max=function(e,t,i){var r;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={max:{max:{field:t}}},this.index._submit("/"+e+"/_search",r,"POST").aggregations.max.value},r.index.range=function(e,t,i){var r,n;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={min:{min:{field:t}},max:{max:{field:t}}},{min:(n=this.index._submit("/"+e+"/_search",r,"POST")).aggregations.min.value,max:n.aggregations.max.value}},r.index._each=function(e,t,i,n){var s,l,o,a,u,h,c,p,d,f,m,y,g,v,b,_;for(void 0===n&&void 0===i&&"function"==typeof t&&(n=t,t="*"),void 0===n&&"function"==typeof i&&(n=i,i=void 0),null==i&&(i={}),null!=i.keep_alive?(u=i.keep_alive,delete i.keep_alive):u="5m",i.action?(s=i.action,delete i.action):s=!1,(d=r.index.translate(t,i)).from=0,null==d.size&&(d.size=1e3),c=this.index(e+"/_pit?keep_alive="+u).id,d.pit={id:c,keep_alive:u},null==d.sort&&(d.sort=[{createdAt:"asc"}]),p=0,_=[],b=!1;null!=(null!=v&&null!=(g=v.hits)?g.hits:void 0)&&(!1===b||p<b);){for(v=this.index(e,d),!1===b&&(b=v.hits.total.value),a=0,h=(f=v.hits.hits).length;a<h;a++)o=f[a],p+=1,null==(l=(n=n.bind(this))(null!=(m=null!=(y=o._source)?y:o.fields)?m:{_id:o._id}))||"object"!=typeof l&&"string"!=typeof l||_.push(l),d.search_after=o.sort;d.pit.id=v.pit_id}return s&&_.length&&this.index._bulk(e,_,s),this.index._submit("/_pit",{id:c})},r.index._bulk=async function(e,t,i="index",r=5e4){var n,s,l,o,a,u,h;if("string"==typeof t&&-1!==t.indexOf("\n"))return await this.index._submit("/_bulk",{content:t,headers:{"Content-Type":"text/plain"}}),!0;for(o in h="object"!=typeof t||Array.isArray(t)||null==(null!=t&&null!=(a=t.hits)?a.hits:void 0)?t:t.hits.hits,Array.isArray(h)||(h=[h]),n=0,l="",h)n+=1,"object"==typeof(u=h[o])&&null==u._id&&(u._id=this.uid()),(s={})[i]={_index:"string"!=typeof u&&null!=u._index?u._index:e},s[i]._id="delete"===i&&"string"==typeof u?u:u._id,l+=JSON.stringify(s)+"\n","create"===i||"index"===i?l+=JSON.stringify(u._source?u._source:u)+"\n":"update"===i&&(null!=u._id&&delete u._id,l+=JSON.stringify({doc:u})+"\n"),(n===r||parseInt(o)===h.length-1||l.length>7e7)&&(await this.index._submit("/_bulk",{content:l,headers:{"Content-Type":"text/plain"}}),l="",n=0);return h.length},r.index._indices=async function(e=!1){var t,i,r,n,s,l,o,u;for(i in s=e?{}:[],l=await this.index._submit("_stats"),u=e?await this.index._submit("_cat/shards?format=json"):[],l.indices)if(a.call([],i)<0&&!i.startsWith(".")&&!i.startsWith("security-"))if(e)for(s[i]={docs:l.indices[i].primaries.docs.count,size:Math.ceil(l.indices[i].primaries.store.size_in_bytes/1024/1024)},r=0,n=u.length;r<n;r++)(o=u[r]).index===i&&"p"===o.prirep&&(null==(t=s[i]).shards&&(t.shards=0),s[i].shards+=1);else s.push(i);return s},r.index.status=async function(){var e,t,i,r,n,s;(s={status:"green"}).indices=await this.index._indices(!0);try{for("green"!==(r=s.cluster.status)&&"yellow"!==r&&(s.status="red"),e=0,i=(n=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;e<i;e++)t=n[e],delete s.cluster[t]}catch(e){}return s},r.index._q=function(e,t){var i,r,n,s,l,o,a;if("object"!=typeof e||Array.isArray(e)){if("string"==typeof e&&-1===e.indexOf("\n")){if("string"==typeof t&&e.toLowerCase().startsWith(t.toLowerCase()))return!1;if(e.startsWith("?")||e.startsWith("q="))return!0;if(e.length<8||(-1!==e.indexOf("/")?e.split("/").pop():e).length>34)return!0;for(n=0,l=(a=[" ",":","*","~","(",")","?"]).length;n<l;n++)if(i=a[n],-1!==e.indexOf(i))return!0}}else{for(r=0,s=(o=["settings","aliases","mappings","index"]).length;r<s;r++)if(e[o[r]])return!1;if(null!=e.q||null!=e.query)return!0}return!1},r.index.translate=function(e,t={}){var i,r,n,s,l,o,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,he,ce,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,qe,Se,Ae,je;null==e&&(e=null!=this?this.params:void 0);try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if("random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null==($=null!=(G=null!=t?t.query:void 0)?G:{}).query&&($.query={}),$=(i=function(e){var t,i,r,n,s;return null!=e.query&&null!=e.query.filtered||(e.query={filtered:{query:e.query,filter:{}}}),null==(t=e.query.filtered).filter&&(t.filter={}),null==(i=e.query.filtered.filter).bool&&(i.bool={}),null==(r=e.query.filtered.filter.bool).must&&(r.must=[]),null==e.query.filtered.query.bool&&(s=[],"{}"!==JSON.stringify(e.query.filtered.query)&&s.push(e.query.filtered.query),e.query.filtered.query={bool:{must:s}}),null==(n=e.query.filtered.query.bool).must&&(n.must=[]),e})($),"object"==typeof e){for(_=0,k=(se=["apikey","_","callback","refresh","key","counts","index"]).length;_<k;_++)delete e[se[_]];for(O=0,q=(he=["random","seed"]).length;O<q;O++)t[M=he[O]]=e[M],delete e[M];if(0===JSON.stringify(e).indexOf("["))for($.query.filtered.filter.bool.should=[],N=0,A=e.length;N<A;N++)if("object"==typeof(P=e[N])&&null!=P)for(x in P)"string"==typeof P[x]?((xe={term:{}}).term[x],$.query.filtered.filter.bool.should.push(xe)):"number"==(ce=typeof P[x])||"boolean"===ce?$.query.filtered.query.bool.should.push({query_string:{query:x+":"+P[x]}}):null!=P[x]&&$.query.filtered.filter.bool.should.push(P[x]);else"string"==typeof P&&(null==(l=$.query.filtered.query.bool).should&&(l.should=[]),$.query.filtered.query.bool.should.push({query_string:{query:P}}));else if(null!=e.query)$=e;else if(null!=e.source)for(D in"string"==typeof e.source&&($=JSON.parse(e.source)),"object"==typeof e.source&&($=e.source),null==t&&(t={}),e)"source"!==D&&null==t[D]&&(t[D]=e[D]);else if(null!=e.q)for(D in null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(z={})[(F=e.q.split(":"))[0]]=F[1],$.query.filtered.query.bool.must.push({prefix:z})):$.query.filtered.query.bool.must.push({query_string:{query:e.q}}),null==t&&(t={}),e)"q"!==D&&null==t[D]&&(t[D]=e[D]);else for(Ae in null!=e.must&&($.query.filtered.filter.bool.must=e.must),null!=e.should&&($.query.filtered.filter.bool.should=e.should),null!=e.must_not&&($.query.filtered.filter.bool.must_not=e.must_not),e)"fields"===Ae||"sort"===Ae&&"string"==typeof e[Ae]&&-1!==e[Ae].indexOf(":")||!("from"!==Ae&&"size"!==Ae||"number"!=typeof e[Ae]&&isNaN(parseInt(e[Ae])))?(null==t&&(t={}),t[Ae]=e[Ae]):"must"!==Ae&&"must_not"!==Ae&&"should"!==Ae&&("string"==typeof e[Ae]?((xe={term:{}}).term[Ae]=e[Ae],$.query.filtered.filter.bool.must.push(xe)):"number"==(pe=typeof e[Ae])||"boolean"===pe?$.query.filtered.query.bool.must.push({query_string:{query:Ae+":"+e[Ae]}}):"object"==typeof e[Ae]?((V={})[Ae]=e[Ae],$.query.filtered.filter.bool.must.push(V)):null!=e[Ae]&&$.query.filtered.filter.bool.must.push(e[Ae]))}else"string"==typeof e&&(0===e.indexOf("?")?$=e:null!=e&&(""===e&&(e="*"),$.query.filtered.query.bool.must.push({query_string:{query:e}})));if($=i($),null!=t){if(!0===t.newest?(delete t.newest,t.sort={createdAt:{order:"desc"}}):!1===t.newest&&(delete t.newest,t.sort={createdAt:{order:"asc"}}),delete t._,delete t.apikey,t.fields&&"string"==typeof t.fields&&-1!==t.fields.indexOf(",")&&(t.fields=t.fields.split(",")),t.random&&(m={function_score:{random_score:{}}},null!=t.seed&&(m.function_score.random_score.seed=seed),$.query.filtered?(m.function_score.query=$.query.filtered.query,$.query.filtered.query=m):(m.function_score.query=$.query,$.query=m),delete t.random,delete t.seed),(null!=t._include||null!=t.include||null!=t._includes||null!=t.includes||null!=t._exclude||null!=t.exclude||null!=t._excludes||null!=t.excludes)&&(null==$._source&&($._source={}),null!=(b=t[v=null!=t._include?"_include":null!=t.include?"include":null!=t._includes?"_includes":"includes"])&&("string"==typeof b&&(b=b.split(",")),$._source.includes=b,delete t[v]),null!=(p=t[c=null!=t._exclude?"_exclude":null!=t.exclude?"exclude":null!=t._excludes?"_excludes":"excludes"]))){for("string"==typeof p&&(p=p.split(",")),J=0,j=(de=null!=b?b:[]).length;J<j;J++)y=de[J],a.call(p,y)>=0&&delete p[y];$._source.excludes=p,delete t[c]}if(null!=t.and){for(be=0,E=(fe=t.and).length;be<E;be++)r=fe[be],$.query.filtered.filter.bool.must.push(r);delete t.and}if(null!=t.sort){if("string"==typeof t.sort&&-1!==t.sort.indexOf(","))if(-1!==t.sort.indexOf(":")){for(B=[],Oe=0,R=(me=t.sort.split(",")).length;Oe<R;Oe++)(U={})[(W=me[Oe]).split(":")[0]]={order:W.split(":")[1]},B.push(U);t.sort=B}else t.sort=t.sort.split(",");"string"==typeof t.sort&&-1!==t.sort.indexOf(":")&&((B={})[t.sort.split(":")[0]]={order:t.sort.split(":")[1]},t.sort=B)}if(null!=t.restrict){for(qe=0,T=(ye=t.restrict).length;qe<T;qe++)ge=ye[qe],$.query.filtered.filter.bool.must.push(ge);delete t.restrict}if(null!=t.not||null!=t.must_not){if(_e=null!=t.not?"not":"must_not",Array.isArray(t[_e]))$.query.filtered.filter.bool.must_not=t[_e];else for(null==(o=$.query.filtered.filter.bool).must_not&&(o.must_not=[]),Se=0,L=(X=t[_e]).length;Se<L;Se++)Y=X[Se],$.query.filtered.filter.bool.must_not.push(Y);delete t[_e]}if(null!=t.should){if(Array.isArray(t.should))$.query.filtered.filter.bool.should=t.should;else for(null==(u=$.query.filtered.filter.bool).should&&(u.should=[]),je=0,C=(H=t.should).length;je<C;je++)ve=H[je],$.query.filtered.filter.bool.should.push(ve);delete t.should}if(null!=t.all&&($.size=1e6,delete t.all),null!=t.terms){try{t.terms=t.terms.split(",")}catch(e){}for(null==$.facets&&($.facets={}),g=0,I=(K=t.terms).length;g<I;g++)we=K[g],$.facets[we]={terms:{field:we,size:1e3}};delete t.terms}for(w=0,S=(Q=["facets","aggs","aggregations"]).length;w<S;w++)if(null!=t[n=Q[w]]){for(d in null==$[n]&&($[n]={}),t[n])$[n][d]=t[n][d];delete t[n]}for(x in t)ke=t[x],$[x]=ke}if("object"==typeof $&&null!=(null!=(Z=$.query)&&null!=(ee=Z.filtered)?ee.query:void 0)&&"{}"===JSON.stringify($.query.filtered.query)&&($.query.filtered.query={match_all:{}}),null!=(null!=(te=$.query)&&null!=(ie=te.filtered)&&null!=(re=ie.query)?re.bool:void 0))for(h in $.query.filtered.query.bool)for(s in $.query.filtered.query.bool[h])"string"==typeof(null!=(ne=$.query.filtered.query.bool[h][s].query_string)?ne.query:void 0)&&-1!==$.query.filtered.query.bool[h][s].query_string.query.indexOf("/")&&($.query.filtered.query.bool[h][s].query_string.query=$.query.filtered.query.bool[h][s].query_string.query.replace(/\//g,"\\/"));if(null!=(null!=(le=$.query)&&null!=(oe=le.filtered)&&null!=(ae=oe.filter)?ae.bool:void 0))for(f in $.query.filtered.filter.bool)for(d in $.query.filtered.filter.bool[f])null!=(null!=(ue=$.query.filtered.filter.bool[f][d].query_string)?ue.query:void 0)&&-1!==$.query.filtered.filter.bool[f][d].query_string.query.indexOf("/")&&($.query.filtered.filter.bool[f][d].query_string.query=$.query.filtered.filter.bool[f][d].query_string.query.replace(/\//g,"\\/"));return null!=$._source&&null!=$.fields&&delete $._source,$},r.kv=async function(e,i,r,n,s){var l,o,a,u,h,c,p,d,f,m,y,g,v,b;if(null==e&&(e=null!=(p=null!=(d=this.params.kv)?d:this.params.key)?p:this.parts.join("_"),null==i)){if("DELETE"===this.request.method||this.params._delete)i="";else if(null!=this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,l=0,u=(f=["key","kv","refresh","apikey"]).length;l<u;l++)delete i[a=f[l]];for(o=0,h=(m=this.parts).length;o<h;o++)delete i[a=m[o]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=void 0)}if("object"!=typeof i||"{}"!==(g=JSON.stringify(i))&&"[]"!==g||(i=""),"object"==typeof e&&null==i&&(e=null!=(v=(i=e)._id)?v:await this.uid()),null!=e&&this.S.kv&&null!=t[this.S.kv]){if(null!=i&&""!==i){if(c={metadata:n},"number"==typeof r&&(1e3*r>Date.now()?c.expiration=r:c.expirationTtl=r),"object"==typeof i&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(a in r)null==i[a]&&(i[a]=r[a]);return this.waitUntil(t[this.S.kv].put(e,"object"==typeof i?JSON.stringify(i):i,c)),i}({value:b,metadata:n}=await t[this.S.kv].getWithMetadata(e,s));try{b=JSON.parse(b)}catch(e){}try{n=JSON.parse(n)}catch(e){}return""===i&&this.waitUntil(t[this.S.kv].delete(e)),!0===n?{value:b,metadata:n}:b}},r.kv.count=async function(e){var i,r,n,s,l,o,a,u;if(r=0,this.S.kv&&null!=t[this.S.kv])for(null==e&&(e=null!=(a=this.params.kv)?a:this.params.prefix),i=!1;!i;){for(n=(o=await t[this.S.kv].list({prefix:e,cursor:n})).cursor,s=0,l=(u=o.keys).length;s<l;s++)u[s],r+=1;i=o.list_complete}return r},r.kv._each=async function(e,i,r){var n,s,l,o,a,u,h,c,p,d;if(p=[],this.S.kv&&null!=t[this.S.kv])for(n=!1,s=0;!n;){for(l=(h=await t[this.S.kv].list({prefix:e,cursor:l})).cursor,o=0,u=(c=h.keys).length;o<u;o++)a=c[o],s+=1,""===i?this.waitUntil(this.kv(a.name,"")):"function"==typeof i?p.push(await i.call(this,a.name)):null!=i?this.waitUntil(this.kv(a.name,i)):(null!=(d=await this.kv(a.name))&&null==d.id&&(d.id=a.name),p.push(d));n=!(!r||s!==r)||h.list_complete}return p};var u,h;a=[].indexOf;n.name,null!=(u=n.mail)&&u.to,r.src.crossref={},r.src.crossref.journals=async function(e){var t,i,r,n,s;return null==e&&(e=null!=(t=null!=this&&null!=(i=this.params)?i.journals:void 0)?t:null!=this&&null!=(r=this.params)?r.issn:void 0),s="https://dev.lvatn.com/use/crossref/journals/"+e,null!=(null!=(n=await this.fetch(s))?n.ISSN:void 0)?n:void 0},r.src.crossref.journals._index=!0,r.src.crossref.journals._key="ISSN",r.src.crossref.works=async function(e){var t,i,r,n,s,l,o,a;return(null!=this&&null!=(i=this.params)?i.title:void 0)||"object"==typeof e&&null!=e.title||"string"==typeof e&&0!==e.indexOf("10.")?o=this.src.crossref.works._title((null!=this&&null!=(r=this.params)?r.title:void 0)?this.params.title:"object"==typeof e?e.title:e):(null==e&&(e=null!=(n=null!=this&&null!=(s=this.params)?s.works:void 0)?n:null!=this&&null!=(l=this.params)?l.doi:void 0),"string"==typeof e&&(0===e.indexOf("http")&&(e=e.split("://")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),a="https://dev.lvatn.com/use/crossref/works/"+e,o=await this.fetch(a))),null!=(null!=o?o.DOI:void 0)?(delete(t=o).relation,delete t.reference,delete t.abstract,t):void 0},r.src.crossref.works._kv=!1,r.src.crossref.works._index={settings:{number_of_shards:9}},r.src.crossref.works._key="DOI",r.src.crossref.works._title=async function(e){var t,i,r,n,s,l,o,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O;if(null==e&&(e=this.params.title),"string"==typeof e){if(c='title.exact:"'+e+'"',-1!==e.indexOf(" ")){for(c+=" OR (",t=!0,i=0,s=(d=e.split(" ")).length;i<s;i++)(x=d[i]).length>2&&(!0===t?t=!1:c+=" AND "),c+='(title:"'+x+'" OR subtitle:"'+x+'")';c+=")"}for(O="https://dev.lvatn.com/use/crossref/works?q="+c,b=await this.fetch(O),h=!1,o=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),r=0,l=(y=null!=(f=null!=b&&null!=(m=b.hits)?m.hits:void 0)?f:[]).length;r<l;r++)if(_=("string"==typeof(p=y[r]._source).title?p.title:p.title[0]).toLowerCase(),null!=p.subtitle&&"string"==typeof(w=("string"==typeof p.subtitle?p.subtitle:p.subtitle[0]).toLowerCase())&&w.length&&a.call(_,w)<0&&(_+=" "+w),_=_.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==o.indexOf(_)||-1!==_.indexOf(o))&&o.length/_.length>.7&&o.length/_.length<1.3){for(n in u=!0,metadata)"citation"===n||"title"===n||"string"!=(g=typeof metadata[n])&&"number"!==g||(u=null==fr[n]||"string"!=(v=typeof fr[n])&&"number"!==v||fr[n].toLowerCase()===metadata[n].toLowerCase());if(u){if("journal-article"===p.type)return format?API.use.crossref.works.format(p):p;(!1===h||"journal-article"!==h.type&&"journal-article"===p.type)&&(h=p)}}return!1===h?void 0:h}},r.src.epmc=async function(e,t,i){var r,n,s,l,o;return 0===e.indexOf("10.")&&-1===e.indexOf(" ")&&2===e.split("/").length&&(e="DOI:"+e),o="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+"%20sort_date:y&resulttype=core&format=json",null!=i&&(o+="&pageSize="+i),null!=t&&(o+="&cursorMark="+t),l={},s=await this.fetch(o),l.total=s.hitCount,l.data=null!=(r=null!=(n=s.resultList)?n.result:void 0)?r:[],l.cursor=s.nextCursorMark,l},r.src.epmc.pmid=function(e){var t;return(t=this.src.epmc("EXT_ID:"+e+" AND SRC:MED")).total?t.data[0]:void 0},r.src.epmc.pmc=function(e){var t;return(t=this.src.epmc("PMCID:PMC"+e.toLowerCase().replace("pmc",""))).total?t.data[0]:void 0},r.src.epmc.title=function(e){var t;try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(t=this.src.epmc('title:"'+e+'"')).total?t.data[0]:void 0},r.src.epmc.licence=function(e,t,i){var r,n,s,l,o;if(e&&!t&&(o=this.src.epmc("PMC"+e.toLowerCase().replace("pmc",""))),(null!=o?o.total:void 0)>0||t||i){if(null==t&&(t=o.data[0]),!e&&t&&(e=t.pmcid),t.license)return 0===(n={licence:t.license,source:"epmc_api"}).licence.indexOf("cc")&&(n.licence=n.licence.replace(/ /g,"-")),n;if(!i&&e&&(i=this.src.epmc.xml(e)),404!==i&&"string"==typeof i&&0===i.indexOf("<")&&null!=this.svc.lantern){if(null!=(s=this.svc.lantern.licence(void 0,void 0,i,"<permissions>","</permissions>")).licence)return s.source="epmc_xml_permissions",s;if(null!=(r=this.svc.lantern.licence(void 0,void 0,i)).licence)return r.source="epmc_xml_outside_permissions",r;-1!==i.indexOf("<permissions>")&&(l={licence:"non-standard-licence",source:"epmc_xml_permissions"})}return null!=l&&l}return!1},r.src.epmc.xml=async function(e){var t;return e&&(e=e.toLowerCase().replace("pmc","")),t="https://www.ebi.ac.uk/europepmc/webservices/rest/PMC"+e+"/fullTextXML",(await this.fetch(t)).content},r.src.epmc.aam=function(e,t,i,r){return"string"==typeof i&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(null==e&&(e=null!=t?t.pmcid:void 0),e&&"string"==typeof(i=this.src.epmc.xml(e))&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:{aam:!1,info:""})},r.src.google=async function(e,t,i){var r,s,l,o,a,u,h,c,p,d;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(l=this.params)?l.google:void 0),null==t&&(t=null!=(o=n.src.google)&&null!=(a=o.secrets)&&null!=(u=a.search)?u.id:void 0),null==i&&(i=null!=(h=n.src.google)&&null!=(c=h.secrets)&&null!=(p=c.search)?p.key:void 0),e&&t&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(d)):{}},r.src.google.sheets=async function(e){var t,i,r,n,s,l,o,a;if(null==e&&(e=null!=(n=null!=this?this.params:void 0)?n:{}),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(s=e.sheet)?s:e.sheets,delete e.sheet,delete e.sheets),a=[],!e.sheetid)return a;for(r in 0===e.sheetid.indexOf("http")?l=e.sheetid:(-1!==e.sheetid.indexOf("/spreadsheets/d/")&&(e.sheetid=e.sheetid.split("/spreadsheets/d/")[1].split("/")[0]),null==e.sheet&&(e.sheet="default"),l="https://spreadsheets.google.com/feeds/list/"+e.sheetid+"/"+e.sheet+"/public/values?alt=json"),(t=await this.fetch(l)).feed.entry){for(i in o={},t.feed.entry[r])try{0===i.indexOf("gsx$")&&(o[i.replace("gsx$","")]=t.feed.entry[r][i].$t)}catch(e){}a.push(o)}return a},r.src.google.sheets._bg=!0,r.src.google.chat=function(e,t){var i,r,n,s,l,o;return null==e&&(e=this.params),i={method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:{text:decodeURIComponent(null!=(r=null!=(n=null!=(s=e.text)?s:e.msg)?n:e.body)?r:"")}},null==t&&(t=null!=(l=this.S.src.google)&&null!=(o=l.secrets)?o.chat:void 0),i.body.text&&null!=t?this.fetch(t,i):void 0},null==(h=n.src).microsoft&&(h.microsoft={});try{n.src.microsoft.secrets=JSON.parse(SECRETS_MICROSOFT)}catch(e){}r.src.microsoft={},r.src.microsoft.bing=async function(e,t){var i,r,s,l,o,a,u,h,c,p,d;return null==e&&(e=null!=(i=null!=(r=null!=this&&null!=(s=this.params)?s.bing:void 0)?r:null!=this&&null!=(l=this.params)?l.q:void 0)?i:null!=this&&null!=(o=this.params)?o.query:void 0),null==t&&(t=null!=(a=n.src.microsoft)&&null!=(u=a.secrets)&&null!=(h=u.bing)?h.key:void 0),d="https://api.cognitive.microsoft.com/bing/v7.0/search?mkt=en-GB&count=20&q="+e,(null!=(p=await this.fetch(d,{headers:{"Ocp-Apim-Subscription-Key":t}}))&&null!=(c=p.webPages)?c.value:void 0)?{total:p.data.webPages.totalEstimatedMatches,data:p.data.webPages.value}:{total:0,data:[]}},r.src.microsoft.graph=function(e){var t,i,r,n,s,l,o,a,u,h,c;if(t=function(e){var t;return e.JournalId&&(t=this.src.microsoft.graph.journal(e.JournalId))&&(e.journal=t),e},null==e&&(e=null!=(s=null!=(l=null!=(o=this.params.graph)?o:this.params.doi)?l:this.params.title)?s:this.params),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&-1!==e.indexOf("/")&&0===e.indexOf("10.")&&(n=this.src.microsoft.graph.paper('Doi.exact:"'+e+'"')))return t(n);if("string"==typeof e&&-1===e.indexOf(" ")&&10===e.length&&(n=this.src.microsoft.graph.paper(e)))return t(n);if("string"!=typeof e||-1===e.indexOf(" "))return this.src.microsoft.graph.paper(e);if(c=c.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),u=this.src.microsoft.graph.paper('PaperTitle:"'+c+'"'))if(h=u.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),"function"==typeof(null!=this&&null!=(a=this.tdm)?a.levenshtein:void 0)){if(i=(r=this.tdm.levenshtein(c,h,!1)).length.a>r.length.b?r.length.a:r.length.b,r.distance<2||i/r.distance>10)return u}else if(c.length<1.2*h.length&&c.length>.8*h.length)return u},r.src.microsoft.graph.paper=async function(e){var t;try{return t="https://dev.lvatn.com/use/microsoft/graph/paper/?q="+e,(await this.fetch(t)).hits.hits[0]._source}catch(e){return}},r.src.microsoft.graph.journal=async function(e){var t;try{return t="https://dev.lvatn.com/use/microsoft/graph/journal/"+e,await this.fetch(t)}catch(e){return}},r.src.oadoi=function(e){var t,i,r,s;return null==e&&(e=null!=(t=null!=this&&null!=(i=this.params)?i.oadoi:void 0)?t:null!=this&&null!=(r=this.params)?r.doi:void 0),"string"==typeof e&&e.startsWith("10.")?(s="https://api.oadoi.org/v2/"+e+"?email="+n.mail.to,this.fetch(s)):void 0},r.src.oadoi._index=!0,r.src.oadoi._kv=!1,r.src.oadoi._key="doi";try{n.svc.oaworks=JSON.parse(SECRETS_OAWORKS)}catch(e){n.svc.oaworks={}}r.svc.oaworks=function(){return{name:"OA.works API"}},r.svc.oaworks.metadata=async function(){return(await this.svc.oaworks.find()).metadata},r.svc.oaworks.find=async function(e,t={},i){var r,n,s,l,o,a,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O;x={},n=async e=>{var i,r,n;for(r in n=[],i=await this.svc.oaworks.citation(e))"url"===r||"paywall"===r?n.push(null!=x[r]?x[r]:x[r]=i[r]):n.push(null!=t[r]?t[r]:t[r]=i[r]);return n};try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==e.doi&&(e.doi=e.find),null==i&&(i=null!=(f=e.dom)?f:this.request.body),(e.q||e.id)&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),-1!==e.url.indexOf("/10.")&&-1!==(u="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).indexOf("/")&&u.split("/")[0].length>6&&u.length>8&&((h=u.split("/")).length>2&&(u=h.join("/")),null==t.doi&&(t.doi=u)),0===e.url.replace("doi:","").replace("doi.org/","").trim().indexOf("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):0===e.url.toLowerCase().indexOf("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&-1===e.url.indexOf(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null==t.title&&0!==e.url.indexOf("http")&&(-1!==e.url.indexOf("{")||(null!=(y=e.url.replace("...","").match(/\./gi))?y:[]).length>3||(null!=(g=e.url.match(/\(/gi))?g:[]).length>2?e.citation=e.url:t.title=e.url),0===e.url.indexOf("http")&&-1!==e.url.indexOf(".")||delete e.url),e.title&&(-1!==e.title.indexOf("{")||(null!=(v=e.title.replace("...","").match(/\./gi))?v:[]).length>3||(null!=(b=e.title.match(/\(/gi))?b:[]).length>2)&&(e.citation=e.title,delete e.title),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(_=e.pmcid)?_:e.pmc),e.citation&&await n(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}if("string"==typeof t.doi&&0===t.doi.indexOf("10.")||delete t.doi,t.title||!i||"string"!=typeof e.url||-1===e.url.indexOf("alma.exlibrisgroup.com")&&-1===e.url.indexOf("/exlibristest")||delete e.url,l=async()=>{var r,s,l,o,a,u,h;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await n(await this.svc.oaworks.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(h=t.pmcid)?h:t.pmid),await n(u)),t.title&&!t.doi&&(s=async()=>(t.doi||await n(await this.src.crossref.works(t.title)),!0),l=async()=>(t.doi||await n(await this.src.microsoft.graph(t.title)),!0),a=async()=>(null!=u||t.doi||await n(await this.src.epmc.title(t.title)),!0),await Promise.all([s(),l(),a()]))),t.doi&&(o=async()=>{var e;return(null!=(e=await this.src.oadoi(t.doi))?e.doi:void 0)===t.doi&&await n(e),!0},r=async()=>{var i;return(null!=(i=await this.src.crossref.works(t.doi))?i.type:void 0)?await n(i):(x.doi_not_in_crossref=t.doi,"string"==typeof e.url&&-1!==e.url.indexOf("doi.org/"+t.doi)&&delete e.url,delete t.doi),!0},await Promise.all([o(),r()])),!0},await l(),t.title&&!t.doi&&!i&&!e.url&&("undefined"==typeof epmc||null===epmc))try{d=unidecode(t.title.toLowerCase()).replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),null!=(null!=(a=await this.src.microsoft.bing.search(d))?a.data:void 0)&&a.data.length&&(o=unidecode(a.data[0].name.toLowerCase()).replace("(pdf)","").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),0!==d.replace(/ /g,"").indexOf(o.replace(/ /g,""))||await this.svc.oaworks.blacklist(a.data[0].url)||(e.url=a.data[0].url.replace(/"/g,""),"string"==typeof e.url&&-1!==e.url.indexOf("pubmed.ncbi")&&(t.pmid=e.url.replace(/\/$/,"").split("/").pop()),"string"==typeof e.url&&-1!==e.url.indexOf("/10.")&&null==t.doi&&(t.doi="10."+e.url.split("/10.")[1]))),(t.doi||t.pmid||e.url)&&await l()}catch(e){}for(r=async()=>{var i,r,n,s;if((t.doi||t.title)&&(null!=e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill)){null==x.ill&&(x.ill={});try{x.ill.terms=null!=(r=null!=(n=e.config)?n.terms:void 0)?r:await this.svc.oaworks.ill.terms(e.from)}catch(e){}try{x.ill.openurl=await this.svc.oaworks.ill.openurl(null!=(s=e.config)?s:e.from,t)}catch(e){}try{x.ill.subscription=await this.svc.oaworks.ill.subscription(null!=(i=e.config)?i:e.from,t,x.refresh)}catch(e){}}return!0},s=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==x.permissions&&(x.permissions=await this.svc.oaworks.permissions(t,null!=(i=e.config)?i:e.from)),!0},await Promise.all([r(),s()]),c=0,p=(w=["title","journal","year","doi"]).length;c<p;c++)e[O=w[c]]&&e[O]!==t[O]&&(t[O]=e[O]);return x.metadata=t,x},r.svc.oaworks.citation=function(e){var t,i,r,n,s,l,o,a,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,he,ce,pe,de,fe,me,ye,ge,ve,be;de={};try{null==e&&(e=null!=(E=this.params.citation)?E:this.params)}catch(e){}if("string"==typeof e&&(0===e.indexOf("{")||0===e.indexOf("[")))try{e=JSON.parse(options.citation)}catch(e){}if("object"==typeof e){null==de.doi&&(de.doi=null!=(R=e.DOI)?R:e.doi);try{null==de.type&&(de.type=null!=(B=e.type)?B:e.genre)}catch(e){}null==de.issn&&(de.issn=null!=(Q=null!=(oe=null!=(ae=e.ISSN)?ae:e.issn)?oe:null!=(ue=e.journalInfo)&&null!=(he=ue.journal)?he.issn:void 0)?Q:null!=(ce=e.journal)?ce.issn:void 0),e.journal_issns&&null==de.issn&&(de.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==de.title&&(de.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(de.title+=": "+e.subtitle[0])}catch(e){}null==de.title&&(de.title=null!=(pe=e.dctitle)?pe:null!=(T=e.bibjson)?T.title:void 0),404!==(L=e.title)&&"404"!==L&&null==de.title&&(de.title=e.title),de.title&&(de.title=de.title.replace(/\s\s+/g," ").trim());try{null==de.journal&&(de.journal=e["container-title"][0])}catch(e){}try{de.shortname=e["short-container-title"][0]}catch(e){}null==de.journal&&(de.journal=null!=(C=null!=(I=e.journal_name)?I:null!=(P=e.journalInfo)&&null!=(N=P.journal)?N.title:void 0)?C:null!=(U=e.journal)?U.title:void 0),e.journal&&(de.journal=e.journal.split("(")[0].trim()),null==de.publisher&&(de.publisher=e.publisher);try{null!=e.issue&&null==de.issue&&(de.issue=e.issue)}catch(e){}try{null!=e.volume&&null==de.volume&&(de.volume=e.volume)}catch(e){}try{null!=e.page&&null==de.page&&(de.page=e.page.toString())}catch(e){}for(o=0,c=(Y=["title","journal"]).length;o<c;o++)de[u=Y[o]]||"string"!=typeof e[u]||e[u].charAt(0).toUpperCase()===e[u].charAt(0)&&e[u].toUpperCase()!==e.key&&e[u].toLowerCase()!==e.key||(de[u]=e[u].charAt(0).toUpperCase()+e[u].slice(1));if(null==de.year&&(null!=e.year||null!=e.published||null!=e.published_date)){try{for(W=(null!=(J=null!=(z=e.year)?z:e.published)?J:e.published_date).split(-1!==(null!=(D=null!=(M=e.year)?M:e.published)?D:e.published_date).indexOf("/")?"/":"-"),a=0,p=W.length;a<p;a++)4===(_=W[a]).length&&null==de.year&&(de.year=_)}catch(e){}try{"number"==typeof de.year||4===de.year.length&&0===de.year.replace(/[0-9]/gi,"").length||delete de.year}catch(e){}"number"==typeof de.year&&(de.year=de.year.toString())}if(null==de.year&&null==de.published)for(w=0,d=(V=["published-print","journal-issue.published-print","issued","published-online","created","deposited","indexed"]).length;w<d;w++){O=V[w];try{if(ye=null!=(F=e[O])?F:null!=($=e["journal-issue"])?$[O.replace("journal-issue.","")]:void 0){if("string"==typeof ye["date-time"]&&-1!==ye["date-time"].indexOf("T")&&3===ye["date-time"].split("T")[0].split("-").length){null==de.published&&(de.published=ye["date-time"].split("T")[0]),null==de.year&&(de.year=de.published.split("-")[0]);break}if(null!=ye["date-parts"]&&ye["date-parts"].length&&Array.isArray(ye["date-parts"][0])&&ye["date-parts"][0].length&&(k=(me=ye["date-parts"][0])[0].toString()).length>2){null==de.year&&(de.year=k),1===me.length?k+="-01-01":(b=!1,l=!1,!isNaN(parseInt(me[1]))&&parseInt(me[1])>12?l=me[1].toString():b=me[1].toString(),2===me.length&&(!1!==l?b=me[2].toString():l=me[2].toString()),k+="-"+(b=!1===b?"01":1===b.length?"0"+b:b)+"-"+(l=!1===l?"01":1===l.length?"0"+l:l)),null==de.published&&(de.published=k);break}}}catch(e){}}try{if(null==de.author&&(null!=e.author||null!=e.z_authors))for(null==de.author&&(de.author=[]),X=null!=(G=e.author)?G:e.z_authors,x=0,f=X.length;x<f;x++)"string"==typeof(t=X[x])?de.author.push({name:t}):(null!=t.affiliation&&(Array.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),de.author.push(t))}catch(e){}try{(null!=(H=e.best_oa_location)?H.license:void 0)&&null!==(null!=(K=e.best_oa_location)?K.license:void 0)&&null==de.licence&&(de.licence=e.best_oa_location.license)}catch(e){}if(Array.isArray(e.assertion))for(A=0,m=(Z=e.assertion).length;A<m;A++)"OPEN ACCESS"===(t=Z[A]).label&&t.URL&&-1!==t.URL.indexOf("creativecommons")&&null==de.licence&&(de.licence=t.URL);if(Array.isArray(e.license))for(j=0,y=(te=null!=(ee=e.license)?ee:[]).length;j<y;j++)!(h=te[j]).URL||-1===h.URL.indexOf("creativecommons")||rec.licence&&-1!==rec.licence.indexOf("creativecommons")||null==de.licence&&(de.licence=h.URL);"string"==typeof e.license&&null==de.licence&&(de.licence=e.license),"string"==typeof de.licence&&-1!==de.licence.indexOf("/licenses/")&&(de.licence="cc-"+rec.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-")),null==de.url&&(de.url=null!=(ie=null!=(re=null!=(ne=e.best_oa_location)?ne.url_for_pdf:void 0)?re:null!=(se=e.best_oa_location)?se.url:void 0)?ie:e.url)}else if("string"==typeof e)try{-1!==(e=e.replace(/citation\:/gi,"").trim()).indexOf("title")&&(e=e.split("title")[1].trim()),-1!==(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).indexOf("doi:")&&(de.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),-1!==e.indexOf("doi.org/")&&(de.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),de.doi||-1===e.indexOf("http")||(de.url="http"+e.split("http")[1].split(" ")[0].trim());try{-1===e.indexOf("|")&&-1===e.indexOf("}")||(de.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?de.title=e.split('"')[1].trim():e.split("'").length>2&&null==de.title&&(de.title=e.split("'")[1].trim())}catch(e){}try{for(S=e.replace(/,\./g," ").split(" "),ge=0,g=S.length;ge<g;ge++)q=S[ge],de.year||4===(q=q.replace(/[^0-9]/g,"")).length&&("number"!=typeof(ve=parseInt(q))||isNaN(ve)||(de.year=ve))}catch(e){}try{!de.title&&de.year&&e.indexOf(de.year)<e.length/4&&(de.title=e.split(de.year)[1].trim(),(-1===de.title.indexOf("(")||de.title.indexOf(")")<de.title.indexOf("("))&&(de.title=de.title.replace(")","")),de.title.indexOf(".")<3&&(de.title=de.title.replace(".","")),de.title.indexOf(",")<3&&(de.title=de.title.replace(",","")),de.title=de.title.trim(),-1!==de.title.indexOf(".")?de.title=de.title.split(".")[0]:-1!==de.title.indexOf(",")&&(de.title=de.title.split(",")[0]))}catch(e){}if(de.title){try{if(r=e.split(de.title)[0],de.year&&-1!==r.indexOf(de.year)&&(r=r.split(de.year)[0]),de.url&&r.indexOf(de.url)>0&&(r=r.split(de.url)[0]),de.url&&0===r.indexOf(de.url)&&(r=r.replace(de.url)),de.doi&&0===r.indexOf(de.doi)&&(r=r.replace(de.doi)),r.indexOf(".")<3&&(r=r.replace(".","")),r.indexOf(",")<3&&(r=r.replace(",","")),r.lastIndexOf("(")>r.length-3&&(r=r.substring(0,r.lastIndexOf("("))),r.lastIndexOf(")")>r.length-3&&(r=r.substring(0,r.lastIndexOf(")"))),r.lastIndexOf(",")>r.length-3&&(r=r.substring(0,r.lastIndexOf(","))),r.lastIndexOf(".")>r.length-3&&(r=r.substring(0,r.lastIndexOf("."))),(r=r.trim()).length>6)if(-1!==r.indexOf(","))for(de.author=[],le=r.split(","),be=0,v=le.length;be<v;be++)i=le[be],de.author.push({name:i});else de.author=[{name:r}]}catch(e){}try{fe=e.split(de.title)[1],de.url&&-1!==fe.indexOf(de.url)&&(fe=fe.replace(de.url)),de.doi&&-1!==fe.indexOf(de.doi)&&(fe=fe.replace(de.doi)),fe.indexOf(".")<3&&(fe=fe.replace(".","")),fe.indexOf(",")<3&&(fe=fe.replace(",","")),(fe=fe.trim()).length>6&&(de.journal=fe,-1!==fe.indexOf(",")&&(de.journal=de.journal.split(",")[0].replace(/in /gi,"").trim()),de.journal.indexOf(".")<3&&(de.journal=de.journal.replace(".","")),de.journal.indexOf(",")<3&&(de.journal=de.journal.replace(",","")),de.journal=de.journal.trim())}catch(e){}}try{if(de.journal&&(fe=e.split(de.journal)[1],de.url&&-1!==fe.indexOf(de.url)&&(fe=fe.replace(de.url)),de.doi&&-1!==fe.indexOf(de.doi)&&(fe=fe.replace(de.doi)),fe.indexOf(".")<3&&(fe=fe.replace(".","")),fe.indexOf(",")<3&&(fe=fe.replace(",","")),(fe=fe.trim()).length>4)){if(-1!==fe.indexOf("retrieved")&&(fe=fe.split("retrieved")[0]),-1!==fe.indexOf("Retrieved")&&(fe=fe.split("Retrieved")[0]),de.volume=fe,-1!==de.volume.indexOf("(")){de.volume=de.volume.split("(")[0],de.volume=de.volume.trim();try{de.issue=fe.split("(")[1].split(")")[0],de.issue=de.issue.trim()}catch(e){}}if(-1!==de.volume.indexOf(",")){de.volume=de.volume.split(",")[0],de.volume=de.volume.trim();try{de.issue=fe.split(",")[1],de.issue=de.issue.trim()}catch(e){}}if(de.volume)try{isNaN(parseInt(de.volume))&&delete de.volume}catch(e){}if(de.issue){-1!==de.issue.indexOf(",")&&(de.issue=de.issue.split(",")[0].trim());try{isNaN(parseInt(de.issue))&&delete de.issue}catch(e){}}if(de.volume&&de.issue)try{-1!==(fe=e.split(de.journal)[1]).indexOf("retriev")&&(fe=fe.split("retriev")[0]),-1!==fe.indexOf("Retriev")&&(fe=fe.split("Retriev")[0]),de.url&&-1!==fe.indexOf(de.url)&&(fe=fe.split(de.url)[0]),de.doi&&-1!==fe.indexOf(de.doi)&&(fe=fe.split(de.doi)[0]),(fe=(fe=fe.substring(fe.indexOf(de.volume)+(de.volume+"").length)).substring(fe.indexOf(de.issue)+(de.issue+"").length)).indexOf(".")<2&&(fe=fe.replace(".","")),fe.indexOf(",")<2&&(fe=fe.replace(",","")),fe.indexOf(")")<2&&(fe=fe.replace(")","")),fe=fe.trim(),isNaN(parseInt(fe.substring(0,1)))||(de.pages=fe.split(" ")[0].split(".")[0].trim(),de.pages.length>5&&(de.pages=de.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(de.author||-1===e.indexOf("et al")||(s=e.split("et al")[0].trim(),0===e.indexOf(s)&&(de.author=[{name:s+"et al"}])),de.title&&!de.volume)try{-1!==(n=e.split(de.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).indexOf("vol")&&(de.volume=n.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),de.issue||-1===n.indexOf("iss")||(de.issue=n.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),de.pages||-1===n.indexOf("page")||(de.pages=n.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return de};a=[].indexOf;r.svc.oaworks.ill=async function(){var e,t,i,r,n,s,l,o,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A;for(d in y=this.params,this.user&&(null==y.from&&(y.from=this.user._id),y.api=!0),null==(y=await this.tdm.clean(y)).metadata&&(y.metadata={}),f=this.svc.oaworks.metadata(y))null==(n=y.metadata)[d]&&(n[d]=f[d]);if(!0===y.pilot&&(y.pilot=Date.now()),!0===y.live&&(y.live=Date.now()),"imperial"===y.library)return y.forwarded||y.resolved||(this.mail({service:"openaccessbutton",from:"natalia.norori@openaccessbutton.org",to:["joe@righttoresearch.org","s.barron@imperial.ac.uk"],subject:"EXAMPLE ILL TRIGGER",text:JSON.stringify(y,void 0,2)}),this.waitUntil(this.fetch("https://www.imperial.ac.uk/library/dynamic/oabutton/oabutton3.php",{body:y,method:"POST"}))),y;if(null!=y.from||null!=y.config){if("anonymous"!==y.from&&(S=this.auth(y.from)),null!=S||null!=y.config){for(m in(s=y.config).requests&&null==s.requests_off&&(s.requests_off=s.requests),null!=y.config&&delete y.config,(A={}).name=null!=(b=null!=S&&null!=(_=S.profile)?_.firstname:void 0)?b:"librarian",A.details="",g=["title","author","volume","issue","date","pages"],y)if("metadata"===m){for(d in y[m])"email"!==d&&(y[d]=y[m][d],a.call(g,d)<0&&g.push(d));delete y.metadata}else a.call(g,m)<0&&g.push(m);for(u=0,c=g.length;u<c;u++)if(y[v=g[u]])if(A[v]=y[v],"author"===v){for(r="<p>Authors:<br>",o=!0,i=[],h=0,p=(w=y[v]).length;h<p;h++)(e=w[h]).family&&(o?o=!1:r+=", ",r+=t=e.family+(e.given?" "+e.given:""),i.push(t));A.details+=r+"</p>",A[v]=i}else-1===["started","ended","took"].indexOf(v)&&(A.details+="<p>"+v+":<br>"+y[v]+"</p>");return s.requests_off&&(y.requests_off=!0),null!=y.author&&delete y.author,null!=(null!=(x=y.metadata)?x.author:void 0)&&delete y.metadata.author,A.details+="<p>Open access button ILL ID:<br>"+A.illid+"</p>",l=s.email&&s.email.length?s.email:!!(null!=S?S.email:void 0)&&(null!=S?S.email:void 0),s.search&&s.search.length&&(y.issn||y.journal)&&(-1!==s.search.indexOf("worldcat")?(k=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",k+=null!=y.issn?"in%3A":"ti%3A",k+="&si0qs="+(null!=(O=y.issn)?O:y.journal),k+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(k=s.search,k+=y.issn?y.issn:y.journal),A.details+='<p>Search URL:<br><a href="'+k+'">'+k+"</a></p>",A.worldcatsearchurl=k),y.forwarded||y.resolved||!l||this.svc.oaworks.mail({vars:A,template:{filename:"instantill_create.html"},to:l,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+A.illid}),q=A.details,delete A.details,q+="<br><br>"+JSON.stringify(A,void 0,2),this.mail({service:"openaccessbutton",from:"InstantILL <InstantILL@openaccessbutton.org>",to:["mark@cottagelabs.com","joe@righttoresearch.org"],subject:"ILL CREATED",html:q,text:q}),A.illid}return{status:401}}return{status:404}},r.svc.oaworks.ill.collect=function(){var e,t;for(e in t="https://script.google.com/macros/s/"+this.params.collect+"/exec?",this.params)"collect"!==e&&(t+=e+"="+this.params[e]+"&");return t+="uuid="+this.uid(),this.waitUntil(this.fetch(t)),!0},r.svc.oaworks.ill.openurl=async function(){var e,t,i,r,n,s,l,o,a,u,h,c,p,d,f;if(null!=(u=this.params).config&&(null==u.uid&&(u.uid=u.config),delete u.config),null!=u.metadata){for(o in u.metadata)null==u[o]&&(u[o]=u.metadata[o]);delete u.metadata}if(u.uid||null!=this.user){if(null==(t="object"==typeof(p=null!=(h=(u=await this.tdm.clean(u)).uid)?h:this.user._id)?p:void 0)&&(t={}),t.ill_redirect_base_url&&null==t.ill_form&&(t.ill_form=t.ill_redirect_base_url),t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),!0!==withoutbase&&!t.ill_form)return"";for(i in r={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})t[i]||(t[i]=r[i]);for(s in d=t.ill_form?t.ill_form:"",d+=-1===d.indexOf("?")?"?":"&",t.ill_added_params&&(d+=t.ill_added_params.replace("?","")+"&"),d+=t.sid+"=InstantILL&",meta){if(f=!1,"author"===s)try{if("string"==typeof meta.author)f=meta.author;else if(Array.isArray(meta.author))for(f="",c=meta.author,n=0,l=c.length;n<l;n++)e=c[n],f.length&&(f+=", "),"string"==typeof e?f+=e:e.family&&(f+=e.family+(e.given?", "+e.given:""));else f=meta.author.family?meta.author.family+(meta.author.given?", "+meta.author.given:""):JSON.stringify(meta.author)}catch(e){}else"doi"!==s&&"pmid"!==s&&"pmc"!==s&&"pmcid"!==s&&"url"!==s&&"journal"!==s&&"title"!==s&&"year"!==s&&"issn"!==s&&"volume"!==s&&"issue"!==s&&"page"!==s&&"crossref_type"!==s&&"publisher"!==s&&"published"!==s&&"notes"!==s||(f=meta[s]);f&&(d+=(t[s]?t[s]:s)+"="+encodeURIComponent(f)+"&")}return meta.usermetadata&&(a=t.notes?t.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(a+"=")?d+="&"+a+"=The user provided some metadata.":d=d.replace(a+"=",a+"=The user provided some metadata. ")),d.replace("/&&/g","&")}return{status:404}},r.svc.oaworks.ill.subscription=async function(e,t){var i,r,n,s,l,o,a,u,h,c,p,d,f,m,y,g,v,b;if(null==e&&(e=null!=(o=this.user)?o:this.params.uid),null==t&&delete(t=JSON.parse(JSON.stringify(this.params))).uid,!0,!0,p={findings:{},lookups:[],error:[],contents:[]},"string"==typeof e?(p.uid=e,i=null!=(b=this.auth(e))&&null!=(a=b.service)&&null!=(u=a.openaccessbutton)&&null!=(h=u.ill)?h.config:void 0):i=e,null!=(null!=i?i.subscription:void 0))for(d in i.ill_redirect_params&&null==i.ill_added_params&&(i.ill_added_params=i.ill_redirect_params),s=this.svc.oaworks.ill.openurl(i,t,!0),i.ill_added_params&&(s=s.replace(i.ill_added_params.replace("?",""),"")),-1!==s.indexOf("?")&&(s=s.split("?")[1]),"string"==typeof i.subscription&&(i.subscription=i.subscription.split(",")),"string"==typeof i.subscription_type&&(i.subscription_type=i.subscription_type.split(",")),null==i.subscription_type&&(i.subscription_type=[]),i.subscription)if("object"==typeof(m=i.subscription[d])?(y=m.type,m=m.url):y=null!=(c=i.subscription_type[d])?c:"unknown",m=m.trim()){"serialssolutions"!==y&&-1===m.indexOf("serialssolutions")||-1!==m.indexOf(".xml.")?"sfx"!==y&&-1===m.indexOf("sfx.")||-1!==m.indexOf("sfx.response_type=simplexml")||(m+=(-1===m.indexOf("?")?"?":"&")+"sfx.response_type=simplexml"):(-1!==(g=m.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),m="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"),-1!==(v=m+(-1===m.indexOf("?")?"?":"&")+s).indexOf("snc.idm.oclc.org/login?url=")&&(v=v.split("snc.idm.oclc.org/login?url=")[1]),v=v.replace("cache=true",""),("sfx"===y||-1!==m.indexOf("sfx.")&&-1!==v.indexOf("=10."))&&(v=v.replace("=10.","=doi:10.")),l="",f="",r=!1,p.lookups.push(v);try{f=-1!==(l=-1!==v.indexOf(".xml.serialssolutions")||-1!==v.indexOf("sfx.response_type=simplexml")?await this.fetch(v):await this.puppet(v)).indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,p.contents.push(f)}catch(e){e,r=!0}if("sfx"===y||-1!==v.indexOf("sfx.")){if(r&&p.error.push("sfx"),-1!==f.indexOf("getFullTxt")&&-1!==f.indexOf("<target_url>"))try{if(p.url=f.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),p.findings.sfx=p.url,null!=p.url){if(-1===p.url.indexOf("getitnow"))return p.found="sfx",p;p.url=void 0,p.findings.sfx=void 0}}catch(e){}}else if("eds"===y||-1!==v.indexOf("ebscohost.")){if(r&&p.error.push("eds"),-1!==f.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(p.url=v.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],p.findings.eds=p.url,null!=p.url)){if(-1===p.url.indexOf("getitnow"))return p.found="eds",p;p.url=void 0}}else if(("serialssolutions"===y||-1!==v.indexOf("serialssolutions."))&&(r&&p.error.push("serialssolutions"),-1!==f.indexOf('<ssopenurl:url type="article">')&&(n=f.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim()).length&&(p.url=n,p.findings.serials=p.url,null!=p.url))){if(-1===p.url.indexOf("getitnow"))return p.found="serials",p;p.url=void 0,p.findings.serials=void 0}}return p};a=[].indexOf;r.svc.oaworks.permissions=async function(e,t,i){var r,s,l,o,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,he,ce,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,qe,Se,Ae,je,Ee,Re,Te,Le,Ce;if(D=!1,c=!1,m=!1,null==e&&(e=this.copy(this.params)),null!=(null!=e?e.permissions:void 0)&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):0===e.permissions.indexOf("10.")&&-1!==e.permissions.indexOf("/")?e.doi=e.permissions:0!==e.permissions.indexOf("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.publisher=e.permissions,delete e.permissions),s=async function(t){var i,r,s,l,o,a,u,h,p,d,f,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L;if(m&&t.embargo_months&&(e.published||e.year)&&(r=(r=moment(null!=(g=e.published)?g:e.year+"-01-01")).add(t.embargo_months,"months"),t.embargo_end=r.format("YYYY-MM-DD")),""===t.embargo_end&&delete t.embargo_end,t.copyright_name="publisher"===t.copyright_owner?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:"journal"===(v=t.copyright_owner)||"affiliation"===v?null!=(k=e.journal)?k:"":t.copyright_owner&&-1!==t.copyright_owner.toLowerCase().indexOf("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(q=e.author[0].name)?q:e.author[0].family)+(e.author.length>1?" et al":""):"",("publisher"===(S=t.copyright_name)||"journal"===S)&&(c||e.doi||(null!=(A=t.provenance)?A.example:void 0))&&(!1===c&&(c=await this.src.crossref.works(null!=(j=e.doi)?j:t.provenance.example)),null!=(null!=c?c.assertion:void 0)&&c.assertion.length))for(o=0,u=(E=c.assertion).length;o<u;o++)if("copyright"===(i=E[o]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&-1!==t.deposit_statement.indexOf("<<")){for(l="",a=0,h=(R=t.deposit_statement.split("<<")).length;a<h;a++)if(y=R[a],""===l&&-1===y.indexOf(">>"))l+=y;else{if(null!=(L={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[f=(s=y.split(">>"))[0].toLowerCase()]&&(f=L[f]),"author"===f)try{l+=(null!=(T=e.author[0].name)?T:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else l+=null!=(b=null!=(_=e[f])?_:t[f])?b:"";try{l+=s[1]}catch(e){}}t.deposit_statement=l}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(n.dev?"dev.api.cottagelabs.com/svc/oaworks/permissions/":"api.openaccessbutton.org/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(w=t.issuer)?w.has_policy:void 0)||"not publisher"!==(x=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==x||(D=t.issuer.has_policy),d=0,p=(O=["_id","permission_required","createdAt","updatedAt","created_date","updated_date"]).length;d<p;d++)delete t[O[d]];try{delete t.issuer.updatedAt}catch(e){}return t},l=e=>{var t,i,r,n,s,l,o;return o=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(o+=1e3),null!=e.requirements?o-=10:o+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,null!=e.licences&&e.licences.length&&(o-=5),o+="journal"===(null!=(i=e.issuer)?i.type:void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type:void 0)?4:"university"===(null!=(n=e.issuer)?n.type:void 0)?3:(s=null!=(l=e.issuer)?l.type:void 0,a.call("article",s)>=0?2:0),e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||moment(e.embargo_end,"YYYY-MM-DD").isBefore(moment()))&&(o-=25),o},{},"string"==typeof e&&(e=0===e.indexOf("10.")?{doi:e}:{issn:e}),null!=e.meta&&delete e.meta,null!=e.metadata&&(e,e=e.metadata),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),e.journal&&-1===e.journal.indexOf(" ")&&(e.issn=e.journal,delete e.journal),e.publisher&&-1===e.publisher.indexOf(" ")&&-1===e.publisher.indexOf(",")&&!oab_permissions.find('issuer.type.exact:"publisher" AND issuer.id:"'+e.publisher+'"')&&(e.ror=e.publisher,delete e.publisher),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&-1!==e.issn.indexOf(",")&&(e.issn=e.issn.split(",")),"string"==typeof e.ror&&-1!==e.ror.indexOf(",")&&(e.ror=e.ror.split(",")),e.ror||("object"==typeof(Ee="object"==typeof t?t:"string"==typeof t?this.svc.oaworks.deposit.config(t):void 0)&&null!=Ee.ror||"string"==typeof t)&&(e.ror=null!=($=null!=Ee?Ee.ror:void 0)?$:t),"{}"===JSON.stringify(e)||e.issn&&-1===JSON.stringify(e.issn).indexOf("-")||e.doi&&("string"!=typeof e.doi||0!==e.doi.indexOf("10.")||-1===e.doi.indexOf("/")))return{body:"No valid DOI, ISSN, or ROR provided",statusCode:404};if(r=()=>{var t,i,r,n;if(delete(i=this.copy(e)).ror,"{}"!==JSON.stringify(i)){for(t in r=[],n=this.svc.oaworks.metadata({metadata:["crossref_type","issn","publisher","published","year","author","ror"]},i))r.push(null!=e[t]?e[t]:e[t]=n[t]);return r}},!1===i||!e.doi||e.publisher&&e.issn||await r(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,o=!1,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(y=0,x=(G=e.issn).length;y<x;y++)g=G[y],a.call(v,g)<0&&v.push(g);if((!v.length||!e.publisher||!e.doi)&&(o=academic_journal.find('issn.exact:"'+v.join('" OR issn.exact:"')+'"'))){for(null==e.publisher&&(e.publisher=o.publisher),b=0,O=(se="string"==typeof o.issn?[o.issn]:o.issn).length;b<O;b++)h=se[b],a.call(v,h)<0&&v.push(h);null==e.doi&&(e.doi=o.doi)}try{null==e.doi&&(e.doi=await this.src.crossref.journals.doi(v))}catch(t){null==e.doi&&(e.doi=await this.src.crossref.journals.dois.example(v))}!m&&e.doi&&await r()}if(m&&"journal-article"!==e.crossref_type)return{body:"DOI is not a journal article",status:501};e.publisher&&-1!==e.publisher.indexOf("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(pe=e.page)?pe:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(de=e.year)?de:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(B={best_permission:void 0,all_permissions:[]},be=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(we=oab_permissions.search('issuer.id.exact:"'+e.ror.join('" OR issuer.id.exact:"')+'"'))&&null!=(fe=we.hits)?fe.total:void 0)&&(xe=wikidata_record.find('snaks.property.exact:"P6782" AND snaks.property.exact:"P17" AND (snaks.value.exact:"'+e.ror.join(" OR snaks.value.exact:")+'")')))for(qe=!1,P=0,q=(me=xe.snaks).length;P<q&&(ke=me[P],!qe);P++)if("P17"===ke.property&&(p=wikidata_record.get(ke.qid)))for(N=0,S=(ye=p.snaks).length;N<S;N++)if("P297"===(Oe=ye[N]).property){qe=!0,we=oab_permissions.search('issuer.id.exact:"'+Oe.value+'"');break}for(U=0,A=(H=null!=(ge=null!=we&&null!=(X=we.hits)?X.hits:void 0)?ge:[]).length;U<A;U++)(Ae=s(H[U]._source)).score=l(Ae),be.push(Ae)}if((v.length||e.publisher)&&(V=v.length?'issuer.id.exact:"'+v.join('" OR issuer.id.exact:"')+'"':"",e.publisher&&(""!==V&&(V+=" OR "),V+='issuer.id:"'+e.publisher+'"'),null!=(null!=(z=oab_permissions.search(V))&&null!=(K=z.hits)?K.hits:void 0)&&z.hits.hits.length))for(W=0,j=(Q=z.hits.hits).length;W<j;W++)(_e=s(Q[W]._source)).score=l(_e),B.all_permissions.push(_e);if(0!==B.all_permissions.length||!e.publisher||e.doi||v.length||(null==(o=academic_journal.find('publisher:"'+e.publisher+'"'))&&((f=academic_journal.find('publisher:"'+e.publisher.split(" ").join(' AND publisher:"')+'"')).publisher===e.publisher?o=f:(C=(I=this.tdm.levenshtein(f.publisher,e.publisher,!0)).length.a>I.length.b?I.length.a:I.length.b,(I.distance<5||C/I.distance>10)&&(o=f))),"object"==typeof o&&o.is_oa&&(J=academic_journal.count('publisher:"'+o.publisher+'"')===academic_journal.count('publisher:"'+o.publisher+'" AND is_oa:true')),o.is_oa&&J||(o=!1)),"object"==typeof o&&!1!==o.is_oa&&(null==o.is_oa&&(a.call(o.src,"doaj")>=0||o.wikidata_in_doaj)&&(o.is_oa=!0),o.is_oa)){u={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,licence_terms:"",licences:[],locations:["institutional repository"],embargo_months:void 0,issuer:{type:"journal",has_policy:"yes",id:o.issn},meta:{creator:["joe+doaj@openaccessbutton.org"],contributors:["joe+doaj@openaccessbutton.org"],monitoring:"Automatic"}};try{u.licence=o.license[0].type}catch(e){}null==u.licence&&(u.licence=o.licence),(a.call(o.src,"doaj")>=0||o.wikidata_in_doaj)&&(u.embargo_months=0,u.provenance={oa_evidence:"In DOAJ"}),"string"==typeof u.licence?(u.licence=u.licence.toLowerCase().trim(),0===u.licence.indexOf("cc")?u.licence=u.licence.replace(/ /g,"-"):-1!==u.licence.indexOf("creative")?u.licence=-1!==u.licence.indexOf("0")||-1!==u.licence.indexOf("zero")?"cc0":-1!==u.licence.indexOf("share")?"ccbysa":-1!==u.licence.indexOf("derivative")?"ccbynd":"ccby":delete u.licence):delete u.licence,u.licence&&(u.licences=[{type:u.licence,terms:""}]),u.score=l(u),B.all_permissions.push(u)}if(m&&e.doi&&(Y=await this.src.oadoi(e.doi))&&(null!=Y&&null!=(Z=Y.best_oa_location)?Z.license:void 0)&&-1!==Y.best_oa_location.license.indexOf("cc")&&("string"==typeof(d={can_archive:!0,version:Y.best_oa_location.version,versions:[],licence:Y.best_oa_location.license,licence_terms:"",licences:[],locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:["support@unpaywall.org"],contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:Y.best_oa_location.updated},provenance:{oa_evidence:Y.best_oa_location.evidence}}).licence&&(d.licences=[{type:d.licence,terms:""}]),d.version&&(d.versions="submittedVersion"===(ee=d.version)||"preprint"===ee?["submittedVersion"]:"acceptedVersion"===(te=d.version)||"postprint"===te?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),d.score=l(d),B.all_permissions.push(d)),B.all_permissions.length){for(B.all_permissions.sort((e,t)=>e.score>t.score?1:-1),F=0,E=(ie=B.all_permissions).length;F<E;F++){if(!(null!=(re=(Ce=ie[F]).provenance)?re.enforcement_from:void 0)){B.best_permission=this.copy(Ce);break}if(!e.published||moment(e.published,"YYYY-MM-DD").isAfter(moment(Ce.provenance.enforcement_from,"DD/MM/YYYY"))){B.best_permission=this.copy(Ce);break}}if(be.length)for(be.sort((e,t)=>e.score>t.score?1:-1),Se=0,R=be.length;Se<R;Se++)if(ve=be[Se],B.all_permissions.push(ve),null==(null!=(ne=B.best_permission)?ne.author_affiliation_requirement:void 0)&&null!=B.best_permission&&(!(null!=(le=ve.provenance)?le.enforcement_from:void 0)||!e.published||moment(e.published,"YYYY-MM-DD").isAfter(moment(ve.provenance.enforcement_from,"DD/MM/YYYY")))){for(M=this.copy(B.best_permission),je=0,T=(oe=["licences","versions","locations"]).length;je<T;je++)for(Re=0,L=(ae=ve[_=oe[je]]).length;Re<L;Re++)Te=ae[Re],null==M[_]&&(M[_]=[]),a.call(M[_],Te)<0&&M[_].push(Te);for(Le=0,k=(he=null!=(ue=M.licences)?ue:[]).length;Le<k;Le++)w=he[Le],(null==M.licence||w.type.length<M.licence.length)&&(M.licence=w.type);M.version=a.call(M.versions,"publishedVersion")>=0||a.call(M.versions,"publisher pdf")>=0?"publishedVersion":a.call(M.versions,"acceptedVersion")>=0||a.call(M.versions,"postprint")>=0?"acceptedVersion":"submittedVersion",M.embargo_end&&ve.embargo_end&&moment(ve.embargo_end,"YYYY-MM-DD").isBefore(moment(M.embargo_end,"YYYY-MM-DD"))&&(M.embargo_end=ve.embargo_end),M.embargo_months&&null!=ve.embargo_months&&ve.embargo_months<M.embargo_months&&(M.embargo_months=ve.embargo_months),!0===ve.can_archive&&(M.can_archive=!0),null==M.requirements&&(M.requirements={}),M.requirements.author_affiliation_requirement=null==e.ror?ve.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],M.issuer.affiliation=ve.issuer,null==M.meta&&(M.meta={}),M.meta.affiliation=ve.meta,null==M.provenance&&(M.provenance={}),M.provenance.affiliation=ve.provenance,M.score=parseInt(M.score)+parseInt(ve.score),B.best_permission=M,B.all_permissions.push(M)}}return D?{body:"string"!=typeof D?D:null!=(ce={"not publisher":"Please find another DOI for this article as this is provided as this doesn’t allow us to find required information like who published it"}[D.toLowerCase()])?ce:D,status:501}:B},r.svc.oaworks.permission=function(e=[]){var t,i,r,n,s,l,o,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j,E,R,T,L,C,I,P,N,U,Y,D,M,B,J;for(u={versionsarchivable:"versions",permissionsrequestcontactemail:"permissions_contact",archivinglocationsallowed:"locations",license:"licence",licencesallowed:"licences","post-printembargo":"embargo_months",depositstatementrequired:"deposit_statement",copyrightowner:"copyright_owner",publicnotes:"notes",authoraffiliationrolerequirement:"requirements.role",authoraffiliationrequirement:"requirements.affiliation",authoraffiliationdepartmentrequirement:"requirements.departmental_affiliation",iffundedby:"requirements.funder",fundingproportionrequired:"requirements.funding_proportion",subjectcoverage:"requirements.subject",has_policy:"issuer.has_policy",permissiontype:"issuer.type",parentpolicy:"issuer.parent_policy",contributedby:"meta.contributors",recordlastupdated:"meta.updated",reviewers:"meta.reviewer",addedby:"meta.creator",monitoringtype:"meta.monitoring",policyfulltext:"provenance.archiving_policy",policylandingpage:"provenance.archiving_policy_splash",publishingagreement:"provenance.sample_publishing_agreement",publishingagreementsplash:"provenance.sample_publishing_splash",rights:"provenance.author_rights",embargolist:"provenance.embargo_list",policyfaq:"provenance.faq",miscsource:"provenance.misc_source",enforcementdate:"provenance.enforcement_from",example:"provenance.example"},T=[],s=0,d=e.length;s<d;s++){L=e[s],S={can_archive:!1,version:void 0,versions:void 0,licence:void 0,licence_terms:void 0,licences:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,permission_required:void 0,permissions_contact:void 0,copyright_owner:void 0,copyright_name:void 0,copyright_year:void 0,notes:void 0,requirements:void 0,issuer:{},meta:{},provenance:void 0};try{if(L.recordlastupdated=L.recordlastupdated.trim(),-1!==L.recordlastupdated.indexOf(",")){for(x=!1,C=L.recordlastupdated.split(","),l=0,f=C.length;l<f;l++)n=C[l],(!1===x||moment(n.trim(),"DD/MM/YYYY").isAfter(moment(x,"DD/MM/YYYY")))&&(x=n.trim());!1!==x&&(L.recordlastupdated=x)}S.meta.updated=L.recordlastupdated}catch(e){}if(null!=S.meta.updated&&(S.meta.updatedAt=moment(S.meta.updated,"DD/MM/YYYY").valueOf()),S.issuer.id=-1!==L.id.indexOf(",")?L.id.split(","):L.id,"string"!=typeof S.issuer.id){for(r=[],!1,b=0,m=(I=S.issuer.id).length;b<m;b++){if(O=(O=I[b]).trim(),"journal"===S.issuer.type&&-1!==O.indexOf("-")&&-1===O.indexOf(" ")&&(O=O.toUpperCase(),t=academic_journal.find('issn.exact:"'+O+'"')))for(!0,_=0,y=(P=t.issn).length;_<y;_++)i=P[_],a.call(r,i)<0&&r.push(i);a.call(r,O)<0&&r.push(O)}S.issuer.id=r}for(o in S.permission_required=null!=L.has_policy&&-1!==L.has_policy.toLowerCase().indexOf("permission required"),L)if(u[o]&&null!=L[o]&&0!==L[o].length){if(k=u[o],A=void 0,"post-printembargo"===o)try{"number"!=typeof(h=parseInt(L[o].trim()))||isNaN(h&&0!==h)||(A=h),null!=A&&(S.embargo_end="")}catch(e){}else if("journal"===o||"versionsarchivable"===o||"archivinglocationsallowed"===o||"licencesallowed"===o||"policyfulltext"===o||"contributedby"===o||"addedby"===o||"reviewers"===o||"iffundedby"===o)for(A=[],j=0,g=(N=R=L[o].trim().split(",")).length;j<g;j++)if(J=(B=N[j]).trim(),"licencesallowed"===o){if("unclear"!==J.toLowerCase()){p={type:J.toLowerCase()};try{p.terms=L.licenceterms.split(",")[R.indexOf(B)].trim()}catch(e){}A.push(p)}}else"versionsarchivable"===o&&("preprint"===(J=J.toLowerCase())&&(J="submittedVersion"),"postprint"===J&&(J="acceptedVersion"),"publisher pdf"===J&&(J="publishedVersion")),J.length&&a.call(A,J)<0&&A.push("archivinglocationsallowed"===o?J.toLowerCase():J);else"recordlastupdated"!==o&&(A=L[o].trim());"string"!=typeof A||"yes"!==(U=A.toLowerCase())&&"no"!==U&&"haspolicy"!==o&&"permissiontype"!==o&&"copyrightowner"!==o||(A=A.toLowerCase()),"copyrightowner"!==o&&"license"!==o||"unclear"!==A||(A=""),null!=A&&(-1!==k.indexOf(".")?(null==S[w=(q=k.split("."))[0]]&&(S[w]={}),S[q[0]][[q[1]]]=A):S[k]=A)}if(null==S.licences&&(S.licences=[]),!S.licence)for(E=0,v=(Y=S.licences).length;E<v;E++)c=Y[E],(null==S.licence||c.type.length<S.licence.length)&&(S.licence=c.type,S.licence_terms=c.terms);null==S.versions&&(S.versions=[]),S.versions.length&&(S.can_archive=!0,S.version=a.call(S.versions,"acceptedVersion")>=0||a.call(S.versions,"postprint")>=0?"acceptedVersion":a.call(S.versions,"publishedVersion")>=0||a.call(S.versions,"publisher pdf")>=0?"publishedVersion":"submittedVersion"),null==S.copyright_owner&&(S.copyright_owner=null!=(D=null!=(M=S.issuer)?M.type:void 0)?D:""),null==S.copyright_name&&(S.copyright_name=""),null==S.copyright_year&&(S.copyright_year=""),"{}"!==!JSON.stringify(S)&&T.push(S)}return T.length&&(oab_permissions.remove("*"),oab_permissions.insert(T)),T.length},r.svc.oaworks.permission._sheet="1qBb0RV1XgO3xOQMdHJBAf3HCJlUgsXqDVauWAtxde4A",r.svc.oaworks.scrape=async function(e,t){var i,r,n,s,l,o,a,u,h,c,p,d,f,m,y,g,v,b,_,w,x,O,k,q,S,A,j;if(f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(j=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&j.length>1&&9<j[1].length&&j[1].length<45&&-1!==j[1].indexOf("/")&&0===j[1].indexOf("10.")&&(f.doi=j[1]),null==e&&(e=await this.fetch(url))),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)for(r=0,s=0,a=(k=e.split(" ")).length;s<a;s++)if(A=k[s],(r+=1)<600&&(-1!==(A=A.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(A=A.split("doi.org")[1]),0===A.indexOf("/")&&(A=A.replace("/","")),0===(A=A.trim()).indexOf("10.")&&-1!==A.indexOf("/"))){f.doi=A;break}if(!f.doi)try{for(q=(n=this.tdm.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,o=0,u=q.length;o<u;o++)_=q[o],!f.doi&&9<n.matches[_].result[1].length&&n.matches[_].result[1].length<45&&(f.doi=n.matches[_].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),f.title||(-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))),f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"}).matches[0].result[1].split("-")).length)f.year=m[0];else for(w=0,h=m.length;w<h;w++)(b=m[w]).length>2&&(f.year=b)}catch(e){}if(!f.keywords)try{-1!==(l=this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"}).matches[0].result[1]).indexOf(";")?(l=l.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=l.split(";")):(l=l.replace(/, /g,",").replace(/ ,/g,","),f.keywords=l.split(","))}catch(e){}if(!f.email){y=[];try{for(S=this.tdm.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]}).matches,x=0,c=S.length;x<c;x++)(g=S[x].result[1].replace("mailto:","")).endsWith(".")&&(g=g.substring(0,g.length-1)),-1===y.indexOf(g)&&y.push(g)}catch(e){}for(y.sort((function(e,t){return t.length-e.length})),v="",f.email=[],O=0,p=y.length;O<p;O++)d=y[O],-1===v.indexOf(d)&&f.email.push(d),v+=d}return f},n.built="Mon Mar 08 2021 02:50:00 GMT+0000"}.call(this,i(3).Buffer,i(0))},function(e,t,i){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var r=i(4),n=i(5),s=i(6);function l(){return a.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function o(e,t){if(l()<t)throw new RangeError("Invalid typed array length");return a.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=a.prototype:(null===e&&(e=new a(t)),e.length=t),e}function a(e,t,i){if(!(a.TYPED_ARRAY_SUPPORT||this instanceof a))return new a(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return c(this,e)}return u(this,e,t,i)}function u(e,t,i,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,r){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,i):new Uint8Array(t,i,r);a.TYPED_ARRAY_SUPPORT?(e=t).__proto__=a.prototype:e=p(e,t);return e}(e,t,i,r):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!a.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var r=0|f(t,i),n=(e=o(e,r)).write(t,i);n!==r&&(e=e.slice(0,n));return e}(e,t,i):function(e,t){if(a.isBuffer(t)){var i=0|d(t.length);return 0===(e=o(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?o(e,0):p(e,t);if("Buffer"===t.type&&s(t.data))return p(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function h(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function c(e,t){if(h(t),e=o(e,t<0?0:0|d(t)),!a.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function p(e,t){var i=t.length<0?0:0|d(t.length);e=o(e,i);for(var r=0;r<i;r+=1)e[r]=255&t[r];return e}function d(e){if(e>=l())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l().toString(16)+" bytes");return 0|e}function f(e,t){if(a.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return M(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return B(e).length;default:if(r)return M(e).length;t=(""+t).toLowerCase(),r=!0}}function m(e,t,i){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,i);case"utf8":case"utf-8":return S(this,t,i);case"ascii":return A(this,t,i);case"latin1":case"binary":return j(this,t,i);case"base64":return q(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function g(e,t,i,r,n){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=n?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(n)return-1;i=e.length-1}else if(i<0){if(!n)return-1;i=0}if("string"==typeof t&&(t=a.from(t,r)),a.isBuffer(t))return 0===t.length?-1:v(e,t,i,r,n);if("number"==typeof t)return t&=255,a.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):v(e,[t],i,r,n);throw new TypeError("val must be string, number or Buffer")}function v(e,t,i,r,n){var s,l=1,o=e.length,a=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;l=2,o/=2,a/=2,i/=2}function u(e,t){return 1===l?e[t]:e.readUInt16BE(t*l)}if(n){var h=-1;for(s=i;s<o;s++)if(u(e,s)===u(t,-1===h?0:s-h)){if(-1===h&&(h=s),s-h+1===a)return h*l}else-1!==h&&(s-=s-h),h=-1}else for(i+a>o&&(i=o-a),s=i;s>=0;s--){for(var c=!0,p=0;p<a;p++)if(u(e,s+p)!==u(t,p)){c=!1;break}if(c)return s}return-1}function b(e,t,i,r){i=Number(i)||0;var n=e.length-i;r?(r=Number(r))>n&&(r=n):r=n;var s=t.length;if(s%2!=0)throw new TypeError("Invalid hex string");r>s/2&&(r=s/2);for(var l=0;l<r;++l){var o=parseInt(t.substr(2*l,2),16);if(isNaN(o))return l;e[i+l]=o}return l}function _(e,t,i,r){return J(M(t,e.length-i),e,i,r)}function w(e,t,i,r){return J(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function x(e,t,i,r){return w(e,t,i,r)}function O(e,t,i,r){return J(B(t),e,i,r)}function k(e,t,i,r){return J(function(e,t){for(var i,r,n,s=[],l=0;l<e.length&&!((t-=2)<0);++l)i=e.charCodeAt(l),r=i>>8,n=i%256,s.push(n),s.push(r);return s}(t,e.length-i),e,i,r)}function q(e,t,i){return 0===t&&i===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,i))}function S(e,t,i){i=Math.min(e.length,i);for(var r=[],n=t;n<i;){var s,l,o,a,u=e[n],h=null,c=u>239?4:u>223?3:u>191?2:1;if(n+c<=i)switch(c){case 1:u<128&&(h=u);break;case 2:128==(192&(s=e[n+1]))&&(a=(31&u)<<6|63&s)>127&&(h=a);break;case 3:s=e[n+1],l=e[n+2],128==(192&s)&&128==(192&l)&&(a=(15&u)<<12|(63&s)<<6|63&l)>2047&&(a<55296||a>57343)&&(h=a);break;case 4:s=e[n+1],l=e[n+2],o=e[n+3],128==(192&s)&&128==(192&l)&&128==(192&o)&&(a=(15&u)<<18|(63&s)<<12|(63&l)<<6|63&o)>65535&&a<1114112&&(h=a)}null===h?(h=65533,c=1):h>65535&&(h-=65536,r.push(h>>>10&1023|55296),h=56320|1023&h),r.push(h),n+=c}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return i}(r)}t.Buffer=a,t.SlowBuffer=function(e){+e!=e&&(e=0);return a.alloc(+e)},t.INSPECT_MAX_BYTES=50,a.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=l(),a.poolSize=8192,a._augment=function(e){return e.__proto__=a.prototype,e},a.from=function(e,t,i){return u(null,e,t,i)},a.TYPED_ARRAY_SUPPORT&&(a.prototype.__proto__=Uint8Array.prototype,a.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&a[Symbol.species]===a&&Object.defineProperty(a,Symbol.species,{value:null,configurable:!0})),a.alloc=function(e,t,i){return function(e,t,i,r){return h(t),t<=0?o(e,t):void 0!==i?"string"==typeof r?o(e,t).fill(i,r):o(e,t).fill(i):o(e,t)}(null,e,t,i)},a.allocUnsafe=function(e){return c(null,e)},a.allocUnsafeSlow=function(e){return c(null,e)},a.isBuffer=function(e){return!(null==e||!e._isBuffer)},a.compare=function(e,t){if(!a.isBuffer(e)||!a.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,r=t.length,n=0,s=Math.min(i,r);n<s;++n)if(e[n]!==t[n]){i=e[n],r=t[n];break}return i<r?-1:r<i?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,t){if(!s(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return a.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var r=a.allocUnsafe(t),n=0;for(i=0;i<e.length;++i){var l=e[i];if(!a.isBuffer(l))throw new TypeError('"list" argument must be an Array of Buffers');l.copy(r,n),n+=l.length}return r},a.byteLength=f,a.prototype._isBuffer=!0,a.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)y(this,t,t+1);return this},a.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},a.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},a.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?S(this,0,e):m.apply(this,arguments)},a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===a.compare(this,e)},a.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},a.prototype.compare=function(e,t,i,r,n){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===n&&(n=this.length),t<0||i>e.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&t>=i)return 0;if(r>=n)return-1;if(t>=i)return 1;if(this===e)return 0;for(var s=(n>>>=0)-(r>>>=0),l=(i>>>=0)-(t>>>=0),o=Math.min(s,l),u=this.slice(r,n),h=e.slice(t,i),c=0;c<o;++c)if(u[c]!==h[c]){s=u[c],l=h[c];break}return s<l?-1:l<s?1:0},a.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},a.prototype.indexOf=function(e,t,i){return g(this,e,t,i,!0)},a.prototype.lastIndexOf=function(e,t,i){return g(this,e,t,i,!1)},a.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}var n=this.length-t;if((void 0===i||i>n)&&(i=n),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var s=!1;;)switch(r){case"hex":return b(this,e,t,i);case"utf8":case"utf-8":return _(this,e,t,i);case"ascii":return w(this,e,t,i);case"latin1":case"binary":return x(this,e,t,i);case"base64":return O(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,i);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function A(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(127&e[n]);return r}function j(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(e[n]);return r}function E(e,t,i){var r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);for(var n="",s=t;s<i;++s)n+=D(e[s]);return n}function R(e,t,i){for(var r=e.slice(t,i),n="",s=0;s<r.length;s+=2)n+=String.fromCharCode(r[s]+256*r[s+1]);return n}function T(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function L(e,t,i,r,n,s){if(!a.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<s)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function C(e,t,i,r){t<0&&(t=65535+t+1);for(var n=0,s=Math.min(e.length-i,2);n<s;++n)e[i+n]=(t&255<<8*(r?n:1-n))>>>8*(r?n:1-n)}function I(e,t,i,r){t<0&&(t=4294967295+t+1);for(var n=0,s=Math.min(e.length-i,4);n<s;++n)e[i+n]=t>>>8*(r?n:3-n)&255}function P(e,t,i,r,n,s){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function N(e,t,i,r,s){return s||P(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function U(e,t,i,r,s){return s||P(e,0,i,8),n.write(e,t,i,r,52,8),i+8}a.prototype.slice=function(e,t){var i,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),a.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=a.prototype;else{var n=t-e;i=new a(n,void 0);for(var s=0;s<n;++s)i[s]=this[s+e]}return i},a.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r},a.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e+--t],n=1;t>0&&(n*=256);)r+=this[e+--t]*n;return r},a.prototype.readUInt8=function(e,t){return t||T(e,1,this.length),this[e]},a.prototype.readUInt16LE=function(e,t){return t||T(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUInt16BE=function(e,t){return t||T(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUInt32LE=function(e,t){return t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},a.prototype.readUInt32BE=function(e,t){return t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*t)),r},a.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=t,n=1,s=this[e+--r];r>0&&(n*=256);)s+=this[e+--r]*n;return s>=(n*=128)&&(s-=Math.pow(2,8*t)),s},a.prototype.readInt8=function(e,t){return t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},a.prototype.readInt16LE=function(e,t){t||T(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt16BE=function(e,t){t||T(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt32LE=function(e,t){return t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,t){return t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readFloatLE=function(e,t){return t||T(e,4,this.length),n.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,t){return t||T(e,4,this.length),n.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,t){return t||T(e,8,this.length),n.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,t){return t||T(e,8,this.length),n.read(this,e,!1,52,8)},a.prototype.writeUIntLE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||L(this,e,t,i,Math.pow(2,8*i)-1,0);var n=1,s=0;for(this[t]=255&e;++s<i&&(n*=256);)this[t+s]=e/n&255;return t+i},a.prototype.writeUIntBE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||L(this,e,t,i,Math.pow(2,8*i)-1,0);var n=i-1,s=1;for(this[t+n]=255&e;--n>=0&&(s*=256);)this[t+n]=e/s&255;return t+i},a.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,1,255,0),a.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},a.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,65535,0),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},a.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,65535,0),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},a.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,4294967295,0),a.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):I(this,e,t,!0),t+4},a.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,4294967295,0),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):I(this,e,t,!1),t+4},a.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);L(this,e,t,i,n-1,-n)}var s=0,l=1,o=0;for(this[t]=255&e;++s<i&&(l*=256);)e<0&&0===o&&0!==this[t+s-1]&&(o=1),this[t+s]=(e/l>>0)-o&255;return t+i},a.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);L(this,e,t,i,n-1,-n)}var s=i-1,l=1,o=0;for(this[t+s]=255&e;--s>=0&&(l*=256);)e<0&&0===o&&0!==this[t+s+1]&&(o=1),this[t+s]=(e/l>>0)-o&255;return t+i},a.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,1,127,-128),a.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},a.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,32767,-32768),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},a.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,32767,-32768),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},a.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,2147483647,-2147483648),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):I(this,e,t,!0),t+4},a.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):I(this,e,t,!1),t+4},a.prototype.writeFloatLE=function(e,t,i){return N(this,e,t,!0,i)},a.prototype.writeFloatBE=function(e,t,i){return N(this,e,t,!1,i)},a.prototype.writeDoubleLE=function(e,t,i){return U(this,e,t,!0,i)},a.prototype.writeDoubleBE=function(e,t,i){return U(this,e,t,!1,i)},a.prototype.copy=function(e,t,i,r){if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);var n,s=r-i;if(this===e&&i<t&&t<r)for(n=s-1;n>=0;--n)e[n+t]=this[n+i];else if(s<1e3||!a.TYPED_ARRAY_SUPPORT)for(n=0;n<s;++n)e[n+t]=this[n+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+s),t);return s},a.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!a.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{var l=a.isBuffer(e)?e:M(new a(e,r).toString()),o=l.length;for(s=0;s<i-t;++s)this[s+t]=l[s%o]}return this};var Y=/[^+\/0-9A-Za-z-_]/g;function D(e){return e<16?"0"+e.toString(16):e.toString(16)}function M(e,t){var i;t=t||1/0;for(var r=e.length,n=null,s=[],l=0;l<r;++l){if((i=e.charCodeAt(l))>55295&&i<57344){if(!n){if(i>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(l+1===r){(t-=3)>-1&&s.push(239,191,189);continue}n=i;continue}if(i<56320){(t-=3)>-1&&s.push(239,191,189),n=i;continue}i=65536+(n-55296<<10|i-56320)}else n&&(t-=3)>-1&&s.push(239,191,189);if(n=null,i<128){if((t-=1)<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function B(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Y,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,i,r){for(var n=0;n<r&&!(n+i>=t.length||n>=e.length);++n)t[n+i]=e[n];return n}}).call(this,i(0))},function(e,t,i){"use strict";t.byteLength=function(e){var t=u(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,r=u(e),l=r[0],o=r[1],a=new s(function(e,t,i){return 3*(t+i)/4-i}(0,l,o)),h=0,c=o>0?l-4:l;for(i=0;i<c;i+=4)t=n[e.charCodeAt(i)]<<18|n[e.charCodeAt(i+1)]<<12|n[e.charCodeAt(i+2)]<<6|n[e.charCodeAt(i+3)],a[h++]=t>>16&255,a[h++]=t>>8&255,a[h++]=255&t;2===o&&(t=n[e.charCodeAt(i)]<<2|n[e.charCodeAt(i+1)]>>4,a[h++]=255&t);1===o&&(t=n[e.charCodeAt(i)]<<10|n[e.charCodeAt(i+1)]<<4|n[e.charCodeAt(i+2)]>>2,a[h++]=t>>8&255,a[h++]=255&t);return a},t.fromByteArray=function(e){for(var t,i=e.length,n=i%3,s=[],l=0,o=i-n;l<o;l+=16383)s.push(h(e,l,l+16383>o?o:l+16383));1===n?(t=e[i-1],s.push(r[t>>2]+r[t<<4&63]+"==")):2===n&&(t=(e[i-2]<<8)+e[i-1],s.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return s.join("")};for(var r=[],n=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,a=l.length;o<a;++o)r[o]=l[o],n[l.charCodeAt(o)]=o;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function h(e,t,i){for(var n,s,l=[],o=t;o<i;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),l.push(r[(s=n)>>18&63]+r[s>>12&63]+r[s>>6&63]+r[63&s]);return l.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,i,r,n){var s,l,o=8*n-r-1,a=(1<<o)-1,u=a>>1,h=-7,c=i?n-1:0,p=i?-1:1,d=e[t+c];for(c+=p,s=d&(1<<-h)-1,d>>=-h,h+=o;h>0;s=256*s+e[t+c],c+=p,h-=8);for(l=s&(1<<-h)-1,s>>=-h,h+=r;h>0;l=256*l+e[t+c],c+=p,h-=8);if(0===s)s=1-u;else{if(s===a)return l?NaN:1/0*(d?-1:1);l+=Math.pow(2,r),s-=u}return(d?-1:1)*l*Math.pow(2,s-r)},t.write=function(e,t,i,r,n,s){var l,o,a,u=8*s-n-1,h=(1<<u)-1,c=h>>1,p=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,l=h):(l=Math.floor(Math.log(t)/Math.LN2),t*(a=Math.pow(2,-l))<1&&(l--,a*=2),(t+=l+c>=1?p/a:p*Math.pow(2,1-c))*a>=2&&(l++,a/=2),l+c>=h?(o=0,l=h):l+c>=1?(o=(t*a-1)*Math.pow(2,n),l+=c):(o=t*Math.pow(2,c-1)*Math.pow(2,n),l=0));n>=8;e[i+d]=255&o,d+=f,o/=256,n-=8);for(l=l<<n|o,u+=n;u>0;e[i+d]=255&l,d+=f,l/=256,u-=8);e[i+d-f]|=128*m}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}}]);