!function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));let s=e=>crypto.getRandomValues(new Uint8Array(e)),r=(e,t)=>((e,t,i)=>{let s=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*s*t/e.length);return()=>{let a="";for(;;){let n=i(r),l=r;for(;l--;)if(a+=e[n[l]&s]||"",a.length===t)return a}}})(e,t,s)},function(e,t,i){"use strict";i.r(t),function(e,t){var s,r,a,n,l=i(1),o=[].indexOf;try{r=JSON.parse(SECRETS_SETTINGS)}catch(e){}try{for(n in a=JSON.parse(SECRETS_SERVER))r[n]=a[n]}catch(e){}null==r&&(r={}),null==r.name&&(r.name="Paradigm"),null==r.version&&(r.version="5.5.0"),r.pass=["docs","client",".well-known"],null==r.dev&&(r.dev=!0),null==r.headers&&(r.headers={"Access-Control-Allow-Methods":"HEAD, GET, PUT, POST, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"X-apikey, X-id, Origin, X-Requested-With, Content-Type, Content-Disposition, Accept, DNT, Keep-Alive, User-Agent, If-Modified-Since, Cache-Control","Permissions-Policy":"interest-cohort=()"}),null==r.formats&&(r.formats=["html","csv","json"]),null==r.svc&&(r.svc={}),null==r.src&&(r.src={});try{addEventListener("fetch",(function(e){return!1!==r.pass&&e.passThroughOnException(),e.respondWith(s.call(e))}))}catch(e){}try{addEventListener("scheduled",(function(e){return e.waitUntil(s.call(e,!0))}))}catch(e){}(s=async function(t){var i,a,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe,fe,me,ge,ye,ve,be;this.started=Date.now();try{null==(l=r.headers)[L="x-"+r.name.toLowerCase()]&&(l[L]=(r.version?"v"+r.version:"")+(r.built?" built "+r.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(r)),"function"!=typeof this.waitUntil?(null!=this.S.bg&&"string"!=typeof this.S.bg||(this.S.bg=!0),null==(u=this.S).cache&&(u.cache=!1),this.waitUntil=function(e){return!0}):this.S.kv||(this.S.kv=this.S.name.replace(/\s/g,""),e[this.S.kv]||delete this.S.kv),this.params={},null!=this.request.url&&-1!==this.request.url.indexOf("?"))for(U="",O=0,q=(F=this.request.url.split("?")[1].split("&")).length;O<q;O++)if((A=(Y=F[O]).split("="))[0].length){if(1===A.length&&U&&(A[0].startsWith(" ")||A[0].includes("%")))this.params[U]+="&"+decodeURIComponent(A[0]);else{if(this.params[A[0]]=1===A.length||("string"==typeof A[1]&&"true"===A[1].toLowerCase()||("string"!=typeof A[1]||"false"!==A[1].toLowerCase())&&(!!Y.endsWith("=")||A[1])),"string"!=typeof this.params[A[0]]||0!==this.params[A[0]].replace(/[0-9]/g,"").length||this.params[A[0]].startsWith("0")||(j=parseInt(this.params[A[0]]),isNaN(j)||(this.params[A[0]]=j)),"string"==typeof this.params[A[0]]&&-1!==this.params[A[0]].indexOf("%"))try{this.params[A[0]]=decodeURIComponent(this.params[A[0]])}catch(e){}if("string"==typeof this.params[A[0]]&&(this.params[A[0]].startsWith("[")||this.params[A[0]].startsWith("{")))try{this.params[A[0]]=JSON.parse(this.params[A[0]])}catch(e){}}U=A[0]}this.headers={};try{for(V=[...this.request.headers],S=0,C=V.length;S<C;S++)x=V[S],this.headers[x[0].toLowerCase()]=x[1]}catch(e){try{for(k in this.request.headers)this.headers[k.toLowerCase()]=this.request.headers[k]}catch(e){}}if(null==(c=this.headers).ip&&(c.ip=null!=(se=this.headers["x-real-ip"])?se:this.headers["x-forwarded-for"]),m=null!=(ne=this.headers["content-type"])?ne:"",!0===this.S.bg)null!=this.request.body&&(this.body=this.request.body);else if(m.includes("/json"))this.body=await this.request.json();else if(m.includes("form")){for(v in d={},(await this.request.formData()).entries())v[0]&&(null!=d[v[0]]?(Array.isArray(d[v[0]])||(d[v[0]]=[d[v[0]]]),d[v[0]].push(v[1])):d[v[0]]=v[1]);null!=d&&"{}"!==JSON.stringify(d)&&(this.body=d)}if(null==this.body&&("POST"===(le=this.request.method)||"PUT"===le||"DELETE"===le)){try{d=await this.request.text()}catch(e){}d&&(this.body=d)}try{"string"==typeof this.body&&(this.body.startsWith("{")||this.body.startsWith("["))&&(this.body=JSON.parse(this.body))}catch(e){}if("object"==typeof this.body&&!Array.isArray(this.body))for(Y in this.body)Y&&null==(h=this.params)[Y]&&(h[Y]=this.body[Y]);try{this.cookie=null!=(oe=this.headers.Cookie)?oe:this.headers.cookie}catch(e){}this.rid=this.headers["x-"+this.S.name.toLowerCase()+"-rid"];try{null==this.rid&&(this.rid=this.headers["cf-ray"])}catch(e){}null==this.rid&&(this.rid=s.uid());try{this.apikey=null!=(ue=null!=(ce=this.headers["x-apikey"])?ce:this.headers.apikey)?ue:this.params.apikey}catch(e){}for(I=0,P=(he=["x-apikey","apikey"]).length;I<P;I++)me=he[I],null!=this.headers[me]&&delete this.headers[me],null!=this.params[me]&&delete this.params[me];if(this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh),0!==this.request.url.indexOf("http://")&&0!==this.request.url.indexOf("https://")){this.url=this.request.url.split("?")[0].replace(/^\//,"").replace(/\/$/,"");try{-1!==this.url.indexOf("%")&&(y=decodeURIComponent(this.url))}catch(e){}this.parts=this.url.length?(null!=y?y:this.url).split("/"):[];try{this.base=this.headers.host}catch(e){}}else{this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1];try{-1!==this.url.indexOf("%")&&(y=decodeURIComponent(this.url))}catch(e){}this.parts=(null!=y?y:this.url).split("/"),this.base=this.parts.shift()}if("string"==typeof this.headers.accept&&this.headers.accept.includes("/csv")&&o.call(this.S.formats,"csv")>=0&&(this.format="csv"),this.parts.length&&-1!==this.parts[this.parts.length-1].indexOf(".")&&(D=this.parts[this.parts.length-1].split(".").pop(),o.call(this.S.formats,D)>=0&&(this.format=D,this.parts[this.parts.length-1]=this.parts[this.parts.length-1].replace("."+D,""))),"string"==typeof this.S.bg&&Array.isArray(this.S.pass)&&this.parts.length&&(de=this.parts[0],o.call(this.S.pass,de)>=0))throw new Error;for(g in null!=(X=this.S.domains)?X:{})if(Array.isArray(this.S.domains[g])&&(this.S.domains[g]={parts:this.S.domains[g],exclusive:!1}),-1!==this.base.indexOf(g)){if(!(b=this.S.domains[g].exclusive)){for(W=[...this.S.domains[g].parts],be=s;p=W.shift();)try{be=be[p]}catch(e){}null==be||(this.parts.length||"function"!=typeof be)&&null==be[this.parts[0]]||(b=!0)}if(b){this.domain=g,this.parts=[...this.S.domains[g].parts,...this.parts];break}}if(ye="x-"+this.S.name.toLowerCase()+"-system",this.S.name&&this.S.system&&this.headers[ye]===this.S.system&&(delete this.headers[ye],this.system=!0),this._logs=[],this.nolog=!1,this.params._nolog&&(this.nolog=this.S.nolog&&this.params._nolog===this.S.nolog,delete this.params._nolog),this.route=this.parts.join("/"),this.routes=[],this.fn="",(t||"_schedule"===this.route)&&(this.scheduled=!0),""===this.route)return s._response.call(this,"HEAD"===($=this.request.method)||"OPTIONS"===$?"":{name:this.S.name,version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.dev?this.S.built:void 0});for(ge=[],w=void 0,J=[...this.parts],T=void 0,M=[],(i=(e,t,r,a,l,u,c)=>{var h,d,p,f,m,g,y,v,b,_,x,k,O,S,A,j,I,q,C,P,N;if(T&&0===this.fn.indexOf(r))for(;J.length&&null==e[J[0]];)this.params[T]=(this.params[T]?this.params[T]+"/":"")+J.shift(),o.call(M,T)<0&&M.push(T);for(n in C=[],e)if("function"!=(I=typeof e[n])&&"object"!==I)C.push(t[n]=e[n]);else if(null!=e[n]){if(A=r+(r?".":"")+n,"object"!=typeof e[n]||e[n]._index||e[n]._indexed||e[n]._kv||e[n]._bg){if(null==(g=e[n])._hide&&(g._hide=null!=(y=e[n])._hides?y._hides:y._hides=a),null==(v=e[n])._auth&&(v._auth=null!=(b=e[n])._auths?b._auths:b._auths=l),Array.isArray(e[n]._auths)&&0===e[n]._auths.length&&(e[n]._auths=A.split(".")),Array.isArray(e[n]._auth)&&0===e[n]._auth.length&&(e[n]._auth=A.split(".")),null==(_=e[n])._wrap&&(_._wrap=null!=(x=e[n])._wraps?x._wraps:x._wraps=u),null==(h=e[n])._cache&&(h._cache=null!=(d=e[n])._caches?d._caches:d._caches=c),A.startsWith("auth")&&null==(p=e[n])._cache&&(p._cache=!1),e[n]._sheet&&null==(f=e[n])._index&&(f._index=!0),e[n]._index)for(j=0,S=(q=["keys","terms","suggest","count","min","max","range","mapping","history","_for","_each","_bulk","_refresh"]).length;j<S;j++)O=q[j],null==(m=e[n])[O]&&(m[O]={_indexed:O,_auth:O.startsWith("_")?"system":e[n]._auth});for(P in k=s.dot(this.S,r))P.startsWith("_")&&(e[n][P]=k[P]);for(N in"function"!=typeof e[n]||e[n]._index||e[n]._indexed||e[n]._kv||e[n]._bg||-1!==A.indexOf(".")&&!1!==e[n]._wrap&&0!==A.split(".").pop().indexOf("_")?t[n]=s._wrapper(e[n],A).bind(this):t[n]=e[n].bind(this),t[n]._fn=A,e[n])N.startsWith("_")&&(t[n][N]=e[n][N])}else t[n]=JSON.parse(JSON.stringify(e[n]));this.scheduled&&t[n]._schedule&&ge.push(t[n]),n.startsWith("_")||(J.length&&J[0]===n&&0===this.fn.indexOf(r)&&(T=J.shift(),this.fn+=(""===this.fn?"":".")+T,"function"==typeof t[n]&&-1===r.indexOf("._")&&(w=t[n])),"function"!=typeof t[n]||t[n]._hide||1!==A.replace("svc.","").replace("src.","").split(".").length||this.routes.push(A.replace(/\./g,"/"))),Array.isArray(e[n])||n.startsWith("_")&&"function"!=typeof t[n]?C.push(void 0):C.push(i(e[n],t[n],A,null!=a?a:e[n]._hides,null!=l?l:e[n]._auths,null!=u?u:e[n]._wraps,null!=c?c:e[n]._caches))}else C.push(void 0);return C})(s,this,""),T&&J.length&&(this.params[T]=this.params[T]?this.params[T]+"/"+J.join("/"):J.join("/")),R=0,N=M.length;R<N;R++)f=M[R],"true"===this.params[f].toLowerCase()&&(this.params[f]=!0),"false"===this.params[f].toLowerCase()&&(this.params[f]=!1),"string"!=typeof this.params[f]||0!==this.params[f].replace(/[0-9]/g,"").length||this.params[f].startsWith("0")||(z=parseInt(this.params[f]),isNaN(z)||(this.params[f]=z));if(this.S.dev&&!0===this.S.bg&&console.log("=== "+(this.system?"SYSTEM ":"")+this.request.method+" ===",this.base,this.fn,this.domain,typeof this.body),this.scheduled)for(B=0,E=ge.length;B<E;B++){_=ge[B],this.S.dev&&!0===this.S.bg&&console.log("scheduled",_._fn);try{"function"==typeof _._schedule?this.waitUntil(_._schedule.apply(this)):this.waitUntil(_.apply(this))}catch(e){}}else{if(("object"==(G=typeof w)||"function"===G)&&w._bg&&"string"==typeof this.S.bg&&this.S.bg.startsWith("http"))throw new Error;"function"==typeof w&&("object"==typeof(a="auth"===this.fn?void 0:await this.auth())&&a._id&&a.email&&(this.user=a),(a="function"==typeof w._auth?await w._auth():!0===w._auth&&null!=this.user||(!w._auth||await this.auth.role(w._auth)))||this.system?"HEAD"===(H=this.request.method)||"OPTIONS"===H?pe="":!1!==w._cache&&!this.refresh&&("GET"===this.request.method||"POST"===this.request.method&&await this.index.translate(this.params))&&(pe=await this.cache())?(this.cached="cache",(pe=new Response(pe.body,pe)).headers.append("x-"+this.S.name.toLowerCase()+"-cached","cache"),pe.headers.delete("x-"+this.S.name.toLowerCase()+"-took")):(pe=await w(),this.completed=!0):(this.unauthorised=!0,await this.sleep(200*(1+Math.random())),(pe={status:401}).body=await this.auth(!1)))}if((null==pe||"object"==typeof pe&&404===pe.status)&&this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("favicon")&&(pe=""),fe="object"!=typeof pe||Array.isArray(pe)||"function"!=typeof(null!=(K=pe.headers)?K.append:void 0)?await this._response(pe,w):pe,this.parts.length&&"log"!==(Q=this.parts[0])&&"status"!==Q&&(!this.system||"kv"!==(Z=this.parts[0])&&"index"!==Z)&&"HEAD"!==(ee=this.request.method)&&"OPTIONS"!==ee&&null!=pe&&""!==pe&&(!this.completed||!1===w._cache||200!==fe.status||"object"==typeof pe&&!Array.isArray(pe)&&0===(null!=(te=pe.hits)?te.total:void 0)||"number"==typeof pe&&this.refresh?this.refresh&&this.cache(void 0,""):(null!=(ve=w._cache)||"object"!=typeof pe||Array.isArray(pe)||null==(null!=(ie=pe.hits)?ie.hits:void 0)||(ve=60),this.cache(void 0,fe,ve)),("object"!=(re=typeof w)&&"function"!==re||!1!==w._log)&&this.log()),this.completed||this.cached||this.unauthorised||this.scheduled||!1===this.S.pass||"string"!=typeof this.S.bg||"HEAD"===(ae=this.request.method)||"OPTIONS"===ae)return fe;throw new Error})._response=async function(e,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S;if(null==(a=this.S).headers&&(a.headers={}),null==e)e=404,O=404;else if("status"!==this.fn&&"object"==typeof e&&!Array.isArray(e)&&("number"==typeof e.status&&e.status>300&&e.status<600||e.headers)){if(null!=e.headers){for(o in e.headers)this.S.headers[o]=e.headers[o];delete e.headers}O=null!=(v=e.status)?v:200,delete e.status,0===(p=this.keys(e)).length?e=O:1===p.length&&(e=e[p[0]])}else O=200;if(!this.S.headers["Content-Type"]&&!this.S.headers["content-type"]){if(this.format&&("html"===(b=this.format)||"csv"===b)){if("string"!=typeof e)try{e=await this.convert["json2"+this.format](e)}catch(e){}if("string"==typeof e&&"html"===this.format&&!(e=e.replace(/\>\</g,">\n<")).includes("<html")&&!this.params.partial){for(x='<!DOCTYPE html><html dir="ltr" lang="en">\n<head>\n',x+='<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n',e.includes("<title")?([y,S]=e.split("<title"),[S,r]=S.split("</title>"),x+="<title"+S+"</title>\n",e=y+r):e.includes('id="title"')&&(x+="<title>"+e.split('id="title"')[1].split(">")[1].split("<")[0]+"</title>\n"),x+='<link href="//fonts.googleapis.com/css?family=Lustria|Noto+Sans|Roboto+Slab|Nixie+One" rel="stylesheet" type="text/css">\n',x+='<link rel="stylesheet" href="/client/pradm.min.css?v='+this.S.version+'">\n',x+='<script type="text/javascript" src="/client/pradm.min.js?v='+this.S.version+'"><\/script>\n',x+='<script type="text/javascript" src="/client/pradmLogin.min.js?v='+this.S.version+'"><\/script>\n',h=0,f=(w=["<meta ","<link "]).length;h<f;h++)if(u=w[h],e.includes(u))for(d=0,m=(_=e.split(u)).length;d<m;d++)k=u+_[d].split(">")[0],e=e.replace(k,""),x+=k+"\n";e.includes("<head>")&&([g,c]=e.split("<head>"),[c,s]=c.split("</head>"),x+=c,e=g+s),x.includes("icon")||(x+='<link rel="icon" href="data:,">'),x+="\n</head>\n",x+=e.includes("<body")?e:"\n<body>\n"+e+"\n</body>\n",e=x+"\n</html>"}this.S.headers["Content-Type"]="html"===this.format?"text/html; charset=UTF-8":"text/csv; charset=UTF-8"}if("string"!=typeof e)try{e=JSON.stringify(e,"",2)}catch(e){}null==(n=this.S.headers)["Content-Type"]&&(n["Content-Type"]="application/json; charset=UTF-8")}try{null==(l=this.S.headers)["Content-Length"]&&(l["Content-Length"]=t.byteLength(e))}catch(e){}try{this.S.headers["x-"+this.S.name.toLowerCase()+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name.toLowerCase()+"-cached"]=this.cached)}catch(e){}try{return new Response(e,{status:O,headers:this.S.headers})}catch(t){return{status:O,headers:this.S.headers,body:e}}},s._wrapper=function(e,t){return async function(){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(y=Date.now(),m=t.replace(/\./g,"_"),n={fn:t},e._limit)for(l=await this.kv("limit/"+t);l;)null==n.limited&&(n.limited=0),n.limited+=l,await this.sleep(l-y),l=await this.kv("limit/"+t);if("string"==(c=typeof this.params._async)||"number"===c)if(f=await this.kv("async/"+this.params._async,"")){if("string"==typeof f&&f.includes("/")&&!f.includes(" ")&&!f.includes(":")&&!f.startsWith("10.")&&2===f.split("/").length){try{e._kv&&(f=await this.kv(f))}catch(e){}try{null==f&&e._index&&(f=await this.index(f))}catch(e){}}try{"string"==typeof f&&(f.startsWith("{")||f.startsWith("["))&&(f=JSON.parse(f))}catch(e){}}else f={_async:this.params._async};else if(this.fn===t&&e._sheet&&this.parts.indexOf("sheet")===this.parts.length-1)f={status:302},e._sheet.startsWith("http")?f.body=e._sheet:"json"===this.format?f.body="https://spreadsheets.google.com/feeds/list/"+e._sheet+"/default/public/values?alt=json":f.body="https://docs.google.com/spreadsheets/d/"+e._sheet,f.headers={Location:f.body};else if(e._indexed)(s=[...arguments]).unshift(m.replace("_"+e._indexed,"")),f=await this.index[e._indexed](...s);else if((e._index||e._kv)&&(!e._sheet||this.fn!==t||!this.refresh)){this.fn===t?(this.fn.replace(/\./g,"/")!==this.route&&(n.key=this.route.split(t.split(".").pop()).pop().replace(/\//g,"_").replace(/^_/,"").replace(/_$/,"")),!n.key&&e._index&&(o=await this.index.translate("POST"===this.request.method?this.body:this.params))):arguments.length&&("string"==typeof arguments[0]&&arguments[0].length&&!arguments[0].includes("\n")&&(n.key=arguments[0].replace(/\//g,"_")),n.key&&n.key.length!==n.key.replace(/[\s\:\*~\?=%]/g,"").length&&delete n.key,e._index&&""!==arguments[0]&&""!==arguments[1]&&(o=await this.index.translate(arguments[0],arguments[1]))&&n.key&&(1===arguments.length||"object"==typeof arguments[1])&&(a=await this.index(m+"/"+n.key))&&(o=void 0),u=null!=o?void 0:n.key?arguments[1]:e._index?arguments[0]:void 0),"object"!=typeof u||Array.isArray(u)||(null==u._id&&(u._id=null!=(h=null!=(d=n.key)?d:u[e._key])?h:this.uid()),null==n.key&&(n.key=u._id)),null!=o&&(f=await this.index(m,o),n.qry=JSON.stringify(o)),null==u&&this.refresh&&"function"==typeof e||(e._kv&&n.key&&(null!=u||null==a)&&null!=(f=await this.kv(m+"/"+n.key,u))&&null==u&&(n.cached="kv"),!e._index||null==u&&null!=f||null!=(f=null!=a&&null==u?a:await this.index(m+(!n.key||null==u&&null!=o?"":"/"+n.key),null!=u?u:n.key?void 0:o))||n.key&&null!=u||(await this.index(m,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:e._index.mappings,aliases:e._index.aliases}),""!==u&&(f=await this.index(m+(n.key?"/"+n.key:""),null!=u?u:n.key?void 0:o))));try{null==u&&0===f.hits.total&&"function"==typeof e&&n.key&&(f=void 0)}catch(e){}try{null!=o.query.bool&&(1===o.size||1===f.hits.total&&n.key)&&(null!=f.hits.hits[0]._source&&null==f.hits.hits[0]._source._id&&(f.hits.hits[0]._source._id=f.hits.hits[0]._id),f=null!=(p=f.hits.hits[0]._source)?p:f.hits.hits[0].fields)}catch(e){}null==f||null!=u||n.cached||(n.cached="index"),n.cached&&this.fn===t&&(this.cached=n.cached)}if(e._history&&"object"==typeof u&&!Array.isArray(u)&&u._id&&(n.history=u._id,n.rec=JSON.stringify(u)),null==f&&(e._bg||e._sheet)&&"string"==typeof this.S.bg&&0===this.S.bg.indexOf("http")&&(r={headers:{},body:u,params:this.copy(this.params)},this.refresh&&(r.params.refresh=!0),r.headers["x-"+this.S.name.toLowerCase()+"-rid"]=this.rid,f=await this.fetch(this.S.bg+"/"+m.replace(/\_/g,"/"),r),n.bg=!0),null==f&&e._sheet&&""!==u&&(this.refresh&&this.fn===t||!(a=await this.index(m)))&&(e._sheet.startsWith("http")&&e._sheet.includes("csv")?g=await this.convert.csv2json(e._sheet):e._sheet.startsWith("http")&&e._sheet.includes("json")?(g=await this.fetch(e._sheet))&&!Array.isArray(g)&&(g=[g]):g=await this.src.google.sheets(e._sheet),Array.isArray(g)&&g.length?("function"==typeof e&&(g=await e.apply(this,[g])),await this.index(m,""),await this.index(m,"object"!=typeof e._index?{}:{settings:e._index.settings,mappings:e._index.mappings,aliases:e._index.aliases}),arguments.length||"{}"!==JSON.stringify(this.params)?await this.index(m,g):(this.waitUntil(this.index(m,g)),f=g.length)):f=0),null!=f||e._index&&""===u||"function"!=typeof e||(i=async(e,i,s,r)=>{var a,n,l,o,u,c,h,d;if(i._limit&&(n=!0===i._limit?86400:i._limit,await this.kv("limit/"+t,y+n,n)),"object"==typeof(c=await i.apply(this,s))&&(i._kv||i._index)&&null==c.took&&null==c.hits){if(i._key&&Array.isArray(c)&&c.length&&null==c[0]._id&&null!=c[0][i._key])for(l=0,u=c.length;l<u;l++)null==(a=c[l])._id&&(a._id=a[i._key]);o=Array.isArray(c)?"":"/"+(null!=(h=null!=(d=c[i._key])?d:c._id)?h:this.uid()).replace(/\//g,"_").toLowerCase(),i._kv&&!Array.isArray(c)&&this.kv(e+o,f,i._kv),i._index&&this.waitUntil(this.index(e+o,c))}return!0===i._limit&&await this.kv("limit/"+t,""),i._async&&(this.kv("async/"+this.rid,null==o||Array.isArray(c)?Array.isArray(c)?c.length:c:e+o,172800),r&&this.mail({to:r,text:this.base+"/"+e+"?_async="+this.rid})),c},e._async?(n.async=!0,f={_async:this.rid},this.waitUntil(i(m,e,arguments,this.params.notify))):f=await i(m,e,arguments)),e._diff&&null!=f&&!n.cached&&!n.async){n.args=JSON.stringify(arguments.length?arguments:this.fn===t?this.params:""),n.res=JSON.stringify(f);try{n.checksum=this.shorthash(n.res)}catch(e){}}return!1!==e._log&&(n.took=Date.now()-y,this.log(n)),f}},s.src={},s.svc={},s.scripts={};o=[].indexOf;s.auth=async function(e){var t,i,s,a,n,l,o,u,c,h,d,p,f;if("string"==typeof e)return this.users._get(e);if(e||null==this.user||"auth"!==this.fn&&!1!==e){if(!1!==e&&((this.params.access_token&&(s=await this.auth._oauth(this.params.access_token))||(this.params.token||this.params.auth)&&(i=await this.kv("auth/token/"+(null!=(a=this.params.token)?a:this.params.auth),"")))&&((f=await this.users._get(null!=(n=null!=s?s.email:void 0)?n:i))||(f=await this.users._create(null!=s?s:i))),!f&&this.apikey&&(!0===this.S.bg&&(f=await this.users._get(void 0,this.apikey)),!f&&(p=await this.kv("auth/apikey/"+this.apikey))&&(f=await this.users._get(p))),!f&&(this.params.resume||this.cookie))){if(!(h=this.params.resume))try{h=(t=JSON.parse(decodeURIComponent(this.cookie).split((null!=(l=null!=(o=r.auth)&&null!=(u=o.cookie)?u.name:void 0)?l:"pradm")+"=")[1].split(";")[0])).resume,p=t._id}catch(e){}null==p&&(p=this.headers["x-id"]),this.params.email&&!p&&(p=this.hashhex(this.params.email.trim().toLowerCase())),h&&p&&await this.kv("auth/resume/"+p+"/"+h)&&null!=(f=await this.users._get(p))&&(f.resume=h)}}else f=this.user;return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(c=f.roles)?c[this.params.service]:void 0)&&(null==f.roles&&(f.roles={}),f.roles[this.params.service]="user",this.users._update(f)),null!=f.resume||this.apikey||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,{createdAt:Date.now(),device:this.device()},789e4)),await this.auth.role("root",this.user)&&this.log({msg:"root login"})),!this.format&&("auth"===this.fn||this.unauthorised)&&this.headers["user-agent"]&&this.headers["user-agent"].toLowerCase().includes("mozilla")&&this.headers.accept&&this.headers.accept.includes("/html")&&!this.headers.accept.includes("/json")&&(this.format="html"),e||"html"!==this.format?f:(d='<body class="black">',d+='<div class="flex" style="margin-top: 10%;"><div class="c6 off3"><h1 id="title" class="centre statement" style="font-size:40px;">'+(this.base?this.base.replace("bg.","(bg) "):this.S.name)+"</h1></div></div>",d+='<div class="flex" style="margin-top: 5%;"><div class="c6 off3">',null==this.user?(d+='<input autofocus id="PEmail" class="PEmail big shadow" type="text" name="email" placeholder="email">',d+='<input id="PToken" class="PToken big shadow" style="display:none;" type="text" name="token" placeholder="token (check your email)">',d+='<p class="PWelcome" style="display:none;">Welcome back</p>',d+='<p class="PLogout" style="display:none;"><a id="PLogout" class="button action" href="#">logout</a></p>'):d+="<p>"+f.email+'</p><p><a id="PLogout" class="button action" href="#">logout</a></p>',d+='<div class="PLoading" style="display:none;"><div class="loading big"></div></div>',d+="</div></div></body>",d+="<script>","auth"===this.fn&&(d+="P.afterLogout = function() { location.reload(); }; "),"auth"===this.fn&&null==this.user||(d+="P.loginNext = true;"),d+="<\/script>")},s.auth.token=function(e,t,i,s,a,n,l){var o,u,c;return null==e&&(e=this.params.email),e?(e=e.trim().toLowerCase(),null==t&&(t=null!=(o=null!=(u=r.auth)?u.from:void 0)?o:"login@example.com"),c=this.uid(8),this.S.dev&&!0===this.S.bg&&console.log(e,c),null==l&&(l=this.params.url),l?(l+="#"+c,null==i&&(i="Complete your login to "+(l.includes("//")?l.split("//")[1]:l).split("/")[0])):(l=this.base+"/"+this.route.replace("/token","/"+c),null==i&&(i="Complete your login to "+(this.base?this.base.replace("bg.","(bg) "):this.S.name))),this.kv("auth/token/"+c,e,1200),this.waitUntil(this.mail({from:t,to:e,subject:i,text:null!=s?s:"Your login code is:\r\n\r\n"+c+"\r\n\r\nor use this link:\r\n\r\n"+l+"\r\n\r\nnote: this single-use code is only valid for 20 minutes.",html:null!=a?a:"<html><body><p>Your login code is:</p><p><b>"+c+'</b></p><p>or click on this link</p><p><a href="'+l+'">'+l+"</a></p><p>note: this single-use code is only valid for 10 minutes.</p></body></html>",params:{token:c,url:l}})),{email:e}):this.uid(8)},s.auth.role=async function(e,t){var i,s,r,a,n,l,u,c,h,d,p,f,m,g;if(null==e&&(e=this.params.role),t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,"system"===e&&this.system)return"system";if((null!=t?t.email:void 0)&&(c=t.email,o.call("string"==typeof this.S.root?[this.S.root]:Array.isArray(this.S.root)?this.S.root:[],c)>=0))return"root";if(null!=(null!=t?t.roles:void 0))for(a=0,l=(h="string"==typeof e?e.split(","):e||[]).length;a<l;a++){if(s=h[a],[r,g]=s.replace("/",".").split("."),r===t._id)return"owner";if(g){if(o.call(null!=(d=t.roles[r])?d:[],g)>=0)return g;if(null!=t.roles[r]&&-1<(f=(i=["service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public","request"]).indexOf(g)))for(n=0,u=(p=i.splice(0,f)).length;n<u;n++)if(m=p[n],o.call(t.roles[r],m)>=0)return m}}return!1},s.auth.add=async function(e,t,i,s){var r,a,n,l,u,c,h;return t="object"==typeof t?t:t||this.params.auth?await this.users._get(null!=t?t:this.params.auth):this.user,!(!e&&this.user._id!==t._id&&!await this.auth.role("system"))&&(null==e&&(e=null!=(n=null!=(l=this.params.add)?l:this.params.remove)?n:this.params.deny),!!e&&([a,h]=e.replace("/",".").split("."),null==i&&(i=("DELETE"===this.request.method||!0===this.params._delete)&&"auth.roles"===this.fn),"root"!==a&&"root"!==h&&(s?(t.roles[a]=["deny"],this.users._update(t)):h?(null!=(u=t.roles)?u[a]:void 0)&&o.call(t.roles[a],h)>=0?null!=i&&(t.roles[a].splice(t.roles[a].indexOf(h),1),t.roles[a].length||delete t.roles[a],this.users._update(t)):("request"!==h||o.call(null!=(c=t.roles[a])?c:[],"deny")<0)&&(null==(r=t.roles)[a]&&(r[a]=[]),o.call(t.roles[a],"request")>=0&&(t.roles[a]=t.roles[a].splice(t.roles[a].indexOf("request"),1)),t.roles.group.push(h),this.users._update(t)):null!=t.roles[a]?null!=i&&(delete t.roles[a],this.users._update(t)):(t.roles[a]=["user"],this.users._update(t)),t)))},s.auth.remove=function(e,t){return this.auth.add(e,t,!0)},s.auth.deny=function(e,t){return this.auth.add(e,t,void 0,!0)},s.auth.request=function(e,t){return null==e&&(e=this.params.request),e=e.split("/")[0]+"/request",this.auth.add(e,t)},s.auth.logout=async function(e){return null==e&&(e=this.user),!!e&&(await this.kv._each("auth/resume/"+("string"==typeof e?e.includes("@")?this.hashhex(e.trim().toLowerCase()):e:e._id),""),!0)},s.auth._oauth=async function(e,t){var i,s,a,n,l,o,u,c,h,d,p,f,m,g;if({},e)try{if(g=await this.fetch("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e,{method:"POST"}),null==t&&(t=null!=(i=null!=(s=this.S.svc[null!=(l=this.params.service)?l:"z"])&&null!=(o=s.google)&&null!=(u=o.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=r.use)&&null!=(d=h.google)&&null!=(p=d.oauth)&&null!=(f=p.client)?f.id:void 0),null!=t&&(null!=(a=g.data)?a.aud:void 0)===t)return{email:(m=await this.fetch("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e)).data.email.toLowerCase(),google:{id:m.data.id},name:null!=(n=m.data.name)?n:m.data.given_name+(m.data.family_name?" "+m.data.family_name:""),avatar:m.data.picture}}catch(e){}},s.users={_index:!0,_hide:!0,_auth:"system"},s.users._get=async function(e,t){var i,s,r;if(t)try{1===(null!=(s=await this.index("users",'apikey:"'+t+'"'))&&null!=(i=s.hits)?i.total:void 0)&&(r=s.hits.hits[0]._source)}catch(e){}else if("string"==typeof e){if(e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),!0!==this.S.bg)try{r=await this.kv("users/"+e)}catch(e){}if(null==r){try{r=await this.index("users/"+e)}catch(e){}if(null!=r&&!0!==this.S.bg){try{await this.kv("users/"+e,r)}catch(e){}try{await this.kv("auth/apikey/"+r.apikey,e)}catch(e){}}}}return r},s.users._create=async function(e){var t;if("string"==typeof e&&(e={email:e}),"string"!=typeof e.email||!e.email.includes("@"))return!1;t={_id:this.hashhex(e.email.trim().toLowerCase()),email:e.email,apikey:this.uid()},delete e.email;try{t.profile=e}catch(e){}try{t.creation=this.base+"/"+this.route}catch(e){}t.roles={},t.createdAt=new Date;try{await this.kv("users/"+t._id,t)}catch(e){}try{await this.kv("auth/apikey/"+t.apikey,t._id)}catch(e){}try{this.waitUntil(this.index("users/"+t._id,t))}catch(e){}return t},s.users._update=async function(e,t){if("object"==typeof e&&t._id&&null==t&&(e=(t=e)._id),"string"==typeof e&&"object"==typeof t&&"{}"!==JSON.stringify(t)){e.startsWith("users/")&&(e=e.replace("users/","")),e.includes("@")&&(e=this.hashhex(e.trim().toLowerCase())),t.updatedAt=new Date;try{await this.kv("users/"+e,t)}catch(e){}try{this.waitUntil(this.index("users/"+e,t))}catch(e){}return!0}return!1},s.users._delete=async function(e){var t,i;if(i="object"==typeof e?e:(null!=(t=this.user)?t._id:void 0)===e?this.user:await this.users._get(e)){try{await this.kv._each("auth/resume/"+i._id,"")}catch(e){}try{await this.kv("auth/apikey/"+i.apikey,"")}catch(e){}try{await this.kv("users/"+i._id,"")}catch(e){}try{return await this.index("users/"+i._id,"")}catch(e){}}};var u,c,h,p;o=[].indexOf;null==s.convert&&(s.convert={}),s.convert.json2csv=async function(e,t){var i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S;if(null==e&&(e=null!=(y=this.body)?y:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(t.url)),t.es||null!=(null!=e&&null!=(v=e.hits)?v.hits:void 0))try{e=e.hits.hits,t.es=!0}catch(e){}if(Array.isArray(e)||(e=[e]),p=null!=(b=t.quote)?b:'"',S=null!=(w=t.separator)?w:",",h=null!=(_=t.newline)?_:"\n",e.length){for(s=null!=(x=t.keys)?x:[],g="",r=0,u=e.length;r<u;r++){if(m=e[r],g.length&&(g+=h),!1!==t.es&&(m._source||m.fields)){for(d in O=null!=(k=m._source)?k:m.fields,f={},a=!0,(!t.keys||o.call(t.keys,"_id")>=0)&&(f._id="<a onclick=\"this.setAttribute('href', window.location.href.split('.html')[0].split('/').pop() + '/' + this.getAttribute('href') )\" href=\""+m._id+'.html">'+m._id+"</a>",a=!1),O)if(null==f[d]&&(f[d]=O[d]),a&&d===t.keys[0]){try{f[d]="<a onclick=\"this.setAttribute('href', window.location.href.split('.html')[0].split('/').pop() + '/' + this.getAttribute('href') )\" href=\""+m._id+'.html">'+O[d]+"</a>"}catch(e){}a=!1}m=f}if(t.flatten&&(m=await this.flatten(m)),t.subset&&(m=await this.dot(m,t.subset)),!t.keys)for(l in m)null!=m[l]&&o.call(s,l)<0&&s.push(l);for(n=0,c=s.length;n<c;n++){if(i=s[n],g.length&&!g.endsWith(h)&&(g+=S),g+=p,null!=m[i]){try{Array.isArray(m[i])&&1===m[i].length&&Array.isArray(m[i][0])&&(m[i]=m[i][0])}catch(e){}try{Array.isArray(m[i])&&m[i].length&&"object"!=typeof m[i][0]&&(m[i]=m[i].join(","))}catch(e){}try{"object"==typeof m[i]&&(m[i]=JSON.stringify(m[i]))}catch(e){}try{'"'===p&&-1!==m[i].indexOf(p)&&(m[i]=m[i].replace(/"/g,p+p))}catch(e){}try{m[i]=m[i].replace(/\n/g," ")}catch(e){}try{m[i]=m[i].replace(/\s\s/g," ")}catch(e){}try{g+=m[i]}catch(e){}}g+=p}}return p+s.join(p+S+p)+p+"\n"+g}return""},s.convert.csv2json=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_;if(null==t&&(t=this.params),null==e&&(e=null!=(p=this.body)?p:this.params.csv),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(f=t.url)?f:e)),v=[],"string"==typeof e&&e.length&&(d=null!=(m=t.quote)?m:'"',w=null!=(g=t.separator)?g:",",c=null!=(y=t.newline)?y:"\n",(u=e.split(c)).length))for(s=u.shift().split(d+w),h="",r=0,n=u.length;r<n;r++)if((_=(h+=(h?c:"")+(o=u[r])).split(d+w)).length===s.length&&(!d||o.endsWith(d))){for(h="",b={},a=0,l=s.length;a<l;a++)if((i=s[a]).startsWith(d)&&(i=i.replace(d,"")),i.endsWith(d)&&(i=i.substring(0,i.length-1)),_.length&&(b[i]=_.shift(),b[i])){b[i].startsWith(d)&&(b[i]=b[i].replace(d,"")),!_.length&&b[i].endsWith(d)&&(b[i]=b[i].substring(0,b[i].length-1));try{b[i]=JSON.parse(b[i])}catch(e){}}v.push(b)}return v},s.convert.csv2html=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(null==e&&(e=null!=(h=this.body)?h:this.params.csv),null==t&&(t=this.params),(t.url||"string"==typeof e&&e.startsWith("http"))&&(e=await this.fetch(null!=(d=t.url)?d:e)),'"',",","\n",m="<style>table.paradigm tr:nth-child(even) {background: #eee}table.paradigm tr:nth-child(odd) {background: #fff}</style>\n",m+='<table class="paradigm" style="border-collapse: collapse;">\n',"string"==typeof(e=e.replace(/,,/g,',"",'))&&e.length&&(o=e.split("\n")).length){for(m+="<thead><tr>",u=0,i=0,r=(p=o.shift().split('","')).length;i<r;i++)m+='<th style="padding:2px; border:1px solid #ccc;">'+p[i].replace(/"/g,"")+"</th>",u+=1;for(m+="</tr></thead>\n<tbody>\n",s=0,a=o.length;s<a;s++){for(l=o[s],m+="<tr>";-1!==l.indexOf(',"",');)l=l.replace(',"",',',"XXX_EMPTY_XXX",');for(;l.startsWith('"",');)l=l.replace('"",','"XXX_EMPTY_XXX",');for(;l.endsWith(',""');)l=l.slice(0,l.length-3);for(y=0,c=0,n=(f=(l=l.replace(/""/g,"XXX_QUOTER_GOES_HERE_XXX")).split('","')).length;c<n;c++)y+=1,m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;">',"XXX_EMPTY_XXX"!==(g=(g=f[c]).replace(/^"/,"").replace(/"$/,""))&&(0===g.indexOf("{")||0===g.indexOf("[")?(m+="<a href=\"#\" onclick=\"if (this.nextSibling.style.display === 'none') {this.nextSibling.style.display = 'block'} else {this.nextSibling.style.display = 'none'}; return false;\">...</a><div style=\"display:none;\">",m+=await this.convert.json2html(JSON.parse(g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"'))),m+="</div>"):m+=g.replace(/XXX_QUOTER_GOES_HERE_XXX/g,'"')),m+="</td>";for(;y<u;)m+='<td style="padding:2px; border:1px solid #ccc;vertical-align:text-top;"></td>',y+=1;m+="</tr>\n"}m+="</tbody>\n"}return m+"</table>"},s.convert.json2html=async function(e,t){var i,s,r,a,n,l,u,c,h,d,p;if(null==e&&(e=null!=(c=this.body)?c:this.params),null==t&&(t=this.params),t.url&&(e=await this.fetch(url)),t.new)for(null==t.edit&&(t.edit=!0),e={},s=0,a=(h=await this.index.keys(this.route.replace(/\//g,"_"))).length;s<a;s++)e[h[s]]="";if(t.subset&&!Array.isArray(e))for(u=t.subset.split(".");(l=u.shift())&&"object"==typeof e&&!Array.isArray(e)&&null!=e[l];)e=e[l];if(Array.isArray(e)||null!=(null!=e&&null!=(d=e.hits)?d.hits:void 0)&&!1!==t.es)return t.search?'<script type="text/javascript" src="/client/pradmSearch.min.js"><\/script><script>P.search()<\/script>':(null!=u&&(t.subset=u.join(".")),this.convert.csv2html(await this.convert.json2csv(e,t)));if(p="<div>",t.flatten&&(e=await this.flatten(e),p+='<input type="hidden" id="options_flatten" value="true">'),t.subset){if(u.length)for(r=0,n=u.length;r<n;r++)e=e[u[r]];p+="<h3>"+t.subset+":</h3>",p+='<input type="hidden" id="options_subset" value="'+t.subset+'">'}return(i=e=>{var s,r,a,n,l,u,c,h,d,f,m;if(t.edit&&null==e.comments&&(e.comments=""),t.keys)for(n=0,r=(h=t.keys).length;n<r;n++)null==e[c=h[n]]&&(e[c]="");for(s in f=[],e){try{Array.isArray(e[s])&&1===e[s].length&&Array.isArray(e[s][0])&&(e[s]=e[s][0])}catch(e){}if(null==e[s]||Array.isArray(e[s])&&!e[s].length||t.keys&&!(o.call(t.keys,s)>=0))f.push(void 0);else{if(p+='<div style="clear:both; '+(t.edit?"":"border:1px solid #ccc; ")+'margin:-1px 0px;"><div style="float:left;width: 150px; overflow: scroll;"><b><p>'+s+"</p></b></div>",p+='<div style="float:left;">',p+=t.edit?'<textarea class="PForm" id="'+s+'" style="min-height:80px;width:100%;margin-bottom:5px;">':"",Array.isArray(e[s]))if("object"==typeof e[s][0])for(l=0,a=(d=e[s]).length;l<a;l++)u=d[l],i(u);else{try{m=e[s].join(", ")}catch(t){try{m=JSON.stringify(e[s])}catch(t){m=e[s]}}try{p+=(t.edit?"":"<p>")+m+(t.edit?"":"</p>")}catch(e){}}else"object"==typeof e[s]?i(e[s]):p+=(t.edit?"":"<p>")+e[s]+(t.edit?"":"</p>");p+=t.edit?"</textarea>":"",f.push(p+="</div></div>")}}return f})(e),p+="</div>",t.edit&&(p='<script type="text/javascript" src="/client/pradm.min.js"><\/script><script type="text/javascript" src="/client/pradmEdit.min.js"><\/script>'+p,p+='<script type="text/javascript">P.edit()<\/script>'),p},s.convert.json2txt=async function(e){var t,i,s;return null==e&&(e=null!=(i=this.body)?i:this.params),this.params.url&&(e=await this.fetch(this.params.url)),s=[],t=async function(e){var i,r,a,n,l;if(Array.isArray(e)){for(n=[],r=0,a=e.length;r<a;r++)i=e[r],n.push(await t(i));return n}if("object"==typeof e){for(i in l=[],e)l.push(await t(e[i]));return l}if(e)return s.push(e)},await t(e),s.join(" ")},s.convert._hexMatch={0:"0000",1:"0001",2:"0010",3:"0011",4:"0100",5:"0101",6:"0110",7:"0111",8:"1000",9:"1001",a:"1010",b:"1011",c:"1100",d:"1101",e:"1110",f:"1111"},s.convert.hex2bin=function(e){var t,i,r,a,n;for(n=[],t=0,r=(a=Array.isArray(e)?e:[e]).length;t<r;t++)i=a[t],n.push(s.convert._hexMatch[i.toLowerCase()]);return n.join("")},s.convert.bin2hex=function(e){var i,r,a,n,l,o,u,c,h;if(!Array.isArray(e)){for(i=[],h=e.split(""),u="";h.length;)4===(u+=h.shift()).length&&(i.push(u),u="");e=i}for(n in c=[],r={},s.convert._hexMatch)r[s.convert._hexMatch[n]]=n;for(a=0,o=e.length;a<o;a++)l=e[a],c.push("0x"+r[l]);return new t(c).toString()},s.convert.buf2bin=function(e){var i,r;for(t.isBuffer(e)&&(e=e.toString("hex")),e=e.replace(/^0x/,""),r="",i=0;i<e.length;)r+=s.convert.hex2bin(e[i]),i++;return r},s.convert._mimes={".aac":"audio/aac",".abw":"application/x-abiword",".arc":"application/x-freearc",".avi":"video/x-msvideo",".azw":"application/vnd.amazon.ebook",".bin":"application/octet-stream",".bmp":"image/bmp",".bz":"application/x-bzip",".bz2":"application/x-bzip2",".csh":"application/x-csh",".css":"text/css",".csv":"text/csv",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".eot":"application/vnd.ms-fontobject",".epub":"application/epub+zip",".gz":"application/gzip",".gif":"image/gif",".htm":"text/html",".ico":"image/vnd.microsoft.icon",".ics":"text/calendar",".jar":"application/java-archive",".jpg":"image/jpeg",".js":"text/javascript",".json":"application/json",".jsonld":"application/ld+json",".mid":"audio/midi",".mjs":"text/javascript",".mp3":"audio/mpeg",".mpeg":"video/mpeg",".mpkg":"application/vnd.apple.installer+xml",".odp":"application/vnd.oasis.opendocument.presentation",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odt":"application/vnd.oasis.opendocument.text",".oga":"audio/ogg",".ogv":"video/ogg",".ogx":"application/ogg",".opus":"audio/opus",".otf":"font/otf",".png":"image/png",".pdf":"application/pdf",".php":"application/php",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".py":"text/plain",".rar":"application/vnd.rar",".rb":"text/plain",".rtf":"application/rtf",".sh":"application/x-sh",".svg":"image/svg+xml",".swf":"application/x-shockwave-flash",".tar":"application/x-tar",".tif":"image/tiff",".ts":"video/mp2t",".ttf":"font/ttf",".txt":"text/plain",".vsd":"application/vnd.visio",".wav":"audio/wav",".weba":"audio/webm",".webm":"video/webm",".webp":"image/webp",".woff":"font/woff",".woff2":"font/woff2",".xhtml":"application/xhtml+xml",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xml":"application/xml",".xul":"application/vnd.mozilla.xul+xml",".zip":"application/zip",".3gp":"video/3gpp",".3g2":"video/3gpp2",".7z":"application/x-7z-compressed"},s.convert.mime=function(e){var t,i,r,a,n;return null==e&&(e=null!=(i=null!=(r=null!=(a=this.params.fn)?a:this.params.mime)?r:this.params.filename)?i:this.params.file),"html"===(n=(-1===e.indexOf(".")?e:e.substr(e.lastIndexOf(".")+1)).toLowerCase())&&(n="htm"),"jpeg"===n&&(n="jpg"),"tiff"===n&&(n="tif"),"midi"===n&&(n="mid"),"string"==typeof(t=s.convert._mimes["."+n])&&t},s.convert.stream2txt=function(e){var i;return i=[],new Promise((s,r)=>(e.on("data",e=>i.push(t.from(e))),e.on("error",e=>r(e)),e.on("end",()=>s(t.concat(i).toString("utf8")))))},null==r.example&&(r.example={}),r.example.example=3,s.example=function(){var e;e={name:r.name,version:r.version,built:r.built};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}if(r.dev){try{null==e.headers&&(e.headers=this.headers)}catch(e){}try{null==e.parts&&(e.parts=this.parts)}catch(e){}try{null==e.params&&(e.params=this.params)}catch(e){}try{null==e.opts&&(e.opts=this.opts)}catch(e){}}return e},s.example._hides=!0,s.example.idx={_index:!0},s.example.restricted=function(){return{hello:this.user._id}},s.example.restricted._auth=!0,s.example.deep=async function(){var e;e={example:"deep",deeper:await this.example.deep.deeper()};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},s.example.deep.deeper=async function(){var e;e={hello:"deeper"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}try{e.deepest=await this.example.deep.deeper.deepest()}catch(e){}return e},s.example.deep.deeper.deepest=function(){var e;e={hello:"deepest"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},s.example.inbetween=function(){return console.log(typeof this.params.example),this.params},s.fetch=async function(e,i){var s,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k;if(null==e&&null==i)try{i=this.copy(this.params)}catch(e){}for("object"==typeof e&&null==i&&(e=(i=e).url),null==i&&(i={}),"number"==typeof i&&(i={cache:i}),"number"==typeof i.cache&&(null==i.cf&&(i.cf={cacheEverything:!0}),i.cf.cacheTtl=i.cache,delete i.cache),!e&&i.url&&(e=i.url,delete i.url),!0===i.bg&&"string"==typeof r.bg&&(i.url=e,e=r.bg+"/fetch",delete i.bg),i.username&&i.password&&(i.auth=i.username+":"+i.password,delete i.username,delete i.password),-1!==e.split("//")[1].split("@")[0].indexOf(":")&&(i.auth=e.split("//")[1].split("@")[0],e=e.replace(i.auth+"@","")),i.auth&&(null==i.headers&&(i.headers={}),i.headers.Authorization="Basic "+t.from(i.auth).toString("base64"),delete i.auth),o=0,h=(v=["data","content","json"]).length;o<h;o++)null!=i[n=v[o]]&&(i.body=i[n],delete i[n]);if(null!=i.body&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="object"==typeof i.body?"application/json":"text/plain"),"object"!=(b=typeof i.body)&&"boolean"!==b&&"number"!==b||(i.body=JSON.stringify(i.body)),null==i.method&&(i.method="POST")),null!=i.form){if(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"==typeof i.form)try{i.form=await this.form(i.form)}catch(e){}i.body=i.form,delete i.form,null==i.method&&(i.method="POST")}if("string"!=typeof e);else{if(e.includes("localhost"))try{null==i.agent&&(i.agent=new https.Agent({rejectUnauthorized:!1}))}catch(e){}if(e.includes("?")){for(f=(g=e.split("?")).shift()+"?",u=0,d=(w=g.join("?").split("&")).length;u<d;u++)y=w[u],f.endsWith("?")||(f+="&"),[c,k]=y.split("="),null==k&&(k=""),c&&(f+=encodeURIComponent(c)+(k?"="+(-1!==k.indexOf("%")?k:encodeURIComponent(k)):""));e=f}if(i.params&&"{}"!==JSON.stringify(i.params)){for(c in-1===e.indexOf("?")&&(e+="?"),_=i.params)k=_[c],e.endsWith("&")||e.endsWith("?")||(e+="&"),c&&(e+=encodeURIComponent(c)+"="+encodeURIComponent("object"==typeof k?JSON.stringify(k):k));delete i.params}r.system&&("string"==typeof r.bg&&e.startsWith(r.bg)||"string"==typeof r.kv&&r.kv.startsWith("http")&&e.startsWith(r.kv))&&(null==i.headers&&(i.headers={}),null==(a=i.headers)[p="x-"+r.name.toLowerCase()+"-system"]&&(a[p]=r.system),i.headers.Authorization||i.headers.authorization||i.headers["x-apikey"]||!this.user||(i.headers["x-apikey"]=this.user.apikey)),s=async()=>{var t,s;if(i.stream)return delete i.stream,fetch(e,i);s=await fetch(e,i),r.dev&&!0===r.bg&&console.log(s.status+" "+e),t=await s.text();try{"string"!=typeof t||0!==t.indexOf("{")&&0!==t.indexOf("[")||(t=JSON.parse(t))}catch(e){}return 404!==s.status?s.status>=400?(r.dev&&!0===r.bg&&console.log(i,JSON.stringify(t),"FETCH ERROR",s.status),{status:s.status}):t:void 0};try{i.timeout&&null!=(null!=this?this._timeout:void 0)?(m=!0===i.timeout?3e4:i.timeout,delete i.timeout,x=await this._timeout(m,s())):x=await s();try{0!==(x=x.trim()).indexOf("[")&&0!==x.indexOf("{")||(x=JSON.parse(x))}catch(e){}return x}catch(e){l=e,r.dev&&!0===r.bg&&console.log(l,JSON.stringify(l),"ERROR TRYING TO CALL FETCH");try{this.log(l)}catch(e){}}}},s.fetch._auth="system",s.fetch._hide=!0,null==r.log&&(r.log={}),c=[],h=!1,u=!1,s.log=async function(e,t){var i,s,a,n,l,o,d,p,f,m,g;if(i=async()=>{var e,t;for(!1!==h&&clearTimeout(h),h=setTimeout(i,3e4),u=Date.now(),t=new Date(u).toISOString().replace("T"," ").split(".")[0],e=[];e.length<400&&c.length;)e.push(c.shift());return e.length?(!0===this.S.bg&&console.log("Writing "+e.length+" logs to index",e[0]._id,e[e.length-1]._id,t),await this.index("logs",e)||(await this.index("logs",{}),await this.index("logs",e)),[]):!0===this.S.bg?console.log("Checked log batch but none to save",t):void 0},!1!==this.S.log&&!0!==this.nolog){if(!0!==t&&(t=null==e),"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(s=0,l=e.length;s<l;s++)n=e[s],this._logs.push(n);e=void 0}if(null==e){if(1===this.parts.length&&"log"===this.parts[0]){if(this.system)return c.push(this.body),!1===h&&i(),!0;e="object"==typeof this.body?this.body:this.params,Array.isArray(e)&&(e={logs:e})}null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method}}catch(e){}try{e.request.body=null!=this.body}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers=this.headers,e.request.headers.cookie&&(e.cookie=!0,delete e.request.headers.cookie)}catch(e){}try{null==e.fn&&null!=this.fn&&(e.fn=this.fn),this.refresh&&(e.refresh=this.refresh),e.parts=this.parts,this.completed&&(e.completed=this.completed),this.cached&&(e.cached=this.cached)}catch(e){}try{for(d in e.params={},this.params)e.params[d]="string"==typeof this.params[d]?this.params[d]:JSON.stringify(this.params[d])}catch(e){}try{e.apikey=null!=this.apikey}catch(e){}try{null!=(null!=(f=this.user)?f._id:void 0)&&(e.user=this.user._id)}catch(e){}this.unauthorised&&(e.unauthorised=!0)}else if("object"==typeof e&&e.res&&e.args)try{p=(await this.index("logs",'args:"'+e.args+'"')).hits.hits[0]._source,e.diff=e.checksum&&p.checksum?e.checksum!==p.checksum:e.res!==p.res}catch(e){}if(t){if(!e.logs&&(e.logs=[],Array.isArray(null!=this?this._logs:void 0)&&this._logs.length))for(a=0,o=(m=this._logs).length;a<o;a++)(n=m[a]).alert&&null==e.alert&&(e.alert=n.alert),n.notify&&null==e.notify&&(e.notify=n.notify),e.logs.push(n);e.createdAt=new Date,null==e.name&&(e.name=r.name),null==e.version&&(e.version=r.version),e.base=this.base,this.domain&&(e.domain=this.domain),!0===this.S.bg&&(e.bg=!0),!0===this.system&&(e.system=!0),!0===this.scheduled&&(e.scheduled=!0);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}if(e._id=this.rid,null!=(null!=(g=this.S.index)?g.url:void 0))!0===this.S.bg?(c.push(e),("object"==typeof this.S.log&&!1===this.S.log.batch||c.length>300||!1===u||Date.now()>u+3e4)&&i()):"string"!=typeof this.S.bg||"object"==typeof this.S.log&&!1===this.S.log.batch?(c.push(e),this.waitUntil(i())):this.waitUntil(this.fetch(this.S.bg+"/log",{body:e}));else try{this.kv("logs/"+e._id,e)}catch(t){console.log("Logging unable to save to kv or index"),consolg.log(e)}}else this._logs.push(e)}else this.S.dev&&!0===this.S.bg&&console.log("NOT logging",e);return!0},s.log._hide=!0,s.logs={_index:!0,_hide:!0,_auth:"system"};try{r.mail=JSON.parse(SECRETS_MAIL)}catch(e){r.mail={}}s.mail=async function(e){var t,i,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x;if(null!=(o=r.mail)?o.disabled:void 0)return{};if("string"==typeof e&&(e={text:e}),null==e&&(e=null!=(u=this.copy(null!=this?this.params:void 0))?u:{}),e.template){for(n in l=await this.template(e.template,null!=(f=null!=(m=e.vars)?m:e.params)?f:e))e[n]=l[n];delete e.template,delete e.vars,delete e.params}if(!e.text&&!e.html&&(e.text=null!=(g=null!=(y=null!=(v=null!=(b=e.content)?b:e.msg)?v:e.body)?y:this.body)?g:"","object"==typeof e.text))try{e.text=await this.convert.json2html(e.text)}catch(t){e.text=JSON.stringify(e.text)}return delete e.content,delete e.body,e.html||"string"!=typeof e.text||-1===e.text.indexOf("<")||-1===e.text.indexOf(">")||(e.html=e.text),a=(e.svc||e.service)&&null!=(null!=(w=this.S.svc[null!=(_=e.svc)?_:e.service])?w.mail:void 0)?this.S.svc[null!=(c=e.svc)?c:e.service].mail:null!=(h=null!=this&&null!=(d=this.S)?d.mail:void 0)?h:r.mail,null==e.from&&(e.from=a.from),null==e.to&&(e.to=a.to),delete e.svc,x="https://api.mailgun.net/v3/"+a.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),t=null!=(p=null!=this?this.fetch:void 0)?p:s.fetch,i=await this.form(e),await t(x,{method:"POST",form:i,auth:"api:"+a.apikey})},s.mail._hide=!0,s.mail._auth="system",s.mail.validate=async function(e,t){var i,s,r,a,n;if(null==e&&(e=null!=this&&null!=(r=this.params)?r.email:void 0),"string"==typeof e&&e.length&&(-1===e.indexOf(" ")||e.startsWith('"')&&2===e.split('"@').length)){try{if("string"==typeof t)return null!=(a=(n=await this.fetch("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e)+"&api_key="+t)).did_you_mean)?a:n.is_valid}catch(e){}if(2===(i=e.split("@")).length&&i[0].length&&i[0].length<65&&(i[0].startsWith('"')&&i[0].endsWith('"')||-1===i[0].indexOf(" ")&&-1===i[0].indexOf(",")&&-1===i[0].indexOf(":")&&-1===i[0].indexOf(";"))&&i[1].length&&-1===i[1].indexOf(",")&&-1===i[1].indexOf(" ")&&(s=i[1].split(".")).length>1&&(2!==s.length||"example"!==s[0]))return!0}return!1},null==r.mail&&(r.mail={}),null==(g=r.mail).from&&(g.from="system@oa.works"),null==(f=r.mail).to&&(f.to="mark@oa.works"),null==(p=r.src).google&&(p.google={});try{r.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}s.status=async function(){var t,i,s,a,n,l,o,u,c;for(c={name:r.name,version:r.version,built:r.built},t=0,a=(l=["uid","rid","params","base","parts","opts","routes"]).length;t<a;t++){s=l[t];try{null==c[s]&&(c[s]=this[s])}catch(e){}}!0===this.S.bg&&(c.bg=!0),c.kv=("string"==typeof this.S.kv&&e[this.S.kv]||"string"==typeof this.S.kv)&&this.S.kv;try{c.index=await this.index.status()}catch(e){}if(r.dev){if(c.bg=this.S.bg,!0!==this.S.bg)try{c.request=this.request}catch(e){}for(i=0,n=(o=["headers","cookie","user","body"]).length;i<n;i++){s=o[i];try{null==c[s]&&(c[s]=this[s])}catch(e){}}}else{try{c.index=c.index.status}catch(e){}c.kv&&(c.kv=!0),(null!=(u=this.user)?u.email:void 0)&&(c.user=this.user.email)}return c};o=[].indexOf;s.tdm={},s.tdm.occurrence=function(e,t,i){var s,r,a,n,l,o,u,c,h,d;if(null==e&&(e=null!=(a=null!=this&&null!=(n=this.params)?n.content:void 0)?a:null!=this&&null!=(l=this.params)?l.url:void 0),0===e.indexOf("http")&&(e=this.fetch(e)),null==t&&(t=null!=(o=null!=this&&null!=(u=this.params)?u.sub:void 0)?o:null!=this&&null!=(c=this.params)?c.q:void 0),null==i&&(i=null!=this&&null!=(h=this.params)?h.overlap:void 0),e+="",(t+="").length<=0)return e.length+1;for(s=0,r=0,d=i?1:t.length;(r=e.indexOf(t,r))>=0;)++s,r+=d;return s},s.tdm.levenshtein=function(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m;for(null==e&&(e=null!=this&&null!=(d=this.params)?d.a:void 0),null==t&&(t=null!=this&&null!=(p=this.params)?p.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),o=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(l=e.length)<(u=t.length)&&(s=e,e=t,t=s,c=l,l=u,u=c),h=[[]],s=0;s<u+1;)h[0][s]=s,s++;for(a=1;a<l+1;){for(h[a]=[a],n=1;n<u+1;)r=e.charAt(a-1)===t.charAt(n-1)?0:1,h[a][n]=o(h[a-1][n]+1,h[a][n-1]+1,h[a-1][n-1]+r),n++;a++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:l,b:u}}},s.tdm.hamming=function(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g;if(null==e&&(e=null!=this&&null!=(c=this.params)?c.a:void 0),null==t&&(t=null!=this&&null!=(h=this.params)?h.b:void 0),null==i&&(i=null==(d=null!=this&&null!=(p=this.params)?p.lowercase:void 0)||d),i&&(e=e.toLowerCase(),t=t.toLowerCase()),e.length<t.length?(f=e,n=t):(f=t,n=e),u=n.indexOf(f),g=f.split(""),(m=n.split("")).length>g.length){if(r=m.length-g.length,0<u)for(o=0;o<u;)g.unshift(""),o++,r--;for(s=0;s<r;)g.push(""),s++}for(a in l=0,m)g[a]!==m[a]&&l++;return l},s.tdm.extract=async function(e){var t,i,s,r,a,n,l,o,u,c,h;if(e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=await this.puppet(e.url)),e.convert)try{h=await this.convert[e.convert+"2txt"](null!=(o=e.url)?o:e.content)}catch(e){}if(null==h&&(h=e.content),null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(l=h.split(e.start),h=l.length>1?l[1]:l[0]),null!=e.end&&(h=h.split(e.end)[0]),e.lowercase&&(h=h.toLowerCase()),e.ascii&&(h=h.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(h=h.replace(/ /g,"")),c={length:h.length,matched:0,matches:[],matchers:e.matchers,text:h},h&&"number"!=typeof h)for(t=0,s=(u="string"==typeof e.matchers?e.matchers.split(","):e.matchers).length;t<s;t++){"string"==typeof(a=u[t])?(n="",0===a.indexOf("/")?(i=a.lastIndexOf("/"))+1!==a.length&&(n=a.substring(i+1),a=a.substring(1,i)):a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")):n="",e.lowercase&&(n+="i");try{(r=new RegExp(a,n).exec(h))&&(c.matched+=1,c.matches.push({matched:a.toString(),result:r}))}catch(e){}}return c},s.tdm.emails=function(e={}){var t,i,r,a,n,l,u,c,h,d,p,f,m;for(e.matchers=["/([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"],i=[],t=[],r=0,a=(c=s.tdm.extract(e).matches).length;r<a;r++)for(l=0,n=(h=c[r].result).length;l<n;l++)u=h[l],o.call(t,u)<0&&("function"!=typeof(null!=(null!=(d=s.mail)?d.validate:void 0))||s.mail.validate(u,null!=(p=s.settings.service)&&null!=(f=p.openaccessbutton)&&null!=(m=f.mail)?m.pubkey:void 0).is_valid)&&i.push(u),t.push(u);return i},s.tdm.stopwords=function(e,t,i=!0){var s,r,a,n,l,u;if(null==e&&(e=["purl","w3","http","https","ref","html","www","ref","cite","url","title","date","nbsp","doi","fig","figure","supplemental","year","time","january","february","march","april","may","june","july","august","september","october","november","december","jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec","keywords","revised","accepted","file","attribution","org","com","id","wp","main","website","blogs","media","people","years","made","location","its","asterisk","called","xp","er","image","jpeg","jpg","png","php","object","false","true","article","chapter","book","caps","isbn","scale","axis","accessed","email","e-mail","story","first1","first2","last1","last2","general","list","accessdate","view_news","d0","dq","sfnref","onepage","sfn","authorlink"]),i=["apos","as","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","aint","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","arent","around","as","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","cmon","cs","came","can","cant","cannot","cant","cause","causes","certain","certainly","changes","clearly","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldnt","course","currently","definitely","described","despite","did","didnt","different","do","does","doesnt","doing","dont","done","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadnt","happens","hardly","has","hasnt","have","havent","having","he","hes","hello","help","hence","her","here","heres","hereafter","hereby","herein","hereupon","hers","herself","hi","him","himself","his","hither","hopefully","how","howbeit","however","i","I","id","ill","im","ive","ie","if","ignored","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isnt","it","itd","itll","its","itself","just","keep","keeps","kept","know","knows","known","last","lately","later","latter","latterly","least","less","lest","let","lets","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldnt","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","ts","take","taken","tell","tends","th","than","thank","thanks","thanx","that","thats","thats","the","their","theirs","them","themselves","then","thence","there","theres","thereafter","thereby","therefore","therein","theres","thereupon","these","they","theyd","theyll","theyre","theyve","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasnt","way","we","wed","well","weve","welcome","well","went","were","werent","what","whats","whatever","when","whence","whenever","where","wheres","whereafter","whereas","whereby","wherein","whereupon","wherever","whether","which","while","whither","who","whos","whoever","whole","whom","whose","why","will","willing","wish","with","within","without","wont","wonder","would","would","wouldnt","yes","yet","you","youd","youll","youre","youve","your","yours","yourself","yourselves","zero"])for(r=0,a=i.length;r<a;r++)s=i[r],o.call(e,s)<0&&e.push(s);if(t)for("string"==typeof t&&(t=t.split(",")),u=0,n=t.length;u<n;u++)l=t[u],o.call(e,l)<0&&e.push(l);return e};o=[].indexOf;s.uid=function(e){var t,i,s,r,a,n,o,u,c,h,d;return null==e&&(e="uid"===this.fn&&null!=(t=null!=(i=null!=(s=null!=(r=null!=this&&null!=(a=this.params)?a.len:void 0)?r:null!=this&&null!=(n=this.params)?n.length:void 0)?s:null!=this&&null!=(o=this.params)?o.size:void 0)?i:null!=this&&null!=(u=this.params)?u.uid:void 0)?t:21),"string"==typeof e&&(d=parseInt(e),e=isNaN(d)?void 0:d),Object(l.a)(null!=(c=null!=this&&null!=(h=this.params)?h.alphabet:void 0)?c:"0123456789abcdefghijklmnopqrstuvwxyz",e)()},s.uid._cache=!1,s.hash=async function(e){var t,i,s,r,a,n,l,o,u,c;null==e&&(e=null!=(l=null!=(o=null!=(u=null!=(c=this.params.hash)?c:this.params.content)?u:this.params.q)?o:this.params)?l:this.body);try{this.params.url&&(e=await this.fetch(this.params.url))}catch(e){}"string"!=typeof e&&(e=JSON.stringify(e));try{for(e=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",e),t=new Uint8Array(s),n=[],r=0,a=t.length;r<a;r++)i=t[r],n.push(("00"+i.toString(16)).slice(-2));return n.join("")}catch(t){return crypto.createHash("sha256").update(e,"utf8").digest("hex")}},s.hashcode=function(e){var t,i,s,r,a,n;for(null==e&&(e=null!=(s=null!=(r=null!=(a=null!=(n=this.params.hashcode)?n:this.params.content)?a:this.params.q)?r:this.params)?s:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),t=0,i=0;i<e.length;)t=(t<<5)-t+e.charCodeAt(i),t&=t,i++;return t},s.hashhex=function(e){var t;return null==e&&(e=this.params.hashhex),(t=this.hashcode(e))<0&&(t=4294967295+t+1),t.toString(16)},s.shorthash=function(e,t){var i,s,r,a,n,l,o,u;for(null==e&&(e=null!=(r=null!=(a=null!=(n=null!=(l=this.params.shorthash)?l:this.params.content)?n:this.params.q)?a:this.params)?r:this.body),"string"!=typeof e&&(e=JSON.stringify(e)),s=this.hashcode(e),t?(u=t.substring(0,1),t=t.replace(u,"")):(t="0123456789abcdefghijklmnoqrstuvwxyz",u="p"),i=t.length,o=s<0?u:"",s=Math.abs(s);s>=i;)o+=t[s%i],s=Math.floor(s/i);return o+(s>0?t[s]:"")},s.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise(t=>setTimeout(t,null!=e?e:1e3))},s.sleep._hide=!0,s._timeout=function(e,t){return new Promise((t,i)=>{var s;return s=setTimeout(()=>i(new Error("TIMEOUT")),e),promise.then(value(()=>(clearTimeout(s),t(value)))).catch(reason(()=>(clearTimeout(s),i(reason))))})},s.form=function(e){var t,i,s,r,a,n;for(s in null==e&&(e=this.params),r="",e)for(""!==r&&(r+="&"),t=0,i=(n=Array.isArray(e[s])?e[s]:[e[s]]).length;t<i;t++)null!=(a=n[t])&&(r.endsWith("&")||(r+="&"),r+=s+"="+encodeURIComponent("object"==typeof a?JSON.stringify(a):a));return r},s.decode=async function(e){var t,i,s,r,a,n,l,o,u,c;for(null==e&&(e=null!=(n=null!=(l=null!=(o=this.params.decode)?o:this.params.content)?l:this.params.text)?n:this.body),t=function(e){var t,i;return i=/&(nbsp|amp|quot|lt|gt);/g,t={nbsp:" ",amp:"&",quot:'"',lt:"<",gt:">"},e.replace(i,(function(e,i){return t[i]})).replace(/&#(\d+);/gi,(function(e,t){var i;return i=parseInt(t,10),String.fromCharCode(i)}))},c=(c=await t(e)).replace(/\n/g," "),s=0,r=(u=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;s<r;s++)i=u[s],a=new RegExp(i.bad,"g"),c=c.replace(a,i.good);return-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),-1!==c.indexOf("%2")&&(c=decodeURIComponent(c)),c},s.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},s.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&o.call(i,t)<0&&i.push(t);return i},s.dot=function(e,t){var i,s,r,a,n;"string"==typeof e&&"object"==typeof t&&(n=e,e=t,t=n),null==e&&null!=(null!=this&&null!=(r=this.params)?r.key:void 0)&&(t=(e=this.copy(this.params)).key),"string"==typeof t&&(t=t.split("."));try{for(a=e,i=0,s=t.length;i<s;i++)a=a[t[i]];return a}catch(e){}},s.flatten=async function(e){var t,i,s,r,a,n;if(null==e&&(e=this.params),a={},t=async function(e,i){var s,r,n,l,o;for(s in l=[],e)n=i?i+"."+s:s,"string"==typeof(o=e[s])?l.push(a[n]=o):Array.isArray(o)?"object"==typeof o[0]?l.push(await async function(){var e;for(r in e=[],o)e.push(await t(o[r],n+"."+r));return e}()):l.push(a[n]=o.join(", ")):l.push(await t(o,n));return l},Array.isArray(e)){for(n=[],s=0,r=data.length;s<r;s++)i=data[s],a={},n.push(await t(i));return n}return await t(e),a},s.template=async function(e,t){var i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_;if(null==e&&(e=null!=(m=null!=(g=this.params.content)?g:this.params.template)?m:this.body),null==t&&(t=this.params),(this.params.url||e.startsWith("http"))&&(e=await this.fetch(null!=(y=this.params.url)?y:e)),-1===e.indexOf(" ")&&-1!==e.indexOf(".")&&e.length<100)try{s=await this._templates(e),e=s.content}catch(e){}if(b={},(i=function(t,s=""){var r,a,n,l;for(r in n=[],t)a=s?s+"."+r:r,"object"!=typeof t[r]||Array.isArray(t[r])?-1!==e.toLowerCase().indexOf("{{"+a+"}}")?(l=new RegExp("{{"+a+"}}","gi"),n.push(e=e.replace(l,Array.isArray(t[r])?t[r].join(", "):"string"==typeof t[r]?t[r]:!0===t[r]?"Yes":!1===t[r]?"No":""))):n.push(void 0):n.push(i(t[r],s+(""===s?"":".")+r));return n})(t),u=new RegExp("{{.*?}}","gi"),-1!==e.indexOf("{{")){for(_=["subject","from","to","cc","bcc"],r=0,d=(v=e.toLowerCase().split("{{")).length;r<d;r++)f=v[r].split("{{")[0].split("}}")[0].split(" ")[0],o.call(_,f)<0&&_.push(f);for(h=0,p=_.length;h<p;h++)a=_[h],(n=-1!==e.toLowerCase().indexOf("{{"+a)?a:void 0)&&(l=-1!==e.indexOf("{{"+n.toUpperCase())?n.toUpperCase():n,(w=e.split("{{"+l)[1]).split("}}")[0].indexOf("{{")&&(w=w.replace(u,"")),(w=w.split("}}")[0].trim())&&(b[n]=w),c=new RegExp("{{"+l+".*?}}","gi"),e=e.replace(c,""))}return-1!==e.indexOf("{{")&&(e=e.replace(u,"")),b.content=e,b},s.device=function(){var e,t;t={};try{e=this.request.cf,t.colo=e.colo,t.city=e.city,t.lat=e.latitude,t.lon=e.longitude}catch(e){}return t.ip=this.headers.ip,t.country=this.headers["cf-ipcountry"],t.accept=this.headers.accept,t["accept-language"]=this.headers["accept-language"],t["user-agent"]=this.headers["user-agent"],t["user-agent-hash"]=this.hashhex(this.headers["user-agent"]),t},s.device._cache=!1,s.date=function(e,t){var i,s,r,a,n;if(null==e&&(e=null!=(r=this.params.date)?r:Date.now()),null==t&&(t=this.params.time),"number"==typeof e||"string"==typeof e&&-1===e.indexOf(" ")&&-1===e.indexOf("/")&&-1===e.indexOf("-")&&e.length>8&&-1===e.indexOf("T"))try{return n=(n=new Date(parseInt(e))).toISOString(),t?n:n.split("T")[0]}catch(e){}try{if("number"==typeof e&&(e=e.toString()),Array.isArray(e)&&1===e.length&&Array.isArray(e[0])&&(e=e[0]),"string"!=typeof e)try{for(i in e)"number"!=(a=typeof e[i])&&"string"!==a&&(e[i]="01");e=e.join("-")}catch(e){}return-1!==(e=decodeURIComponent(e)).indexOf("T")&&(e=e.split("T")[0]),-1===(e=e.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1")).indexOf("-")&&(e+="-01"),3!==(s=e.split("-")).length&&(s=(e+="-01").split("-")),3!==s.length&&(e=void 0),s[0].length<s[2].length&&(e=s.reverse().join("-")),e}catch(e){}},s.date._cache=!1,s.datetime=function(){var e;return this.date(this.params.datetime,null==(e=this.params.time)||e)},s.datetime._cache=!1,s.epoch=function(e){var t,i,s,r,a;if(null==e&&(e=this.params.epoch),"number"==typeof e&&(e=e.toString()),!e)return Date.now();if(!(e.startsWith("+")||e.startsWith("-")||2===e.split("+").length&&e.split("+")[0].length>4||2===e.split("-").length&&e.split("-")[0].length>4)){if(e.length>8&&!e.includes("-")&&!isNaN(parseInt(e)))return this.date(e,null==(s=this.params.time)||s);for(4===e.length&&(e+="-01"),e.split("-").length<3&&(e+="-01"),-1===e.indexOf("T")&&(e+="T"),-1===e.indexOf(":")&&(e+="00:00"),e.split(":").length<3&&(e+=":00"),-1===e.indexOf(".")&&(e+="."),[r,i]=e.split("."),i=i.replace("Z","").replace("z","");i.length<3;)i+="0";return-1===i.indexOf("Z")&&(i+="Z"),new Date(r+"."+i).valueOf()}return(e.startsWith("+")||e.startsWith("-"))&&(e=Date.now()+e),e.includes("+")?([e,t]=e.replace("/","").split("+"),(parseInt(e)+parseInt(t)).toString()):e.includes("-")?([e,a]=e.replace("/","").split("-"),(parseInt(e)-parseInt(a)).toString()):void 0},s.epoch._cache=!1,s._subroutes=async function(e){var t,i;return i=[],t=(e,s,r)=>{var a,n,l,o;for(a in o=[],e)"function"==(l=typeof e[a])||"object"===l?(n=(null!=s?s:"")+(s?".":"")+a,a.startsWith("_")||!("function"==typeof e[a]||e[a]._index||e[a]._kv||e[a]._sheet)||e[a]._hide||e[a]._hides||r||n.startsWith("scripts")||-1!==n.indexOf(".scripts")||i.push(n.replace(/\./g,"/")),Array.isArray(e[a])||a.startsWith("_")?o.push(void 0):o.push(t(e[a],n,null!=r?r:e[a]._hides))):o.push(void 0);return o},e&&("string"==typeof e&&(e=e.replace(/\//g,".")),t("string"==typeof e?await this.dot(s,e):e)),i},s.passphrase=function(e,t){var i,r,a,n,l,o,u;for(null==e&&(e=null!=(i=null!=(r=this.params.passphrase)?r:this.params.len)?i:4),null==t&&(t=null!=(a=null!=(n=this.params.lowercase)?n:this.params.lower)&&a),u=[],o=s._passphrase_words.length;u.length<e;)l=s._passphrase_words[Math.floor(Math.random()*o)],u.push(t?l:l.substring(0,1).toUpperCase()+l.substring(1));return u.join("")},s.passphrase._cache=!1,s._passphrase_words=["ability","able","aboard","about","above","accept","accident","according","account","accurate","acres","across","act","action","active","activity","actual","actually","add","addition","additional","adjective","adult","adventure","advice","affect","afraid","after","afternoon","again","against","age","ago","agree","ahead","aid","air","airplane","alike","alive","all","allow","almost","alone","along","aloud","alphabet","already","also","although","am","among","amount","ancient","angle","angry","animal","announced","another","answer","ants","any","anybody","anyone","anything","anyway","anywhere","apart","apartment","appearance","apple","applied","appropriate","are","area","arm","army","around","arrange","arrangement","arrive","arrow","art","article","as","aside","ask","asleep","at","ate","atmosphere","atom","atomic","attached","attack","attempt","attention","audience","author","automobile","available","average","avoid","aware","away","baby","back","bad","badly","bag","balance","ball","balloon","band","bank","bar","bare","bark","barn","base","baseball","basic","basis","basket","bat","battle","be","bean","bear","beat","beautiful","beauty","became","because","become","becoming","bee","been","before","began","beginning","begun","behavior","behind","being","believed","bell","belong","below","belt","bend","beneath","bent","beside","best","bet","better","between","beyond","bicycle","bigger","biggest","bill","birds","birth","birthday","bit","bite","black","blank","blanket","blew","blind","block","blood","blow","blue","board","boat","body","bone","book","border","born","both","bottle","bottom","bound","bow","bowl","box","boy","brain","branch","brass","brave","bread","break","breakfast","breath","breathe","breathing","breeze","brick","bridge","brief","bright","bring","broad","broke","broken","brother","brought","brown","brush","buffalo","build","building","built","buried","burn","burst","bus","bush","business","busy","but","butter","buy","by","cabin","cage","cake","call","calm","came","camera","camp","can","canal","cannot","cap","capital","captain","captured","car","carbon","card","care","careful","carefully","carried","carry","case","cast","castle","cat","catch","cattle","caught","cause","cave","cell","cent","center","central","century","certain","certainly","chain","chair","chamber","chance","change","changing","chapter","character","characteristic","charge","chart","check","cheese","chemical","chest","chicken","chief","child","children","choice","choose","chose","chosen","church","circle","circus","citizen","city","class","classroom","claws","clay","clean","clear","clearly","climate","climb","clock","close","closely","closer","cloth","clothes","clothing","cloud","club","coach","coal","coast","coat","coffee","cold","collect","college","colony","color","column","combination","combine","come","comfortable","coming","command","common","community","company","compare","compass","complete","completely","complex","composed","composition","compound","concerned","condition","congress","connected","consider","consist","consonant","constantly","construction","contain","continent","continued","contrast","control","conversation","cook","cookies","cool","copper","copy","corn","corner","correct","correctly","cost","cotton","could","count","country","couple","courage","course","court","cover","cow","cowboy","crack","cream","create","creature","crew","crop","cross","crowd","cry","cup","curious","current","curve","customs","cut","cutting","daily","damage","dance","danger","dangerous","dark","darkness","date","daughter","dawn","day","dead","deal","dear","death","decide","declared","deep","deeply","deer","definition","degree","depend","depth","describe","desert","design","desk","detail","determine","develop","development","diagram","diameter","did","die","differ","difference","different","difficult","difficulty","dig","dinner","direct","direction","directly","dirt","dirty","disappear","discover","discovery","discuss","discussion","disease","dish","distance","distant","divide","division","do","doctor","does","dog","doing","doll","dollar","done","donkey","door","dot","double","doubt","down","dozen","draw","drawn","dream","dress","drew","dried","drink","drive","driven","driver","driving","drop","dropped","drove","dry","duck","due","dug","dull","during","dust","duty","each","eager","ear","earlier","early","earn","earth","easier","easily","east","easy","eat","eaten","edge","education","effect","effort","egg","eight","either","electric","electricity","element","elephant","eleven","else","empty","end","enemy","energy","engine","engineer","enjoy","enough","enter","entire","entirely","environment","equal","equally","equator","equipment","escape","especially","essential","establish","even","evening","event","eventually","ever","every","everybody","everyone","everything","everywhere","evidence","exact","exactly","examine","example","excellent","except","exchange","excited","excitement","exciting","exclaimed","exercise","exist","expect","experience","experiment","explain","explanation","explore","express","expression","extra","eye","face","facing","fact","factor","factory","failed","fair","fairly","fall","fallen","familiar","family","famous","far","farm","farmer","farther","fast","fastened","faster","fat","father","favorite","fear","feathers","feature","fed","feed","feel","feet","fell","fellow","felt","fence","few","fewer","field","fierce","fifteen","fifth","fifty","fight","fighting","figure","fill","film","final","finally","find","fine","finest","finger","finish","fire","fireplace","firm","first","fish","five","fix","flag","flame","flat","flew","flies","flight","floating","floor","flow","flower","fly","fog","folks","follow","food","foot","football","for","force","foreign","forest","forget","forgot","forgotten","form","former","fort","forth","forty","forward","fought","found","four","fourth","fox","frame","free","freedom","frequently","fresh","friend","friendly","frighten","frog","from","front","frozen","fruit","fuel","full","fully","fun","function","funny","fur","furniture","further","future","gain","game","garage","garden","gas","gasoline","gate","gather","gave","general","generally","gentle","gently","get","getting","giant","gift","girl","give","given","giving","glad","glass","globe","go","goes","gold","golden","gone","good","goose","got","government","grabbed","grade","gradually","grain","grandfather","grandmother","graph","grass","gravity","gray","great","greater","greatest","greatly","green","grew","ground","group","grow","grown","growth","guard","guess","guide","gulf","gun","habit","had","hair","half","halfway","hall","hand","handle","handsome","hang","happen","happened","happily","happy","harbor","hard","harder","hardly","has","hat","have","having","hay","he","headed","heading","health","heard","hearing","heart","heat","heavy","height","held","hello","help","helpful","her","herd","here","herself","hidden","hide","high","higher","highest","highway","hill","him","himself","his","history","hit","hold","hole","hollow","home","honor","hope","horn","horse","hospital","hot","hour","house","how","however","huge","human","hundred","hung","hungry","hunt","hunter","hurried","hurry","hurt","husband","ice","idea","identity","if","ill","image","imagine","immediately","importance","important","impossible","improve","in","inch","include","including","income","increase","indeed","independent","indicate","individual","industrial","industry","influence","information","inside","instance","instant","instead","instrument","interest","interior","into","introduced","invented","involved","iron","is","island","it","its","itself","jack","jar","jet","job","join","joined","journey","joy","judge","jump","jungle","just","keep","kept","key","kids","kill","kind","kitchen","knew","knife","know","knowledge","known","label","labor","lack","lady","laid","lake","lamp","land","language","large","larger","largest","last","late","later","laugh","law","lay","layers","lead","leader","leaf","learn","least","leather","leave","leaving","led","left","leg","length","lesson","let","letter","level","library","lie","life","lift","light","like","likely","limited","line","lion","lips","liquid","list","listen","little","live","living","load","local","locate","location","log","lonely","long","longer","look","loose","lose","loss","lost","lot","loud","love","lovely","low","lower","luck","lucky","lunch","lungs","lying","machine","machinery","mad","made","magic","magnet","mail","main","mainly","major","make","making","man","managed","manner","manufacturing","many","map","mark","market","married","mass","massage","master","material","mathematics","matter","may","maybe","me","meal","mean","means","meant","measure","meat","medicine","meet","melted","member","memory","men","mental","merely","met","metal","method","mice","middle","might","mighty","mile","military","milk","mill","mind","mine","minerals","minute","mirror","missing","mission","mistake","mix","mixture","model","modern","molecular","moment","money","monkey","month","mood","moon","more","morning","most","mostly","mother","motion","motor","mountain","mouse","mouth","move","movement","movie","moving","mud","muscle","music","musical","must","my","myself","mysterious","nails","name","nation","national","native","natural","naturally","nature","near","nearby","nearer","nearest","nearly","necessary","neck","needed","needle","needs","negative","neighbor","neighborhood","nervous","nest","never","new","news","newspaper","next","nice","night","nine","no","nobody","nodded","noise","none","noon","nor","north","nose","not","note","noted","nothing","notice","noun","now","number","numeral","nuts","object","observe","obtain","occasionally","occur","ocean","of","off","offer","office","officer","official","oil","old","older","oldest","on","once","one","only","onto","open","operation","opinion","opportunity","opposite","or","orange","orbit","order","ordinary","organization","organized","origin","original","other","ought","our","ourselves","out","outer","outline","outside","over","own","owner","oxygen","pack","package","page","paid","pain","paint","pair","palace","pale","pan","paper","paragraph","parallel","parent","park","part","particles","particular","particularly","partly","parts","party","pass","passage","past","path","pattern","pay","peace","pen","pencil","people","per","percent","perfect","perfectly","perhaps","period","person","personal","pet","phrase","physical","piano","pick","picture","pictured","pie","piece","pig","pile","pilot","pine","pink","pipe","pitch","place","plain","plan","plane","planet","planned","planning","plant","plastic","plate","plates","play","pleasant","please","pleasure","plenty","plural","plus","pocket","poem","poet","poetry","point","pole","police","policeman","political","pond","pony","pool","poor","popular","population","porch","port","position","positive","possible","possibly","post","pot","potatoes","pound","pour","powder","power","powerful","practical","practice","prepare","present","president","press","pressure","pretty","prevent","previous","price","pride","primitive","principal","principle","printed","private","prize","probably","problem","process","produce","product","production","program","progress","promised","proper","properly","property","protection","proud","prove","provide","public","pull","pupil","pure","purple","purpose","push","put","putting","quarter","queen","question","quick","quickly","quiet","quietly","quite","rabbit","race","radio","railroad","rain","raise","ran","ranch","range","rapidly","rate","rather","raw","rays","reach","read","reader","ready","real","realize","rear","reason","recall","receive","recent","recently","recognize","record","red","refer","refused","region","regular","related","relationship","religious","remain","remarkable","remember","remove","repeat","replace","replied","report","represent","require","research","respect","rest","result","return","review","rhyme","rhythm","rice","rich","ride","riding","right","ring","rise","rising","river","road","roar","rock","rocket","rocky","rod","roll","roof","room","root","rope","rose","rough","round","route","row","rubbed","rubber","rule","ruler","run","running","rush","sad","saddle","safe","safety","said","sail","sale","salmon","salt","same","sand","sang","sat","satellites","satisfied","save","saved","saw","say","scale","scared","scene","school","science","scientific","scientist","score","screen","sea","search","season","seat","second","secret","section","see","seed","seeing","seems","seen","seldom","select","selection","sell","send","sense","sent","sentence","separate","series","serious","serve","service","sets","setting","settle","settlers","seven","several","shade","shadow","shake","shaking","shall","shallow","shape","share","sharp","she","sheep","sheet","shelf","shells","shelter","shine","shinning","ship","shirt","shoe","shoot","shop","shore","short","shorter","shot","should","shoulder","shout","show","shown","shut","sick","sides","sight","sign","signal","silence","silent","silk","silly","silver","similar","simple","simplest","simply","since","sing","single","sink","sister","sit","sitting","situation","six","size","skill","skin","sky","slabs","slave","sleep","slept","slide","slight","slightly","slip","slipped","slope","slow","slowly","small","smaller","smallest","smell","smile","smoke","smooth","snake","snow","so","soap","social","society","soft","softly","soil","solar","sold","soldier","solid","solution","solve","some","somebody","somehow","someone","something","sometime","somewhere","son","song","soon","sort","sound","source","south","southern","space","speak","special","species","specific","speech","speed","spell","spend","spent","spider","spin","spirit","spite","split","spoken","sport","spread","spring","square","stage","stairs","stand","standard","star","stared","start","state","statement","station","stay","steady","steam","steel","steep","stems","step","stepped","stick","stiff","still","stock","stomach","stone","stood","stop","stopped","store","storm","story","stove","straight","strange","stranger","straw","stream","street","strength","stretch","strike","string","strip","strong","stronger","struck","structure","struggle","stuck","student","studied","studying","subject","substance","success","successful","such","sudden","suddenly","sugar","suggest","suit","sum","summer","sun","sunlight","supper","supply","support","suppose","sure","surface","surprise","surrounded","swam","sweet","swept","swim","swimming","swing","swung","syllable","symbol","system","table","tail","take","taken","tales","talk","tall","tank","tape","task","taste","taught","tax","tea","teach","teacher","team","tears","teeth","telephone","television","tell","temperature","ten","tent","term","terrible","test","than","thank","that","thee","them","themselves","then","theory","there","therefore","these","they","thick","thin","thing","think","third","thirty","this","those","thou","though","thought","thousand","thread","three","threw","throat","through","throughout","throw","thrown","thumb","thus","thy","tide","tie","tight","tightly","till","time","tin","tiny","tip","tired","title","to","tobacco","today","together","told","tomorrow","tone","tongue","tonight","too","took","tool","top","topic","torn","total","touch","toward","tower","town","toy","trace","track","trade","traffic","trail","train","transportation","trap","travel","treated","tree","triangle","tribe","trick","tried","trip","troops","tropical","trouble","truck","trunk","truth","try","tube","tune","turn","twelve","twenty","twice","two","type","typical","uncle","under","underline","understanding","unhappy","union","unit","universe","unknown","unless","until","unusual","up","upon","upper","upward","us","use","useful","using","usual","usually","valley","valuable","value","vapor","variety","various","vast","vegetable","verb","vertical","very","vessels","victory","view","village","visit","visitor","voice","volume","vote","vowel","voyage","wagon","wait","walk","wall","want","war","warm","warn","was","wash","waste","watch","water","wave","way","we","weak","wealth","wear","weather","week","weigh","weight","welcome","well","went","were","west","western","wet","whale","what","whatever","wheat","wheel","when","whenever","where","wherever","whether","which","while","whispered","whistle","white","who","whole","whom","whose","why","wide","widely","wife","wild","will","willing","win","wind","window","wing","winter","wire","wise","wish","with","within","without","wolf","women","won","wonder","wonderful","wood","wooden","wool","word","wore","work","worker","world","worried","worry","worse","worth","would","wrapped","write","writer","writing","written","wrong","wrote","yard","year","yellow","yes","yesterday","yet","you","young","younger","your","yourself","youth","zero","zoo"],s.cache=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d;if("number"!=typeof i&&(i="number"==typeof this.S.cache?this.S.cache:this.S.dev?120:43200),!1===this.S.cache||!0===this.S.bg);else{try{null==e&&(e=this.request);try{for(d=e.url.toString(),l=0,o=(u=["refresh"]).length;l<o;l++)a=u[l],-1!==d.indexOf(a+"=")&&(n=new RegExp(a+"=.*?&"),d=d.replace(n,"")),-1!==d.indexOf("&"+a+"=")&&(d=d.split("&"+a+"=")[0]);r=new URL(d)}catch(e){}}catch(e){}if(null!=e)try{if(null==r&&(r=new URL(e.url)),s=new Request(r.toString().replace("?refresh=true","").replace("&refresh=true",""),e),null==t||""===t)return h=await caches.default.match(s),""===t&&this.waitUntil(caches.default.delete(s)),h;t=t.clone(),(c=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(s,c))}catch(e){}}},s.cache._hide=!0,s.cache._auth="system";var f,m;o=[].indexOf;null==r.index&&(r.index={}),null==(g=r.index).name&&(g.name=null!=(m=r.name)?m:"Paradigm"),"string"!=typeof r.index.name&&(r.index.name=""),r.index.name=r.index.name.toLowerCase().replace(/\s/g,""),"string"==typeof r.bg&&null==(f=r.index).url&&(f.url=r.bg+"/index"),s.index=async function(e,t,i,r){var a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w;if("object"==typeof e&&(t=e,e=void 0),null==e&&null==t&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]){if(this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(h=this.parts[1])||"src"===h))return{status:403};if("object"==typeof this.body?t=this.copy(this.body):"string"==typeof this.body?""!==this.body&&(t=this.body):t=this.copy(this.params),delete t.route,delete t.index,delete t[this.fn.split(".").pop()],delete t._id,null!=t.script||-1!==JSON.stringify(t).toLowerCase().indexOf("<script"))return}if("object"!=typeof t||Array.isArray(t)||(null==e&&(e=null!=(d=t.route)?d:t.index),delete t.route,delete t.index),null==e)if(null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]){if(1===this.parts.length){for(l in g=[],(await this.index._send("_stats")).indices)l.startsWith(".")||l.startsWith("security-")||g.push(l);return g}2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else null!=(null!=this?this.fn:void 0)&&(e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_","")));if("string"==typeof e)if(e.includes("?")?([e,w]=e.split("?"),w="?"+w):w="",e.endsWith("/")&&(e=e.replace(/\/$/,"")),"object"==typeof t&&!Array.isArray(t)&&t._id&&(n=(t=null!=(null!=this?this.copy:void 0)?this.copy(t):s.copy(t))._id.replace(/\//g,"_"),-1===e.indexOf("/")&&-1===e.indexOf(n)&&(e+="/"+n),delete t._id),b=(e=e.toLowerCase()).split("/").length,null==this.index&&(this.index=s.index),null!=(null!=this?this.parts:void 0)&&"index"===this.parts[0]&&this.parts[1]===e.split("/")[0]&&("DELETE"===this.request.method||this.params._delete)||""===t)y=await this.index._send(e.replace("/","/_doc/")+w,"");else if(1===b){if("string"==typeof t&&(""===t||-1!==t.indexOf("\n"))||Array.isArray(t))return""===t?this.index._send(e+w,t):this.index._bulk(e+w,t);if("object"!=(p=typeof t)&&"string"!==p)return this.index._send(e+"/_search"+w);if("{}"!==JSON.stringify(t)&&(c=await this.index.translate(t,i)))return this.index._send(e+"/_search"+w,c);if("object"==typeof t){for(a=null!=(null!=this?this.copy:void 0)?this.copy(t):s.copy(t),o=0,u=(f=["settings","aliases","mappings"]).length;o<u;o++)delete a[f[o]];return"{}"===JSON.stringify(a)?(await this.index._send(e+w)||await this.index._send(e+w,{settings:t.settings,aliases:t.aliases,mappings:t.mappings}),this.index._send(e+"/_search"+w)):"created"===(null!=(y=await this.index._send(e+"/_doc"+w,t))?y.result:void 0)&&y._id?y._id:y}}else if(2===b&&(null==t||"object"==typeof t&&!Array.isArray(t)))return e.startsWith("_")||e.includes("/_")||(e=e.replace("/","/_doc/")),null!=t&&"{}"!==JSON.stringify(t)?("object"==typeof t&&null!=t.script&&(e+="_update",w+=(w.length?"&":"?")+"retry_on_conflict=2"),"created"===(null!=(y=await this.index._send(e+w,t))?y.result:void 0)&&y._id?y._id:y):("object"==typeof(y=await this.index._send(e+w))&&(y._source||y.fields)&&(null==(v=null!=(m=y._source)?m:y.fields)._id&&(v._id=y._id),y=v),y)},s.index._auths="system",s.index._hides=!0,s.index._wraps=!1,s.index._caches=!1,s.index.status=async function(){var e,t,i,s,r,a,n,l,o,u,c,h,d;for(t in(u={status:"green"}).indices={},c=await this.index._send("_stats"),d=await this.index._send("_cat/shards?format=json"),c.indices)if(!t.startsWith(".")&&!t.startsWith("security-"))for(u.indices[t]={docs:c.indices[t].primaries.docs.count,size:Math.ceil(c.indices[t].primaries.store.size_in_bytes/1024/1024)+"mb"},i=0,a=d.length;i<a;i++)(h=d[i]).index===t&&"p"===h.prirep&&(null==(e=u.indices[t]).shards&&(e.shards=0),u.indices[t].shards+=1);try{for("green"!==(l=u.cluster.status)&&"yellow"!==l&&(u.status="red"),r=0,n=(o=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;r<n;r++)s=o[r],delete u.cluster[s]}catch(e){}return u},s.index.keys=async function(e){var t,i,s,r;return null==e&&(e=null!=(s=null!=(r=this.params.index)?r:this.params.keys)?s:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/keys",""),i=[],t=async(s,r="")=>{var a,n,l,u,c,h,d,p,f;if(null==s&&(s="object"==typeof e?e:await this.index.mapping(e)),s.properties=null!=(n=null!=(l=null!=(u=s[e])&&null!=(c=u.mappings)?c.properties:void 0)?l:null!=(h=s[this.S.index.name+"_"+e])&&null!=(d=h.mappings)?d.properties:void 0)?n:s.properties,null!=s.properties){for(a in r.length&&(r+="."),f=[],s.properties)p=r+a,o.call(i,p)<0&&i.push(r+a),null!=s.properties[a].properties?f.push(await t(s.properties[a],r+a)):f.push(void 0);return f}},await t(),i},s.index.terms=async function(e,t,i,s=100,r=!0,a="count"){var n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x;if(null==e&&(e=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),e=e.replace("index/","").replace("/terms",""),!t||!i){if(null==t&&(t=null!=(m=this.params.terms)?m:this.params.key),null==t&&-1!==e.indexOf("/")&&([e,t]=e.split("/")),!t)return[];for(n=this.copy(this.params),l=0,u=(g=["index","route","terms","key"]).length;l<u;l++)delete n[g[l]]}for(null!=i&&(i=await this.index.translate(i)),null==i&&(i=await this.index.translate(n)),p="object"==typeof i?i:{size:0,query:{bool:{must:[],filter:[{exists:{field:t}}]}}},"string"==typeof i&&p.query.bool.must.push({query_string:{query:i}}),null==p.aggregations&&(p.aggregations={}),null==p.size&&(p.size=0),null!=this.params.size&&(s=this.params.size),null!=this.params.counts&&(r=this.params.counts),null!=this.params.order&&(a=this.params.order),h={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},"string"==typeof a&&null!=h[a]&&(a=h[a]),p.aggregations[t]={terms:{field:t+(t.endsWith(".keyword")?"":".keyword"),size:s,order:a}},_=[],o=0,c=(w=null!=(y=null!=(x=await this.index._send("/"+e+"/_search",p,"POST"))&&null!=(v=x.aggregations)&&null!=(b=v[t])?b.buckets:void 0)?y:[]).length;o<c;o++)d=w[o],_.push(r?{term:d.key,count:d.doc_count}:d.key);return _},s.index.suggest=async function(e,t,i,s=100,r){var a,n,l,u,c,h,d,p,f,m,g,y,v;if(t&&i||(null==t&&(t=null!=(p=this.params.suggest)?p:this.params.key),-1!==t.indexOf("/")&&([t,i]=t.split("/"))),!t)return this.index.keys(e);if(null==e&&(e=null!=(f=this.params.index)?f:this.fn.replace(/\./g,"/")),e=e.replace("index/","").split("/suggest")[0],null==r&&(r=this.params.include),"string"==typeof r&&(r=r.replace(/,\s/g,",").split(",")),Array.isArray(r)&&o.call(r,t)<0&&r.push(t),"string"==typeof i&&(h=(i=i.trim()).toLowerCase(),r&&((v={should:[{match:{}},{prefix:{}},{query_string:{query:t+":"+i.split(" ").join(" AND "+t+":")+"*"}}]}).should[0].match[t]={query:i,boost:3},v.should[1].prefix[t]={value:i,boost:2})),g=[],y=[],r){for await(d of this.index._for(e,null!=v?v:i,{sort:t+".keyword",until:s,include:!0===r?[t]:r}))if(l=await this.dot(d,t)){for(;Array.isArray(l)&&(a=l.shift());)a.toLowerCase().includes(h)&&(l=a);u=l.toLowerCase(),o.call(y,u)<0&&(!h||u.includes(h))&&g.push(d),y.push(u)}}else for(n=0,c=(m=await this.index.terms(e,t,null!=v?v:i,s,!1,"term")).length;n<c;n++)u=(l=m[n]).toLowerCase(),o.call(y,u)<0&&(!h||u.includes(h))&&g.push(l),y.push(u);return g},s.index.count=async function(e,t,i){var s,r,a,n,l,u,c,h,d,p,f;if(e&&"string"==typeof t&&!i)o.call(await this.index.keys(e),t)<0&&(i=t,t=void 0);else{for(null==t&&(t=null!=(l=this.params.count)?l:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"_")),-1!==(e=e.replace("index/","").split("/count")[0]).indexOf("/")&&([e,t]=e.split("/")),s=this.copy(this.params),r=0,a=(c=["index","route","count","key"]).length;r<a;r++)delete s[c[r]];null==i&&(n=await this.index.translate(s))&&(i=n)}return"string"==typeof i&&(i=await this.index.translate(i)),null==i&&(i={query:{bool:{must:[],filter:[]}}}),t?(t.endsWith(".keyword")||(t+=".keyword"),i.size=0,i.aggs={keyed:{cardinality:{field:t,precision_threshold:4e4}}},null!=(f=await this.index._send("/"+e+"/_search",i,"POST"))&&null!=(h=f.aggregations)&&null!=(d=h.keyed)?d.value:void 0):null!=(f=await this.index._send("/"+e+"/_search",i,"POST"))&&null!=(p=f.hits)?p.total:void 0},s.index.min=async function(e,t,i,s="min"){var r,a,n,l,o,u,c,h;for(null==t&&(t=null!=(o=this.params[s])?o:this.params.key),null==e&&(e=null!=(u=this.params.index)?u:this.fn.replace(/\./g,"/")),-1!==(e=e.replace("index/","").replace("/"+s,"")).indexOf("/")&&([e,t]=e.split("/")),r=this.copy(this.params),a=0,n=(c=["index","route","min","max","key"]).length;a<n;a++)delete r[c[a]];return null==i&&(i=await this.index.translate(r)),(l="object"==typeof t?t:null!=i?i:{query:{bool:{must:[],filter:[{exists:{field:t}}]}}}).size=0,l.aggs={},"min"!==s&&"range"!==s||(l.aggs.min={min:{field:t}}),"max"!==s&&"range"!==s||(l.aggs.max={max:{field:t}}),h=await this.index._send("/"+e+"/_search",l,"POST"),"range"===s?{min:h.aggregations.min.value,max:h.aggregations.max.value}:h.aggregations[s].value},s.index.max=function(e,t,i){return this.index.min(e,t,i,"max")},s.index.range=function(e,t,i){return this.index.min(e,t,i,"range")},s.index.mapping=function(e){return-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),this.index._send(e)},s.index.history=function(e,t){var i;try{null==t&&(t=null!=(i=this.params.history)?i:this.params.index)}catch(e){}return[]},s.index._for=async function*(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m;for((null!=i?i.scroll:void 0)?("number"!=typeof(m=i.scroll)&&m.endsWith("m")||(m+="m"),delete i.scroll):m="2m",((null!=i?i.until:void 0)||(null!=i?i.max:void 0))&&(r=null!=(o=i.until)?o:i.max,delete i.until,delete i.max),null==(n=await this.index.translate(t,i)).from&&(n.from=0),null==n.size&&(n.size=500),null==n.sort&&(n.sort=["_doc"]),s=0,a=null!=(p=await this.index._send(e+"/_search?scroll="+m,n))?p._scroll_id:void 0,(null!=p&&null!=(u=p.hits)?u.total:void 0)===p.hits.hits.length&&delete p._scroll_id;;){if((null!=p&&null!=(c=p.hits)?c.hits:void 0)&&0!==p.hits.hits.length||!(null!=p?p._scroll_id:void 0)||(a=p._scroll_id,(null!=(p=await this.index._send("/_search/scroll?scroll="+m+"&scroll_id="+p._scroll_id))?p._scroll_id:void 0)!==a&&(a&&await this.index._send("/_search/scroll?scroll_id="+a,""),a=p._scroll_id)),s===r||null==(null!=p&&null!=(h=p.hits)?h.hits:void 0)||!p.hits.hits.length){a&&this.waitUntil(this.index._send("/_search/scroll?scroll_id="+a,""));break}s+=1,null==(f=null!=(d=(l=p.hits.hits.shift())._source)?d:l.fields)._id&&(f._id=l._id),yield f}},s.index._each=async function(e,i,s,r){var a,n,l,o,u,c,h,d,p,f,m;for await(h of(null==r&&null==s&&"function"==typeof i&&(r=i,i="*"),null==r&&"function"==typeof s&&(r=s,s=void 0),null==s&&(s={}),"string"==typeof s&&(a=s,s=void 0),(null!=s?s.action:void 0)&&(a=s.action,delete s.action),(f=null!=(d=s.size)?d:"object"==typeof i&&null!=i.size?i.size:1e3)>50&&((c=await this.index.translate(i,s)).size=1,null!=(null!=(n=await this.index._send(e,c))&&null!=(p=n.hits)?p.total:void 0)&&0!==n.hits.total&&(o=Math.floor(1e9/(t.byteLength(JSON.stringify(n.hits.hits[0]))*n._shards.total)))<f&&(f=o),c.size=f),u=0,m=[],this.index._for(e,null!=c?c:i,s)))u+=1,null==(l=await r.call(this,h))||"object"!=typeof l&&"string"!=typeof l||m.push(l),a&&m.length>f&&(await this.index._bulk(e,m,a),m=[]);if(a&&m.length&&this.index._bulk(e,m,a),this.S.dev&&!0===this.S.bg)return console.log("_each processed "+u)},s.index._bulk=async function(e,t,i="index",r=5e4){var a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S;if(!0===i&&(i="index"),!1!==await this.dot(s,e.split("/")[0].replace(/_/g,".")+"._prefix")&&(e=this.S.index.name+"_"+e),null==this.index&&(this.index=s.index),"string"==typeof t&&-1!==t.indexOf("\n"))return await this.index._send("/_bulk",{body:t,headers:{"Content-Type":"application/x-ndjson"}}),!0;for(p in O="object"!=typeof t||Array.isArray(t)||null==(null!=t&&null!=(f=t.hits)?f.hits:void 0)?t:t.hits.hits,Array.isArray(O)||(O=[O]),a=0,n=0,d="",O)if(a+=1,"object"==typeof(k=O[p])&&(x=null!=(m=k._id)?m:null!=(g=k._source)?g._id:void 0,k._source&&(k=k._source),delete k._id),(h={})[i]={_index:e},h[i]._id="delete"!==i||"string"!=(y=typeof k)&&"number"!==y?x:k,d+=JSON.stringify(h)+"\n","create"===i||"index"===i?d+=JSON.stringify(k)+"\n":"update"===i&&(d+=JSON.stringify({doc:k})+"\n"),a===r||parseInt(p)===O.length-1||d.length>7e7){if(S=await this.index._send("/_bulk",{body:d,headers:{"Content-Type":"application/x-ndjson"}}),(null!=this&&null!=(v=this.S)?v.dev:void 0)&&!0===(null!=this&&null!=(b=this.S)?b.bg:void 0)&&(null!=S?S.errors:void 0)){for(l=[],u=0,c=(w=S.items).length;u<c;u++){o=w[u];try{200!==(_=o[i].status)&&201!==_&&(l.push(o[i]),n+=1)}catch(e){n+=1}}try{console.log(l)}catch(e){}try{console.log(0===l.length?"SOME":l.length,"INDEX ERRORS BULK LOADING",S.items.length)}catch(e){}}d="",a=0}return O.length-n},s.index.translate=function(e,t){var i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe;if((null!=this?this.route:void 0)&&this.route.startsWith("index")&&null==e&&(e=null!=this?this.params:void 0),"string"==typeof e){if(""===e||-1!==e.indexOf("\n"))return}else{if("object"!=typeof e||Array.isArray(e))return;for(v=0,_=(D=["settings","aliases","mappings","index","_id"]).length;v<_;v++)if(null!=e[b=D[v]])return;if("{}"!==JSON.stringify(e)&&null==e.q&&null==e.query&&null==e.source&&null==e.must&&null==e.should&&null==e.must_not&&null==e.filter&&null==e.aggs&&null==e.aggregations)return}try{try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if(null==t&&(t={}),"random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null!=t.newest&&(t.sort={createdAt:t.newest?"desc":"asc"},delete t.newest),null==(R=null!=(X=null!=t?t.query:void 0)?X:{}).query&&(R.query={}),null==(a=R.query).bool&&(a.bool={must:[],filter:[]}),"string"==typeof e)R.query.bool.filter.push({query_string:{query:e}});else if("object"==typeof e)if(null!=e.query)R=e;else for(P in null!=e.source?("string"==typeof e.source&&(R=JSON.parse(decodeURIComponent(e.source))),"object"==typeof e.source&&(R=e.source)):null!=e.q&&("object"==typeof e.q?R.query=e.q:(e.q=decodeURIComponent(e.q),null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(E={})[(L=e.q.split(":"))[0]]=L[1],R.query.bool.must.push({prefix:E})):R.query.bool.filter.push({query_string:{query:e.q}}))),e)null==t[P]&&(t[P]=e[P]);if(null!=(null!=(K=R.query)&&null!=(Q=K.filtered)&&null!=(Z=Q.query)?Z.bool:void 0)&&(R.query.bool=R.query.filtered.query.bool,R.query.bool.filter=R.query.filtered.filter,delete R.query.filtered),null!=R.facets&&(R.aggregations=JSON.parse(JSON.stringify(R.facets).replace(/\.exact/g,".keyword")),delete R.facets),null!=R.query&&null==R.query.bool&&JSON.stringify("{}"!==R.query)&&(R.query={bool:{must:[],filter:[R.query]}}),null==R.query&&(R.query={bool:{must:[],filter:[]}}),null==(n=R.query).bool&&(n.bool={must:[],filter:[]}),null==(l=R.query.bool).filter&&(l.filter=[]),"string"==typeof t.sort){for(le=[],ee=t.sort.split(","),w=0,x=ee.length;w<x;w++)ne=ee[w],[b,P]=ne.split(":"),P?(le.push({}),le[le.length-1][b.trim()]=P.trim()):le.push(b.trim());t.sort=le}if(t.random&&(m={function_score:{random_score:{}}},null!=t.seed&&(m.function_score.random_score.seed=seed),m.function_score.query=R.query,R.query=m,delete t.random,delete t.seed),(y=null!=(te=null!=(ie=null!=(se=t._include)?se:t.include)?ie:t._includes)?te:t.includes)&&(null==R._source&&(R._source={}),R._source.includes="string"==typeof y?y.replace(/,\s/g,",").split(","):y),d=null!=(T=null!=(z=null!=(U=t._exclude)?U:t.exclude)?z:t._excludes)?T:t.excludes){for("string"==typeof d&&(p=d.replace(/,\s/g,",").split(",")),J=null!=(M=null!=(W=R._source)?W.includes:void 0)?M:[],q=0,k=J.length;q<k;q++)g=J[q],o.call(p,g)>=0&&delete d[g];R._source.excludes=d}for(C=0,O=(B=["filter","restrict","must","and","must_not","not","should","or"]).length;C<O;C++)if(null!=t[ce=B[C]])for(I=Array.isArray(t[ce])?t[ce]:[t[ce]],delete t[ce],h="filter"===ce||"restrict"===ce||"must"===ce||"and"===ce?"filter":"must_not"===ce||"not"===ce?"must_not":"should",null==(u=R.query.bool)[h]&&(u[h]=[]),oe=0,S=I.length;oe<S;oe++)"object"==typeof(ae=I[oe])?1===(re=this.keys(ae)).length&&"object"!=typeof ae[re[0]]&&(ae={term:ae}):ae={query_string:{query:ae}},R.query.bool[h].push(ae);if(null!=t.terms){try{t.terms=t.terms.replace(/,\s/g,",").split(",")}catch(e){}for(null==R.aggregations&&(R.aggregations={}),Y=t.terms,he=0,A=Y.length;he<A;he++)ue=Y[he],R.aggregations[ue]={terms:{field:ue+(ue.endsWith(".keyword")?"":".keyword"),size:1e3}};delete t.terms}for(pe=0,j=(F=["aggs","aggregations"]).length;pe<j;pe++)if(null!=t[i=F[pe]]){for(f in null==R[i]&&(R[i]={}),t[i])R[i][f]=t[i][f];delete t[i]}for(b in t){if(de=t[b],"fields"===b&&"string"==typeof de&&-1!==de.indexOf(",")&&(de=de.replace(/,\s/g,",").split(",")),("from"===b||"size"===b)&&"number"!=typeof de)try{de=parseInt(de),isNaN(de)&&(de=void 0)}catch(e){}null!=de&&"apikey"!==b&&"_"!==b&&"callback"!==b&&"refresh"!==b&&"key"!==b&&"counts"!==b&&"index"!==b&&"search"!==b&&"source"!==b&&"q"!==b&&"include"!==(V=b.replace("_","").replace("s",""))&&"exclude"!==V&&(R[b]=de)}try{for(s in N={count:{_count:"desc"},reverse_count:{_count:"asc"},term:{_key:"asc"},reverse_term:{_key:"desc"}},R.aggregations)"string"==typeof(null!=($=R.aggregations[s].terms)?$.order:void 0)&&null!=N[R.aggregations[s].terms.order]&&(R.aggregations[s].terms.order=N[R.aggregations[s].terms.order])}catch(e){}if(null!=(null!=(G=R.query)?G.bool:void 0))for(c in R.query.bool)for(r in R.query.bool[c])"string"==typeof(null!=(H=R.query.bool[c][r].query_string)?H.query:void 0)&&-1!==R.query.bool[c][r].query_string.query.indexOf("/")&&-1===R.query.bool[c][r].query_string.query.indexOf('"')&&(R.query.bool[c][r].query_string.query='"'+R.query.bool[c][r].query_string.query+'"');return null!=R._source&&null!=R.fields&&delete R._source,R}catch(e){return}},s.index.translate._auth=!1,s.index._send=async function(e,t,i){var a,n,l,o,u,c,h,d,p;if(e.includes("?")?([e,d]=e.split("?"),d="?"+d):d="",(e=e.toLowerCase()).startsWith("/")&&(e=e.replace("/","")),e.endsWith("/")&&(e=e.replace(/\/$/,"")),null==i&&(i=""===t?"DELETE":null==t||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=t||"_refresh"===(l=e.split("/").pop().split("?")[0])||"_aliases"===l?"POST":"GET":"PUT"),"DELETE"===i&&-1!==e.indexOf("/_all"))return!1;if(!e.startsWith("http")){if(!this.S.index.name||e.startsWith(this.S.index.name)||e.startsWith("_")||!1!==(n=await this.dot(s,e.split("/")[0].replace(/_/g,".")+"._prefix"))&&(e=("string"==typeof n?n:this.S.index.name)+"_"+e),p=(null!=this&&null!=(o=this.S)&&null!=(u=o.index)?u.url:void 0)?this.S.index.url:null!=(c=r.index)?c.url:void 0,Array.isArray(p)&&(p=p[Math.floor(Math.random()*p.length)]),"string"!=typeof p)return;e=p+"/"+e}if(e.startsWith("http")){if(a=-1!==(e=e+=d).indexOf("/_bulk")||"object"==typeof(null!=t?t.headers:void 0)?t:{body:t},-1===e.indexOf("/_search")||"GET"!==i&&"POST"!==i||(e+=(-1===e.indexOf("?")?"?":"&")+"rest_total_hits_as_int=true"),this.S.dev&&!0===this.S.bg&&console.log("INDEX",i,e),a.method=i,h=await this.fetch(e,a),this.S.dev&&!0===this.S.bg)try{console.log("INDEX QUERY FOUND",h.hits.total,h.hits.hits.length)}catch(e){}if(!(null==h||"object"==typeof h&&"number"==typeof h.status&&h.status>=400&&h.status<=600)){try{this.S.dev&&null!=(null!=t?t.query:void 0)&&(h.q=t)}catch(e){}return h}}else console.log("NO INDEX URL AVAILABLE")},"string"==typeof r.kv&&r.kv.startsWith("http")&&!e[r.kv]&&(e[r.kv]={},e[r.kv].get=function(e){return s.fetch(r.kv+"/"+e)},e[r.kv].getWithMetadata=async function(e){return{value:await s.fetch(r.kv+"/"+e),metadata:{}}},e[r.kv].put=function(e,t){return s.fetch(r.kv+"/"+e,{body:t})},e[r.kv].delete=function(e){return s.fetch(r.kv+"/"+e,{method:"DELETE"})},e[r.kv].list=function(e){return null==e&&(e={}),s.fetch(r.kv+"/list"+(e.prefix?"/"+e.prefix:"")+(e.cursor?"?cursor="+e.cursor:""))}),s.kv=async function(t,i,s,r,a){var n,l,o,u,c,h,d,p,f,m,g,y,v,b;if(null==t&&(t=null!=(d=null!=(p=this.params.kv)?p:this.params.key)?d:this.parts.join("_"),null==i)){if("DELETE"===this.request.method)i="";else if(this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,n=0,u=(f=["key","kv","refresh","apikey"]).length;n<u;n++)delete i[o=f[n]];for(l=0,c=(m=this.parts).length;l<c;l++)delete i[o=m[l]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(g=JSON.stringify(i))&&"[]"!==g||(i=void 0)}if("object"!=typeof i||"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=void 0),"object"==typeof t&&null==i&&(t=null!=(v=(i=t)._id)?v:await this.uid()),null!=t&&this.S.kv&&e[this.S.kv]){if(null!=i&&""!==i){if(h={metadata:r},"number"==typeof s&&(1e3*s>Date.now()?h.expiration=s:h.expirationTtl=s),"object"==typeof i&&(!0===s&&(s=await this.kv(t)),"object"==typeof s))for(o in s)null==i[o]&&(i[o]=s[o]);return this.waitUntil(e[this.S.kv].put(t,"object"==typeof i?JSON.stringify(i):i,h)),i}if(({value:b,metadata:r}=await e[this.S.kv].getWithMetadata(t,a)),null!=b){try{b=JSON.parse(b)}catch(e){}try{r=JSON.parse(r)}catch(e){}return""===i&&this.waitUntil(e[this.S.kv].delete(t)),!0===r?{value:b,metadata:r}:b}}},s.kv._auths="system",s.kv._hides=!0,s.kv._caches=!1,s.kv.list=async function(t,i){var s,r;try{null==t&&(t=null!=(s=null!=(r=this.params.kv)?r:this.params.prefix)?s:this.params.list)}catch(e){}try{null==i&&(i=this.params.cursor)}catch(e){}return await e[this.S.kv].list({prefix:t,cursor:i})},s.kv.count=async function(t){var i,s,r,a,n,l,o,u,c;if(s=0,this.S.kv&&null!=e[this.S.kv])for(null==t&&(t=null!=(o=null!=(u=this.params.kv)?u:this.params.prefix)?o:this.params.count),i=!1,r=void 0;!i;){for(r=(l=await e[this.S.kv].list({prefix:t,cursor:r})).cursor,a=0,n=(c=l.keys).length;a<n;a++)c[a],s+=1;i=l.list_complete}return s},s.kv.prefixes=async function(){var e;return e={},await this.kv._each(void 0,(function(t){var i;return i=t.split("/")[0],null==e[i]&&(e[i]=0),e[i]+=1})),e},s.kv.clear=function(t){var i;if(this.S.dev)return null==t&&(t=null!=(i=this.params.clear)?i:this.params.kv),this.waitUntil(this.kv._each(t,(function(t){return this.waitUntil(e[this.S.kv].delete(t))}))),!0},s.kv.delete=async function(e){var t,i,s,r;if("string"==typeof this.S.kv&&this.S.kv.startsWith("http")){for(null==e&&(e=null!=(i=null!=(s=this.params.kv)?s:this.params.delete)?i:this.params.prefix),r=t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));t&&"0"!==t;)this.S.dev&&console.log(e,t),await this.fetch(this.S.kv+"/clear"+(e?"/"+e:"")),await this.sleep(500),t=await this.fetch(this.S.kv+"/count"+(e?"/"+e:""));return r}},s.kv.delete._bg=!0,s.kv._each=async function(t,i){var s,r,a,n,l,o,u,c;if(0,this.S.kv&&null!=e[this.S.kv]){for("function"==typeof t&&null==i&&(i=t,t=void 0),s=!1,r=void 0,c=[];!s;){for(r=(o=await e[this.S.kv].list({prefix:t,cursor:r})).cursor,a=0,l=(u=o.keys).length;a<l;a++)n=u[a],1,"function"==typeof i?this.waitUntil(i.call(this,n.name)):""===i?this.waitUntil(e[this.S.kv].delete(n.name)):null!=i&&this.waitUntil(this.kv(n.name,i));c.push(s=o.list_complete)}return c}},s.src.base={},s.src.base.doi=async function(e){return await this.fetch("https://dev.api.cottagelabs.com/use/base/doi/"+e)},s.src.base.title=async function(e){var t,i;if(e=e.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036F]/g,"").replace(/ß/g,"ss"),(null!=(null!=(i=await this.src.base.get('dctitle:"'+e+'"'))?i.dctitle:void 0)||null!=i.title)&&(null==i.title&&(i.title=i.dctitle),i.title&&(t=i.title.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036F]/g,"").replace(/ß/g,"ss"))&&t.length<=1.2*e.length&&t.length>=.8*e.length&&-1!==e.replace(/ /g,"").indexOf(t.replace(" ","").replace(" ","").replace(" ","").split(" ")[0])))return i},s.src.base.get=async function(e){var t,i;return(null!=(i=await this.src.base.search(e))&&null!=(t=i.data)?t.length:void 0)?i.data[0]:void 0},s.src.base.search=async function(e="*",t,i){var s,r;-1===e.indexOf('"')&&-1!==e.indexOf(" ")&&(e=e.replace(/ /g,"+")),r="https://api.base-search.net/cgi-bin/BaseHttpSearchInterface.fcgi?func=PerformSearch&format=json&query="+e,t&&(r+="&offset="+t),i&&(r+="&hits="+i),r+="&sortBy=dcdate+desc";try{return s=await this.fetch(r),(s=JSON.parse(s).response).data=s.docs,delete s.docs,s.total=s.numFound,s}catch(e){}};var g;o=[].indexOf;s.src.crossref=function(){return"Crossref API wrapper"},s.src.crossref.journals=async function(e){var t,i,s,r;return null==e&&(e=null!=(i=this.params.journals)?i:this.params.issn),r="https://dev.api.cottagelabs.com/use/crossref/journals"+((t="string"==typeof e&&9===e.length&&2===e.split("-").length&&4===e.indexOf("-"))?"/"+e:"?q=")+e,s=await this.fetch(r),t?null!=(null!=s?s.ISSN:void 0)?s:void 0:s},s.src.crossref.journals.doi=async function(e){var t;null==e&&(e=null!=(t=this.params.doi)?t:this.params.issn),"string"==typeof e&&(e=e.split(","));try{return(await this.fetch('https://dev.api.cottagelabs.com/use/crossref/works?q=ISSN.exact:"'+e.join('" OR ISSN.exact:"')+'"')).hits.hits[0]._source.DOI}catch(e){}},s.src.crossref.works=async function(e,t){var i,s,r,a,n;return null==e&&(e=null!=(i=null!=(s=null!=(r=this.params.works)?r:this.params.doi)?s:this.params.title)?i:this.params.q),"string"!=typeof e?(n="https://dev.api.cottagelabs.com/use/crossref/works?q="+e,await this.fetch(n,{params:t})):(0!==e.indexOf("10.")?a=await this.src.crossref.works.title(e):(0===e.indexOf("http")&&(e=e.split("//")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),n="https://dev.api.cottagelabs.com/use/crossref/works?doi="+e,a=await this.fetch(n)),null!=(null!=a?a.DOI:void 0)?await this.src.crossref.works._format(a):void 0)},s.src.crossref.works._index={settings:{number_of_shards:9}},s.src.crossref.works._key="DOI",s.src.crossref.works._prefix=!1,s.src.crossref.works.title=async function(e){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v;if(null==e&&(e=null!=(u=this.params.title)?u:this.params.q),n='title:"'+e+'"',e.split(" ").length>2){for(n+=" OR (",t=0,s=(c=e.split(" ")).length;t<s;t++)v=c[t],n.endsWith("(")||(n+=" AND "),n+='(title:"'+v+'" OR subtitle:"'+v+'")';n+=")"}for(f=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+n),a=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),i=0,r=(p=null!=(h=null!=f&&null!=(d=f.hits)?d.hits:void 0)?h:[]).length;i<r;i++)(l=p[i])._source.DOI&&l._source.title&&l._source.title.length&&(g=("string"==typeof l._source.title?l._source.title:l._source.title[0]).toLowerCase(),l._source.subtitle&&l._source.subtitle.length&&"string"==typeof(y=("string"==typeof l._source.subtitle?l._source.subtitle:l._source.subtitle[0]).toLowerCase())&&y.length&&o.call(g,y)<0&&(g+=" "+y),g=g.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==a.indexOf(g)||-1!==g.indexOf(a))&&a.length/g.length>.7&&a.length/g.length<1.3&&("journal-article"===l._source.type||null==m||"journal-article"!==m.type&&"journal-article"===l._source.type)&&(m=l._source));return m},s.src.crossref.works._format=async function(e){var t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x;for(e.abstract&&(e.abstract=e.abstract.replace(/<.*?>/g,"").replace(/^ABSTRACT/,"")),null==e._id&&(e._id=e.DOI.replace(/\//g,"_")),s=0,l=(f=null!=(p=e.assertion)?p:[]).length;s<l;s++)"OPEN ACCESS"===(t=f[s]).label&&(t.URL&&-1!==t.URL.indexOf("creativecommons")&&(null==e.license&&(e.license=[]),e.license.push({URL:t.URL})),e.is_oa=!0);for(r=0,o=(g=null!=(m=e.license)?m:[]).length;r<o;r++)if((n=g[r]).URL&&-1!==n.URL.indexOf("creativecommons")&&(!e.licence||-1===e.licence.indexOf("creativecommons"))){e.licence=n.URL;try{e.licence="cc-"+e.licence.split("/licenses/")[1].replace(/^\//,"").replace(/\/$/,"").replace(/\//g,"-").replace(/-$/,"")}catch(e){}e.is_oa=!0}try{e.reference&&e.reference.length>100&&(e.reference_original_length=e.reference.length,e.reference=e.reference.slice(0,100))}catch(e){}try{e.relation&&e.relation.length>100&&(e.relation_original_length=e.relation.length,e.relation=e.relation.slice(0,100))}catch(e){}for(a=0,u=(v=null!=(y=e.author)?y:[]).length;a<u;a++)(i=v[a]).name=(i.given?i.given+" ":"")+(null!=(b=i.family)?b:"");for(h=0,c=(w=["published","published-print","published-online","issued","deposited","indexed"]).length;h<c;h++)"object"!=typeof e[d=w[h]]||e.published||("string"==typeof e[d]["date-time"]&&3===e[d]["date-time"].split("T")[0].split("-").length&&(e.published=e[d]["date-time"].split("T")[0]),"string"!=typeof e.published&&Array.isArray(e[d]["date-parts"])&&e[d]["date-parts"].length&&Array.isArray(e[d]["date-parts"][0])&&"string"==typeof(x=e[d]["date-parts"][0])[0]&&"null"!==x[0]&&(e.published=x[0]+(x.length>1?"-"+(1===x[1].toString().length?"0":"")+x[1]:"-01")+(x.length>2?"-"+(1===x[2].toString().length?"0":"")+x[2]:"-01")),"string"==typeof e.published&&(e.year=e.published.split("-")[0],e.publishedAt=null!=(_=e[d].timestamp)?_:await this.epoch(e.published)));return e},s.src.doaj={},s.src.doaj.journals=async function(e){var t;if(null==e&&(e=null!=(t=this.params.journals)?t:this.params.issn),e)try{return(await this.fetch("https://doaj.org/api/v2/search/journals/"+e)).results[0]}catch(e){}},s.src.doaj.articles=async function(e){var t,i,s,r;r="https://doaj.org/api/v1/search/articles";try{s=this.params.title.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}if(s||"string"==typeof e)e.startsWith("10.")&&(e+="doi:"),r+=null!=(i="/"+s)?i:e;else for(t in r+="?",params)r+=t+"="+params[t]+"&";return(await this.fetch(r)).results},s.src.epmc=async function(e,t,i){var s,r,a,n,l,o;return null==e&&(e=null!=(s=this.params.epmc)?s:this.params.doi),0===e.indexOf("10.")&&-1===e.indexOf(" ")&&e.split("/").length>=2&&(e="DOI:"+e),o="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+" sort_date:y&resulttype=core&format=json",null!=i&&(o+="&pageSize="+i),null!=t&&(o+="&cursorMark="+t),l={},await this.sleep(300),n=await this.fetch(o),l.total=n.hitCount,l.data=null!=(r=null!=(a=n.resultList)?a.result:void 0)?r:[],l.cursor=n.nextCursorMark,this.params.doi&&1===l.total?l.data[0]:l},s.src.epmc.doi=async function(e){var t;return null==e&&(e=this.params.doi),(t=await this.src.epmc("DOI:"+e)).total?t.data[0]:void 0},s.src.epmc.doi._hide=!0,s.src.epmc.pmid=async function(e){var t;return null==e&&(e=this.params.pmid),(t=await this.src.epmc("EXT_ID:"+e+" AND SRC:MED")).total?t.data[0]:void 0},s.src.epmc.pmc=async function(e){var t;return(t=await this.src.epmc("PMCID:PMC"+e.toLowerCase().replace("pmc",""))).total?t.data[0]:void 0},s.src.epmc.title=async function(e){var t;null==e&&(e=this.params.title);try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(t=await this.src.epmc('title:"'+e+'"')).total?t.data[0]:void 0},s.src.epmc.licence=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d;if(null==e&&(e=null!=(u=this.params.licence)?u:this.params.pmcid),e&&!t&&(h=await this.src.epmc("PMC"+e.toLowerCase().replace("pmc",""))),(null!=h?h.total:void 0)>0||t||i){if(null==t&&(t=h.data[0]),!e&&t&&(e=t.pmcid),t.license)return 0===(r={licence:t.license,source:"epmc_api"}).licence.indexOf("cc")&&(r.licence=r.licence.replace(/ /g,"-")),r;if(!i&&e&&(i=await this.src.epmc.xml(e)),404!==i&&"string"==typeof i&&0===i.indexOf("<")&&null!=this.svc.lantern){if(null!=(a=await this.svc.lantern.licence(void 0,void 0,i,"<permissions>","</permissions>")).licence)return a.source="epmc_xml_permissions",a;if(null!=(s=await this.svc.lantern.licence(void 0,void 0,i)).licence)return s.source="epmc_xml_outside_permissions",s;-1!==i.indexOf("<permissions>")&&(l={licence:"non-standard-licence",source:"epmc_xml_permissions"})}if(e&&null!=(null!=(c=this.svc.lantern)?c.licence:void 0)&&(await this.sleep(1e3),d="https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc",""),"string"==typeof(o=await this.puppet(d)))){try{n=await this.svc.lantern.licence(d,!1,o)}catch(e){}if(null!=(null!=n?n.licence:void 0))return n.source="epmc_html",n}return null!=l&&l}return!1},s.src.epmc.xml=async function(e){var t;return null==e&&(e=null!=(t=this.params.xml)?t:this.params.pmcid),e&&(e=e.toLowerCase().replace("pmc","")),await this.sleep(900),this.fetch("https://www.ebi.ac.uk/europepmc/webservices/rest/PMC"+e+"/fullTextXML")},s.src.epmc.aam=async function(e,t,i){var s,r;return null==e&&(e=null!=(r=this.params.xml)?r:this.params.pmcid),"string"==typeof i&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(null==e&&(e=null!=t?t.pmcid:void 0),e?"string"==typeof(i=await this.src.epmc.xml(e))&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(await this.sleep(1e3),null==(s=await this.puppet("https://europepmc.org/articles/PMC"+e.toLowerCase().replace("pmc","")))?{aam:!1,info:"not in EPMC (404)"}:"string"==typeof s?("Author Manuscript; Accepted for publication in peer reviewed journal","Author manuscript; available in PMC","logo-nihpa.gif","logo-wtpa2.gif",-1!==s.indexOf("Author Manuscript; Accepted for publication in peer reviewed journal")||-1!==s.indexOf("Author manuscript; available in PMC")||-1!==s.indexOf("logo-nihpa.gif")||-1!==s.indexOf("logo-wtpa2.gif")?{aam:!0,info:"splashpage"}:{aam:!1,info:"EPMC splashpage checked, no indicator found"}):"object"==typeof s&&403===s.status?{info:"EPMC blocking access, AAM status unknown"}:null!=s?{info:"EPMC was accessed but aam could not be decided from what was returned"}:{info:"EPMC was accessed nothing was returned, so aam check could not be performed"}):{aam:!1,info:""})},s.src.fatcat=async function(e){var t;null==e&&(e=null!=(t=this.params.fatcat)?t:this.params.doi);try{return await this.fetch("https://api.fatcat.wiki/v0/release/lookup?expand=files&hide=abstracts,refs&doi="+e)}catch(e){}},s.src.google=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d;return null==e&&(e=null!=(s=null!=this&&null!=(r=this.params)?r.q:void 0)?s:null!=this&&null!=(a=this.params)?a.google:void 0),null==t&&(t=null!=(n=this.S.src.google)&&null!=(l=n.secrets)&&null!=(o=l.search)?o.id:void 0),null==i&&(i=null!=(u=this.S.src.google)&&null!=(c=u.secrets)&&null!=(h=c.search)?h.key:void 0),e&&t&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(d)):{}},s.src.google.sheets=async function(e){var t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_;if(null==e&&(e=this.copy(this.params)),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(c=e.sheet)?c:e.sheets,delete e.sheet,delete e.sheets),!e.sheetid)return _;if(e.sheetid.startsWith("http")?b=e.sheetid:(e.sheetid.includes("/spreadsheets/")?(y=e.sheetid.split("/spreadsheets/")[1].split("/")[0],!e.sheet&&e.sheetid.includes("/values/")&&(e.sheet=e.sheetid.split("/values/")[1].split("?")[0].split("#")[0]),e.sheetid=y):2===e.sheetid.split("/").length&&([e.sheetid,e.sheet]=e.sheetid.split("/")),null==e.sheet&&(e.sheet="Sheet1"),b="https://sheets.googleapis.com/v4/spreadsheets/"+e.sheetid+"/values/"+e.sheet+"?alt=json&key="+(null!=(h=null!=(d=this.S.src.google)&&null!=(p=d.secrets)?p.serverkey:void 0)?h:null!=(f=this.S.src.google)&&null!=(m=f.secrets)?m.apikey:void 0)),t=await this.fetch(b,{headers:{"Cache-Control":"no-cache"}}),!1===e.headers)return t.values;if(Array.isArray(e.headers))r=e.headers;else for(r=[],a=0,o=(v=t.values.shift()).length;a<o;a++)s=v[a],r.push(s.toLowerCase().replace(/[^a-z0-9]/g,""));for(_=[],n=0,u=(g=t.values).length;n<u;n++){for(i in l=g[n],w={},r)try{w[r[i]]=l[i]}catch(e){}"{}"!==JSON.stringify(w)&&_.push(w)}return _},s.src.google.sheets._bg=!0,s.src.google.chat=function(e,t){var i,s,r,a,n,l;if("string"==typeof e&&(e={text:e}),null==e&&(e=this.params),i={method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:{text:decodeURIComponent(null!=(s=null!=(r=null!=(a=e.text)?a:e.msg)?r:e.body)?s:"")}},null==t&&(t=null!=(n=this.S.src.google)&&null!=(l=n.secrets)?l.chat:void 0),i.body.text&&null!=t)return this.fetch(t,i)},s.src.grist=async function(e,t){var i,s,r,a;return null==e&&(e=this.params.grist),0!==e.indexOf("gid:")&&-1===e.indexOf(" ")&&parseInt(e)&&(e="gid:"+e),a="https://www.ebi.ac.uk/europepmc/GristAPI/rest/get/query="+encodeURIComponent(e)+"&resultType=core&format=json",null!=t&&(a+="&page="+(Math.floor(t/25)+1)),{total:(r=await this.fetch(a)).HitCount,data:null!=(i=null!=(s=r.RecordList)?s.Record:void 0)?i:{}}},null==(g=r.src).microsoft&&(g.microsoft={});try{r.src.microsoft.secrets=JSON.parse(SECRETS_MICROSOFT)}catch(e){}s.src.microsoft={},s.src.microsoft.bing=async function(e,t){var i,s,a,n,l,o,u,c,h,d,p;return null==e&&(e=null!=(i=null!=(s=null!=this&&null!=(a=this.params)?a.bing:void 0)?s:null!=this&&null!=(n=this.params)?n.q:void 0)?i:null!=this&&null!=(l=this.params)?l.query:void 0),null==t&&(t=null!=(o=r.src.microsoft)&&null!=(u=o.secrets)&&null!=(c=u.bing)?c.key:void 0),p="https://api.cognitive.microsoft.com/bing/v7.0/search?mkt=en-GB&count=20&q="+e,(null!=(d=await this.fetch(p,{headers:{"Ocp-Apim-Subscription-Key":t},cache:259200}))&&null!=(h=d.webPages)?h.value:void 0)?{total:d.data.webPages.totalEstimatedMatches,data:d.data.webPages.value}:{total:0,data:[]}},s.src.microsoft.graph={_prefix:!1,_index:{settings:{number_of_shards:9}}},s.src.microsoft.graph.journal={_prefix:!1,_index:!0},s.src.microsoft.graph.author={_prefix:!1,_index:{settings:{number_of_shards:9}}},s.src.microsoft.graph.affiliation={_prefix:!1,_index:!0},s.src.microsoft.graph.urls={_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.microsoft.graph.abstract={_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.microsoft.graph.relation={_prefix:!1,_index:{settings:{number_of_shards:12}}},null==(g=r.src).oadoi&&(g.oadoi={});try{r.src.oadoi=JSON.parse(SECRETS_OADOI)}catch(e){}s.src.oadoi=async function(e){var t,i,s,a;if(null==e&&(e=null!=(t=null!=(i=this.params)?i.oadoi:void 0)?t:null!=(s=this.params)?s.doi:void 0),"string"==typeof e&&e.startsWith("10."))return await this.sleep(900),a="https://api.oadoi.org/v2/"+e+"?email="+r.mail.to,this.fetch(a)},s.src.oadoi._index={settings:{number_of_shards:9}},s.src.oadoi._key="doi",s.src.oadoi._prefix=!1,s.src.pubmed={_key:"PMID",_prefix:!1,_index:{settings:{number_of_shards:6}}},s.src.pubmed.entrez={},s.src.pubmed.entrez.summary=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w;w="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed",null!=i?(Array.isArray(i)&&(i=i.join(",")),w+="&id="+i):w+="&query_key="+e+"&WebEnv="+t;try{for(y=await this.fetch(w),h=await this.convert.xml2json(y),p=[],f=h.eSummaryResult.DocSum,r=0,o=f.length;r<o;r++){for(s={id:(d=f[r]).Id[0]},m=d.Item,n=0,u=m.length;n<u;n++)if("List"===(a=m[n]).$.Type){if(s[a.$.Name]=[],null!=a.Item)for(g=a.Item,l=0,c=g.length;l<c;l++)v=g[l],(b={})[v.$.Name]=v._,s[a.$.Name].push(b)}else s[a.$.Name]=a._;if(p.push(s),null==i||-1===i.indexOf(","))return p[0]}return p}catch(e){}},s.src.pubmed.entrez.pmid=async function(e){var t,i,s;s="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/epost.fcgi?db=pubmed&id="+e;try{return t=await this.fetch(s),i=await this.convert.xml2json(t),this.src.pubmed.entrez.summary(i.ePostResult.QueryKey[0],i.ePostResult.WebEnv[0])}catch(e){}},s.src.pubmed.search=async function(e,t,i=10,s=!1){var r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_;w="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax="+i+"&sort=pub date&term="+e;try{if("string"==typeof s&&(s=s.split(",")),Array.isArray(s))y={total:s.length,data:[]};else{if(y=await this.fetch(w),y={total:(v=await this.convert.xml2json(y)).eSearchResult.Count[0],data:[]},!0===s)return y.data=v.eSearchResult.IdList[0].Id,y;s=v.eSearchResult.IdList[0].Id}if(t)for(r=0,u=s.length;r<u&&(b=s[r],p=await this.src.pubmed.pmid(b),y.data.push(p),y.data.length!==i);r++);else{for(_=[],n=0,c=s.length;n<c&&(a=s[n],y.data.length!==i);n++)if(_.push(a),40===_.length){for(m=await this.src.pubmed.entrez.summary(void 0,void 0,_),l=0,h=m.length;l<h&&(f=m[l],y.data.push(await this.src.pubmed.format(f)),y.data.length!==i);l++);_=[]}if(_.length)for(g=await this.src.pubmed.entrez.summary(void 0,void 0,_),o=0,d=g.length;o<d&&(f=g[o],y.data.push(await this.src.pubmed.format(f)),y.data.length!==i);o++);}return y}catch(e){}},s.src.pubmed.pmid=async function(e){var t,i;try{if(i="https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml",0===(t=await this.fetch(i)).indexOf("<"))return this.src.pubmed.format(await this.decode(t.split("<pre>")[1].split("</pre>")[0].replace("\n","")))}catch(e){}try{return this.src.pubmed.format(await this.src.pubmed.entrez.pmid(e))}catch(e){}},s.src.pubmed.aheadofprint=async function(e){try{return-1!==(await this.fetch("https://www.ncbi.nlm.nih.gov/pubmed/"+e+"?report=xml")).indexOf("PublicationStatus&gt;aheadofprint&lt;/PublicationStatus")}catch(e){}},s.src.pubmed.format=async function(e,t={}){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J;if("string"==typeof e&&0===e.indexOf("<")&&(e=await this.convert.xml2json(e)),null!=(null!=(q=e.eSummaryResult)?q.DocSum:void 0)||e.ArticleIds){if(n={},null!=(null!=(N=e.eSummaryResult)?N.DocSum:void 0))for(l=0,d=(E=(e=md.eSummaryResult.DocSum[0]).Item).length;l<d;l++)if("List"===(o=E[l]).$.Type){if(n[o.$.Name]=[],null!=o.Item)for(u=0,p=(L=o.Item).length;u<p;u++)(J={})[(W=L[u]).$.Name]=W._,n[o.$.Name].push(J)}else n[o.$.Name]=o._;else n=e;try{null==t.pmid&&(t.pmid=e.Id[0])}catch(e){}try{null==t.pmid&&(t.pmid=e.id)}catch(e){}try{null==t.title&&(t.title=n.Title)}catch(e){}try{null==t.issn&&(t.issn=n.ISSN)}catch(e){}try{null==t.essn&&(t.essn=n.ESSN)}catch(e){}try{null==t.doi&&(t.doi=n.DOI)}catch(e){}try{null==t.journal&&(t.journal=n.FullJournalName)}catch(e){}try{null==t.journal_short&&(t.journal_short=n.Source)}catch(e){}try{null==t.volume&&(t.volume=n.Volume)}catch(e){}try{null==t.issue&&(t.issue=n.Issue)}catch(e){}try{null==t.page&&(t.page=n.Pages)}catch(e){}try{null==t.year&&(t.year=n[n.PubDate?"PubDate":"EPubDate"].split(" ")[0])}catch(e){}try{O=n[n.PubDate?"PubDate":"EPubDate"].split(" "),null==t.published&&(t.published=O[0]+"-"+(["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(O[1].toLowerCase())+1)+"-"+(3===O.length?O[2]:"01"))}catch(e){}if(null!=n.AuthorList)for(null==t.author&&(t.author=[]),c=0,f=(R=n.AuthorList).length;c<f;c++){i=R[c];try{i.family=i.Author.split(" ")[0],i.given=i.Author.replace(i.family+" ",""),i.name=i.given+" "+i.family,t.author.push(i)}catch(e){}}if(null!=n.ArticleIds&&null==t.pmcid)for(h=0,m=(D=n.ArticleIds).length;h<m;h++)if((s=D[h]).pmc){null==t.pmcid&&(t.pmcid=s.pmc);break}}else if(null!=e.PubmedArticle){_=(e=e.PubmedArticle).MedlineCitation[0];try{null==t.pmid&&(t.pmid=_.PMID[0]._)}catch(e){}try{null==t.title&&(t.title=_.Article[0].ArticleTitle[0])}catch(e){}try{null==t.issn&&(t.issn=_.Article[0].Journal[0].ISSN[0]._)}catch(e){}try{null==t.journal&&(t.journal=_.Article[0].Journal[0].Title[0])}catch(e){}try{null==t.journal_short&&(t.journal_short=_.Article[0].Journal[0].ISOAbbreviation[0])}catch(e){}try{S=_.Article[0].Journal[0].JournalIssue[0].PubDate[0];try{null==t.year&&(t.year=S.Year[0])}catch(e){}try{null==t.published&&(t.published=S.Year[0]+"-"+(S.Month?["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"].indexOf(S.Month[0].toLowerCase())+1:"01")+"-"+(S.Day?S.Day[0]:"01"))}catch(e){}}catch(e){}try{for(null==t.author&&(t.author=[]),T=_.Article[0].AuthorList[0].Author,w=0,g=T.length;w<g;w++){a=T[w],(i={}).family=a.LastName[0],i.given=a.ForeName[0],i.name=(i.given?i.given+" ":"")+(null!=(z=i.family)?z:"");try{i.affiliation=a.AffiliationInfo[0].Affiliation[0]}catch(e){}null!=i.affiliation&&(Array.isArray(i.affiliation)&&(i.affiliation=i.affiliation[0]),"string"==typeof i.affiliation&&(i.affiliation={name:i.affiliation})),t.author.push(i)}}catch(e){}try{for(U=e.PubmedData[0].ArticleIdList[0].ArticleId,x=0,y=U.length;x<y;x++)if("doi"===(A=U[x]).$.IdType){null==t.doi&&(t.doi=A._);break}}catch(e){}try{for(null==t.reference&&(t.reference=[]),C=e.PubmedData[0].ReferenceList[0].Reference,k=0,v=C.length;k<v;k++){I=C[k].Citation[0],M={},-1!==I.indexOf("doi.org/")&&(M.doi=I.split("doi.org/")[1].trim());try{for(M.author=[],P=I.split(". ")[0].split(", "),j=0,b=P.length;j<b;j++)r=P[j],M.author.push({name:r})}catch(e){}try{M.title=I.split(". ")[1].split("?")[0].trim()}catch(e){}try{M.journal=I.replace(/\?/g,".").split(". ")[2].trim()}catch(e){}try{M.url="http"+I.split("http")[1].split(" ")[0],-1!==M.url.indexOf("doi.org")&&delete M.url}catch(e){}"{}"!==JSON.stringify(M)&&t.reference.push(M)}}catch(e){}}try{null==t.pdf&&(t.pdf=e.pdf)}catch(e){}try{null==t.url&&(t.url=e.url)}catch(e){}return t},s.src.ror=async function(e){if(null==e&&(e=this.params.ror),"string"==typeof e&&!e.includes(" ")&&(e=e.split("/").pop()).length<11)return this.src.ror._format(await this.fetch("https://api.ror.org/organizations/"+e))},s.src.ror._index=!0,s.src.ror._prefix=!1,s.src.ror.query=function(e){var t;if(null==e&&(e=null!=(t=this.params.query)?t:this.params.q),"string"==typeof e)return this.fetch('https://api.ror.org/organizations?query="'+e+'"')},s.src.ror.grid=async function(e){var t,i,s,r;if(null==e&&(e=this.params.grid),"string"==typeof e&&e.startsWith("grid.")){if((null!=(s=await this.src.ror('external_ids.GRID.all:"'+e+'"'))?s.id:void 0)||1===(null!=s&&null!=(t=s.hits)?t.total:void 0))return s.id?s:s.hits.hits[0]._source;if(null!=(s=await this.src.ror.query(e))&&null!=(i=s.items)?i[0]:void 0)return r=await this.src.ror._format(s.items[0]),this.waitUntil(this.src.ror(r)),r}},s.src.ror.title=async function(e){var t,i,s,r,a;if(null==e&&(e=null!=(t=this.params.title)?t:this.params.q),"string"==typeof e){if(this.refresh||(r=await this.src.ror('title:"'+e+'"')),(null!=r?r.id:void 0)||1===(null!=r&&null!=(i=r.hits)?i.total:void 0))return r.id?r:r.hits.hits[0]._source;if(null!=(r=await this.src.ror.query(e))&&null!=(s=r.items)?s[0]:void 0)return a=await this.src.ror._format(r.items[0]),this.waitUntil(this.src.ror(a)),a}},s.src.ror._format=function(e){try{e._id=e.id.split("/").pop()}catch(e){}return e};try{r.svc.sherpa=JSON.parse(SECRETS_SHERPA)}catch(e){}s.src.sherpa={},s.src.sherpa.opendoar={_index:!0,_prefix:!1},s.src.sherpa.opendoar.import=async function(){var e,t,i,s,r,a,n,l;for(this.src.sherpa.opendoar(""),a=[],e=0,s=0;(l=await this.fetch("https://v2.sherpa.ac.uk/cgi/retrieve?api-key="+this.S.svc.sherpa.apikey+"&item-type=repository&format=Json&offset="+s))&&null!=(null!=l?l.items:void 0)&&l.items.length;)for(console.log(s,e,l.items.length),s+=100,t=0,i=(n=l.items).length;t<i;t++)r=n[t],e+=1,a.push(r),2e3===a.length&&(await this.src.sherpa.opendoar(a),a=[]);return a.length&&await this.src.sherpa.opendoar(a),e},s.src.sherpa.opendoar.import._hide=!0;var y;o=[].indexOf;s.src.wikidata=function(e){var t,i;try{null==e&&(e=null!=(t=null!=(i=this.params.wikidata)?i:this.params.q)?t:this.params)}catch(e){}return"string"==typeof e?0===e.indexOf("Q")?this.fetch("https://dev.api.cottagelabs.com/use/wikidata/"+e):this.fetch("https://dev.api.cottagelabs.com/use/wikidata?q="+e):this.fetch("https://dev.api.cottagelabs.com/use/wikidata",{body:e})},s.src.wikidata._format=async function(e){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R;for(e._id=e.id,e.qid=e.id,e.createdAt=Date.now(),e.label=null!=(m=e.labels)&&null!=(g=m.en)?g.value:void 0,delete e.labels,E={},r=0,u=(S=null!=(O=e.sitelinks)?O:[]).length;r<u;r++)R=S[r],o.call(R,"enwiki")>=0&&(E[R]=e.sitelinks[R]);for(e.sitelinks=E,e.description=null!=(A=e.descriptions)&&null!=(j=A.en)?j.value:void 0,delete e.descriptions,e.alias=[],a=0,c=(q=null!=(I=e.aliases)?I:[]).length;a<c;a++)for(i=q[a],n=0,h=(C=e.aliases[i]).length;n<h;n++)t=C[n],e.alias.push(t);for(delete e.aliases,e.snaks=[],l=0,d=(y=null!=(P=e.claims)?P:[]).length;l<d;l++)for(N=y[l],f=0,p=(v=e.claims[N]).length;f<p;f++)L=v[f],s=await this.src.wikidata.desnak(L.mainsnak),"{}"!==JSON.stringify(s)&&e.snaks.push(s),null==e.image&&(e.image=s.imgurl);delete e.claims;try{e.wikipedia=null!=(b=null!=(w=e.sitelinks)&&null!=(_=w.enwiki)?_.url:void 0)?b:"https://en.wikipedia.org/wiki/"+e.sitelinks.enwiki.title.replace(/ /g,"_")}catch(e){}try{e.wid=null!=(x=e.sitelinks)&&null!=(k=x.enwiki)?k.url.split("wiki/").pop():void 0}catch(e){}return e},s.src.wikidata.desnak=async function(e){var t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L;if(null==e&&(e=this.params),"object"!=typeof e||null==(null!=(_=e.datavalue)?_.value:void 0))return{};L={qualifiers:[],references:[],property:e.property};try{L.key=(await this.src.wikidata.property(L.property)).label}catch(e){}if("object"!=typeof e.datavalue.value)L.value=e.datavalue.value,"url"===e.datatype&&(L.url=L.value);else if(e.datavalue.value.latitude)L.location={latitude:e.datavalue.value.latitude,longitude:e.datavalue.value.longitude,precision:e.datavalue.value.precision},L.value=L.location.latitude+(L.location.longitude?","+L.location.longitude:""),null!=e.datavalue.value.globe&&(L.globe=e.datavalue.value.globe.split("/").pop());else if(e.datavalue.value.amount){for(i=0,l=(x=["amount","upperBound","lowerBound"]).length;i<l;i++)L[N=x[i]]=e.datavalue.value[N].toString();L.value=L.amount,e.datavalue.value.unit&&(L.unit=e.datavalue.value.unit.split("/").pop())}else if(e.datavalue.value.time){for(r=0,o=(O=["time","timezone","before","after","precision"]).length;r<o;r++)L[N=O[r]]=e.datavalue.value[N].toString();L.value=L.time}else e.datavalue.value.id&&(L.qid=e.datavalue.value.id);for(a=0,u=(A=null!=(S=e.qualifiers)?S:[]).length;a<u;a++)for(v=A[a],n=0,c=(j=e.qualifiers[v]).length;n<c;n++)b=j[n],L.qualifiers.push(await this.src.wikidata.desnak(b));for(f=0,h=(q=null!=(I=e.references)?I:[]).length;f<h;f++)for(g=0,d=(C=(w=q[f])["snaks-order"]).length;g<d;g++)for(E=C[g],y=0,p=(P=w.snaks[E]).length;y<p;y++)t=P[y],L.references.push(await this.src.wikidata.desnak(t));return"image"!==L.key&&("string"!=typeof L.value||"bmp"!==(k=L.value.toLowerCase().split(".").pop())&&"gif"!==k&&"jpg"!==k&&"jpeg"!==k&&"png"!==k&&"svg"!==k&&"tif"!==k&&"webp"!==k)||(L.value.startsWith("http")?L.imgurl=L.value:(L.imgurl="https://upload.wikimedia.org/wikipedia/commons/",s=L.value.replace(/\s/g,"_"),m=crypto.createHash("md5").update(s,"utf8").digest("hex"),L.imgurl+=m.charAt(0)+"/"+m.charAt(0)+m.charAt(1)+"/"+encodeURIComponent(s))),L.value||L.qid?L:{}},y={},s.src.wikidata.properties=async function(){var e,t,i,s,r,a,n;if(this.refresh||"{}"===JSON.stringify(y)){y={};try{if(e=await this.fetch("https://www.wikidata.org/wiki/Wikidata:Database_reports/List_of_properties/all"))for((n=e.split('<table class="wikitable sortable">')[1].split("</table>")[0].split("</tr>")).shift(),t=0,i=n.length;t<i;t++){a=n[t];try{r={},s=a.split("</td>");try{r.pid=s[0].replace("</a>","").split(">").pop().trim().replace("\n","")}catch(e){}try{r.label=s[1].replace("</a>","").split(">").pop().trim().replace("\n","")}catch(e){}try{r.desc=s[2].replace("</a>","").split(">").pop().trim().replace("\n","")}catch(e){}try{r.alias=s[3].replace("</a>","").split(">").pop().replace(/, or/g,",").replace(/, /g,",").trim().replace("\n","").split(",")}catch(e){}try{r.type=s[4].replace("</a>","").split(">").pop().trim().replace("\n","")}catch(e){}try{r.count=s[5].replace("</a>","").split(">").pop().replace(/,/g,"").trim().replace("\n","")}catch(e){}"string"==typeof r.pid&&r.pid.length&&r.pid.startsWith("P")&&(y[r.pid]=r)}catch(e){}}}catch(e){}return y}return y},s.src.wikidata.property=async function(e){var t,i,s,r,a,n,l;if(null==e&&(e=this.params.property),"string"==typeof e){if((a=await this.src.wikidata.properties())[e])return a[e];for(i in l=(n=e.toLowerCase()).split(" ")[0],s=[],t=[],a){if((r=a[i].label.toLowerCase())===n)return a[i];-1!==r.indexOf(n)?s.push(a[i]):-1!==r.indexOf(l)&&t.push(a[i])}return s.concat(t)}},s.src.wikidata.property.terms=async function(e,t=100,i=!0,s=!1){var r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,k,O,S,A,j,I,q;for(null==e&&(e=null!=(m=this.params.terms)?m:this.params.property),q={},u=!1,n=!1,h=0,c=0,j=t<1e3?t:1e3,p="snaks.property.exact:"+e;this.keys(q).length<t&&(!1===u||c<u);){for(null!=(null!=(S=await this.src.wikidata({q:p,size:j,from:j*c}))&&null!=(g=S.hits)?g.total:void 0)&&(h=S.hits.total),u=null==(null!=S&&null!=(y=S.hits)?y.total:void 0)?0:Math.floor(S.hits.total/j),r=0,l=(w=null!=(v=null!=S&&null!=(b=S.hits)?b.hits:void 0)?v:[]).length;r<l;r++)for(a=0,o=(O=null!=(_=null!=(k=w[r]._source)?k.snaks:void 0)?_:[]).length;a<o;a++)(A=O[a]).property===e&&(null!=A.key&&!1===n&&(n=A.key),null==A.value&&null!=A.qid&&null!=(f=await this.src.wikidata(A.qid))&&(A.value=f.label),null!=A.value&&(null==q[A.value]&&(q[A.value]=0,null!=A.qid&&p.split("AND NOT").length<100&&(p+=" AND NOT snaks.qid.exact:"+A.qid)),q[A.value]+=1));c+=1}for(I in d=[],q)d.push({term:I,count:q[I]});return d=s?d.sort((function(e,t){return e.term.toLowerCase().replace(/ /g,"")>t.term.toLowerCase().replace(/ /g,"")?1:-1})):d.sort((function(e,t){return t.count>e.count?1:-1})),i?{property:n,total:h,terms:d}:d.map(x(()=>x.term))},s.src.wikidata.grid2ror=async function(e,t){var i,s,r,a;if("string"==typeof t&&(t=await this.src.wikidata(t)),null==t&&(t=await this.src.wikidata('(snaks.property:"P6782" OR snaks.property:"P1366") AND snaks.property:"P2427" AND snaks.value:"'+e+'"')),"object"==typeof t&&null!=t.snaks)for(i=0,s=(r=t.snaks).length;i<s;i++){if("P6782"===(a=r[i]).property)return a.value;if("P1366"===a.property&&a.qid)return this.src.wikidata.grid2ror(e,a.qid)}},s.src.wikidata._flatten=async function(e){var t,i,s,r,a;for(a={},i=0,s=(r=e.snaks).length;i<s;i++)!(t=r[i]).value&&t.qid&&(t.value=(await this.src.wikidata(_c.qid)).label),!t.value&&t.property&&(t.value=(await this.src.wikidata.property(t)).label),a[t.key]?(Array.isArray(a[t.key])||(a[t.key]=[a[t.key]]),a[t.key].push(t.value)):a[t.key]=t.value;return a},s.src.zenodo={deposition:{},records:{}},s.src.zenodo.records.search=function(e,t){var i;return null==e&&(e=this.params),null==t&&(t=this.params.dev),i="https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records?size="+size+"&q="+e,this.fetch(i)},s.src.zenodo.records.record=function(e,t){var i;return null==e&&(e=null!=(i=this.params.record)?i:this.params.id),null==t&&(t=this.params.dev),this.fetch("https://"+(this.S.dev||t?"sandbox.":"")+"zenodo.org/api/records/"+e)},s.src.zenodo.records.get=async function(e,t){var i;null==e&&(e=this.params.get),null==t&&(t=this.params.dev),i=await this.src.zenodo.records.search(e,t);try{return i.hits.hits[0]}catch(e){}},s.src.zenodo.records.doi=function(e,t){return null==e&&(e=this.params.doi),null==t&&(t=this.params.dev),this.src.zenodo.records.get('doi:"'+e+'"',t)},s.src.zenodo.records.title=function(e,t){return null==e&&(e=this.params.title),null==t&&(t=this.params.dev),this.src.zenodo.records.get('title:"'+e+'"',t)},s.src.zenodo.records.format=async function(e){var t,i,s,r,a,n,l,o,u,c,h;null==e&&(e=this.params),o={};try{null==o.pdf&&(o.pdf=e.pdf)}catch(e){}try{null==o.url&&(o.url=e.url)}catch(e){}null==o.doi&&(o.doi=e.doi);try{if("string"==typeof e.metadata.publication_date&&3===e.metadata.publication_date.split("-").length){o.published=e.metadata.publication_date;try{o.year=o.published.split("-")[0]}catch(e){}}}catch(e){}try{null==o.title&&(o.title=e.metadata.title)}catch(e){}try{null==o.journal&&(o.journal=e.metadata.journal.title)}catch(e){}try{null==o.issue&&(o.issue=e.metadata.journal.issue)}catch(e){}try{null==o.page&&(o.page=e.metadata.journal.pages)}catch(e){}try{null==o.volume&&(o.volume=e.metadata.journal.volume)}catch(e){}try{null==o.keyword&&(o.keyword=e.metadata.keywords)}catch(e){}try{null==o.licence&&(o.licence=e.metadata.license.id)}catch(e){}try{o.abstract=await this.convert.html2txt(e.metadata.description)}catch(e){}try{(e.metadata.access_right="open")&&(null==o.url&&(o.url=null!=e.files&&e.files.length&&null!=(null!=(u=e.files[0].links)?u.self:void 0)?e.files[0].links.self:e.links.html),null==o.open&&(o.open=o.url))}catch(e){}try{for(c=e.files,r=0,n=c.length;r<n;r++)if("pdf"===(s=c[r]).type){null==o.pdf&&(o.pdf=s.links.self);break}}catch(e){}try{for(null==o.author&&(o.author=[]),h=e.metadata.creators,a=0,l=h.length;a<l;a++){if("string"==typeof(t=h[a])&&(t={name:t}),null!=t.name&&"unknown"!==t.name.toLowerCase()){i=t.name.split(" ");try{t.family=i[i.length-1]}catch(e){}try{t.given=t.name.replace(t.family,"").trim()}catch(e){}}null!=t.affiliation&&(_.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),o.author.push(t)}}catch(e){}return o},s.src.zenodo.deposition.create=async function(e,t,i,s){var r,a,n,l,o,u,c,h;return null==s&&(s=this.params.dev),null==i&&(i=this.params.token),null==i&&(i=this.S.dev||s?null!=(n=this.S.src)&&null!=(l=n.zenodo)?l.sandbox:void 0:null!=(o=this.S.src)&&null!=(u=o.zenodo)?u.token:void 0),null==e&&(e=this.params.metadata),null!=i&&null!=e&&null!=e.title&&null!=e.description&&(h="https://"+(this.S.dev||s?"sandbox.":"")+"zenodo.org/api/deposit/depositions?access_token="+i,(a={metadata:e}).metadata.upload_type||(a.metadata.upload_type="publication",a.metadata.publication_type="article"),null==(r=a.metadata).creators&&(r.creators=[{name:"Works, Open Access"}]),null!=t?(null!=(null!=(c=await this.fetch(h,{method:"POST",body:a}))?c.id:void 0)&&(t.content||t.file)&&(c.uploaded=await this.src.zenodo.deposition.upload(c.id,t.content,t.file,t.name,t.url,i)),t.publish&&(c.published=await this.src.zenodo.deposition.publish(c.id,i)),c):await this.fetch(h,{method:"POST",body:a}))},s.src.zenodo.deposition.upload=async function(e,t,i,s,r,a,n){var l,o,u,c;if(null==e&&(e=null!=(l=this.params.upload)?l:this.params.id),null==t&&(t=this.params.content),null==s&&(s=this.params.name),!t&&!i)try{i=this.request.files[0]}catch(e){}if(r&&!t&&!i)try{t=await this.fetch(r)}catch(e){}return null==a&&(a=this.params.token),null==a&&(a=this.S.dev||n?null!=(o=this.S.src.zenodo)?o.sandbox:void 0:null!=(u=this.S.src)&&null!=(c=u.zenodo)?c.token:void 0),null==n&&(n=this.params.dev),null!=a&&null!=e&&(r="https://"+(this.S.dev||n?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/files?access_token="+a,this.fetch(r,{method:"POST",body:null!=t?t:i},{name:s}))},s.src.zenodo.deposition.publish=function(e,t,i){var s,r,a,n,l;return null==e&&(e=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src)&&null!=(n=a.zenodo)?n.token:void 0),null!=t&&null!=e&&(l="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"/actions/publish?access_token="+t,this.fetch(l,{method:"POST"}))},s.src.zenodo.deposition.delete=async function(e,t,i){var s,r,a,n;return null==e&&(e=null!=(s=this.params.publish)?s:this.params.id),null==i&&(i=this.params.dev),null==t&&(t=this.params.token),null==t&&(t=this.S.dev||i?null!=(r=this.S.src.zenodo)?r.sandbox:void 0:null!=(a=this.S.src.zenodo)?a.token:void 0),null!=t&&null!=e&&(n="https://"+(this.S.dev||i?"sandbox.":"")+"zenodo.org/api/deposit/depositions/"+e+"?access_token="+t,await this.fetch(n,{method:"DELETE"}),!0)},s.svc.hanzi={_index:!0,_hides:!0},s.svc.hanzi.collect=async function(){var e,t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b;for(y="http://hanzidb.org/character-list/general-standard",t=0,c=0,this.svc.hanzi("");c<82;)for(c+=1,console.log(c,t),c>1&&(y=y.split("?")[0]+"?page="+c),(m=(await this.fetch(y)).split("<table>")[1].split("</table>")[0].split("</tr>")).shift(),a=["character","pinyin","definition","radical","strokes","HSK","standard","frequency"],i=0,n=m.length;i<n;i++){for(h={type:["character"],page:y},b=0,s=0,l=(d=m[i].replace("<tr>","").replace("</td></td>","</td>").split("</td>")).length;s<l;s++){if("string"==typeof(v=(v=d[s]).replace("<td>",""))&&v.includes("</span>"))v=v.replace("</span>","").split(">")[1];else if("string"==typeof v&&v.includes("</a>"))if(0===b)v=v.replace("</a>","").split(">")[1];else{try{h.radical_float=parseFloat(v.split(">").pop().replace("&nbsp;",""))}catch(e){}try{h.radical_base=parseInt(h.radical_float.toString().split(".")[0])}catch(e){}v=v.split("</a>")[0].split(">").pop();try{h.radical_url="http://hanzidb.org/character/"+v}catch(e){}}try{v=v.replace("&nbsp;","")}catch(e){}try{v=v.trim()}catch(e){}try{"string"==typeof v&&0===v.replace(/[0-9]/g,"").length&&(u=parseInt(v),isNaN(u)||(v=u))}catch(e){}!v||"number"!=(p=typeof v)&&"string"!==p||(h[a[b]]=v),b+=1}h.definition&&h.definition.includes("KangXi radical")&&h.type.push("radical"),h.definition&&h.definition.includes("heavenly stem")&&h.type.push("stem");try{h.url="http://hanzidb.org/character/"+h.character}catch(e){}if(h.ascii="",h.tones=[],h.pinyin)for(r=0,o=(f=[...h.pinyin.normalize("NFD")]).length;r<o;r++)(g=["",772,769,780,768].indexOf((e=f[r]).codePointAt(0)))&&g>0&&h.tones.push(g),0===e.replace(/[a-zA-Z]/g,"").length&&(h.ascii+=e);null!=h.character?this.svc.hanzi(h):console.log(h),t+=1}return t},s.svc.hanzi.collect._async=!0;try{r.svc.oaworks=JSON.parse(SECRETS_OAWORKS)}catch(e){r.svc.oaworks={}}s.svc.oaworks=async function(){var e;return"{}"!==JSON.stringify(this.params)?{status:404}:{name:"OA.Works Paradigm API",version:this.S.version,base:this.S.dev?this.base:void 0,built:this.S.dev?this.S.built:void 0,user:(null!=(e=this.user)?e.email:void 0)?this.user.email:void 0,routes:await this._subroutes("svc.oaworks")}},s.svc.oaworks.templates={_key:"name",_sheet:"16Qm8n3Rmx3QyttFpSGj81_7T6ehfLAtYRSvmDf3pAzg/1",_hide:!0},s.svc.oaworks.deal={_index:!0,_hides:!0,_prefix:!1},s.svc.oaworks.deal.institution={_index:!0,_prefix:!1},s.svc.oaworks.deal.import=async function(){var e,t,i,s,r,a,n,l,o;for(t={},s=0,r=(o=await this.src.google.sheets("1dPG7Xxvk4qnPajTu9jG_uNuz2R5jvjfeaKI-ylX4NXs")).length;s<r;s++){l=o[s];try{if(l.value=parseInt(l.packageprice.replace(/[^0-9]+/g,"")),"string"==typeof l.fte)try{l.fte=parseInt(l.fte)}catch(e){delete l.fte}-1!==l.notes.toLowerCase().indexOf("canadian")?(l.gbpvalue=Math.floor(.57*l.value),l.usdvalue=Math.floor(.75*l.value)):-1!==l.packageprice.indexOf("$")?(l.gbpvalue=Math.floor(.77*l.value),l.usdvalue=Math.floor(l.value)):(l.gbpvalue=Math.floor(l.value),l.usdvalue=Math.floor(1.3*l.value))}catch(e){}null==l.usdvalue&&(l.usdvalue="");try{"2103"===l.years&&(l.years="2013")}catch(e){}try{"yes"!==l.shareurlpublicly.toLowerCase()&&delete l.url}catch(e){}try{delete l.shareurlpublicly}catch(e){}try{""===l.collection&&(l.collection="Unclassified")}catch(e){}try{l.carnegiebasicclassification=l["2015carnegiebasicclassification"],delete l["2015carnegiebasicclassification"]}catch(e){}try{null==t[a=l.institution]&&(t[a]={institution:l.institution,deals:[],value:0,usdvalue:0,gbpvalue:0}),n=JSON.parse(JSON.stringify(l));try{delete n.institution}catch(e){}try{t[l.institution].value+=l.value,t[l.institution].gbpvalue+=l.gbpvalue,t[l.institution].usdvalue+=l.usdvalue}catch(e){}t[l.institution].deals.push(n)}catch(e){}}for(e in i=[],t)i.push(t[e]);return await this.svc.oaworks.deal(""),await this.svc.oaworks.deal.institution(""),await this.svc.oaworks.deal(o),await this.svc.oaworks.deal.institution(i),{retrieved:o.length,institutions:i.length}},s.svc.oaworks.deposit=async function(e,t,i){var s,r,a,n,l,o,u,c,h,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe,fe,me,ge,ye,ve;for(null==e&&(e=this.copy(this.params)),null==t&&(t=this.request.files),h={zenodo:{}},m=0,w=(C=["embedded","demo","pilot","live","email","plugin"]).length;m<w;m++)h[v=C[m]]=e[v];if(h.pilot=!0===h.pilot?Date.now():void 0,h.live=!0===h.live?Date.now():void 0,null!=t&&t.length&&(h.name=null!=(P=t[0].filename)?P:t[0].name),"anonymous"!==e.from&&(h.from=e.from),e.confirmed&&(h.confirmed=decodeURIComponent(e.confirmed)),ge=e.config,"string"==typeof e.config&&(ge=JSON.parse(e.config)),!e.config&&e.from&&(ge=await this.fetch("https://"+(this.S.dev||i?"dev.":"")+"api.cottagelabs.com/service/oab/deposit/config?uid="+e.from)),(null!=(J=(q=await this.svc.oaworks.permissions(e.metadata)).file)?J.archivable:void 0)&&(null!=h.confirmed&&h.confirmed===q.file.checksum||!h.confirmed)){for((ve={content:t[0].data,name:q.file.name}).publish=!0===(null!=(Z=this.S.svc.oaworks)&&null!=(le=Z.deposit)?le.zenodo:void 0),c=[],y=0,_=(ce=null!=(oe=null!=(ue=e.metadata)?ue.author:void 0)?oe:[]).length;y<_;y++)if(null!=(s=ce[y]).family){a={name:s.family+(s.given?", "+s.given:"")};try{s.ORCID&&(a.orcid=s.ORCID.split("/").pop())}catch(e){}try{"object"==typeof s.affiliation&&null!=s.affiliation.name&&(a.affiliation=s.affiliation.name)}catch(e){}c.push(a)}0===c.length&&(c=[{name:"Unknown"}]),p=e.metadata.abstract?e.metadata.abstract+"<br><br>":"",(p=(p+=null!=(he=null!=(de=q.best_permission)?de.deposit_statement:void 0)?he:null!=e.metadata.doi?"The publisher's final version of this work can be found at https://doi.org/"+d.metadata.doi:"").trim()).lastIndexOf(".")!==p.length-1&&(p+="."),p.length&&(p+=" "),p+="<br><br>Deposited by shareyourpaper.org and openaccessbutton.org. We've taken reasonable steps to ensure this content doesn't violate copyright. However, if you think it does you can request a takedown by emailing help@openaccessbutton.org.",A={title:null!=(N=e.metadata.title)?N:"Unknown",description:p.trim(),creators:c,version:"preprint"===q.file.version?"Submitted Version":"postprint"===q.file.version?"Accepted Version":"publisher pdf"===q.file.version?"Published Version":"Accepted Version",journal_title:e.metadata.journal,journal_volume:e.metadata.volume,journal_issue:e.metadata.issue,journal_pages:e.metadata.page},null!=e.metadata.doi?!(g=await this.src.zenodo.records.doi(e.metadata.doi))||h.confirmed===q.file.checksum||this.S.dev||i?g?A.related_identifiers=[{relation:"postprint"===A.version||"AAM"===A.version||"preprint"===A.version?"isPreviousVersionOf":"isIdenticalTo",identifier:d.metadata.doi}]:A.doi=e.metadata.doi:h.zenodo.already=g.id:(null!=(E=this.S.svc.oaworks.zenodo)?E.prereserve_doi:void 0)&&(A.prereserve_doi=!0),A.access_right="open",A.license=null!=(L=null!=(R=q.best_permission)?R.licence:void 0)?L:"cc-by",-1!==A.license.indexOf("other")&&-1!==A.license.indexOf("closed")&&(A.license="other-closed"),-1!==A.license.indexOf("other")&&-1!==A.license.indexOf("non")&&-1!==A.license.indexOf("commercial")&&(A.license="other-nc"),0===A.license.toLowerCase().indexOf("cc")&&isNaN(parseInt(A.license.substring(A.license.length-1)))&&(A.license+="-4.0");try{(null!=(D=q.best_permission)?D.embargo_end:void 0)&&moment(q.best_permission.embargo_end,"YYYY-MM-DD").valueOf()>Date.now()&&(A.access_right="embargoed",A.embargo_date=q.best_permission.embargo_end)}catch(e){}try{null!=e.metadata.published&&"string"==typeof e.metadata.published&&(A.publication_date=e.metadata.published)}catch(e){}if(ge){if(null!=ge.community_ID&&null==ge.community&&(ge.community=ge.community_ID),ge.community)for(null==ge.communities&&(ge.communities=[]),b=0,x=(T="string"==typeof ge.community?ge.community.split(","):ge.community).length;b<x;b++)o=T[b],ge.communities.push({identifier:o});if(null!=ge.community||null!=ge.communities)for(null==ge.communities&&(ge.communities=ge.community),Array.isArray(ge.communities)||(ge.communities=[ge.communities]),A.communities=[],S=0,k=(z=ge.communities).length;S<k;S++)u=z[S],A.communities.push("string"==typeof u?{identifier:u}:u)}if(pe=this.S.dev||i||h.demo?null!=(U=this.S.svc.oaworks)&&null!=(M=U.zenodo)?M.sandbox:void 0:null!=(W=this.S.svc.oaworks)&&null!=(B=W.zenodo)?B.token:void 0){if(!h.zenodo.already)if((ye=await this.src.zenodo.deposition.create(A,ve,pe)).id)h.zenodo.id=ye.id,h.zenodo.url="https://"+(this.S.dev||i||h.demo?"sandbox.":"")+"zenodo.org/record/"+ye.id,null!=(null!=(Y=ye.metadata)&&null!=(F=Y.prereserve_doi)?F.doi:void 0)&&(h.zenodo.doi=ye.metadata.prereserve_doi.doi),h.zenodo.file=null!=(V=null!=(X=ye.uploaded)&&null!=($=X.links)?$.download:void 0)?V:null!=(G=ye.uploaded)&&null!=(H=G.links)?H.download:void 0;else{h.error="Deposit to Zenodo failed";try{h.error+=": "+JSON.stringify(ye)}catch(e){}}}else h.error="No Zenodo credentials available"}if(null!=(null!=(K=q.file)?K.version:void 0)&&(h.version=q.file.version),h.zenodo.id?((null!=(Q=q.best_permission)?Q.embargo_end:void 0)&&moment(q.best_permission.embargo_end,"YYYY-MM-DD").valueOf()>Date.now()&&(h.embargo=q.best_permission.embargo_end),h.type="zenodo"):null!=h.error&&-1!==h.error.toLowerCase().indexOf("zenodo")?h.type="review":e.from&&(!h.embedded||-1===h.embedded.indexOf("oa.works")&&-1===h.embedded.indexOf("openaccessbutton.org")&&-1===h.embedded.indexOf("shareyourpaper.org"))?h.type=e.redeposit?"redeposit":null!=t&&t.length?"forward":"dark":h.type="review",l=["joe@openaccessbutton.org","natalia.norori@openaccessbutton.org"],me=[],"string"==typeof(null!=ge?ge.owner:void 0)&&-1!==ge.owner.indexOf("@")?me.push(ge.owner):ge.email&&me.push(ge.email),0===me.length&&(me=this.copy(l),l=[]),h.url="string"==typeof e.redeposit?e.redeposit:e.url?e.url:void 0,null!=(null!=(ee=(f=this.copy(h)).metadata)?ee.author:void 0)){for(r=[],I=0,O=(te=f.metadata.author).length;I<O;I++)(n=te[I]).family&&r.push((n.given?n.given+" ":"")+n.family);f.metadata.author=r}return f.adminlink=f.embedded?f.embedded:"https://shareyourpaper.org"+(null!=(null!=(ie=f.metadata)?ie.doi:void 0)?"/"+f.metadata.doi:""),f.adminlink+=-1===f.adminlink.indexOf("?")?"?":"&",null!=(null!=q&&null!=(se=q.file)?se.checksum:void 0)&&(f.confirmed=encodeURIComponent(q.file.checksum),f.adminlink+="confirmed="+f.confirmed+"&"),f.adminlink+="email="+f.email,fe=(fe=await this.svc.oaworks.templates(h.type+"_deposit.html")).content,!1!==(null!=(re=q.file)?re.archivable:void 0)&&(j={from:"deposits@openaccessbutton.org",to:me,template:fe,vars:f,subject:null!=(ae=sub.subject)?ae:h.type+" deposit",html:sub.content},l.length&&(j.bcc=l),Array.isArray(t)&&t.length&&(j.attachments=[{filename:null!=(ne=t[0].filename)?ne:t[0].name,content:t[0].data}]),this.waitUntil(this.mail(j))),h},s.svc.oaworks.deposit._index=!0;o=[].indexOf;s.svc.oaworks.metadata=async function(e){var t;return null!=(t=await this.svc.oaworks.find(e))?t.metadata:void 0},s.svc.oaworks.find=async function(e,t={},i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O;k={},r=async e=>{var i,s;for(s in i=await this.svc.oaworks.citation(e))"url"===s||"paywall"===s?null==k[s]&&(k[s]=i[s]):null==t[s]&&(t[s]=i[s]);return!0},"string"==typeof e&&(e={doi:e});try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==i&&(i=null!=(f=e.dom)?f:"string"==typeof this.body?this.body:void 0),e.metadata&&(e.find=e.metadata),e.find&&(0===e.find.indexOf("10.")&&-1!==e.find.indexOf("/")?e.doi=e.find:e.url=e.find,delete e.find),null==e.url&&(e.url=null!=(m=e.q)?m:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),-1!==e.url.indexOf("/10.")&&-1!==(u="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).indexOf("/")&&u.split("/")[0].length>6&&u.length>8&&((c=u.split("/")).length>2&&(u=c.join("/")),null==t.doi&&(t.doi=u)),0===e.url.replace("doi:","").replace("doi.org/","").trim().indexOf("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):0===e.url.toLowerCase().indexOf("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&-1===e.url.indexOf(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null==t.title&&0!==e.url.indexOf("http")&&(-1!==e.url.indexOf("{")||(null!=(g=e.url.replace("...","").match(/\./gi))?g:[]).length>3||(null!=(y=e.url.match(/\(/gi))?y:[]).length>2?e.citation=e.url:t.title=e.url),0===e.url.indexOf("http")&&-1!==e.url.indexOf(".")||delete e.url),"string"==typeof e.title&&(-1!==e.title.indexOf("{")||(null!=(v=e.title.replace("...","").match(/\./gi))?v:[]).length>3||(null!=(b=e.title.match(/\(/gi))?b:[]).length>2)&&(e.citation=e.title,delete e.title),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(w=e.pmcid)?w:e.pmc),e.citation&&await r(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.title=await this.decode(t.title)}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}if("string"==typeof t.doi&&0===t.doi.indexOf("10.")||delete t.doi,t.title||!i||"string"!=typeof e.url||-1===e.url.indexOf("alma.exlibrisgroup.com")&&-1===e.url.indexOf("/exlibristest")||delete e.url,null!=e.demo&&(k.demo=e.demo),("10.1234/567890"===t.doi||null!=t.doi&&0===t.doi.indexOf("10.1234/oab-syp-")||"Engineering a Powerfully Simple Interlibrary Loan Experience with InstantILL"===t.title||"qZooaHWRz9NLFNcgR"===(_=e.from)||"eZwJ83xp3oZDaec86"===_)&&null==k.demo&&(k.demo=!0),k.demo&&null==k.test&&(k.test=!0),n=async()=>{var s,a,n,l,o,u,c;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||(c=await this.svc.oaworks.scrape(null!=i?i:e.url),await r(c)),t.doi||((t.pmid||t.pmcid)&&(l=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(u=t.pmcid)?u:t.pmid),await r(l)),!t.doi&&t.title&&t.title.length>8&&t.title.split(" ").length>1&&(t.title=t.title.replace(/\+/g," "),(null!=(n=await this.src.crossref.works.title(t.title))?n.type:void 0)&&(null!=n?n.DOI:void 0)&&await r(n),t.doi||(null!=(o=await this.src.microsoft.graph(t.title))?o.PaperTitle:void 0)&&await r(o),t.doi||null!=l||(l=await this.src.epmc.title(t.title),await r(l)))),t.doi&&(async()=>{var e,i,s,r,a,n,l,o,u;if(null!=(null!=(i=await this.src.fatcat(t.doi))?i.files:void 0))for(r=0,n=(u=i.files).length;r<n;r++)if(-1!==(e=u[r]).mimetype.toLowerCase().indexOf("pdf")&&"active"===e.state)for(a=0,l=(o=e.urls).length;a<l;a++)if((s=o[a]).url&&"webarchive"===s.rel){k.url=s.url;break}return!0},a=async()=>{var e;return null==(e=await this.src.oadoi(t.doi))&&(k.doi_not_in_oadoi=t.doi),(null!=e?e.doi:void 0)&&(null!=t?t.doi:void 0)&&e.doi.toLowerCase()===t.doi.toLowerCase()&&await r(e),!0},s=async()=>((null!=(n=await this.src.crossref.works(t.doi))?n.type:void 0)?await r(n):k.doi_not_in_crossref=t.doi,!0),await Promise.all([a(),s()])),!0},await n(),!t.doi&&!i&&!e.url&&("undefined"==typeof epmc||null===epmc)&&t.title&&t.title.length>8&&t.title.split(" ").length>1)try{p=unidecode(t.title.toLowerCase()).replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),(null!=(o=await this.src.microsoft.bing.search(p))?o.data:void 0)&&(l=unidecode(o.data[0].name.toLowerCase()).replace("(pdf)","").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),0===p.replace(/ /g,"").indexOf(l.replace(/ /g,""))&&(e.url=o.data[0].url.replace(/"/g,""),"string"==typeof e.url&&-1!==e.url.indexOf("pubmed.ncbi")&&(t.pmid=e.url.replace(/\/$/,"").split("/").pop()),"string"==typeof e.url&&-1!==e.url.indexOf("/10.")&&null==t.doi&&(t.doi="10."+e.url.split("/10.")[1]))),(t.doi||t.pmid||e.url)&&await n()}catch(e){}for(s=async()=>{var i;if((t.doi||t.title&&t.title.length>8&&t.title.split(" ").length>1)&&(e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill))try{null==k.ill&&(k.ill={subscription:await this.svc.oaworks.ill.subscription(null!=(i=e.config)?i:e.from,t)})}catch(e){}return!0},a=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==k.permissions&&(k.permissions=await this.svc.oaworks.permissions(t,null!=(i=e.config)?i.ror:void 0,!1)),!0},await Promise.all([s(),a()]),h=0,d=(x=["title","journal","year","doi"]).length;h<d;h++)e[O=x[h]]&&e[O]!==t[O]&&(t[O]=e[O]);return k.metadata=t,k},s.svc.oaworks.citation=function(e){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe,fe,me,ge,ye,ve,be,we,_e,xe,ke,Oe,Se,Ae,je,Ie,qe,Ce,Pe,Ne,Ee,Le,Re,De,Te,ze,Ue,Me,We,Je,Be,Ye,Fe;ze={};try{null==e&&(e=null!=(L=this.params.citation)?L:this.params)}catch(e){}if("string"==typeof e&&(0===e.indexOf("{")||0===e.indexOf("[")))try{e=JSON.parse(e)}catch(e){}if("object"==typeof e){ze.doi=null!=(R=e.DOI)?R:e.doi,e.pmid&&(ze.pmid=e.pmid),e.pmcid&&(ze.pmcid=e.pmcid);try{ze.type=null!=(V=e.type)?V:e.genre}catch(e){}null==ze.issn&&(ze.issn=null!=(se=null!=(fe=null!=(Se=e.ISSN)?Se:e.issn)?fe:null!=(Le=e.journalInfo)&&null!=(Re=Le.journal)?Re.issn:void 0)?se:null!=(De=e.journal)?De.issn:void 0),null!=(null!=(Te=e.journalInfo)&&null!=(D=Te.journal)?D.eissn:void 0)&&(null==ze.issn&&(ze.issn=[]),"string"==typeof ze.issn&&(ze.issn=[ze.issn]),ze.issn.push(e.journalInfo.journal.eissn)),e.journal_issns&&null==ze.issn&&(ze.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==ze.title&&(ze.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(ze.title+=": "+e.subtitle[0])}catch(e){}null==ze.title&&(ze.title=null!=(T=e.dctitle)?T:null!=(z=e.bibjson)?z.title:void 0),404!==(U=e.title)&&"404"!==U&&null==ze.title&&(ze.title=e.title),"string"==typeof ze.title&&(ze.title=ze.title.replace(/\s\s+/g," ").trim());try{null==ze.journal&&(ze.journal=e["container-title"][0])}catch(e){}try{ze.shortname=e["short-container-title"][0]}catch(e){}try{ze.shortname=null!=(M=e.journalInfo.journal.isoabbreviation)?M:e.journalInfo.journal.medlineAbbreviation}catch(e){}null==ze.journal&&(ze.journal=null!=(W=null!=(J=e.journal_name)?J:null!=(B=e.journalInfo)&&null!=(Y=B.journal)?Y.title:void 0)?W:null!=(F=e.journal)?F.title:void 0),e.journal&&(ze.journal=e.journal.split("(")[0].trim());try{for(c=0,m=(X=["title","journal"]).length;c<m;c++)ze[p=X[c]]=ze[p].charAt(0).toUpperCase()+ze[p].slice(1)}catch(e){}null==ze.publisher&&(ze.publisher=e.publisher),ze.publisher&&(ze.publisher=ze.publisher.trim());try{null!=e.issue&&null==ze.issue&&(ze.issue=e.issue)}catch(e){}try{(null!=($=e.journalInfo)?$.issue:void 0)&&null==ze.issue&&(ze.issue=e.journalInfo.issue)}catch(e){}try{null!=e.volume&&null==ze.volume&&(ze.volume=e.volume)}catch(e){}try{(null!=(G=e.journalInfo)?G.volume:void 0)&&null==ze.volume&&(ze.volume=e.journalInfo.volume)}catch(e){}try{null!=e.page&&null==ze.page&&(ze.page=e.page.toString())}catch(e){}e.pageInfo&&(ze.page=e.pageInfo.toString()),(e.abstract||e.abstractText)&&(ze.abstract=null!=(H=e.abstract)?H:e.abstractText);try{ze.abstract&&(ze.abstract=this.convert.html2txt(ze.abstract).replace(/\n/g," ").replace("Abstract ",""))}catch(e){}for(h=0,g=(K=["published-print","journal-issue.published-print","journalInfo.printPublicationDate","firstPublicationDate","journalInfo.electronicPublicationDate","published","published_date","issued","published-online","created","deposited","indexed"]).length;h<g;h++)if(q=K[h],!ze.published||ze.DOI){if(Me=null!=(Q=null!=(Z=e[q])?Z:null!=(ee=e["journal-issue"])?ee[q.replace("journal-issue.","")]:void 0)?Q:null!=(te=e.journalInfo)?te[q.replace("journalInfo.","")]:void 0){"number"==typeof Me&&(Me=Me.toString());try{"string"!=typeof Me&&(Me=Me["date-time"].toString())}catch(e){}if("string"!=typeof Me)try{for(d in Me["date-parts"][0])"number"!=(ie=typeof Me["date-parts"][0][d])&&"string"!==ie&&(Me["date-parts"][0][d]="01");Me=Me["date-parts"][0].join("-")}catch(e){}"string"==typeof Me&&(ze.published=-1!==Me.indexOf("T")?Me.split("T")[0]:Me,ze.published=ze.published.replace(/\//g,"-").replace(/-(\d)-/g,"-0$1-").replace(/-(\d)$/,"-0$1"),-1===ze.published.indexOf("-")&&(ze.published+="-01"),3!==ze.published.split("-").length&&(ze.published+="-01"),null==ze.year&&(ze.year=ze.published.split("-")[0]),3!==ze.published.split("-").length&&delete ze.published,4!==ze.year.length&&delete ze.year)}if(ze.published)break}e.year&&null==ze.year&&(ze.year=e.year);try{null==ze.year&&(ze.year=e.journalInfo.yearOfPublication.trim())}catch(e){}if(null==ze.author&&(null!=e.author||null!=e.z_authors||(null!=(re=e.authorList)?re.author:void 0))){null==ze.author&&(ze.author=[]);try{for(le=null!=(ae=null!=(ne=e.author)?ne:e.z_authors)?ae:e.authorList.author,j=0,y=le.length;j<y;j++)if("string"==typeof(t=le[j]))ze.author.push({name:t});else{if((r={}).given=null!=(oe=t.given)?oe:t.firstName,r.family=null!=(ue=t.family)?ue:t.lastName,r.name=(r.given?r.given+" ":"")+(null!=(ce=r.family)?ce:""),null!=t.affiliation)try{for(he=r.affiliation?Array.isArray(t.affiliation)?t.affiliation:[t.affiliation]:r.authorAffiliationDetailsList.authorAffiliation,I=0,v=he.length;I<v;I++)"string"==typeof(i=he[I])?(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:i.replace(/\s\s+/g," ").trim()})):"object"==typeof i&&(i.name||i.affiliation)&&(null==r.affiliation&&(r.affiliation=[]),r.affiliation.push({name:(null!=(de=i.name)?de:i.affiliation).replace(/\s\s+/g," ").trim()}))}catch(e){}ze.author.push(r)}}catch(e){}}try{null!=e.subject&&e.subject.length&&"string"==typeof e.subject[0]&&(ze.subject=e.subject)}catch(e){}try{null!=(null!=(pe=e.keywordList)?pe.keyword:void 0)&&e.keywordList.keyword.length&&"string"==typeof e.keywordList.keyword[0]&&(ze.keyword=e.keywordList.keyword)}catch(e){}try{for(be=[...null!=(me=null!=(ge=e.meshHeadingList)?ge.meshHeading:void 0)?me:[],...null!=(ye=null!=(ve=e.chemicalList)?ve.chemical:void 0)?ye:[]],N=0,b=be.length;N<b;N++)S=be[N],null==ze.keyword&&(ze.keyword=[]),"string"==typeof(A="string"==typeof S?S:null!=(we=S.name)?we:S.descriptorName)&&A&&o.call(ze.keyword,A)<0&&ze.keyword.push(A)}catch(e){}"string"==typeof e.license&&(ze.licence=e.license.trim().replace(/ /g,"-")),"string"==typeof e.licence&&(ze.licence=e.licence.trim().replace(/ /g,"-"));try{(null!=(_e=e.best_oa_location)?_e.license:void 0)&&null!==(null!=(xe=e.best_oa_location)?xe.license:void 0)&&null==ze.licence&&(ze.licence=e.best_oa_location.license)}catch(e){}if(!ze.licence){if(Array.isArray(e.assertion))for(E=0,w=(ke=e.assertion).length;E<w;E++)"OPEN ACCESS"===(t=ke[E]).label&&t.URL&&-1!==t.URL.indexOf("creativecommons")&&null==ze.licence&&(ze.licence=t.URL);if(Array.isArray(e.license))for(We=0,_=(Ae=null!=(Oe=e.license)?Oe:[]).length;We<_;We++)!(f=Ae[We]).URL||-1===f.URL.indexOf("creativecommons")||ze.licence&&-1!==ze.licence.indexOf("creativecommons")||null==ze.licence&&(ze.licence=f.URL)}if("string"==typeof ze.licence&&-1!==ze.licence.indexOf("/licenses/")&&(ze.licence="cc-"+ze.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-").replace(/-$/,"")),null==ze.url&&(ze.url=null!=(je=null!=(Ie=e.best_oa_location)?Ie.url_for_pdf:void 0)?je:null!=(qe=e.best_oa_location)?qe.url:void 0),!ze.url&&null!=(null!=(Ce=e.fullTextUrlList)?Ce.fullTextUrl:void 0))for(Be=0,x=(Pe=e.fullTextUrlList.fullTextUrl).length;Be<x;Be++)"oa"!==(Ne=(n=Pe[Be]).availabilityCode.toLowerCase())&&"f"!==Ne||ze.url&&("pdf"!==n.documentStyle||-1!==ze.url.indexOf("pdf"))||(ze.url=n.url)}else if("string"==typeof e)try{-1!==(e=e.replace(/citation\:/gi,"").trim()).indexOf("title")&&(e=e.split("title")[1].trim()),-1!==(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).indexOf("doi:")&&(ze.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),-1!==e.indexOf("doi.org/")&&(ze.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),ze.doi||-1===e.indexOf("http")||(ze.url="http"+e.split("http")[1].split(" ")[0].trim());try{-1===e.indexOf("|")&&-1===e.indexOf("}")||(ze.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?ze.title=e.split('"')[1].trim():e.split("'").length>2&&null==ze.title&&(ze.title=e.split("'")[1].trim())}catch(e){}try{for(P=e.replace(/,\./g," ").split(" "),Ye=0,k=P.length;Ye<k;Ye++)C=P[Ye],ze.year||4===(C=C.replace(/[^0-9]/g,"")).length&&("number"!=typeof(Je=parseInt(C))||isNaN(Je)||(ze.year=Je))}catch(e){}try{!ze.title&&ze.year&&e.indexOf(ze.year)<e.length/4&&(ze.title=e.split(ze.year)[1].trim(),(-1===ze.title.indexOf("(")||ze.title.indexOf(")")<ze.title.indexOf("("))&&(ze.title=ze.title.replace(")","")),ze.title.indexOf(".")<3&&(ze.title=ze.title.replace(".","")),ze.title.indexOf(",")<3&&(ze.title=ze.title.replace(",","")),ze.title=ze.title.trim(),-1!==ze.title.indexOf(".")?ze.title=ze.title.split(".")[0]:-1!==ze.title.indexOf(",")&&(ze.title=ze.title.split(",")[0]))}catch(e){}if(ze.title){try{if(a=e.split(ze.title)[0],ze.year&&-1!==a.indexOf(ze.year)&&(a=a.split(ze.year)[0]),ze.url&&a.indexOf(ze.url)>0&&(a=a.split(ze.url)[0]),ze.url&&0===a.indexOf(ze.url)&&(a=a.replace(ze.url)),ze.doi&&0===a.indexOf(ze.doi)&&(a=a.replace(ze.doi)),a.indexOf(".")<3&&(a=a.replace(".","")),a.indexOf(",")<3&&(a=a.replace(",","")),a.lastIndexOf("(")>a.length-3&&(a=a.substring(0,a.lastIndexOf("("))),a.lastIndexOf(")")>a.length-3&&(a=a.substring(0,a.lastIndexOf(")"))),a.lastIndexOf(",")>a.length-3&&(a=a.substring(0,a.lastIndexOf(","))),a.lastIndexOf(".")>a.length-3&&(a=a.substring(0,a.lastIndexOf("."))),(a=a.trim()).length>6)if(-1!==a.indexOf(","))for(ze.author=[],Ee=a.split(","),Fe=0,O=Ee.length;Fe<O;Fe++)s=Ee[Fe],ze.author.push({name:s});else ze.author=[{name:a}]}catch(e){}try{Ue=e.split(ze.title)[1],ze.url&&-1!==Ue.indexOf(ze.url)&&(Ue=Ue.replace(ze.url)),ze.doi&&-1!==Ue.indexOf(ze.doi)&&(Ue=Ue.replace(ze.doi)),Ue.indexOf(".")<3&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<3&&(Ue=Ue.replace(",","")),(Ue=Ue.trim()).length>6&&(ze.journal=Ue,-1!==Ue.indexOf(",")&&(ze.journal=ze.journal.split(",")[0].replace(/in /gi,"").trim()),ze.journal.indexOf(".")<3&&(ze.journal=ze.journal.replace(".","")),ze.journal.indexOf(",")<3&&(ze.journal=ze.journal.replace(",","")),ze.journal=ze.journal.trim())}catch(e){}}try{if(ze.journal&&(Ue=e.split(ze.journal)[1],ze.url&&-1!==Ue.indexOf(ze.url)&&(Ue=Ue.replace(ze.url)),ze.doi&&-1!==Ue.indexOf(ze.doi)&&(Ue=Ue.replace(ze.doi)),Ue.indexOf(".")<3&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<3&&(Ue=Ue.replace(",","")),(Ue=Ue.trim()).length>4)){if(-1!==Ue.indexOf("retrieved")&&(Ue=Ue.split("retrieved")[0]),-1!==Ue.indexOf("Retrieved")&&(Ue=Ue.split("Retrieved")[0]),ze.volume=Ue,-1!==ze.volume.indexOf("(")){ze.volume=ze.volume.split("(")[0],ze.volume=ze.volume.trim();try{ze.issue=Ue.split("(")[1].split(")")[0],ze.issue=ze.issue.trim()}catch(e){}}if(-1!==ze.volume.indexOf(",")){ze.volume=ze.volume.split(",")[0],ze.volume=ze.volume.trim();try{ze.issue=Ue.split(",")[1],ze.issue=ze.issue.trim()}catch(e){}}if(ze.volume)try{isNaN(parseInt(ze.volume))&&delete ze.volume}catch(e){}if(ze.issue){-1!==ze.issue.indexOf(",")&&(ze.issue=ze.issue.split(",")[0].trim());try{isNaN(parseInt(ze.issue))&&delete ze.issue}catch(e){}}if(ze.volume&&ze.issue)try{-1!==(Ue=e.split(ze.journal)[1]).indexOf("retriev")&&(Ue=Ue.split("retriev")[0]),-1!==Ue.indexOf("Retriev")&&(Ue=Ue.split("Retriev")[0]),ze.url&&-1!==Ue.indexOf(ze.url)&&(Ue=Ue.split(ze.url)[0]),ze.doi&&-1!==Ue.indexOf(ze.doi)&&(Ue=Ue.split(ze.doi)[0]),(Ue=(Ue=Ue.substring(Ue.indexOf(ze.volume)+(ze.volume+"").length)).substring(Ue.indexOf(ze.issue)+(ze.issue+"").length)).indexOf(".")<2&&(Ue=Ue.replace(".","")),Ue.indexOf(",")<2&&(Ue=Ue.replace(",","")),Ue.indexOf(")")<2&&(Ue=Ue.replace(")","")),Ue=Ue.trim(),isNaN(parseInt(Ue.substring(0,1)))||(ze.pages=Ue.split(" ")[0].split(".")[0].trim(),ze.pages.length>5&&(ze.pages=ze.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(ze.author||-1===e.indexOf("et al")||(u=e.split("et al")[0].trim(),0===e.indexOf(u)&&(ze.author=[{name:u+"et al"}])),ze.title&&!ze.volume)try{-1!==(l=e.split(ze.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).indexOf("vol")&&(ze.volume=l.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),ze.issue||-1===l.indexOf("iss")||(ze.issue=l.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),ze.pages||-1===l.indexOf("page")||(ze.pages=l.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return"number"==typeof ze.year&&(ze.year=ze.year.toString()),ze},s.svc.oaworks.availability=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q;if(null==e&&(e=this.copy(this.params)),delete this.params.dom,e.availability&&(e.availability.startsWith("10.")&&-1!==e.availability.indexOf("/")?e.doi=e.availability:-1!==e.availability.indexOf(" ")?e.title=e.availability:e.id=e.availability,delete e.availability),Array.isArray(e.url)&&(e.url=e.url[0]),!e.test&&e.url,i={data:{availability:[],requests:[],accepts:[],meta:{article:{},data:{}}}},null!=e&&(i.data.match=null!=(a=null!=(n=null!=(y=null!=(w=null!=(_=null!=(x=null!=(k=null!=(O=e.doi)?O:e.pmid)?k:e.pmc)?x:e.pmcid)?_:e.title)?w:e.url)?y:e.id)?n:e.citation)?a:e.q),"object"==typeof t&&"{}"!==JSON.stringify(t)&&null!=t.metadata&&(i.v2=t),null==i.v2&&(i.v2=await this.svc.oaworks.find(e)),null!=i.v2){null==(s=i.data).match&&(s.match=null!=(S=null!=(A=null!=(l=null!=(o=null!=(u=null!=(c=i.v2.input)?c:null!=(h=i.v2.metadata)?h.doi:void 0)?u:null!=(d=i.v2.metadata)?d.title:void 0)?o:null!=(p=i.v2.metadata)?p.pmid:void 0)?l:null!=(f=i.v2.metadata)?f.pmc:void 0)?A:null!=(m=i.v2.metadata)?m.pmcid:void 0)?S:null!=(g=i.v2.metadata)?g.url:void 0),Array.isArray(i.data.match)&&(i.data.match=i.data.match[0]);try{i.data.ill=i.v2.ill,null!=i.v2.metadata&&(i.data.meta.article=JSON.parse(JSON.stringify(i.v2.metadata))),Array.isArray(i.data.meta.article.url)&&(i.data.meta.article.url=i.data.meta.article.url[0]),null!=i.v2.url&&null==i.data.meta.article.source&&(i.data.meta.article.source="oaworks"),i.v2.url&&i.data.availability.push({type:"article",url:Array.isArray(i.v2.url)?i.v2.url[0]:i.v2.url})}catch(e){}try{0===i.data.availability.length&&(i.v2.metadata.doi||i.v2.metadata.title||i.v2.meadata.url)&&(r=i.v2.metadata.doi?'doi.exact:"'+i.v2.metadata.doi+'"':i.v2.metadata.title?'title.exact:"'+i.v2.metadata.title+'"':'url.exact:"'+(Array.isArray(i.v2.metadata.url)?i.v2.metadata.url[0]:i.v2.metadata.url)+'"')&&(null!=(I=await this.fetch("https://api.cottagelabs.com/service/oab/requests?q="+r+" AND type:article&sort=createdAt:desc"))&&null!=(v=I.hits)?v.total:void 0)&&((q={type:"article",_id:(j=I.hits.hits[0]._source)._id}).ucreated=!(!e.uid||(null!=(b=j.user)?b.id:void 0)!==e.uid),i.data.requests.push(q))}catch(e){}}return 0===i.data.availability.length&&0===i.data.requests.length&&i.data.accepts.push({type:"article"}),i},s.svc.oaworks.availability._hide=!0;o=[].indexOf;s.svc.oaworks.gates=function(){return this.refresh?(this.svc.oaworks.gates.oacheck(void 0,void 0,void 0,void 0,!0),!0):"html"===this.format?"Welcome to... Gates stuff":"OA.works Gates project API parts placeholder"},s.svc.oaworks.gates.awards=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q;null==e&&(e=null!=(_=this.params.kind)?_:"opp"),(e=e.toLowerCase()).endsWith("ids")&&(e=e.replace("ids")),null==i&&(i=this.params.total),null==t&&(t=null!=(x=this.params.q)?x:'type:"journal-article" AND funder.award:*'+(e?e.toUpperCase()+"*":"")),v=[/Melinda\sGates\sFoundation/g,/Gates\sCambridge\sTrust/g,/investment\s?id\s?\d{5}/gi,/OPPG[HD]\s?\d{4}/g,/OPP\s?1\s?\d{6}/g,/OPP\s?[45]\s?\d{4}/g,/INV\‐\d{6}/g],o="/home/cloo/static/gates/"+(e?e+"ids":"awards")+".csv",await fs.writeFile(o,'"DOI","Paper title","Journal title","ISSN","Publisher name","Published date","Published year","Funder","Crossref_OA","Matches"'),a=0,u=0,n=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+t,{params:{size:1e3,from:u}});try{console.log(n.hits.total)}catch(e){}for(;(null!=n&&null!=(q=n.hits)?q.hits:void 0)&&n.hits.hits.length&&(!i||a<i);){for(h=0,f=(k=n.hits.hits).length;h<f&&(b=k[h],!i||a!==i);h++){for(a+=1,s="",d=0,m=(O=(w=b._source).funder).length;d<m;d++)c=O[d],s.length&&(s+="\n"),s+=c.name+(c.award&&c.award.length?" ("+c.award.join(", ")+")":"");r="";try{if((l=await this.tdm.extract({content:JSON.stringify(w),matchers:v})).matched)for(S=l.matches,p=0,g=S.length;p<g;p++)y=S[p],""!==r&&(r+="\n"),r+=y.matched+": "+y.result.join(", ")}catch(e){}await fs.appendFile(o,'\n"'+w.DOI+'","'+(w.title?w.title[0].replace(/"/g,""):"")+'","'+(w["container-title"]?w["container-title"][0].replace(/"/g,""):"")+'","'+(w.ISSN?w.ISSN.join(", "):"")+'","'+(w.publisher?w.publisher.replace(/"/g,""):"")+'","'+(null!=(A=w.published)?A:"")+'","'+(null!=(j=w.year)?j:"")+'","'+s.replace(/"/g,"")+'","'+(null!=(I=w.is_oa)?I:"")+'","'+r+'"')}u+=1e3,n=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+t,{params:{size:1e3,from:u}})}return a},s.svc.oaworks.gates.oppids=function(e,t){return this.svc.oaworks.gates.awards("opp",e,t)},s.svc.oaworks.gates.invids=function(e,t){return this.svc.oaworks.gates.awards("inv",e,t)},s.svc.oaworks.gates.funders=async function(e,t,i){var s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L;null==e&&(e=null!=(w=null!=(_=this.params.funders)?_:this.params.funder)?w:"Melinda Gates Foundation"),o=(e=e.replace(/"/g,"")).toLowerCase(),null==i&&(i=this.params.total),null==t&&(t=null!=(j=this.params.q)?j:'type:"journal-article" AND (author.affiliation.name:"'+e+'" OR funder.name:"'+e+'")'),a=0,await fs.writeFile("/home/cloo/static/gates/funders.csv",'"DOI","Affiliation","Funder","Paper title","Journal Title","ISSN","Publisher name","Published date","Published year","Crossref_OA"'),u=0,n=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+t,{params:{size:1e3,from:u}});try{console.log(n.hits.total)}catch(e){}for(;(null!=n&&null!=(A=n.hits)?A.hits:void 0)&&n.hits.hits.length&&(!i||a<i);){for(c=0,f=(I=n.hits.hits).length;c<f&&(v=I[c],!i||a!==i);c++){for(a+=1,r="false",e="false",h=0,m=(C=null!=(q=(b=v._source).author)?q:[]).length;h<m;h++)for(d=0,g=(N=null!=(P=C[h].affiliation)?P:[]).length;d<g;d++)if((s=N[d]).name&&-1!==s.name.toLowerCase().indexOf(o)){r=s.name;break}for(p=0,y=(L=null!=(E=b.funder)?E:[]).length;p<y;p++)if((l=L[p]).name&&-1!==l.name.toLowerCase().indexOf(o)){e=l.name;break}await fs.appendFile("/home/cloo/static/gates/funders.csv",'\n"'+b.DOI+'","'+r.replace(/"/g,"")+'","'+e.replace(/"/g,"")+'","'+(b.title?b.title[0].replace(/"/g,""):"")+'","'+(b["container-title"]?b["container-title"][0].replace(/"/g,""):"")+'","'+(b.ISSN?b.ISSN.join(", "):"")+'","'+(null!=(x=b.publisher)?x:"")+'","'+(null!=(k=b.published)?k:"")+'","'+(null!=(O=b.year)?O:"")+'","'+(null!=(S=b.is_oa)?S:"")+'"')}u+=1e3,n=await this.fetch("https://dev.api.cottagelabs.com/use/crossref/works?q="+t,{params:{size:1e3,from:u}})}return a},s.svc.oaworks.gates.oacheck=async function(e,t,i,s,r){var a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe,fe,me,ge,ye,ve;for(null==s&&(s=this.params.total),null==r&&(r=this.params.all),r&&(await this.svc.oaworks.gates.oppids(t,s),await this.svc.oaworks.gates.invids(t,s),await this.svc.oaworks.gates.funders(i,t,s)),h=[],c={},n={},d=[],g=0,x=(W=[]).length;g<x;g++)(l=W[g].replace(/"/g,"").split(",")[0].trim()).startsWith("10.")&&-1!==l.indexOf("/")&&o.call(d,l)<0&&d.push(l);for(console.log(d.length),R="/home/cloo/static/gates/oacheck_rerererun.csv",v=0,k=(J=["/home/cloo/static/gates/oacheck_gates_dev_55.csv","/home/cloo/static/gates/oacheck_gates_dev_63.csv"]).length;v<k;v++)for(p=J[v],w=0,O=(Z=(await fs.readFile(p)).toString().split("\n")).length;w<O;w++)(ve=(ve=Z[w]).replace(/"/g,"").trim()).startsWith("10.")&&-1!==ve.indexOf("/")&&o.call(h,ve)<0&&o.call(d,ve)<0&&h.push(ve);for(console.log(h.length),_=0,S=(le=["oppids.csv","invids.csv","funders.csv"]).length;_<S;_++){for(p=le[_],P=0,A=(oe=await this.convert.csv2json((await fs.readFile("/home/cloo/static/gates/"+p)).toString())).length;P<A;P++)(f=oe[P]).DOI.startsWith("10.")?(ue=f.DOI,o.call(d,ue)<0&&(ce=f.DOI,o.call(h,ce)<0&&h.push(f.DOI),null==f.Crossref_OA||n[f.DOI]||(n[f.DOI]=f.Crossref_OA),null==f.Matches||c[f.DOI]||(c[f.DOI]=f.Matches))):console.log(f.DOI);console.log(p,h.length)}for(await fs.writeFile(R,'"DOI","in_oadoi","journal_oa_status","Crossref_OA","best_oa_location_url","best_oa_location_url_for_pdf","is_oa","oa_status","has_repository_copy","repository_license","repository_url_for_pdf","repository_url","repository_version","publisher_license","publisher_url_for_pdf","publisher_version","Paper title","Journal Title","ISSN","Publisher name","Published date","Published year","Matches"'),a=0,N=0,j=h.length;N<j&&(u=h[N],!this.params.total||a!==this.params.total);N++){if(a+=1,L=await this.src.oadoi(u)){if("hybrid"===(b="gold"===L.oa_status?"gold":"bronze"===L.oa_status?"closed":"hybrid"===L.oa_status?"hybrid":"")&&L.journal_issns)for(E=0,I=(he="string"==typeof L.journal_issns?L.journal_issns.split(","):L.journal_issns).length;E<I;E++){y=he[E];try{if(!0===(await this.fetch("https://api.journalcheckertool.org/tj/"+y)).transformative_journal){b="transformative";break}}catch(e){}}for(m=!1,fe="",ge="",me="",ye="",z="",U="",M="",T=!1,D=0,q=(pe=null!=(de=L.oa_locations)?de:[]).length;D<q;D++)"publisher"===(C=pe[D]).host_type&&(m=!0,C.license&&""===z&&(z=C.license),C.url_for_pdf&&""===U&&(U=C.url_for_pdf),C.version&&""===M&&(M=C.version)),"repository"===C.host_type&&(!C.license||""!==fe&&!1!==T||(fe=C.license),!C.url_for_pdf||""!==ge&&!1!==T||(ge=C.url_for_pdf),!C.url||""!==me&&!1!==T||(me=C.url),!C.version||""!==ye&&!1!==T||(ye=C.version),-1!==me.indexOf("pmc")&&(T=!0));m||(b="closed"),await fs.appendFile(R,'\n"'+u+'","true","'+b+'","'+(null!=(B=n[u])?B:"")+'","'+(null!=(Y=null!=(F=L.best_oa_location)?F.url:void 0)?Y:"")+'","'+(null!=(V=null!=(X=L.best_oa_location)?X.url_for_pdf:void 0)?V:"")+'","'+(null!=($=L.is_oa)?$:"")+'","'+(null!=(G=L.oa_status)?G:"")+'","'+(null!=(H=L.has_repository_copy)?H:"")+'","'+fe+'","'+ge+'","'+me+'","'+ye+'","'+z+'","'+U+'","'+M+'","'+(null!=(K=L.title)?K:"")+'","'+(null!=(Q=L.journal_name)?Q:"")+'","'+(null!=(ee=L.journal_issns)?ee:"")+'","'+(null!=(te=L.publisher)?te:"")+'","'+(null!=(ie=L.published_date)?ie:"")+'","'+(null!=(se=L.year)?se:"")+'","'+(null!=(re=c[u])?re:"")+'"')}else await fs.appendFile(R,'\n"'+u+'","false","","'+(null!=(ae=n[u])?ae:"")+'","","","","","","","","","","","","","","","","","","'+(null!=(ne=c[u])?ne:"")+'"');console.log(a)}return this.mail({to:"mark@oa.works",subject:"Gates OA check done "+a,text:"https://static.oa.works/gates"}),a},s.svc.oaworks.gates._hides=!0,s.svc.oaworks.gates.awards._bg=!0,s.svc.oaworks.gates.awards._hide=!0,s.svc.oaworks.gates.awards._async=!0,s.svc.oaworks.gates.oppids._bg=!0,s.svc.oaworks.gates.oppids._async=!0,s.svc.oaworks.gates.invids._bg=!0,s.svc.oaworks.gates.invids._async=!0,s.svc.oaworks.gates.funders._bg=!0,s.svc.oaworks.gates.funders._async=!0,s.svc.oaworks.gates.oacheck._bg=!0,s.svc.oaworks.gates.oacheck._async=!0,s.svc.oaworks.gates.recheck=async function(){var e,t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F;for(y="/home/cloo/static/gates/rerecheck.csv",await fs.writeFile(y,'"DOI","in_oadoi","journal_oa_status","Crossref_OA","best_oa_location_url","best_oa_location_url_for_pdf","is_oa","oa_status","has_repository_copy","repository_license","repository_url_for_pdf","repository_url","repository_version","publisher_license","publisher_url_for_pdf","publisher_version","Paper title","Journal Title","ISSN","Publisher name","Published date","Published year","Matches","Recheck"'),e=0,l=0,d=(O=(await fs.readFile("/home/cloo/static/gates/oacheck_rererun.csv")).toString().split('\n"10.')).length;l<d;l++)if(s="10."+(v=(i=O[l]).split('","'))[0].replace(/"/g,""),0===e)e+=1;else{if(this.params.total&&e===this.params.total+1)break;if(e+=1,F=v[1].replace(/"/g,""),a=v[2].replace(/"/g,""),k="false"===F?"notfound":"closed"===a&&"closed",console.log(e,s,F,a),k)if(t=v[3].replace(/"/g,""),r=v[v.length-1].replace(/"/g,""),g=await this.src.oadoi(s)){if("hybrid"===(c="gold"===g.oa_status?"gold":"bronze"===g.oa_status?"closed":"hybrid"===g.oa_status?"hybrid":"")&&g.journal_issns)for(u=0,p=(S="string"==typeof g.journal_issns?g.journal_issns.split(","):g.journal_issns).length;u<p;u++){o=S[u];try{if(!0===(await this.fetch("https://api.journalcheckertool.org/tj/"+o)).transformative_journal){c="transformative";break}}catch(e){}}for(n=!1,W="",B="",J="",Y="",w="",_="",x="",b=!1,h=0,f=(L=null!=(E=g.oa_locations)?E:[]).length;h<f;h++)"publisher"===(m=L[h]).host_type&&(n=!0,m.license&&""===w&&(w=m.license),m.url_for_pdf&&""===_&&(_=m.url_for_pdf),m.version&&""===x&&(x=m.version)),"repository"===m.host_type&&(!m.license||""!==W&&!1!==b||(W=m.license),!m.url_for_pdf||""!==B&&!1!==b||(B=m.url_for_pdf),!m.url||""!==J&&!1!==b||(J=m.url),!m.version||""!==Y&&!1!==b||(Y=m.version),-1!==J.indexOf("pmc")&&(b=!0));n||(c="closed"),await fs.appendFile("/home/cloo/static/gates/recheck.csv",'\n"'+s+'","true","'+c+'","'+t+'","'+(null!=(R=null!=(D=g.best_oa_location)?D.url:void 0)?R:"")+'","'+(null!=(T=null!=(z=g.best_oa_location)?z.url_for_pdf:void 0)?T:"")+'","'+(null!=(U=g.is_oa)?U:"")+'","'+(null!=(M=g.oa_status)?M:"")+'","'+(null!=(A=g.has_repository_copy)?A:"")+'","'+W+'","'+B+'","'+J+'","'+Y+'","'+w+'","'+_+'","'+x+'","'+(null!=(j=g.title)?j:"")+'","'+(null!=(I=g.journal_name)?I:"")+'","'+(null!=(q=g.journal_issns)?q:"")+'","'+(null!=(C=g.publisher)?C:"")+'","'+(null!=(P=g.published_date)?P:"")+'","'+(null!=(N=g.year)?N:"")+'","'+r+'","'+k+'"')}else await fs.appendFile(y,'\n"'+s+'","false","","'+t+'","","","","","","","","","","","","","","","","","","'+r+'","'+k+'"');else await fs.appendFile(y,'\n"10.'+i+',""')}return this.mail({to:"mark@oa.works",subject:"Gates OA recheck done "+e,text:"https://static.oa.works/gates"}),e},s.svc.oaworks.gates.recheck._bg=!0,s.svc.oaworks.gates.recheck._async=!0;o=[].indexOf;s.svc.oaworks.ill=async function(e){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x;null==e&&(e=this.copy(this.params)).ill&&(e.doi=e.ill,delete e.ill),null==e.metadata&&(e.metadata=await this.svc.oaworks.metadata(e)),!0===e.pilot&&(e.pilot=Date.now()),!0===e.live&&(e.live=Date.now()),r=e.config;try{r=JSON.parse(r)}catch(e){}for(d in("string"==typeof r||!r&&e.from)&&(null!=(r=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(m=e.from)?m:r)))&&"{}"!==JSON.stringify(r)||(r=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(g=e.from)?g:r)))),null==r&&(r={}),x={name:"librarian",details:""},p=["title","author","volume","issue","date","pages"],e)if("metadata"===d){for(h in e[d])"email"!==h&&(e[h]=e[d][h],o.call(p,h)<0&&p.push(h));delete e.metadata}else o.call(p,d)<0&&p.push(d);for(n=0,u=p.length;n<u;n++)if(e[f=p[n]]&&(x[f]=e[f],"author"===f)){for("<p>Authors:<br>",a=!0,s=[],l=0,c=(y=e[f]).length;l<c;l++)(t=y[l]).family&&(a?a=!1:", ",i=t.family+(t.given?" "+t.given:""),s.push(i));x[f]=s}return null!=e.author&&delete e.author,x.illid=e._id=await this.uid(),r.search&&r.search.length&&(e.issn||e.journal)&&(-1!==r.search.indexOf("worldcat")?(w=r.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",w+=null!=e.issn?"in%3A":"ti%3A",w+="&si0qs="+(null!=(v=e.issn)?v:e.journal),w+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(w=r.search,w+=e.issn?e.issn:e.journal),x.worldcatsearchurl=w),_=(_=await this.svc.oaworks.templates("instantill_create.html")).content,e.forwarded||e.resolved||!r.email&&!e.email||this.mail({svc:"oaworks",vars:x,template:_,to:null!=(b=r.email)?b:e.email,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+e._id}),_=_.replace(/Dear.*?\,/,"Dear Joe, here is a copy of what was just sent:"),this.waitUntil(this.mail({svc:"oaworks",vars:x,template:_,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL CREATED "+e._id,to:"mark@cottagelabs.com"})),e},s.svc.oaworks.ill._index=!0,s.svc.oaworks.ill.collect=async function(e){var t,i,s;for(t in null==e&&(e=this.copy(this.params)),i=e.collect,null==e._id&&(e._id=await this.uid()),s="https://script.google.com/macros/s/"+i+"/exec?",e)"collect"!==t&&(s+=("_id"===t?"uuid":t)+"="+e[t]+"&");return this.waitUntil(this.fetch(s)),this.waitUntil(this.svc.rscvd(e)),!0},s.svc.oaworks.ill.collect._hide=!0,s.svc.oaworks.ill.openurl=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p;for(s in null==e&&(e=null!=(u=this.params.config)?u:{}),null==t&&(t=null!=(c=this.params.meta)?c:await this.svc.oaworks.metadata()),e.ill_redirect_base_url&&null==e.ill_form&&(e.ill_form=e.ill_redirect_base_url),e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),r={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})e[s]||(e[s]=r[s]);for(n in d="",e.ill_added_params&&(d+=e.ill_added_params.replace("?","")+"&"),d+=e.sid+"=InstantILL&",t){if(p="","author"===n)for(a=0,l=(h=Array.isArray(t.author)?t.author:[t.author]).length;a<l;a++)i=h[a],p.length&&(p+=", "),p+="string"==typeof i?i:i.family?i.family+(i.given?", "+i.given:""):JSON.stringify(i);else"doi"!==n&&"pmid"!==n&&"pmc"!==n&&"pmcid"!==n&&"url"!==n&&"journal"!==n&&"title"!==n&&"year"!==n&&"issn"!==n&&"volume"!==n&&"issue"!==n&&"page"!==n&&"crossref_type"!==n&&"publisher"!==n&&"published"!==n&&"notes"!==n||(p=t[n]);p&&(d+=(e[n]?e[n]:n)+"="+encodeURIComponent(p)+"&")}return t.usermetadata&&(o=e.notes?e.notes:"notes",-1===(d=d.replace("usermetadata=true","")).indexOf(o+"=")?d+="&"+o+"=The user provided some metadata.":d=d.replace(o+"=",o+"=The user provided some metadata. ")),d.replace("/&&/g","&")},s.svc.oaworks.ill.subscription=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y;if(e||t||!this.params.sub&&!this.params.subscription||((e=this.copy(this.params)).sub&&(e.subscription=e.sub),this.params.meta?(t=this.params.meta,delete e.meta):e.doi&&2===this.keys(e).length?(console.log(e.doi),t=await this.svc.oaworks.metadata(e.doi),delete e.doi):(t=this.copy(e),delete e.doi)),null==e&&(e=null!=(l=this.params.config)?l:{}),"string"==typeof e&&(null!=(e=await this.fetch("https://api.cottagelabs.com/service/oab/ill/config?uid="+e))&&"{}"!==JSON.stringify(e)||(e=await this.fetch("https://dev.api.cottagelabs.com/service/oab/ill/config?uid="+(null!=(o=opts.from)?o:e)))),null==t&&(t=this.params.meta),c={findings:{},lookups:[],error:[],contents:[]},null!=e.subscription)for(h in e.ill_redirect_params&&null==e.ill_added_params&&(e.ill_added_params=e.ill_redirect_params),a=await this.svc.oaworks.ill.openurl(e,t),e.ill_added_params&&(a=a.replace(e.ill_added_params.replace("?",""),"")),"string"==typeof e.subscription&&(e.subscription=e.subscription.split(",")),"string"==typeof e.subscription_type&&(e.subscription_type=e.subscription_type.split(",")),null==e.subscription_type&&(e.subscription_type=[]),e.subscription)if("object"==typeof(p=e.subscription[h])?(f=p.type,p=p.url):f=null!=(u=e.subscription_type[h])?u:"unknown",p=p.trim()){"serialssolutions"===f||-1!==p.indexOf("serialssolutions")?(-1!==(g=p.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),p="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"):"sfx"!==f&&-1===p.indexOf("sfx.")||-1!==p.indexOf("sfx.response_type=simplexml")?"exlibris"!==f&&-1===p.indexOf(".exlibris")||-1!==p.indexOf("response_type")||(p=p.split("?")[0]+"?svc_dat=CTO&response_type=xml&sid=InstantILL&"):p+=(-1===p.indexOf("?")?"?":"&")+"sfx.response_type=simplexml",-1!==(y=p+(-1===p.indexOf("?")?"?":"&")+a).indexOf("snc.idm.oclc.org/login?url=")&&(y=y.split("snc.idm.oclc.org/login?url=")[1]),y=y.replace("cache=true",""),("sfx"===f||-1!==p.indexOf("sfx.")&&-1!==y.indexOf("=10."))&&(y=y.replace("=10.","=doi:10.")),("exlibris"===f||-1!==p.indexOf(".exlibris")&&-1!==y.indexOf("doi=10."))&&(y=y.replace("doi=10.","ID=doi:10.")),n="",d="",i=!1,c.lookups.push(y);try{d=-1!==(n=-1!==y.indexOf(".xml.serialssolutions")||-1!==y.indexOf("sfx.response_type=simplexml")||-1!==y.indexOf("response_type=xml")?await this.fetch(y):await this.puppet(y)).indexOf("<body")?n.toLowerCase().split("<body")[1].split("</body")[0]:n,c.contents.push(d)}catch(e){e,i=!0}if("sfx"===f||-1!==y.indexOf("sfx.")){if(i&&c.error.push("sfx"),-1!==d.indexOf("getFullTxt")&&-1!==d.indexOf("<target_url>"))try{if(c.url=d.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),c.findings.sfx=c.url,null!=c.url){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}catch(e){}else if(-1!==d.indexOf('<a title="navigate to target in new window')&&-1!==d.split('<a title="navigate to target in new window')[1].split('">')[0].indexOf("basic1")&&(c.url=y,c.findings.sfx=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="sfx",c;c.url=void 0,c.findings.sfx=void 0}}else if("eds"===f||-1!==y.indexOf("ebscohost.")){if(i&&c.error.push("eds"),-1!==d.indexOf("view this ")&&-1!==n.indexOf('<a data-auto="menu-link" href="')&&(c.url=y.replace("://","______").split("/")[0].replace("______","://")+n.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],c.findings.eds=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="eds",c;c.url=void 0}}else if("serialssolutions"===f||-1!==y.indexOf("serialssolutions.")){if(i&&c.error.push("serialssolutions"),-1!==d.indexOf('<ssopenurl:url type="article">')){if((s=d.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim().replace(/&amp;/g,"&")).length&&(c.url=s,c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}else if(-1===d.indexOf("ss_noresults"))try{if(m=y.split("?")[0]+"?ShowSupressedLinks"+n.split("?ShowSupressedLinks")[1].split('">')[0],-1!==(r=await this.puppet(m)).indexOf("ArticleCL")&&-1!==r.split("DatabaseCL")[0].indexOf('href="./log')&&(c.url=m.split("?")[0]+r.split("ArticleCL")[1].split("DatabaseCL")[0].split('href="')[1].split('">')[0].replace(/&amp;/g,"&"),c.findings.serials=c.url,null!=c.url)){if(-1===c.url.indexOf("getitnow"))return c.found="serials",c;c.url=void 0,c.findings.serials=void 0}}catch(e){i&&c.error.push("serialssolutions")}}else if(("exlibris"===f||-1!==y.indexOf(".exlibris"))&&(i&&c.error.push("exlibris"),-1!==d.indexOf("full_text_indicator")&&0===d.split("full_text_indicator")[1].replace('">',"").indexOf("true")&&-1!==d.indexOf("resolution_url")))return c.url=d.split("<resolution_url>")[1].split("</resolution_url>")[0].replace(/&amp;/g,"&"),c.findings.exlibris=c.url,c.found="exlibris",c}return c},s.svc.oaworks.journal=async function(e){var t;try{(null==e&&this.params.journal||this.params.issn)&&(e='"'+(null!=(t=this.params.journal)?t:this.params.issn)+'"')}catch(e){}try{return(await this.fetch("https://api.jct.cottagelabs.com/journal?q="+e)).hits.hits[0]._source}catch(e){}},s.svc.oaworks.journal.oa=async function(e){var t,i,s,r;try{null==e&&(e=null!=(i=null!=(s=this.params.journal)?s:this.params.issn)?i:this.params.oa)}catch(e){}return r=await this.fetch('https://dev.api.cottagelabs.com/use/crossref/works?q=type.exact:"journal-article" AND ISSN.exact:"'+e+'"'),t=await this.fetch('https://dev.api.cottagelabs.com/use/crossref/works?q=type.exact:"journal-article" AND ISSN.exact:"'+e+'" AND is_oa:true'),r.hits.total===t.hits.total&&(0!==r.hits.total||0!==t.hits.total)},s.svc.oaworks.publisher={},s.svc.oaworks.publisher.oa=async function(e){var t,i,s,r,a;try{null==e&&(e=null!=(i=this.params.publisher)?i:this.params.oa)}catch(e){}return a=await this.fetch('https://api.jct.cottagelabs.com/journal?q=publisher:"'+e.replace(/&/g,"")+'" AND NOT discontinued:true'),t=await this.fetch('https://api.jct.cottagelabs.com/journal?q=publisher:"'+e.replace(/&/g,"")+'" AND NOT discontinued:true AND indoaj:true'),null!=a&&null!=t&&(null!=(s=a.hits)?s.total:void 0)===(null!=(r=t.hits)?r.total:void 0)&&(0!==a.hits.total||0!==t.hits.total)};o=[].indexOf;s.svc.oaworks.permissions=async function(e,t,i){var s,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J,B,Y,F,V,X,$,G,H,K,Q,Z,ee,te,ie,se,re,ae,ne,le,oe,ue,ce,he,de,pe,fe,me,ge,ye,ve,be,we,_e,xe,ke,Oe,Se,Ae,je,Ie,qe,Ce,Pe;if(T=!1,h=!1,f=!1,s=async function(t){var i,s,a,n,l,o,u,c,d,p,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N;if(f&&t.embargo_months&&(e.published||e.year)&&(s=new Date(Date.parse(null!=(y=e.published)?y:e.year+"-01-01")),s=new Date(s.setMonth(s.getMonth()+t.embargo_months)),t.embargo_end=s.toISOString().split("T")[0]),""===t.embargo_end&&delete t.embargo_end,t.copyright_name="publisher"===t.copyright_owner?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:"journal"===(v=t.copyright_owner)||"affiliation"===v?null!=(O=e.journal)?O:"":f&&t.copyright_owner&&-1!==t.copyright_owner.toLowerCase().indexOf("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(S=e.author[0].name)?S:e.author[0].family)+(e.author.length>1?" et al":""):"",("publisher"===(A=t.copyright_name)||"journal"===A)&&(h||e.doi||(null!=(j=t.provenance)?j.example:void 0))&&(!1===h&&(h=await this.src.crossref.works(null!=(I=e.doi)?I:t.provenance.example)),null!=(null!=h?h.assertion:void 0)&&h.assertion.length))for(l=0,u=(q=h.assertion).length;l<u;l++)if("copyright"===(i=q[l]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(f&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,f&&null!=t.deposit_statement&&-1!==t.deposit_statement.indexOf("<<")){for(n="",o=0,c=(C=t.deposit_statement.split("<<")).length;o<c;o++)if(g=C[o],""===n&&-1===g.indexOf(">>"))n+=g;else{if(null!=(N={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[m=(a=g.split(">>"))[0].toLowerCase()]&&(m=N[m]),"author"===m)try{n+=(null!=(P=e.author[0].name)?P:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else n+=null!=(b=null!=(w=e[m])?w:t[m])?b:"";try{n+=a[1]}catch(e){}}t.deposit_statement=n}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(r.dev?"dev.api.cottagelabs.com/svc/oaworks/permissions/":"api.openaccessbutton.org/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(_=t.issuer)?_.has_policy:void 0)||"not publisher"!==(x=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==x||(T=t.issuer.has_policy),p=0,d=(k=["_id","permission_required","createdAt","updatedAt","created_date","updated_date"]).length;p<d;p++)delete t[k[p]];try{delete t.issuer.updatedAt}catch(e){}return t},n=e=>{var t,i,s,r,a,n,l;return l=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(l+=1e3),null!=e.requirements?l-=10:l+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,null!=e.licences&&e.licences.length&&(l-=5),l+="journal"===(null!=(i=e.issuer)?i.type:void 0)?5:"publisher"===(null!=(s=e.issuer)?s.type:void 0)?4:"university"===(null!=(r=e.issuer)?r.type:void 0)?3:(a=null!=(n=e.issuer)?n.type:void 0,o.call("article",a)>=0?2:0),e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||Date.parse(e.embargo_end)<Date.now())&&(l-=25),l},"string"==typeof e&&(e=0===e.indexOf("10.")?{doi:e}:{issn:e}),null==e&&(e=this.copy(this.params)),!0===(null!=e?e.metadata:void 0)&&delete e.metadata,null!=(null!=e?e.permissions:void 0)&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):0===e.permissions.indexOf("10.")&&-1!==e.permissions.indexOf("/")?e.doi=e.permissions:-1!==e.permissions.indexOf("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:-1===e.permissions.indexOf(" ")&&-1===e.permissions.indexOf(",")&&e.permissions.replace(/[0-9]/g,"").length!==e.permissions.length?e.ror=e.permissions:e.publisher=e.permissions,delete e.permissions),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),null==e.ror&&(e.ror=t),"string"==typeof e.ror&&-1!==e.ror.indexOf(",")&&(e.ror=e.ror.split(",")),e.journal&&-1===e.journal.indexOf(" ")&&-1!==e.journal.indexOf("-")&&(e.issn=e.journal,delete e.journal),y=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&-1!==e.issn.indexOf(",")&&(e.issn=e.issn.split(",")),"{}"===JSON.stringify(e)||e.issn&&-1===JSON.stringify(e.issn).indexOf("-")||e.doi&&("string"!=typeof e.doi||0!==e.doi.indexOf("10.")||-1===e.doi.indexOf("/")))return{body:"No valid DOI, ISSN, or ROR provided",status:404};if(a=async()=>{var t,i,s,r;if(i=this.copy(e),"{}"!==JSON.stringify(i)){for(t in s=[],r=await this.svc.oaworks.metadata(e.doi))s.push(null!=e[t]?e[t]:e[t]=r[t]);return s}},!1===i||!e.doi||e.publisher&&e.issn||await a(),!e.published&&e.year&&(e.published=e.year+"-01-01"),f=null!=e.doi,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!y.length)for(m=0,_=(V=e.issn).length;m<_;m++)g=V[m],o.call(y,g)<0&&y.push(g);y.length&&e.publisher&&e.doi||(l=await this.svc.oaworks.journal('issn.exact:"'+y.join('" OR issn.exact:"')+'"'))&&null==e.doi&&(e.doi=l.doi);try{null==e.doi&&(e.doi=await this.src.crossref.journals.doi(y))}catch(e){}if(!f&&e.doi){await a();try{if(null==e.publisher&&(e.publisher=null!=l?l.publisher:void 0),null!=l?l.issn:void 0)for(X="string"==typeof l.issn?[l.issn]:l.issn,v=0,x=X.length;v<x;v++)c=X[v],o.call(y,c)<0&&y.push(c)}catch(e){}}}if(f&&"journal-article"!==e.type)return{body:"DOI is not a journal article",status:501};e.publisher&&-1!==e.publisher.indexOf("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(pe=e.page)?pe:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(fe=e.year)?fe:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(M={best_permission:void 0,all_permissions:[]},_e=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(Oe=await this.svc.oaworks.permissions.affiliations('issuer.id:"'+e.ror.join('" OR issuer.id:"')+'"'))&&null!=(me=Oe.hits)?me.total:void 0))try{(null!=(ge=(Se=await this.src.ror(1===e.ror.length?e.ror[0]:'id:"'+e.ror.join(" OR id:")+'"')).hits)?ge.total:void 0)&&(Se=Se.hits.hits[0]._source),Se.country.country_code&&(Oe=await this.svc.oaworks.permissions.affiliations('issuer.id:"'+Se.country.country_code+'"'))}catch(e){}for(E=0,k=(be=null!=(ye=null!=Oe&&null!=(ve=Oe.hits)?ve.hits:void 0)?ye:[]).length;E<k;E++)ke=be[E],(je=await s(ke._source)).score=await n(je),_e.push(je)}if(y.length)for(Y=y.length?'issuer.id:"'+y.join('" OR issuer.id:"')+'"':"",L=0,O=(H=null!=($=null!=(J=await this.svc.oaworks.permissions.journals(Y))&&null!=(G=J.hits)?G.hits:void 0)?$:[]).length;L<O;L++)z=H[L],(xe=await s(z._source)).score=await n(xe),M.all_permissions.push(xe);if(e.publisher)for(Y='issuer.id:"'+e.publisher+'"',R=0,S=(Z=null!=(K=null!=(J=await this.svc.oaworks.permissions.publishers(Y))&&null!=(Q=J.hits)?Q.hits:void 0)?K:[]).length;R<S;R++)z=Z[R],(xe=await s(z._source)).score=await n(xe),M.all_permissions.push(xe);if(e.publisher&&(null==(l=await this.svc.oaworks.journal('publisher:"'+e.publisher+'"'))&&((null!=(p=await this.svc.oaworks.journal('publisher:"'+e.publisher.split(" ").join('" AND publisher:"')+'"'))?p.publisher:void 0)===e.publisher?l=p:(null!=p?p.publisher:void 0)&&(P=(N=await this.tdm.levenshtein(p.publisher,e.publisher)).length.a>N.length.b?N.length.a:N.length.b,(N.distance<5||P/N.distance>10)&&(l=p))),(null!=l?l.publisher:void 0)&&(W=await this.svc.oaworks.publisher.oa(l.publisher))),"object"==typeof l&&(l.indoaj||W)){u={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,licence_terms:"",licences:[],locations:["institutional repository"],embargo_months:void 0,issuer:{type:"journal",has_policy:"yes",id:l.issn},meta:{creator:["joe+doaj@openaccessbutton.org"],contributors:["joe+doaj@openaccessbutton.org"],monitoring:"Automatic"}};try{u.licence=null!=(ee=l.doaj.bibjson.license[0].type)?ee:l.license[0].type}catch(e){}l.indoaj?(u.embargo_months=0,u.provenance={oa_evidence:"In DOAJ"}):W&&(u.meta.creator=["joe+oapublisher@openaccessbutton.org"],u.meta.contributors=["joe+oapublisher@openaccessbutton.org"],u.provenance={oa_evidence:"OA publisher"}),"string"==typeof u.licence?(u.licence=u.licence.toLowerCase().trim(),0===u.licence.indexOf("cc")?u.licence=u.licence.replace(/ /g,"-"):-1!==u.licence.indexOf("creative")?u.licence=-1!==u.licence.indexOf("0")||-1!==u.licence.indexOf("zero")?"cc0":-1!==u.licence.indexOf("share")?"ccbysa":-1!==u.licence.indexOf("derivative")?"ccbynd":"ccby":delete u.licence):delete u.licence,u.licence&&(u.licences=[{type:u.licence,terms:""}]),u.score=await n(u),M.all_permissions.push(u)}if(e.doi&&(D=await this.src.oadoi(e.doi))&&f&&(null!=D&&null!=(te=D.best_oa_location)?te.license:void 0)&&-1!==D.best_oa_location.license.indexOf("cc")&&("string"==typeof(d={can_archive:!0,version:D.best_oa_location.version,versions:[],licence:D.best_oa_location.license,licence_terms:"",licences:[],locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:["support@unpaywall.org"],contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:D.best_oa_location.updated},provenance:{oa_evidence:D.best_oa_location.evidence}}).licence&&(d.licences=[{type:d.licence,terms:""}]),d.version&&(d.versions="submittedVersion"===(ie=d.version)||"preprint"===ie?["submittedVersion"]:"acceptedVersion"===(se=d.version)||"postprint"===se?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),d.score=await n(d),M.all_permissions.push(d)),M.all_permissions.length){for(M.all_permissions.sort((e,t)=>e.score<t.score?1:-1),B=0,A=(re=M.all_permissions).length;B<A;B++){if(!(null!=(ae=(Pe=re[B]).provenance)?ae.enforcement_from:void 0)){M.best_permission=this.copy(Pe);break}if(!e.published||Date.parse(e.published)>Date.parse(Pe.provenance.enforcement_from.split("/").reverse().join("-"))){M.best_permission=this.copy(Pe);break}}if(_e.length)for(_e.sort((e,t)=>e.score<t.score?1:-1),F=0,j=_e.length;F<j;F++)if(we=_e[F],M.all_permissions.push(we),null==(null!=(ne=M.best_permission)?ne.author_affiliation_requirement:void 0)&&null!=M.best_permission&&(!(null!=(le=we.provenance)?le.enforcement_from:void 0)||!e.published||Date.parse(e.published)>Date.parse(we.provenance.enforcement_from.split("/").reverse().join("-")))){for(U=this.copy(M.best_permission),Ae=0,I=(oe=["licences","versions","locations"]).length;Ae<I;Ae++)for(Ie=0,q=(ue=we[b=oe[Ae]]).length;Ie<q;Ie++)Ce=ue[Ie],null==U[b]&&(U[b]=[]),o.call(U[b],Ce)<0&&U[b].push(Ce);for(qe=0,C=(he=null!=(ce=U.licences)?ce:[]).length;qe<C;qe++)w=he[qe],(null==U.licence||w.type.length<U.licence.length)&&(U.licence=w.type);U.version=o.call(U.versions,"publishedVersion")>=0||o.call(U.versions,"publisher pdf")>=0?"publishedVersion":o.call(U.versions,"acceptedVersion")>=0||o.call(U.versions,"postprint")>=0?"acceptedVersion":"submittedVersion",U.embargo_end&&we.embargo_end&&Date.parse(we.embargo_end)<Date.parse(U.embargo_end)&&(U.embargo_end=we.embargo_end),U.embargo_months&&null!=we.embargo_months&&we.embargo_months<U.embargo_months&&(U.embargo_months=we.embargo_months),!0===we.can_archive&&(U.can_archive=!0),null==U.requirements&&(U.requirements={}),U.requirements.author_affiliation_requirement=null==e.ror?we.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],U.issuer.affiliation=we.issuer,null==U.meta&&(U.meta={}),U.meta.affiliation=we.meta,null==U.provenance&&(U.provenance={}),U.provenance.affiliation=we.provenance,U.score=parseInt(U.score)+parseInt(we.score),M.best_permission=U,M.all_permissions.push(U)}}return T?{body:"string"!=typeof T?T:null!=(de={"not publisher":"Please find another DOI for this article as this is provided as this doesn’t allow us to find required information like who published it"}[T.toLowerCase()])?de:T,status:501}:(!0!==this.params.metadata&&!0!==i||(M.metadata=e),M)},s.svc.oaworks.permissions.journals=function(e){return this.svc.oaworks.permissions._format(e)},s.svc.oaworks.permissions.journals._sheet="19pDvOY5pge-C0yDSObnkMqqlMJgct3iIjPI2rMPLQEc",s.svc.oaworks.permissions.journals._prefix=!1,s.svc.oaworks.permissions.publishers=function(e){return this.svc.oaworks.permissions._format(e)},s.svc.oaworks.permissions.publishers._sheet="1tmEfeJ6RCTCQjcCht-FI7FH-04z7MPSKdUnm0UpAxWM",s.svc.oaworks.permissions.publishers._prefix=!1,s.svc.oaworks.permissions.affiliations=function(e){return this.svc.oaworks.permissions._format(e)},s.svc.oaworks.permissions.affiliations._sheet="1J4WhZjPsAjpoogsj7wSTQGJPguo7TiSe0uNcrvyd_OM",s.svc.oaworks.permissions.affiliations._prefix=!1,s.svc.oaworks.permissions._format=async function(e=[]){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N,E,L,R,D,T,z,U,M,W,J;for("object"!=typeof e||Array.isArray(e)||(e=[e]),u={versionsarchivable:"versions",permissionsrequestcontactemail:"permissions_contact",archivinglocationsallowed:"locations",license:"licence",licencesallowed:"licences","post-printembargo":"embargo_months",depositstatementrequired:"deposit_statement",copyrightowner:"copyright_owner",publicnotes:"notes",authoraffiliationrolerequirement:"requirements.role",authoraffiliationrequirement:"requirements.affiliation",authoraffiliationdepartmentrequirement:"requirements.departmental_affiliation",iffundedby:"requirements.funder",fundingproportionrequired:"requirements.funding_proportion",subjectcoverage:"requirements.subject",has_policy:"issuer.has_policy",permissiontype:"issuer.type",parentpolicy:"issuer.parent_policy",contributedby:"meta.contributors",recordlastupdated:"meta.updated",reviewers:"meta.reviewer",addedby:"meta.creator",monitoringtype:"meta.monitoring",policyfulltext:"provenance.archiving_policy",policylandingpage:"provenance.archiving_policy_splash",publishingagreement:"provenance.sample_publishing_agreement",publishingagreementsplash:"provenance.sample_publishing_splash",rights:"provenance.author_rights",embargolist:"provenance.embargo_list",policyfaq:"provenance.faq",miscsource:"provenance.misc_source",enforcementdate:"provenance.enforcement_from",example:"provenance.example"},P=[],a=0,p=e.length;a<p;a++){N=e[a],A={can_archive:!1,version:void 0,versions:void 0,licence:void 0,licence_terms:void 0,licences:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,permission_required:void 0,permissions_contact:void 0,copyright_owner:void 0,copyright_name:void 0,copyright_year:void 0,notes:void 0,requirements:void 0,issuer:{},meta:{},provenance:void 0};try{if(N.recordlastupdated=N.recordlastupdated.trim(),-1!==N.recordlastupdated.indexOf(",")){for(x=!1,E=N.recordlastupdated.split(","),n=0,f=E.length;n<f;n++)r=E[n],(!1===x||Date.parse(r.trim().split("/").reverse().join("-"))>Date.parse(x.split("/").reverse().join("-")))&&(x=r.trim());!1!==x&&(N.recordlastupdated=x)}A.meta.updated=N.recordlastupdated}catch(e){}if(null!=A.meta.updated&&(A.meta.updatedAt=Date.parse(A.meta.updated.split("/").reverse().join("-"))),A.issuer.id="string"==typeof N.id&&-1!==N.id.indexOf(",")?N.id.split(","):N.id,null!=A.issuer.id)if("string"!=typeof A.issuer.id){for(s=[],b=0,m=(L=A.issuer.id).length;b<m;b++){if(k=(k=L[b]).trim(),"journal"===A.issuer.type&&-1!==k.indexOf("-")&&-1===k.indexOf(" ")&&(k=k.toUpperCase(),t=await this.svc.oaworks.journal('issn.exact:"'+k+'"')))for(w=0,g=(R=t.issn).length;w<g;w++)i=R[w],o.call(s,i)<0&&s.push(i);o.call(s,k)<0&&s.push(k)}A.issuer.id=s}else A.issuer.id.startsWith("10.")&&-1!==A.issuer.id.indexOf("/")&&-1===A.issuer.id.indexOf(" ")&&(A.DOI=A.issuer.id);for(l in A.permission_required="string"==typeof N.has_policy&&-1!==N.has_policy.toLowerCase().indexOf("permission required"),N)if(u[l]&&null!=N[l]&&0!==N[l].length){if(O=u[l],j=void 0,"post-printembargo"===l)try{"number"!=typeof(c=parseInt(N[l].trim()))||isNaN(c&&0!==c)||(j=c),null!=j&&(A.embargo_end="")}catch(e){}else if("journal"===l||"versionsarchivable"===l||"archivinglocationsallowed"===l||"licencesallowed"===l||"policyfulltext"===l||"contributedby"===l||"addedby"===l||"reviewers"===l||"iffundedby"===l)for(j=[],I=0,y=(D=C=N[l].trim().split(",")).length;I<y;I++)if(J=(W=D[I]).trim(),"licencesallowed"===l){if("unclear"!==J.toLowerCase()){d={type:J.toLowerCase()};try{d.terms=N.licenceterms.split(",")[C.indexOf(W)].trim()}catch(e){}j.push(d)}}else"versionsarchivable"===l&&("preprint"===(J=J.toLowerCase())&&(J="submittedVersion"),"postprint"===J&&(J="acceptedVersion"),"publisher pdf"===J&&(J="publishedVersion")),J.length&&o.call(j,J)<0&&j.push("archivinglocationsallowed"===l?J.toLowerCase():J);else"recordlastupdated"!==l&&(j=N[l].trim());"string"!=typeof j||"yes"!==(T=j.toLowerCase())&&"no"!==T&&"haspolicy"!==l&&"permissiontype"!==l&&"copyrightowner"!==l||(j=j.toLowerCase()),"copyrightowner"!==l&&"license"!==l||"unclear"!==j||(j=""),null!=j&&(-1!==O.indexOf(".")?(null==A[_=(S=O.split("."))[0]]&&(A[_]={}),A[S[0]][[S[1]]]=j):A[O]=j)}if(null==A.licences&&(A.licences=[]),!A.licence)for(q=0,v=(z=A.licences).length;q<v;q++)h=z[q],(null==A.licence||h.type.length<A.licence.length)&&(A.licence=h.type,A.licence_terms=h.terms);null==A.versions&&(A.versions=[]),A.versions.length&&(A.can_archive=!0,A.version=o.call(A.versions,"acceptedVersion")>=0||o.call(A.versions,"postprint")>=0?"acceptedVersion":o.call(A.versions,"publishedVersion")>=0||o.call(A.versions,"publisher pdf")>=0?"publishedVersion":"submittedVersion"),null==A.copyright_owner&&(A.copyright_owner=null!=(U=null!=(M=A.issuer)?M.type:void 0)?U:""),null==A.copyright_name&&(A.copyright_name=""),null==A.copyright_year&&(A.copyright_year=""),"{}"!==!JSON.stringify(A)&&P.push(A)}return 1===P.length?P[0]:P};o=[].indexOf;s.svc.oaworks.report=async function(e){var t,i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C;if(null==e&&(e=null!=(w=this.params.report)?w:this.params.ror),"string"==typeof e&&(e=await this.src.ror(e)),e){if((r=await this.svc.oaworks.report.filter(e))+(r?" AND ":"")+"is_oa:true",q='<body> <div class="flex" style="margin-top: 5%;"><div class="c1 off1 green"><h1 class="centre">'+await this.svc.oaworks.report.rating(e)+'%</h1></div><div class="c8">'+("0456r8d26"===e._id?'<div class="centre"><img src="https://www.gatesfoundation.org/-/media/logos/logolg.svg"></div>':"")+'<h1 id="title" class="centre statement" style="font-size:40px;">'+("0456r8d26"===e._id?'<a target="_blank" href="https://www.gatesfoundation.org/about/policies-and-resources/open-access-policy">':"")+e.name+("0456r8d26"===e._id?"</a>":"")+'</h1> </div></div> <div class="flex" style="margin-top: 5%;"><div class="c5 off1">',y=await this.src.crossref.works.count(void 0,r)){for await(b of(q+=y+" papers",q+="<br><br>",this.index._for("src_crossref_works",r,{sort:{published:"desc"},until:100}))){for(b.is_oa||(q+='<div class="bordered-warning">'),q+='<a target="_blank" href="https://doi.org/'+b.DOI+'">'+b.title[0]+"</a><br>",q+=b["container-title"][0]+", "+b.published.split("-").reverse().join("/")+". "+b.publisher+"<br>",n=!1,l=0,c=(x=null!=(_=b.funder)?_:[]).length;l<c;l++)if((s=x[l]).award&&"0456r8d26"===e._id)for(o=0,h=(k="string"==typeof s.award?[s.award]:s.award).length;o<h;o++)((a=k[o]).includes("OPP")||a.includes("INV"))&&(n=!0,q+="Grant ID "+a+". ");for(n||"0456r8d26"!==e._id||((C=JSON.stringify(b)).includes("OPP")&&(q+="Grant ID OPP"+C.replace("OPP ","OPP").split("OPP")[1].split(" ")[0]+". "),C.includes("INV")&&(q+="Grant ID INV"+C.replace("INV ","INV").split("INV")[1].split(" ")[0]+". ")),u=0,d=(S=null!=(O=b.author)?O:[]).length;u<d;u++)for(m=0,p=(j=null!=(A=(t=S[u]).affiliation)?A:[]).length;m<p;m++)(i=j[m]).name.toLowerCase().includes("gates")&&(q+="Author "+t.given+" "+t.family+" affiliated with "+i.name+". ");b.is_oa||(q+="</div>"),q+="<br><br>"}q+="<p>TODO add autoscroll to load more</p>"}else q+="No papers yet";for(q+='</div><div class="c5 off1">Publishers<br><br>',g=0,f=(I=await this.svc.oaworks.report.publishers(r)).length;g<f;g++)q+="<p>"+(v=I[g]).name+"<br>"+v.percent+"% of "+v.papers+" papers open"+(v.percent>=50?"!":"")+"</p>";q+="</div>",q+="</div></div> <script> <\/script> </body>"}else q='<script type="text/javascript" src="/client/pradmSuggest.min.js?v='+this.S.version+'"><\/script> <body> <div class="flex" style="margin-top: 5%;"><div class="c6 off3"> <h1 id="title" class="centre statement" style="font-size:40px;">Welcome to OA.Report</h1> </div></div> <div class="flex" style="margin-top: 5%;"> <div class="c6 off3"> <div id="funders"> <p>Great tool does great things.</p> <p>Funders! (or organisations) Find out if your recipients are meeting your policy expectations, take action if not:</p> <p><input type="text" class="PSuggest PForOrganisation" placeholder="Find an organisation" url="/src/ror/suggest/name/"></p> <div class="PSuggestions PForOrganisation"></div> </div> <div id="publishers"> <p> Publishers! How accessible are they?<br> <a href="/report/publishers.html">View the rankings</a> or pick one: </p> <p><input type="text" class="PSuggest PForPublisher" placeholder="Find a publisher" url="/src/crossref/works/suggest/publisher/"></p> <div class="PSuggestions PForPublisher"></div> </div> <div id="journals"> <p> Journals! How open are they? Do they meet your funder policy expectations? <a href="/report/journals.html">View the rankings</a> or pick one: </p> <p><input type="text" class="PSuggest PForJournal" placeholder="Find a journal" url="/src/crossref/works/suggest/container-title/"></p> <div class="PSuggestions PForJournal"></div> </div> <p>Authors! We will help you meet funder policy expectations (which improves future funding applications...):</p> <p><input id="author" type="text" placeholder="Tell us your name"></p> <div class="PSuggestions PForAuthor"></div> </div> </div> <script> P.suggest({include: ["_id"], suggestion: function(e, val, rec) { window.location = window.location.href + "/" + rec._id; }}, "#funders"); P.suggest({suggestion: function(e, val) { window.location = window.location.href + "/publishers/" + val; }}, "#publishers"); P.suggest({suggestion: function(e, val) { window.location = window.location.href + "/journals/" + val; }}, "#journals"); P.on("enter", "#author", function(e) { window.location = window.location.href + "/author/" + P.val(e.target); }); <\/script> </body>';return this.format="html",q},s.svc.oaworks.report._hides=!0,s.svc.oaworks.report.filter=async function(e){var t,i;return null==e&&(e=null!=(t=null!=(i=this.params.report)?i:this.params.filter)?t:this.params.ror),"string"==typeof e&&(e=await this.src.ror(e)),"0456r8d26"===(null!=e?e._id:void 0)?'type:"journal-article" AND (funder.award:*OPP* OR funder.award:*INV* OR "melinda gates foundation" OR "gates cambridge trust" OR "'+e._id+'")':'type:"journal-article"'+(e?' AND ("'+e.name+'" OR "'+e._id+'")':"")},s.svc.oaworks.report.rating=async function(e){var t,i,s,r,a,n,l;if(null==e&&(e=null!=(n=null!=(l=this.params.report)?l:this.params.rating)?n:this.params.ror),e)try{return i=(t=await this.svc.oaworks.report.filter(e))+(t?" AND ":"")+"is_oa:true",console.log(i),r=await this.src.crossref.works.count(void 0,t),s=await this.src.crossref.works.count(void 0,i),console.log(r,s),(a=Math.ceil(s/r*1e3)/10)>100?100:a}catch(e){return 0}},s.svc.oaworks.report.publishers=async function(e){var t,i,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v;if(e||!(f=s.svc.oaworks.report._publishers)){for(m={},i=0,n=(g=await this.src.crossref.works.terms("publisher",e,200)).length;i<n;i++)m[(p=g[i]).term]={papers:p.count};for(null==e&&(e=""),e.includes(" OR ")&&!e.includes(")")&&(e="("+e+")"),t=(e?e+" AND ":"")+"is_oa:true",r=0,l=(y=await this.src.crossref.works.terms("publisher",t,200)).length;r<l;r++)null==m[u=(c=y[r]).term]&&(m[u]={}),m[c.term].open=c.count;for(h in f=[],m)m[h].name=h,null!=m[h].open&&null==m[h].papers&&(m[h].papers=await this.src.crossref.works.count(void 0,e+(e?" AND ":"")+' publisher.keyword:"'+h+'"')),m[h].papers&&null==m[h].open&&(m[h].open=await this.src.crossref.works.count(void 0,t+' AND publisher.keyword:"'+h+'"')),m[h].rating=m[h].open&&m[h].papers?m[h].open/m[h].papers:0,m[h].percent=Math.ceil(1e3*m[h].rating)/10,m[h].percent>100&&(m[h].percent=100),m[h].papers&&m[h].rating&&f.push(m[h]);f.sort((e,t)=>t.rating-e.rating||t.open-e.open),s.svc.oaworks.report._publishers=f}if("svc.oaworks.report.publishers"!==this.fn)return f;for(this.format="html",v='<body> <div class="flex" style="margin-top: 5%;"><div class="c6 off3"> <h1 id="title" class="centre statement" style="font-size:40px;">Publisher ranking :)</h1> </div></div> <div class="flex" style="margin-top: 5%;"> <div class="c6 off3">',a=0,o=f.length;a<o;a++)v+="<p>"+(d=f[a]).name+" "+d.percent+"% of "+d.papers+" papers open"+(d.percent>=50?"!":"")+"</p>";return v+="</div> </div> </body>"},s.svc.oaworks.report.journals=async function(){var e,t,i,r,a,n,l,o,u,c,h,d,p,f,m,g;if(this.params.journals)return g='<body> <div class="flex" style="margin-top: 5%;"><div class="c6 off3"> <h1 id="title" class="centre statement" style="font-size:40px;">'+this.params.journals+'</h1> </div></div> <div class="flex" style="margin-top: 5%;"> <div class="c6 off3"> <br><br>Info like journal is in or not in DOAJ, journal has XX % OA articles <br><br>Allow to filter a particular funder, see how many of their articles are OA <br><br>And/or user provides their institutional affiliation to see if this journal is in an agreement with them / their country... </div> </div> </body>',this.format="html",g;if(!(a=s.svc.oaworks.report._journals)){for(n={},e=0,u=(f=await this.src.crossref.works.terms("container-title",void 0,200)).length;e<u;e++)n[(r=f[e]).term]={papers:r.count};for(l=0,c=(m=await this.src.crossref.works.terms("container-title","is_oa:true",200)).length;l<c;l++)null==n[d=(p=m[l]).term]&&(n[d]={}),n[p.term].open=p.count;for(t in a=[],n)n[t].name=t,null!=n[t].open&&null==n[t].papers&&(n[t].papers=await this.src.crossref.works.count(void 0,'container-title.keyword:"'+t+'"')),n[t].papers&&null==n[t].open&&(n[t].open=await this.src.crossref.works.count(void 0,'is_oa:true AND container-title.keyword:"'+t+'"')),n[t].rating=n[t].open&&n[t].papers?n[t].open/n[t].papers:0,n[t].percent=Math.ceil(1e3*n[t].rating)/10,n[t].percent>100&&(n[t].percent=100),n[t].papers&&n[t].rating&&a.push(n[t]);a.sort((e,t)=>t.rating-e.rating||t.open-e.open),s.svc.oaworks.report._journals=a}if("svc.oaworks.report.journals"!==this.fn)return a;for(g='<body> <div class="flex" style="margin-top: 5%;"><div class="c6 off3"> <h1 id="title" class="centre statement" style="font-size:40px;">Journal ranking :)</h1> </div></div> <div class="flex" style="margin-top: 5%;"> <div class="c6 off3">',o=0,h=a.length;o<h;o++)g+="<p>"+(i=a[o]).name+" "+i.percent+"% of "+i.papers+" papers open"+(i.percent>=50?"!":"")+"</p>";return g+="</div> </div> </body>",this.format="html",g},s.svc.oaworks.report.author=async function(e){var t,i,s,r,a,n,l,u,c,h,d,p,f,m,g,y;if(null==e&&(e=this.params.author),y='<body> <div class="flex" style="margin-top: 5%;"><div class="c6 off3"> <h1 id="title" class="centre statement" style="font-size:40px;">'+(null!=e?e:"")+'</h1> </div></div> <div class="flex" style="margin-top: 5%;"> <div class="c6 off3"> <p>Show list of possible names to disambiguate. Ask for ORCID or additional info to identify. (Prod to get an ORCID if not got one.)</p>',e){for(n=[],c="",i=0,r=(u=e.toLowerCase().split(" ")).length;i<r;i++)c&&(c+=" OR "),c+="author.family:"+(l=u[i])+" OR author.given:"+l;for await(h of this.index._for("src_crossref_works",c,{until:20}))for(s=0,a=(p=null!=(d=h.author)?d:[]).length;s<a;s++)(t=p[s]).family&&t.given&&(f=t.family.toLowerCase(),o.call(u,f)>=0||(m=t.given.toLowerCase(),o.call(u,m)>=0))&&(g=t.given+" "+t.family,o.call(n,g)<0)&&(n.push(t.given+" "+t.family),y+="<p>"+t.given+" "+t.family+"</p>")}return y+='<p>Ask for an email address for this author</p> <p>Provide estimate count of papers we think are by this author, how many are open, which funders funded, and estimate of how compliant to funder policies this author is.</p> <p>Allow to filter to a specific funder</p> <p>List papers that appear to be by this author, provide a checkbox to confirm</p> <p>Ask author/person to "share the paper" if not already OA, (and prompt which funders, if any, require this to be done hence improving author compliance score).</p> </div> </div> </body>',this.format="html",y},s.svc.oaworks.scrape=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C;if(null==e&&(e=null!=(O=null!=(S=this.params.scrape)?S:this.params.content)?O:this.params.url),null==t&&(t=this.params.doi),f={doi:t},"string"==typeof e&&e.startsWith("http")&&(f.doi||(C=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&C.length>1&&9<C[1].length&&C[1].length<45&&-1!==C[1].indexOf("/")&&0===C[1].indexOf("10.")&&(f.doi=C[1]),e=await this.puppet(e)),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!f.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(f.doi=i))}catch(e){}if(!f.doi)for(s=0,a=0,o=(A=e.split(" ")).length;a<o;a++)if(q=A[a],(s+=1)<600&&(-1!==(q=q.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(q=q.split("doi.org")[1]),0===q.indexOf("/")&&(q=q.replace("/","")),0===(q=q.trim()).indexOf("10.")&&-1!==q.indexOf("/"))){f.doi=q;break}if(!f.doi)try{for(j=(r=await this.tdm.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,l=0,u=j.length;l<u;l++)w=j[l],!f.doi&&9<r.matches[w].result[1].length&&r.matches[w].result[1].length<45&&(f.doi=r.matches[w].result[1],f.doi.endsWith(".")&&(f.doi=f.doi.substring(0,f.doi.length-1)))}catch(e){}if(f.doi&&(f.doi=f.doi.split(" ")[0]),f.title||(-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?f.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?f.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?f.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(f.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),f.title.startsWith("'")&&(f.title=f.title.substring(1,f.title.length-1))):-1!==i.indexOf('"citation_title" ')?f.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(f.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))),f.title&&-1!==f.title.indexOf("|")&&(f.title=f.title.split("|")[0].trim()),!f.year)try{if(1===(m=(await this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1].split("-")).length)f.year=m[0];else for(_=0,c=m.length;_<c;_++)(b=m[_]).length>2&&(f.year=b)}catch(e){}if(!f.keywords)try{-1!==(n=(await this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"})).matches[0].result[1]).indexOf(";")?(n=n.replace(/; /g,";").replace(/ ;/g,";"),f.keywords=n.split(";")):(n=n.replace(/, /g,",").replace(/ ,/g,","),f.keywords=n.split(","))}catch(e){}if(!f.email){g=[];try{for(I=(await this.tdm.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]})).matches,x=0,h=I.length;x<h;x++)(y=I[x].result[1].replace("mailto:","")).endsWith(".")&&(y=y.substring(0,y.length-1)),-1===g.indexOf(y)&&g.push(y)}catch(e){}for(g.sort((function(e,t){return t.length-e.length})),v="",k=0,d=g.length;k<d;k++)p=g[k],null==f.email&&(f.email=[]),-1===v.indexOf(p)&&f.email.push(p),v+=p}return f},s.svc.oaworks.scrape._hide=!0;o=[].indexOf;s.svc.rscvd={_index:!0},s.svc.rscvd.form=async function(){var e,t,i,s,r,a,n,l;if(this.keys(this.params).length>1){delete(t=this.copy(this.params)).form,t.status="Awaiting verification";try{(n=await this.svc.rscvd.requestees('email:"'+t.email+'"'))&&((null!=n?n.verified:void 0)||"Approved"===(null!=n?n.verification:void 0)?(t.status="Verified",t.verified=!0):((null!=n?n.denied:void 0)||"Denied"===(null!=n?n.verification:void 0))&&(t.status="Denied",t.verified=!1))}catch(e){}if("Awaiting verification"===t.status)try{(null!=(e=await this.svc.rscvd('email:"'+t.email+'" AND verified:*'))&&null!=(i=e.hits)?i.hits:void 0)&&!0===e.hits.hits[0]._source.verified?(t.status="Verified",t.verified=!0):!1===e.hits.hits[0]._source.verified&&(t.status="Denied",t.verified=!1)}catch(e){}null==t.type&&(t.type="paper");try{t.createdAt=new Date}catch(e){}try{t.neededAt=await this.epoch(t["needed-by"])}catch(e){}t._id=await this.svc.rscvd(t);try{l="Hi "+t.name+",<br><br>We got your request:<br><br>Title: "+(null!=(s=null!=(r=t.atitle)?r:t.title)?s:"Unknown")+"\nReference (if provided): "+(null!=(a=t.reference)?a:"")+"<br><br>",l+='If at any point you no longer need this item, please <a href="https://'+(this.S.dev?"dev.":"")+"rscvd.org/cancel?id="+t._id+'">cancel your request</a>, it only takes a second.<br><br>',l+='Our team of volunteers will try and fill your request as soon as possible. If you would like to thank us, please consider <a href="https://rscvd.org/volunteer">joining us in helping supply requests</a>.<br><br>',l+="Yours,<br><br>RSCVD team",this.mail({from:"rscvd@oa.works",to:t.email,subject:"RSCVD Request Receipt",text:l})}catch(e){}return t}},s.svc.rscvd.requestees={_index:!0,_hide:!0,_auth:!0,_prefix:!1,_sheet:"1GuIH-Onf0A0dXFokH6Ma0cS0TRbbpAeOyhDVpmDNDNw"},s.svc.rscvd.resolves=async function(e,t){var i,s,r,a,n,l,o,u,c,h,d,p;for(null==e&&(e=this.params.resolves),null==t&&(t=this.params.resolver),e?n="object"==typeof e?e:await this.svc.rscvd(e):l=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified" OR status:"In progress" OR status:"Awaiting Peter") AND NOT resolved:"'+t+'" AND NOT unresolved:"'+t+'"'),d={},i=0,s=(c=null!=n?[n]:null!=(o=null!=l&&null!=(u=l.hits)?u.hits:void 0)?o:[]).length;i<s;i++)null!=(a=c[i])._source&&null==(n=a._source)._id&&(n._id=a._id),(r=this.copy(n)).title&&(r.journal=r.title),r.atitle&&(r.title=r.atitle),(null!=(p=await this.svc.oaworks.ill.subscription({subscription:t},r))?p.url:void 0)?(null==n.resolved&&(n.resolved=[]),n.resolved.push(t),null==n.resolves&&(n.resolves=[]),n.resolves.push({resolver:t,url:p.url,user:null!=(h=this.user)?h._id:void 0}),d[a._id]=!0):(null==n.unresolved&&(n.unresolved=[]),n.unresolved.push(t),d[a._id]=!1),this.svc.rscvd(n);return e&&d[e]?d[e]:d},s.svc.rscvd.cancel=async function(){var e;if(this.params.cancel)return(e=await this.svc.rscvd(this.params.cancel)).status="Cancelled",this.svc.rscvd(e),e},s.svc.rscvd.verify=async function(e,t=!0){var i,s;if(null==e&&(e=this.params.verify),e)return 1===(null!=(i=await this.svc.rscvd.requestees('email:"'+e+'"'))&&null!=(s=i.hits)?s.total:void 0)&&(i=i.hits.hits[0]._source),null!=(null!=i?i.hits:void 0)&&(i=void 0),null==i&&(i={email:e,createdAt:Date.now()}),t?(i.verified=!0,i.verified_by=this.user.email):(i.denied=!0,i.denied_by=this.user.email),this.waitUntil(this.svc.rscvd.requestees(i)),await this.svc.rscvd._each('email:"'+e+'"',{action:"index"},(function(e){return e.status&&"Awaiting verification"!==e.status||(e.verified=t,t?(e.status="Verified",e.verified_by=this.user.email):(e.status="Denied",e.denied_by=this.user.email)),e})),!0},s.svc.rscvd.verify._auth=!0,s.svc.rscvd.deny=function(){return this.svc.rscvd.verify(this.params.deny,!1)},s.svc.rscvd.deny._auth=!0,s.svc.rscvd.status=async function(){var e,t,i;if(this.params.status){[t,i]=this.params.status.split("/"),(e=await this.svc.rscvd(t)).status=i;try{"Done"===e.status?e.done_by=this.user.email:"In Progress"===e.status&&(e.progressed_by=this.user.email)}catch(e){}return this.svc.rscvd(e),e}},s.svc.rscvd.status._auth=!0,s.svc.rscvd.poll=async function(e,t){var i,s,r,a,n,l,u,c,h,d,p,f,m,g,y,v,b,w,_,x,k,O,S,A,j,I,q,C,P,N;if(this.nolog=!0,null==e&&(e=null!=(w=this.params.poll)?w:Date.now()-18e4),"string"==typeof(t=null!=(_=this.params.which)?_:["new","verify","deny","cancel","status","overdue"])&&(t=t.split(",")),o.call(t,"overdue")>=0&&this.svc.rscvd.overdue(),q={new:[],verify:[],deny:[],cancel:[],status:{}},o.call(t,"new")>=0)for(n=0,h=(O=null!=(x=null!=(b=await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND createdAt:>'+e,500))&&null!=(k=b.hits)?k.hits:void 0)?x:[]).length;n<h;n++)null==(i=(y=O[n])._source)._id&&(i._id=y._id),q.new.push(y._source);if(o.call(t,"verify")>=0)for(l=0,d=(S=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.verify"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;l<d;l++)N=S[l]._source.parts.pop(),o.call(q.verify,N)<0&&q.verify.push(N);if(o.call(t,"deny")>=0)for(u=0,p=(A=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.deny"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;u<p;u++)a=A[u]._source.parts.pop(),o.call(q.deny,a)<0&&q.deny.push(a);if(o.call(t,"cancel")>=0)for(c=0,f=(j=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.cancel"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;c<f;c++)r=j[c]._source.parts.pop(),o.call(q.cancel,r)<0&&q.cancel.push(r);if(o.call(t,"status")>=0)for(g=0,m=(I=(await this.index("logs","createdAt:>"+e+' AND fn:"svc.rscvd.status"',{sort:{createdAt:"desc"},size:500})).hits.hits).length;g<m;g++)P=(C=I[g])._source.parts.pop(),null==(s=q.status)[v=C._source.parts.pop()]&&(s[v]=P);return q},s.svc.rscvd.overdue=async function(){var e,t,i,s,r,a,n,l,o,u,c;if(t=0,i=Date.now(),u=[],this.params.overdue)u.push(await this.svc.rscvd(this.params.overdue));else for(s=0,a=(c=(await this.svc.rscvd('(status:"Awaiting verification" OR status:"Verified") AND (neededAt:<'+i+" OR createdAt:<"+(i-12096e5)+")",1e4)).hits.hits).length;s<a;s++)null==(e=(l=c[s])._source)._id&&(e._id=l._id),u.push(l._source);for(r=0,n=u.length;r<n;r++)(o=u[r]).status="Overdue",this.waitUntil(this.svc.rscvd(o)),t+=1;return t},r.built="Fri Aug 20 2021 05:22:29 GMT+0100",s.puppet={_bg:!0},s.puppet._auth="system",s.puppet._hide=!0,s.scripts.testoab={_bg:!0},s.scripts.testoab._cache=!1,s.src.crossref.load={_bg:!0},s.src.crossref.load._async=!0,s.src.crossref.load._auth="root",s.src.microsoft.load={_bg:!0},s.src.microsoft.load._async=!0,s.src.microsoft.load._auth="root",s.src.oadoi.load={_bg:!0},s.src.oadoi.load._async=!0,s.src.oadoi.load._auth="root",s.src.oadoi.changes={_bg:!0},s.src.oadoi.changes._async=!0,s.src.oadoi.changes._auth="root",s.src.pubmed.load={_bg:!0},s.src.pubmed.load._async=!0,s.src.pubmed.load._auth="root",s.src.pubmed.changes={_bg:!0},s.src.pubmed.changes._async=!0,s.src.pubmed.changes._auth="root",s.src.ror.load={_bg:!0},s.src.ror.load._async=!0,s.src.ror.load._auth="root",s.src.wikidata.load={_bg:!0},s.src.wikidata.load._async=!0,s.src.wikidata.load._auth="root"}.call(this,i(0),i(3).Buffer)},function(e,t,i){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var s=i(4),r=i(5),a=i(6);function n(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(e,t){if(n()<t)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=o.prototype:(null===e&&(e=new o(t)),e.length=t),e}function o(e,t,i){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return u(this,e,t,i)}function u(e,t,i,s){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,s){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(s||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===s?new Uint8Array(t):void 0===s?new Uint8Array(t,i):new Uint8Array(t,i,s);o.TYPED_ARRAY_SUPPORT?(e=t).__proto__=o.prototype:e=d(e,t);return e}(e,t,i,s):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!o.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var s=0|f(t,i),r=(e=l(e,s)).write(t,i);r!==s&&(e=e.slice(0,r));return e}(e,t,i):function(e,t){if(o.isBuffer(t)){var i=0|p(t.length);return 0===(e=l(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(s=t.length)!=s?l(e,0):d(e,t);if("Buffer"===t.type&&a(t.data))return d(e,t.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(c(t),e=l(e,t<0?0:0|p(t)),!o.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function d(e,t){var i=t.length<0?0:0|p(t.length);e=l(e,i);for(var s=0;s<i;s+=1)e[s]=255&t[s];return e}function p(e){if(e>=n())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n().toString(16)+" bytes");return 0|e}function f(e,t){if(o.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return M(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return W(e).length;default:if(s)return M(e).length;t=(""+t).toLowerCase(),s=!0}}function m(e,t,i){var s=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return q(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return j(this,t,i);case"latin1":case"binary":return I(this,t,i);case"base64":return S(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,i);default:if(s)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),s=!0}}function g(e,t,i){var s=e[t];e[t]=e[i],e[i]=s}function y(e,t,i,s,r){if(0===e.length)return-1;if("string"==typeof i?(s=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=r?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(r)return-1;i=e.length-1}else if(i<0){if(!r)return-1;i=0}if("string"==typeof t&&(t=o.from(t,s)),o.isBuffer(t))return 0===t.length?-1:v(e,t,i,s,r);if("number"==typeof t)return t&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):v(e,[t],i,s,r);throw new TypeError("val must be string, number or Buffer")}function v(e,t,i,s,r){var a,n=1,l=e.length,o=t.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(e.length<2||t.length<2)return-1;n=2,l/=2,o/=2,i/=2}function u(e,t){return 1===n?e[t]:e.readUInt16BE(t*n)}if(r){var c=-1;for(a=i;a<l;a++)if(u(e,a)===u(t,-1===c?0:a-c)){if(-1===c&&(c=a),a-c+1===o)return c*n}else-1!==c&&(a-=a-c),c=-1}else for(i+o>l&&(i=l-o),a=i;a>=0;a--){for(var h=!0,d=0;d<o;d++)if(u(e,a+d)!==u(t,d)){h=!1;break}if(h)return a}return-1}function b(e,t,i,s){i=Number(i)||0;var r=e.length-i;s?(s=Number(s))>r&&(s=r):s=r;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");s>a/2&&(s=a/2);for(var n=0;n<s;++n){var l=parseInt(t.substr(2*n,2),16);if(isNaN(l))return n;e[i+n]=l}return n}function w(e,t,i,s){return J(M(t,e.length-i),e,i,s)}function _(e,t,i,s){return J(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,s)}function x(e,t,i,s){return _(e,t,i,s)}function k(e,t,i,s){return J(W(t),e,i,s)}function O(e,t,i,s){return J(function(e,t){for(var i,s,r,a=[],n=0;n<e.length&&!((t-=2)<0);++n)i=e.charCodeAt(n),s=i>>8,r=i%256,a.push(r),a.push(s);return a}(t,e.length-i),e,i,s)}function S(e,t,i){return 0===t&&i===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);for(var s=[],r=t;r<i;){var a,n,l,o,u=e[r],c=null,h=u>239?4:u>223?3:u>191?2:1;if(r+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(a=e[r+1]))&&(o=(31&u)<<6|63&a)>127&&(c=o);break;case 3:a=e[r+1],n=e[r+2],128==(192&a)&&128==(192&n)&&(o=(15&u)<<12|(63&a)<<6|63&n)>2047&&(o<55296||o>57343)&&(c=o);break;case 4:a=e[r+1],n=e[r+2],l=e[r+3],128==(192&a)&&128==(192&n)&&128==(192&l)&&(o=(15&u)<<18|(63&a)<<12|(63&n)<<6|63&l)>65535&&o<1114112&&(c=o)}null===c?(c=65533,h=1):c>65535&&(c-=65536,s.push(c>>>10&1023|55296),c=56320|1023&c),s.push(c),r+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",s=0;for(;s<t;)i+=String.fromCharCode.apply(String,e.slice(s,s+=4096));return i}(s)}t.Buffer=o,t.SlowBuffer=function(e){+e!=e&&(e=0);return o.alloc(+e)},t.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=n(),o.poolSize=8192,o._augment=function(e){return e.__proto__=o.prototype,e},o.from=function(e,t,i){return u(null,e,t,i)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(e,t,i){return function(e,t,i,s){return c(t),t<=0?l(e,t):void 0!==i?"string"==typeof s?l(e,t).fill(i,s):l(e,t).fill(i):l(e,t)}(null,e,t,i)},o.allocUnsafe=function(e){return h(null,e)},o.allocUnsafeSlow=function(e){return h(null,e)},o.isBuffer=function(e){return!(null==e||!e._isBuffer)},o.compare=function(e,t){if(!o.isBuffer(e)||!o.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,s=t.length,r=0,a=Math.min(i,s);r<a;++r)if(e[r]!==t[r]){i=e[r],s=t[r];break}return i<s?-1:s<i?1:0},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var s=o.allocUnsafe(t),r=0;for(i=0;i<e.length;++i){var n=e[i];if(!o.isBuffer(n))throw new TypeError('"list" argument must be an Array of Buffers');n.copy(s,r),r+=n.length}return s},o.byteLength=f,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},o.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?A(this,0,e):m.apply(this,arguments)},o.prototype.equals=function(e){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},o.prototype.compare=function(e,t,i,s,r){if(!o.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===s&&(s=0),void 0===r&&(r=this.length),t<0||i>e.length||s<0||r>this.length)throw new RangeError("out of range index");if(s>=r&&t>=i)return 0;if(s>=r)return-1;if(t>=i)return 1;if(this===e)return 0;for(var a=(r>>>=0)-(s>>>=0),n=(i>>>=0)-(t>>>=0),l=Math.min(a,n),u=this.slice(s,r),c=e.slice(t,i),h=0;h<l;++h)if(u[h]!==c[h]){a=u[h],n=c[h];break}return a<n?-1:n<a?1:0},o.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},o.prototype.indexOf=function(e,t,i){return y(this,e,t,i,!0)},o.prototype.lastIndexOf=function(e,t,i){return y(this,e,t,i,!1)},o.prototype.write=function(e,t,i,s){if(void 0===t)s="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)s=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}var r=this.length-t;if((void 0===i||i>r)&&(i=r),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var a=!1;;)switch(s){case"hex":return b(this,e,t,i);case"utf8":case"utf-8":return w(this,e,t,i);case"ascii":return _(this,e,t,i);case"latin1":case"binary":return x(this,e,t,i);case"base64":return k(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,e,t,i);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function j(e,t,i){var s="";i=Math.min(e.length,i);for(var r=t;r<i;++r)s+=String.fromCharCode(127&e[r]);return s}function I(e,t,i){var s="";i=Math.min(e.length,i);for(var r=t;r<i;++r)s+=String.fromCharCode(e[r]);return s}function q(e,t,i){var s=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>s)&&(i=s);for(var r="",a=t;a<i;++a)r+=U(e[a]);return r}function C(e,t,i){for(var s=e.slice(t,i),r="",a=0;a<s.length;a+=2)r+=String.fromCharCode(s[a]+256*s[a+1]);return r}function P(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function N(e,t,i,s,r,a){if(!o.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<a)throw new RangeError('"value" argument is out of bounds');if(i+s>e.length)throw new RangeError("Index out of range")}function E(e,t,i,s){t<0&&(t=65535+t+1);for(var r=0,a=Math.min(e.length-i,2);r<a;++r)e[i+r]=(t&255<<8*(s?r:1-r))>>>8*(s?r:1-r)}function L(e,t,i,s){t<0&&(t=4294967295+t+1);for(var r=0,a=Math.min(e.length-i,4);r<a;++r)e[i+r]=t>>>8*(s?r:3-r)&255}function R(e,t,i,s,r,a){if(i+s>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function D(e,t,i,s,a){return a||R(e,0,i,4),r.write(e,t,i,s,23,4),i+4}function T(e,t,i,s,a){return a||R(e,0,i,8),r.write(e,t,i,s,52,8),i+8}o.prototype.slice=function(e,t){var i,s=this.length;if((e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e),o.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=o.prototype;else{var r=t-e;i=new o(r,void 0);for(var a=0;a<r;++a)i[a]=this[a+e]}return i},o.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s},o.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var s=this[e+--t],r=1;t>0&&(r*=256);)s+=this[e+--t]*r;return s},o.prototype.readUInt8=function(e,t){return t||P(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return t||P(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return t||P(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},o.prototype.readUInt32BE=function(e,t){return t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s>=(r*=128)&&(s-=Math.pow(2,8*t)),s},o.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||P(e,t,this.length);for(var s=t,r=1,a=this[e+--s];s>0&&(r*=256);)a+=this[e+--s]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*t)),a},o.prototype.readInt8=function(e,t){return t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},o.prototype.readInt16LE=function(e,t){t||P(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt16BE=function(e,t){t||P(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},o.prototype.readInt32LE=function(e,t){return t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,i,s){(e=+e,t|=0,i|=0,s)||N(this,e,t,i,Math.pow(2,8*i)-1,0);var r=1,a=0;for(this[t]=255&e;++a<i&&(r*=256);)this[t+a]=e/r&255;return t+i},o.prototype.writeUIntBE=function(e,t,i,s){(e=+e,t|=0,i|=0,s)||N(this,e,t,i,Math.pow(2,8*i)-1,0);var r=i-1,a=1;for(this[t+r]=255&e;--r>=0&&(a*=256);)this[t+r]=e/a&255;return t+i},o.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,1,255,0),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):E(this,e,t,!0),t+2},o.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):E(this,e,t,!1),t+2},o.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):L(this,e,t,!0),t+4},o.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):L(this,e,t,!1),t+4},o.prototype.writeIntLE=function(e,t,i,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*i-1);N(this,e,t,i,r-1,-r)}var a=0,n=1,l=0;for(this[t]=255&e;++a<i&&(n*=256);)e<0&&0===l&&0!==this[t+a-1]&&(l=1),this[t+a]=(e/n>>0)-l&255;return t+i},o.prototype.writeIntBE=function(e,t,i,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*i-1);N(this,e,t,i,r-1,-r)}var a=i-1,n=1,l=0;for(this[t+a]=255&e;--a>=0&&(n*=256);)e<0&&0===l&&0!==this[t+a+1]&&(l=1),this[t+a]=(e/n>>0)-l&255;return t+i},o.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,1,127,-128),o.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):E(this,e,t,!0),t+2},o.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):E(this,e,t,!1),t+2},o.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):L(this,e,t,!0),t+4},o.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||N(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),o.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):L(this,e,t,!1),t+4},o.prototype.writeFloatLE=function(e,t,i){return D(this,e,t,!0,i)},o.prototype.writeFloatBE=function(e,t,i){return D(this,e,t,!1,i)},o.prototype.writeDoubleLE=function(e,t,i){return T(this,e,t,!0,i)},o.prototype.writeDoubleBE=function(e,t,i){return T(this,e,t,!1,i)},o.prototype.copy=function(e,t,i,s){if(i||(i=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-i&&(s=e.length-t+i);var r,a=s-i;if(this===e&&i<t&&t<s)for(r=a-1;r>=0;--r)e[r+t]=this[r+i];else if(a<1e3||!o.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)e[r+t]=this[r+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+a),t);return a},o.prototype.fill=function(e,t,i,s){if("string"==typeof e){if("string"==typeof t?(s=t,t=0,i=this.length):"string"==typeof i&&(s=i,i=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!o.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var a;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(a=t;a<i;++a)this[a]=e;else{var n=o.isBuffer(e)?e:M(new o(e,s).toString()),l=n.length;for(a=0;a<i-t;++a)this[a+t]=n[a%l]}return this};var z=/[^+\/0-9A-Za-z-_]/g;function U(e){return e<16?"0"+e.toString(16):e.toString(16)}function M(e,t){var i;t=t||1/0;for(var s=e.length,r=null,a=[],n=0;n<s;++n){if((i=e.charCodeAt(n))>55295&&i<57344){if(!r){if(i>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(n+1===s){(t-=3)>-1&&a.push(239,191,189);continue}r=i;continue}if(i<56320){(t-=3)>-1&&a.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&(t-=3)>-1&&a.push(239,191,189);if(r=null,i<128){if((t-=1)<0)break;a.push(i)}else if(i<2048){if((t-=2)<0)break;a.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;a.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return a}function W(e){return s.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(z,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,i,s){for(var r=0;r<s&&!(r+i>=t.length||r>=e.length);++r)t[r+i]=e[r];return r}}).call(this,i(0))},function(e,t,i){"use strict";t.byteLength=function(e){var t=u(e),i=t[0],s=t[1];return 3*(i+s)/4-s},t.toByteArray=function(e){var t,i,s=u(e),n=s[0],l=s[1],o=new a(function(e,t,i){return 3*(t+i)/4-i}(0,n,l)),c=0,h=l>0?n-4:n;for(i=0;i<h;i+=4)t=r[e.charCodeAt(i)]<<18|r[e.charCodeAt(i+1)]<<12|r[e.charCodeAt(i+2)]<<6|r[e.charCodeAt(i+3)],o[c++]=t>>16&255,o[c++]=t>>8&255,o[c++]=255&t;2===l&&(t=r[e.charCodeAt(i)]<<2|r[e.charCodeAt(i+1)]>>4,o[c++]=255&t);1===l&&(t=r[e.charCodeAt(i)]<<10|r[e.charCodeAt(i+1)]<<4|r[e.charCodeAt(i+2)]>>2,o[c++]=t>>8&255,o[c++]=255&t);return o},t.fromByteArray=function(e){for(var t,i=e.length,r=i%3,a=[],n=0,l=i-r;n<l;n+=16383)a.push(c(e,n,n+16383>l?l:n+16383));1===r?(t=e[i-1],a.push(s[t>>2]+s[t<<4&63]+"==")):2===r&&(t=(e[i-2]<<8)+e[i-1],a.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return a.join("")};for(var s=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,o=n.length;l<o;++l)s[l]=n[l],r[n.charCodeAt(l)]=l;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function c(e,t,i){for(var r,a,n=[],l=t;l<i;l+=3)r=(e[l]<<16&16711680)+(e[l+1]<<8&65280)+(255&e[l+2]),n.push(s[(a=r)>>18&63]+s[a>>12&63]+s[a>>6&63]+s[63&a]);return n.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,i,s,r){var a,n,l=8*r-s-1,o=(1<<l)-1,u=o>>1,c=-7,h=i?r-1:0,d=i?-1:1,p=e[t+h];for(h+=d,a=p&(1<<-c)-1,p>>=-c,c+=l;c>0;a=256*a+e[t+h],h+=d,c-=8);for(n=a&(1<<-c)-1,a>>=-c,c+=s;c>0;n=256*n+e[t+h],h+=d,c-=8);if(0===a)a=1-u;else{if(a===o)return n?NaN:1/0*(p?-1:1);n+=Math.pow(2,s),a-=u}return(p?-1:1)*n*Math.pow(2,a-s)},t.write=function(e,t,i,s,r,a){var n,l,o,u=8*a-r-1,c=(1<<u)-1,h=c>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:a-1,f=s?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(l=isNaN(t)?1:0,n=c):(n=Math.floor(Math.log(t)/Math.LN2),t*(o=Math.pow(2,-n))<1&&(n--,o*=2),(t+=n+h>=1?d/o:d*Math.pow(2,1-h))*o>=2&&(n++,o/=2),n+h>=c?(l=0,n=c):n+h>=1?(l=(t*o-1)*Math.pow(2,r),n+=h):(l=t*Math.pow(2,h-1)*Math.pow(2,r),n=0));r>=8;e[i+p]=255&l,p+=f,l/=256,r-=8);for(n=n<<r|l,u+=r;u>0;e[i+p]=255&n,p+=f,n/=256,u-=8);e[i+p-f]|=128*m}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}}]);