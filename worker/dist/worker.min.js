!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));let r=e=>crypto.getRandomValues(new Uint8Array(e)),n=(e,t)=>((e,t,i)=>{let r=(2<<Math.log(e.length-1)/Math.LN2)-1,n=-~(1.6*r*t/e.length);return()=>{let s="";for(;;){let l=i(n),o=n;for(;o--;)if(s+=e[l[o]&r]||"",s.length===t)return s}}})(e,t,r)},function(e,t,i){"use strict";i.r(t),function(e,t){var r,n,s,l,o,a,u,c,h,p=i(1),d=[].indexOf;try{n=JSON.parse(SECRETS_SETTINGS)}catch(e){}null==n&&(n={}),null==n.name&&(n.name="N2"),null==n.version&&(n.version="5.2.0"),null==n.env&&(n.env="dev"),null==n.dev&&(n.dev="dev"===n.env),null==n.bg&&(n.bg="https://dev.api.cottagelabs.com/log/remote"),null==n.headers&&(n.headers={}),null==n.svc&&(n.svc={}),null==n.src&&(n.src={});try{addEventListener("fetch",(function(e){return e.respondWith(r.call(e))}))}catch(e){}(r=async function(){var e,t,i,s,l,o,a,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L,C,I,P;this.started=Date.now();try{n.dev&&console.log(n.version)}catch(e){}try{null==(o=n.headers)[y="X-"+n.name]&&(o[y]=(n.version?"v"+n.version:"")+(n.env?" "+n.env:"")+(n.built?" built "+n.built:""))}catch(e){}if(this.S=JSON.parse(JSON.stringify(n)),this.params={},null!=this.request.url&&-1!==this.request.url.indexOf("?"))for(P=0,f=(_=this.request.url.split("?")[1].split("&")).length;P<f;P++)if(p=(b=_[P]).split("="),this.params[p[0]]=1===p.length||("string"==typeof p[1]&&"true"===p[1].toLowerCase()||("string"!=typeof p[1]||"false"!==p[1].toLowerCase())&&(!!b.endsWith("=")||p[1])),"string"!=typeof this.params[p[0]]||0!==this.params[p[0]].replace(/[0-9]/g,"").length||this.params[p[0]].startsWith("0")||(d=parseInt(this.params[p[0]]),isNaN(d)||(this.params[p[0]]=d)),"string"==typeof this.params[p[0]]&&(this.params[p[0]].startsWith("[")||this.params[p[0]].startsWith("{")))try{this.params[p[0]]=JSON.parse(this.params[p[0]])}catch(e){}if(this.request.bodyUsed){try{if((this.request.body.startsWith("{")||this.request.body.startsWith("["))&&(this.body=JSON.parse(this.request.body)),"object"==typeof this.body&&!Array.isArray(this.body))for(b in this.body)null==(a=this.params)[b]&&(a[b]=this.body[b])}catch(e){}try{null==this.body&&(this.body=this.request.body)}catch(e){}}this.params.refresh&&(this.refresh=this.params.refresh,delete this.params.refresh);try{this.rid=this.request.headers.get("cf-ray").slice(0,-4)}catch(e){}try{this.id=null!=(w=null!=(q=null!=(A=null!=(j=this.request.headers.get("x-id"))?j:this.request.headers.get("id"))?A:this.request.headers.get("_id"))?q:this.params._id)?w:this.params.id}catch(e){}try{this.apikey=null!=(S=null!=(E=null!=(R=this.request.headers.get("x-apikey"))?R:this.request.headers.get("apikey"))?E:this.params.apikey)?S:this.params.apiKey}catch(e){}this.params.apikey&&delete this.params.apikey;try{this.cookie=this.request.headers.get("cookie")}catch(e){}for(this.headers={},h=0,m=(T=[...this.request.headers]).length;h<m;h++)c=T[h],this.headers[c[0]]=c[1];if(this.url=this.request.url.split("?")[0].replace(/\/$/,"").split("://")[1],this.parts=this.url.split("/"),this.base=this.parts.shift(),this.route=this.parts.join("/"),this._logs=[],""===this.route)return r._response.call(this,"HEAD"===(L=this.request.method)||"OPTIONS"===L?"":{name:this.S.name,version:this.S.version,env:this.S.env,built:this.S.dev?this.S.built:void 0});if(this.routes={},this.fn="",s=async(e,t,i)=>{if(i._kv&&this.kv(e,t,"number"==typeof i._kv?i._kv:void 0),i._index&&(!1===i._kv||!1===this.S.kv||!0===this.S.index.immediate)&&!await this.index(e,t))return await this.index(t.split("/")[0],"object"!=typeof i._index?{}:{settings:i._index.settings,mappings:i._index.mappings,aliases:i._index.aliases})?this.index(e,t):this.log({fn:t.split("/")[0].replace(/\_/g,"."),msg:"Could not save/create index",level:"error"})},i=(e,t)=>(e._sheet&&null==e._index&&(e._index=!0),e._index||e._kv||"object"!=typeof e||Array.isArray(e)||"function"==typeof e[this.request.method]?(e._index||e._kv)&&"function"!=typeof e?e:-1===t.indexOf(".")||0===t.split(".").pop().indexOf("_")?e.bind(this):async function(){var i,r,n,l,o,a,u,c,h;if(h=Date.now(),c=t.replace(/\./g,"_"),i=!1,e._index&&(this.fn===t&&this.index._q(this.params)||this.fn!==t&&1===arguments.length&&this.index._q(arguments[0])||2===arguments.length&&this.index._q(arguments[1]))&&(u=this.index(2===arguments.length&&null!=(l=arguments[0])?l:c,2===arguments.length||1===arguments.length?arguments[1]:this.params)),null!=u||this.refresh||"GET"!==this.request.method&&this.fn===t||this.fn!==t&&1!==arguments.length||!e._kv&&!e._index||(e._kv&&null!=(u=await this.kv(arguments.length?c+"/"+arguments[0].replace(/\//g,"_").replace(c+"_",""):void 0))&&(i="kv"),e._index&&null==u&&null!=(u=await this.index(arguments.length?c+"/"+arguments[0].replace(/\//g,"_").replace(c+"_",""):void 0))&&(i="index")),i&&this.fn.startsWith(t)&&(this.cached=i),r=!1,null==u)if("function"==typeof e&&(u=await(null!=(o=e[this.request.method])?o:e).apply(this,arguments)),null!=u){if(e._kv||e._index){try{r=null!=(a=u[e._key])?a:u._id,0!==(r=(r=Array.isArray(r)?r[0]:"string"!=typeof r?void 0:r).replace(/\//g,"_").replace(c+"_",c+"/")).indexOf(c)&&(r=c+"/"+r)}catch(e){}!1===r&&(r=c+"/"+this.uid()),r=r.toLowerCase(),this.waitUntil(s(r,u,this.copy(e)))}}else arguments.length&&arguments[0]!==c||(e._index?u=await this.index(...arguments):e._kv&&(u=""));if(n={fn:t,cached:i||void 0,key:r||(i&&arguments.length?arguments[0].toLowerCase():void 0)},e._index||e._kv){try{arguments.length&&(n.args=JSON.stringify([...arguments]))}catch(e){}try{n.result=null!=u}catch(e){}}try{n.took=Date.now()-h}catch(e){}return this.log(n),u}.bind(this):JSON.parse(JSON.stringify(e))),u=void 0,v=[...this.parts],g=void 0,(e=(t,r,n)=>{var s,l,o,a,c;for(s in c=!1,(""===n||g&&("."+n).endsWith("."+g+"."))&&v.length&&("function"==(l=typeof t[v[0]])||"object"===l?(this.fn+=(""===this.fn?"":".")+v[0],c=g=v.shift()):g&&(this.params[g]=this.params[g]?this.params[g]+"/"+v[0]:v[0],v.shift())),a=[],t)r[s]=i(t[s],n+s),"function"==(o=typeof r[s])||"object"===o?("function"==typeof r[s]&&(s.startsWith("_")||(s===c&&-1===n.indexOf("._")&&(u=r[s]),this.routes[n+s]="")),Array.isArray(t[s])||s.startsWith("_")&&"function"!=typeof t[s]?a.push(void 0):a.push(e(t[s],r[s],n+s+"."))):a.push(void 0);return a})(r,this,""),g&&v.length&&(this.params[g]=this.params[g]?this.params[g]+"/"+v.join("/"):v.join("/")),C=void 0,"function"==typeof u)if("object"==typeof(l=this.auth())&&l._id&&l.email&&(this.user=l),l="function"==typeof u._auth?await u._auth():!0===u._auth&&null!=this.user||(null==u._auth||await this.auth.role(u._auth)))if("HEAD"===(x=this.request.method)||"OPTIONS"===x)C="";else{if(!1!==u._cache&&!this.refresh&&"GET"===this.request.method&&(C=await this._cache()))return this.cached="cache",(I=new Response(C.body,C)).headers.append("x-"+this.S.name+"-cached","cache"),I.headers.delete("x-"+this.S.name+"-took"),this.log(),I;t=async()=>(C=await u(),this.completed=!0),await Promise.race([t(),this.sleep(14500)]),this.completed||(C={status:408})}else await this.sleep(200*(1+Math.random())),C={status:401};return this.url.replace(".ico","").replace(".gif","").replace(".png","").endsWith("/favicon")&&null==C&&(C=""),I=await this._response(C),this.parts.length&&"log"!==(O=this.parts[0])&&"status"!==O&&"HEAD"!==(k=this.request.method)&&"OPTIONS"!==k&&null!=C&&""!==C&&(null!=u&&!1!==u._cache&&this.completed&&200===I.status&&this._cache(void 0,I.clone(),u._cache),this.log()),I})._response=function(t){var i,r,n,s,l,o;if(null==(i=this.S).headers&&(i.headers={}),null==t)t=404,o=404;else if("object"==typeof t&&!Array.isArray(t)&&("number"==typeof t.status&&t.status>300&&t.status<600||t.headers)){if(null!=t.headers){for(n in t.headers)this.S.headers[n]=t.headers[n];delete t.headers}o=null!=(l=t.status)?l:200,delete t.status,0===(s=this.keys(t)).length?t=o:1===s.length&&(t=t[s[0]])}else o=200;if(null==this.S.headers["Content-Type"]){try{t=JSON.stringify(t,"",2)}catch(e){}this.S.headers["Content-Type"]="application/json; charset=UTF-8"}try{null==(r=this.S.headers)["Content-Length"]&&(r["Content-Length"]=e.byteLength(t))}catch(e){}try{this.S.headers["x-"+this.S.name+"-took"]=Date.now()-this.started}catch(e){}try{this.cached&&(this.S.headers["x-"+this.S.name+"-cached"]=this.cached)}catch(e){}return new Response(t,{status:o,headers:this.S.headers})},r.src={},r.svc={},r.uid=function(e){var t,i,r,n,s;return Object(p.a)(null!=(t=this.params.alphabet)?t:"0123456789abcdefghijklmnopqrstuvwxyz-",null!=(i=null!=(r=null!=(n=null!=(s=this.params.len)?s:this.params.length)?n:this.params.size)?r:this.params.uid)?i:21)()},r.uid._cache=!1,r.copy=function(e){try{null==e&&(e=this.params)}catch(e){}return JSON.parse(JSON.stringify(e))},r.keys=function(e){var t,i;try{null==e&&(e=this.params)}catch(e){}for(t in i=[],null!=e?e:{})null!=e[t]&&d.call(i,t)<0&&i.push(t);return i},r.sleep=function(e){try{null==e&&(e=this.params.ms)}catch(e){}return new Promise(t=>setTimeout(t,null!=e?e:1e3))},r.hash=async function(e){var t,i,r,n,s,l,o,a,u;try{null==e&&(e=null!=(l=null!=(o=null!=(a=this.params.hash)?a:this.request.body)?o:this.params.q)?l:this.params)}catch(e){}for("string"!=typeof e&&(e=JSON.stringify(e)),e=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",e),s=[],u=0,n=(t=new Uint8Array(r)).length;u<n;u++)i=t[u],s.push(("00"+i.toString(16)).slice(-2));return s.join("")},r.dot=function(e,t){var i,r,n,s;for("string"==typeof e&&"object"==typeof t&&(n=e,e=t,t=n),null!=e&&(e=this.copy(e)),null==e&&null!=(null!=this&&null!=(r=this.params)?r.key:void 0)&&(t=(e=this.copy(this.params)).key,delete e.key),"string"==typeof t&&(t=t.split(".")),s=0,i=t.length;s<i;s++)e=e[t[s]];return e},r.fetch=async function(t,i){var r,n,s,l,o,a,u,c,h;"object"==typeof t&&null==i&&(t=(i=t).url);try{null==i&&(i=this.copy(this.params))}catch(e){}for(null==i&&(i={}),!t&&i.url&&(t=i.url,delete i.url),i.username&&i.password&&(i.auth=i.username+":"+i.password,delete i.username,delete i.password),-1!==t.split("//")[1].split("@")[0].indexOf(":")&&(i.auth=t.split("//")[1].split("@")[0],t=t.replace(i.auth+"@","")),i.auth&&(null==i.headers&&(i.headers={}),i.headers.Authorization="Basic "+e.from(i.auth).toString("base64"),delete i.auth),h=0,s=(o=["data","content","json"]).length;h<s;h++)null!=i[n=o[h]]&&(i.body=i[n],delete i[n]);if(null!=i.body&&(null==i.headers&&(i.headers={}),null==i.headers["Content-Type"]&&null==i.headers["content-type"]&&(i.headers["Content-Type"]="object"==typeof i.body?"application/json":"text/plain"),"object"!=(a=typeof i.body)&&"boolean"!==a&&"number"!==a||(i.body=JSON.stringify(i.body))),console.log(t),"string"!=typeof t)return!1;r=async()=>{var e;return i.verbose?(e=!0,delete i.verbose):e=!1,c=await fetch(t,i),console.log(c.status),e?c:(n=c.headers.get("content-type"),l="string"==typeof n&&-1!==n.toLowerCase().indexOf("json")?await c.json():await c.text(),404===c.status?void 0:c.status>=400?(console.log(l),{status:c.status}):l)},u=await r();try{0!==(u=u.trim()).indexOf("[")&&0!==u.indexOf("{")||(u=JSON.parse(u))}catch(e){}return u};try{n.svc.oaworks=JSON.parse(SECRETS_OAWORKS)}catch(e){n.svc.oaworks={}}r.svc.oaworks=function(){return{name:"OA.works API"}},r.svc.oaworks.permissions=async function(e,t,i){var r,s,l,o,a,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,qe,Ae,je,Se,Ee,Re,Te,Le,Ce;if(B=!1,c=!1,m=!1,null==e&&(e=this.copy(this.params)),null!=(null!=e?e.permissions:void 0)&&(e.permissions.startsWith("journal/")?e.issn=e.permissions.replace("journal/",""):e.permissions.startsWith("affiliation/")?e.ror=e.permissions.replace("affiliation/",""):e.permissions.startsWith("publisher/")?e.publisher=e.permissions.replace("publisher/",""):0===e.permissions.indexOf("10.")&&-1!==e.permissions.indexOf("/")?e.doi=e.permissions:0!==e.permissions.indexOf("-")&&e.permissions.length<10&&e.permissions.length>6?e.issn=e.permissions:e.publisher=e.permissions,delete e.permissions),s=async function(t){var i,r,s,l,o,a,u,h,p,d,f,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L;if(m&&t.embargo_months&&(e.published||e.year)&&(r=(r=moment(null!=(y=e.published)?y:e.year+"-01-01")).add(t.embargo_months,"months"),t.embargo_end=r.format("YYYY-MM-DD")),""===t.embargo_end&&delete t.embargo_end,t.copyright_name="publisher"===t.copyright_owner?"string"==typeof t.issuer.parent_policy?t.issuer.parent_policy:"string"==typeof t.issuer.id?t.issuer.id:t.issuer.id[0]:"journal"===(g=t.copyright_owner)||"affiliation"===g?null!=(O=e.journal)?O:"":t.copyright_owner&&-1!==t.copyright_owner.toLowerCase().indexOf("author")&&null!=e.author&&e.author.length&&(e.author[0].name||e.author[0].family)?(null!=(k=e.author[0].name)?k:e.author[0].family)+(e.author.length>1?" et al":""):"",("publisher"===(q=t.copyright_name)||"journal"===q)&&(c||e.doi||(null!=(A=t.provenance)?A.example:void 0))&&(!1===c&&(c=await this.src.crossref.works(null!=(j=e.doi)?j:t.provenance.example)),null!=(null!=c?c.assertion:void 0)&&c.assertion.length))for(L=0,u=(S=c.assertion).length;L<u;L++)if("copyright"===(i=S[L]).name.toLowerCase()){try{t.copyright_name=i.value}catch(e){}try{t.copyright_name=i.value.replace("© ","").replace(/[0-9]/g,"").trim()}catch(e){}}if(m&&""===t.copyright_year&&e.year&&(t.copyright_year=e.year),""===t.copyright_year&&delete t.copyright_year,m&&null!=t.deposit_statement&&-1!==t.deposit_statement.indexOf("<<")){for(l="",o=0,h=(E=t.deposit_statement.split("<<")).length;o<h;o++)if(f=E[o],""===l&&-1===f.indexOf(">>"))l+=f;else{if(null!=(T={"journal title":"journal",vol:"volume","date of publication":"published","(c)":"year","article title":"title","copyright name":"copyright_name"})[d=(s=f.split(">>"))[0].toLowerCase()]&&(d=T[d]),"author"===d)try{l+=(null!=(R=e.author[0].name)?R:e.author[0].family)+(e.author.length>1?" et al":"")}catch(e){}else l+=null!=(v=null!=(b=e[d])?b:t[d])?v:"";try{l+=s[1]}catch(e){}}t.deposit_statement=l}for(null!=t._id&&(null==t.meta&&(t.meta={}),t.meta.source="https://"+(n.dev?"dev.api.cottagelabs.com/svc/oaworks/permissions/":"api.openaccessbutton.org/permissions/")+(t.issuer.type?t.issuer.type+"/":"")+t._id),"string"!=typeof(null!=(_=t.issuer)?_.has_policy:void 0)||"not publisher"!==(w=t.issuer.has_policy.toLowerCase().trim())&&"takedown"!==w||(B=t.issuer.has_policy),a=0,p=(x=["_id","permission_required","createdAt","updatedAt","created_date","updated_date"]).length;a<p;a++)delete t[x[a]];try{delete t.issuer.updatedAt}catch(e){}return t},l=e=>{var t,i,r,n,s,l,o;return o=e.can_archive?1e3:0,"In DOAJ"===(null!=(t=e.provenance)?t.oa_evidence:void 0)&&(o+=1e3),null!=e.requirements?o-=10:o+="publishedVersion"===e.version?200:"acceptedVersion"===e.version?100:0,null!=e.licences&&e.licences.length&&(o-=5),o+="journal"===(null!=(i=e.issuer)?i.type:void 0)?5:"publisher"===(null!=(r=e.issuer)?r.type:void 0)?4:"university"===(null!=(n=e.issuer)?n.type:void 0)?3:(s=null!=(l=e.issuer)?l.type:void 0,d.call("article",s)>=0?2:0),e.embargo_months&&e.embargo_months>=36&&(!e.embargo_end||moment(e.embargo_end,"YYYY-MM-DD").isBefore(moment()))&&(o-=25),o},{},"string"==typeof e&&(e=0===e.indexOf("10.")?{doi:e}:{issn:e}),null!=e.meta&&delete e.meta,null!=e.metadata&&(e,e=e.metadata),e.affiliation&&(e.ror=e.affiliation,delete e.affiliation),e.journal&&-1===e.journal.indexOf(" ")&&(e.issn=e.journal,delete e.journal),e.publisher&&-1===e.publisher.indexOf(" ")&&-1===e.publisher.indexOf(",")&&!oab_permissions.find('issuer.type.exact:"publisher" AND issuer.id:"'+e.publisher+'"')&&(e.ror=e.publisher,delete e.publisher),v=Array.isArray(e.issn)?e.issn:[],"string"==typeof e.issn&&-1!==e.issn.indexOf(",")&&(e.issn=e.issn.split(",")),"string"==typeof e.ror&&-1!==e.ror.indexOf(",")&&(e.ror=e.ror.split(",")),e.ror||("object"==typeof(Re="object"==typeof t?t:"string"==typeof t?this.svc.oaworks.deposit.config(t):void 0)&&null!=Re.ror||"string"==typeof t)&&(e.ror=null!=(H=null!=Re?Re.ror:void 0)?H:t),"{}"===JSON.stringify(e)||e.issn&&-1===JSON.stringify(e.issn).indexOf("-")||e.doi&&("string"!=typeof e.doi||0!==e.doi.indexOf("10.")||-1===e.doi.indexOf("/")))return{body:"No valid DOI, ISSN, or ROR provided",statusCode:404};if(r=()=>{var t,i,r,n;if(delete(i=this.copy(e)).ror,"{}"!==JSON.stringify(i)){for(t in r=[],n=this.svc.oaworks.metadata({metadata:["crossref_type","issn","publisher","published","year","author","ror"]},i))r.push(null!=e[t]?e[t]:e[t]=n[t]);return r}},!1===i||!e.doi||e.publisher&&e.issn||await r(),!e.published&&e.year&&(e.published=e.year+"-01-01"),m=null!=e.doi,o=!1,e.issn){if("string"==typeof e.issn&&(e.issn=[e.issn]),!v.length)for(Le=0,k=(K=e.issn).length;Le<k;Le++)g=K[Le],d.call(v,g)<0&&v.push(g);if((!v.length||!e.publisher||!e.doi)&&(o=academic_journal.find('issn.exact:"'+v.join('" OR issn.exact:"')+'"'))){for(null==e.publisher&&(e.publisher=o.publisher),y=0,q=(ae="string"==typeof o.issn?[o.issn]:o.issn).length;y<q;y++)u=ae[y],d.call(v,u)<0&&v.push(u);null==e.doi&&(e.doi=o.doi)}try{null==e.doi&&(e.doi=await this.src.crossref.journals.doi(v))}catch(t){null==e.doi&&(e.doi=await this.src.crossref.journals.dois.example(v))}!m&&e.doi&&await r()}if(m&&"journal-article"!==e.crossref_type)return{body:"DOI is not a journal article",status:501};e.publisher&&-1!==e.publisher.indexOf("(")&&e.publisher.lastIndexOf(")")>.7*e.publisher.length&&(e.publisher=e.publisher.substring(0,e.publisher.lastIndexOf("(")).trim());try{e.citation="[",e.title&&(e.citation+=e.title+". "),e.journal&&(e.citation+=e.journal+" "),e.volume&&(e.citation+=e.volume+(e.issue?", ":" ")),e.issue&&(e.citation+=e.issue+" "),null==e.page&&null==e.pages||(e.citation+="p"+(null!=(me=e.page)?me:e.pages)),(e.year||e.published)&&(e.citation+=" ("+(null!=(ye=e.year)?ye:e.published).split("-")[0]+")"),e.citation=e.citation.trim(),e.citation+="]"}catch(e){}if(W={best_permission:void 0,all_permissions:[]},xe=[],null!=e.ror){if("string"==typeof e.ror&&(e.ror=[e.ror]),!(null!=(ke=oab_permissions.search('issuer.id.exact:"'+e.ror.join('" OR issuer.id.exact:"')+'"'))&&null!=(ge=ke.hits)?ge.total:void 0)&&(qe=wikidata_record.find('snaks.property.exact:"P6782" AND snaks.property.exact:"P17" AND (snaks.value.exact:"'+e.ror.join(" OR snaks.value.exact:")+'")')))for(Se=!1,b=0,j=(ve=qe.snaks).length;b<j&&(je=ve[b],!Se);b++)if("P17"===je.property&&(h=wikidata_record.get(je.qid)))for(_=0,S=(be=h.snaks).length;_<S;_++)if("P297"===(Ae=be[_]).property){Se=!0,ke=oab_permissions.search('issuer.id.exact:"'+Ae.value+'"');break}for(O=0,E=(Z=null!=(_e=null!=ke&&null!=(Q=ke.hits)?Q.hits:void 0)?_e:[]).length;O<E;O++)(Ee=s(Z[O]._source)).score=l(Ee),xe.push(Ee)}if((v.length||e.publisher)&&(G=v.length?'issuer.id.exact:"'+v.join('" OR issuer.id.exact:"')+'"':"",e.publisher&&(""!==G&&(G+=" OR "),G+='issuer.id:"'+e.publisher+'"'),null!=(null!=(F=oab_permissions.search(G))&&null!=(ee=F.hits)?ee.hits:void 0)&&F.hits.hits.length))for(U=0,R=(te=F.hits.hits).length;U<R;U++)(Oe=s(te[U]._source)).score=l(Oe),W.all_permissions.push(Oe);if(0!==W.all_permissions.length||!e.publisher||e.doi||v.length||(null==(o=academic_journal.find('publisher:"'+e.publisher+'"'))&&((f=academic_journal.find('publisher:"'+e.publisher.split(" ").join(' AND publisher:"')+'"')).publisher===e.publisher?o=f:(P=(N=this.tdm.levenshtein(f.publisher,e.publisher,!0)).length.a>N.length.b?N.length.a:N.length.b,(N.distance<5||P/N.distance>10)&&(o=f))),"object"==typeof o&&o.is_oa&&(V=academic_journal.count('publisher:"'+o.publisher+'"')===academic_journal.count('publisher:"'+o.publisher+'" AND is_oa:true')),o.is_oa&&V||(o=!1)),"object"==typeof o&&!1!==o.is_oa&&(null==o.is_oa&&(d.call(o.src,"doaj")>=0||o.wikidata_in_doaj)&&(o.is_oa=!0),o.is_oa)){a={can_archive:!0,version:"publishedVersion",versions:["publishedVersion"],licence:void 0,licence_terms:"",licences:[],locations:["institutional repository"],embargo_months:void 0,issuer:{type:"journal",has_policy:"yes",id:o.issn},meta:{creator:["joe+doaj@openaccessbutton.org"],contributors:["joe+doaj@openaccessbutton.org"],monitoring:"Automatic"}};try{a.licence=o.license[0].type}catch(e){}null==a.licence&&(a.licence=o.licence),(d.call(o.src,"doaj")>=0||o.wikidata_in_doaj)&&(a.embargo_months=0,a.provenance={oa_evidence:"In DOAJ"}),"string"==typeof a.licence?(a.licence=a.licence.toLowerCase().trim(),0===a.licence.indexOf("cc")?a.licence=a.licence.replace(/ /g,"-"):-1!==a.licence.indexOf("creative")?a.licence=-1!==a.licence.indexOf("0")||-1!==a.licence.indexOf("zero")?"cc0":-1!==a.licence.indexOf("share")?"ccbysa":-1!==a.licence.indexOf("derivative")?"ccbynd":"ccby":delete a.licence):delete a.licence,a.licence&&(a.licences=[{type:a.licence,terms:""}]),a.score=l(a),W.all_permissions.push(a)}if(m&&e.doi&&(M=await this.src.oadoi(e.doi))&&(null!=M&&null!=(ie=M.best_oa_location)?ie.license:void 0)&&-1!==M.best_oa_location.license.indexOf("cc")&&("string"==typeof(p={can_archive:!0,version:M.best_oa_location.version,versions:[],licence:M.best_oa_location.license,licence_terms:"",licences:[],locations:["institutional repository"],issuer:{type:"article",has_policy:"yes",id:e.doi},meta:{creator:["support@unpaywall.org"],contributors:["support@unpaywall.org"],monitoring:"Automatic",updated:M.best_oa_location.updated},provenance:{oa_evidence:M.best_oa_location.evidence}}).licence&&(p.licences=[{type:p.licence,terms:""}]),p.version&&(p.versions="submittedVersion"===(re=p.version)||"preprint"===re?["submittedVersion"]:"acceptedVersion"===(ne=p.version)||"postprint"===ne?["submittedVersion","acceptedVersion"]:["submittedVersion","acceptedVersion","publishedVersion"]),p.score=l(p),W.all_permissions.push(p)),W.all_permissions.length){for(W.all_permissions.sort((e,t)=>e.score>t.score?1:-1),Y=0,T=(se=W.all_permissions).length;Y<T;Y++){if(!(null!=(le=(Ce=se[Y]).provenance)?le.enforcement_from:void 0)){W.best_permission=this.copy(Ce);break}if(!e.published||moment(e.published,"YYYY-MM-DD").isAfter(moment(Ce.provenance.enforcement_from,"DD/MM/YYYY"))){W.best_permission=this.copy(Ce);break}}if(xe.length)for(xe.sort((e,t)=>e.score>t.score?1:-1),D=0,L=xe.length;D<L;D++)if(we=xe[D],W.all_permissions.push(we),null==(null!=(oe=W.best_permission)?oe.author_affiliation_requirement:void 0)&&null!=W.best_permission&&(!(null!=(ue=we.provenance)?ue.enforcement_from:void 0)||!e.published||moment(e.published,"YYYY-MM-DD").isAfter(moment(we.provenance.enforcement_from,"DD/MM/YYYY")))){for(z=this.copy(W.best_permission),J=0,C=(ce=["licences","versions","locations"]).length;J<C;J++)for($=0,I=(he=we[w=ce[J]]).length;$<I;$++)Te=he[$],null==z[w]&&(z[w]=[]),d.call(z[w],Te)<0&&z[w].push(Te);for(X=0,A=(de=null!=(pe=z.licences)?pe:[]).length;X<A;X++)x=de[X],(null==z.licence||x.type.length<z.licence.length)&&(z.licence=x.type);z.version=d.call(z.versions,"publishedVersion")>=0||d.call(z.versions,"publisher pdf")>=0?"publishedVersion":d.call(z.versions,"acceptedVersion")>=0||d.call(z.versions,"postprint")>=0?"acceptedVersion":"submittedVersion",z.embargo_end&&we.embargo_end&&moment(we.embargo_end,"YYYY-MM-DD").isBefore(moment(z.embargo_end,"YYYY-MM-DD"))&&(z.embargo_end=we.embargo_end),z.embargo_months&&null!=we.embargo_months&&we.embargo_months<z.embargo_months&&(z.embargo_months=we.embargo_months),!0===we.can_archive&&(z.can_archive=!0),null==z.requirements&&(z.requirements={}),z.requirements.author_affiliation_requirement=null==e.ror?we.issuer.id:"string"==typeof e.ror?e.ror:e.ror[0],z.issuer.affiliation=we.issuer,null==z.meta&&(z.meta={}),z.meta.affiliation=we.meta,null==z.provenance&&(z.provenance={}),z.provenance.affiliation=we.provenance,z.score=parseInt(z.score)+parseInt(we.score),W.best_permission=z,W.all_permissions.push(z)}}return B?{body:"string"!=typeof B?B:null!=(fe={"not publisher":"Please find another DOI for this article as this is provided as this doesn’t allow us to find required information like who published it"}[B.toLowerCase()])?fe:B,status:501}:W},r.svc.oaworks.permission=function(e=[]){var t,i,r,n,s,l,o,a,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L,C,I,P,N,U,Y,D,M,B,J;for(u={versionsarchivable:"versions",permissionsrequestcontactemail:"permissions_contact",archivinglocationsallowed:"locations",license:"licence",licencesallowed:"licences","post-printembargo":"embargo_months",depositstatementrequired:"deposit_statement",copyrightowner:"copyright_owner",publicnotes:"notes",authoraffiliationrolerequirement:"requirements.role",authoraffiliationrequirement:"requirements.affiliation",authoraffiliationdepartmentrequirement:"requirements.departmental_affiliation",iffundedby:"requirements.funder",fundingproportionrequired:"requirements.funding_proportion",subjectcoverage:"requirements.subject",has_policy:"issuer.has_policy",permissiontype:"issuer.type",parentpolicy:"issuer.parent_policy",contributedby:"meta.contributors",recordlastupdated:"meta.updated",reviewers:"meta.reviewer",addedby:"meta.creator",monitoringtype:"meta.monitoring",policyfulltext:"provenance.archiving_policy",policylandingpage:"provenance.archiving_policy_splash",publishingagreement:"provenance.sample_publishing_agreement",publishingagreementsplash:"provenance.sample_publishing_splash",rights:"provenance.author_rights",embargolist:"provenance.embargo_list",policyfaq:"provenance.faq",miscsource:"provenance.misc_source",enforcementdate:"provenance.enforcement_from",example:"provenance.example"},R=[],J=0,m=e.length;J<m;J++){T=e[J],j={can_archive:!1,version:void 0,versions:void 0,licence:void 0,licence_terms:void 0,licences:void 0,locations:void 0,embargo_months:void 0,embargo_end:void 0,deposit_statement:void 0,permission_required:void 0,permissions_contact:void 0,copyright_owner:void 0,copyright_name:void 0,copyright_year:void 0,notes:void 0,requirements:void 0,issuer:{},meta:{},provenance:void 0};try{if(T.recordlastupdated=T.recordlastupdated.trim(),-1!==T.recordlastupdated.indexOf(",")){for(O=!1,L=T.recordlastupdated.split(","),s=0,y=L.length;s<y;s++)n=L[s],(!1===O||moment(n.trim(),"DD/MM/YYYY").isAfter(moment(O,"DD/MM/YYYY")))&&(O=n.trim());!1!==O&&(T.recordlastupdated=O)}j.meta.updated=T.recordlastupdated}catch(e){}if(null!=j.meta.updated&&(j.meta.updatedAt=moment(j.meta.updated,"DD/MM/YYYY").valueOf()),j.issuer.id=-1!==T.id.indexOf(",")?T.id.split(","):T.id,"string"!=typeof j.issuer.id){for(r=[],!1,l=0,g=(C=j.issuer.id).length;l<g;l++){if(k=(k=C[l]).trim(),"journal"===j.issuer.type&&-1!==k.indexOf("-")&&-1===k.indexOf(" ")&&(k=k.toUpperCase(),t=academic_journal.find('issn.exact:"'+k+'"')))for(!0,a=0,v=(I=t.issn).length;a<v;a++)i=I[a],d.call(r,i)<0&&r.push(i);d.call(r,k)<0&&r.push(k)}j.issuer.id=r}for(o in j.permission_required=null!=T.has_policy&&-1!==T.has_policy.toLowerCase().indexOf("permission required"),T)if(u[o]&&null!=T[o]&&0!==T[o].length){if(q=u[o],S=void 0,"post-printembargo"===o)try{"number"!=typeof(c=parseInt(T[o].trim()))||isNaN(c&&0!==c)||(S=c),null!=S&&(j.embargo_end="")}catch(e){}else if("journal"===o||"versionsarchivable"===o||"archivinglocationsallowed"===o||"licencesallowed"===o||"policyfulltext"===o||"contributedby"===o||"addedby"===o||"reviewers"===o||"iffundedby"===o)for(S=[],p=0,b=(P=E=T[o].trim().split(",")).length;p<b;p++)if(B=(M=P[p]).trim(),"licencesallowed"===o){if("unclear"!==B.toLowerCase()){f={type:B.toLowerCase()};try{f.terms=T.licenceterms.split(",")[E.indexOf(M)].trim()}catch(e){}S.push(f)}}else"versionsarchivable"===o&&("preprint"===(B=B.toLowerCase())&&(B="submittedVersion"),"postprint"===B&&(B="acceptedVersion"),"publisher pdf"===B&&(B="publishedVersion")),B.length&&d.call(S,B)<0&&S.push("archivinglocationsallowed"===o?B.toLowerCase():B);else"recordlastupdated"!==o&&(S=T[o].trim());"string"!=typeof S||"yes"!==(N=S.toLowerCase())&&"no"!==N&&"haspolicy"!==o&&"permissiontype"!==o&&"copyrightowner"!==o||(S=S.toLowerCase()),"copyrightowner"!==o&&"license"!==o||"unclear"!==S||(S=""),null!=S&&(-1!==q.indexOf(".")?(null==j[x=(A=q.split("."))[0]]&&(j[x]={}),j[A[0]][[A[1]]]=S):j[q]=S)}if(null==j.licences&&(j.licences=[]),!j.licence)for(w=0,_=(U=j.licences).length;w<_;w++)h=U[w],(null==j.licence||h.type.length<j.licence.length)&&(j.licence=h.type,j.licence_terms=h.terms);null==j.versions&&(j.versions=[]),j.versions.length&&(j.can_archive=!0,j.version=d.call(j.versions,"acceptedVersion")>=0||d.call(j.versions,"postprint")>=0?"acceptedVersion":d.call(j.versions,"publishedVersion")>=0||d.call(j.versions,"publisher pdf")>=0?"publishedVersion":"submittedVersion"),null==j.copyright_owner&&(j.copyright_owner=null!=(Y=null!=(D=j.issuer)?D.type:void 0)?Y:""),null==j.copyright_name&&(j.copyright_name=""),null==j.copyright_year&&(j.copyright_year=""),"{}"!==!JSON.stringify(j)&&R.push(j)}return R.length&&(oab_permissions.remove("*"),oab_permissions.insert(R)),R.length},r.svc.oaworks.permission._sheet="1qBb0RV1XgO3xOQMdHJBAf3HCJlUgsXqDVauWAtxde4A",r.svc.oaworks.metadata=async function(){return(await this.svc.oaworks.find()).metadata},r.svc.oaworks.find=async function(e,t={},i){var r,n,s,l,o,a,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O;w={},n=async e=>{var i,r,n;for(r in n=[],i=await this.svc.oaworks.citation(e))"url"===r||"paywall"===r?n.push(null!=w[r]?w[r]:w[r]=i[r]):n.push(null!=t[r]?t[r]:t[r]=i[r]);return n};try{null==e&&(e=this.copy(this.params))}catch(e){}null==e&&(e={}),null==e.doi&&(e.doi=e.find),null==i&&(i=null!=(d=e.dom)?d:this.request.body),(e.q||e.id)&&(e.url=null!=(f=e.q)?f:e.id),e.url&&("number"==typeof e.url&&(e.url=e.url.toString()),-1!==e.url.indexOf("/10.")&&-1!==(u="10."+e.url.split("/10.")[1].split("&")[0].split("#")[0]).indexOf("/")&&u.split("/")[0].length>6&&u.length>8&&((c=u.split("/")).length>2&&(u=c.join("/")),null==t.doi&&(t.doi=u)),0===e.url.replace("doi:","").replace("doi.org/","").trim().indexOf("10.")?(null==t.doi&&(t.doi=e.url.replace("doi:","").replace("doi.org/","").trim()),e.url="https://doi.org/"+t.doi):0===e.url.toLowerCase().indexOf("pmc")?(null==t.pmcid&&(t.pmcid=e.url.toLowerCase().replace("pmcid","").replace("pmc","")),e.url="http://europepmc.org/articles/PMC"+t.pmcid):e.url.replace(/pmid/i,"").replace(":","").length<10&&-1===e.url.indexOf(".")&&!isNaN(parseInt(e.url.replace(/pmid/i,"").replace(":","").trim()))?(null==t.pmid&&(t.pmid=e.url.replace(/pmid/i,"").replace(":","").trim()),e.url="https://www.ncbi.nlm.nih.gov/pubmed/"+t.pmid):null==t.title&&0!==e.url.indexOf("http")&&(-1!==e.url.indexOf("{")||(null!=(m=e.url.replace("...","").match(/\./gi))?m:[]).length>3||(null!=(y=e.url.match(/\(/gi))?y:[]).length>2?e.citation=e.url:t.title=e.url),0===e.url.indexOf("http")&&-1!==e.url.indexOf(".")||delete e.url),e.title&&(-1!==e.title.indexOf("{")||(null!=(g=e.title.replace("...","").match(/\./gi))?g:[]).length>3||(null!=(v=e.title.match(/\(/gi))?v:[]).length>2)&&(e.citation=e.title,delete e.title),null==t.doi&&(t.doi=e.doi),null==t.title&&(t.title=e.title),null==t.pmid&&(t.pmid=e.pmid),null==t.pmcid&&(t.pmcid=null!=(b=e.pmcid)?b:e.pmc),e.citation&&await n(e.citation);try{t.title=t.title.replace(/(<([^>]+)>)/g,"").replace(/\+/g," ").trim()}catch(e){}try{t.doi=t.doi.split(" ")[0].replace("http://","").replace("https://","").replace("doi.org/","").replace("doi:","").trim()}catch(e){}if("string"==typeof t.doi&&0===t.doi.indexOf("10.")||delete t.doi,t.title||!i||"string"!=typeof e.url||-1===e.url.indexOf("alma.exlibrisgroup.com")&&-1===e.url.indexOf("/exlibristest")||delete e.url,l=async()=>{var r,s,l,o,a,u,c;return null==i&&null==e.url||t.doi||null!=t.pmid||null!=t.pmcid||null!=t.title||await n(await this.svc.oaworks.scrape(null!=i?i:e.url)),t.doi||((t.pmid||t.pmcid)&&(u=await this.src.epmc[t.pmcid?"pmc":"pmid"](null!=(c=t.pmcid)?c:t.pmid),await n(u)),t.title&&!t.doi&&(s=async()=>(t.doi||await n(await this.src.crossref.works(t.title)),!0),l=async()=>(t.doi||await n(await this.src.microsoft.graph(t.title)),!0),a=async()=>(null!=u||t.doi||await n(await this.src.epmc.title(t.title)),!0),await Promise.all([s(),l(),a()]))),t.doi&&(o=async()=>{var e;return(null!=(e=await this.src.oadoi(t.doi))?e.doi:void 0)===t.doi&&await n(e),!0},r=async()=>{var i;return(null!=(i=await this.src.crossref.works(t.doi))?i.type:void 0)?await n(i):(w.doi_not_in_crossref=t.doi,"string"==typeof e.url&&-1!==e.url.indexOf("doi.org/"+t.doi)&&delete e.url,delete t.doi),!0},await Promise.all([o(),r()])),!0},await l(),t.title&&!t.doi&&!i&&!e.url&&("undefined"==typeof epmc||null===epmc))try{p=unidecode(t.title.toLowerCase()).replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),null!=(null!=(a=await this.src.microsoft.bing.search(p))?a.data:void 0)&&a.data.length&&(o=unidecode(a.data[0].name.toLowerCase()).replace("(pdf)","").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," "),0!==p.replace(/ /g,"").indexOf(o.replace(/ /g,""))||await this.svc.oaworks.blacklist(a.data[0].url)||(e.url=a.data[0].url.replace(/"/g,""),"string"==typeof e.url&&-1!==e.url.indexOf("pubmed.ncbi")&&(t.pmid=e.url.replace(/\/$/,"").split("/").pop()),"string"==typeof e.url&&-1!==e.url.indexOf("/10.")&&null==t.doi&&(t.doi="10."+e.url.split("/10.")[1]))),(t.doi||t.pmid||e.url)&&await l()}catch(e){}for(r=async()=>{var i,r,n,s;if((t.doi||t.title)&&(null!=e.from||null!=e.config)&&("instantill"===e.plugin||!0===e.ill)){null==w.ill&&(w.ill={});try{w.ill.terms=null!=(r=null!=(n=e.config)?n.terms:void 0)?r:await this.svc.oaworks.ill.terms(e.from)}catch(e){}try{w.ill.openurl=await this.svc.oaworks.ill.openurl(null!=(s=e.config)?s:e.from,t)}catch(e){}try{w.ill.subscription=await this.svc.oaworks.ill.subscription(null!=(i=e.config)?i:e.from,t,w.refresh)}catch(e){}}return!0},s=async()=>{var i;return t.doi&&(e.permissions||"shareyourpaper"===e.plugin)&&null==w.permissions&&(w.permissions=await this.svc.oaworks.permissions(t,null!=(i=e.config)?i:e.from)),!0},await Promise.all([r(),s()]),O=0,h=(_=["title","journal","year","doi"]).length;O<h;O++)e[x=_[O]]&&e[x]!==t[x]&&(t[x]=e[x]);return w.metadata=t,w},r.svc.oaworks.citation=function(e){var t,i,r,n,s,l,o,a,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,ce,he,pe,de,fe,me,ye,ge,ve,be;fe={};try{null==e&&(e=null!=(R=this.params.citation)?R:this.params)}catch(e){}if("string"==typeof e&&(0===e.indexOf("{")||0===e.indexOf("[")))try{e=JSON.parse(options.citation)}catch(e){}if("object"==typeof e){null==fe.doi&&(fe.doi=null!=(T=e.DOI)?T:e.doi);try{null==fe.type&&(fe.type=null!=(J=e.type)?J:e.genre)}catch(e){}null==fe.issn&&(fe.issn=null!=(Z=null!=(ae=null!=(ue=e.ISSN)?ue:e.issn)?ae:null!=(ce=e.journalInfo)&&null!=(he=ce.journal)?he.issn:void 0)?Z:null!=(pe=e.journal)?pe.issn:void 0),e.journal_issns&&null==fe.issn&&(fe.issn=e.journal_issns.split(","));try{Array.isArray(e.title)&&null==fe.title&&(fe.title=e.title[0])}catch(e){}try{null!=e.subtitle&&e.subtitle.length&&e.subtitle[0].length&&(fe.title+=": "+e.subtitle[0])}catch(e){}null==fe.title&&(fe.title=null!=(de=e.dctitle)?de:null!=(L=e.bibjson)?L.title:void 0),404!==(C=e.title)&&"404"!==C&&null==fe.title&&(fe.title=e.title),fe.title&&(fe.title=fe.title.replace(/\s\s+/g," ").trim());try{null==fe.journal&&(fe.journal=e["container-title"][0])}catch(e){}try{fe.shortname=e["short-container-title"][0]}catch(e){}null==fe.journal&&(fe.journal=null!=(I=null!=(P=e.journal_name)?P:null!=(N=e.journalInfo)&&null!=(U=N.journal)?U.title:void 0)?I:null!=(Y=e.journal)?Y.title:void 0),e.journal&&(fe.journal=e.journal.split("(")[0].trim()),null==fe.publisher&&(fe.publisher=e.publisher);try{null!=e.issue&&null==fe.issue&&(fe.issue=e.issue)}catch(e){}try{null!=e.volume&&null==fe.volume&&(fe.volume=e.volume)}catch(e){}try{null!=e.page&&null==fe.page&&(fe.page=e.page.toString())}catch(e){}for(be=0,d=(D=["title","journal"]).length;be<d;be++)fe[c=D[be]]||"string"!=typeof e[c]||e[c].charAt(0).toUpperCase()===e[c].charAt(0)&&e[c].toUpperCase()!==e.key&&e[c].toLowerCase()!==e.key||(fe[c]=e[c].charAt(0).toUpperCase()+e[c].slice(1));if(null==fe.year&&(null!=e.year||null!=e.published||null!=e.published_date)){try{for(V=(null!=(z=null!=(W=e.year)?W:e.published)?z:e.published_date).split(-1!==(null!=(M=null!=(B=e.year)?B:e.published)?M:e.published_date).indexOf("/")?"/":"-"),o=0,f=V.length;o<f;o++)4===(O=V[o]).length&&null==fe.year&&(fe.year=O)}catch(e){}try{"number"==typeof fe.year||4===fe.year.length&&0===fe.year.replace(/[0-9]/gi,"").length||delete fe.year}catch(e){}"number"==typeof fe.year&&(fe.year=fe.year.toString())}if(null==fe.year&&null==fe.published)for(a=0,m=(F=["published-print","journal-issue.published-print","issued","published-online","created","deposited","indexed"]).length;a<m;a++){A=F[a];try{if(ge=null!=($=e[A])?$:null!=(G=e["journal-issue"])?G[A.replace("journal-issue.","")]:void 0){if("string"==typeof ge["date-time"]&&-1!==ge["date-time"].indexOf("T")&&3===ge["date-time"].split("T")[0].split("-").length){null==fe.published&&(fe.published=ge["date-time"].split("T")[0]),null==fe.year&&(fe.year=fe.published.split("-")[0]);break}if(null!=ge["date-parts"]&&ge["date-parts"].length&&Array.isArray(ge["date-parts"][0])&&ge["date-parts"][0].length&&(j=(ye=ge["date-parts"][0])[0].toString()).length>2){null==fe.year&&(fe.year=j),1===ye.length?j+="-01-01":(w=!1,l=!1,!isNaN(parseInt(ye[1]))&&parseInt(ye[1])>12?l=ye[1].toString():w=ye[1].toString(),2===ye.length&&(!1!==l?w=ye[2].toString():l=ye[2].toString()),j+="-"+(w=!1===w?"01":1===w.length?"0"+w:w)+"-"+(l=!1===l?"01":1===l.length?"0"+l:l)),null==fe.published&&(fe.published=j);break}}}catch(e){}}try{if(null==fe.author&&(null!=e.author||null!=e.z_authors))for(null==fe.author&&(fe.author=[]),H=null!=(X=e.author)?X:e.z_authors,u=0,y=H.length;u<y;u++)"string"==typeof(t=H[u])?fe.author.push({name:t}):(null!=t.affiliation&&(Array.isArray(t.affiliation)&&(t.affiliation=t.affiliation[0]),"string"==typeof t.affiliation&&(t.affiliation={name:t.affiliation})),fe.author.push(t))}catch(e){}try{(null!=(K=e.best_oa_location)?K.license:void 0)&&null!==(null!=(Q=e.best_oa_location)?Q.license:void 0)&&null==fe.licence&&(fe.licence=e.best_oa_location.license)}catch(e){}if(Array.isArray(e.assertion))for(p=0,g=(ee=e.assertion).length;p<g;p++)"OPEN ACCESS"===(t=ee[p]).label&&t.URL&&-1!==t.URL.indexOf("creativecommons")&&null==fe.licence&&(fe.licence=t.URL);if(Array.isArray(e.license))for(x=0,v=(ie=null!=(te=e.license)?te:[]).length;x<v;x++)!(h=ie[x]).URL||-1===h.URL.indexOf("creativecommons")||rec.licence&&-1!==rec.licence.indexOf("creativecommons")||null==fe.licence&&(fe.licence=h.URL);"string"==typeof e.license&&null==fe.licence&&(fe.licence=e.license),"string"==typeof fe.licence&&-1!==fe.licence.indexOf("/licenses/")&&(fe.licence="cc-"+rec.licence.split("/licenses/")[1].replace(/$\//,"").replace(/\//g,"-")),null==fe.url&&(fe.url=null!=(re=null!=(ne=null!=(se=e.best_oa_location)?se.url_for_pdf:void 0)?ne:null!=(le=e.best_oa_location)?le.url:void 0)?re:e.url)}else if("string"==typeof e)try{-1!==(e=e.replace(/citation\:/gi,"").trim()).indexOf("title")&&(e=e.split("title")[1].trim()),-1!==(e=e.replace(/^"/,"").replace(/^'/,"").replace(/"$/,"").replace(/'$/,"")).indexOf("doi:")&&(fe.doi=e.split("doi:")[1].split(",")[0].split(" ")[0].trim()),-1!==e.indexOf("doi.org/")&&(fe.doi=e.split("doi.org/")[1].split(",")[0].split(" ")[0].trim()),fe.doi||-1===e.indexOf("http")||(fe.url="http"+e.split("http")[1].split(" ")[0].trim());try{-1===e.indexOf("|")&&-1===e.indexOf("}")||(fe.title=e.split("|")[0].split("}")[0].trim()),e.split('"').length>2?fe.title=e.split('"')[1].trim():e.split("'").length>2&&null==fe.title&&(fe.title=e.split("'")[1].trim())}catch(e){}try{for(E=e.replace(/,\./g," ").split(" "),k=0,b=E.length;k<b;k++)S=E[k],fe.year||4===(S=S.replace(/[^0-9]/g,"")).length&&("number"!=typeof(ve=parseInt(S))||isNaN(ve)||(fe.year=ve))}catch(e){}try{!fe.title&&fe.year&&e.indexOf(fe.year)<e.length/4&&(fe.title=e.split(fe.year)[1].trim(),(-1===fe.title.indexOf("(")||fe.title.indexOf(")")<fe.title.indexOf("("))&&(fe.title=fe.title.replace(")","")),fe.title.indexOf(".")<3&&(fe.title=fe.title.replace(".","")),fe.title.indexOf(",")<3&&(fe.title=fe.title.replace(",","")),fe.title=fe.title.trim(),-1!==fe.title.indexOf(".")?fe.title=fe.title.split(".")[0]:-1!==fe.title.indexOf(",")&&(fe.title=fe.title.split(",")[0]))}catch(e){}if(fe.title){try{if(r=e.split(fe.title)[0],fe.year&&-1!==r.indexOf(fe.year)&&(r=r.split(fe.year)[0]),fe.url&&r.indexOf(fe.url)>0&&(r=r.split(fe.url)[0]),fe.url&&0===r.indexOf(fe.url)&&(r=r.replace(fe.url)),fe.doi&&0===r.indexOf(fe.doi)&&(r=r.replace(fe.doi)),r.indexOf(".")<3&&(r=r.replace(".","")),r.indexOf(",")<3&&(r=r.replace(",","")),r.lastIndexOf("(")>r.length-3&&(r=r.substring(0,r.lastIndexOf("("))),r.lastIndexOf(")")>r.length-3&&(r=r.substring(0,r.lastIndexOf(")"))),r.lastIndexOf(",")>r.length-3&&(r=r.substring(0,r.lastIndexOf(","))),r.lastIndexOf(".")>r.length-3&&(r=r.substring(0,r.lastIndexOf("."))),(r=r.trim()).length>6)if(-1!==r.indexOf(","))for(fe.author=[],oe=r.split(","),q=0,_=oe.length;q<_;q++)i=oe[q],fe.author.push({name:i});else fe.author=[{name:r}]}catch(e){}try{me=e.split(fe.title)[1],fe.url&&-1!==me.indexOf(fe.url)&&(me=me.replace(fe.url)),fe.doi&&-1!==me.indexOf(fe.doi)&&(me=me.replace(fe.doi)),me.indexOf(".")<3&&(me=me.replace(".","")),me.indexOf(",")<3&&(me=me.replace(",","")),(me=me.trim()).length>6&&(fe.journal=me,-1!==me.indexOf(",")&&(fe.journal=fe.journal.split(",")[0].replace(/in /gi,"").trim()),fe.journal.indexOf(".")<3&&(fe.journal=fe.journal.replace(".","")),fe.journal.indexOf(",")<3&&(fe.journal=fe.journal.replace(",","")),fe.journal=fe.journal.trim())}catch(e){}}try{if(fe.journal&&(me=e.split(fe.journal)[1],fe.url&&-1!==me.indexOf(fe.url)&&(me=me.replace(fe.url)),fe.doi&&-1!==me.indexOf(fe.doi)&&(me=me.replace(fe.doi)),me.indexOf(".")<3&&(me=me.replace(".","")),me.indexOf(",")<3&&(me=me.replace(",","")),(me=me.trim()).length>4)){if(-1!==me.indexOf("retrieved")&&(me=me.split("retrieved")[0]),-1!==me.indexOf("Retrieved")&&(me=me.split("Retrieved")[0]),fe.volume=me,-1!==fe.volume.indexOf("(")){fe.volume=fe.volume.split("(")[0],fe.volume=fe.volume.trim();try{fe.issue=me.split("(")[1].split(")")[0],fe.issue=fe.issue.trim()}catch(e){}}if(-1!==fe.volume.indexOf(",")){fe.volume=fe.volume.split(",")[0],fe.volume=fe.volume.trim();try{fe.issue=me.split(",")[1],fe.issue=fe.issue.trim()}catch(e){}}if(fe.volume)try{isNaN(parseInt(fe.volume))&&delete fe.volume}catch(e){}if(fe.issue){-1!==fe.issue.indexOf(",")&&(fe.issue=fe.issue.split(",")[0].trim());try{isNaN(parseInt(fe.issue))&&delete fe.issue}catch(e){}}if(fe.volume&&fe.issue)try{-1!==(me=e.split(fe.journal)[1]).indexOf("retriev")&&(me=me.split("retriev")[0]),-1!==me.indexOf("Retriev")&&(me=me.split("Retriev")[0]),fe.url&&-1!==me.indexOf(fe.url)&&(me=me.split(fe.url)[0]),fe.doi&&-1!==me.indexOf(fe.doi)&&(me=me.split(fe.doi)[0]),(me=(me=me.substring(me.indexOf(fe.volume)+(fe.volume+"").length)).substring(me.indexOf(fe.issue)+(fe.issue+"").length)).indexOf(".")<2&&(me=me.replace(".","")),me.indexOf(",")<2&&(me=me.replace(",","")),me.indexOf(")")<2&&(me=me.replace(")","")),me=me.trim(),isNaN(parseInt(me.substring(0,1)))||(fe.pages=me.split(" ")[0].split(".")[0].trim(),fe.pages.length>5&&(fe.pages=fe.pages.split(", ")[0]))}catch(e){}}}catch(e){}if(fe.author||-1===e.indexOf("et al")||(s=e.split("et al")[0].trim(),0===e.indexOf(s)&&(fe.author=[{name:s+"et al"}])),fe.title&&!fe.volume)try{-1!==(n=e.split(fe.title)[1].toLowerCase().replace("volume","vol").replace("vol.","vol").replace("issue","iss").replace("iss.","iss").replace("pages","page").replace("pp","page")).indexOf("vol")&&(fe.volume=n.split("vol")[1].split(",")[0].split("(")[0].split(".")[0].split(" ")[0].trim()),fe.issue||-1===n.indexOf("iss")||(fe.issue=n.split("iss")[1].split(",")[0].split(".")[0].split(" ")[0].trim()),fe.pages||-1===n.indexOf("page")||(fe.pages=n.split("page")[1].split(".")[0].split(", ")[0].split(" ")[0].trim())}catch(e){}}catch(e){}return fe},r.svc.oaworks.scrape=async function(e,t){var i,r,n,s,l,o,a,u,c,h,p,d,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S;if(y={doi:t},"string"==typeof e&&e.startsWith("http")&&(y.doi||(j=new RegExp(/\/(10\.[^ &#]+\/[^ &#]+)$/).exec(decodeURIComponent(e)))&&j.length>1&&9<j[1].length&&j[1].length<45&&-1!==j[1].indexOf("/")&&0===j[1].indexOf("10.")&&(y.doi=j[1]),null==e&&(e=await this.fetch(url))),"string"!=typeof e)return{};if(0!==e.indexOf("<")&&e.length>6e3?e=e.substring(0,6e3):e.length>5e4&&(e=e.substring(0,5e4)),!y.doi)try{-1!==(i=e.toLowerCase()).indexOf("dc.identifier")&&(-1!==(i=i.split("dc.identifier")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(y.doi=i))}catch(e){}if(!y.doi)try{null==i&&(i=e.toLowerCase()),-1!==i.indexOf("citation_doi")&&(-1!==(i=i.split("citation_doi")[1].split("content")[1]).indexOf('"')&&(i=i.split('"')[1]),-1!==i.indexOf("'")&&(i=i.split("'")[1]),0===i.indexOf("10.")&&-1!==i.indexOf("/")&&(y.doi=i))}catch(e){}if(!y.doi)for(r=0,S=0,c=(O=e.split(" ")).length;S<c;S++)if(A=O[S],(r+=1)<600&&(-1!==(A=A.replace(/ /g,"").replace("doi:","")).indexOf("doi.org")&&(A=A.split("doi.org")[1]),0===A.indexOf("/")&&(A=A.replace("/","")),0===(A=A.trim()).indexOf("10.")&&-1!==A.indexOf("/"))){y.doi=A;break}if(!y.doi)try{for(k=(n=this.tdm.extract({content:e,matchers:["/doi[^>;]*?(?:=|:)[^>;]*?(10[.].*?/.*?)(\"|')/gi","/doi[.]org/(10[.].*?/.*?)(\"| ')/gi"]})).matches,s=0,h=k.length;s<h;s++)x=k[s],!y.doi&&9<n.matches[x].result[1].length&&n.matches[x].result[1].length<45&&(y.doi=n.matches[x].result[1],y.doi.endsWith(".")&&(y.doi=y.doi.substring(0,y.doi.length-1)))}catch(e){}if(y.doi&&(y.doi=y.doi.split(" ")[0]),y.title||(-1!==(i=e.toLowerCase()).indexOf("requestdisplaytitle")?y.title=i.split("requestdisplaytitle").pop().split(">")[1].split("<")[0].trim().replace(/"/g,""):-1!==i.indexOf("dc.title")?y.title=i.split("dc.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("eprints.title")?y.title=i.split("eprints.title")[1].replace(/'/g,'"').split("content=")[1].split('"')[1].trim().replace(/"/g,""):-1!==i.indexOf("og:title")?(y.title=i.split("og:title")[1].split("content")[1].split("=")[1].replace("/>",">").split(">")[0].trim().replace(/"/g,""),y.title.startsWith("'")&&(y.title=y.title.substring(1,y.title.length-1))):-1!==i.indexOf('"citation_title" ')?y.title=i.split('"citation_title" ')[1].replace(/ = /,"=").split('content="')[1].split('"')[0].trim().replace(/"/g,""):-1!==i.indexOf("<title")&&(y.title=i.split("<title")[1].split(">")[1].split("</title")[0].trim().replace(/"/g,""))),y.title&&-1!==y.title.indexOf("|")&&(y.title=y.title.split("|")[0].trim()),!y.year)try{if(1===(g=this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')citation_date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')dc.date(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi","/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')prism.publicationDate(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"}).matches[0].result[1].split("-")).length)y.year=g[0];else for(l=0,p=g.length;l<p;l++)(w=g[l]).length>2&&(y.year=w)}catch(e){}if(!y.keywords)try{-1!==(a=this.tdm.extract({content:e,matchers:["/meta[^>;\"']*?name[^>;\"']*?= *?(?:\"|')keywords(?:\"|')[^>;\"']*?content[^>;\"']*?= *?(?:\"|')(.*?)(?:\"|')/gi"],start:"<head",end:"</head"}).matches[0].result[1]).indexOf(";")?(a=a.replace(/; /g,";").replace(/ ;/g,";"),y.keywords=a.split(";")):(a=a.replace(/, /g,",").replace(/ ,/g,","),y.keywords=a.split(","))}catch(e){}if(!y.email){v=[];try{for(q=this.tdm.extract({content:e,matchers:["/mailto:([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"]}).matches,o=0,d=q.length;o<d;o++)(b=q[o].result[1].replace("mailto:","")).endsWith(".")&&(b=b.substring(0,b.length-1)),-1===v.indexOf(b)&&v.push(b)}catch(e){}for(v.sort((function(e,t){return t.length-e.length})),_="",y.email=[],u=0,f=v.length;u<f;u++)m=v[u],-1===_.indexOf(m)&&y.email.push(m),_+=m}return y},r.svc.oaworks.ill=async function(){var e,t,i,r,n,s,l,o,a,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,q,A,j;for(h in m=this.params,this.user&&(null==m.from&&(m.from=this.user._id),m.api=!0),null==(m=await this.tdm.clean(m)).metadata&&(m.metadata={}),p=this.svc.oaworks.metadata(m))null==(n=m.metadata)[h]&&(n[h]=p[h]);if(!0===m.pilot&&(m.pilot=Date.now()),!0===m.live&&(m.live=Date.now()),"imperial"===m.library)return m.forwarded||m.resolved||(this.mail({service:"openaccessbutton",from:"natalia.norori@openaccessbutton.org",to:["joe@righttoresearch.org","s.barron@imperial.ac.uk"],subject:"EXAMPLE ILL TRIGGER",text:JSON.stringify(m,void 0,2)}),this.waitUntil(this.fetch("https://www.imperial.ac.uk/library/dynamic/oabutton/oabutton3.php",{body:m,method:"POST"}))),m;if(null!=m.from||null!=m.config){if("anonymous"!==m.from&&(q=this.auth(m.from)),null!=q||null!=m.config){for(f in(s=m.config).requests&&null==s.requests_off&&(s.requests_off=s.requests),null!=m.config&&delete m.config,(A={}).name=null!=(v=null!=q&&null!=(b=q.profile)?b.firstname:void 0)?v:"librarian",A.details="",y=["title","author","volume","issue","date","pages"],m)if("metadata"===f){for(h in m[f])"email"!==h&&(m[h]=m[f][h],d.call(y,h)<0&&y.push(h));delete m.metadata}else d.call(y,f)<0&&y.push(f);for(j=0,u=y.length;j<u;j++)if(m[g=y[j]])if(A[g]=m[g],"author"===g){for(r="<p>Authors:<br>",o=!0,i=[],a=0,c=(_=m[g]).length;a<c;a++)(e=_[a]).family&&(o?o=!1:r+=", ",r+=t=e.family+(e.given?" "+e.given:""),i.push(t));A.details+=r+"</p>",A[g]=i}else-1===["started","ended","took"].indexOf(g)&&(A.details+="<p>"+g+":<br>"+m[g]+"</p>");return s.requests_off&&(m.requests_off=!0),null!=m.author&&delete m.author,null!=(null!=(w=m.metadata)?w.author:void 0)&&delete m.metadata.author,A.details+="<p>Open access button ILL ID:<br>"+A.illid+"</p>",l=s.email&&s.email.length?s.email:!!(null!=q?q.email:void 0)&&(null!=q?q.email:void 0),s.search&&s.search.length&&(m.issn||m.journal)&&(-1!==s.search.indexOf("worldcat")?(O=s.search.split("?")[0]+"?ai0id=level3&ai0type=scope&offset=1&pageSize=10&si0in=",O+=null!=m.issn?"in%3A":"ti%3A",O+="&si0qs="+(null!=(x=m.issn)?x:m.journal),O+="&sortDirection=descending&sortKey=librarycount&applicationId=nd&requestType=search&searchType=advancedsearch&eventSource=df-advancedsearch"):(O=s.search,O+=m.issn?m.issn:m.journal),A.details+='<p>Search URL:<br><a href="'+O+'">'+O+"</a></p>",A.worldcatsearchurl=O),m.forwarded||m.resolved||!l||this.svc.oaworks.mail({vars:A,template:{filename:"instantill_create.html"},to:l,from:"InstantILL <InstantILL@openaccessbutton.org>",subject:"ILL request "+A.illid}),k=A.details,delete A.details,k+="<br><br>"+JSON.stringify(A,void 0,2),this.mail({service:"openaccessbutton",from:"InstantILL <InstantILL@openaccessbutton.org>",to:["mark@cottagelabs.com","joe@righttoresearch.org"],subject:"ILL CREATED",html:k,text:k}),A.illid}return{status:401}}return{status:404}},r.svc.oaworks.ill.collect=function(){var e,t;for(e in t="https://script.google.com/macros/s/"+this.params.collect+"/exec?",this.params)"collect"!==e&&(t+=e+"="+this.params[e]+"&");return t+="uuid="+this.uid(),this.waitUntil(this.fetch(t)),!0},r.svc.oaworks.ill.openurl=async function(){var e,t,i,r,n,s,l,o,a,u,c,h,p,d,f;if(null!=(a=this.params).config&&(null==a.uid&&(a.uid=a.config),delete a.config),null!=a.metadata){for(l in a.metadata)null==a[l]&&(a[l]=a.metadata[l]);delete a.metadata}if(a.uid||null!=this.user){if(null==(t="object"==typeof(h=null!=(u=(a=await this.tdm.clean(a)).uid)?u:this.user._id)?h:void 0)&&(t={}),t.ill_redirect_base_url&&null==t.ill_form&&(t.ill_form=t.ill_redirect_base_url),t.ill_redirect_params&&null==t.ill_added_params&&(t.ill_added_params=t.ill_redirect_params),!0!==withoutbase&&!t.ill_form)return"";for(i in r={sid:"sid",title:"atitle",doi:"rft_id",pmcid:"pmcid",author:"aulast",journal:"title",page:"pages",published:"date",year:"rft.year"})t[i]||(t[i]=r[i]);for(n in p=t.ill_form?t.ill_form:"",p+=-1===p.indexOf("?")?"?":"&",t.ill_added_params&&(p+=t.ill_added_params.replace("?","")+"&"),p+=t.sid+"=InstantILL&",meta){if(d=!1,"author"===n)try{if("string"==typeof meta.author)d=meta.author;else if(Array.isArray(meta.author))for(d="",c=meta.author,f=0,s=c.length;f<s;f++)e=c[f],d.length&&(d+=", "),"string"==typeof e?d+=e:e.family&&(d+=e.family+(e.given?", "+e.given:""));else d=meta.author.family?meta.author.family+(meta.author.given?", "+meta.author.given:""):JSON.stringify(meta.author)}catch(e){}else"doi"!==n&&"pmid"!==n&&"pmc"!==n&&"pmcid"!==n&&"url"!==n&&"journal"!==n&&"title"!==n&&"year"!==n&&"issn"!==n&&"volume"!==n&&"issue"!==n&&"page"!==n&&"crossref_type"!==n&&"publisher"!==n&&"published"!==n&&"notes"!==n||(d=meta[n]);d&&(p+=(t[n]?t[n]:n)+"="+encodeURIComponent(d)+"&")}return meta.usermetadata&&(o=t.notes?t.notes:"notes",-1===(p=p.replace("usermetadata=true","")).indexOf(o+"=")?p+="&"+o+"=The user provided some metadata.":p=p.replace(o+"=",o+"=The user provided some metadata. ")),p.replace("/&&/g","&")}return{status:404}},r.svc.oaworks.ill.subscription=async function(e,t){var i,r,n,s,l,o,a,u,c,h,p,d,f,m,y,g,v,b;if(null==e&&(e=null!=(o=this.user)?o:this.params.uid),null==t&&delete(t=JSON.parse(JSON.stringify(this.params))).uid,!0,!0,p={findings:{},lookups:[],error:[],contents:[]},"string"==typeof e?(p.uid=e,i=null!=(b=this.auth(e))&&null!=(a=b.service)&&null!=(u=a.openaccessbutton)&&null!=(c=u.ill)?c.config:void 0):i=e,null!=(null!=i?i.subscription:void 0))for(d in i.ill_redirect_params&&null==i.ill_added_params&&(i.ill_added_params=i.ill_redirect_params),s=this.svc.oaworks.ill.openurl(i,t,!0),i.ill_added_params&&(s=s.replace(i.ill_added_params.replace("?",""),"")),-1!==s.indexOf("?")&&(s=s.split("?")[1]),"string"==typeof i.subscription&&(i.subscription=i.subscription.split(",")),"string"==typeof i.subscription_type&&(i.subscription_type=i.subscription_type.split(",")),null==i.subscription_type&&(i.subscription_type=[]),i.subscription)if("object"==typeof(m=i.subscription[d])?(y=m.type,m=m.url):y=null!=(h=i.subscription_type[d])?h:"unknown",m=m.trim()){"serialssolutions"!==y&&-1===m.indexOf("serialssolutions")||-1!==m.indexOf(".xml.")?"sfx"!==y&&-1===m.indexOf("sfx.")||-1!==m.indexOf("sfx.response_type=simplexml")||(m+=(-1===m.indexOf("?")?"?":"&")+"sfx.response_type=simplexml"):(-1!==(g=m.split(".search")[0]).indexOf("//")&&(g=g.split("//")[1]),m="http://"+g+".openurl.xml.serialssolutions.com/openurlxml?version=1.0&genre=article&"),-1!==(v=m+(-1===m.indexOf("?")?"?":"&")+s).indexOf("snc.idm.oclc.org/login?url=")&&(v=v.split("snc.idm.oclc.org/login?url=")[1]),v=v.replace("cache=true",""),("sfx"===y||-1!==m.indexOf("sfx.")&&-1!==v.indexOf("=10."))&&(v=v.replace("=10.","=doi:10.")),l="",f="",r=!1,p.lookups.push(v);try{f=-1!==(l=-1!==v.indexOf(".xml.serialssolutions")||-1!==v.indexOf("sfx.response_type=simplexml")?await this.fetch(v):await this.puppet(v)).indexOf("<body")?l.toLowerCase().split("<body")[1].split("</body")[0]:l,p.contents.push(f)}catch(e){e,r=!0}if("sfx"===y||-1!==v.indexOf("sfx.")){if(r&&p.error.push("sfx"),-1!==f.indexOf("getFullTxt")&&-1!==f.indexOf("<target_url>"))try{if(p.url=f.split("getFullTxt")[1].split("</target>")[0].split("<target_url>")[1].split("</target_url>")[0].trim(),p.findings.sfx=p.url,null!=p.url){if(-1===p.url.indexOf("getitnow"))return p.found="sfx",p;p.url=void 0,p.findings.sfx=void 0}}catch(e){}}else if("eds"===y||-1!==v.indexOf("ebscohost.")){if(r&&p.error.push("eds"),-1!==f.indexOf("view this ")&&-1!==l.indexOf('<a data-auto="menu-link" href="')&&(p.url=v.replace("://","______").split("/")[0].replace("______","://")+l.split('<a data-auto="menu-link" href="')[1].split('" title="')[0],p.findings.eds=p.url,null!=p.url)){if(-1===p.url.indexOf("getitnow"))return p.found="eds",p;p.url=void 0}}else if(("serialssolutions"===y||-1!==v.indexOf("serialssolutions."))&&(r&&p.error.push("serialssolutions"),-1!==f.indexOf('<ssopenurl:url type="article">')&&(n=f.split('<ssopenurl:url type="article">')[1].split("</ssopenurl:url>")[0].trim()).length&&(p.url=n,p.findings.serials=p.url,null!=p.url))){if(-1===p.url.indexOf("getitnow"))return p.found="serials",p;p.url=void 0,p.findings.serials=void 0}}return p},null==n.index&&(n.index={}),null==(s=n.index).name&&(s.name=null!=(c=n.name)?c:"n2"),r.index=async function(e,t){var i,n,s,l,o,a,u,c,h,p,d,f;if(console.log(e),console.log(t),!e&&null==t&&null!=(null!=this?this.parts:void 0)&&this.parts.length&&"index"===this.parts[0]&&this.parts.length>1&&(this.parts[1].startsWith(".")||this.parts[1].startsWith("_")||"svc"===(o=this.parts[1])||"src"===o||null!=r[this.parts[1]]))return{status:403};if("object"==typeof e&&(t=e,e=void 0),e||null!=t||(delete(t="object"==typeof this.body?this.copy(this.body):"string"==typeof this.body?this.body:this.copy(this.params)).route,delete t.index,delete t[this.fn.split(".").pop()],delete t._id,null==t.script&&-1===JSON.stringify(t).toLowerCase().indexOf("<script"))){if("object"!=typeof t||Array.isArray(t)||(null==e&&(e=null!=(a=t.route)?a:t.index),delete t.route,delete t.index),!e)if("index"===this.parts[0]){if(1===this.parts.length)return await this.index._indices();2===this.parts.length?e=this.parts[1]:this.parts.length>2&&(e=this.parts[1]+"/"+this.parts.slice(2).join("_"))}else e=this.fn.replace(/\./g,"_"),this.parts.join(".")!==this.fn&&(e+="/"+this.parts.join("_").replace(e+"_",""));if("object"==typeof t&&!Array.isArray(t)&&t._id&&(n=t._id.replace(/\//g,"_"),-1===e.indexOf("/")&&-1===e.indexOf(n)&&(e+="/"+t._id),delete t._id),d=(e=e.toLowerCase()).split("/").length,("index"!==this.parts[0]||"DELETE"!==this.request.method&&!this.params._delete)&&""!==t){if(1===d){if("string"==typeof t&&-1===t.indexOf("\n"))try{t=this.index.translate(t)}catch(e){}if("string"==typeof t||Array.isArray(t))return this.index._bulk(e,t);if("object"==typeof t){if(this.index._q(t))return this.index._submit(e+"/_search",this.index.translate(t));for(i=this.copy(t),f=0,l=(u=["settings","aliases","mappings"]).length;f<l;f++)delete i[u[f]];return"{}"===JSON.stringify(i)?(await this.index._submit(e)||(s=this.index._q(t)?{}:{settings:t.settings,aliases:t.aliases,mappings:t.mappings},await this.index._submit(e,s)),this.index._submit(e+"/_search")):this.index._submit(e+"/_doc",t)}return this.index._submit(e+"/_search")}return 2!==d||null!=t&&("object"!=typeof t||Array.isArray(t))?void 0:null!=t&&"{}"!==JSON.stringify(t)?(e=null!=t.script?e+"/_update?retry_on_conflict=2":e.replace("/","/_create/"),this.index._submit(e,t)):("object"==typeof(h=await this.index._submit(e.replace("/","/_doc/")))&&(h._source||h.fields)&&(null==(p=null!=(c=h._source)?c:h.fields)._id&&(p._id=h._id),h=p),h)}h=await this.index._submit(e.replace("/","/_doc/"),"")}},r.index._submit=async function(e,t,i,s=!0){var l,o,a,u,c,h,p,d;if(console.log(e),console.log(t),0===(e=e.toLowerCase()).indexOf("/")&&(e=e.replace("/","")),null==i&&(i="/_pit"===e||""===t?"DELETE":null==t||-1!==e.indexOf("/")&&-1===e.indexOf("/_create")&&(-1===e.indexOf("/_doc")||e.endsWith("/_doc"))?null!=t||"_refresh"===(o=e.split("/").pop().split("?")[0])||"_pit"===o||"_aliases"===o?"POST":"GET":"PUT"),console.log(i),"DELETE"===i&&(!0!==s||-1!==e.indexOf("/_all")))return!1;if(!e.startsWith("http")){if(d=(null!=this&&null!=(a=this.S)&&null!=(u=a.index)?u.url:void 0)?this.S.index.url:null!=(c=n.index)?c.url:void 0,Array.isArray(d)&&(d=d[Math.floor(Math.random()*d.length)]),"string"!=typeof d)return;e=d+"/"+e}if((l=-1!==e.indexOf("/_bulk")||"object"==typeof(null!=t?t.headers:void 0)?t:{body:t}).method=i,!(null==(p=null!=(null!=this?this.fetch:void 0)?await this.fetch(e,l):await r.fetch(e,l))||"object"==typeof p&&"number"==typeof p.status&&p.status>=400&&p.status<=600)){try{this.S.dev&&null!=(null!=l&&null!=(h=l.body)?h.query:void 0)&&(p.q=l.body)}catch(e){}return p}},r.index._mapping=async function(e){return"string"==typeof e&&(-1===(e=e.replace(/^\//,"")).indexOf("/")&&(e+="/"),-1===e.indexOf("_mapping")&&(e=e.replace("/","/_mapping")),await this.index._submit(e))},r.index.keys=function(e){var t,i;i=[];try{(t=function(r,n=""){var s,l,o;if(null==r&&(r="object"==typeof e?e:this.index._mapping(e)),null!=r.properties){for(s in n.length&&(n+="."),o=[],r.properties)l=n+s,d.call(i,l)<0&&i.push(n+s),null!=r.properties[s].properties?o.push(t(r.properties[s],n+s)):o.push(void 0);return o}})()}catch(e){}return i},r.index.terms=function(e,t,i,r=1e3,n=!1,s="count"){var l,o;l="object"==typeof i?i:{query:{filtered:{filter:{exists:{field:t}}}},size:0,facets:{}},"string"==typeof i&&(l.filtered.query={query_string:{query:i}}),null==l.facets&&(l.facets={}),l.facets[t]={terms:{field:t,size:r,order:s}};try{return null==(null!=(o=this.index._submit("/"+e+"/_search",l,"POST"))?o.facets:void 0)?[]:n?o.facets[t].terms:_.pluck(o.facets[t].terms,"term")}catch(e){return e,[]}},r.index.count=function(e,t,i){var r,n,s,l,o,a;return null==i&&(i={query:{filtered:{filter:{bool:{must:[]}}}}}),null!=t?(i.size=0,i.aggs={keycard:{cardinality:{field:t,precision_threshold:4e4}}},null!=(r=this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(n=r.aggregations)&&null!=(s=n.keycard)?s.value:void 0):null!=(l=this.index._submit("/"+e+"/_search",i,"POST"))&&null!=(o=l.hits)&&null!=(a=o.total)?a.value:void 0},r.index.min=function(e,t,i){var r;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={min:{min:{field:t}}},this.index._submit("/"+e+"/_search",r,"POST").aggregations.min.value},r.index.max=function(e,t,i){var r;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={max:{max:{field:t}}},this.index._submit("/"+e+"/_search",r,"POST").aggregations.max.value},r.index.range=function(e,t,i){var r,n;return(r="object"==typeof t?t:null!=i?i:{query:{filtered:{filter:{exists:{field:t}}}}}).size=0,r.aggs={min:{min:{field:t}},max:{max:{field:t}}},{min:(n=this.index._submit("/"+e+"/_search",r,"POST")).aggregations.min.value,max:n.aggregations.max.value}},r.index._each=function(e,t,i,n){var s,l,o,a,u,c,h,p,d,f,m,y,g,v,b,_;for(void 0===n&&void 0===i&&"function"==typeof t&&(n=t,t="*"),void 0===n&&"function"==typeof i&&(n=i,i=void 0),null==i&&(i={}),null!=i.keep_alive?(a=i.keep_alive,delete i.keep_alive):a="5m",i.action?(s=i.action,delete i.action):s=!1,(p=r.index.translate(t,i)).from=0,null==p.size&&(p.size=1e3),c=this.index(e+"/_pit?keep_alive="+a).id,p.pit={id:c,keep_alive:a},null==p.sort&&(p.sort=[{createdAt:"asc"}]),h=0,b=[],v=!1;null!=(null!=g&&null!=(y=g.hits)?y.hits:void 0)&&(!1===v||h<v);){for(g=this.index(e,p),!1===v&&(v=g.hits.total.value),_=0,u=(d=g.hits.hits).length;_<u;_++)o=d[_],h+=1,null==(l=(n=n.bind(this))(null!=(f=null!=(m=o._source)?m:o.fields)?f:{_id:o._id}))||"object"!=typeof l&&"string"!=typeof l||b.push(l),p.search_after=o.sort;p.pit.id=g.pit_id}return s&&b.length&&this.index._bulk(e,b,s),this.index._submit("/_pit",{id:c})},r.index._bulk=async function(e,t,i="index",r=5e4){var n,s,l,o,a,u,c;if("string"==typeof t&&-1!==t.indexOf("\n"))return await this.index._submit("/_bulk",{content:t,headers:{"Content-Type":"text/plain"}}),!0;for(o in c="object"!=typeof t||Array.isArray(t)||null==(null!=t&&null!=(a=t.hits)?a.hits:void 0)?t:t.hits.hits,Array.isArray(c)||(c=[c]),n=0,l="",c)n+=1,"object"==typeof(u=c[o])&&null==u._id&&(u._id=this.uid()),(s={})[i]={_index:"string"!=typeof u&&null!=u._index?u._index:e},s[i]._id="delete"===i&&"string"==typeof u?u:u._id,l+=JSON.stringify(s)+"\n","create"===i||"index"===i?l+=JSON.stringify(u._source?u._source:u)+"\n":"update"===i&&(null!=u._id&&delete u._id,l+=JSON.stringify({doc:u})+"\n"),(n===r||parseInt(o)===c.length-1||l.length>7e7)&&(await this.index._submit("/_bulk",{content:l,headers:{"Content-Type":"text/plain"}}),l="",n=0);return c.length},r.index._indices=async function(e=!1){var t,i,r,n,s,l,o,a;for(i in n=e?{}:[],s=await this.index._submit("_stats"),o=e?await this.index._submit("_cat/shards?format=json"):[],s.indices)if(d.call([],i)<0&&!i.startsWith(".")&&!i.startsWith("security-"))if(e)for(n[i]={docs:s.indices[i].primaries.docs.count,size:Math.ceil(s.indices[i].primaries.store.size_in_bytes/1024/1024)},a=0,r=o.length;a<r;a++)(l=o[a]).index===i&&"p"===l.prirep&&(null==(t=n[i]).shards&&(t.shards=0),n[i].shards+=1);else n.push(i);return n},r.index.status=async function(){var e,t,i,r,n,s;(n={status:"green"}).indices=await this.index._indices(!0);try{for("green"!==(i=n.cluster.status)&&"yellow"!==i&&(n.status="red"),s=0,t=(r=["cluster_name","number_of_nodes","number_of_data_nodes","unassigned_shards"]).length;s<t;s++)e=r[s],delete n.cluster[e]}catch(e){}return n},r.index._q=function(e,t){var i,r,n,s,l,o,a;if("object"!=typeof e||Array.isArray(e)){if("string"==typeof e&&-1===e.indexOf("\n")){if("string"==typeof t&&e.toLowerCase().startsWith(t.toLowerCase()))return!1;if(e.startsWith("?")||e.startsWith("q="))return!0;if(e.length<8||(-1!==e.indexOf("/")?e.split("/").pop():e).length>34)return!0;for(r=0,s=(o=[" ",":","*","~","(",")","?"]).length;r<s;r++)if(i=o[r],-1!==e.indexOf(i))return!0}}else{for(a=0,n=(l=["settings","aliases","mappings","index"]).length;a<n;a++)if(e[l[a]])return!1;if(null!=e.q||null!=e.query)return!0}return!1},r.index.translate=function(e,t={}){var i,r,n,s,l,o,a,u,c,h,p,f,m,y,g,v,b,_,w,x,O,k,q,A,j,S,E,R,T,L,C,I,P,N,U,Y,D,M,B,J,z,W,V,F,$,G,X,H,K,Q,Z,ee,te,ie,re,ne,se,le,oe,ae,ue,ce,he,pe,de,fe,me,ye,ge,ve,be,_e,we,xe,Oe,ke,qe,Ae,je,Se;null==e&&(e=null!=this?this.params:void 0);try{"object"==typeof e&&(e=this.copy(e))}catch(e){}try{"object"==typeof t&&(t=this.copy(t))}catch(e){}if("random"===t&&(t={random:!0}),"number"==typeof t&&(t={size:t}),!0===t&&(t={newest:!0}),!1===t&&(t={newest:!1}),null==(H=null!=(Q=null!=t?t.query:void 0)?Q:{}).query&&(H.query={}),H=(i=function(e){var t,i,r,n,s;return null!=e.query&&null!=e.query.filtered||(e.query={filtered:{query:e.query,filter:{}}}),null==(t=e.query.filtered).filter&&(t.filter={}),null==(i=e.query.filtered.filter).bool&&(i.bool={}),null==(r=e.query.filtered.filter.bool).must&&(r.must=[]),null==e.query.filtered.query.bool&&(s=[],"{}"!==JSON.stringify(e.query.filtered.query)&&s.push(e.query.filtered.query),e.query.filtered.query={bool:{must:s}}),null==(n=e.query.filtered.query.bool).must&&(n.must=[]),e})(H),"object"==typeof e){for(je=0,k=(ue=["apikey","_","callback","refresh","key","counts","index"]).length;je<k;je++)delete e[ue[je]];for(g=0,q=(fe=["random","seed"]).length;g<q;g++)t[J=fe[g]]=e[J],delete e[J];if(0===JSON.stringify(e).indexOf("["))for(H.query.filtered.filter.bool.should=[],_=0,j=e.length;_<j;_++)if("object"==typeof(P=e[_])&&null!=P)for(w in P)"string"==typeof P[w]?((qe={term:{}}).term[w],H.query.filtered.filter.bool.should.push(qe)):"number"==(me=typeof P[w])||"boolean"===me?H.query.filtered.query.bool.should.push({query_string:{query:w+":"+P[w]}}):null!=P[w]&&H.query.filtered.filter.bool.should.push(P[w]);else"string"==typeof P&&(null==(l=H.query.filtered.query.bool).should&&(l.should=[]),H.query.filtered.query.bool.should.push({query_string:{query:P}}));else if(null!=e.query)H=e;else if(null!=e.source)for(M in"string"==typeof e.source&&(H=JSON.parse(e.source)),"object"==typeof e.source&&(H=e.source),null==t&&(t={}),e)"source"!==M&&null==t[M]&&(t[M]=e[M]);else if(null!=e.q)for(M in null!=e.prefix&&-1!==e.q.indexOf(":")?(delete e.prefix,(V={})[(X=e.q.split(":"))[0]]=X[1],H.query.filtered.query.bool.must.push({prefix:V})):H.query.filtered.query.bool.must.push({query_string:{query:e.q}}),null==t&&(t={}),e)"q"!==M&&null==t[M]&&(t[M]=e[M]);else for(Se in null!=e.must&&(H.query.filtered.filter.bool.must=e.must),null!=e.should&&(H.query.filtered.filter.bool.should=e.should),null!=e.must_not&&(H.query.filtered.filter.bool.must_not=e.must_not),e)"fields"===Se||"sort"===Se&&"string"==typeof e[Se]&&-1!==e[Se].indexOf(":")||!("from"!==Se&&"size"!==Se||"number"!=typeof e[Se]&&isNaN(parseInt(e[Se])))?(null==t&&(t={}),t[Se]=e[Se]):"must"!==Se&&"must_not"!==Se&&"should"!==Se&&("string"==typeof e[Se]?((qe={term:{}}).term[Se]=e[Se],H.query.filtered.filter.bool.must.push(qe)):"number"==(ye=typeof e[Se])||"boolean"===ye?H.query.filtered.query.bool.must.push({query_string:{query:Se+":"+e[Se]}}):"object"==typeof e[Se]?((G={})[Se]=e[Se],H.query.filtered.filter.bool.must.push(G)):null!=e[Se]&&H.query.filtered.filter.bool.must.push(e[Se]))}else"string"==typeof e&&(0===e.indexOf("?")?H=e:null!=e&&(""===e&&(e="*"),H.query.filtered.query.bool.must.push({query_string:{query:e}})));if(H=i(H),null!=t){if(!0===t.newest?(delete t.newest,t.sort={createdAt:{order:"desc"}}):!1===t.newest&&(delete t.newest,t.sort={createdAt:{order:"asc"}}),delete t._,delete t.apikey,t.fields&&"string"==typeof t.fields&&-1!==t.fields.indexOf(",")&&(t.fields=t.fields.split(",")),t.random&&(m={function_score:{random_score:{}}},null!=t.seed&&(m.function_score.random_score.seed=seed),H.query.filtered?(m.function_score.query=H.query.filtered.query,H.query.filtered.query=m):(m.function_score.query=H.query,H.query=m),delete t.random,delete t.seed),(null!=t._include||null!=t.include||null!=t._includes||null!=t.includes||null!=t._exclude||null!=t.exclude||null!=t._excludes||null!=t.excludes)&&(null==H._source&&(H._source={}),null!=(b=t[v=null!=t._include?"_include":null!=t.include?"include":null!=t._includes?"_includes":"includes"])&&("string"==typeof b&&(b=b.split(",")),H._source.includes=b,delete t[v]),null!=(h=t[c=null!=t._exclude?"_exclude":null!=t.exclude?"exclude":null!=t._excludes?"_excludes":"excludes"]))){for("string"==typeof h&&(h=h.split(",")),x=0,S=(ge=null!=b?b:[]).length;x<S;x++)y=ge[x],d.call(h,y)>=0&&delete h[y];H._source.excludes=h,delete t[c]}if(null!=t.and){for(O=0,E=(ve=t.and).length;O<E;O++)r=ve[O],H.query.filtered.filter.bool.must.push(r);delete t.and}if(null!=t.sort){if("string"==typeof t.sort&&-1!==t.sort.indexOf(","))if(-1!==t.sort.indexOf(":")){for(z=[],N=0,R=(be=t.sort.split(",")).length;N<R;N++)(Y={})[(F=be[N]).split(":")[0]]={order:F.split(":")[1]},z.push(Y);t.sort=z}else t.sort=t.sort.split(",");"string"==typeof t.sort&&-1!==t.sort.indexOf(":")&&((z={})[t.sort.split(":")[0]]={order:t.sort.split(":")[1]},t.sort=z)}if(null!=t.restrict){for(U=0,T=(_e=t.restrict).length;U<T;U++)we=_e[U],H.query.filtered.filter.bool.must.push(we);delete t.restrict}if(null!=t.not||null!=t.must_not){if(Oe=null!=t.not?"not":"must_not",Array.isArray(t[Oe]))H.query.filtered.filter.bool.must_not=t[Oe];else for(null==(o=H.query.filtered.filter.bool).must_not&&(o.must_not=[]),B=0,L=(Z=t[Oe]).length;B<L;B++)D=Z[B],H.query.filtered.filter.bool.must_not.push(D);delete t[Oe]}if(null!=t.should){if(Array.isArray(t.should))H.query.filtered.filter.bool.should=t.should;else for(null==(a=H.query.filtered.filter.bool).should&&(a.should=[]),W=0,C=(ee=t.should).length;W<C;W++)xe=ee[W],H.query.filtered.filter.bool.should.push(xe);delete t.should}if(null!=t.all&&(H.size=1e6,delete t.all),null!=t.terms){try{t.terms=t.terms.split(",")}catch(e){}for(null==H.facets&&(H.facets={}),$=0,I=(te=t.terms).length;$<I;$++)ke=te[$],H.facets[ke]={terms:{field:ke,size:1e3}};delete t.terms}for(K=0,A=(ie=["facets","aggs","aggregations"]).length;K<A;K++)if(null!=t[n=ie[K]]){for(p in null==H[n]&&(H[n]={}),t[n])H[n][p]=t[n][p];delete t[n]}for(w in t)Ae=t[w],H[w]=Ae}if("object"==typeof H&&null!=(null!=(re=H.query)&&null!=(ne=re.filtered)?ne.query:void 0)&&"{}"===JSON.stringify(H.query.filtered.query)&&(H.query.filtered.query={match_all:{}}),null!=(null!=(se=H.query)&&null!=(le=se.filtered)&&null!=(oe=le.query)?oe.bool:void 0))for(u in H.query.filtered.query.bool)for(s in H.query.filtered.query.bool[u])"string"==typeof(null!=(ae=H.query.filtered.query.bool[u][s].query_string)?ae.query:void 0)&&-1!==H.query.filtered.query.bool[u][s].query_string.query.indexOf("/")&&(H.query.filtered.query.bool[u][s].query_string.query=H.query.filtered.query.bool[u][s].query_string.query.replace(/\//g,"\\/"));if(null!=(null!=(ce=H.query)&&null!=(he=ce.filtered)&&null!=(pe=he.filter)?pe.bool:void 0))for(f in H.query.filtered.filter.bool)for(p in H.query.filtered.filter.bool[f])null!=(null!=(de=H.query.filtered.filter.bool[f][p].query_string)?de.query:void 0)&&-1!==H.query.filtered.filter.bool[f][p].query_string.query.indexOf("/")&&(H.query.filtered.filter.bool[f][p].query_string.query=H.query.filtered.filter.bool[f][p].query_string.query.replace(/\//g,"\\/"));return null!=H._source&&null!=H.fields&&delete H._source,H},r.kv=async function(e,i,r,n,s){var l,o,a,u,c,h,p,d,f,m,y,g,v,b;if(null==e&&(e=null!=(h=null!=(p=this.params.kv)?p:this.params.key)?h:this.parts.join("_"),null==i)){if("DELETE"===this.request.method||this.params._delete)i="";else if(null!=this.body)i=this.body;else if(this.params.val)i=this.params.val;else{for(i=this.params,b=0,a=(d=["key","kv","refresh","apikey"]).length;b<a;b++)delete i[o=d[b]];for(l=0,u=(f=this.parts).length;l<u;l++)delete i[o=f[l]]}"string"!=typeof i||0!==i.indexOf("[")&&0!==i.indexOf("{")||(i=JSON.parse(i)),"{}"!==(m=JSON.stringify(i))&&"[]"!==m||(i=void 0)}if("object"!=typeof i||"{}"!==(y=JSON.stringify(i))&&"[]"!==y||(i=""),"object"==typeof e&&null==i&&(e=null!=(g=(i=e)._id)?g:await this.uid()),null!=e&&this.S.kv&&null!=t[this.S.kv]){if(null!=i&&""!==i){if(c={metadata:n},"number"==typeof r&&(1e3*r>Date.now()?c.expiration=r:c.expirationTtl=r),"object"==typeof i&&(!0===r&&(r=await this.kv(e)),"object"==typeof r))for(o in r)null==i[o]&&(i[o]=r[o]);return this.waitUntil(t[this.S.kv].put(e,"object"==typeof i?JSON.stringify(i):i,c)),i}({value:v,metadata:n}=await t[this.S.kv].getWithMetadata(e,s));try{v=JSON.parse(v)}catch(e){}try{n=JSON.parse(n)}catch(e){}return""===i&&this.waitUntil(t[this.S.kv].delete(e)),!0===n?{value:v,metadata:n}:v}},r.kv.count=async function(e){var i,r,n,s,l,o,a,u;if(r=0,this.S.kv&&null!=t[this.S.kv])for(null==e&&(e=null!=(o=this.params.kv)?o:this.params.prefix),i=!1;!i;){for(n=(l=await t[this.S.kv].list({prefix:e,cursor:n})).cursor,u=0,s=(a=l.keys).length;u<s;u++)a[u],r+=1;i=l.list_complete}return r},r.kv._each=async function(e,i,r){var n,s,l,o,a,u,c,h,p,d;if(h=[],this.S.kv&&null!=t[this.S.kv])for(n=!1,s=0;!n;){for(l=(u=await t[this.S.kv].list({prefix:e,cursor:l})).cursor,d=0,a=(c=u.keys).length;d<a;d++)o=c[d],s+=1,""===i?this.waitUntil(this.kv(o.name,"")):"function"==typeof i?h.push(await i.call(this,o.name)):null!=i?this.waitUntil(this.kv(o.name,i)):(null!=(p=await this.kv(o.name))&&null==p.id&&(p.id=o.name),h.push(p));n=!(!r||s!==r)||u.list_complete}return h},r._cache=async function(e,t,i=120){var r,n,s,l,o,a,u,c,h,p;if(!1!==this.S.cache){try{null==e&&(e=this.request);try{for(h=e.url.toString(),p=0,o=(a=["refresh"]).length;p<o;p++)s=a[p],-1!==h.indexOf(s+"=")&&(l=new RegExp(s+"=.*?&"),h=h.replace(l,"")),-1!==h.indexOf("&"+s+"=")&&(h=h.split("&"+s+"=")[0]);n=new URL(h)}catch(e){}}catch(e){}return null!=e?(null==n&&(n=new URL(e.url)),r=new Request(n.toString(),e),null==t||""===t?(c=await caches.default.match(r),""===t&&this.waitUntil(caches.default.delete(r)),c):((u=new Response(t.body,t)).headers.append("Cache-Control","max-age="+i),this.waitUntil(caches.default.put(r,u)))):void 0}},null==n.example&&(n.example={}),n.example.example=3,r.example=function(){var e;e={name:n.name,version:n.version,env:n.env,built:n.built};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}if(n.dev){try{null==e.headers&&(e.headers=this.headers)}catch(e){}try{null==e.request&&(e.request=this.request)}catch(e){}try{null==e.parts&&(e.parts=this.parts)}catch(e){}try{null==e.params&&(e.params=this.params)}catch(e){}try{null==e.opts&&(e.opts=this.opts)}catch(e){}}return e},r.example.restricted=function(){return{hello:this.user._id}},r.example.restricted._auth=!0,r.example.deep=async function(){var e;e={example:"deep",request:this.request,deeper:await this.example.deep.deeper()};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.example.deep.deeper=async function(){var e;e={hello:"deeper"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}try{e.deepest=await this.example.deep.deeper.deepest()}catch(e){}return e},r.example.deep.deeper.deepest=function(){var e;e={hello:"deepest"};try{e.caller=(new Error).stack.split("\n")[3].split("FetchEvent.")[1].split(" ")[0]}catch(e){}try{e.fn=this.fn}catch(e){}return e},r.tdm={},r.tdm.clean=function(e){var t,i,r,n,s,l,o,a,u,c;for(null==e&&(e=null!=(s=null!=(l=null!=this&&null!=(o=this.params)?o.clean:void 0)?l:null!=this&&null!=(a=this.params)?a.text:void 0)?s:null!=this&&null!=(u=this.params)?u.q:void 0),c=0,r=(t=[{bad:"‘",good:"'"},{bad:"’",good:"'"},{bad:"´",good:"'"},{bad:"“",good:'"'},{bad:"”",good:'"'},{bad:"–",good:"-"},{bad:"-",good:"-"}]).length;c<r;c++)i=t[c],n=new RegExp(i.bad,"g"),e=e.replace(n,i.good);return e},r.tdm.occurrence=function(e,t,i){var r,n,s,l,o,a,u,c,h,p;if(null==e&&(e=null!=(s=null!=this&&null!=(l=this.params)?l.content:void 0)?s:null!=this&&null!=(o=this.params)?o.url:void 0),0===e.indexOf("http")&&(e=this.fetch(e)),null==t&&(t=null!=(a=null!=this&&null!=(u=this.params)?u.sub:void 0)?a:null!=this&&null!=(c=this.params)?c.q:void 0),null==i&&(i=null!=this&&null!=(h=this.params)?h.overlap:void 0),e+="",(t+="").length<=0)return e.length+1;for(r=0,n=0,p=i?1:t.length;(n=e.indexOf(t,n))>=0;)++r,n+=p;return r},r.tdm.levenshtein=function(e,t,i){var r,n,s,l,o,a,u,c,h,p,d,f,m;for(null==e&&(e=null!=this&&null!=(p=this.params)?p.a:void 0),null==t&&(t=null!=this&&null!=(d=this.params)?d.b:void 0),null==i&&(i=null==(f=null!=this&&null!=(m=this.params)?m.lowercase:void 0)||f),i&&(e=e.toLowerCase(),t=t.toLowerCase()),a=function(e,t,i){return e<=t&&e<=i?e:t<=e&&t<=i?t:i},(o=e.length)<(u=t.length)&&(r=e,e=t,t=r,c=o,o=u,u=c),h=[[]],r=0;r<u+1;)h[0][r]=r,r++;for(s=1;s<o+1;){for(h[s]=[s],l=1;l<u+1;)n=e.charAt(s-1)===t.charAt(l-1)?0:1,h[s][l]=a(h[s-1][l]+1,h[s][l-1]+1,h[s-1][l-1]+n),l++;s++}return{distance:h[h.length-1][h[h.length-1].length-1],length:{a:o,b:u}}},r.tdm.hamming=function(e,t,i){var r,n,s,l,o,a,u,c,h,p,d,f,m,y;if(null==e&&(e=null!=this&&null!=(c=this.params)?c.a:void 0),null==t&&(t=null!=this&&null!=(h=this.params)?h.b:void 0),null==i&&(i=null==(p=null!=this&&null!=(d=this.params)?d.lowercase:void 0)||p),i&&(e=e.toLowerCase(),t=t.toLowerCase()),e.length<t.length?(f=e,l=t):(f=t,l=e),u=l.indexOf(f),y=f.split(""),(m=l.split("")).length>y.length){if(n=m.length-y.length,0<u)for(a=0;a<u;)y.unshift(""),a++,n--;for(r=0;r<n;)y.push(""),r++}for(s in o=0,m)y[s]!==m[s]&&o++;return o},r.tdm.extract=function(e){var t,i,n,s,l,o,a,u,c,h,p,d;e.url&&!e.content&&(-1!==e.url.indexOf(".pdf")||-1!==e.url.indexOf("/pdf")?null==e.convert&&(e.convert="pdf"):e.content=r.http.puppeteer(e.url,!0));try{p=e.convert?r.convert.run(null!=(u=e.url)?u:e.content,e.convert,"txt"):e.content}catch(t){p=e.content}if(null==e.matchers&&(e.matchers=[e.match]),null!=e.start&&(a=p.split(e.start),p=a.length>1?a[1]:a[0]),null!=e.end&&(p=p.split(e.end)[0]),e.lowercase&&(p=p.toLowerCase()),e.ascii&&(p=p.replace(/[^a-z0-9]/g,"")),!1===e.spaces&&(p=p.replace(/ /g,"")),h={length:p.length,matched:0,matches:[],matchers:e.matchers,text:p},p&&"number"!=typeof p)for(d=0,i=(c=e.matchers).length;d<i;d++)for(s=c[d],l="g",e.lowercase&&(l+="i"),0===s.indexOf("/")?(t=s.lastIndexOf("/"))+1!==s.length&&(l=s.substring(t+1),s=s.substring(1,t)):s=s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),o=new RegExp(s,l);n=o.exec(p);)h.matched+=1,h.matches.push({matched:s,result:n});return h},r.tdm.emails=function(e={}){var t,i,n,s,l,o,a,u,c,h,p,f,m;for(e.matchers=["/([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)/gi","/(?: |>|\"|')([^ '\">{}/]*?@[^ '\"{}<>]*?[.][a-z.]{2,}?)(?: |<|\"|')/gi"],i=[],t=[],m=0,s=(a=r.tdm.extract(e).matches).length;m<s;m++)for(n=0,l=(u=a[m].result).length;n<l;n++)o=u[n],d.call(t,o)<0&&("function"!=typeof(null!=(null!=(c=r.mail)?c.validate:void 0))||r.mail.validate(o,null!=(h=r.settings.service)&&null!=(p=h.openaccessbutton)&&null!=(f=p.mail)?f.pubkey:void 0).is_valid)&&i.push(o),t.push(o);return i},r.tdm.stopwords=function(e,t,i=!0){var r,n,s,l,o,a;if(null==e&&(e=["purl","w3","http","https","ref","html","www","ref","cite","url","title","date","nbsp","doi","fig","figure","supplemental","year","time","january","february","march","april","may","june","july","august","september","october","november","december","jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec","keywords","revised","accepted","file","attribution","org","com","id","wp","main","website","blogs","media","people","years","made","location","its","asterisk","called","xp","er","image","jpeg","jpg","png","php","object","false","true","article","chapter","book","caps","isbn","scale","axis","accessed","email","e-mail","story","first1","first2","last1","last2","general","list","accessdate","view_news","d0","dq","sfnref","onepage","sfn","authorlink"]),i=["apos","as","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","aint","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","arent","around","as","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","cmon","cs","came","can","cant","cannot","cant","cause","causes","certain","certainly","changes","clearly","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldnt","course","currently","definitely","described","despite","did","didnt","different","do","does","doesnt","doing","dont","done","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadnt","happens","hardly","has","hasnt","have","havent","having","he","hes","hello","help","hence","her","here","heres","hereafter","hereby","herein","hereupon","hers","herself","hi","him","himself","his","hither","hopefully","how","howbeit","however","i","I","id","ill","im","ive","ie","if","ignored","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isnt","it","itd","itll","its","itself","just","keep","keeps","kept","know","knows","known","last","lately","later","latter","latterly","least","less","lest","let","lets","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldnt","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","ts","take","taken","tell","tends","th","than","thank","thanks","thanx","that","thats","thats","the","their","theirs","them","themselves","then","thence","there","theres","thereafter","thereby","therefore","therein","theres","thereupon","these","they","theyd","theyll","theyre","theyve","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasnt","way","we","wed","well","weve","welcome","well","went","were","werent","what","whats","whatever","when","whence","whenever","where","wheres","whereafter","whereas","whereby","wherein","whereupon","wherever","whether","which","while","whither","who","whos","whoever","whole","whom","whose","why","will","willing","wish","with","within","without","wont","wonder","would","would","wouldnt","yes","yet","you","youd","youll","youre","youve","your","yours","yourself","yourselves","zero"])for(a=0,s=i.length;a<s;a++)r=i[a],d.call(e,r)<0&&e.push(r);if(t)for("string"==typeof t&&(t=t.split(",")),n=0,l=t.length;n<l;n++)o=t[n],d.call(e,o)<0&&e.push(o);return e},r.mail=async function(e){var t,i,s,l,o,a,u,c,h,p,d,f,m,y,g,v;if(null!=(a=n.mail)?a.disabled:void 0)return{};if(null==e&&(null!=(null!=this?this.params:void 0)||null!=(null!=this?this.opts:void 0)))for(l in e=null!=(u=null!=this?this.params:void 0)?u:{},this.params)e[l]=this.params[l];e.text||e.html||(e.text=null!=(c=null!=(h=e.content)?h:e.body)?c:""),delete e.content;try{for(v=0,i=(p=["subject","text","html","template"]).length;v<i;v++)if(null!=e[y=p[v]])for(o in e.params)e[y]=e[y].replace("{{"+o.toUpperCase()+"}}",e.params[o])}catch(e){}return s=null!=e.svc&&null!=(null!=(d=n.svc)&&null!=(f=d[e.svc])?f.mail:void 0)?n.svc[e.svc].mail:n.mail,null==e.from&&(e.from=s.from),null==e.to&&(e.to=s.to),delete e.svc,delete e.template,delete e.params,g="https://api.mailgun.net/v3/"+s.domain+"/messages",Array.isArray(e.to)&&(e.to=e.to.join(",")),t=null!=(m=null!=this?this.fetch:void 0)?m:r.fetch,await t(g,{method:"POST",body:e,headers:{auth:"api:"+s.apikey}})},r.mail.validate=async function(e,t){var i,s,l,o;if(null==t&&(t=null!=(s=n.mail)?s.pubkey:void 0),null==e&&(e=null!=this&&null!=(l=this.params)?l.email:void 0),"string"==typeof e&&"string"==typeof t)return i=null!=(o=null!=this?this.fetch:void 0)?o:r.fetch,await i("https://api.mailgun.net/v3/address/validate?syntax_only=false&address="+encodeURIComponent(e.params.email)+"&api_key="+t)},null==n.log&&(n.log={}),r.log=function(e){var t,i,r,s,l,o,a,u,c;if(!1!==n.log){if(u=null==e,"string"==typeof e)e=-1!==e.indexOf("/")&&-1===e.indexOf(" ")?{fn:e}:{msg:e};else if(Array.isArray(e)){for(c=0,r=e.length;c<r;c++)i=e[c],this._logs.push(i);e=void 0}if(null==e){1===this.parts.length&&"log"===this.parts[0]&&null==(e="object"==typeof this.body?{logs:this.body}:this.params).fn&&(e.fn=this.params.log),null==e&&(e={});try{e.request={url:this.request.url,method:this.request.method,body:this.request.bodyUsed}}catch(e){}try{e.request.cf={colo:this.request.cf.colo,country:this.request.cf.country}}catch(e){}try{e.request.headers={ip:this.headers["x-real-ip"],"user-agent":this.headers["user-agent"],referer:this.headers.referer}}catch(e){}try{null==e.fn&&(e.fn=this.fn),e.params=this.params,e.refresh=this.refresh,e.parts=this.parts,e.completed=this.completed,e.cached=this.cached}catch(e){}try{e.apikey=null!=this.headers.apikey||null!=this.headers["x-apikey"]}catch(e){}try{e.user=null!=(l=this.user)?l._id:void 0}catch(e){}}if(u){if(null==e.logs&&(e.logs=[]),Array.isArray(null!=this?this._logs:void 0)&&this._logs.length)for(t=0,s=(o=this._logs).length;t<s;t++)i=o[t],null==e.alert&&(e.alert=i.alert),null==e.notify&&(e.notify=i.notify),e.logs.push(i);null==e.createdAt&&(e.createdAt=Date.now()),null==e.name&&(e.name=n.name),null==e.version&&(e.version=n.version),null==e.env&&(e.env=n.env);try{e.started=this.started,e.took=Date.now()-this.started}catch(e){}return e._id="log/"+(null!=(a=this.rid)?a:this.uid()),this.kv(e)}return this._logs.push(e)}},r.log.schedule=function(){return this.kv._each("log","")},r.auth=async function(e,t){var i,r,s,l,o,a,u,c,h,p,d,f;if("string"==typeof e)return await this.kv("user/"+e);if((null==this.params.access_token||!(f=await this.oauth()))&&(this.params.token&&(r=await this.kv("auth/token/"+this.params.token,""))&&((p=await this.kv("user/email/"+r))&&(f=await this.kv("user/"+p)),null==f&&(f=await this.auth._insert(r))),!f&&this.apikey&&(p=await this.kv("user/apikey/"+this.apikey))&&(f=await this.kv("user/"+p)),!f&&(null!=this.params.resume||this.cookie))){if((p=this.id)||null==this.params.email||(p=await this.kv("user/email/"+this.params.email)),!(h=this.params.resume))try{h=(i=JSON.parse(decodeURIComponent(this.cookie).split((null!=(s=null!=(l=null!=(o=n.auth)&&null!=(a=o.cookie)?a.name:void 0)?l:n.name)?s:"n2")+"=")[1].split(";")[0])).resume,p=i.id}catch(e){}null!=h&&null!=p&&await this.kv("auth/resume/"+p+"/"+h,this.params.resume?"":void 0)&&(f=await this.kv("user/"+p))}return"object"==typeof f&&f._id&&(this.params.service&&null==(null!=(u=f.roles)?u[this.params.service]:void 0)&&((d={}).roles=null!=(c=f.roles)?c:{},d.roles[this.params.service]="user",this.kv("user/"+f._id,d,f)),null==this.params.resume&&null==this.params.token||(f.resume=this.uid(),this.kv("auth/resume/"+f._id+"/"+f.resume,Date.now(),789e4))),f},r.auth.token=async function(e,t,i,r,s,l,o){var a,u,c,h,p,d,f,m;return null==e&&(e=null!=(a=this.params.email)?a:""),null==t&&(t=null!=(u=null!=(c=n.auth)?c.from:void 0)?u:"nobody@example.com"),null==i&&(i=null!=(h=null!=(p=n.auth)?p.subject:void 0)?h:"Please complete your login"),m=this.uid(8),null==o&&(o=(null!=(d=null!=(f=this.params.url)?f:this.request.url)?d:"https://example.com").split("?")[0].replace("/token","")+"?token="+m),this.kv("auth/token/"+m,e,900),t&&e?await this.mail.send({from:t,to:e,subject:i,text:null!=r?r:"Your login code is:\r\n\r\n{{TOKEN}}\r\n\r\nor use this link:\r\n\r\n{{URL}}\r\n\r\nnote: this single-use code is only valid for 15 minutes.",html:null!=s?s:'<html><body><p>Your login code is:</p><p><b>{{TOKEN}}</b></p><p>or click on this link</p><p><a href="{{URL}}">{{URL}}</a></p><p>note: this single-use code is only valid for 15 minutes.</p></body></html>',params:{token:m,url:o}}):m},r.auth.role=function(e,t){var i,r,n,s,l,o,a,u,c,h,p,f,m,y,g,v;if(null==e&&(e=this.params.role),null==e&&"string"==typeof(null!=(a=this.opts)?a.auth:void 0)&&(e=this.opts.auth),null==t&&(t=this.user),"string"==typeof e&&-1!==e.indexOf("/")&&null==t&&(t=e.split("/").pop(),e=e.replace("/"+t,"")),null==(null!=(g=null!=t&&t!==(null!=(u=this.user)?u._id:void 0)?this.user(t):this.user)?g.roles:void 0))return!1;for("string"==typeof e&&(e=[e]),v=0,l=e.length;v<l;v++){if(r=(r=e[v]).replace("/","."),[n,y]=r.split("."),null==y&&(y=n,n="__global__"),n===g.id)return"owner";if(d.call(null!=(c=g.roles.__global__)?c:[],"root")>=0)return"root";if(d.call(null!=(h=g.roles[n])?h:[],y)>=0)return y;if(null!=g.roles[n]&&0<(f=(i=["root","service","owner","super","admin","auth","bulk","delete","remove","create","insert","publish","put","draft","post","edit","update","user","get","read","info","public"]).indexOf(y)))for(s=0,o=(p=i.splice(0,f)).length;s<o;s++)if(m=p[s],d.call(g.roles[n],m)>=0)return m}return!1},r.auth.roles=async function(e,t,i){var r,n,s,l,o,a;return null==e&&(e=null!=(s=this.user)?s:this.params.roles),"string"==typeof e&&(e=await this.kv("user/"+e)),[n,a]=t.split("."),null==a&&(a=n,n="__global__"),null==(l=d.call(null!=(o=e.roles)?o[n]:void 0,a)>=0)||l?null!=i?(e.roles[n].splice(e.roles[n].indexOf(a),1),this.kv("user/"+e._id,e)):void 0:(null==(r=e.roles)[n]&&(r[n]=[]),e.roles.group.push(a),this.kv("user/"+e._id,e))},r.auth.logout=function(e){if(null==e&&(e=this.user),null!=e)return this.kv("auth/resume/"+("string"==typeof e?e:e._id),"")},r.oauth=async function(e,t){var i,r,s,l,o,a,u,c,h,p,d,f,m,y,g,v;if(m={},null==e&&(e=this.params.access_token),e)try{v=await this.http.post("https://www.googleapis.com/oauth2/v3/tokeninfo?access_token="+e),null==t&&(t=null!=(i=null!=(l=n.svc[null!=(o=this.params.service)?o:"z"])&&null!=(a=l.google)&&null!=(u=a.oauth)&&null!=(c=u.client)?c.id:void 0)?i:null!=(h=n.use)&&null!=(p=h.google)&&null!=(d=p.oauth)&&null!=(r=d.client)?r.id:void 0),null!=t&&(null!=(s=v.data)?s.aud:void 0)===t&&(f=await this.http.get("https://www.googleapis.com/oauth2/v2/userinfo?access_token="+e),(y=await this.kv("user/email/"+f.data.email))&&((g=await this.kv("user/"+y))||(g=await this.auth._insert(f.data.email))),null==g.google&&(m.google={id:f.data.id}),f.data.name?g.name||(m.name=f.data.name):f.data.given_name&&!g.name&&(m.name=f.data.given_name,f.data.family_name&&(m.name+=" "+f.data.family_name)),!g.avatar&&f.data.picture&&(m.avatar=f.data.picture))}catch(e){}return null!=g&&"{}"!==JSON.stringify(m)&&(g=await this.user.update(g.id,m)),g},r.auth._insert=async function(e,t){var i,r,n,s,l;if("string"!=typeof e||null==t)return"string"==typeof e&&-1!==e.indexOf("@")&&-1!==e.indexOf(".")&&(i=e),null==e&&(null!=this&&null!=(n=this.user)?n._id:void 0)&&(e="user/"+this.user._id),-1!==e.indexOf("@")&&(e=await this.kv("user/email/"+e)),null==await this.kv("user/"+e)&&i?(!1,(s={email:i.trim(),apikey:this.uid(),profile:{}}).roles={},s.createdAt=Date.now(),s._id=this.uid(),this.kv("user/apikey/"+apikey,s._id),this.kv("user/email/"+email,s._id),this.kv("user/"+s._id,s),s):void 0;if(""===t){e.startsWith("user/")&&(e=e.replace("user/","")),l=(null!=(r=this.user)?r._id:void 0)===e?this.user:await this.kv("user/"+e);try{this.auth.logout(e)}catch(e){}try{null!=l.apikey&&this.kv("user/apikey/"+l.apikey,"-")}catch(e){}try{null!=l.email&&this.kv("user/email/"+l.email,"-")}catch(e){}return this.kv("user/"+e,"")}},r.auth._update=async function(e,t){var i;if(null==t&&(t=e.auth),e.param&&this.auth(e.param)&&"","{}"!==JSON.stringify(e.params)){for(i in null==t.profile&&(t.profile={}),e.params)t.profile[i]=pr[i];return await this.kv("user/"+t.id,t),!0}return!1},r.status=function(){var e,t,i,r,s;if(r={name:n.name,version:n.version,env:n.env,built:n.built},n.dev)for(s=0,t=(i=["id","request","params","parts","opts","headers","cookie","user","fn","routes"]).length;s<t;s++){e=i[s];try{null==r[e]&&(r[e]=this[e])}catch(e){}}return r},r.src.epmc=async function(e,t,i){var r,n,s,l,o;return 0===e.indexOf("10.")&&-1===e.indexOf(" ")&&2===e.split("/").length&&(e="DOI:"+e),o="https://www.ebi.ac.uk/europepmc/webservices/rest/search?query="+e+"%20sort_date:y&resulttype=core&format=json",null!=i&&(o+="&pageSize="+i),null!=t&&(o+="&cursorMark="+t),l={},s=await this.fetch(o),l.total=s.hitCount,l.data=null!=(r=null!=(n=s.resultList)?n.result:void 0)?r:[],l.cursor=s.nextCursorMark,l},r.src.epmc.pmid=function(e){var t;return(t=this.src.epmc("EXT_ID:"+e+" AND SRC:MED")).total?t.data[0]:void 0},r.src.epmc.pmc=function(e){var t;return(t=this.src.epmc("PMCID:PMC"+e.toLowerCase().replace("pmc",""))).total?t.data[0]:void 0},r.src.epmc.title=function(e){var t;try{e=e.toLowerCase().replace(/(<([^>]+)>)/g,"").replace(/[^a-z0-9 ]+/g," ").replace(/\s\s+/g," ")}catch(e){}return(t=this.src.epmc('title:"'+e+'"')).total?t.data[0]:void 0},r.src.epmc.licence=function(e,t,i){var r,n,s,l,o;if(e&&!t&&(o=this.src.epmc("PMC"+e.toLowerCase().replace("pmc",""))),(null!=o?o.total:void 0)>0||t||i){if(null==t&&(t=o.data[0]),!e&&t&&(e=t.pmcid),t.license)return 0===(n={licence:t.license,source:"epmc_api"}).licence.indexOf("cc")&&(n.licence=n.licence.replace(/ /g,"-")),n;if(!i&&e&&(i=this.src.epmc.xml(e)),404!==i&&"string"==typeof i&&0===i.indexOf("<")&&null!=this.svc.lantern){if(null!=(s=this.svc.lantern.licence(void 0,void 0,i,"<permissions>","</permissions>")).licence)return s.source="epmc_xml_permissions",s;if(null!=(r=this.svc.lantern.licence(void 0,void 0,i)).licence)return r.source="epmc_xml_outside_permissions",r;-1!==i.indexOf("<permissions>")&&(l={licence:"non-standard-licence",source:"epmc_xml_permissions"})}return null!=l&&l}return!1},r.src.epmc.xml=async function(e){var t;return e&&(e=e.toLowerCase().replace("pmc","")),t="https://www.ebi.ac.uk/europepmc/webservices/rest/PMC"+e+"/fullTextXML",(await this.fetch(t)).content},r.src.epmc.aam=function(e,t,i,r){return"string"==typeof i&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:(null==e&&(e=null!=t?t.pmcid:void 0),e&&"string"==typeof(i=this.src.epmc.xml(e))&&-1!==i.indexOf("pub-id-type='manuscript'")&&-1!==i.indexOf('pub-id-type="manuscript"')?{aam:!0,info:"fulltext"}:{aam:!1,info:""})},r.src.google=async function(e,t,i){var r,s,l,o,a,u,c,h,p,d;return null==e&&(e=null!=(r=null!=this&&null!=(s=this.params)?s.q:void 0)?r:null!=this&&null!=(l=this.params)?l.google:void 0),null==t&&(t=null!=(o=n.src.google)&&null!=(a=o.secrets)&&null!=(u=a.search)?u.id:void 0),null==i&&(i=null!=(c=n.src.google)&&null!=(h=c.secrets)&&null!=(p=h.search)?p.key:void 0),e&&t&&i?(d="https://www.googleapis.com/customsearch/v1?key="+i+"&cx="+t+"&q="+e,await this.fetch(d)):{}},r.src.google.sheets=async function(e){var t,i,r,n,s,l,o,a;if(null==e&&(e=null!=(n=null!=this?this.params:void 0)?n:{}),"string"==typeof e&&(e={sheetid:e}),null==e.sheets&&null==e.sheet||null!=e.sheetid||(e.sheetid=null!=(s=e.sheet)?s:e.sheets,delete e.sheet,delete e.sheets),a=[],!e.sheetid)return a;for(r in 0===e.sheetid.indexOf("http")?l=e.sheetid:(-1!==e.sheetid.indexOf("/spreadsheets/d/")&&(e.sheetid=e.sheetid.split("/spreadsheets/d/")[1].split("/")[0]),null==e.sheet&&(e.sheet="default"),l="https://spreadsheets.google.com/feeds/list/"+e.sheetid+"/"+e.sheet+"/public/values?alt=json"),(t=await this.fetch(l)).feed.entry){for(i in o={},t.feed.entry[r])try{0===i.indexOf("gsx$")&&(o[i.replace("gsx$","")]=t.feed.entry[r][i].$t)}catch(e){}a.push(o)}return a},r.src.google.chat=function(e,t){var i,r,n,s,l,o;return null==e&&(e=this.params),i={method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},body:{text:decodeURIComponent(null!=(r=null!=(n=null!=(s=e.text)?s:e.msg)?n:e.body)?r:"")}},null==t&&(t=null!=(l=this.S.src.google)&&null!=(o=l.secrets)?o.chat:void 0),i.body.text&&null!=t?this.fetch(t,i):void 0},null==(l=n.src).microsoft&&(l.microsoft={});try{n.src.microsoft.secrets=JSON.parse(SECRETS_MICROSOFT)}catch(e){}r.src.microsoft={},r.src.microsoft.bing=async function(e,t){var i,r,s,l,o,a,u,c,h,p,d;return null==e&&(e=null!=(i=null!=(r=null!=this&&null!=(s=this.params)?s.bing:void 0)?r:null!=this&&null!=(l=this.params)?l.q:void 0)?i:null!=this&&null!=(o=this.params)?o.query:void 0),null==t&&(t=null!=(a=n.src.microsoft)&&null!=(u=a.secrets)&&null!=(c=u.bing)?c.key:void 0),d="https://api.cognitive.microsoft.com/bing/v7.0/search?mkt=en-GB&count=20&q="+e,(null!=(p=await this.fetch(d,{headers:{"Ocp-Apim-Subscription-Key":t}}))&&null!=(h=p.webPages)?h.value:void 0)?{total:p.data.webPages.totalEstimatedMatches,data:p.data.webPages.value}:{total:0,data:[]}},r.src.microsoft.graph=function(e){var t,i,r,n,s,l,o,a,u,c,h;if(t=function(e){var t;return e.JournalId&&(t=this.src.microsoft.graph.journal(e.JournalId))&&(e.journal=t),e},null==e&&(e=null!=(s=null!=(l=null!=(o=this.params.graph)?o:this.params.doi)?l:this.params.title)?s:this.params),"number"==typeof e&&(e=e.toString()),"string"==typeof e&&-1!==e.indexOf("/")&&0===e.indexOf("10.")&&(n=this.src.microsoft.graph.paper('Doi.exact:"'+e+'"')))return t(n);if("string"==typeof e&&-1===e.indexOf(" ")&&10===e.length&&(n=this.src.microsoft.graph.paper(e)))return t(n);if("string"!=typeof e||-1===e.indexOf(" "))return this.src.microsoft.graph.paper(e);if(h=h.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),u=this.src.microsoft.graph.paper('PaperTitle:"'+h+'"'))if(c=u.PaperTitle.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),"function"==typeof(null!=this&&null!=(a=this.tdm)?a.levenshtein:void 0)){if(i=(r=this.tdm.levenshtein(h,c,!1)).length.a>r.length.b?r.length.a:r.length.b,r.distance<2||i/r.distance>10)return u}else if(h.length<1.2*c.length&&h.length>.8*c.length)return u},r.src.microsoft.graph.paper=async function(e){var t;try{return t="https://dev.lvatn.com/use/microsoft/graph/paper/?q="+e,(await this.fetch(t)).hits.hits[0]._source}catch(e){return}},r.src.microsoft.graph.journal=async function(e){var t;try{return t="https://dev.lvatn.com/use/microsoft/graph/journal/"+e,await this.fetch(t)}catch(e){return}},r.src.oadoi=function(e){var t,i,r,s;return null==e&&(e=null!=(t=null!=this&&null!=(i=this.params)?i.oadoi:void 0)?t:null!=this&&null!=(r=this.params)?r.doi:void 0),"string"==typeof e&&e.startsWith("10.")?(s="https://api.oadoi.org/v2/"+e+"?email="+n.mail.to,this.fetch(s)):void 0},r.src.oadoi._index=!0,r.src.oadoi._kv=!1,r.src.oadoi._key="doi",n.name,null!=(h=n.mail)&&h.to,r.src.crossref={},r.src.crossref.journals=async function(e){var t,i,r,n,s;return null==e&&(e=null!=(t=null!=this&&null!=(i=this.params)?i.journals:void 0)?t:null!=this&&null!=(r=this.params)?r.issn:void 0),s="https://dev.lvatn.com/use/crossref/journals/"+e,null!=(null!=(n=await this.fetch(s))?n.ISSN:void 0)?n:void 0},r.src.crossref.journals._index=!0,r.src.crossref.journals._key="ISSN",r.src.crossref.works=async function(e){var t,i,r,n,s,l,o,a;return(null!=this&&null!=(i=this.params)?i.title:void 0)||"object"==typeof e&&null!=e.title||"string"==typeof e&&0!==e.indexOf("10.")?o=this.src.crossref.works._title((null!=this&&null!=(r=this.params)?r.title:void 0)?this.params.title:"object"==typeof e?e.title:e):(null==e&&(e=null!=(n=null!=this&&null!=(s=this.params)?s.works:void 0)?n:null!=this&&null!=(l=this.params)?l.doi:void 0),"string"==typeof e&&(0===e.indexOf("http")&&(e=e.split("://")[1]),0!==e.indexOf("10.")&&-1!==e.indexOf("/10.")&&(e="10."+e.split("/10.")[1]),a="https://dev.lvatn.com/use/crossref/works/"+e,o=await this.fetch(a))),null!=(null!=o?o.DOI:void 0)?(delete(t=o).relation,delete t.reference,delete t.abstract,t):void 0},r.src.crossref.works._kv=!1,r.src.crossref.works._index={settings:{number_of_shards:9}},r.src.crossref.works._key="DOI",r.src.crossref.works._title=async function(e){var t,i,r,n,s,l,o,a,u,c,h,p,f,m,y,g,v,b,_,w,x,O;if(null==e&&(e=this.params.title),"string"==typeof e){if(u='title.exact:"'+e+'"',-1!==e.indexOf(" ")){for(u+=" OR (",t=!0,O=0,n=(h=e.split(" ")).length;O<n;O++)(w=h[O]).length>2&&(!0===t?t=!1:u+=" AND "),u+='(title:"'+w+'" OR subtitle:"'+w+'")';u+=")"}for(x="https://dev.lvatn.com/use/crossref/works?q="+u,v=await this.fetch(x),a=!1,l=e.toLowerCase().replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),i=0,s=(m=null!=(p=null!=v&&null!=(f=v.hits)?f.hits:void 0)?p:[]).length;i<s;i++)if(b=("string"==typeof(c=m[i]._source).title?c.title:c.title[0]).toLowerCase(),null!=c.subtitle&&"string"==typeof(_=("string"==typeof c.subtitle?c.subtitle:c.subtitle[0]).toLowerCase())&&_.length&&d.call(b,_)<0&&(b+=" "+_),b=b.replace(/['".,\/\^&\*;:!\?#\$%{}=\-\+_`~()]/g," ").replace(/\s{2,}/g," ").trim(),(-1!==l.indexOf(b)||-1!==b.indexOf(l))&&l.length/b.length>.7&&l.length/b.length<1.3){for(r in o=!0,metadata)"citation"===r||"title"===r||"string"!=(y=typeof metadata[r])&&"number"!==y||(o=null==fr[r]||"string"!=(g=typeof fr[r])&&"number"!==g||fr[r].toLowerCase()===metadata[r].toLowerCase());if(o){if("journal-article"===c.type)return format?API.use.crossref.works.format(c):c;(!1===a||"journal-article"!==a.type&&"journal-article"===c.type)&&(a=c)}}return!1===a?void 0:a}},null==n.mail&&(n.mail={}),null==(o=n.mail).from&&(o.from="alert@cottagelabs.com"),null==(a=n.mail).to&&(a.to="mark@cottagelabs.com"),null==(u=n.src).google&&(u.google={});try{n.src.google.secrets=JSON.parse(SECRETS_GOOGLE)}catch(e){}n.built="Fri Mar 5 11:52:23 GMT 2021"}.call(this,i(3).Buffer,i(0))},function(e,t,i){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var r=i(4),n=i(5),s=i(6);function l(){return a.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function o(e,t){if(l()<t)throw new RangeError("Invalid typed array length");return a.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=a.prototype:(null===e&&(e=new a(t)),e.length=t),e}function a(e,t,i){if(!(a.TYPED_ARRAY_SUPPORT||this instanceof a))return new a(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return u(this,e,t,i)}function u(e,t,i,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,r){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,i):new Uint8Array(t,i,r);a.TYPED_ARRAY_SUPPORT?(e=t).__proto__=a.prototype:e=p(e,t);return e}(e,t,i,r):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!a.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var r=0|f(t,i),n=(e=o(e,r)).write(t,i);n!==r&&(e=e.slice(0,n));return e}(e,t,i):function(e,t){if(a.isBuffer(t)){var i=0|d(t.length);return 0===(e=o(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?o(e,0):p(e,t);if("Buffer"===t.type&&s(t.data))return p(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(c(t),e=o(e,t<0?0:0|d(t)),!a.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function p(e,t){var i=t.length<0?0:0|d(t.length);e=o(e,i);for(var r=0;r<i;r+=1)e[r]=255&t[r];return e}function d(e){if(e>=l())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+l().toString(16)+" bytes");return 0|e}function f(e,t){if(a.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return M(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return B(e).length;default:if(r)return M(e).length;t=(""+t).toLowerCase(),r=!0}}function m(e,t,i){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,i);case"utf8":case"utf-8":return A(this,t,i);case"ascii":return j(this,t,i);case"latin1":case"binary":return S(this,t,i);case"base64":return q(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,t,i);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function g(e,t,i,r,n){if(0===e.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=n?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(n)return-1;i=e.length-1}else if(i<0){if(!n)return-1;i=0}if("string"==typeof t&&(t=a.from(t,r)),a.isBuffer(t))return 0===t.length?-1:v(e,t,i,r,n);if("number"==typeof t)return t&=255,a.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):v(e,[t],i,r,n);throw new TypeError("val must be string, number or Buffer")}function v(e,t,i,r,n){var s,l=1,o=e.length,a=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;l=2,o/=2,a/=2,i/=2}function u(e,t){return 1===l?e[t]:e.readUInt16BE(t*l)}if(n){var c=-1;for(s=i;s<o;s++)if(u(e,s)===u(t,-1===c?0:s-c)){if(-1===c&&(c=s),s-c+1===a)return c*l}else-1!==c&&(s-=s-c),c=-1}else for(i+a>o&&(i=o-a),s=i;s>=0;s--){for(var h=!0,p=0;p<a;p++)if(u(e,s+p)!==u(t,p)){h=!1;break}if(h)return s}return-1}function b(e,t,i,r){i=Number(i)||0;var n=e.length-i;r?(r=Number(r))>n&&(r=n):r=n;var s=t.length;if(s%2!=0)throw new TypeError("Invalid hex string");r>s/2&&(r=s/2);for(var l=0;l<r;++l){var o=parseInt(t.substr(2*l,2),16);if(isNaN(o))return l;e[i+l]=o}return l}function _(e,t,i,r){return J(M(t,e.length-i),e,i,r)}function w(e,t,i,r){return J(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,r)}function x(e,t,i,r){return w(e,t,i,r)}function O(e,t,i,r){return J(B(t),e,i,r)}function k(e,t,i,r){return J(function(e,t){for(var i,r,n,s=[],l=0;l<e.length&&!((t-=2)<0);++l)i=e.charCodeAt(l),r=i>>8,n=i%256,s.push(n),s.push(r);return s}(t,e.length-i),e,i,r)}function q(e,t,i){return 0===t&&i===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,i))}function A(e,t,i){i=Math.min(e.length,i);for(var r=[],n=t;n<i;){var s,l,o,a,u=e[n],c=null,h=u>239?4:u>223?3:u>191?2:1;if(n+h<=i)switch(h){case 1:u<128&&(c=u);break;case 2:128==(192&(s=e[n+1]))&&(a=(31&u)<<6|63&s)>127&&(c=a);break;case 3:s=e[n+1],l=e[n+2],128==(192&s)&&128==(192&l)&&(a=(15&u)<<12|(63&s)<<6|63&l)>2047&&(a<55296||a>57343)&&(c=a);break;case 4:s=e[n+1],l=e[n+2],o=e[n+3],128==(192&s)&&128==(192&l)&&128==(192&o)&&(a=(15&u)<<18|(63&s)<<12|(63&l)<<6|63&o)>65535&&a<1114112&&(c=a)}null===c?(c=65533,h=1):c>65535&&(c-=65536,r.push(c>>>10&1023|55296),c=56320|1023&c),r.push(c),n+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var i="",r=0;for(;r<t;)i+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return i}(r)}t.Buffer=a,t.SlowBuffer=function(e){+e!=e&&(e=0);return a.alloc(+e)},t.INSPECT_MAX_BYTES=50,a.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=l(),a.poolSize=8192,a._augment=function(e){return e.__proto__=a.prototype,e},a.from=function(e,t,i){return u(null,e,t,i)},a.TYPED_ARRAY_SUPPORT&&(a.prototype.__proto__=Uint8Array.prototype,a.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&a[Symbol.species]===a&&Object.defineProperty(a,Symbol.species,{value:null,configurable:!0})),a.alloc=function(e,t,i){return function(e,t,i,r){return c(t),t<=0?o(e,t):void 0!==i?"string"==typeof r?o(e,t).fill(i,r):o(e,t).fill(i):o(e,t)}(null,e,t,i)},a.allocUnsafe=function(e){return h(null,e)},a.allocUnsafeSlow=function(e){return h(null,e)},a.isBuffer=function(e){return!(null==e||!e._isBuffer)},a.compare=function(e,t){if(!a.isBuffer(e)||!a.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,r=t.length,n=0,s=Math.min(i,r);n<s;++n)if(e[n]!==t[n]){i=e[n],r=t[n];break}return i<r?-1:r<i?1:0},a.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(e,t){if(!s(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return a.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var r=a.allocUnsafe(t),n=0;for(i=0;i<e.length;++i){var l=e[i];if(!a.isBuffer(l))throw new TypeError('"list" argument must be an Array of Buffers');l.copy(r,n),n+=l.length}return r},a.byteLength=f,a.prototype._isBuffer=!0,a.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)y(this,t,t+1);return this},a.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},a.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},a.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?A(this,0,e):m.apply(this,arguments)},a.prototype.equals=function(e){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===a.compare(this,e)},a.prototype.inspect=function(){var e="",i=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(e+=" ... ")),"<Buffer "+e+">"},a.prototype.compare=function(e,t,i,r,n){if(!a.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===r&&(r=0),void 0===n&&(n=this.length),t<0||i>e.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&t>=i)return 0;if(r>=n)return-1;if(t>=i)return 1;if(this===e)return 0;for(var s=(n>>>=0)-(r>>>=0),l=(i>>>=0)-(t>>>=0),o=Math.min(s,l),u=this.slice(r,n),c=e.slice(t,i),h=0;h<o;++h)if(u[h]!==c[h]){s=u[h],l=c[h];break}return s<l?-1:l<s?1:0},a.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},a.prototype.indexOf=function(e,t,i){return g(this,e,t,i,!0)},a.prototype.lastIndexOf=function(e,t,i){return g(this,e,t,i,!1)},a.prototype.write=function(e,t,i,r){if(void 0===t)r="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)r=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}var n=this.length-t;if((void 0===i||i>n)&&(i=n),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var s=!1;;)switch(r){case"hex":return b(this,e,t,i);case"utf8":case"utf-8":return _(this,e,t,i);case"ascii":return w(this,e,t,i);case"latin1":case"binary":return x(this,e,t,i);case"base64":return O(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,i);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function j(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(127&e[n]);return r}function S(e,t,i){var r="";i=Math.min(e.length,i);for(var n=t;n<i;++n)r+=String.fromCharCode(e[n]);return r}function E(e,t,i){var r=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>r)&&(i=r);for(var n="",s=t;s<i;++s)n+=D(e[s]);return n}function R(e,t,i){for(var r=e.slice(t,i),n="",s=0;s<r.length;s+=2)n+=String.fromCharCode(r[s]+256*r[s+1]);return n}function T(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function L(e,t,i,r,n,s){if(!a.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<s)throw new RangeError('"value" argument is out of bounds');if(i+r>e.length)throw new RangeError("Index out of range")}function C(e,t,i,r){t<0&&(t=65535+t+1);for(var n=0,s=Math.min(e.length-i,2);n<s;++n)e[i+n]=(t&255<<8*(r?n:1-n))>>>8*(r?n:1-n)}function I(e,t,i,r){t<0&&(t=4294967295+t+1);for(var n=0,s=Math.min(e.length-i,4);n<s;++n)e[i+n]=t>>>8*(r?n:3-n)&255}function P(e,t,i,r,n,s){if(i+r>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function N(e,t,i,r,s){return s||P(e,0,i,4),n.write(e,t,i,r,23,4),i+4}function U(e,t,i,r,s){return s||P(e,0,i,8),n.write(e,t,i,r,52,8),i+8}a.prototype.slice=function(e,t){var i,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),a.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=a.prototype;else{var n=t-e;i=new a(n,void 0);for(var s=0;s<n;++s)i[s]=this[s+e]}return i},a.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r},a.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e+--t],n=1;t>0&&(n*=256);)r+=this[e+--t]*n;return r},a.prototype.readUInt8=function(e,t){return t||T(e,1,this.length),this[e]},a.prototype.readUInt16LE=function(e,t){return t||T(e,2,this.length),this[e]|this[e+1]<<8},a.prototype.readUInt16BE=function(e,t){return t||T(e,2,this.length),this[e]<<8|this[e+1]},a.prototype.readUInt32LE=function(e,t){return t||T(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},a.prototype.readUInt32BE=function(e,t){return t||T(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},a.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=this[e],n=1,s=0;++s<t&&(n*=256);)r+=this[e+s]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*t)),r},a.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||T(e,t,this.length);for(var r=t,n=1,s=this[e+--r];r>0&&(n*=256);)s+=this[e+--r]*n;return s>=(n*=128)&&(s-=Math.pow(2,8*t)),s},a.prototype.readInt8=function(e,t){return t||T(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},a.prototype.readInt16LE=function(e,t){t||T(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt16BE=function(e,t){t||T(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt32LE=function(e,t){return t||T(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},a.prototype.readInt32BE=function(e,t){return t||T(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},a.prototype.readFloatLE=function(e,t){return t||T(e,4,this.length),n.read(this,e,!0,23,4)},a.prototype.readFloatBE=function(e,t){return t||T(e,4,this.length),n.read(this,e,!1,23,4)},a.prototype.readDoubleLE=function(e,t){return t||T(e,8,this.length),n.read(this,e,!0,52,8)},a.prototype.readDoubleBE=function(e,t){return t||T(e,8,this.length),n.read(this,e,!1,52,8)},a.prototype.writeUIntLE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||L(this,e,t,i,Math.pow(2,8*i)-1,0);var n=1,s=0;for(this[t]=255&e;++s<i&&(n*=256);)this[t+s]=e/n&255;return t+i},a.prototype.writeUIntBE=function(e,t,i,r){(e=+e,t|=0,i|=0,r)||L(this,e,t,i,Math.pow(2,8*i)-1,0);var n=i-1,s=1;for(this[t+n]=255&e;--n>=0&&(s*=256);)this[t+n]=e/s&255;return t+i},a.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,1,255,0),a.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},a.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,65535,0),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},a.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,65535,0),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},a.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,4294967295,0),a.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):I(this,e,t,!0),t+4},a.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,4294967295,0),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):I(this,e,t,!1),t+4},a.prototype.writeIntLE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);L(this,e,t,i,n-1,-n)}var s=0,l=1,o=0;for(this[t]=255&e;++s<i&&(l*=256);)e<0&&0===o&&0!==this[t+s-1]&&(o=1),this[t+s]=(e/l>>0)-o&255;return t+i},a.prototype.writeIntBE=function(e,t,i,r){if(e=+e,t|=0,!r){var n=Math.pow(2,8*i-1);L(this,e,t,i,n-1,-n)}var s=i-1,l=1,o=0;for(this[t+s]=255&e;--s>=0&&(l*=256);)e<0&&0===o&&0!==this[t+s+1]&&(o=1),this[t+s]=(e/l>>0)-o&255;return t+i},a.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,1,127,-128),a.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},a.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,32767,-32768),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):C(this,e,t,!0),t+2},a.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,2,32767,-32768),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):C(this,e,t,!1),t+2},a.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,2147483647,-2147483648),a.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):I(this,e,t,!0),t+4},a.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||L(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),a.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):I(this,e,t,!1),t+4},a.prototype.writeFloatLE=function(e,t,i){return N(this,e,t,!0,i)},a.prototype.writeFloatBE=function(e,t,i){return N(this,e,t,!1,i)},a.prototype.writeDoubleLE=function(e,t,i){return U(this,e,t,!0,i)},a.prototype.writeDoubleBE=function(e,t,i){return U(this,e,t,!1,i)},a.prototype.copy=function(e,t,i,r){if(i||(i=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-i&&(r=e.length-t+i);var n,s=r-i;if(this===e&&i<t&&t<r)for(n=s-1;n>=0;--n)e[n+t]=this[n+i];else if(s<1e3||!a.TYPED_ARRAY_SUPPORT)for(n=0;n<s;++n)e[n+t]=this[n+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+s),t);return s},a.prototype.fill=function(e,t,i,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!a.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var s;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(s=t;s<i;++s)this[s]=e;else{var l=a.isBuffer(e)?e:M(new a(e,r).toString()),o=l.length;for(s=0;s<i-t;++s)this[s+t]=l[s%o]}return this};var Y=/[^+\/0-9A-Za-z-_]/g;function D(e){return e<16?"0"+e.toString(16):e.toString(16)}function M(e,t){var i;t=t||1/0;for(var r=e.length,n=null,s=[],l=0;l<r;++l){if((i=e.charCodeAt(l))>55295&&i<57344){if(!n){if(i>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(l+1===r){(t-=3)>-1&&s.push(239,191,189);continue}n=i;continue}if(i<56320){(t-=3)>-1&&s.push(239,191,189),n=i;continue}i=65536+(n-55296<<10|i-56320)}else n&&(t-=3)>-1&&s.push(239,191,189);if(n=null,i<128){if((t-=1)<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function B(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Y,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,i,r){for(var n=0;n<r&&!(n+i>=t.length||n>=e.length);++n)t[n+i]=e[n];return n}}).call(this,i(0))},function(e,t,i){"use strict";t.byteLength=function(e){var t=u(e),i=t[0],r=t[1];return 3*(i+r)/4-r},t.toByteArray=function(e){var t,i,r=u(e),l=r[0],o=r[1],a=new s(function(e,t,i){return 3*(t+i)/4-i}(0,l,o)),c=0,h=o>0?l-4:l;for(i=0;i<h;i+=4)t=n[e.charCodeAt(i)]<<18|n[e.charCodeAt(i+1)]<<12|n[e.charCodeAt(i+2)]<<6|n[e.charCodeAt(i+3)],a[c++]=t>>16&255,a[c++]=t>>8&255,a[c++]=255&t;2===o&&(t=n[e.charCodeAt(i)]<<2|n[e.charCodeAt(i+1)]>>4,a[c++]=255&t);1===o&&(t=n[e.charCodeAt(i)]<<10|n[e.charCodeAt(i+1)]<<4|n[e.charCodeAt(i+2)]>>2,a[c++]=t>>8&255,a[c++]=255&t);return a},t.fromByteArray=function(e){for(var t,i=e.length,n=i%3,s=[],l=0,o=i-n;l<o;l+=16383)s.push(c(e,l,l+16383>o?o:l+16383));1===n?(t=e[i-1],s.push(r[t>>2]+r[t<<4&63]+"==")):2===n&&(t=(e[i-2]<<8)+e[i-1],s.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return s.join("")};for(var r=[],n=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,a=l.length;o<a;++o)r[o]=l[o],n[l.charCodeAt(o)]=o;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");return-1===i&&(i=t),[i,i===t?0:4-i%4]}function c(e,t,i){for(var n,s,l=[],o=t;o<i;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),l.push(r[(s=n)>>18&63]+r[s>>12&63]+r[s>>6&63]+r[63&s]);return l.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},function(e,t){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read=function(e,t,i,r,n){var s,l,o=8*n-r-1,a=(1<<o)-1,u=a>>1,c=-7,h=i?n-1:0,p=i?-1:1,d=e[t+h];for(h+=p,s=d&(1<<-c)-1,d>>=-c,c+=o;c>0;s=256*s+e[t+h],h+=p,c-=8);for(l=s&(1<<-c)-1,s>>=-c,c+=r;c>0;l=256*l+e[t+h],h+=p,c-=8);if(0===s)s=1-u;else{if(s===a)return l?NaN:1/0*(d?-1:1);l+=Math.pow(2,r),s-=u}return(d?-1:1)*l*Math.pow(2,s-r)},t.write=function(e,t,i,r,n,s){var l,o,a,u=8*s-n-1,c=(1<<u)-1,h=c>>1,p=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,l=c):(l=Math.floor(Math.log(t)/Math.LN2),t*(a=Math.pow(2,-l))<1&&(l--,a*=2),(t+=l+h>=1?p/a:p*Math.pow(2,1-h))*a>=2&&(l++,a/=2),l+h>=c?(o=0,l=c):l+h>=1?(o=(t*a-1)*Math.pow(2,n),l+=h):(o=t*Math.pow(2,h-1)*Math.pow(2,n),l=0));n>=8;e[i+d]=255&o,d+=f,o/=256,n-=8);for(l=l<<n|o,u+=n;u>0;e[i+d]=255&l,d+=f,l/=256,u-=8);e[i+d-f]|=128*m}},function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLm1pbi5qcyIsInNvdXJjZXMiOlsid2VicGFjazovLy93b3JrZXIubWluLmpzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQXN2T0E7O0FBdzVEQSIsInNvdXJjZVJvb3QiOiIifQ==