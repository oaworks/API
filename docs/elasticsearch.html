# installing an index server on Ubuntu Linux

# create a user account if you're still on root
adduser --gecos "" USERNAME
cd /home/USERNAME
mkdir /home/USERNAME/.ssh
chown USERNAME:USERNAME /home/USERNAME/.ssh
chmod 700 /home/USERNAME/.ssh
mv /root/.ssh/authorized_keys .ssh/
chown USERNAME:USERNAME .ssh/authorized_keys
chmod 600 /home/USERNAME/.ssh/authorized_keys
adduser USERNAME sudo
export VISUAL=vim

visudo
# USERNAME ALL=(ALL) NOPASSWD: ALL

apt-get update
apt-get -q -y install ntp nginx

dpkg-reconfigure tzdata
# set to Europe/London, or wherever best suits

dpkg-reconfigure --priority=low unattended-upgrades

vim /etc/ssh/sshd_config
# uncomment PubkeyAuthentication yes
# set PermitRootLogin no
# set PasswordAuthentication no

service ssh restart

# apt-get install ufw # (if your system doesn't already have it)
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable

# Follow your install Elasticsearch instructions (we use these ones): 
# https://opendistro.github.io/for-elasticsearch-docs/docs/install/deb/
# and link on that page for kibana too (which we also use)

# in /etc/elasticsearch
# set java min and max to same number in jvm.options
# enable bootstrap.memory_lock in elasticsearch.yml

# in jvm.options
# -Des.enforce.bootstrap.checks=true

# and see
# https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html
# https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html
# https://www.elastic.co/guide/en/elasticsearch/reference/master/setting-system-settings.html

# /etc/systemd/system/elasticsearch.service.d/override.conf
# need to set the values in systemd override file (which needs to be created)
# [Service]
# LimitMEMLOCK=infinity
# LimitNPROC=4096
# LimitNOFILE=1024000

# after changing the above settings any time, also need to:
# sudo systemctl daemon-reload

# set elasticsearch and kibana to start at restart
# then start them

# if the bootstrap checks fail then it will show a startup warning and not start
# then status will tell of any problems. For example memlock not being possible
# and discovery settings being unsuitable for production
# for running a single-node instance (at least to begin with), add this to elasticsearch.yml
# discovery.type: single-node

# can check what ES does actually have rights to do like:
# curl -X GET "https://localhost:9200/_nodes/stats/process?filter_path=**.max_file_descriptors&pretty" -u admin:admin --insecure

# newer ES has no types, everything is an index. So it defaults to 1 shard so that shard count doesn't go up so fast
# (which it would, with index for everything instead of types in index)
# This is OK apart from where an index may be large. A good shard size is up to 50gb 
# To manually create an index with more shards:
# https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html
# curl -X PUT 'https://localhost:9200/my-index-000001?pretty' -u USERNAME:PASSWORD --insecure -H 'Content-Type: application/json' -d '{"settings": {"number_of_shards": 3}}'

# mappings and aliases can be sent there too, although Elasticsearch dynamic mapping is 
#Â a very useful feature to use instead, if possible. It works for us. Different defaults
# can also be set in advance and applied to all new indexes if mappings aren't specified
# https://www.elastic.co/guide/en/elasticsearch/reference/current/index-templates.html

# with newer ubuntu 20.04 everything is systemd now as well. So restarting nginx is systemctl instead of old "service"
# sudo systemctl restart nginx
# sudo nginx -t still works though to test config changes

# if encrypting ssl is needed (which it should be):
sudo apt install certbot
# then configure the necessary domains and check they auto-renew
# note certbot behind CF can't do the nginx editing so do that directly. But once set up, should be able to autorenew. But check it.
# Set CF to DNS only, no proxy, then in the nginx config listen on 80 for .well-known.
# sudo certbot certonly --webroot --webroot-path /var/www/html -d DOMAIN_NAME_HERE
# once it succeeds, edit the nginx configs for a 443 server block with ssl settings to the newly created keys
# note also that although it is now certbot, the certs still end up in a folder called /etc/letsencrypt

# note by default the opendistro will require admin user and insecure tag for curl (see above)
# configure the ES and kibana default internal users, removing unnecessary ones or at least changing their passwords
# then these can be used as the connection privileges for remote connections
# https://opendistro.github.io/for-elasticsearch-docs/docs/security/configuration/yaml/

# The easiest way to change Open Distro default users is to edit them before starting ES the first time.
# if ES was already started but no data loaded, just remove the nodes folder from wherever ES data is stored (/var/lib/elasticsearch by default)
# Note if using kibana it will also be necessary to have a kibana user and see /etc/kibana/kibana.yml 
# to configure that user if changed from the default one - which it should be, because anyone who knows the default setup could use it
